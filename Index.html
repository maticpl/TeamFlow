<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>TeamFlow</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    /* === Tw√≥j CSS ‚Äì zachowany uk≈Çad i zmienne === */
    :root {
      --bg-primary:#f4f5f7;--bg-secondary:#ffffff;--bg-tertiary:#e9eaec;--bg-overlay:rgba(0,0,0,.5);
      --text-primary:#172b4d;--text-secondary:#5e6c84;--text-on-accent:#ffffff;--border-color:#dfe1e6;
      --accent-primary:#4f46e5;--accent-hover:#4338ca;--danger-primary:#dc2626;--danger-hover:#b91c1c;--success-primary:#16a34a;
      --priority-high-bg:#fef9c3;--priority-high-border:#fde047;
      --shadow-sm:0 1px 2px rgba(0,0,0,.05);--shadow-md:0 4px 6px -1px rgba(0,0,0,.1),0 2px 4px -2px rgba(0,0,0,.1);
      --shadow-lg:0 10px 15px -3px rgba(0,0,0,.1),0 4px 6px -4px rgba(0,0,0,.1);--border-radius:8px;--font-family:'Inter',sans-serif
    }
    .dark-mode{--bg-primary:#1f2937;--bg-secondary:#374151;--bg-tertiary:#4b5563;--text-primary:#f9fafb;--text-secondary:#d1d5db;--border-color:#4b5563;--success-primary:#22c55e;--priority-high-bg:#4f46e5;--priority-high-border:#6d28d9}
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:var(--font-family);background:var(--bg-primary);color:var(--text-primary);line-height:1.5;overflow:hidden;transition:background .3s,color .3s}

    /* Overlays / auth */
    #auth-overlay{position:fixed;inset:0;background:var(--bg-primary);display:flex;align-items:center;justify-content:center;z-index:10001}
    .auth-container{background:var(--bg-secondary);padding:40px;border-radius:12px;box-shadow:var(--shadow-lg);width:min(92vw,420px)}
    .auth-container h2{margin-bottom:10px}
    .auth-form .form-group{margin:12px 0}
    .auth-form label{display:block;margin-bottom:6px;font-size:14px;font-weight:600}
    .auth-form input{width:100%;padding:10px;border:1px solid var(--border-color);border-radius:10px;background:var(--bg-primary);color:var(--text-primary)}
    .btn{display:inline-flex;align-items:center;justify-content:center;padding:10px 14px;border-radius:10px;font-weight:700;border:none;cursor:pointer}
    .btn-primary{background:var(--accent-primary);color:#fff}.btn-primary:hover{background:var(--accent-hover)}
    .btn-secondary{background:var(--bg-tertiary)}
    .auth-form .btn{width:100%;margin-top:8px}
    .auth-toggle{margin-top:10px;font-size:13px}.auth-toggle a{color:var(--accent-primary);cursor:pointer}
    .error-message{min-height:20px;color:var(--danger-primary);font-size:13px;margin-top:8px}

    /* App layout */
    .app-container{display:flex;height:100vh}
    .app-container.hidden{display:none}
    #sidebar{width:280px;background:var(--bg-secondary);border-right:1px solid var(--border-color);padding:16px;display:flex;flex-direction:column}
    .sidebar-header{display:flex;gap:8px;align-items:center;margin-bottom:14px}
    .logo{width:32px;height:32px;border-radius:8px;background:var(--accent-primary);color:#fff;display:grid;place-items:center;font-weight:800}
    .nav-section h2{font-size:12px;color:var(--text-secondary);text-transform:uppercase;margin:10px 0 4px}
    .nav-list{list-style:none;display:grid;gap:6px;max-height:30vh;overflow:auto}
    .nav-item a{display:flex;gap:8px;align-items:center;padding:8px;border-radius:8px;color:inherit;text-decoration:none}
    .nav-item a:hover{background:var(--bg-tertiary)} .nav-item a.active{background:var(--accent-primary);color:#fff}
    .new-project-btn{margin-top:10px}
    .sidebar-footer{margin-top:auto;border-top:1px solid var(--border-color);padding-top:12px;font-size:12px;color:var(--text-secondary)}

    .main-content{flex:1;display:flex;flex-direction:column}
    .main-header{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid var(--border-color);background:var(--bg-secondary)}
    .header-actions{display:flex;gap:8px;align-items:center}
    .header-btn{background:transparent;border:none;border-radius:999px;padding:6px;cursor:pointer;color:var(--text-secondary)}
    .header-btn:hover{background:var(--bg-tertiary)}
    .search{display:flex;align-items:center;gap:8px}
    .search input{padding:8px 10px;border:1px solid var(--border-color);border-radius:10px;background:var(--bg-primary);color:var(--text-primary);width:220px}

    .kanban-board{flex:1;display:grid;grid-template-columns:repeat(3,1fr);gap:16px;padding:16px;overflow:auto;background:var(--bg-primary)}
    .kanban-column{background:var(--bg-tertiary);border-radius:12px;padding:12px;display:flex;flex-direction:column}
    .kanban-column-header{display:flex;align-items:center;gap:8px;margin-bottom:8px}
    .task-count{font-size:12px;border:1px solid var(--border-color);border-radius:999px;padding:2px 8px;color:var(--text-secondary)}
    .kanban-tasks{list-style:none;display:grid;gap:8px;overflow:auto}
    .task-card{background:var(--bg-secondary);border:1px solid var(--border-color);border-radius:12px;padding:12px;display:grid;gap:6px}
    .task-meta{display:flex;gap:6px;flex-wrap:wrap}
    .badge{font-size:11px;padding:2px 6px;border:1px solid var(--border-color);border-radius:8px;color:var(--text-secondary)}
    .assignees{display:flex;gap:4px;flex-wrap:wrap}
    .avatar{width:22px;height:22px;border-radius:50%;display:grid;place-items:center;font-size:11px;color:#fff}

    /* Modale */
    .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;padding:16px;z-index:1100}
    .modal-overlay.visible{display:flex}
    .modal{background:var(--bg-secondary);border:1px solid var(--border-color);border-radius:12px;box-shadow:var(--shadow-lg);width:min(92vw,560px)}
    .modal header{padding:12px 16px;border-bottom:1px solid var(--border-color)}
    .modal .content{padding:16px}
    .modal .footer{display:flex;gap:8px;justify-content:flex-end;padding:12px 16px;border-top:1px solid var(--border-color)}

    #loading-overlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(255,255,255,.75);z-index:1200}
    .dark-mode #loading-overlay{background:rgba(0,0,0,.75);color:#fff}

    /* Mobile */
    #sidebar-overlay{display:none}
    @media (max-width:900px){
      .app-container{flex-direction:column}
      #sidebar{position:fixed;height:100vh;transform:translateX(-100%);transition:transform .25s;z-index:1201}
      #sidebar.open{transform:translateX(0)}
      #sidebar-overlay{display:block;position:fixed;inset:0;background:rgba(0,0,0,.4);opacity:0;pointer-events:none;transition:opacity .2s;z-index:1200}
      #sidebar-overlay.visible{opacity:1;pointer-events:auto}
    }
  </style>
</head>
<body>

<!-- LOADING -->
<div id="loading-overlay"><p>≈Åadowanie‚Ä¶</p></div>

<!-- AUTH -->
<div id="auth-overlay">
  <div class="auth-container">
    <form id="login-form" class="auth-form">
      <h2>Zaloguj siƒô</h2>
      <div class="form-group"><label for="login-email">Email</label><input id="login-email" type="email" required></div>
      <div class="form-group"><label for="login-password">Has≈Ço</label><input id="login-password" type="password" required></div>
      <button class="btn btn-primary" type="submit">Zaloguj siƒô</button>
      <p id="auth-error-login" class="error-message"></p>
      <p class="auth-toggle">Nie masz konta? <a id="show-register">Zarejestruj siƒô</a></p>
    </form>

    <form id="register-form" class="auth-form" style="display:none">
      <h2>Stw√≥rz konto</h2>
      <div class="form-group"><label for="register-name">Nazwa u≈ºytkownika</label><input id="register-name" type="text" required></div>
      <div class="form-group"><label for="register-email">Email</label><input id="register-email" type="email" required></div>
      <div class="form-group"><label for="register-password">Has≈Ço (min. 6 znak√≥w)</label><input id="register-password" type="password" minlength="6" required></div>
      <button class="btn btn-primary" type="submit">Zarejestruj siƒô</button>
      <p id="auth-error-register" class="error-message"></p>
      <p class="auth-toggle">Masz ju≈º konto? <a id="show-login">Zaloguj siƒô</a></p>
    </form>
  </div>
</div>

<!-- APP -->
<div class="app-container hidden" id="app-container">
  <div id="sidebar-overlay"></div>
  <aside id="sidebar">
    <div class="sidebar-header">
      <div class="logo">TF</div>
      <div>
        <div style="font-weight:800">TeamFlow</div>
        <div style="font-size:12px;color:var(--text-secondary)" id="user-email-display"></div>
      </div>
    </div>

    <nav class="nav-section">
      <ul class="nav-list" id="main-nav">
        <li class="nav-item">
          <a href="#" class="active" data-view="projects" id="menu-toggle">
            <span>Projekty</span>
          </a>
        </li>
      </ul>
    </nav>

    <nav class="nav-section">
      <h2>Moje projekty</h2>
      <ul class="nav-list" id="projects-list"></ul>
    </nav>

    <div id="completed-projects-section" class="nav-section">
      <h2>Zako≈Ñczone</h2>
      <ul class="nav-list" id="completed-projects-list"></ul>
    </div>

    <button class="btn btn-primary new-project-btn" id="new-project-btn">+ Nowy projekt</button>

    <div class="sidebar-footer">
      <button id="logout-btn" class="btn btn-secondary" style="width:100%">Wyloguj</button>
    </div>
  </aside>

  <main class="main-content">
    <header class="main-header">
      <div class="project-title-wrapper">
        <h2 id="project-name-header">‚Äî</h2>
        <div id="project-members-header" class="project-members"></div>
      </div>
      <div class="header-actions">
        <div class="search">
          <input id="search-input" placeholder="Szukaj zada≈Ñ...">
          <button id="sort-btn" class="header-btn" title="Sortuj po terminie">‚Üï</button>
        </div>
        <button id="notification-toggle-btn" class="header-btn" title="Powiadomienia">üîî</button>
        <div class="theme-switcher" id="desktop-theme-switcher">
          <button id="theme-light" class="header-btn" title="Tryb jasny">‚òÄÔ∏è</button>
          <button id="theme-dark" class="header-btn" title="Tryb ciemny">üåô</button>
        </div>
      </div>
    </header>

    <section id="project-actions" style="display:flex;gap:8px;padding:12px 16px;border-bottom:1px solid var(--border-color);background:var(--bg-secondary)">
      <button id="edit-project-btn" class="btn btn-secondary">Edytuj projekt</button>
      <button id="complete-project-btn" class="btn btn-primary">Zako≈Ñcz projekt</button>
      <button id="fab-add-task" class="btn btn-primary">+ Dodaj zadanie</button>
    </section>

    <section class="kanban-board" id="kanban-board">
      <div class="kanban-column" data-status="todo">
        <div class="kanban-column-header"><h3>Do realizacji</h3><span class="task-count" id="count-todo">0</span></div>
        <ul class="kanban-tasks" id="list-todo"></ul>
      </div>
      <div class="kanban-column" data-status="inprogress">
        <div class="kanban-column-header"><h3>W trakcie realizacji</h3><span class="task-count" id="count-inprogress">0</span></div>
        <ul class="kanban-tasks" id="list-inprogress"></ul>
      </div>
      <div class="kanban-column" data-status="done">
        <div class="kanban-column-header"><h3>Wykonane</h3><span class="task-count" id="count-done">0</span></div>
        <ul class="kanban-tasks" id="list-done"></ul>
      </div>
    </section>
  </main>
</div>

<!-- MODAL: TASK -->
<div class="modal-overlay" id="task-modal">
  <div class="modal">
    <header><h3 id="modal-task-title">Nowe zadanie</h3></header>
    <div class="content">
      <div class="form-group"><label>Tytu≈Ç <input id="modal-task-title-input" type="text"></label></div>
      <div class="form-group"><label>Opis <textarea id="modal-task-description" rows="4"></textarea></label></div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
        <label>Status
          <select id="modal-task-status">
            <option value="todo">Do realizacji</option>
            <option value="inprogress">W trakcie realizacji</option>
            <option value="done">Wykonane</option>
          </select>
        </label>
        <label>Priorytet
          <select id="modal-task-priority">
            <option value="normal">Normalny</option>
            <option value="high">Wysoki</option>
            <option value="low">Niski</option>
          </select>
        </label>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:8px">
        <label>Termin (data) <input id="modal-task-dueDate" type="date"></label>
        <label>Godzina <input id="modal-task-dueTime" type="time"></label>
      </div>
      <div class="form-group" style="margin-top:8px">
        <label>Przypisanie
          <select id="modal-assign-mode">
            <option value="single">Jedna osoba</option>
            <option value="multi">Wiele os√≥b</option>
          </select>
        </label>
        <div id="modal-assign-single-wrap" style="margin-top:8px">
          <select id="modal-assign-single"></select>
        </div>
        <div id="modal-assign-multi-wrap" style="display:none;margin-top:8px;grid-template-columns:repeat(3,minmax(0,1fr));gap:6px"></div>
      </div>
      <div id="modal-completion-status-section" style="display:none;margin-top:8px">
        <div class="form-group"><label><input id="modal-task-completed" type="checkbox"> Moja czƒô≈õƒá wykonana</label></div>
        <div id="modal-completion-status-list" class="assignees"></div>
      </div>
    </div>
    <div class="footer">
      <button id="modal-task-cancel" class="btn btn-secondary">Anuluj</button>
      <button id="save-task-btn" class="btn btn-primary">Zapisz</button>
    </div>
  </div>
</div>

<!-- MODAL: PROJECT -->
<div class="modal-overlay" id="project-modal">
  <div class="modal">
    <header><h3 id="project-modal-title">Nowy projekt</h3></header>
    <div class="content">
      <div class="form-group"><label>Nazwa projektu <input id="project-name-input" type="text"></label></div>
      <div class="form-group">
        <div style="font-size:12px;color:var(--text-secondary);margin-bottom:6px">Cz≈Çonkowie projektu</div>
        <div id="project-members-list" style="display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:8px"></div>
      </div>
    </div>
    <div class="footer">
      <button id="project-cancel" class="btn btn-secondary">Anuluj</button>
      <button id="project-save" class="btn btn-primary">Zapisz</button>
    </div>
  </div>
</div>

<script type="module">
/* =========================
   IMPORTY Firebase (naprawione)
========================= */
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, collection, doc, getDoc, getDocs, setDoc, addDoc, updateDoc, deleteDoc, onSnapshot, query, where, writeBatch, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
import { getMessaging, getToken, onMessage, isSupported } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-messaging.js";

/* =========================
   KONFIG ‚Äì wstaw swoje klucze (cofingAPI)
========================= */
const firebaseConfig = {
  apiKey: "__API_KEY__",
  authDomain: "__AUTH_DOMAIN__",
  projectId: "__PROJECT_ID__",
  storageBucket: "__STORAGE_BUCKET__",
  messagingSenderId: "__MESSAGING_SENDER_ID__",
  appId: "__APP_ID__"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db   = getFirestore(app);

/* =========================
   STATE + sta≈Çe
========================= */
const STATUSES = { todo:"Do realizacji", inprogress:"W trakcie realizacji", done:"Wykonane" };
const state = {
  currentUser:null,
  users:[],
  projects:[],
  completedProjects:[],
  currentProjectId:null,
  ui:{ theme:"light", sortMyTasksByDate:"asc", unsubscribeUsers:null, unsubscribeProjects:null, unsubscribeCompleted:null }
};

const APP_ID = "__APP_ID__"; // je≈õli chcesz u≈ºyƒá w≈Çasnego appId w ≈õcie≈ºkach ‚Äì podmie≈Ñ
const PATHS = {
  users:               `artifacts/${APP_ID}/public/data/users`,
  projects:            `artifacts/${APP_ID}/public/data/projects`,
  completed:           `artifacts/${APP_ID}/public/data/completedProjects`,
  tasksGlobal:         `artifacts/${APP_ID}/public/data/tasks`,
  tasksSub:            (projectId)=>`artifacts/${APP_ID}/public/data/projects/${projectId}/tasks`
};

const usersRef = collection(db, PATHS.users);
const projectsRef = collection(db, PATHS.projects);
const completedProjectsRef = collection(db, PATHS.completed);

/* =========================
   DOM refs
========================= */
const authOverlay = document.getElementById('auth-overlay');
const appContainer = document.getElementById('app-container');
const loadingOverlay = document.getElementById('loading-overlay');

const loginForm = document.getElementById('login-form');
const registerForm = document.getElementById('register-form');
const showRegisterBtn = document.getElementById('show-register');
const showLoginBtn = document.getElementById('show-login');
const authErrorLogin = document.getElementById('auth-error-login');
const authErrorRegister = document.getElementById('auth-error-register');

const userEmailDisplay = document.getElementById('user-email-display');
const logoutBtn = document.getElementById('logout-btn');

const projectsListEl = document.getElementById('projects-list');
const completedProjectsListEl = document.getElementById('completed-projects-list');
const projectNameHeaderEl = document.getElementById('project-name-header');
const projectMembersHeaderEl = document.getElementById('project-members-header');
const newProjectBtn = document.getElementById('new-project-btn');
const editProjectBtn = document.getElementById('edit-project-btn');
const completeProjectBtn = document.getElementById('complete-project-btn');
const fabAddTask = document.getElementById('fab-add-task');

const kanbanBoardEl = document.getElementById('kanban-board');
const listTodo = document.getElementById('list-todo');
const listInprogress = document.getElementById('list-inprogress');
const listDone = document.getElementById('list-done');
const countTodo = document.getElementById('count-todo');
const countInprogress = document.getElementById('count-inprogress');
const countDone = document.getElementById('count-done');

const searchInput = document.getElementById('search-input');
const sortBtn = document.getElementById('sort-btn');
const sidebar = document.getElementById('sidebar');
const sidebarOverlay = document.getElementById('sidebar-overlay');
const menuToggle = document.getElementById('menu-toggle');

const notificationToggleBtn = document.getElementById('notification-toggle-btn');
const themeLight = document.getElementById('theme-light');
const themeDark  = document.getElementById('theme-dark');
const desktopThemeSwitcher = document.getElementById('desktop-theme-switcher');

/* =========================
   Helpers
========================= */
const $esc = (s)=>String(s??"").replace(/[&<>"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[m]));
const toInputDate=(d)=>d.toISOString().slice(0,10);
const toInputTime=(d)=>d.toTimeString().slice(0,5);
function combineDateTime(dateStr,timeStr){
  if(!dateStr && !timeStr) return null;
  const d = dateStr? new Date(dateStr+"T00:00:00") : new Date();
  if(timeStr){ const [h,m]=(timeStr||"").split(":").map(Number); d.setHours(h||0,m||0,0,0); }
  return d.toISOString();
}

/* =========================
   Theme
========================= */
function applyTheme(){ document.body.classList.toggle("dark-mode", state.ui.theme==="dark"); }
themeLight.addEventListener("click", ()=>{state.ui.theme="light";applyTheme();});
themeDark.addEventListener("click", ()=>{state.ui.theme="dark";applyTheme();});
applyTheme();

/* =========================
   Auth events (naprawione)
========================= */
showRegisterBtn.addEventListener('click', ()=>{ loginForm.style.display='none'; registerForm.style.display='block'; });
showLoginBtn.addEventListener('click', ()=>{ registerForm.style.display='none'; loginForm.style.display='block'; });

loginForm.addEventListener('submit', async (e)=>{
  e.preventDefault();
  authErrorLogin.textContent="";
  const email = (document.getElementById('login-email').value||"").trim();
  const pass  = document.getElementById('login-password').value;
  try{ await signInWithEmailAndPassword(auth,email,pass); }
  catch(err){ authErrorLogin.textContent = err.message; }
});

registerForm.addEventListener('submit', async (e)=>{
  e.preventDefault();
  authErrorRegister.textContent="";
  const name = (document.getElementById('register-name').value||"").trim();
  const email= document.getElementById('register-email').value;
  const pass = document.getElementById('register-password').value;
  if(!name){ authErrorRegister.textContent="Nazwa u≈ºytkownika jest wymagana."; return; }
  const btn = registerForm.querySelector('button[type="submit"]'); btn.disabled=true; btn.textContent="Rejestrowanie‚Ä¶";
  try{
    const cred = await createUserWithEmailAndPassword(auth,email,pass);
    await setDoc(doc(usersRef, cred.user.uid), {
      uid: cred.user.uid, email: cred.user.email||"", name, createdAt: serverTimestamp()
    }, { merge:true });
  }catch(err){ authErrorRegister.textContent = err.message; }
  finally{ btn.disabled=false; btn.textContent="Zarejestruj siƒô"; }
});

logoutBtn.addEventListener('click', ()=> signOut(auth));

/* =========================
   Notifications (naprawione)
========================= */
function updateNotificationBellUI(){
  if(!notificationToggleBtn) return;
  if(!("Notification" in window)){ notificationToggleBtn.classList.remove('active'); notificationToggleBtn.title = 'Brak wsparcia'; return; }
  if(Notification.permission==='granted'){ notificationToggleBtn.classList.add('active'); notificationToggleBtn.title='Powiadomienia w≈ÇƒÖczone'; }
  else { notificationToggleBtn.classList.remove('active'); notificationToggleBtn.title='Kliknij, aby w≈ÇƒÖczyƒá'; }
}
updateNotificationBellUI();

async function requestNotificationPermission(){
  try{
    if(!await isSupported()) return;
    const perm = await Notification.requestPermission();
    updateNotificationBellUI();
    if(perm!=='granted') return;
    const messaging = getMessaging(app);
    const token = await getToken(messaging);
    if(token && state.currentUser){
      const uref = doc(usersRef, state.currentUser.uid);
      const snap = await getDoc(uref);
      const tokens = snap.exists()? (snap.data().fcmTokens||[]) : [];
      if(!tokens.includes(token)){
        await updateDoc(uref, { fcmTokens: [...tokens, token] }); /* kropka przed tokens -> poprawione */  /* :contentReference[oaicite:4]{index=4} */
      }
    }
    onMessage(messaging, (payload)=> console.log('FCM message:', payload));
  }catch(err){ console.error('FCM error:', err); }
}
notificationToggleBtn.addEventListener('click', requestNotificationPermission);

/* =========================
   Firestore Listeners
========================= */
function cleanup(){
  for (const k of ['unsubscribeUsers','unsubscribeProjects','unsubscribeCompleted']){
    if(state.ui[k]){ state.ui[k](); state.ui[k]=null; }
  }
}

function listenUsers(){
  if(state.ui.unsubscribeUsers) state.ui.unsubscribeUsers();
  state.ui.unsubscribeUsers = onSnapshot(usersRef, (snap)=>{
    state.users = snap.docs.map(d=>({ id:d.id, ...d.data() }));
    // od≈õwie≈º UI w modalu je≈õli otwarty
  }, (e)=>console.error('B≈ÇƒÖd odczytu u≈ºytkownik√≥w:', e));
}

function listenProjectsForUser(userId){
  if(state.ui.unsubscribeProjects) state.ui.unsubscribeProjects();
  const q = query(projectsRef, where("members","array-contains", userId));
  state.ui.unsubscribeProjects = onSnapshot(q, (snap)=>{
    state.projects = snap.docs.map(d=>({ id:d.id, ...d.data() })); /* .doc.data() -> poprawione */ /* :contentReference[oaicite:5]{index=5} */
    // je≈õli nie ma wybranego projektu ‚Äî ustaw pierwszy
    if(!state.currentProjectId || !state.projects.find(p=>p.id===state.currentProjectId)){
      state.currentProjectId = state.projects[0]?.id || null;
    }
    render();
  }, (e)=>{
    console.error('B≈ÇƒÖd odczytu projekt√≥w:', e);
  });

  if(state.ui.unsubscribeCompleted) state.ui.unsubscribeCompleted();
  const qc = query(completedProjectsRef, where("members","array-contains", userId));
  state.ui.unsubscribeCompleted = onSnapshot(qc, (snap)=>{
    state.completedProjects = snap.docs.map(d=>({ id:d.id, ...d.data() }));
    render();
  }, (e)=>console.error('B≈ÇƒÖd odczytu zako≈Ñczonych projekt√≥w:', e));
}

/* =========================
   Auth state change (naprawione spread)
========================= */
onAuthStateChanged(auth, async (user)=>{
  if(user){
    const userDoc = await getDoc(doc(usersRef, user.uid));
    state.currentUser = userDoc.exists() ? { id:user.uid, uid:user.uid, ...userDoc.data() } : { id:user.uid, uid:user.uid, email:user.email }; /* ...userDoc.data() -> poprawione */ /* :contentReference[oaicite:6]{index=6} */
    userEmailDisplay.textContent = state.currentUser.email || "(brak email)";
    authOverlay.style.display='none'; appContainer.classList.remove('hidden'); loadingOverlay.style.display='none';
    listenUsers(); listenProjectsForUser(user.uid);
    updateNotificationBellUI();
  }else{
    cleanup();
    state.currentUser=null;
    appContainer.classList.add('hidden'); authOverlay.style.display='flex'; loadingOverlay.style.display='none';
  }
});

/* =========================
   Projekty: render i akcje
========================= */
function render(){
  renderProjectsList();
  renderProjectHeader();
  renderBoardFromDB();
}

function renderProjectsList(){
  projectsListEl.innerHTML="";
  for(const p of state.projects){
    const li = document.createElement('li');
    const a = document.createElement('a');
    a.href="#"; a.dataset.id=p.id; a.className = (p.id===state.currentProjectId)?"active":"";
    a.innerHTML = `<span style="width:8px;height:8px;border-radius:999px;background:${p.closed?'#9ca3af':'#10b981'};display:inline-block"></span> <span>${$esc(p.name||'(bez nazwy)')}</span>`;
    a.addEventListener('click',(e)=>{ e.preventDefault(); state.currentProjectId=p.id; render(); });
    li.appendChild(a); projectsListEl.appendChild(li);
  }
  // zako≈Ñczone
  completedProjectsListEl.innerHTML="";
  for(const p of state.completedProjects){
    const li = document.createElement('li');
    li.innerHTML = `<a href="#" data-id="${p.id}"><span style="width:8px;height:8px;border-radius:999px;background:#9ca3af;display:inline-block"></span> <span>${$esc(p.name||'(bez nazwy)')}</span></a>`;
    completedProjectsListEl.appendChild(li);
  }
}

function currentProject(){ return state.projects.find(p=>p.id===state.currentProjectId) || null; }

function renderProjectHeader(){
  const p = currentProject();
  projectNameHeaderEl.textContent = p?.name || "‚Äî";
  projectMembersHeaderEl.innerHTML = (p?.members||[]).map(uid=>renderAvatar(uid)).join("");
}

function renderAvatar(uid){
  const u = state.users.find(x=>x.id===uid || x.uid===uid);
  const name = u?.name || u?.email || "U";
  const inic = name.trim().charAt(0).toUpperCase();
  const hue = (uid||"0").split("").reduce((a,c)=>a+c.charCodeAt(0),0)%360;
  return `<span class="avatar" title="${$esc(name)}" style="background:hsl(${hue} 70% 45%)">${inic}</span>`;
}

/* =========================
   Zadania: odczyt z 2 ≈õcie≈ºek i render
========================= */
function listenTasks(projectId, cb){
  const buffers = { sub:[], glob:[] };
  const unsub = [];
  // sub
  unsub.push(onSnapshot(collection(db, PATHS.tasksSub(projectId)), (snap)=>{
    buffers.sub = snap.docs.map(d=>({ id:d.id, ...d.data(), __src:'sub' }));
    cb([...buffers.sub, ...buffers.glob]);
  }));
  // global
  unsub.push(onSnapshot(query(collection(db, PATHS.tasksGlobal), where("projectId","==",projectId)), (snap)=>{
    buffers.glob = snap.docs.map(d=>({ id:d.id, ...d.data(), __src:'glob' }));
    cb([...buffers.sub, ...buffers.glob]);
  }));
  return ()=> unsub.forEach(u=>u());
}

let unsubTasks = null;
function renderBoardFromDB(){
  const p = currentProject();
  if(!p){ listTodo.innerHTML=listInprogress.innerHTML=listDone.innerHTML=""; countTodo.textContent=countInprogress.textContent=countDone.textContent="0"; return; }
  if(unsubTasks) unsubTasks();
  unsubTasks = listenTasks(p.id, (all)=> renderBoard(all));
}

function renderBoard(tasks){
  // sortowanie po terminie
  const dir = state.ui.sortMyTasksByDate === 'asc' ? 1 : -1;
  const arr = tasks.slice().sort((a,b)=> {
    const ad = a.dueAt? new Date(a.dueAt).getTime():0;
    const bd = b.dueAt? new Date(b.dueAt).getTime():0;
    return (ad-bd)*dir;
  });
  const buckets = { todo:[], inprogress:[], done:[] };
  for(const t of arr){
    const s = (t.status==='inprogress'||t.status==='done')? t.status:'todo';
    buckets[s].push(t);
  }
  renderBucket(listTodo, buckets.todo);
  renderBucket(listInprogress, buckets.inprogress);
  renderBucket(listDone, buckets.done);
  countTodo.textContent = String(buckets.todo.length);
  countInprogress.textContent = String(buckets.inprogress.length);
  countDone.textContent = String(buckets.done.length);
}

function renderBucket(ul,tasks){
  ul.innerHTML = "";
  for(const t of tasks){
    const li = document.createElement('li');
    li.className="task-card"; li.draggable=true; li.dataset.taskId=t.id; li.dataset.src=t.__src||'sub';
    const ass = Array.isArray(t.assignees)? t.assignees : (t.assignee?[t.assignee]:[]);
    const assHtml = ass.map(renderAvatar).join("");
    const dateStr = t.dueAt ? new Date(t.dueAt).toLocaleString() : "";
    li.innerHTML = `
      <div style="display:flex;justify-content:space-between;gap:6px">
        <div style="font-weight:700">${$esc(t.title||'(bez tytu≈Çu)')}</div>
        <div class="assignees">${assHtml}</div>
      </div>
      ${t.description? `<div style="font-size:13px;color:var(--text-secondary)">${$esc(t.description)}</div>`:""}
      <div class="task-meta">
        ${dateStr? `<span class="badge">‚è∞ ${$esc(dateStr)}</span>`:""}
        ${t.priority? `<span class="badge">‚≠ê ${$esc(t.priority)}</span>`:""}
      </div>
    `;
    li.addEventListener('click', ()=> openTaskModal(t));
    li.addEventListener('dragstart', (e)=>{
      e.dataTransfer.setData("text/plain", JSON.stringify({ id:t.id, src:li.dataset.src }));
      setTimeout(()=> li.classList.add('dragging'), 0);
    });
    li.addEventListener('dragend', ()=> li.classList.remove('dragging'));
    ul.appendChild(li);
  }
}

// DnD na kolumnach
kanbanBoardEl.addEventListener('dragover', (e)=> e.preventDefault());
kanbanBoardEl.addEventListener('drop', async (e)=>{
  e.preventDefault();
  const column = e.target.closest('.kanban-column'); if(!column) return;
  const data = JSON.parse(e.dataTransfer.getData("text/plain")||"{}");
  if(!data.id) return;
  await setTaskStatus(data.id, column.dataset.status, data.src);
});

async function setTaskStatus(taskId, status, src){
  const p = currentProject(); if(!p) return;
  const ref = (src==='glob') ? doc(collection(db, PATHS.tasksGlobal), taskId) : doc(collection(db, PATHS.tasksSub(p.id)), taskId);
  await updateDoc(ref, { status, updatedAt: serverTimestamp() });
}

/* =========================
   Dodawanie / edycja zada≈Ñ
========================= */
const taskModal = {
  overlay: document.getElementById('task-modal'),
  title: document.getElementById('modal-task-title'),
  inTitle: document.getElementById('modal-task-title-input'),
  inDesc: document.getElementById('modal-task-description'),
  inStatus: document.getElementById('modal-task-status'),
  inPriority: document.getElementById('modal-task-priority'),
  inDate: document.getElementById('modal-task-dueDate'),
  inTime: document.getElementById('modal-task-dueTime'),
  inMode: document.getElementById('modal-assign-mode'),
  singleWrap: document.getElementById('modal-assign-single-wrap'),
  single: document.getElementById('modal-assign-single'),
  multiWrap: document.getElementById('modal-assign-multi-wrap'),
  multi: document.getElementById('modal-assign-multi-wrap'),
  completed: document.getElementById('modal-task-completed'),
  completionStatusSection: document.getElementById('modal-completion-status-section'),
  completionStatusList: document.getElementById('modal-completion-status-list'),
  btnSave: document.getElementById('save-task-btn'),
  btnCancel: document.getElementById('modal-task-cancel'),
  _edit:null
};

function openTaskModal(task){
  const p = currentProject(); if(!p) return;
  taskModal._edit = task || null;
  taskModal.title.textContent = task? "Edytuj zadanie":"Nowe zadanie";
  taskModal.inTitle.value = task?.title || "";
  taskModal.inDesc.value  = task?.description || "";
  taskModal.inStatus.value= task?.status || "todo";
  taskModal.inPriority.value= task?.priority || "normal";
  if(task?.dueAt){ const d=new Date(task.dueAt); taskModal.inDate.value=toInputDate(d); taskModal.inTime.value=toInputTime(d); } else { taskModal.inDate.value=""; taskModal.inTime.value=""; }

  // przypisanie
  const ass = Array.isArray(task?.assignees)? task.assignees : (task?.assignee?[task.assignee]:[]);
  const isMulti = ass.length>1;
  taskModal.inMode.value = isMulti? "multi":"single";
  fillAssignUI(ass);

  taskModal.overlay.classList.add('visible');
}
function closeTaskModal(){ taskModal.overlay.classList.remove('visible'); }
taskModal.btnCancel.addEventListener('click', closeTaskModal);
taskModal.overlay.addEventListener('click', (e)=>{ if(e.target===taskModal.overlay) closeTaskModal(); });

function fillAssignUI(preselected=[]){
  // single
  const options = [`<option value="">‚Äî wybierz ‚Äî</option>`, ...state.users.map(u=>`<option value="${u.id||u.uid}">${$esc(u.name||u.email||u.id)}</option>`)].join("");
  document.getElementById('modal-assign-single').innerHTML = options;
  document.getElementById('modal-assign-single').value = preselected[0] || "";

  // multi
  const wrap = document.getElementById('modal-assign-multi-wrap');
  wrap.innerHTML = state.users.map(u=>{
    const id = u.id||u.uid;
    const checked = preselected.includes(id) ? "checked":"";
    return `<label style="display:flex;gap:6px;align-items:center"><input type="checkbox" value="${id}" ${checked}/> <span>${$esc(u.name||u.email||id)}</span></label>`;
  }).join("");

  const multi = (document.getElementById('modal-assign-mode').value === "multi");
  document.getElementById('modal-assign-single-wrap').style.display = multi? "none":"block";
  document.getElementById('modal-assign-multi-wrap').style.display  = multi? "grid":"none";
}
document.getElementById('modal-assign-mode').addEventListener('change', ()=> fillAssignUI([]));

fabAddTask.addEventListener('click', ()=> openTaskModal());
taskModal.btnSave.addEventListener('click', async ()=>{
  const p = currentProject(); if(!p) return;
  const title = taskModal.inTitle.value.trim();
  if(!title) return;
  const dueAt = combineDateTime(taskModal.inDate.value, taskModal.inTime.value);
  const isMulti = document.getElementById('modal-assign-mode').value === "multi";
  const multiSel = Array.from(document.querySelectorAll('#modal-assign-multi-wrap input[type=checkbox]:checked')).map(i=>i.value);
  const singleSel = document.getElementById('modal-assign-single').value;
  const assignees = isMulti ? multiSel : (singleSel? [singleSel] : []);

  const payload = {
    title, description: taskModal.inDesc.value.trim(),
    status: taskModal.inStatus.value,
    priority: taskModal.inPriority.value,
    projectId: p.id,
    assignees,
    dueAt: dueAt??null,
    updatedAt: serverTimestamp(),
    createdBy: state.currentUser?.uid || null
  };

  try{
    if(taskModal._edit){
      await updateTask(taskModal._edit, payload);
    }else{
      await addDoc(collection(db, PATHS.tasksSub(p.id)), { ...payload, createdAt: serverTimestamp() });
    }
    closeTaskModal();
  }catch(e){ console.error(e); }
});

async function updateTask(task, data){
  const p = currentProject(); if(!p) return;
  // spr√≥buj w sub
  const subRef = doc(collection(db, PATHS.tasksSub(p.id)), task.id);
  const subSnap = await getDoc(subRef);
  if(subSnap.exists()){ await updateDoc(subRef, data); return; }
  // global
  const gRef = doc(collection(db, PATHS.tasksGlobal), task.id);
  const gSnap = await getDoc(gRef);
  if(gSnap.exists()){ await updateDoc(gRef, data); return; }
  // fallback
  await setDoc(subRef, { ...data, createdAt: serverTimestamp() });
}

/* =========================
   Projekty: dodawanie/edycja/zamykanie
========================= */
const projectModal = {
  overlay: document.getElementById('project-modal'),
  title: document.getElementById('project-modal-title'),
  inName: document.getElementById('project-name-input'),
  membersList: document.getElementById('project-members-list'),
  btnSave: document.getElementById('project-save'),
  btnCancel: document.getElementById('project-cancel'),
  _editId:null
};

function openProjectModal(p){
  projectModal._editId = p?.id || null;
  projectModal.title.textContent = p? "Edytuj projekt":"Nowy projekt";
  projectModal.inName.value = p?.name || "";
  projectModal.membersList.innerHTML = state.users.map(u=>{
    const id=u.id||u.uid; const checked = (p?.members||[]).includes(id)?"checked":"";
    return `<label style="display:flex;gap:6px;align-items:center"><input type="checkbox" value="${id}" ${checked}/> <span>${$esc(u.name||u.email||id)}</span></label>`;
  }).join("");
  projectModal.overlay.classList.add('visible');
}
function closeProjectModal(){ projectModal.overlay.classList.remove('visible'); }
projectModal.btnCancel.addEventListener('click', closeProjectModal);
projectModal.overlay.addEventListener('click', (e)=>{ if(e.target===projectModal.overlay) closeProjectModal(); });

newProjectBtn.addEventListener('click', ()=> openProjectModal());
editProjectBtn.addEventListener('click', ()=>{ const p=currentProject(); if(p) openProjectModal(p); });
projectModal.btnSave.addEventListener('click', async ()=>{
  const name = projectModal.inName.value.trim();
  const members = Array.from(projectModal.membersList.querySelectorAll('input[type=checkbox]:checked')).map(i=>i.value);
  if(!name) return;
  try{
    if(projectModal._editId){
      await updateDoc(doc(projectsRef, projectModal._editId), { name, members, updatedAt: serverTimestamp() });
    }else{
      const ref = await addDoc(projectsRef, { name, members, closed:false, createdAt: serverTimestamp() });
      state.currentProjectId = ref.id;
    }
    closeProjectModal();
  }catch(e){ console.error(e); }
});

completeProjectBtn.addEventListener('click', async ()=>{
  const p = currentProject(); if(!p) return;
  try{
    const batch = writeBatch(db);
    const src = doc(projectsRef, p.id);
    const dst = doc(completedProjectsRef, p.id);
    batch.set(dst, { ...p, closed:true, closedAt: serverTimestamp() });
    batch.delete(src);
    await batch.commit();
    state.currentProjectId = null;
  }catch(e){ console.error(e); }
});

/* =========================
   Szukaj + sort (liter√≥wki naprawione)
========================= */
function performGlobalSearch(term){
  if(!term || term.length<2) return [];
  const q = term.toLowerCase();
  const allProjects = [...state.projects, ...state.completedProjects]; /* [.state.projects, .state.completedProjects] -> poprawione */ /* :contentReference[oaicite:7]{index=7} */
  return allProjects.flatMap(p =>
    (p.tasks||[]).filter(t =>
      (t.title||"").toLowerCase().includes(q) ||
      (t.description||"").toLowerCase().includes(q)
    ).map(t => ({ ...t, projectName:p.name, projectId:p.id })) /* ({ .task, ... }) -> poprawione */ /* :contentReference[oaicite:8]{index=8} */
  );
}
searchInput.addEventListener('input', ()=>{
  const results = performGlobalSearch(searchInput.value);
  // Tutaj mo≈ºesz wyrenderowaƒá w≈Çasny modal wynik√≥w ‚Äì struktura zostawiona jak u Ciebie.
});
sortBtn.addEventListener('click', ()=>{
  state.ui.sortMyTasksByDate = (state.ui.sortMyTasksByDate==='asc')?'desc':'asc';
  renderBoardFromDB();
});

/* =========================
   Sidebar mobile
========================= */
menuToggle.addEventListener('click', ()=>{ sidebar.classList.toggle('open'); sidebarOverlay.classList.toggle('visible'); });
sidebarOverlay.addEventListener('click', ()=>{ sidebar.classList.remove('open'); sidebarOverlay.classList.remove('visible'); });

</script>
</body>
</html>
