<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TeamFlow</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* CAŁY TWÓJ KOD CSS POZOSTAJE BEZ ZMIAN */
        :root {
            --bg-primary: #f4f5f7;
            --bg-secondary: #ffffff;
            --bg-tertiary: #e9eaec;
            --bg-overlay: rgba(0, 0, 0, 0.5);
            --text-primary: #172b4d;
            --text-secondary: #5e6c84;
            --text-on-accent: #ffffff;
            --border-color: #dfe1e6;
            --accent-primary: #4f46e5;
            --accent-hover: #4338ca;
            --danger-primary: #dc2626;
            --danger-hover: #b91c1c;
            --danger-border: #fca5a5; /* Nowa zmienna dla ostylowania przycisku usuwania */
            --success-primary: #16a34a;
            --priority-high-bg: #fef9c3;
            --priority-high-border: #fde047;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
            --border-radius: 8px;
            --font-family: 'Inter', sans-serif;
        }
        .dark-mode {
            --bg-primary: #1f2937;
            --bg-secondary: #374151;
            --bg-tertiary: #4b5563;
            --text-primary: #f9fafb;
            --text-secondary: #d1d5db;
            --border-color: #4b5563;
            --success-primary: #22c55e;
            --priority-high-bg: #4f46e5;
            --priority-high-border: #6d28d9;
            --danger-border: #ef4444; /* Dostosowanie koloru w trybie ciemnym */
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: var(--font-family); background-color: var(--bg-primary); color: var(--text-primary); line-height: 1.5; overflow: hidden; transition: background-color 0.3s, color 0.3s; }
        #auth-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--bg-primary); display: flex; align-items: center; justify-content: center; z-index: 10001; }
        .auth-container { background-color: var(--bg-secondary); padding: 40px; border-radius: var(--border-radius); box-shadow: var(--shadow-lg); width: 90%; max-width: 400px; text-align: center; }
        .auth-container h2 { margin-bottom: 24px; }
        #register-form { display: none; }
        .auth-form .form-group { text-align: left; }
        .auth-form .btn { width: 100%; margin-top: 16px; }
        .auth-form .btn:disabled { background-color: var(--bg-tertiary); cursor: wait; }
        .auth-toggle { margin-top: 24px; font-size: 14px; }
        .auth-toggle a { color: var(--accent-primary); font-weight: 500; cursor: pointer; }
        .error-message { color: var(--danger-primary); margin-top: 16px; font-size: 14px; min-height: 20px; }
        .app-container { display: flex; height: 100vh; position: relative; }
        .app-container.hidden { display: none; }
        .sidebar { width: 260px; background-color: var(--bg-secondary); border-right: 1px solid var(--border-color); padding: 24px; display: flex; flex-direction: column; transition: background-color 0.3s, border-color 0.3s, transform 0.3s ease-in-out; flex-shrink: 0; }
        .main-content { flex-grow: 1; padding: 24px; display: flex; flex-direction: column; overflow: hidden; }
        .sidebar-footer { margin-top: auto; border-top: 1px solid var(--border-color); padding-top: 16px; }
        .sidebar-footer .user-info { font-size: 12px; color: var(--text-secondary); margin-bottom: 8px; word-break: break-all; }
        #logout-btn { width: 100%; background: none; border: 1px solid var(--border-color); color: var(--text-secondary); }
        #logout-btn:hover { background-color: var(--bg-tertiary); }
        .sidebar-header { display: flex; align-items: center; gap: 8px; margin-bottom: 24px; }
        .sidebar-header .logo { width: 32px; height: 32px; background-color: var(--accent-primary); border-radius: var(--border-radius); display: flex; align-items: center; justify-content: center; }
        .sidebar-header .logo svg { width: 20px; height: 20px; color: white; }
        .sidebar-header h1 { font-size: 20px; font-weight: 600; }
        /* Nowy styl dla subtytułu aplikacji */
        .app-subtitle { font-size: 12px; color: var(--text-secondary); font-weight: 400; margin-top: -4px; }

        .search-bar { position: relative; margin-bottom: 16px; }
        .search-bar input { width: 100%; padding: 8px 12px 8px 32px; border-radius: var(--border-radius); border: 1px solid var(--border-color); background-color: var(--bg-primary); color: var(--text-primary); font-size: 14px; }
        .search-bar svg { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); width: 16px; height: 16px; color: var(--text-secondary); }
        .nav-section { margin-bottom: 24px; }
        .nav-section h2 { 
    font-size: 12px; 
    font-weight: 600; 
    color: var(--text-secondary); 
    text-transform: uppercase; 
    letter-spacing: 0.5px; 
    margin-bottom: 8px; 
    padding: 0 4px; 
}

.nav-list { 
    list-style: none; 
    overflow-y: auto; 
    max-height: calc(100vh - 500px); 
}

.nav-item a { 
    display: flex; 
    align-items: center; 
    gap: 12px; 
    padding: 8px 10px; 
    border-radius: var(--border-radius); 
    text-decoration: none; 
    color: var(--text-primary); 
    font-weight: 500; 
    font-size: 14px; 
    transition: background-color 0.2s, color 0.2s; 
    line-height: 1.2; /* trochę oddechu */
}

.nav-item a:hover { 
    background-color: var(--bg-tertiary); 
}

.nav-item a.active { 
    background-color: var(--accent-primary); 
    color: var(--text-on-accent); 
}

.nav-item svg {
    width: 24px;          /* standardowa siatka ikon */
    height: 24px;
    flex-shrink: 0;
    display: block;       /* eliminuje przycinanie inline */
    overflow: visible;    /* nie ucina obrysu */
    padding: 1px;         /* minimalny margines bezpieczeństwa */
}

/* opcjonalnie: gdy stroke w svg wygląda dziwnie przy skalowaniu */
.nav-item svg * {
    vector-effect: non-scaling-stroke;
}

/* POPRAWKA: Dodatkowy margines tylko dla ikony projektu */
.nav-item a[data-project-id] svg {
    margin-left: 2px;
}

.new-project-btn { 
    width: 100%; 
    padding: 10px; 
    border-radius: var(--border-radius); 
    border: none; 
    background-color: var(--accent-primary); 
    color: var(--text-on-accent); 
    font-size: 14px; 
    font-weight: 600; 
    cursor: pointer; 
    transition: background-color 0.2s; 
}

.new-project-btn:hover { 
    background-color: var(--accent-hover); 
}

.mobile-header { 
    display: none; 
}
        .main-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; flex-shrink: 0; }
        .project-title-wrapper { display: flex; align-items: center; gap: 16px; }
        .project-title h2 { font-size: 24px; font-weight: 600; }
        .project-actions button { background: none; border: 1px solid var(--border-color); color: var(--text-secondary); padding: 4px 10px; font-size: 13px; font-weight: 500; border-radius: var(--border-radius); cursor: pointer; margin-left: 8px; transition: background-color 0.2s, color 0.2s, border-color 0.2s; }
        .project-actions button:hover { background-color: var(--bg-tertiary); color: var(--text-primary); }
        .project-actions .complete-project-btn:hover { border-color: var(--danger-primary); background-color: var(--danger-primary); color: white; }
        /* Nowy styl dla przycisku usuwania */
        .project-actions .delete-project-btn {
            border-color: var(--danger-border);
            color: var(--danger-primary);
        }
        .project-actions .delete-project-btn:hover {
            border-color: var(--danger-hover);
            background-color: var(--danger-hover);
            color: white;
        }

        .project-members { display: flex; align-items: center; margin-top: 4px; }
        .avatar { width: 32px; height: 32px; border-radius: 50%; background-color: #ccc; color: var(--text-on-accent); display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 14px; border: 2px solid var(--bg-secondary); margin-left: -8px; }
        .project-members .avatar:first-child { margin-left: 0; }
        .header-actions { display: flex; align-items: center; gap: 16px; }
        .sort-btn { display: flex; align-items: center; gap: 6px; padding: 6px 12px; border: none; border-radius: var(--border-radius); background-color: var(--bg-tertiary); color: var(--text-secondary); font-weight: 500; cursor: pointer; }
        .sort-btn svg { width: 16px; height: 16px; }
        .theme-switcher { display: flex; align-items: center; background-color: var(--bg-tertiary); padding: 4px; border-radius: 20px; }
        .theme-switcher button { background: none; border: none; padding: 6px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; color: var(--text-secondary); }
        .theme-switcher button.active { background-color: var(--bg-secondary); color: var(--accent-primary); box-shadow: var(--shadow-sm); }
        .theme-switcher svg { width: 18px; height: 18px; }
        .kanban-board { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; height: 100%; overflow-x: auto; }
        .kanban-column { background-color: var(--bg-tertiary); border-radius: var(--border-radius); padding: 12px; display: flex; flex-direction: column; max-height: 100%; }
        .kanban-column-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; padding: 0 4px; gap: 8px; }
        .kanban-column-header h3 { font-size: 14px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-secondary); white-space: nowrap; }
        .task-count { font-size: 12px; font-weight: 600; background-color: var(--border-color); color: var(--text-secondary); padding: 2px 8px; border-radius: 10px; margin-left: auto; }
        .add-task-icon-btn { background: none; border: none; width: 24px; height: 24px; border-radius: 50%; color: var(--text-secondary); font-size: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: background-color 0.2s, color 0.2s; }
        .add-task-icon-btn:hover { background-color: var(--border-color); color: var(--text-primary); }
        .kanban-tasks { list-style: none; flex-grow: 1; overflow-y: auto; padding-right: 4px; }
        .kanban-tasks::-webkit-scrollbar { width: 6px; }
        .kanban-tasks::-webkit-scrollbar-thumb { background-color: var(--border-color); border-radius: 3px; }
        .task-card { background-color: var(--bg-secondary); border-left: 4px solid transparent; border-radius: var(--border-radius); padding: 12px 12px 12px 36px; margin-bottom: 12px; box-shadow: var(--shadow-sm); cursor: pointer; transition: box-shadow 0.2s, background-color 0.2s; position: relative; }
        .task-card.priority-high { background-color: var(--priority-high-bg); border-left-color: var(--priority-high-border); }
        .task-card:hover { box-shadow: var(--shadow-md); }
        .task-card.dragging { opacity: 0.5; transform: rotate(3deg); }
        .task-card-checkbox { position: absolute; left: 12px; top: 14px; width: 18px; height: 18px; cursor: pointer; }
        .task-project-name { font-size: 11px; font-weight: 600; color: var(--text-secondary); margin-bottom: 4px; display: block; }
        .task-card h4 { font-size: 15px; font-weight: 600; margin-bottom: 8px; }
        .task-card.completed h4 { text-decoration: line-through; color: var(--text-secondary); }
        .task-meta { display: flex; justify-content: space-between; align-items: center; }
        .task-details { display: flex; align-items: center; gap: 12px; }
        .task-detail { display: flex; align-items: center; gap: 4px; font-size: 12px; color: var(--text-secondary); }
        .task-detail svg { width: 14px; height: 14px; }
        .task-assignees { display: flex; }
        .task-assignees .avatar { width: 24px; height: 24px; font-size: 12px; border-color: var(--bg-tertiary); }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--bg-overlay); display: flex; align-items: center; justify-content: center; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; z-index: 1000; }
        .modal-overlay.visible { opacity: 1; visibility: visible; }
        .modal { background-color: var(--bg-secondary); border-radius: var(--border-radius); box-shadow: var(--shadow-lg); width: 90%; max-width: 800px; display: flex; flex-direction: column; transform: scale(0.95); transition: transform 0.3s; max-height: 90vh; }
        #notification-modal .modal, #confirmation-modal .modal { max-width: 400px; }
        .modal-overlay.visible .modal { transform: scale(1); }
        .modal-header { padding: 16px 24px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
        .modal-header h2 { font-size: 18px; }
        .modal-close-btn { background: none; border: none; cursor: pointer; color: var(--text-secondary); padding: 4px; font-size: 24px; line-height: 1; }
        .modal-close-btn:hover { color: var(--text-primary); }
        .task-modal-content { display: flex; overflow: hidden; }
        .task-modal-main { flex-grow: 1; padding: 24px; border-right: 1px solid var(--border-color); overflow-y: auto; }
        .task-modal-sidebar { width: 250px; padding: 24px; background-color: var(--bg-primary); flex-shrink: 0; }
        .task-modal-title { display: flex; align-items: flex-start; gap: 12px; margin-bottom: 16px; }
        .task-modal-title input[type="checkbox"] { margin-top: 8px; width: 18px; height: 18px; }
        .task-modal-title h3 { font-size: 22px; font-weight: 600; }
        .task-modal-section { margin-bottom: 24px; }
        .task-modal-section h4 { font-size: 14px; font-weight: 600; color: var(--text-secondary); margin-bottom: 8px; }
        .description textarea { width: 100%; min-height: 120px; padding: 8px; border-radius: var(--border-radius); border: 1px solid var(--border-color); background-color: var(--bg-primary); font-family: var(--font-family); font-size: 14px; resize: vertical; }
        .completion-status-list { list-style: none; }
        .completion-status-item { display: flex; align-items: center; justify-content: space-between; padding: 8px; border-radius: var(--border-radius); transition: background-color 0.2s; }
        .completion-status-item:hover { background-color: var(--bg-tertiary); }
        .completion-status-item .user-info { display: flex; align-items: center; gap: 8px; }
        .completion-status-item .user-info .avatar { width: 28px; height: 28px; font-size: 12px; margin: 0; }
        .completion-status-item .status-indicator { font-size: 12px; font-weight: 600; padding: 2px 8px; border-radius: 12px; }
        .completion-status-item .status-indicator.done { background-color: var(--success-primary); color: white; }
        .completion-status-item .status-indicator.pending { background-color: var(--border-color); color: var(--text-secondary); }
        .sidebar-detail { margin-bottom: 16px; }
        .sidebar-detail label { display: block; font-size: 12px; font-weight: 600; color: var(--text-secondary); margin-bottom: 4px; }
        .sidebar-detail select, .sidebar-detail input { width: 100%; padding: 8px; border-radius: var(--border-radius); border: 1px solid var(--border-color); background-color: var(--bg-secondary); color: var(--text-primary); }
        .form-modal-content { padding: 24px; overflow-y: auto; }
        .form-group { margin-bottom: 16px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 500; }
        .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 10px; border-radius: var(--border-radius); border: 1px solid var(--border-color); background-color: var(--bg-primary); font-family: var(--font-family); font-size: 14px; }
        .form-group textarea { resize: vertical; }
        .task-type-selection { display: flex; gap: 10px; margin-bottom: 16px; }
        .task-type-selection label { flex: 1; padding: 10px; border: 1px solid var(--border-color); border-radius: var(--border-radius); text-align: center; cursor: pointer; }
        .task-type-selection input { display: none; }
        .task-type-selection input:checked + label { background-color: var(--accent-primary); color: white; border-color: var(--accent-primary); }
        .members-selection { display: flex; flex-direction: column; gap: 8px; background-color: var(--bg-primary); padding: 12px; border-radius: var(--border-radius); max-height: 150px; overflow-y: auto; }
        .member-option { display: flex; align-items: center; gap: 8px; font-size: 14px; padding: 4px; }
        .modal-footer { padding: 16px 24px; border-top: 1px solid var(--border-color); display: flex; justify-content: flex-end; gap: 8px; background-color: var(--bg-secondary); flex-shrink: 0; }
        .btn { padding: 10px 16px; border-radius: var(--border-radius); border: none; cursor: pointer; font-weight: 600; font-size: 14px; }
        .btn-primary { background-color: var(--accent-primary); color: var(--text-on-accent); }
        .btn-danger { background-color: var(--danger-primary); color: var(--text-on-accent); }
        .btn-secondary { background-color: var(--bg-tertiary); color: var(--text-primary); }
        .confetti-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9999; overflow: hidden; }
        .confetti { position: absolute; width: 8px; height: 16px; background: #f00; opacity: 0; animation: fall 4s linear forwards; }
        @keyframes fall { 0% { transform: translateY(-10vh) rotateZ(0deg); opacity: 1; } 100% { transform: translateY(110vh) rotateZ(720deg); opacity: 0; } }
        .search-results-list { list-style: none; max-height: 50vh; overflow-y: auto; }
        .search-result-item:last-child { border-bottom: none; }
        .search-result-item:hover { background-color: var(--bg-tertiary); }
        .search-result-item h4 { font-size: 15px; font-weight: 600; margin-bottom: 4px; }
        .search-result-item p { font-size: 12px; color: var(--text-secondary); }
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(255, 255, 255, 0.8); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 10000; color: var(--text-primary); font-size: 18px; text-align: center; padding: 20px; }
        .dark-mode #loading-overlay { background-color: rgba(0, 0, 0, 0.8); }
        .fab-add-task { display: none; position: fixed; bottom: 24px; right: 24px; width: 56px; height: 56px; border-radius: 50%; background-color: var(--accent-primary); color: white; border: none; box-shadow: var(--shadow-lg); font-size: 28px; line-height: 56px; text-align: center; cursor: pointer; z-index: 1002; }
        .sidebar-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.4); z-index: 1999; }
        /* Nowe style dla komentarzy i aktywności */
        .comment-input-area {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }
        .comment-input-area textarea {
            flex-grow: 1;
            min-height: 40px;
            max-height: 100px;
            padding: 8px;
            resize: vertical;
        }
        .comments-list, .activity-list {
            list-style: none;
            max-height: 200px;
            overflow-y: auto;
            border-top: 1px solid var(--border-color);
            padding-top: 12px;
        }
        .comment-item {
            margin-bottom: 12px;
            padding: 8px 12px;
            background-color: var(--bg-primary);
            border-radius: var(--border-radius);
            font-size: 14px;
        }
        .comment-author {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }
        .activity-item {
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 8px;
            border-left: 3px solid var(--border-color);
            padding-left: 10px;
        }
        .activity-item strong {
            color: var(--text-primary);
        }
        .activity-item span.status-change {
    font-weight: 500;
    padding: 1px 6px;
    border-radius: 4px;
    /* Celowo usunęliśmy stąd 'color: white;', aby nie był domyślnie biały */
}
.status-todo { 
    background-color: var(--danger-primary); 
    color: var(--text-on-accent); /* Zapewnia biały kolor tekstu */
}
.status-inprogress { 
    background-color: var(--accent-primary);
    color: var(--text-on-accent); /* Zapewnia biały kolor tekstu */
}
.status-done { 
    background-color: var(--success-primary);
    color: var(--text-on-accent); }

        /* NOWE STYLE DLA PASKA POSTĘPU */
        .progress-bar-container {
            width: 100%;
            height: 10px;
            background-color: var(--bg-tertiary);
            border-radius: 5px;
            margin-top: 12px;
            overflow: hidden;
            box-shadow: var(--shadow-sm);
        }
        .progress-bar-fill {
            height: 100%;
            background-color: var(--success-primary);
            width: 0%;
            transition: width 0.5s ease-out;
            border-radius: 5px;
        }
        .progress-text {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-secondary);
            margin-top: 4px;
        }
        /* Style dla Pulpitu/Dashboard */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 24px;
            margin-bottom: 24px;
        }
        .dashboard-card {
            background-color: var(--bg-secondary);
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-sm);
        }
        .dashboard-card h3 {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            color: var(--accent-primary);
        }
        /* Ulepszenie wyglądu kart w Dashboardzie */
        .dashboard-grid .dashboard-card:first-child h3 {
             color: var(--danger-primary);
        }

        .chart-mockup {
            height: 100px;
            display: flex;
            align-items: flex-end;
            gap: 10px;
            padding-top: 10px;
            border-bottom: 1px solid var(--border-color);
        }
        .chart-bar {
            width: 40%;
            background-color: var(--accent-primary);
            color: white;
            text-align: center;
            font-size: 12px;
            line-height: 1.2;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            font-weight: 600;
            border-top-left-radius: 4px;
            border-top-right-radius: 4px;
            transition: height 0.5s;
        }
        .chart-label {
            font-size: 12px;
            color: var(--text-secondary);
            text-align: center;
            margin-top: 4px;
        }
        .overdue-list-container {
            max-height: 200px;
            overflow-y: auto;
        }
        .overdue-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px dotted var(--border-color);
        }
        .overdue-item:last-child {
            border-bottom: none;
        }
        .overdue-item-title {
            font-weight: 500;
            color: var(--danger-primary);
            cursor: pointer;
        }
        .overdue-item-title:hover {
            text-decoration: underline;
        }
        .overdue-item-date {
            font-size: 12px;
            color: var(--text-secondary);
        }
        .no-overdue-tasks {
            font-style: italic;
            color: var(--success-primary);
            padding: 10px 0;
        }
        /* Rozciągnięcie sekcji Kanban pod Dashboardem */
        /* Poprawiono: Użycie flexbox w kanban-board-mini, aby wymusić układ pionowy dla dashboardu. */
        .kanban-board-mini {
            width: 100%;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
        }

        /* Naprawienie głównego kontenera, który zawiera elementy Dashboardu */
        .main-content {
            /* Przy widoku Dashboardu (kanban-board display: block) chcemy, żeby zawartość płynęła w pionie */
            overflow-y: auto;
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
        }
        
        /* Kontener Dashboardu, który ma zapewnić flow pionowy */
        .dashboard-container {
            display: flex;
            flex-direction: column;
            width: 100%;
            flex-shrink: 0; /* Zapobiega ściskaniu */
        }

        @media (max-width: 768px) {
            .app-container { flex-direction: column; overflow-y: auto; }
            .sidebar { position: fixed; top: 0; left: 0; height: 100%; z-index: 2000; transform: translateX(-100%); border-right: 1px solid var(--border-color); }
            .sidebar.open { transform: translateX(0); box-shadow: var(--shadow-lg); }
            .sidebar.open + .sidebar-overlay { display: block; }
            .main-content { padding: 16px; padding-top: 70px; overflow: visible; height: auto; }
            .mobile-header { display: flex; align-items: center; justify-content: space-between; position: fixed; top: 0; left: 0; width: 100%; background-color: var(--bg-secondary); padding: 12px 16px; box-shadow: var(--shadow-sm); z-index: 1001; }
            #menu-toggle { background: none; border: none; cursor: pointer; padding: 4px; }
            #menu-toggle svg { width: 24px; height: 24px; color: var(--text-primary); }
            .mobile-header h2 { font-size: 18px; }
            .main-header { display: none; }
            .kanban-board { display: block; overflow: visible; height: auto; }
            .kanban-column { min-height: 200px; margin-bottom: 24px; }
            .kanban-tasks { overflow-y: visible; max-height: none; }
            .modal { width: 95vw; max-height: 85vh; }
            .task-modal-content { flex-direction: column; overflow-y: auto; }
            .task-modal-sidebar { width: 100%; border-top: 1px solid var(--border-color); border-right: none; }
            .fab-add-task { display: block; }
            .add-task-icon-btn { display: none; }
            .header-btn {
    background: none;
    border: none;
    padding: 6px;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--text-secondary);
    transition: background-color 0.2s, color 0.2s;
}
.header-btn:hover {
    background-color: var(--bg-tertiary);
}
.header-btn.active {
    color: var(--accent-primary);
}
.header-btn svg {
    width: 22px;
    height: 22px;
}
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div id="loading-overlay" style="display: none;">
        <p>Ładowanie aplikacji...</p>
    </div>

    <div id="auth-overlay">
        <div class="auth-container">
            <form id="login-form" class="auth-form">
                <h2>Zaloguj się</h2>
                <div class="form-group">
                    <label for="login-email">Email</label>
                    <input type="email" id="login-email" required>
                </div>
                <div class="form-group">
                    <label for="login-password">Hasło</label>
                    <input type="password" id="login-password" required>
                </div>
                <button type="submit" class="btn btn-primary">Zaloguj się</button>
                <p id="auth-error-login" class="error-message"></p>
                <p class="auth-toggle">Nie masz konta? <a id="show-register">Zarejestruj się</a></p>
            </form>

            <form id="register-form" class="auth-form">
                <h2>Stwórz konto</h2>
                 <div class="form-group">
                    <label for="register-name">Nazwa użytkownika</label>
                    <input type="text" id="register-name" required>
                </div>
                <div class="form-group">
                    <label for="register-email">Email</label>
                    <input type="email" id="register-email" required>
                </div>
                <div class="form-group">
                    <label for="register-password">Hasło (min. 6 znaków)</label>
                    <input type="password" id="register-password" required>
                </div>
                <button type="submit" class="btn btn-primary">Zarejestruj się</button>
                 <p id="auth-error-register" class="error-message"></p>
                <p class="auth-toggle">Masz już konto? <a id="show-login">Zaloguj się</a></p>
            </form>
        </div>
    </div>
    
    <div class="app-container hidden">
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6A2.25 2.25 0 016 3.75h2.25A2.25 2.25 0 0110.5 6v2.25a2.25 2.25 0 01-2.25 2.25H6a2.25 2.25 0 01-2.25-2.25V6zM3.75 15.75A2.25 2.25 0 016 13.5h2.25a2.25 2.25 0 012.25 2.25V18a2.25 2.25 0 01-2.25 2.25H6A2.25 2.25 0 013.75 18v-2.25zM13.5 6a2.25 2.25 0 012.25-2.25H18A2.25 2.25 0 0120.25 6v2.25A2.25 2.25 0 0118 10.5h-2.25a2.25 2.25 0 01-2.25-2.25V6zM13.5 15.75a2.25 2.25 0 012.25-2.25H18a2.25 2.25 0 012.25 2.25V18A2.25 2.25 0 0118 20.25h-2.25A2.25 2.25 0 0113.5 18v-2.25z" />
                    </svg>
                </div>
                <div>
                    <h1>TeamFlow</h1>
                    <!-- ZMIANA: Nowy subtytuł -->
                    <p class="app-subtitle">by Mateusz Czerwiński</p>
                </div>
            </div>

            <div class="search-bar">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" />
                </svg>
                <input type="text" placeholder="Szukaj..." id="search-input" readonly>
            </div>

            <nav class="nav-section">
                <ul class="nav-list" id="main-nav">
                    <li class="nav-item">
                        <a href="#" data-view="my-dashboard"> <!-- Zmieniono data-view na my-dashboard -->
                             <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z" />
                            </svg>
                            <span>Moje zadania</span>
                        </a>
                    </li>
                </ul>
            </nav>

            <div style="flex-grow: 1; overflow: hidden; display: flex; flex-direction: column;">
                <nav class="nav-section">
                    <h2>Moje projekty</h2>
                    <ul class="nav-list" id="projects-list">
                        </ul>
                </nav>
                
                 <nav class="nav-section" id="completed-projects-section" style="display: none;">
                    <h2>Zakończone projekty</h2>
                    <ul class="nav-list" id="completed-projects-list">
                        </ul>
                </nav>
            </div>
            
            <button class="new-project-btn" id="new-project-btn">+ Nowy Projekt</button>

            <div class="sidebar-footer">
                <p class="user-info">Zalogowano jako:<br><span id="user-email-display"></span></p>
                <button id="logout-btn" class="btn">Wyloguj</button>
            </div>
        </aside>
        <div class="sidebar-overlay" id="sidebar-overlay"></div>

        <main class="main-content">
            <header class="mobile-header">
                <button id="menu-toggle">
                     <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
                    </svg>
                </button>
                 <h2 id="mobile-header-title"></h2>
                 <div class="theme-switcher" id="mobile-theme-switcher">
                    </div>
            </header>
            <header class="main-header">
                <div>
                    <div class="project-title-wrapper">
                        <div class="project-title">
                            <h2 id="project-name-header"></h2>
                        </div>
                        <div class="project-actions" id="project-actions">
                             <button id="edit-project-btn">Edytuj projekt</button>
                             <button id="complete-project-btn" class="complete-project-btn">Zakończ projekt</button>
                             <!-- NOWY PRZYCISK DO USUNIĘCIA PROJEKTU -->
                             <button id="delete-project-btn" class="delete-project-btn">Usuń projekt</button>
                        </div>
                    </div>
                    <div class="project-members" id="project-members-header">
                       </div>

                    <!-- NOWA STRUKTURA PASKA POSTĘPU -->
                    <div id="project-progress" style="margin-top: 16px;">
                        <!-- Treść będzie dynamicznie ładowana przez JS -->
                    </div>
                    
                </div>
                <div class="header-actions">
                     <button class="sort-btn" id="sort-btn" style="display: none;">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                           <path stroke-linecap="round" stroke-linejoin="round" d="M3 7.5L7.5 3m0 0L12 7.5M7.5 3v13.5m13.5 0L16.5 21m0 0L12 16.5m4.5 4.5V7.5" />
                        </svg>
                        <span>Sortuj po dacie</span>
                    </button>
                    <div class="header-actions">
     <button class="sort-btn" id="sort-btn" style="display: none;">
        </button>
    
    <button id="notification-toggle-btn" class="header-btn" title="Zarządzaj powiadomieniami">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M14.857 17.082a23.848 23.848 0 005.454-1.31A8.967 8.967 0 0118 9.75v-.7V9A6 6 0 006 9v.75a8.967 8.967 0 01-2.312 6.022c1.733.64 3.56 1.085 5.455 1.31m5.714 0a24.255 24.255 0 01-5.714 0m5.714 0a3 3 0 11-5.714 0" />
        </svg>
    </button>
    
    <div class="theme-switcher" id="desktop-theme-switcher">
        </div>
</div>
                    <div class="theme-switcher" id="desktop-theme-switcher">
                        <button id="theme-light" title="Tryb Jasny">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z" />
                            </svg>
                        </button>
                        <button id="theme-dark" title="Tryb Ciemny">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                              <path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z" />
                            </svg>
                        </button>
                    </div>
                </div>
            </header>

            <section class="kanban-board" id="kanban-board">
                </section>
            
            <button id="fab-add-task" class="fab-add-task">+</button>
        </main>
    </div>

    <div class="modal-overlay" id="task-modal">
        <div class="modal">
            <div class="modal-header">
                <h2>Szczegóły zadania</h2>
                <button type="button" class="modal-close-btn">&times;</button>
            </div>
            <div class="task-modal-content">
                <div class="task-modal-main">
                   <div class="task-modal-title">
                        <input type="checkbox" id="modal-task-completed">
                        <h3 id="modal-task-title"></h3>
                        <input type="text" id="modal-task-title-input" class="form-group" style="font-size: 22px; font-weight: 600; flex-grow: 1; display: none;">
                    </div>

                    <div class="task-modal-section description">
                        <h4>Opis</h4>
                        <textarea id="modal-task-description" placeholder="Dodaj opis zadania..."></textarea>
                    </div>

                    <div class="task-modal-section completion-status" id="modal-completion-status-section" style="display: none;">
                        <h4>Status ukończenia</h4>
                        <ul class="completion-status-list" id="modal-completion-status-list">
                            </ul>
                    </div>
                    
                    <!-- NOWA SEKCJA: Komentarze -->
                    <div class="task-modal-section comments">
                        <h4>Komentarze</h4>
                        <div class="comment-input-area">
                            <textarea id="new-comment-text" placeholder="Napisz komentarz..." rows="1"></textarea>
                            <button class="btn btn-primary" id="add-comment-btn">Dodaj</button>
                        </div>
                        <ul class="comments-list" id="comments-list">
                            <!-- Komentarze będą ładowane dynamicznie tutaj -->
                        </ul>
                    </div>

                    <!-- NOWA SEKCJA: Historia aktywności -->
                    <div class="task-modal-section activity-log">
                        <h4>Historia aktywności</h4>
                        <ul class="activity-list" id="activity-list">
                            <!-- Aktywności będą ładowane dynamicznie tutaj -->
                        </ul>
                    </div>

                </div>
                <div class="task-modal-sidebar">
                    <div class="sidebar-detail">
                        <label for="modal-task-status">Status</label>
                        <select id="modal-task-status"></select>
                    </div>
                   <div class="sidebar-detail" id="modal-task-assignees-wrapper">
                        <label>Przypisane osoby</label>
                        <div id="modal-task-assignees-list"></div>
                        <div id="modal-task-assignees-edit" class="members-selection" style="display: none;"></div>
                    </div>
                    <div class="sidebar-detail">
                        <label for="modal-task-priority">Priorytet</label>
                        <select id="modal-task-priority">
                            <option value="low">Niski</option>
                            <option value="medium">Średni</option>
                            <option value="high">Wysoki</option>
                        </select>
                    </div>
                    <div class="sidebar-detail">
                        <label for="modal-task-dueDate">Termin wykonania</label>
                        <input type="datetime-local" id="modal-task-dueDate">
                    </div>
                </div>
            </div>
             <div class="modal-footer">
                <button type="button" id="delete-task-btn" class="btn btn-danger" style="margin-right: auto;">Usuń zadanie</button>
                <button type="button" id="edit-task-btn" class="btn btn-secondary" style="margin-right: auto; display: none;">Edytuj</button>
                <button type="button" class="btn btn-secondary modal-close-btn">Anuluj</button>
                <button type="button" id="save-task-btn" class="btn btn-primary" style="display: none;">Zapisz zmiany</button>
            </div>
        </div>
    </div>
    
    <div class="modal-overlay" id="new-project-modal">
        <div class="modal">
            <form id="new-project-form">
                <div class="modal-header">
                    <h2>Stwórz nowy projekt</h2>
                    <button type="button" class="modal-close-btn">&times;</button>
                </div>
                <div class="form-modal-content">
                    <div class="form-group">
                        <label for="new-project-name">Nazwa projektu</label>
                        <input type="text" id="new-project-name" required placeholder="np. Nowa kampania marketingowa">
                    </div>
                    <div class="form-group">
                        <label>Dodaj członków zespołu</label>
                         <div id="new-project-members" class="members-selection" style="flex-direction: row; flex-wrap: wrap;">
                            </div>
                    </div>
                    <div class="form-group">
                        <label for="new-project-tasks">Pierwsze zadania (każde w nowej linii)</label>
                        <textarea id="new-project-tasks" rows="4" placeholder="- Zaplanować spotkanie kickoff&#10;- Przygotować brief"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary modal-close-btn">Anuluj</button>
                    <button type="submit" class="btn btn-primary">Stwórz projekt</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal-overlay" id="edit-project-modal">
        <div class="modal">
            <form id="edit-project-form">
                <div class="modal-header">
                    <h2>Edytuj projekt</h2>
                    <button type="button" class="modal-close-btn">&times;</button>
                </div>
                <div class="form-modal-content">
                    <div class="form-group">
                        <label for="edit-project-name">Nazwa projektu</label>
                        <input type="text" id="edit-project-name" required>
                    </div>
                     <div class="form-group">
                        <label>Członkowie zespołu</label>
                        <div id="edit-project-members" class="members-selection" style="flex-direction: row; flex-wrap: wrap;">
                            </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary modal-close-btn">Anuluj</button>
                    <button type="submit" class="btn btn-primary">Zapisz zmiany</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal-overlay" id="new-task-modal">
        <div class="modal">
            <form id="new-task-form">
                <div class="modal-header">
                    <h2>Dodaj nowe zadanie</h2>
                    <button type="button" class="modal-close-btn">&times;</button>
                </div>
                <div class="form-modal-content">
                     <div class="form-group" id="new-task-project-group">
                        <label for="new-task-project">Projekt</label>
                        <select id="new-task-project"></select>
                    </div>
                    <div class="form-group">
                        <label for="new-task-title">Tytuł zadania</label>
                        <input type="text" id="new-task-title" required placeholder="np. Zaprojektować nowy landing page">
                    </div>
                     <div class="form-group">
                        <label>Typ zadania</label>
                        <div class="task-type-selection">
                            <input type="radio" id="task-type-single" name="task-type" value="single" checked>
                            <label for="task-type-single">Jednoosobowe</label>
                            <input type="radio" id="task-type-multi" name="task-type" value="multi">
                            <label for="task-type-multi">Wieloosobowe</label>
                        </div>
                    </div>
                     <div class="form-group" id="new-task-assignee-single-wrapper">
                        <label for="new-task-assignee-select">Przypisz do</label>
                        <select id="new-task-assignee-select"></select>
                    </div>
                    <div class="form-group" id="new-task-assignee-multi-wrapper" style="display: none;">
                        <label>Wybierz osoby</label>
                        <div id="new-task-assignee-multi-list" class="members-selection"></div>
                    </div>
                    <div class="form-group">
                        <label for="new-task-description">Opis</label>
                        <textarea id="new-task-description" rows="3" placeholder="Dodaj więcej szczegółów..."></textarea>
                    </div>
                    <div style="display: flex; gap: 16px;">
                        <div class="form-group" style="flex: 1;">
                            <label for="new-task-dueDate">Termin</label>
                            <input type="datetime-local" id="new-task-dueDate">
                        </div>
                         <div class="form-group" style="flex: 1;">
                            <label for="new-task-priority">Priorytet</label>
                            <select id="new-task-priority">
                                <option value="low">Niski</option>
                                <option value="medium" selected>Średni</option>
                                <option value="high">Wysoki</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary modal-close-btn">Anuluj</button>
                    <button type="submit" class="btn btn-primary">Zapisz zadanie</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal-overlay" id="search-modal">
        <div class="modal">
            <div class="modal-header">
                <h2>Wyszukaj zadania</h2>
                <button type="button" class="modal-close-btn">&times;</button>
            </div>
            <div class="form-modal-content">
                <div class="search-bar" style="margin-bottom: 24px;">
                     <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" />
                    </svg>
                     <input type="text" placeholder="Wpisz szukaną frazę..." id="modal-search-input">
                </div>
                <ul id="search-results-list" class="search-results-list">
                    </ul>
            </div>
        </div>
    </div>
    
    <div class="modal-overlay" id="notification-modal">
        <div class="modal">
             <div class="modal-header">
                <h2 id="notification-title">Powiadomienie</h2>
                <button type="button" class="modal-close-btn">&times;</button>
            </div>
            <div class="form-modal-content">
                <p id="notification-message"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary modal-close-btn">OK</button>
            </div>
        </div>
    </div>
    
    <!-- NOWY MODAL POTWIERDZENIA -->
    <div class="modal-overlay" id="confirmation-modal">
        <div class="modal">
             <div class="modal-header">
                <h2 id="confirmation-title">Potwierdzenie</h2>
                <button type="button" class="modal-close-btn" data-action="cancel">&times;</button>
            </div>
            <div class="form-modal-content">
                <p id="confirmation-message">Czy na pewno chcesz wykonać tę akcję?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary modal-close-btn" data-action="cancel">Anuluj</button>
                <button type="button" class="btn btn-danger" id="confirmation-action-btn" data-action="confirm">Potwierdź</button>
            </div>
        </div>
    </div>

    <script type="module">
        // ============================
        // 1. IMPORTY
        // ============================
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, addDoc, updateDoc, deleteDoc, onSnapshot, collection, query, writeBatch, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getMessaging, getToken, onMessage } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-messaging.js";

        // ============================
        // 2. KONFIGURACJA FIREBASE (z placeholderami!)
        // ============================
        const firebaseConfig = {
            apiKey: "__API_KEY__",
            authDomain: "__AUTH_DOMAIN__",
            projectId: "__PROJECT_ID__",
            storageBucket: "__STORAGE_BUCKET__",
            messagingSenderId: "__MESSAGING_SENDER_ID__",
            appId: "__APP_ID__"
        };

        // ============================
        // 3. INICJALIZACJA FIREBASE (poza DOMContentLoaded)
        // ============================
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        let db, auth, app; // Deklarujemy zmienne globalnie w skrypcie

        const loadingOverlay = document.getElementById('loading-overlay');
        const authOverlay = document.getElementById('auth-overlay');
        const appContainer = document.querySelector('.app-container');

        try {
            app = initializeApp(firebaseConfig); // Przypisujemy zainicjalizowaną aplikację
            db = getFirestore(app);
            auth = getAuth(app);
        } catch (error) {
            console.error("Błąd inicjalizacji Firebase:", error);
            authOverlay.innerHTML = `<div class="auth-container"><h2>Błąd Konfiguracji</h2><p>${error.message}</p></div>`;
        }

        // Definicje referencji do kolekcji (muszą być tutaj, bo używają 'db')
        const projectsRef = collection(db, `artifacts/${appId}/public/data/projects`);
        const completedProjectsRef = collection(db, `artifacts/${appId}/public/data/completedProjects`);
        const usersRef = collection(db, `artifacts/${appId}/public/data/users`);


        // ============================
        // 4. GŁÓWNA LOGIKA APLIKACJI (wszystko wewnątrz DOMContentLoaded)
        // ============================
        document.addEventListener('DOMContentLoaded', () => {
            
            // --- Definicja stanu i stałych ---
            const STATUSES = {
                todo: 'Do realizacji',
                inprogress: 'W trakcie realizacji',
                done: 'Wykonane'
            };

            let state = {
                currentUser: null,
                users: [],
                projects: [],
                completedProjects: [],
                currentProjectId: null,
                ui: {
                    theme: 'light',
                    currentView: 'my-dashboard',
                    sortMyTasksByDate: 'asc',
                    projectSortOrders: {}, // <-- DODANA LINIA
                    unsubscribeProjects: null,
                    unsubscribeCompleted: null,
                    unsubscribeUsers: null,
                    chartInstance: null
                }
            };
            
            // --- Pobieranie referencji do elementów HTML ---
            const notificationToggleBtn = document.getElementById('notification-toggle-btn');
            const sidebar = document.getElementById('sidebar');
            const sidebarOverlay = document.getElementById('sidebar-overlay');
            const menuToggle = document.getElementById('menu-toggle');
            const mobileHeaderTitle = document.getElementById('mobile-header-title');
            const mobileThemeSwitcher = document.getElementById('mobile-theme-switcher');
            const desktopThemeSwitcher = document.getElementById('desktop-theme-switcher');
            const mainNav = document.getElementById('main-nav');
            const projectsListEl = document.getElementById('projects-list');
            const completedProjectsSection = document.getElementById('completed-projects-section');
            const completedProjectsListEl = document.getElementById('completed-projects-list');
            const projectNameHeaderEl = document.getElementById('project-name-header');
            const projectMembersHeaderEl = document.getElementById('project-members-header');
            const projectProgressEl = document.getElementById('project-progress'); // NOWA REFERENCJA
            const kanbanBoardEl = document.getElementById('kanban-board');
            const sortBtn = document.getElementById('sort-btn');
            const searchInput = document.getElementById('search-input');
            const projectActionsEl = document.getElementById('project-actions');
            const editProjectBtn = document.getElementById('edit-project-btn');
            const completeProjectBtn = document.getElementById('complete-project-btn');
            const deleteProjectBtn = document.getElementById('delete-project-btn'); // Nowa referencja
            const userEmailDisplay = document.getElementById('user-email-display');
            const logoutBtn = document.getElementById('logout-btn');
            const newProjectBtn = document.getElementById('new-project-btn');
            const fabAddTask = document.getElementById('fab-add-task');
            const loginForm = document.getElementById('login-form');
            const registerForm = document.getElementById('register-form');
            const showRegisterBtn = document.getElementById('show-register');
            const showLoginBtn = document.getElementById('show-login');
            const authErrorLogin = document.getElementById('auth-error-login');
            const authErrorRegister = document.getElementById('auth-error-register');
            const taskModal = {
                overlay: document.getElementById('task-modal'),
                title: document.getElementById('modal-task-title'),
                completed: document.getElementById('modal-task-completed'),
                description: document.getElementById('modal-task-description'),
                status: document.getElementById('modal-task-status'),
                assigneesList: document.getElementById('modal-task-assignees-list'),
                completionStatusSection: document.getElementById('modal-completion-status-section'),
                completionStatusList: document.getElementById('modal-completion-status-list'),
                priority: document.getElementById('modal-task-priority'),
                dueDate: document.getElementById('modal-task-dueDate'),
                saveBtn: document.getElementById('save-task-btn'),
                deleteBtn: document.getElementById('delete-task-btn'),
                editBtn: document.getElementById('edit-task-btn'), // <-- DODAJ
                titleInput: document.getElementById('modal-task-title-input'), // <-- DODAJ
                assigneesEdit: document.getElementById('modal-task-assignees-edit'), // <-- DODAJ
                commentsList: document.getElementById('comments-list'), // NOWA REFERENCJA
                newCommentText: document.getElementById('new-comment-text'), // NOWA REFERENCJA
                addCommentBtn: document.getElementById('add-comment-btn'), // NOWA REFERENCJA
                activityList: document.getElementById('activity-list'), // NOWA REFERENCJA
            };
            const newProjectModal = {
                overlay: document.getElementById('new-project-modal'),
                form: document.getElementById('new-project-form'),
                nameInput: document.getElementById('new-project-name'),
                membersContainer: document.getElementById('new-project-members'),
                tasksTextarea: document.getElementById('new-project-tasks'),
            };
            const editProjectModal = {
                overlay: document.getElementById('edit-project-modal'),
                form: document.getElementById('edit-project-form'),
                nameInput: document.getElementById('edit-project-name'),
                membersContainer: document.getElementById('edit-project-members'),
            };
            const newTaskModal = {
                overlay: document.getElementById('new-task-modal'),
                form: document.getElementById('new-task-form'),
                projectGroup: document.getElementById('new-task-project-group'),
                projectSelect: document.getElementById('new-task-project'),
                title: document.getElementById('new-task-title'),
                description: document.getElementById('new-task-description'),
                taskTypeRadios: document.querySelectorAll('input[name="task-type"]'),
                assigneeSingleWrapper: document.getElementById('new-task-assignee-single-wrapper'),
                assigneeSingleSelect: document.getElementById('new-task-assignee-select'),
                assigneeMultiWrapper: document.getElementById('new-task-assignee-multi-wrapper'),
                assigneeMultiList: document.getElementById('new-task-assignee-multi-list'),
                dueDate: document.getElementById('new-task-dueDate'),
                priority: document.getElementById('new-task-priority'),
            };
            const searchModal = {
                overlay: document.getElementById('search-modal'),
                input: document.getElementById('modal-search-input'),
                resultsList: document.getElementById('search-results-list'),
            };
            const notificationModal = {
                overlay: document.getElementById('notification-modal'),
                title: document.getElementById('notification-title'),
                message: document.getElementById('notification-message'),
            };
            // Nowa referencja do modala potwierdzenia
            const confirmationModal = {
                overlay: document.getElementById('confirmation-modal'),
                title: document.getElementById('confirmation-title'),
                message: document.getElementById('confirmation-message'),
                confirmBtn: document.getElementById('confirmation-action-btn'),
            };


            // --- Definicje wszystkich funkcji ---
            // ... (pozostałe funkcje pomocnicze)
            function showConfirmation(title, message, callback, danger = false) {
                confirmationModal.title.textContent = title;
                confirmationModal.message.textContent = message;
                confirmationModal.confirmBtn.onclick = () => {
                    closeModal(confirmationModal.overlay);
                    callback(true);
                };
                confirmationModal.confirmBtn.classList.toggle('btn-danger', danger);
                confirmationModal.confirmBtn.classList.toggle('btn-primary', !danger);
                openModal(confirmationModal.overlay);
            }

            async function requestNotificationPermission() {
                try {
                    const messaging = getMessaging(app);
                    const permission = await Notification.requestPermission();
                    if (permission === "granted") {
                        console.log("Zgoda na powiadomienia uzyskana.");
                        const currentToken = await getToken(messaging);
                        if (currentToken) {
                            console.log("Otrzymano token FCM: ", currentToken);
                            if (state.currentUser) {
                                const userRef = doc(usersRef, state.currentUser.uid);
                                const userDoc = await getDoc(userRef);
                                if (userDoc.exists()) {
                                    const tokens = userDoc.data().fcmTokens || [];
                                    if (!tokens.includes(currentToken)) {
                                        await updateDoc(userRef, { fcmTokens: [...tokens, currentToken] });
                                        console.log("Token FCM został dodany.");
                                    }
                                }
                            }
                        } else {
                            console.warn("Nie udało się uzyskać tokenu FCM.");
                        }
                    }
                } catch (error) {
                    console.error("Błąd podczas prośby o zgodę na powiadomienia:", error);
                }
            }
            
            function findUser(userId) { return state.users.find(u => u.id === userId); }
            function findProject(projectId) { return state.projects.find(p => p.id === projectId); }
            function findCompletedProject(projectId) { return state.completedProjects.find(p => p.id === projectId); }
            
            function migrateTask(task) {
                if (!task.type) {
                    task.type = 'single';
                    task.assignees = task.assignee ? [task.assignee] : [];
                    task.completedBy = task.status === 'done' && task.assignee ? [task.assignee] : [];
                }
                if (!task.assignees) task.assignees = [];
                if (!task.completedBy) task.completedBy = [];
                // Upewnij się, że istnieją tablice dla komentarzy i aktywności
                if (!task.comments) task.comments = [];
                if (!task.activityLog) task.activityLog = [];
                return task;
            }

            function findTask(taskId) {
                const allProjects = [...state.projects, ...state.completedProjects];
                for (const project of allProjects) {
                    const task = (project.tasks || []).find(t => t.id === taskId);
                    if (task) return { task: migrateTask(task), project };
                }
                return { task: null, project: null };
            };
            
            // NOWA FUNKCJA: Pobiera wszystkie zadania użytkownika
            function getAllMyTasks() {
                const allProjects = [...state.projects, ...state.completedProjects];
                return allProjects.flatMap(p => 
                    (p.tasks || [])
                        .map(migrateTask)
                        .filter(t => t.assignees.includes(state.currentUser.uid))
                        .map(t => ({ ...t, projectName: p.name, projectId: p.id }))
                );
            }
            
            // NOWA FUNKCJA: Pobiera opóźnione zadania
            function getOverdueTasks(tasks) {
                const now = Date.now();
                return tasks.filter(t => 
                    t.dueDate && new Date(t.dueDate).getTime() < now && t.status !== 'done'
                ).sort((a, b) => new Date(a.dueDate).getTime() - new Date(b.dueDate).getTime()); // Sortuje od najstarszych
            }

            const saveUiState = () => localStorage.setItem(`teamFlowUiState_${appId}`, JSON.stringify(state.ui));
            const loadUiState = () => {
                const savedUiState = localStorage.getItem(`teamFlowUiState_${appId}`);
                if (savedUiState) {
                    const loadedUi = JSON.parse(savedUiState);
                    state.ui = { ...state.ui, ...loadedUi, 
                        unsubscribeProjects: state.ui.unsubscribeProjects,
                        unsubscribeCompleted: state.ui.unsubscribeCompleted,
                        unsubscribeUsers: state.ui.unsubscribeUsers
                    };
                }
            };

            function render() {
            if(!state.currentUser) return;
            applyTheme();
            renderSidebar();

            // Ustawienie widoczności przycisku sortowania
            const isProjectView = state.ui.currentView === 'projects' && state.currentProjectId;
            const isDashboardView = state.ui.currentView === 'my-dashboard';
            sortBtn.style.display = isProjectView || isDashboardView ? 'flex' : 'none';

            if (isProjectView) {
                renderCurrentProjectView();
            } else if (isDashboardView) {
                renderMyDashboardView();
            }
        }

            function renderSidebar() {
                // Aktywuj link dashboardu, jeśli to obecny widok
                mainNav.querySelector('a').classList.toggle('active', state.ui.currentView === 'my-dashboard');
                const renderProjectList = (projects, listEl) => {
                    listEl.innerHTML = '';
                    (projects || []).forEach(project => {
                        const li = document.createElement('li');
                        li.className = 'nav-item';
                        // Zaktualizowano klasę aktywności dla projektu
                        li.innerHTML = `<a href="#" data-project-id="${project.id}" class="${project.id === state.currentProjectId && state.ui.currentView === 'projects' ? 'active' : ''}"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg><span>${project.name}</span></a>`;
                        listEl.appendChild(li);
                    });
                };
                renderProjectList(state.projects, projectsListEl);
                if(state.completedProjects.length > 0) {
                    completedProjectsSection.style.display = 'block';
                    renderProjectList(state.completedProjects, completedProjectsListEl);
                } else {
                    completedProjectsSection.style.display = 'none';
                }
            }

            function renderCurrentProjectView() {
                const project = findProject(state.currentProjectId) || findCompletedProject(state.currentProjectId);
                const isCompleted = !!findCompletedProject(state.currentProjectId);
                const isOwner = project && project.ownerId === state.currentUser.uid;
                
                projectActionsEl.style.display = project && isOwner ? 'flex' : 'none';

                if (project && isOwner) {
                    editProjectBtn.style.display = 'inline-block';
                    deleteProjectBtn.style.display = 'inline-block';
                    completeProjectBtn.style.display = isCompleted ? 'none' : 'inline-block';
                } else {
                    editProjectBtn.style.display = 'none';
                    completeProjectBtn.style.display = 'none';
                    deleteProjectBtn.style.display = 'none';
                }

                if (!project) {
                     projectNameHeaderEl.textContent = 'Wybierz projekt';
                     mobileHeaderTitle.textContent = 'Projekty';
                     projectMembersHeaderEl.innerHTML = '';
                     projectProgressEl.innerHTML = '';
                     kanbanBoardEl.innerHTML = '<p>Wybierz projekt lub stwórz nowy, aby zacząć.</p>';
                     return;
                }
                projectNameHeaderEl.textContent = project.name;
                mobileHeaderTitle.textContent = project.name;
                projectMembersHeaderEl.innerHTML = '';
                (project.members || []).forEach(memberId => {
                    const user = findUser(memberId);
                    if (user) {
                        const avatar = document.createElement('div');
                        avatar.className = 'avatar';
                        avatar.style.backgroundColor = user.avatarColor || '#ccc';
                        avatar.textContent = user.name ? user.name.split(' ').map(n => n[0]).join('') : user.email.substring(0,2).toUpperCase();
                        avatar.title = user.name || user.email;
                        projectMembersHeaderEl.appendChild(avatar);
                    }
                });

                const projectTasks = (project.tasks || []).map(migrateTask);
                const totalTasks = projectTasks.length;
                const completedTasks = projectTasks.filter(t => t.status === 'done').length;
                const progressPercent = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
                
                projectProgressEl.innerHTML = `
                    <div class="progress-bar-container" title="${progressPercent}% ukończenia">
                        <div class="progress-bar-fill" style="width: ${progressPercent}%;"></div>
                    </div>
                    <div class="progress-text">${completedTasks} z ${totalTasks} zadań ukończonych (${progressPercent}%)</div>
                `;
                projectProgressEl.style.display = totalTasks > 0 ? 'block' : 'none';

                // ▼▼▼ NOWA LOGIKA: SORTOWANIE ZADAŃ PROJEKTU ▼▼▼
                const sortOrder = state.ui.projectSortOrders[project.id] || 'asc'; // Domyślnie 'asc'
                projectTasks.sort((a, b) => {
                    const dateA = a.dueDate ? new Date(a.dueDate).getTime() : Infinity;
                    const dateB = b.dueDate ? new Date(b.dueDate).getTime() : Infinity;
                    if (dateA === Infinity && dateB === Infinity) return 0;
                    if (dateA === Infinity) return 1;
                    if (dateB === Infinity) return -1;
                    return sortOrder === 'asc' ? dateA - dateB : dateB - dateA;
                });
                // ▲▲▲ KONIEC NOWEJ LOGIKI ▲▲▲

                renderKanbanBoard(projectTasks, !isCompleted);
            }
            
            // NOWA FUNKCJA: Renderuje widok "Mój Pulpit"
            function renderMyDashboardView() {
                projectNameHeaderEl.textContent = 'Mój Pulpit';
                mobileHeaderTitle.textContent = 'Mój Pulpit';
                projectMembersHeaderEl.innerHTML = '';
                projectActionsEl.style.display = 'none';
                projectProgressEl.innerHTML = ''; 
                fabAddTask.style.display = 'none'; // Ukryj FAB

                const myTasks = getAllMyTasks();
                
                // Sortowanie zadań przed podziałem na dashboard i kanban
                myTasks.sort((a, b) => {
                    const dateA = a.dueDate ? new Date(a.dueDate).getTime() : Infinity;
                    const dateB = b.dueDate ? new Date(b.dueDate).getTime() : Infinity;
                    if (dateA === Infinity && dateB === Infinity) return 0;
                    if (dateA === Infinity) return 1;
                    if (dateB === Infinity) return -1;
                    return state.ui.sortMyTasksByDate === 'asc' ? dateA - dateB : dateB - dateA;
                });
                
                const overdueTasks = getOverdueTasks(myTasks);
                const todoCount = myTasks.filter(t => t.status === 'todo').length;
                const inProgressCount = myTasks.filter(t => t.status === 'inprogress').length;
                const totalActiveTasks = todoCount + inProgressCount;

                // Obliczenia do wykresu (mock)
                const todoHeight = totalActiveTasks > 0 ? Math.round((todoCount / totalActiveTasks) * 100) : 0;
                const inProgressHeight = totalActiveTasks > 0 ? Math.round((inProgressCount / totalActiveTasks) * 100) : 0;
                
                // Struktura Dashboardu
                // UŻYCIE GŁÓWNEGO KONTENERA KANBAN-BOARD DO ZAWIEARANIA WSZYSTKIEGO W WIDOKU DASHBOARD
                kanbanBoardEl.innerHTML = `
                    <div class="dashboard-container"> <!-- KONTENER ZAPEWNIAJĄCY PIONOWY FLOW -->
                        <div class="dashboard-grid">
                            <div class="dashboard-card">
                                <h3>Opóźnione Zadania (${overdueTasks.length})</h3>
                                <div class="overdue-list-container">
                                    ${overdueTasks.length > 0 ? 
                                        overdueTasks.map(task => `
                                            <div class="overdue-item" data-task-id="${task.id}" data-project-id="${task.projectId}">
                                                <span class="overdue-item-title">${task.title}</span>
                                                <span class="overdue-item-date">${new Date(task.dueDate).toLocaleDateString('pl-PL')}</span>
                                            </div>
                                        `).join('') :
                                        '<p class="no-overdue-tasks">Brak opóźnionych zadań. Dobra robota!</p>'
                                    }
                                </div>
                            </div>
                            <div class="dashboard-card">
                                <h3>Obciążenie zadaniami (Aktywne: ${totalActiveTasks})</h3>
                                <div class="chart-mockup">
                                    <div class="chart-bar" style="height: ${todoHeight}% !important; background-color: var(--danger-primary);" title="${todoCount} Do realizacji">${todoCount}</div>
                                    <div class="chart-bar" style="height: ${inProgressHeight}% !important; background-color: var(--accent-primary);" title="${inProgressCount} W trakcie">${inProgressCount}</div>
                                </div>
                                <div style="display: flex; justify-content: space-around; margin-top: 8px;">
                                    <div class="chart-label" style="width: 40%; color: var(--danger-primary);">Do realizacji</div>
                                    <div class="chart-label" style="width: 40%; color: var(--accent-primary);">W trakcie</div>
                                </div>
                            </div>
                        </div>
                        
                        <h2 style="font-size: 20px; font-weight: 600; margin-bottom: 16px;">Wszystkie Twoje Zadania</h2>
                        <section id="my-tasks-kanban" class="kanban-board-mini">
                        </section>
                    </div>
                `;
                
                // Renderuj Kanban dla wszystkich zadań użytkownika w nowej sekcji
                const myTasksKanbanEl = document.getElementById('my-tasks-kanban');
                
                // Zapewnienie, że sekcja Kanbana jest poprawnie inicjowana
                const renderMyTasksKanban = (tasks, targetElement) => {
                    targetElement.innerHTML = '';
                    targetElement.style.display = 'grid';
                    targetElement.style.gridTemplateColumns = 'repeat(3, 1fr)';
                    targetElement.style.gap = '16px';
                    targetElement.style.overflowX = 'auto'; 
                    
                    Object.keys(STATUSES).forEach(statusKey => {
                        const column = document.createElement('div');
                        column.className = 'kanban-column';
                        column.dataset.status = statusKey;
                        // Kanban w widoku Dashboardu powinien być interaktywny
                        const tasksInColumn = tasks.filter(t => t.status === statusKey); 
                        
                        column.innerHTML = `<div class="kanban-column-header"><h3>${STATUSES[statusKey]}</h3><span class="task-count">${tasksInColumn.length}</span></div><ul class="kanban-tasks">${tasksInColumn.map(task => createTaskCardHTML(task, true)).join('')}</ul>`;
                        targetElement.appendChild(column);
                    });
                };
                
                renderMyTasksKanban(myTasks, myTasksKanbanEl);
                
                // Dodanie listenera dla opóźnionych zadań (pozwala na kliknięcie i otwarcie modala)
                document.querySelectorAll('.overdue-item').forEach(item => {
                    item.addEventListener('click', (e) => {
                        const taskId = e.currentTarget.dataset.taskId;
                        openTaskModal(taskId);
                    });
                });
                
                // W widoku Dashboardu, główny kanban-board jest używany jako kontener pionowy
                kanbanBoardEl.style.display = 'block';
                kanbanBoardEl.style.overflow = 'visible';
            }

            function renderKanbanBoard(tasks, isInteractive) {
                // Ta funkcja jest używana DLA PROJEKTÓW
                kanbanBoardEl.innerHTML = '';
                kanbanBoardEl.style.display = 'grid'; // Wróć do grid dla Kanban
                kanbanBoardEl.style.overflow = 'auto'; 
                
                Object.keys(STATUSES).forEach(statusKey => {
                    const column = document.createElement('div');
                    column.className = 'kanban-column';
                    column.dataset.status = statusKey;
                    const tasksInColumn = (tasks || []).filter(t => t.status === statusKey);
                    const addTaskBtnHTML = (isInteractive && statusKey === 'todo') ? `<button class="add-task-icon-btn" title="Dodaj nowe zadanie">+</button>` : '';
                    column.innerHTML = `<div class="kanban-column-header"><h3>${STATUSES[statusKey]}</h3><span class="task-count">${tasksInColumn.length}</span>${addTaskBtnHTML}</div><ul class="kanban-tasks">${tasksInColumn.map(task => createTaskCardHTML(task, isInteractive)).join('')}</ul>`;
                    kanbanBoardEl.appendChild(column);
                });
            }
            
            function createTaskCardHTML(task, isInteractive) {
                const isCompleted = task.status === 'done';
                const priorityClass = task.priority === 'high' ? 'priority-high' : '';
                const projectNameHTML = task.projectName ? `<span class="task-project-name">${task.projectName}</span>` : '';
                
                const assigneesHTML = (task.assignees || []).map(assigneeId => {
                    const user = findUser(assigneeId);
                    return user ? `<div class="avatar" style="background-color: ${user.avatarColor || '#ccc'}" title="${user.name || user.email}">${(user.name || user.email).substring(0,2).toUpperCase()}</div>` : '';
                }).join('');
                
                // Dodanie klasy 'overdue' jeśli zadanie jest opóźnione
                const isOverdue = task.dueDate && new Date(task.dueDate).getTime() < Date.now() && task.status !== 'done';
                const overdueClass = isOverdue ? 'overdue' : '';

                const dueDateHTML = task.dueDate ? `
                    <div class="task-detail ${overdueClass}">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75m-18 0h18" /></svg>
                        <span style="${isOverdue ? 'color: var(--danger-primary); font-weight: 600;' : ''}">${new Date(task.dueDate).toLocaleString('pl-PL', {day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit'})}</span>
                    </div>` : '';
                
                const multiUserIcon = task.type === 'multi' ? `
                    <div class="task-detail" title="Zadanie wieloosobowe">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M18 18.72a9.094 9.094 0 003.741-.479 3 3 0 00-4.682-2.72m-7.5-2.962A3.75 3.75 0 0115 9.75c0 1.036-.394 2.006-1.097 2.753m-10.243-4.553a4.5 4.5 0 118.23 4.762A4.5 4.5 0 006.75 12.75c-1.631 0-3.133-.82-4.01-2.043M15.75 9.75c0-1.036.394-2.006 1.097-2.753A3.75 3.75 0 0015 3.75c-1.631 0-3.133.82-4.01 2.043m5.858 5.858a3.75 3.75 0 00-5.858-5.858m0 0A3.75 3.75 0 019.75 5.25c1.036 0 2.006.394 2.753 1.097" /></svg>
                    </div>` : '';

                return `<li class="task-card ${isCompleted ? 'completed' : ''} ${priorityClass}" ${isInteractive ? 'draggable="true"' : ''} data-task-id="${task.id}">
                    <input type="checkbox" class="task-card-checkbox" data-task-id="${task.id}" ${isCompleted ? 'checked' : ''} ${isInteractive ? '' : 'disabled'}>
                    ${projectNameHTML}
                    <h4>${task.title}</h4>
                    <div class="task-meta">
                        <div class="task-details">${dueDateHTML}${multiUserIcon}</div>
                        <div class="task-assignees">${assigneesHTML}</div>
                    </div>
                </li>`;
            }
            
            function applyTheme() {
                const isDark = state.ui.theme === 'dark';
                document.body.classList.toggle('dark-mode', isDark);
                document.querySelectorAll('.theme-switcher').forEach(switcher => {
                    switcher.querySelector('#theme-dark')?.classList.toggle('active', isDark);
                    switcher.querySelector('#theme-light')?.classList.toggle('active', !isDark);
                });
            }
            
            function openModal(modal) { modal.classList.add('visible'); }
            function closeModal(modal) { modal.classList.remove('visible'); }
            function showNotification(message, title = 'Powiadomienie') {
                notificationModal.title.textContent = title;
                notificationModal.message.textContent = message;
                openModal(notificationModal.overlay);
            }

           async function openTaskModal(taskId) {
                const { task, project } = findTask(taskId);
                if (!task || !project) return;

                // --- TRYB WIDOKU (domyślny) ---
                const setViewMode = () => {
                    taskModal.overlay.dataset.taskId = taskId;
                    
                    taskModal.title.textContent = task.title;
                    taskModal.title.style.display = 'block';
                    taskModal.titleInput.style.display = 'none';

                    taskModal.completed.checked = task.status === 'done';
                    taskModal.description.value = task.description || '';
                    taskModal.priority.value = task.priority;
                    taskModal.dueDate.value = task.dueDate;
                    taskModal.status.innerHTML = Object.keys(STATUSES).map(key => `<option value="${key}" ${task.status === key ? 'selected' : ''}>${STATUSES[key]}</option>`).join('');
                    
                    Array.from(taskModal.overlay.querySelectorAll('.description textarea, .sidebar-detail select, .sidebar-detail input')).forEach(el => el.disabled = true);
                    taskModal.completed.disabled = false;

                    taskModal.assigneesList.innerHTML = (task.assignees || []).map(memberId => {
                        const user = findUser(memberId);
                        return user ? `<div title="${user.name || user.email}" class="avatar" style="background-color: ${user.avatarColor || '#ccc'}">${(user.name || user.email).substring(0,2).toUpperCase()}</div>` : '';
                    }).join('');
                    taskModal.assigneesEdit.style.display = 'none';
                    taskModal.assigneesList.style.display = 'flex';

                    taskModal.saveBtn.style.display = 'none';
                    const isCreator = !task.createdBy || (task.createdBy && task.createdBy === state.currentUser.uid);
                    taskModal.deleteBtn.style.display = isCreator ? 'block' : 'none';
                    taskModal.editBtn.style.display = isCreator ? 'block' : 'none';

                    if (task.type === 'multi') {
                        taskModal.completionStatusSection.style.display = 'block';
                        taskModal.completionStatusList.innerHTML = (task.assignees || []).map(userId => {
                            const user = findUser(userId);
                            const isDone = task.completedBy.includes(userId);
                            const isCurrentUser = userId === state.currentUser.uid;
                            const actionButton = isCurrentUser && !isDone ? `<button class="btn btn-primary btn-sm" data-user-id="${userId}" id="complete-my-part-btn">Oznacz jako wykonane</button>` : '';
                            return `<li class="completion-status-item"><div class="user-info"><div class="avatar" style="background-color: ${user.avatarColor || '#ccc'}" title="${user.name || user.email}">${(user.name || user.email).substring(0,2).toUpperCase()}</div><span>${user.name || user.email}</span></div><div class="status-indicator-wrapper">${actionButton}<span class="status-indicator ${isDone ? 'done' : 'pending'}">${isDone ? 'Gotowe' : 'Oczekuje'}</span></div></li>`;
                        }).join('');
                    } else {
                        taskModal.completionStatusSection.style.display = 'none';
                    }
                    
                    renderComments(task);
                    renderActivityLog(task);
                    openModal(taskModal.overlay);
                };

                // --- TRYB EDYCJI ---
                const setEditMode = () => {
                    taskModal.title.style.display = 'none';
                    taskModal.titleInput.value = task.title;
                    taskModal.titleInput.style.display = 'block';

                    Array.from(taskModal.overlay.querySelectorAll('select, textarea, input[type="datetime-local"]')).forEach(el => el.disabled = false);

                    taskModal.assigneesList.style.display = 'none';
                    taskModal.assigneesEdit.style.display = 'block';
                    const membersOptions = (project.members || []).map(memberId => findUser(memberId)).filter(Boolean);
                    
                    taskModal.assigneesEdit.innerHTML = membersOptions.map(user => 
                        `<div class="member-option">
                            <input type="checkbox" id="edit-task-multi-${user.id}" value="${user.id}" ${task.assignees.includes(user.id) ? 'checked' : ''}>
                            <label for="edit-task-multi-${user.id}">${user.name || user.email}</label>
                        </div>`
                    ).join('');

                    taskModal.saveBtn.style.display = 'block';
                    taskModal.deleteBtn.style.display = 'none';
                    taskModal.editBtn.style.display = 'none';
                };

                taskModal.editBtn.onclick = setEditMode;
                setViewMode();
            }
            
            // FUNKCJE RENDERUJĄCE NOWE SEKCJE
            function renderComments(task) {
                taskModal.commentsList.innerHTML = '';
                task.comments.sort((a, b) => b.timestamp - a.timestamp).forEach(comment => {
                    const user = findUser(comment.userId);
                    const userName = user ? (user.name || user.email) : 'Nieznany Użytkownik';
                    const avatarInitials = user ? (user.name || user.email).substring(0, 2).toUpperCase() : '??';
                    const avatarColor = user ? user.avatarColor || '#ccc' : '#aaa';

                    const li = document.createElement('li');
                    li.className = 'comment-item';
                    li.innerHTML = `
                        <div class="comment-author">
                            <div class="avatar" style="background-color: ${avatarColor}; width: 24px; height: 24px; font-size: 11px;">${avatarInitials}</div>
                            <span>${userName}</span>
                            <small style="color: var(--text-secondary); font-weight: 400;">${new Date(comment.timestamp).toLocaleString('pl-PL', { day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' })}</small>
                        </div>
                        <p>${comment.text}</p>
                    `;
                    taskModal.commentsList.appendChild(li);
                });
            }

            function renderActivityLog(task) {
                taskModal.activityList.innerHTML = '';
                task.activityLog.sort((a, b) => b.timestamp - a.timestamp).forEach(log => {
                    const user = findUser(log.userId);
                    const userName = user ? (user.name || user.email) : 'Nieznany Użytkownik';
                    const dateStr = new Date(log.timestamp).toLocaleString('pl-PL', { day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' });

                    let message = '';
                    if (log.type === 'status') {
                        const oldStatusClass = `status-${log.oldValue.toLowerCase().replace(/\s/g, '')}`;
                        const newStatusClass = `status-${log.newValue.toLowerCase().replace(/\s/g, '')}`;
                        message = `zmienił status z <span class="status-change ${oldStatusClass}">${log.oldValue}</span> na <span class="status-change ${newStatusClass}">${log.newValue}</span>.`;
                    } else if (log.type === 'priority') {
                        message = `zmienił priorytet z <strong>${log.oldValue}</strong> na <strong>${log.newValue}</strong>.`;
                    } else if (log.type === 'comment') {
                        message = `dodał nowy komentarz.`;
                    } else if (log.type === 'completion') {
                        message = `oznaczył swoją część zadania jako <span class="status-change status-done">Wykonaną</span>.`;
                    }
                    
                    const li = document.createElement('li');
                    li.className = 'activity-item';
                    li.innerHTML = `[${dateStr}] <strong>${userName}</strong> ${message}`;
                    taskModal.activityList.appendChild(li);
                });
            }


            function addActivity(task, type, oldValue = null, newValue = null) {
                const activity = {
                    type: type,
                    userId: state.currentUser.uid,
                    timestamp: Date.now(),
                    oldValue: oldValue,
                    newValue: newValue,
                };
                task.activityLog = [...(task.activityLog || []), activity];
                return task; // Ważne: Zwracamy zaktualizowane zadanie
            }

           async function saveTaskFromModal() {
                const taskId = taskModal.overlay.dataset.taskId;
                const { task, project } = findTask(taskId);
                if (!task || !project) return;

                const newTitle = taskModal.titleInput.value.trim();
                if (!newTitle) {
                    showNotification("Tytuł zadania nie może być pusty.", "Błąd");
                    return;
                }

                const newAssignees = Array.from(taskModal.assigneesEdit.querySelectorAll('input:checked')).map(input => input.value);
                if (newAssignees.length === 0) {
                    showNotification("Zadanie musi być przypisane do co najmniej jednej osoby.", "Błąd");
                    return;
                }

                const oldStatus = task.status;
                const newStatus = taskModal.status.value;
                const oldPriority = task.priority;
                const newPriority = taskModal.priority.value;

                if (task.type === 'multi' && newStatus === 'done' && task.completedBy.length < newAssignees.length) {
                    showNotification("Nie można oznaczyć zadania jako 'Wykonane', dopóki wszyscy przypisani członkowie nie ukończą swojej części.", "Błąd");
                    taskModal.status.value = oldStatus;
                    return;
                }

                // 1. Stwórz obiekt zaktualizowanego zadania ze wszystkimi nowymi danymi
                let updatedTask = {
                    ...task,
                    title: newTitle,
                    assignees: newAssignees,
                    description: taskModal.description.value,
                    status: newStatus,
                    priority: newPriority,
                    dueDate: taskModal.dueDate.value,
                };
                 if (taskModal.completed.checked && updatedTask.status !== 'done') {
                    updatedTask.status = 'done';
                }

                // 2. Dodaj wpisy do historii, modyfikując obiekt updatedTask
                if (oldStatus !== newStatus) {
                    updatedTask = addActivity(updatedTask, 'status', STATUSES[oldStatus], STATUSES[newStatus]);
                }
                if (oldPriority !== newPriority) {
                    updatedTask = addActivity(updatedTask, 'priority', oldPriority, newPriority);
                }

                // 3. Wykonaj JEDEN zapis do bazy danych
                const projectDocRef = findProject(project.id) ? doc(projectsRef, project.id) : doc(completedProjectsRef, project.id);
                const updatedTasks = project.tasks.map(t => (t.id === taskId ? updatedTask : t));

                try {
                    await updateDoc(projectDocRef, { tasks: updatedTasks });

                    if (oldStatus !== 'done' && updatedTask.status === 'done') showConfetti();
                    
                    showNotification("Zmiany w zadaniu zostały zapisane.", "Sukces");
                    closeModal(taskModal.overlay);
                    // Nie ma potrzeby ponownego otwierania modala, bo dane odświeżą się automatycznie
                } catch (error) {
                    console.error("Błąd zapisu zmian w zadaniu:", error);
                    showNotification("Wystąpił błąd podczas zapisu zmian.", "Błąd");
                }
            }
            
            function openNewTaskModal(isFab = false) {
                const project = findProject(state.currentProjectId);
                newTaskModal.projectGroup.style.display = isFab ? 'block' : 'none';
                if (isFab) {
                    newTaskModal.projectSelect.innerHTML = state.projects.map(p => `<option value="${p.id}" ${p.id === state.currentProjectId ? 'selected' : ''}>${p.name}</option>`).join('');
                }
                const targetProject = isFab ? findProject(newTaskModal.projectSelect.value) : project;
                if (!targetProject) {
                    showNotification("Stwórz lub wybierz projekt, aby dodać zadanie.");
                    return;
                };
                newTaskModal.form.reset();
                const membersOptions = (targetProject.members || []).map(memberId => {
                    const user = findUser(memberId);
                    return user ? {id: user.id, name: user.name || user.email} : null;
                }).filter(Boolean);
                newTaskModal.assigneeSingleSelect.innerHTML = '<option value="">Nikt</option>' + membersOptions.map(u => `<option value="${u.id}">${u.name}</option>`).join('');
                newTaskModal.assigneeMultiList.innerHTML = membersOptions.map(u => `<div class="member-option"><input type="checkbox" id="new-task-multi-${u.id}" value="${u.id}" ${u.id === state.currentUser.uid ? 'checked disabled' : ''}><label for="new-task-multi-${u.id}">${u.name}</label></div>`).join('');
                newTaskModal.assigneeSingleWrapper.style.display = 'block';
                newTaskModal.assigneeMultiWrapper.style.display = 'none';
                document.getElementById('task-type-single').checked = true;
                openModal(newTaskModal.overlay);
            }

            function openEditProjectModal(projectId) {
                const project = findProject(projectId);
                if (!project) return;
                editProjectModal.overlay.dataset.projectId = projectId;
                editProjectModal.nameInput.value = project.name;
                editProjectModal.membersContainer.innerHTML = state.users.map(user => 
                    `<div class="member-option"><input type="checkbox" id="edit-user-sel-${user.id}" value="${user.id}" ${project.members.includes(user.id) ? 'checked' : ''}><label for="edit-user-sel-${user.id}">${user.name || user.email}</label></div>`
                ).join('');
                openModal(editProjectModal.overlay);
            }

            // NOWA FUNKCJA OBSŁUGUJĄCA USUNIĘCIE PROJEKTU
            async function handleDeleteProject(projectId) {
                const project = findProject(projectId) || findCompletedProject(projectId);
                if (!project || project.ownerId !== state.currentUser.uid) {
                    showNotification("Brak uprawnień lub projekt nie istnieje.", "Błąd");
                    return;
                }

                const collectionRef = findProject(projectId) ? projectsRef : completedProjectsRef;
                
                showConfirmation(
                    "Potwierdź usunięcie", 
                    `Czy na pewno chcesz usunąć projekt "${project.name}"? Tej operacji nie można cofnąć.`, 
                    async (confirmed) => {
                        if (confirmed) {
                            try {
                                await deleteDoc(doc(collectionRef, projectId));
                                
                                // Przełącz na następny projekt lub widok 'Mój Pulpit'
                                const nextProject = state.projects.find(p => p.id !== projectId) || state.completedProjects.find(p => p.id !== projectId);
                                state.currentProjectId = nextProject ? nextProject.id : null;
                                state.ui.currentView = state.currentProjectId ? 'projects' : 'my-dashboard'; // Zmiana na my-dashboard
                                saveUiState();
                                showNotification("Projekt został pomyślnie usunięty.", "Sukces");
                                render();
                            } catch (error) {
                                console.error("Błąd podczas usuwania projektu:", error);
                                showNotification("Wystąpił błąd podczas usuwania projektu. Spróbuj ponownie.", "Błąd");
                            }
                        }
                    }, true
                );
            }


            function showConfetti() {
                const container = document.createElement('div');
                container.className = 'confetti-container';
                document.body.appendChild(container);
                const colors = ['#ef4444', '#3b82f6', '#22c55e', '#f97316', '#8b5cf6', '#ec4899'];
                for (let i = 0; i < 100; i++) {
                    const confetti = document.createElement('div');
                    confetti.className = 'confetti';
                    confetti.style.left = `${Math.random() * 100}vw`;
                    confetti.style.animationDelay = `${Math.random() * 2}s`;
                    confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                    container.appendChild(confetti);
                }
                setTimeout(() => container.remove(), 5000);
            }

            function setupFirestoreListeners(userId) {
                if (!userId) return;
                if (state.ui.unsubscribeUsers) state.ui.unsubscribeUsers();
                state.ui.unsubscribeUsers = onSnapshot(query(usersRef), (snapshot) => {
                    state.users = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    render();
                }, (error) => console.error("Błąd odczytu użytkowników:", error));
                if (state.ui.unsubscribeProjects) state.ui.unsubscribeProjects();
                const projectsQuery = query(projectsRef, where("members", "array-contains", userId));
                state.ui.unsubscribeProjects = onSnapshot(projectsQuery, (snapshot) => {
                    state.projects = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    // Po załadowaniu projektów, sprawdź, czy currentProjectId jest wciąż aktualny
                    const isCurrentProjectActive = findProject(state.currentProjectId) || findCompletedProject(state.currentProjectId);
                    if (!isCurrentProjectActive && state.ui.currentView !== 'my-dashboard') {
                        state.currentProjectId = state.projects.length > 0 ? state.projects[0].id : null;
                        state.ui.currentView = state.currentProjectId ? 'projects' : 'my-dashboard';
                    }
                    loadingOverlay.style.display = 'none';
                    render();
                }, (error) => {
                    console.error("Błąd odczytu projektów:", error);
                    loadingOverlay.innerHTML = `<p>Błąd dostępu do bazy danych.<br><small>Komunikat: ${error.message}</small><br><br><b>Ważne:</b> Upewnij się, że utworzyłeś/aś wymagany indeks w Firestore (zakładka Indexes -> Single Field).</p>`;
                });
                if (state.ui.unsubscribeCompleted) state.ui.unsubscribeCompleted();
                 const completedQuery = query(completedProjectsRef, where("members", "array-contains", userId));
                state.ui.unsubscribeCompleted = onSnapshot(completedQuery, (snapshot) => {
                    state.completedProjects = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    render();
                }, (error) => console.error("Błąd odczytu zakończonych projektów:", error));
            }
            
            loadUiState();
            function updateNotificationBellUI() {
    if (!notificationToggleBtn) return; // Zabezpieczenie na wypadek, gdyby przycisk nie istniał
    
    if (Notification.permission === 'granted') {
        notificationToggleBtn.classList.add('active');
        notificationToggleBtn.title = 'Powiadomienia są włączone';
    } else {
        notificationToggleBtn.classList.remove('active');
        notificationToggleBtn.title = 'Kliknij, aby włączyć powiadomienia';
    }
}
            // --- GŁÓWNY LISTENER UWIERZYTELNIANIA ---
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    const userDoc = await getDoc(doc(usersRef, user.uid));
                    state.currentUser = userDoc.exists() ? { id: user.uid, uid: user.uid, ...userDoc.data() } : { id: user.uid, uid: user.uid, email: user.email };
                    authOverlay.style.display = 'none';
                    appContainer.classList.remove('hidden');
                    loadingOverlay.style.display = 'flex';
                    userEmailDisplay.textContent = state.currentUser.email;
                    setupFirestoreListeners(user.uid);
                    requestNotificationPermission(); 
                    updateNotificationBellUI();
                } else {
                    state.currentUser = null;
                    appContainer.classList.add('hidden');
                    authOverlay.style.display = 'flex';
                    loadingOverlay.style.display = 'none';
                    if (state.ui.unsubscribeProjects) state.ui.unsubscribeProjects();
                    if (state.ui.unsubscribeCompleted) state.ui.unsubscribeCompleted();
                    if (state.ui.unsubscribeUsers) state.ui.unsubscribeUsers();
                }
            });

            // --- WSZYSTKIE POZOSTAŁE EVENT LISTENERY ---
            mobileThemeSwitcher.appendChild(desktopThemeSwitcher.cloneNode(true));
            showRegisterBtn.addEventListener('click', () => { loginForm.style.display = 'none'; registerForm.style.display = 'block'; });
            showLoginBtn.addEventListener('click', () => { registerForm.style.display = 'none'; loginForm.style.display = 'block'; });

            registerForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const name = document.getElementById('register-name').value.trim();
                const email = document.getElementById('register-email').value;
                const password = document.getElementById('register-password').value;
                if (!name) { authErrorRegister.textContent = 'Nazwa użytkownika jest wymagana.'; return; }
                authErrorRegister.textContent = '';
                const submitBtn = e.target.querySelector('button[type="submit"]');
                submitBtn.disabled = true;
                submitBtn.textContent = 'Rejestrowanie...';
                try {
                    await createUserWithEmailAndPassword(auth, email, password);
                    const user = auth.currentUser; // Użyj auth.currentUser po pomyślnym utworzeniu
                    await setDoc(doc(usersRef, user.uid), {
                        uid: user.uid,
                        email: user.email,
                        name: name,
                        avatarColor: '#'+Math.floor(Math.random()*16777215).toString(16).padStart(6, '0')
                    });
                } catch (error) {
                    console.error("Błąd rejestracji:", error);
                    authErrorRegister.textContent = error.message;
                } finally {
                     submitBtn.disabled = false;
                     submitBtn.textContent = 'Zarejestruj się';
                }
            });

            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;
                authErrorLogin.textContent = '';
                const submitBtn = e.target.querySelector('button[type="submit"]');
                submitBtn.disabled = true;
                submitBtn.textContent = 'Logowanie...';
                try {
                    await signInWithEmailAndPassword(auth, email, password);
                } catch (error) {
                    console.error("Błąd logowania:", error);
                    authErrorLogin.textContent = "Nieprawidłowy email lub hasło.";
                } finally {
                     submitBtn.disabled = false;
                     submitBtn.textContent = 'Zaloguj się';
                }
            });
            
            logoutBtn.addEventListener('click', () => signOut(auth));
            notificationToggleBtn.addEventListener('click', requestNotificationPermission);
            
            const handleProjectLinkClick = (e) => {
                e.preventDefault();
                const link = e.target.closest('a');
                if (link && link.dataset.projectId) {
                    state.currentProjectId = link.dataset.projectId;
                    state.ui.currentView = 'projects';
                    saveUiState();
                    render();
                    sidebar.classList.remove('open');
                    sidebarOverlay.classList.remove('visible');
                }
            };
            projectsListEl.addEventListener('click', handleProjectLinkClick);
            completedProjectsListEl.addEventListener('click', handleProjectLinkClick);
            
            mainNav.addEventListener('click', (e) => {
                e.preventDefault();
                const link = e.target.closest('a');
                if(link && link.dataset.view) {
                    state.currentProjectId = null; // Wyczyść ID projektu przy przejściu na pulpit
                    state.ui.currentView = link.dataset.view;
                    saveUiState();
                    render();
                    sidebar.classList.remove('open');
                    sidebarOverlay.classList.remove('visible');
                }
            });

            newProjectBtn.addEventListener('click', () => {
                 newProjectModal.form.reset();
                 newProjectModal.membersContainer.innerHTML = state.users.map(user => 
                    `<div class="member-option"><input type="checkbox" id="new-user-sel-${user.id}" value="${user.id}" ${user.id === state.currentUser.uid ? 'checked disabled' : ''}><label for="new-task-multi-${user.id}">${user.name || user.email}</label></div>`
                ).join('');
                 openModal(newProjectModal.overlay);
            });

            newProjectModal.form.addEventListener('submit', async (e) => {
                e.preventDefault();
                const newName = newProjectModal.nameInput.value.trim();
                if (!newName) return;
                const selectedMembers = Array.from(newProjectModal.membersContainer.querySelectorAll('input:checked')).map(input => input.value);
                if (!selectedMembers.includes(state.currentUser.uid)) {
                    selectedMembers.push(state.currentUser.uid);
                }
                const taskTitles = newProjectModal.tasksTextarea.value.split('\n').map(t => t.replace(/^-/, '').trim()).filter(Boolean);
                const newProject = {
                    name: newName,
                    ownerId: state.currentUser.uid,
                    members: selectedMembers,
                    tasks: taskTitles.map((title, i) => ({
                        id: `task${Date.now() + i}`, title, description: '', status: 'todo', 
                        type: 'single', assignees: [], completedBy: [], priority: 'medium', dueDate: null,
                        comments: [], // Inicjalizacja komentarzy
                        activityLog: [] // Inicjalizacja historii
                    }))
                };
                const docRef = await addDoc(projectsRef, newProject);
                state.currentProjectId = docRef.id;
                state.ui.currentView = 'projects';
                saveUiState();
                closeModal(newProjectModal.overlay);
            });
            
            editProjectBtn.addEventListener('click', () => openEditProjectModal(state.currentProjectId));
            // Dodanie listenera dla nowego przycisku usuwania
            deleteProjectBtn.addEventListener('click', () => handleDeleteProject(state.currentProjectId));


            editProjectModal.form.addEventListener('submit', async (e) => {
                e.preventDefault();
                const projectId = editProjectModal.overlay.dataset.projectId;
                const newName = editProjectModal.nameInput.value.trim();
                if (!projectId || !newName) return;
                const selectedMembers = Array.from(editProjectModal.membersContainer.querySelectorAll('input:checked')).map(input => input.value);
                if (!selectedMembers.includes(state.currentUser.uid)) {
                    selectedMembers.push(state.currentUser.uid);
                }
                await updateDoc(doc(projectsRef, projectId), { name: newName, members: selectedMembers });
                closeModal(editProjectModal.overlay);
            });

            completeProjectBtn.addEventListener('click', async () => {
                const project = findProject(state.currentProjectId);
                if (!project || (project.tasks || []).some(t => t.status !== 'done')) {
                    showNotification("Wszystkie zadania muszą być ukończone, aby zamknąć projekt.");
                    return;
                }
                try {
                    await setDoc(doc(completedProjectsRef, project.id), project);
                    await deleteDoc(doc(projectsRef, project.id));
                    state.currentProjectId = state.projects.length > 0 ? state.projects[0].id : null;
                    state.ui.currentView = state.currentProjectId ? 'projects' : 'my-dashboard';
                    saveUiState();
                } catch (error) {
                    console.error("Błąd zamykania projektu:", error);
                    showNotification("Błąd podczas zamykania projektu.");
                }
            });
            
            newTaskModal.taskTypeRadios.forEach(radio => {
                radio.addEventListener('change', () => {
                    const isMulti = radio.value === 'multi';
                    newTaskModal.assigneeSingleWrapper.style.display = isMulti ? 'none' : 'block';
                    newTaskModal.assigneeMultiWrapper.style.display = isMulti ? 'block' : 'none';
                });
            });

            newTaskModal.form.addEventListener('submit', async (e) => {
                e.preventDefault();
                const title = newTaskModal.title.value.trim();
                if(!title) return;
                const isFab = newTaskModal.projectGroup.style.display === 'block';
                const projectId = isFab ? newTaskModal.projectSelect.value : state.currentProjectId;
                const project = findProject(projectId);
                if(!project) return;
                const taskType = document.querySelector('input[name="task-type"]:checked').value;
                let assignees = [];
                if (taskType === 'single') {
                    const singleAssignee = newTaskModal.assigneeSingleSelect.value;
                    if (singleAssignee) assignees.push(singleAssignee);
                } else {
                    assignees = Array.from(newTaskModal.assigneeMultiList.querySelectorAll('input:checked')).map(input => input.value);
                }
                if (assignees.length === 0) {
                     showNotification("Wybierz przynajmniej jedną osobę do zadania.", "Błąd");
                     return;
                }
                const newTask = {
                    id: `task${Date.now()}`, title,
                    createdBy: state.currentUser.uid,
                    description: newTaskModal.description.value,
                    status: 'todo', 
                    type: taskType,
                    assignees: assignees,
                    completedBy: [],
                    priority: newTaskModal.priority.value,
                    dueDate: newTaskModal.dueDate.value || null,
                    comments: [], // Inicjalizacja komentarzy
                    activityLog: [] // Inicjalizacja historii
                };
                await updateDoc(doc(projectsRef, project.id), {
                    tasks: [...(project.tasks || []), newTask]
                });
                closeModal(newTaskModal.overlay);
            });
            
            async function handleTaskCheckboxClick(checkbox) {
                const taskId = checkbox.dataset.taskId;
                const { task, project } = findTask(taskId);
                if (!task || !project) return;
                const projectDocRef = findProject(project.id) ? doc(projectsRef, project.id) : doc(completedProjectsRef, project.id);
                let updatedTask = { ...task };
                const oldStatus = updatedTask.status;

                if (task.type === 'multi') {
                    const userId = state.currentUser.uid;
                    if (checkbox.checked) {
                        if (!updatedTask.completedBy.includes(userId)) {
                            updatedTask.completedBy.push(userId);
                        }
                    } else {
                        updatedTask.completedBy = updatedTask.completedBy.filter(id => id !== userId);
                    }
                    if (updatedTask.completedBy.length === updatedTask.assignees.length) {
                        updatedTask.status = 'done';
                        if (oldStatus !== 'done') showConfetti();
                    } else {
                        updatedTask.status = oldStatus === 'done' ? 'inprogress' : oldStatus;
                    }
                     if (updatedTask.status !== oldStatus) {
                         await addActivity(updatedTask, project, 'status', STATUSES[oldStatus], STATUSES[updatedTask.status]);
                     } else if (checkbox.checked && updatedTask.status !== 'done' && !updatedTask.activityLog.some(a => a.type === 'completion' && a.userId === state.currentUser.uid)) {
                        // Jeśli multi-task, a użytkownik zaznaczył, ale zadanie jeszcze nie jest 'done', dodajemy tylko activity
                        await addActivity(updatedTask, project, 'completion');
                     }
                } else { 
                     updatedTask.status = checkbox.checked ? 'done' : 'todo';
                     if (updatedTask.status !== oldStatus) {
                         if (updatedTask.status === 'done') showConfetti();
                         await addActivity(updatedTask, project, 'status', STATUSES[oldStatus], STATUSES[updatedTask.status]);
                     }
                }
                const updatedTasks = project.tasks.map(t => t.id === taskId ? updatedTask : t);
                await updateDoc(projectDocRef, { tasks: updatedTasks });
            }

            kanbanBoardEl.addEventListener('click', (e) => {
                // Ta sekcja obsługuje kliknięcia w Kanban na dashboardzie i w widoku projektu
                if (e.target.closest('.task-card-checkbox')) {
                    handleTaskCheckboxClick(e.target.closest('.task-card-checkbox'));
                } else if (e.target.closest('.task-card')) {
                    openTaskModal(e.target.closest('.task-card').dataset.taskId);
                } else if (e.target.closest('.add-task-icon-btn')) {
                    openNewTaskModal(false);
                }
            });
            
            // Dostęp do modala z dashboardu (z opóźnionych zadań)
            document.addEventListener('click', (e) => {
                if (e.target.closest('.overdue-item-title')) {
                    const item = e.target.closest('.overdue-item');
                    if (item && item.dataset.taskId) {
                        openTaskModal(item.dataset.taskId);
                    }
                }
            });

            fabAddTask.addEventListener('click', () => openNewTaskModal(true));

            document.querySelectorAll('.modal-overlay').forEach(overlay => {
                overlay.addEventListener('click', e => {
                    if (e.target === overlay || e.target.closest('.modal-close-btn')) {
                        Array.from(overlay.querySelectorAll('select, textarea, input')).forEach(el => el.disabled = false);
                        closeModal(overlay);
                    }
                });
            });

            taskModal.saveBtn.addEventListener('click', saveTaskFromModal);
            
            // Listener do dodawania komentarzy
            taskModal.addCommentBtn.addEventListener('click', async () => {
    const taskId = taskModal.overlay.dataset.taskId;
    const commentText = taskModal.newCommentText.value.trim();
    if (!commentText) return;

    const { task, project } = findTask(taskId);
    if (!task || !project) return;
    // Sprawdź, czy użytkownik jest twórcą i pokaż/ukryj przycisk usuwania
    if (task.createdBy && task.createdBy === state.currentUser.uid) {
        taskModal.deleteBtn.style.display = 'block';
    } else {
        taskModal.deleteBtn.style.display = 'none';
    }

    const newComment = {
        userId: state.currentUser.uid,
        text: commentText,
        timestamp: Date.now(),
    };

    // Stwórz nową, zaktualizowaną wersję zadania
    let updatedTask = {
        ...task,
        comments: [...(task.comments || []), newComment]
    };

    // Dodaj wpis do historii, używając poprawionej wersji zadania
    updatedTask = addActivity(updatedTask, 'comment'); // <-- POPRAWIONA LINIA

    const projectDocRef = findProject(project.id) ? doc(projectsRef, project.id) : doc(completedProjectsRef, project.id);
    const updatedTasks = project.tasks.map(t => (t.id === taskId ? updatedTask : t));

    await updateDoc(projectDocRef, { tasks: updatedTasks });

    taskModal.newCommentText.value = '';
    // Nie ma potrzeby ponownego otwierania modala, dane odświeżą się same
    // openTaskModal(taskId); // Usunięte dla lepszej płynności
});


            taskModal.overlay.addEventListener('click', async (e) => {
                if (e.target.id === 'complete-my-part-btn') {
const oldStatus = task.status;
let updatedTask = { ...task }; // Pracuj na kopii

if (!updatedTask.completedBy.includes(userId)) {
    updatedTask.completedBy.push(userId);
}
if (updatedTask.completedBy.length === updatedTask.assignees.length) {
    updatedTask.status = 'done';
    if (oldStatus !== 'done') showConfetti();
}

// Jeśli status się zmienił, dodaj aktywność statusu
if (updatedTask.status !== oldStatus) {
    updatedTask = addActivity(updatedTask, 'status', STATUSES[oldStatus], STATUSES[updatedTask.status]);
}
// Zawsze dodaj aktywność ukończenia części zadania
updatedTask = addActivity(updatedTask, 'completion');

const projectDocRef = findProject(project.id) ? doc(projectsRef, project.id) : doc(completedProjectsRef, project.id);
const updatedTasks = project.tasks.map(t => t.id === taskId ? updatedTask : t);
await updateDoc(projectDocRef, { tasks: updatedTasks });
// Nie ma potrzeby ponownego otwierania modala
// openTaskModal(taskId); 
                }
            });

            document.querySelectorAll('.theme-switcher').forEach(switcher => {
                switcher.addEventListener('click', e => {
                    const button = e.target.closest('button');
                    if(!button) return;
                    if(button.id.includes('light')) state.ui.theme = 'light';
                    else if (button.id.includes('dark')) state.ui.theme = 'dark';
                    saveUiState();
                    applyTheme();
                });
            });

            searchInput.addEventListener('click', () => {
                searchModal.resultsList.innerHTML = '<li class="search-result-item"><p>Zacznij pisać...</p></li>';
                openModal(searchModal.overlay);
                searchModal.input.focus();
            });
            searchModal.input.addEventListener('input', (e) => {
                const term = e.target.value;
                renderSearchResults(performGlobalSearch(term));
            });
            function performGlobalSearch(term) {
                if (!term || term.length < 2) return [];
                const lowerCaseTerm = term.toLowerCase();
                const allProjects = [...state.projects, ...state.completedProjects];
                return allProjects.flatMap(project => 
                    (project.tasks || []).filter(task => 
                        task.title.toLowerCase().includes(lowerCaseTerm) || 
                        (task.description && task.description.toLowerCase().includes(lowerCaseTerm))
                    ).map(task => ({ ...task, projectName: project.name, projectId: project.id }))
                );
            }
            function renderSearchResults(results) {
                searchModal.resultsList.innerHTML = results.length === 0 
                    ? '<li>Brak wyników</li>'
                    : results.map(task => `
                        <li class="search-result-item" data-task-id="${task.id}" data-project-id="${task.projectId}">
                            <h4>${task.title}</h4>
                            <p>w projekcie: ${task.projectName}</p>
                        </li>`).join('');
            }
            searchModal.resultsList.addEventListener('click', (e) => {
                const item = e.target.closest('.search-result-item');
                if (item && item.dataset.taskId) {
                    state.currentProjectId = item.dataset.projectId;
                    state.ui.currentView = 'projects';
                    saveUiState();
                    render();
                    closeModal(searchModal.overlay);
                    openTaskModal(item.dataset.taskId);
                }
            });
            
            sortBtn.addEventListener('click', () => {
                if (state.ui.currentView === 'my-dashboard') {
                    // Logika dla pulpitu "Moje zadania"
                    state.ui.sortMyTasksByDate = state.ui.sortMyTasksByDate === 'asc' ? 'desc' : 'asc';
                } else if (state.ui.currentView === 'projects' && state.currentProjectId) {
                    // Logika dla widoku projektu
                    const currentOrder = state.ui.projectSortOrders[state.currentProjectId] || 'asc';
                    state.ui.projectSortOrders[state.currentProjectId] = currentOrder === 'asc' ? 'desc' : 'asc';
                }
                saveUiState();
                render();
            });

            menuToggle.addEventListener('click', () => {
                sidebar.classList.toggle('open');
                sidebarOverlay.classList.toggle('visible');
            });
            sidebarOverlay.addEventListener('click', () => {
                sidebar.classList.remove('open');
                sidebarOverlay.classList.remove('visible');
            });
            sidebar.querySelector('.sidebar-header').addEventListener('click', (e) => {
                if (e.target.closest('a') === null) {
                     sidebar.classList.remove('open');
                     sidebarOverlay.classList.remove('visible');
                }
            });

            let draggedTaskId = null;
            // ZMIANA: Dodano drag&drop do my-tasks-kanban
            kanbanBoardEl.addEventListener('dragstart', (e) => {
                const taskCard = e.target.closest('.task-card');
                if (taskCard) {
                    draggedTaskId = taskCard.dataset.taskId;
                    setTimeout(() => taskCard.classList.add('dragging'), 0);
                }
            });
            kanbanBoardEl.addEventListener('dragend', (e) => {
                e.target.closest('.task-card')?.classList.remove('dragging');
            });
            kanbanBoardEl.addEventListener('dragover', (e) => e.preventDefault());
            kanbanBoardEl.addEventListener('drop', async (e) => {
                e.preventDefault();
                const column = e.target.closest('.kanban-column');
                if (!column || !draggedTaskId) return;

                const newStatus = column.dataset.status;
                const { task, project } = findTask(draggedTaskId);

                if (state.ui.currentView === 'projects' && findCompletedProject(state.currentProjectId)) return;

                if (task && task.status !== newStatus) {
                    if (task.type === 'multi' && newStatus === 'done' && task.completedBy.length < task.assignees.length) {
                        showNotification("Nie można przenieść zadania do 'Wykonane', dopóki wszyscy nie ukończą swojej części.", "Błąd");
                        render();
                        return;
                    }

                    const oldStatus = task.status;

                    // 1. Stwórz wpis do historii
                    const activity = {
                        type: 'status',
                        userId: state.currentUser.uid,
                        timestamp: Date.now(),
                        oldValue: STATUSES[oldStatus],
                        newValue: STATUSES[newStatus],
                    };
                    
                    // 2. Stwórz obiekt zaktualizowanego zadania
                    const updatedTask = {
                        ...task,
                        status: newStatus,
                        activityLog: [...(task.activityLog || []), activity]
                    };
                    
                    // 3. Wykonaj jeden, czysty zapis do bazy danych
                    const projectDocRef = findProject(project.id) ? doc(projectsRef, project.id) : doc(completedProjectsRef, project.id);
                    const updatedTasks = project.tasks.map(t => (t.id === draggedTaskId ? updatedTask : t));

                    await updateDoc(projectDocRef, { tasks: updatedTasks });

                    if (oldStatus !== 'done' && newStatus === 'done') showConfetti();
                }
            });
            taskModal.deleteBtn.addEventListener('click', async () => {
          const taskId = taskModal.overlay.dataset.taskId;
          const { task, project } = findTask(taskId);

          if (!task || !project) return;
          
          if (task.createdBy !== state.currentUser.uid) {
              showNotification("Nie masz uprawnień do usunięcia tego zadania.", "Błąd");
              return;
          }

          showConfirmation(
              "Potwierdź usunięcie zadania",
              `Czy na pewno chcesz trwale usunąć zadanie: "${task.title}"?`,
              async (confirmed) => {
                  if (confirmed) {
                      const updatedTasks = project.tasks.filter(t => t.id !== taskId);

                      const projectDocRef = findProject(project.id) 
                          ? doc(projectsRef, project.id) 
                          : doc(completedProjectsRef, project.id);
                      
                      try {
                          await updateDoc(projectDocRef, { tasks: updatedTasks });
                          closeModal(taskModal.overlay);
                          showNotification("Zadanie zostało pomyślnie usunięte.", "Sukces");
                      } catch (error) {
                          console.error("Błąd podczas usuwania zadania:", error);
                          showNotification("Wystąpił błąd podczas usuwania zadania.", "Błąd");
                      }
                  }
              }, 
              true
          );
      });
        });
    </script>
</body>
</html>











