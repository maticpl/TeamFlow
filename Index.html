<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>TeamFlow — Kanban + Auth (naprawione)</title>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"/>
  <style>
    :root{
      --bg-primary:#f4f5f7;--bg-secondary:#fff;--bg-tertiary:#e9eaec;--bg-overlay:rgba(0,0,0,.5);
      --text-primary:#172b4d;--text-secondary:#5e6c84;--border-color:#dfe1e6;
      --accent-primary:#4f46e5;--accent-hover:#4338ca;--danger:#dc2626;--success:#16a34a;
      --shadow:0 10px 20px rgba(0,0,0,.08);--radius:12px
    }
    .dark{--bg-primary:#111827;--bg-secondary:#1f2937;--bg-tertiary:#374151;--text-primary:#f9fafb;--text-secondary:#d1d5db;--border-color:#374151}
    *{box-sizing:border-box} body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg-primary);color:var(--text-primary)}
    /* AUTH */
    #auth{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:var(--bg-primary)}
    .card{background:var(--bg-secondary);border:1px solid var(--border-color);box-shadow:var(--shadow);border-radius:var(--radius);padding:24px;width:min(92vw,420px)}
    .row{display:grid;gap:10px} label{font-size:13px;font-weight:600} input,select,textarea{width:100%;padding:10px;border:1px solid var(--border-color);border-radius:10px;background:var(--bg-primary);color:var(--text-primary)}
    .btn{display:inline-flex;align-items:center;justify-content:center;padding:10px 14px;border-radius:10px;border:none;cursor:pointer;font-weight:700}
    .btn-primary{background:var(--accent-primary);color:#fff}.btn-primary:hover{background:var(--accent-hover)}
    .btn-ghost{background:transparent;border:1px solid var(--border-color);color:var(--text-primary)}
    .muted{color:var(--text-secondary);font-size:13px}
    .error{color:var(--danger);min-height:20px;font-size:13px}
    /* APP */
    #app{display:none;height:100vh}
    .layout{display:flex;height:100%}
    aside{width:280px;border-right:1px solid var(--border-color);background:var(--bg-secondary);padding:16px;display:flex;flex-direction:column;gap:12px}
    .aside-top{display:flex;align-items:center;gap:10px}
    .logo{width:34px;height:34px;border-radius:8px;background:var(--accent-primary);color:#fff;display:grid;place-items:center;font-weight:900}
    .projects{flex:1;overflow:auto}
    .projects h4{margin:8px 0 4px 0;font-size:12px;text-transform:uppercase;color:var(--text-secondary)}
    .projects ul{list-style:none;margin:0;padding:0;display:grid;gap:6px}
    .projects a{display:flex;align-items:center;gap:8px;text-decoration:none;color:inherit;padding:8px;border-radius:10px}
    .projects a.active,.projects a:hover{background:var(--bg-tertiary)}
    .footer{border-top:1px solid var(--border-color);padding-top:8px;font-size:12px;color:var(--text-secondary)}
    main{flex:1;display:flex;flex-direction:column}
    header{display:flex;align-items:center;justify-content:space-between;padding:16px;border-bottom:1px solid var(--border-color);background:var(--bg-secondary)}
    .title-wrap{display:flex;align-items:center;gap:10px}
    .pill{font-size:12px;padding:2px 8px;border-radius:999px;border:1px solid var(--border-color);color:var(--text-secondary)}
    .controls{display:flex;align-items:center;gap:8px}
    .board{flex:1;display:grid;grid-template-columns:repeat(3,1fr);gap:14px;padding:14px;overflow:auto}
    .col{background:var(--bg-tertiary);border-radius:12px;padding:12px;display:flex;flex-direction:column}
    .col h3{display:flex;align-items:center;gap:8px;margin:0 0 8px 0;font-size:14px}
    .tasks{list-style:none;margin:0;padding:0;display:grid;gap:8px;overflow:auto}
    .card-task{background:var(--bg-secondary);border:1px solid var(--border-color);border-radius:12px;padding:12px;display:grid;gap:6px}
    .card-task .meta{display:flex;gap:6px;flex-wrap:wrap}
    .badge{font-size:11px;padding:2px 6px;border-radius:8px;border:1px solid var(--border-color);color:var(--text-secondary)}
    .assignees{display:flex;gap:4px;flex-wrap:wrap}
    .avatar{width:22px;height:22px;border-radius:50%;display:grid;place-items:center;font-size:11px;color:#fff}
    .drop{min-height:20px;border:2px dashed transparent;border-radius:8px;padding:2px}
    .drop.dragover{border-color:var(--accent-primary);background:rgba(79,70,229,.08)}
    /* MODALS */
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;padding:16px}
    .overlay.open{display:flex}
    .modal{background:var(--bg-secondary);border:1px solid var(--border-color);border-radius:12px;box-shadow:var(--shadow);width:min(92vw,560px)}
    .modal header{border-bottom:1px solid var(--border-color)}
    .modal .content{padding:16px}
    .modal .footer{display:flex;gap:8px;justify-content:flex-end;padding:12px 16px;border-top:1px solid var(--border-color)}
    @media (max-width:900px){aside{width:90vw}.board{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <!-- AUTH -->
  <section id="auth">
    <div class="card">
      <h2>TeamFlow</h2>
      <p class="muted" style="margin:6px 0 18px 0">Zaloguj się lub załóż konto</p>
      <div class="row">
        <label>Email<input id="auth-email" type="email" required/></label>
        <label>Hasło<input id="auth-pass" type="password" minlength="6" required/></label>
        <button id="btn-login" class="btn btn-primary">Zaloguj</button>
        <button id="btn-register" class="btn btn-ghost">Zarejestruj</button>
        <div id="auth-error" class="error"></div>
      </div>
    </div>
  </section>

  <!-- APP -->
  <section id="app">
    <div class="layout">
      <aside>
        <div class="aside-top">
          <div class="logo">TF</div>
          <div>
            <div style="font-weight:700">TeamFlow</div>
            <div class="muted" id="me-email"></div>
          </div>
        </div>

        <div class="projects">
          <h4>Projekty</h4>
          <ul id="projects-list"></ul>
          <button id="btn-new-project" class="btn btn-primary" style="margin-top:8px">+ Nowy projekt</button>
        </div>

        <div class="footer">
          <button id="btn-logout" class="btn btn-ghost" style="width:100%">Wyloguj</button>
        </div>
      </aside>

      <main>
        <header>
          <div class="title-wrap">
            <h2 id="project-title" style="margin:0">—</h2>
            <span class="pill" id="project-status">aktywny</span>
          </div>
          <div class="controls">
            <button id="btn-edit-project" class="btn btn-ghost">Edytuj projekt</button>
            <button id="btn-close-project" class="btn btn-primary">Zakończ projekt</button>
            <button id="btn-new-task" class="btn btn-primary">+ Zadanie</button>
          </div>
        </header>

        <section class="board">
          <div class="col" data-status="todo">
            <h3>Do zrobienia <span class="pill" id="count-todo">0</span></h3>
            <div class="drop" data-drop="todo"></div>
            <ul class="tasks" id="list-todo"></ul>
          </div>
          <div class="col" data-status="inprogress">
            <h3>W trakcie <span class="pill" id="count-inprogress">0</span></h3>
            <div class="drop" data-drop="inprogress"></div>
            <ul class="tasks" id="list-inprogress"></ul>
          </div>
          <div class="col" data-status="done">
            <h3>Gotowe <span class="pill" id="count-done">0</span></h3>
            <div class="drop" data-drop="done"></div>
            <ul class="tasks" id="list-done"></ul>
          </div>
        </section>
      </main>
    </div>
  </section>

  <!-- MODAL: NEW/EDIT TASK -->
  <div id="modal-task" class="overlay">
    <div class="modal">
      <header><h3 id="task-modal-title" style="margin:0">Nowe zadanie</h3></header>
      <div class="content">
        <div class="row">
          <label>Tytuł<input id="task-title" type="text" required/></label>
          <label>Opis<textarea id="task-desc" rows="4"></textarea></label>
          <div class="row" style="grid-template-columns: 1fr 1fr; gap:12px">
            <label>Status
              <select id="task-status">
                <option value="todo">Do zrobienia</option>
                <option value="inprogress">W trakcie</option>
                <option value="done">Gotowe</option>
              </select>
            </label>
            <label>Priorytet
              <select id="task-priority">
                <option value="normal">Normalny</option>
                <option value="high">Wysoki</option>
                <option value="low">Niski</option>
              </select>
            </label>
          </div>
          <div class="row" style="grid-template-columns: 1fr 1fr; gap:12px">
            <label>Termin (data)<input id="task-date" type="date"/></label>
            <label>Godzina<input id="task-time" type="time"/></label>
          </div>
          <div class="row">
            <label>Przypisanie
              <select id="task-assign-mode">
                <option value="single">Jedna osoba</option>
                <option value="multi">Wiele osób</option>
              </select>
            </label>
            <div id="assign-single-wrap">
              <select id="assign-single"></select>
            </div>
            <div id="assign-multi-wrap" style="display:none">
              <div id="assign-multi" class="row" style="grid-template-columns:repeat(3,minmax(0,1fr));gap:8px"></div>
            </div>
          </div>
        </div>
      </div>
      <div class="footer">
        <button id="task-cancel" class="btn btn-ghost">Anuluj</button>
        <button id="task-save" class="btn btn-primary">Zapisz</button>
      </div>
    </div>
  </div>

  <!-- MODAL: NEW/EDIT PROJECT -->
  <div id="modal-project" class="overlay">
    <div class="modal">
      <header><h3 id="project-modal-title" style="margin:0">Nowy projekt</h3></header>
      <div class="content">
        <div class="row">
          <label>Nazwa projektu<input id="proj-name" type="text" required/></label>
          <div class="row">
            <div class="muted">Członkowie projektu</div>
            <div id="proj-members" class="row" style="grid-template-columns:repeat(3,minmax(0,1fr));gap:8px"></div>
          </div>
        </div>
      </div>
      <div class="footer">
        <button id="proj-cancel" class="btn btn-ghost">Anuluj</button>
        <button id="proj-save" class="btn btn-primary">Zapisz</button>
      </div>
    </div>
  </div>

  <!-- SIMPLE TOAST -->
  <div id="toast" style="position:fixed;left:50%;bottom:18px;transform:translateX(-50%);background:var(--bg-secondary);border:1px solid var(--border-color);padding:10px 14px;border-radius:10px;display:none;box-shadow:var(--shadow)"></div>

<script type="module">
/* =========================
   1) IMPORTY — poprawne, bez „...”
========================= */
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc, addDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, writeBatch, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

/* =========================
   2) KONFIG — ZOSTAWIAM „cofingAPI” (wstaw swoje wartości)
========================= */
const firebaseConfig = {
  apiKey: "__API_KEY__",
  authDomain: "__AUTH_DOMAIN__",
  projectId: "__PROJECT_ID__",
  storageBucket: "__STORAGE_BUCKET__",
  messagingSenderId: "__MESSAGING_SENDER_ID__",
  appId: "__APP_ID__"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db   = getFirestore(app);

/* =========================
   3) ŚCIEŻKI DANYCH (kompatybilne wstecz)
========================= */
const APP_ID = "__APP_ID__"; // jeśli chcesz dynamicznie — nadpisz po init
const COLL_PATHS = {
  users:               `artifacts/${APP_ID}/public/data/users`,
  projects:            `artifacts/${APP_ID}/public/data/projects`,
  completedProjects:   `artifacts/${APP_ID}/public/data/completedProjects`,
  tasksGlobal:         `artifacts/${APP_ID}/public/data/tasks`, // wariant globalny
  tasksSub:            (projectId)=> `artifacts/${APP_ID}/public/data/projects/${projectId}/tasks` // wariant subkolekcji
};

/* =========================
   4) STAN & POMOCNICZE
========================= */
const state = {
  me: null,
  projects: [],
  users: [],
  activeProjectId: null,
  unsub: { projects: null, users: null, tasks: null } // cleanup nasłuchów
};

const $ = (sel)=> document.querySelector(sel);
const $$ = (sel)=> Array.from(document.querySelectorAll(sel));
const toast = (msg)=>{ const t=$("#toast"); t.textContent=msg; t.style.display="block"; clearTimeout(t._to); t._to=setTimeout(()=>t.style.display="none",2200); };

const authUI = {
  email: $("#auth-email"),
  pass: $("#auth-pass"),
  err:  $("#auth-error"),
  btnLogin: $("#btn-login"),
  btnRegister: $("#btn-register"),
  root: $("#auth")
};
const appUI = {
  root: $("#app"),
  meEmail: $("#me-email"),
  projectsList: $("#projects-list"),
  btnNewProject: $("#btn-new-project"),
  btnLogout: $("#btn-logout"),
  title: $("#project-title"),
  status: $("#project-status"),
  btnEditProject: $("#btn-edit-project"),
  btnCloseProject: $("#btn-close-project"),
  btnNewTask: $("#btn-new-task"),
  counts: {
    todo: $("#count-todo"),
    inprogress: $("#count-inprogress"),
    done: $("#count-done")
  },
  lists: {
    todo: $("#list-todo"),
    inprogress: $("#list-inprogress"),
    done: $("#list-done")
  }
};
const modTask = {
  root: $("#modal-task"),
  title: $("#task-modal-title"),
  inTitle: $("#task-title"),
  inDesc: $("#task-desc"),
  inStatus: $("#task-status"),
  inPriority: $("#task-priority"),
  inDate: $("#task-date"),
  inTime: $("#task-time"),
  inMode: $("#task-assign-mode"),
  singleWrap: $("#assign-single-wrap"),
  single: $("#assign-single"),
  multiWrap: $("#assign-multi-wrap"),
  multi: $("#assign-multi"),
  btnSave: $("#task-save"),
  btnCancel: $("#task-cancel"),
  _editId: null // jeśli edytujemy
};
const modProj = {
  root: $("#modal-project"),
  title: $("#project-modal-title"),
  inName: $("#proj-name"),
  membersWrap: $("#proj-members"),
  btnSave: $("#proj-save"),
  btnCancel: $("#proj-cancel"),
  _editId: null
};

/* =========================
   5) AUTH — działa i reaguje
========================= */
authUI.btnLogin.addEventListener("click", async ()=>{
  authUI.err.textContent = "";
  try{
    await signInWithEmailAndPassword(auth, authUI.email.value.trim(), authUI.pass.value);
  }catch(e){ authUI.err.textContent = e.message; }
});
authUI.btnRegister.addEventListener("click", async ()=>{
  authUI.err.textContent = "";
  try{
    const cred = await createUserWithEmailAndPassword(auth, authUI.email.value.trim(), authUI.pass.value);
    // auto-dopis do users
    const uid = cred.user.uid;
    await setDoc(doc(collection(db, COLL_PATHS.users), uid), {
      uid, email: cred.user.email ?? "", name: cred.user.email?.split("@")[0] ?? "Użytkownik",
      createdAt: serverTimestamp()
    }, { merge: true });
  }catch(e){ authUI.err.textContent = e.message; }
});

appUI.btnLogout.addEventListener("click", ()=> signOut(auth));

onAuthStateChanged(auth, async (user)=>{
  if(user){
    state.me = user;
    authUI.root.style.display = "none";
    appUI.root.style.display  = "block";
    appUI.meEmail.textContent = user.email || "(brak email)";

    // Nasłuch USERS i PROJECTS
    listenUsers();
    listenProjects();
  }else{
    cleanupListeners();
    state.me = null;
    appUI.root.style.display  = "none";
    authUI.root.style.display = "flex";
  }
});

/* =========================
   6) NASŁUCHY DANYCH
========================= */
function cleanupListeners(){
  for(const k of Object.keys(state.unsub)){
    if(state.unsub[k]){ state.unsub[k](); state.unsub[k]=null; }
  }
}

function listenUsers(){
  if(state.unsub.users) state.unsub.users();
  state.unsub.users = onSnapshot(collection(db, COLL_PATHS.users), (snap)=>{
    state.users = snap.docs.map(d=> ({ id:d.id, ...d.data() }));
    // odśwież selecty w modalach jeśli trzeba
    if(modTask.root.classList.contains("open")) fillAssigneesUI();
    if(modProj.root.classList.contains("open")) fillProjectMembersUI(modProj._editId);
  });
}

function listenProjects(){
  if(state.unsub.projects) state.unsub.projects();
  state.unsub.projects = onSnapshot(collection(db, COLL_PATHS.projects), (snap)=>{
    state.projects = snap.docs.map(d=> ({ id:d.id, ...d.data() }))
      .sort((a,b)=> String(a.name||"").localeCompare(String(b.name||"")));
    renderProjectsList();
    // automatyczny wybór pierwszego projektu (jeśli nieaktywny)
    if(!state.activeProjectId && state.projects[0]){
      selectProject(state.projects[0].id);
    }else if(state.activeProjectId && !state.projects.find(p=>p.id===state.activeProjectId)){
      state.activeProjectId = null;
      if(state.projects[0]) selectProject(state.projects[0].id);
    }
  });
}

/* =========================
   7) RENDER PROJEKTÓW / WYBÓR
========================= */
function renderProjectsList(){
  appUI.projectsList.innerHTML = "";
  for(const p of state.projects){
    const a = document.createElement("a");
    a.href="#"; a.dataset.id=p.id;
    a.className = (p.id===state.activeProjectId) ? "active" : "";
    a.innerHTML = `
      <span style="width:8px;height:8px;border-radius:999px;display:inline-block;background:${p.closed? '#9ca3af':'#10b981'}"></span>
      <span>${escapeHtml(p.name||'(bez nazwy)')}</span>
    `;
    a.addEventListener("click",(e)=>{ e.preventDefault(); selectProject(p.id); });
    const li = document.createElement("li"); li.appendChild(a); appUI.projectsList.appendChild(li);
  }
}

async function selectProject(projectId){
  state.activeProjectId = projectId;
  const p = state.projects.find(x=>x.id===projectId);
  appUI.title.textContent = p?.name || "(bez nazwy)";
  appUI.status.textContent = p?.closed ? "zakończony" : "aktywny";
  appUI.status.style.background = p?.closed ? "#fee2e2" : "";
  // nasłuch zadań (oba warianty)
  listenTasks(projectId);
}

function listenTasks(projectId){
  if(state.unsub.tasks) state.unsub.tasks();

  const subRef  = collection(db, COLL_PATHS.tasksSub(projectId));
  const globRef = collection(db, COLL_PATHS.tasksGlobal);

  // Słuchamy obie kolekcje i scalamy wyniki po id
  const buffers = { sub: [], glob: [] };
  const renderFromBuffers = ()=>{
    const map = new Map();
    for(const t of buffers.sub)  map.set(t.id, t);
    for(const t of buffers.glob) map.set(t.id, t); // global nadpisze sub (albo odwrotnie — nieistotne)
    const arr = Array.from(map.values());
    renderBoard(arr);
  };

  const unsub1 = onSnapshot(subRef, (snap)=>{
    buffers.sub = snap.docs.map(d=> ({ id:d.id, ...d.data(), __src:"sub" }));
    renderFromBuffers();
  });
  const unsub2 = onSnapshot(query(globRef, where("projectId","==",projectId)), (snap)=>{
    buffers.glob = snap.docs.map(d=> ({ id:d.id, ...d.data(), __src:"glob" }));
    renderFromBuffers();
  });

  state.unsub.tasks = ()=>{ unsub1(); unsub2(); };
}

/* =========================
   8) RENDER BOARD + DnD
========================= */
function renderBoard(tasks){
  const buckets = { todo:[], inprogress:[], done:[] };
  for(const t of tasks){
    const s = (t.status==="inprogress"||t.status==="done")? t.status : "todo";
    buckets[s].push(t);
  }

  for(const k of ["todo","inprogress","done"]){
    const ul = appUI.lists[k];
    ul.innerHTML = "";
    for(const t of buckets[k]){
      const li = document.createElement("li");
      li.className="card-task"; li.draggable=true; li.dataset.id = t.id; li.dataset.src = t.__src || "sub";
      li.innerHTML = renderTaskHTML(t);
      // DnD
      li.addEventListener("dragstart", (e)=>{ e.dataTransfer.setData("text/plain", JSON.stringify({id:t.id,src:li.dataset.src})); });
      // Edycja po kliknięciu
      li.addEventListener("click", ()=> openTaskModal(t));
      ul.appendChild(li);
    }
    appUI.counts[k].textContent = String(buckets[k].length);
  }

  // obszary drop
  $$(".drop").forEach(drop=>{
    drop.addEventListener("dragover",(e)=>{ e.preventDefault(); drop.classList.add("dragover"); });
    drop.addEventListener("dragleave",()=> drop.classList.remove("dragover"));
    drop.addEventListener("drop", async (e)=>{
      e.preventDefault(); drop.classList.remove("dragover");
      const data = JSON.parse(e.dataTransfer.getData("text/plain")||"{}");
      const status = drop.dataset.drop;
      if(!data.id) return;
      await setTaskStatus(data.id, status, data.src);
    });
  });
}

function renderTaskHTML(t){
  const dateStr = t.dueAt ? new Date(t.dueAt).toLocaleString() : "";
  const ass = (Array.isArray(t.assignees)? t.assignees : (t.assignee?[t.assignee]:[]));
  const badges = [
    dateStr && `<span class="badge">⏰ ${escapeHtml(dateStr)}</span>`,
    t.priority && `<span class="badge">⭐ ${escapeHtml(t.priority)}</span>`
  ].filter(Boolean).join("");
  const assHtml = ass.map(uid=>renderAvatar(uid)).join("");
  return `
    <div style="display:flex;align-items:flex-start;justify-content:space-between;gap:6px">
      <div style="font-weight:700">${escapeHtml(t.title||"(bez tytułu)")}</div>
      <div class="assignees">${assHtml}</div>
    </div>
    ${t.description? `<div class="muted" style="font-size:13px">${escapeHtml(t.description)}</div>`:""}
    <div class="meta">${badges}</div>
  `;
}

function renderAvatar(uid){
  const u = state.users.find(x=>x.id===uid || x.uid===uid);
  const name = u?.name || u?.email || "U";
  const inic = name.trim().charAt(0).toUpperCase();
  const hue = (uid||"0").split("").reduce((a,c)=>a+c.charCodeAt(0),0)%360;
  return `<span class="avatar" style="background:hsl(${hue} 70% 45%)" title="${escapeHtml(name)}">${inic}</span>`;
}

/* =========================
   9) CREATE/UPDATE TASKS
========================= */
appUI.btnNewTask.addEventListener("click", ()=> openTaskModal());

modTask.btnCancel.addEventListener("click", ()=> closeTaskModal());
modTask.root.addEventListener("click",(e)=>{ if(e.target===modTask.root) closeTaskModal(); });

modTask.inMode.addEventListener("change", ()=>{
  const multi = modTask.inMode.value === "multi";
  modTask.singleWrap.style.display = multi? "none":"block";
  modTask.multiWrap.style.display  = multi? "block":"none";
});

modTask.btnSave.addEventListener("click", async ()=>{
  if(!state.activeProjectId) return;
  const when = combineDateTime(modTask.inDate.value, modTask.inTime.value);
  const isMulti = modTask.inMode.value === "multi";
  const assignees = isMulti ? getCheckedValues(modTask.multi) : [modTask.single.value].filter(Boolean);

  const payload = {
    title: modTask.inTitle.value.trim(),
    description: modTask.inDesc.value.trim(),
    status: modTask.inStatus.value,
    priority: modTask.inPriority.value,
    projectId: state.activeProjectId,
    assignees,
    dueAt: when ?? null,
    updatedAt: serverTimestamp(),
    createdBy: state.me?.uid || null
  };
  if(!payload.title){ toast("Podaj tytuł"); return; }

  try{
    if(modTask._editId){
      // aktualizacja w źródle gdzie dokument istnieje (sub lub global)
      await updateTask(modTask._editId, payload);
      toast("Zadanie zaktualizowane");
    }else{
      await createTask(payload); // zapis do subkolekcji (domyślnie)
      toast("Zadanie dodane");
    }
    closeTaskModal();
  }catch(e){
    toast("Błąd: "+e.message);
  }
});

async function setTaskStatus(taskId, status, src){
  const ref = (src==="glob")
    ? doc(collection(db, COLL_PATHS.tasksGlobal), taskId)
    : doc(collection(db, COLL_PATHS.tasksSub(state.activeProjectId)), taskId);
  await updateDoc(ref, { status, updatedAt: serverTimestamp() });
}

async function updateTask(taskId, data){
  // spróbuj w subkolekcji
  const subRef = doc(collection(db, COLL_PATHS.tasksSub(state.activeProjectId)), taskId);
  const subDoc = await getDoc(subRef);
  if(subDoc.exists()){
    await updateDoc(subRef, data);
    return;
  }
  // spróbuj w global
  const gRef = doc(collection(db, COLL_PATHS.tasksGlobal), taskId);
  const gDoc = await getDoc(gRef);
  if(gDoc.exists()){
    await updateDoc(gRef, data);
    return;
  }
  // fallback – jeśli nie ma nigdzie, utwórz w sub
  await setDoc(subRef, { ...data, createdAt: serverTimestamp() });
}

async function createTask(data){
  // domyślnie do subkolekcji
  await addDoc(collection(db, COLL_PATHS.tasksSub(state.activeProjectId)), {
    ...data,
    createdAt: serverTimestamp()
  });
}

/* =========================
   10) CREATE/EDIT PROJECTS
========================= */
appUI.btnNewProject.addEventListener("click", ()=> openProjectModal());
appUI.btnEditProject.addEventListener("click", ()=>{
  const p = state.projects.find(x=>x.id===state.activeProjectId);
  if(!p) return;
  openProjectModal(p);
});
appUI.btnCloseProject.addEventListener("click", async ()=>{
  const p = state.projects.find(x=>x.id===state.activeProjectId);
  if(!p) return;
  try{
    // przenieś do completedProjects
    const batch = writeBatch(db);
    const src = doc(collection(db, COLL_PATHS.projects), p.id);
    const dst = doc(collection(db, COLL_PATHS.completedProjects), p.id);
    batch.set(dst, { ...p, closed:true, closedAt: serverTimestamp() });
    batch.delete(src);
    await batch.commit();
    toast("Projekt zakończony");
  }catch(e){ toast("Błąd: "+e.message); }
});

modProj.btnCancel.addEventListener("click", ()=> closeProjectModal());
modProj.root.addEventListener("click",(e)=>{ if(e.target===modProj.root) closeProjectModal(); });

modProj.btnSave.addEventListener("click", async ()=>{
  const name = modProj.inName.value.trim();
  if(!name){ toast("Podaj nazwę projektu"); return; }
  const members = getCheckedValues(modProj.membersWrap);
  try{
    if(modProj._editId){
      await updateDoc(doc(collection(db, COLL_PATHS.projects), modProj._editId), { name, members, updatedAt: serverTimestamp() });
      toast("Projekt zaktualizowany");
    }else{
      const ref = await addDoc(collection(db, COLL_PATHS.projects), { name, members, closed:false, createdAt: serverTimestamp() });
      toast("Projekt dodany");
      selectProject(ref.id);
    }
    closeProjectModal();
  }catch(e){ toast("Błąd: "+e.message); }
});

/* =========================
   11) MODALE — wypełnianie
========================= */
function openTaskModal(task){
  modTask._editId = task?.id || null;
  modTask.title.textContent = task? "Edytuj zadanie":"Nowe zadanie";
  modTask.inTitle.value = task?.title || "";
  modTask.inDesc.value  = task?.description || "";
  modTask.inStatus.value = task?.status || "todo";
  modTask.inPriority.value = task?.priority || "normal";
  if(task?.dueAt){
    const d = new Date(task.dueAt);
    modTask.inDate.value = toInputDate(d);
    modTask.inTime.value = toInputTime(d);
  }else{
    modTask.inDate.value=""; modTask.inTime.value="";
  }

  // tryb przypisania
  const assignees = Array.isArray(task?.assignees) ? task.assignees : (task?.assignee?[task.assignee]:[]);
  modTask.inMode.value = (assignees && assignees.length>1) ? "multi" : "single";
  fillAssigneesUI(assignees);

  modTask.root.classList.add("open");
}
function closeTaskModal(){ modTask.root.classList.remove("open"); }

function fillAssigneesUI(preselected=[]){
  // single
  modTask.single.innerHTML = `<option value="">— wybierz —</option>` + state.users.map(u=>`
    <option value="${u.id||u.uid}">${escapeHtml(u.name||u.email||u.id)}</option>
  `).join("");
  const singleValue = preselected[0] || "";
  modTask.single.value = singleValue;

  // multi
  modTask.multi.innerHTML = state.users.map(u=>{
    const id = u.id||u.uid;
    const checked = preselected.includes(id) ? "checked":"";
    return `<label style="display:flex;gap:6px;align-items:center"><input type="checkbox" value="${id}" ${checked}/> <span>${escapeHtml(u.name||u.email||id)}</span></label>`;
  }).join("");

  const multi = modTask.inMode.value === "multi";
  modTask.singleWrap.style.display = multi? "none":"block";
  modTask.multiWrap.style.display  = multi? "block":"none";
}

function openProjectModal(project){
  modProj._editId = project?.id || null;
  modProj.title.textContent = project? "Edytuj projekt":"Nowy projekt";
  modProj.inName.value = project?.name || "";
  fillProjectMembersUI(project?.id, project?.members || []);
  modProj.root.classList.add("open");
}
function closeProjectModal(){ modProj.root.classList.remove("open"); }

function fillProjectMembersUI(projectId, preselected=[]){
  modProj.membersWrap.innerHTML = state.users.map(u=>{
    const id = u.id||u.uid;
    const checked = preselected.includes(id) ? "checked":"";
    return `<label style="display:flex;gap:6px;align-items:center"><input type="checkbox" value="${id}" ${checked}/> <span>${escapeHtml(u.name||u.email||id)}</span></label>`;
  }).join("");
}

/* =========================
   12) UTILS
========================= */
function combineDateTime(d,t){
  if(!d && !t) return null;
  const date = d? new Date(d+"T00:00:00") : new Date();
  if(t){
    const [hh,mm] = t.split(":").map(Number);
    date.setHours(hh||0,mm||0,0,0);
  }
  return date.toISOString();
}
function toInputDate(d){ return d.toISOString().slice(0,10); }
function toInputTime(d){ return d.toTimeString().slice(0,5); }
function getCheckedValues(container){
  return Array.from(container.querySelectorAll("input[type=checkbox]:checked")).map(i=>i.value);
}
function escapeHtml(s){ return String(s??"").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[m])); }

/* =========================
   13) START
========================= */
</script>
</body>
</html>
