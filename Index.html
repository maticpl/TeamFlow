<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TeamFlow</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* ==================
           1. Zmienne i Reset
           ================== */
        :root {
            --bg-primary: #f4f5f7;
            --bg-secondary: #ffffff;
            --bg-tertiary: #e9eaec;
            --bg-overlay: rgba(0, 0, 0, 0.5);
            --text-primary: #172b4d;
            --text-secondary: #5e6c84;
            --text-on-accent: #ffffff;
            --border-color: #dfe1e6;
            --accent-primary: #4f46e5;
            --accent-hover: #4338ca;
            --danger-primary: #dc2626;
            --danger-hover: #b91c1c;
            --priority-high-bg: #fef9c3;
            --priority-high-border: #fde047;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
            --border-radius: 8px;
            --font-family: 'Inter', sans-serif;
        }

        .dark-mode {
            --bg-primary: #1f2937;
            --bg-secondary: #374151;
            --bg-tertiary: #4b5563;
            --text-primary: #f9fafb;
            --text-secondary: #d1d5db;
            --border-color: #4b5563;
            --priority-high-bg: #4f46e5;
            --priority-high-border: #6d28d9;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.5;
            overflow: hidden;
            transition: background-color 0.3s, color 0.3s;
        }

        /* ==================
           2. Główne Komponenty i Uwierzytelnianie
           ================== */

        #auth-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--bg-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10001;
        }

        .auth-container {
            background-color: var(--bg-secondary);
            padding: 40px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-lg);
            width: 90%;
            max-width: 400px;
            text-align: center;
        }

        .auth-container h2 {
            margin-bottom: 24px;
        }

        #register-form {
            display: none;
        }

        .auth-form .form-group {
            text-align: left;
        }
        
        .auth-form .btn {
            width: 100%;
            margin-top: 16px;
        }
        .auth-form .btn:disabled {
            background-color: var(--bg-tertiary);
            cursor: wait;
        }

        .auth-toggle {
            margin-top: 24px;
            font-size: 14px;
        }
        .auth-toggle a {
            color: var(--accent-primary);
            font-weight: 500;
            cursor: pointer;
        }
        
        .error-message {
            color: var(--danger-primary);
            margin-top: 16px;
            font-size: 14px;
            min-height: 20px;
        }


        .app-container {
            display: flex;
            height: 100vh;
        }
        .app-container.hidden {
            display: none;
        }

        .sidebar {
            width: 260px;
            background-color: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            padding: 24px;
            display: flex;
            flex-direction: column;
            transition: background-color 0.3s, border-color 0.3s, transform 0.3s ease-in-out;
            flex-shrink: 0;
        }

        .main-content {
            flex-grow: 1;
            padding: 24px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        /* ==================
           3. Sidebar
           ================== */
        
        .sidebar-footer {
            margin-top: auto;
            border-top: 1px solid var(--border-color);
            padding-top: 16px;
        }
        
        .sidebar-footer .user-info {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 8px;
            word-break: break-all;
        }
        
        #logout-btn {
            width: 100%;
            background: none;
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
        }
        #logout-btn:hover {
            background-color: var(--bg-tertiary);
        }

        .sidebar-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 24px;
        }

        .sidebar-header .logo {
            width: 32px;
            height: 32px;
            background-color: var(--accent-primary);
            border-radius: var(--border-radius);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .sidebar-header .logo svg {
            width: 20px;
            height: 20px;
            color: white;
        }

        .sidebar-header h1 {
            font-size: 20px;
            font-weight: 600;
        }

        .search-bar {
            position: relative;
            margin-bottom: 16px;
        }
        .search-bar input {
            width: 100%;
            padding: 8px 12px 8px 32px;
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
            background-color: var(--bg-primary);
            color: var(--text-primary);
            font-size: 14px;
        }
        .search-bar svg {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            width: 16px;
            height: 16px;
            color: var(--text-secondary);
        }

        .nav-section {
            margin-bottom: 24px;
        }
        .nav-section h2 {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
            padding: 0 4px;
        }
        .nav-list {
            list-style: none;
            overflow-y: auto;
            max-height: calc(100vh - 500px); /* Adjust based on other elements */
        }
        .nav-item a {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px;
            border-radius: var(--border-radius);
            text-decoration: none;
            color: var(--text-primary);
            font-weight: 500;
            font-size: 14px;
            transition: background-color 0.2s, color 0.2s;
        }
        .nav-item a:hover {
            background-color: var(--bg-tertiary);
        }
        .nav-item a.active {
            background-color: var(--accent-primary);
            color: var(--text-on-accent);
        }
        .nav-item svg {
            width: 20px;
            height: 20px;
        }
        
        .new-project-btn {
            width: 100%;
            padding: 10px;
            border-radius: var(--border-radius);
            border: none;
            background-color: var(--accent-primary);
            color: var(--text-on-accent);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .new-project-btn:hover {
            background-color: var(--accent-hover);
        }

        /* ==================
           4. Main Content - Nagłówek
           ================== */
        .mobile-header {
            display: none;
        }
        
        .main-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            flex-shrink: 0;
        }

        .project-title-wrapper {
             display: flex;
             align-items: center;
             gap: 16px;
        }
        .project-title h2 {
            font-size: 24px;
            font-weight: 600;
        }
        .project-actions button {
            background: none;
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            padding: 4px 10px;
            font-size: 13px;
            font-weight: 500;
            border-radius: var(--border-radius);
            cursor: pointer;
            margin-left: 8px;
            transition: background-color 0.2s, color 0.2s;
        }
        .project-actions button:hover {
            background-color: var(--bg-tertiary);
            color: var(--text-primary);
        }
        .project-actions .complete-project-btn:hover {
            border-color: var(--danger-primary);
            background-color: var(--danger-primary);
            color: white;
        }

        .project-members {
            display: flex;
            align-items: center;
            margin-top: 4px;
        }
        .avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background-color: #ccc;
            color: var(--text-on-accent);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
            border: 2px solid var(--bg-secondary);
            margin-left: -8px;
        }
        .project-members .avatar:first-child {
            margin-left: 0;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .sort-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border: none;
            border-radius: var(--border-radius);
            background-color: var(--bg-tertiary);
            color: var(--text-secondary);
            font-weight: 500;
            cursor: pointer;
        }
        .sort-btn svg {
            width: 16px;
            height: 16px;
        }

        .theme-switcher {
            display: flex;
            align-items: center;
            background-color: var(--bg-tertiary);
            padding: 4px;
            border-radius: 20px;
        }
        .theme-switcher button {
            background: none;
            border: none;
            padding: 6px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
        }
        .theme-switcher button.active {
            background-color: var(--bg-secondary);
            color: var(--accent-primary);
            box-shadow: var(--shadow-sm);
        }
        .theme-switcher svg {
            width: 18px;
            height: 18px;
        }

        /* ==================
           5. Kanban Board
           ================== */
        .kanban-board {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            height: 100%;
            overflow-x: auto;
        }
        .kanban-column {
            background-color: var(--bg-tertiary);
            border-radius: var(--border-radius);
            padding: 12px;
            display: flex;
            flex-direction: column;
            max-height: 100%;
        }
        .kanban-column-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding: 0 4px;
            gap: 8px;
        }
        .kanban-column-header h3 {
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-secondary);
            white-space: nowrap;
        }
        .task-count {
            font-size: 12px;
            font-weight: 600;
            background-color: var(--border-color);
            color: var(--text-secondary);
            padding: 2px 8px;
            border-radius: 10px;
            margin-left: auto;
        }
        .add-task-icon-btn {
            background: none;
            border: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            color: var(--text-secondary);
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s, color 0.2s;
        }
        .add-task-icon-btn:hover {
            background-color: var(--border-color);
            color: var(--text-primary);
        }

        .kanban-tasks {
            list-style: none;
            flex-grow: 1;
            overflow-y: auto;
            padding-right: 4px; /* for scrollbar */
        }
        .kanban-tasks::-webkit-scrollbar {
            width: 6px;
        }
        .kanban-tasks::-webkit-scrollbar-thumb {
            background-color: var(--border-color);
            border-radius: 3px;
        }
       
        /* ==================
           6. Task Card
           ================== */
        .task-card {
            background-color: var(--bg-secondary);
            border-left: 4px solid transparent;
            border-radius: var(--border-radius);
            padding: 12px 12px 12px 36px;
            margin-bottom: 12px;
            box-shadow: var(--shadow-sm);
            cursor: pointer;
            transition: box-shadow 0.2s, background-color 0.2s;
            position: relative;
        }
        .task-card.priority-high {
            background-color: var(--priority-high-bg);
            border-left-color: var(--priority-high-border);
        }
        .task-card:hover {
            box-shadow: var(--shadow-md);
        }
        .task-card.dragging {
            opacity: 0.5;
            transform: rotate(3deg);
        }
        .task-card-checkbox {
            position: absolute;
            left: 12px;
            top: 14px;
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        .task-project-name {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 4px;
            display: block;
        }
        .task-card h4 {
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 8px;
        }
        .task-card.completed h4 {
            text-decoration: line-through;
            color: var(--text-secondary);
        }
        .task-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .task-details {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .task-detail {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 12px;
            color: var(--text-secondary);
        }
        .task-detail svg {
            width: 14px;
            height: 14px;
        }
        .task-assignee .avatar {
            width: 24px;
            height: 24px;
            font-size: 12px;
            border-color: var(--bg-tertiary);
        }

        /* ==================
           7. Modal
           ================== */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--bg-overlay);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
            z-index: 1000;
        }
        .modal-overlay.visible {
            opacity: 1;
            visibility: visible;
        }
        .modal {
            background-color: var(--bg-secondary);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-lg);
            width: 90%;
            max-width: 800px;
            display: flex;
            flex-direction: column;
            transform: scale(0.95);
            transition: transform 0.3s;
            max-height: 90vh;
        }
        #notification-modal .modal {
            max-width: 400px;
        }
        .modal-overlay.visible .modal {
            transform: scale(1);
        }

        .modal-header {
            padding: 16px 24px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }
        .modal-header h2 {
            font-size: 18px;
        }
        .modal-close-btn {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--text-secondary);
            padding: 4px;
            font-size: 24px;
            line-height: 1;
        }
        .modal-close-btn:hover {
            color: var(--text-primary);
        }
        
        /* Modal do szczegółów zadania */
        .task-modal-content {
            display: flex;
            overflow: hidden;
        }
        .task-modal-main {
            flex-grow: 1;
            padding: 24px;
            border-right: 1px solid var(--border-color);
            overflow-y: auto;
        }
        .task-modal-sidebar {
            width: 250px;
            padding: 24px;
            background-color: var(--bg-primary);
            flex-shrink: 0;
        }
        
        .task-modal-title {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            margin-bottom: 16px;
        }
        .task-modal-title input[type="checkbox"] {
            margin-top: 8px;
            width: 18px;
            height: 18px;
        }
        .task-modal-title h3 {
            font-size: 22px;
            font-weight: 600;
        }
        
        .task-modal-section {
            margin-bottom: 24px;
        }
        .task-modal-section h4 {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .description textarea {
            width: 100%;
            min-height: 120px;
            padding: 8px;
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
            background-color: var(--bg-primary);
            font-family: var(--font-family);
            font-size: 14px;
            resize: vertical;
        }
        
        .subtasks-list {
            list-style: none;
        }
        .subtask-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 4px 0;
        }
        .subtask-item input[type="checkbox"] {
            width: 16px;
            height: 16px;
        }
        
        .sidebar-detail {
            margin-bottom: 16px;
        }
        .sidebar-detail label {
            display: block;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }
        .sidebar-detail select, .sidebar-detail input {
            width: 100%;
            padding: 8px;
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
            background-color: var(--bg-secondary);
            color: var(--text-primary);
        }

        /* Modal do nowego projektu i zadania */
        .form-modal-content {
            padding: 24px;
            overflow-y: auto;
        }
        .form-group {
            margin-bottom: 16px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }
        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 10px;
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
            background-color: var(--bg-primary);
            font-family: var(--font-family);
            font-size: 14px;
        }
        .form-group textarea {
            resize: vertical;
        }

        .members-selection {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            background-color: var(--bg-primary);
            padding: 12px;
            border-radius: var(--border-radius);
        }
        .member-option {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .modal-footer {
            padding: 16px 24px;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            background-color: var(--bg-secondary);
            flex-shrink: 0;
        }
        .btn {
            padding: 10px 16px;
            border-radius: var(--border-radius);
            border: none;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
        }
        .btn-primary {
            background-color: var(--accent-primary);
            color: var(--text-on-accent);
        }
        .btn-secondary {
            background-color: var(--bg-tertiary);
            color: var(--text-primary);
        }

        /* ==================
           8. Stany i Nakładki
           ================== */
        .confetti-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 9999;
            overflow: hidden;
        }
        .confetti {
            position: absolute;
            width: 8px;
            height: 16px;
            background: #f00; /* Placeholder */
            opacity: 0;
            animation: fall 4s linear forwards;
        }
        @keyframes fall {
            0% {
                transform: translateY(-10vh) rotateZ(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(110vh) rotateZ(720deg);
                opacity: 0;
            }
        }

        .search-results-list {
            list-style: none;
            max-height: 50vh;
            overflow-y: auto;
        }
        .search-result-item {
            padding: 12px;
            border-radius: var(--border-radius);
            cursor: pointer;
            border-bottom: 1px solid var(--border-color);
        }
        .search-result-item:last-child {
            border-bottom: none;
        }
        .search-result-item:hover {
            background-color: var(--bg-tertiary);
        }
        .search-result-item h4 {
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 4px;
        }
        .search-result-item p {
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            color: var(--text-primary);
            font-size: 18px;
            text-align: center;
            padding: 20px;
        }
        .dark-mode #loading-overlay {
             background-color: rgba(0, 0, 0, 0.8);
        }
        
        /* ==================
           9. Responsywność (Mobile)
           ================== */
        @media (max-width: 768px) {
            .app-container {
                flex-direction: column;
            }

            .sidebar {
                position: fixed;
                top: 0;
                left: 0;
                height: 100%;
                z-index: 2000;
                transform: translateX(-100%);
                border-right: 1px solid var(--border-color);
            }
            .sidebar.open {
                transform: translateX(0);
                box-shadow: var(--shadow-lg);
            }

            .main-content {
                padding: 16px;
                padding-top: 70px; /* Miejsce na mobilny nagłówek */
            }
            .mobile-header {
                display: flex;
                align-items: center;
                justify-content: space-between;
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                background-color: var(--bg-secondary);
                padding: 12px 16px;
                box-shadow: var(--shadow-sm);
                z-index: 1001;
            }
            #menu-toggle {
                background: none;
                border: none;
                cursor: pointer;
                padding: 4px;
            }
            #menu-toggle svg {
                width: 24px;
                height: 24px;
                color: var(--text-primary);
            }
            .mobile-header h2 {
                font-size: 18px;
            }
            
            .main-header {
                display: none; /* Ukryj stary nagłówek */
            }
            
            .kanban-board {
                display: flex;
                flex-direction: column;
                overflow-y: auto;
                overflow-x: hidden;
                gap: 24px;
                height: 100%;
            }

            .kanban-column {
                min-height: 200px; /* Zapobiega zapadaniu się pustych kolumn */
            }

            .modal {
                width: 95vw;
                max-height: 85vh;
            }
            .task-modal-content {
                flex-direction: column;
                overflow-y: auto;
            }
            .task-modal-sidebar {
                width: 100%;
                border-top: 1px solid var(--border-color);
                border-right: none;
            }
        }


    </style>
</head>
<body>
    <div id="loading-overlay" style="display: none;">
        <p>Ładowanie aplikacji...</p>
    </div>

    <div id="auth-overlay">
        <div class="auth-container">
            <!-- Formularz Logowania -->
            <form id="login-form" class="auth-form">
                <h2>Zaloguj się</h2>
                <div class="form-group">
                    <label for="login-email">Email</label>
                    <input type="email" id="login-email" required>
                </div>
                <div class="form-group">
                    <label for="login-password">Hasło</label>
                    <input type="password" id="login-password" required>
                </div>
                <button type="submit" class="btn btn-primary">Zaloguj się</button>
                <p id="auth-error-login" class="error-message"></p>
                <p class="auth-toggle">Nie masz konta? <a id="show-register">Zarejestruj się</a></p>
            </form>

            <!-- Formularz Rejestracji -->
            <form id="register-form" class="auth-form">
                <h2>Stwórz konto</h2>
                 <div class="form-group">
                    <label for="register-name">Nazwa użytkownika</label>
                    <input type="text" id="register-name" required>
                </div>
                <div class="form-group">
                    <label for="register-email">Email</label>
                    <input type="email" id="register-email" required>
                </div>
                <div class="form-group">
                    <label for="register-password">Hasło (min. 6 znaków)</label>
                    <input type="password" id="register-password" required>
                </div>
                <button type="submit" class="btn btn-primary">Zarejestruj się</button>
                 <p id="auth-error-register" class="error-message"></p>
                <p class="auth-toggle">Masz już konto? <a id="show-login">Zaloguj się</a></p>
            </form>
        </div>
    </div>
    
    <div class="app-container hidden">
        <!-- =========== PANEL BOCZNY =========== -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6A2.25 2.25 0 016 3.75h2.25A2.25 2.25 0 0110.5 6v2.25a2.25 2.25 0 01-2.25 2.25H6a2.25 2.25 0 01-2.25-2.25V6zM3.75 15.75A2.25 2.25 0 016 13.5h2.25a2.25 2.25 0 012.25 2.25V18a2.25 2.25 0 01-2.25 2.25H6A2.25 2.25 0 013.75 18v-2.25zM13.5 6a2.25 2.25 0 012.25-2.25H18A2.25 2.25 0 0120.25 6v2.25A2.25 2.25 0 0118 10.5h-2.25a2.25 2.25 0 01-2.25-2.25V6zM13.5 15.75a2.25 2.25 0 012.25-2.25H18a2.25 2.25 0 012.25 2.25V18A2.25 2.25 0 0118 20.25h-2.25A2.25 2.25 0 0113.5 18v-2.25z" />
                    </svg>
                </div>
                <h1>TeamFlow</h1>
            </div>

            <div class="search-bar">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" />
                </svg>
                <input type="text" placeholder="Szukaj..." id="search-input" readonly>
            </div>

            <nav class="nav-section">
                <ul class="nav-list" id="main-nav">
                    <li class="nav-item">
                        <a href="#" data-view="my-tasks">
                             <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z" />
                            </svg>
                            <span>Moje zadania</span>
                        </a>
                    </li>
                </ul>
            </nav>

            <div style="flex-grow: 1; overflow: hidden; display: flex; flex-direction: column;">
                <nav class="nav-section">
                    <h2>Moje projekty</h2>
                    <ul class="nav-list" id="projects-list">
                        <!-- Projekty będą renderowane tutaj -->
                    </ul>
                </nav>
                
                 <nav class="nav-section" id="completed-projects-section" style="display: none;">
                    <h2>Zakończone projekty</h2>
                    <ul class="nav-list" id="completed-projects-list">
                        <!-- Zakończone projekty będą renderowane tutaj -->
                    </ul>
                </nav>
            </div>
            
            <button class="new-project-btn" id="new-project-btn">+ Nowy Projekt</button>

            <div class="sidebar-footer">
                <p class="user-info">Zalogowano jako:<br><span id="user-email-display"></span></p>
                <button id="logout-btn" class="btn">Wyloguj</button>
            </div>
        </aside>

        <!-- =========== GŁÓWNA ZAWARTOŚĆ =========== -->
        <main class="main-content">
            <header class="mobile-header">
                <button id="menu-toggle">
                     <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
                    </svg>
                </button>
                 <h2 id="mobile-header-title"></h2>
                 <div class="theme-switcher" id="mobile-theme-switcher">
                    <!-- Switcher zostanie sklonowany tutaj przez JS -->
                 </div>
            </header>
            <header class="main-header">
                <div>
                    <div class="project-title-wrapper">
                        <div class="project-title">
                            <h2 id="project-name-header"></h2>
                        </div>
                        <div class="project-actions" id="project-actions">
                             <button id="edit-project-btn">Edytuj projekt</button>
                             <button id="complete-project-btn" class="complete-project-btn">Zakończ projekt</button>
                        </div>
                    </div>
                    <div class="project-members" id="project-members-header">
                       <!-- Awatary będą renderowane tutaj -->
                    </div>
                </div>
                <div class="header-actions">
                     <button class="sort-btn" id="sort-btn" style="display: none;">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                           <path stroke-linecap="round" stroke-linejoin="round" d="M3 7.5L7.5 3m0 0L12 7.5M7.5 3v13.5m13.5 0L16.5 21m0 0L12 16.5m4.5 4.5V7.5" />
                        </svg>
                        <span>Sortuj po dacie</span>
                    </button>
                    <div class="theme-switcher" id="desktop-theme-switcher">
                        <button id="theme-light" title="Tryb Jasny">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z" />
                            </svg>
                        </button>
                        <button id="theme-dark" title="Tryb Ciemny">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                              <path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z" />
                            </svg>
                        </button>
                    </div>
                </div>
            </header>

            <section class="kanban-board" id="kanban-board">
                <!-- Kolumny Kanban będą renderowane tutaj -->
            </section>
        </main>
    </div>

    <!-- =========== MODAL - SZCZEGÓŁY ZADANIA =========== -->
    <div class="modal-overlay" id="task-modal">
        <div class="modal">
            <div class="modal-header">
                <h2>Szczegóły zadania</h2>
                <button type="button" class="modal-close-btn">&times;</button>
            </div>
            <div class="task-modal-content">
                <div class="task-modal-main">
                    <div class="task-modal-title">
                        <input type="checkbox" id="modal-task-completed">
                        <h3 id="modal-task-title"></h3>
                    </div>

                    <div class="task-modal-section description">
                        <h4>Opis</h4>
                        <textarea id="modal-task-description" placeholder="Dodaj opis zadania..."></textarea>
                    </div>

                    <div class="task-modal-section subtasks">
                        <h4>Podzadania</h4>
                        <ul class="subtasks-list" id="modal-subtasks-list">
                            <!-- podzadania -->
                        </ul>
                    </div>
                </div>
                <div class="task-modal-sidebar">
                    <div class="sidebar-detail">
                        <label for="modal-task-status">Status</label>
                        <select id="modal-task-status"></select>
                    </div>
                    <div class="sidebar-detail">
                        <label for="modal-task-assignee">Przypisana osoba</label>
                        <select id="modal-task-assignee"></select>
                    </div>
                    <div class="sidebar-detail">
                        <label for="modal-task-priority">Priorytet</label>
                        <select id="modal-task-priority">
                            <option value="low">Niski</option>
                            <option value="medium">Średni</option>
                            <option value="high">Wysoki</option>
                        </select>
                    </div>
                    <div class="sidebar-detail">
                        <label for="modal-task-dueDate">Termin wykonania</label>
                        <input type="date" id="modal-task-dueDate">
                    </div>
                </div>
            </div>
             <div class="modal-footer">
                <button type="button" class="btn btn-secondary modal-close-btn">Anuluj</button>
                <button type="button" id="save-task-btn" class="btn btn-primary">Zapisz zmiany</button>
            </div>
        </div>
    </div>
    
    <!-- =========== MODAL - NOWY PROJEKT =========== -->
    <div class="modal-overlay" id="new-project-modal">
        <div class="modal">
            <form id="new-project-form">
                <div class="modal-header">
                    <h2>Stwórz nowy projekt</h2>
                    <button type="button" class="modal-close-btn">&times;</button>
                </div>
                <div class="form-modal-content">
                    <div class="form-group">
                        <label for="new-project-name">Nazwa projektu</label>
                        <input type="text" id="new-project-name" required placeholder="np. Nowa kampania marketingowa">
                    </div>
                    <div class="form-group">
                        <label>Dodaj członków zespołu</label>
                         <div id="new-project-members" class="members-selection">
                            <!-- Opcje użytkowników renderowane przez JS -->
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="new-project-tasks">Pierwsze zadania (każde w nowej linii)</label>
                        <textarea id="new-project-tasks" rows="4" placeholder="- Zaplanować spotkanie kickoff&#10;- Przygotować brief"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary modal-close-btn">Anuluj</button>
                    <button type="submit" class="btn btn-primary">Stwórz projekt</button>
                </div>
            </form>
        </div>
    </div>

    <!-- =========== MODAL - EDYCJA PROJEKTU =========== -->
    <div class="modal-overlay" id="edit-project-modal">
        <div class="modal">
            <form id="edit-project-form">
                <div class="modal-header">
                    <h2>Edytuj projekt</h2>
                    <button type="button" class="modal-close-btn">&times;</button>
                </div>
                <div class="form-modal-content">
                    <div class="form-group">
                        <label for="edit-project-name">Nazwa projektu</label>
                        <input type="text" id="edit-project-name" required>
                    </div>
                     <div class="form-group">
                        <label>Członkowie zespołu</label>
                        <div id="edit-project-members" class="members-selection">
                            <!-- Opcje użytkowników renderowane przez JS -->
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary modal-close-btn">Anuluj</button>
                    <button type="submit" class="btn btn-primary">Zapisz zmiany</button>
                </div>
            </form>
        </div>
    </div>

    <!-- =========== MODAL - NOWE ZADANIE =========== -->
    <div class="modal-overlay" id="new-task-modal">
        <div class="modal">
            <form id="new-task-form">
                <div class="modal-header">
                    <h2>Dodaj nowe zadanie</h2>
                    <button type="button" class="modal-close-btn">&times;</button>
                </div>
                <div class="form-modal-content">
                    <div class="form-group">
                        <label for="new-task-title">Tytuł zadania</label>
                        <input type="text" id="new-task-title" required placeholder="np. Zaprojektować nowy landing page">
                    </div>
                    <div class="form-group">
                        <label for="new-task-description">Opis</label>
                        <textarea id="new-task-description" rows="4" placeholder="Dodaj więcej szczegółów..."></textarea>
                    </div>
                    <div style="display: flex; gap: 16px;">
                        <div class="form-group" style="flex: 1;">
                            <label for="new-task-dueDate">Termin</label>
                            <input type="date" id="new-task-dueDate">
                        </div>
                         <div class="form-group" style="flex: 1;">
                            <label for="new-task-priority">Priorytet</label>
                            <select id="new-task-priority">
                                <option value="low">Niski</option>
                                <option value="medium" selected>Średni</option>
                                <option value="high">Wysoki</option>
                            </select>
                        </div>
                    </div>
                     <div class="form-group">
                        <label for="new-task-assignee">Przypisz do</label>
                        <select id="new-task-assignee"></select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary modal-close-btn">Anuluj</button>
                    <button type="submit" class="btn btn-primary">Zapisz zadanie</button>
                </div>
            </form>
        </div>
    </div>

    <!-- =========== MODAL - WYSZUKIWARKA =========== -->
    <div class="modal-overlay" id="search-modal">
        <div class="modal">
            <div class="modal-header">
                <h2>Wyszukaj zadania</h2>
                <button type="button" class="modal-close-btn">&times;</button>
            </div>
            <div class="form-modal-content">
                <div class="search-bar" style="margin-bottom: 24px;">
                     <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" />
                    </svg>
                     <input type="text" placeholder="Wpisz szukaną frazę..." id="modal-search-input">
                </div>
                <ul id="search-results-list" class="search-results-list">
                    <!-- Wyniki wyszukiwania -->
                </ul>
            </div>
        </div>
    </div>
    
    <!-- =========== MODAL - POWIADOMIENIE =========== -->
    <div class="modal-overlay" id="notification-modal">
        <div class="modal">
             <div class="modal-header">
                <h2 id="notification-title">Powiadomienie</h2>
                <button type="button" class="modal-close-btn">&times;</button>
            </div>
            <div class="form-modal-content">
                <p id="notification-message"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary modal-close-btn">OK</button>
            </div>
        </div>
    </div>

    <script type="module">
        // Importuj potrzebne funkcje z SDK Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, addDoc, updateDoc, deleteDoc, onSnapshot, collection, query, writeBatch, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    
        // ============================
        // 0. Konfiguracja i Inicjalizacja Firebase
        // ============================
        
        const firebaseConfig = {
            apiKey: "AIzaSyDUgw_p1cI4corSOm4vypcNQVNGgXWYNLQ",
  authDomain: "wlasciwa-aplikacja.firebaseapp.com",
  databaseURL: "https://wlasciwa-aplikacja-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "wlasciwa-aplikacja",
  storageBucket: "wlasciwa-aplikacja.firebasestorage.app",
  messagingSenderId: "180170656322",
  appId: "1:180170656322:web:48fff7a2092ed2a3437bdb"
        };
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        let db, auth;
        const loadingOverlay = document.getElementById('loading-overlay');
        const authOverlay = document.getElementById('auth-overlay');
        const appContainer = document.querySelector('.app-container');

        try {
            if (firebaseConfig.apiKey === "TWOJ_KLUCZ_API") {
                throw new Error("Klucze Firebase nie zostały skonfigurowane.");
            }
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
        } catch (error) {
            console.error("Błąd inicjalizacji Firebase:", error);
            authOverlay.innerHTML = `<div class="auth-container"><h2>Błąd Konfiguracji</h2><p>Błąd inicjalizacji Firebase: ${error.message}. Sprawdź, czy obiekt 'firebaseConfig' jest poprawnie uzupełniony w kodzie i czy projekt Firebase został poprawnie utworzony.</p></div>`;
        }

        const projectsRef = collection(db, `artifacts/${appId}/public/data/projects`);
        const completedProjectsRef = collection(db, `artifacts/${appId}/public/data/completedProjects`);
        const usersRef = collection(db, `artifacts/${appId}/public/data/users`);

    document.addEventListener('DOMContentLoaded', () => {
        
        const STATUSES = {
            todo: 'Do realizacji',
            inprogress: 'W trakcie realizacji',
            done: 'Wykonane'
        };

        let state = {
            currentUser: null,
            users: [],
            projects: [],
            completedProjects: [],
            currentProjectId: null,
            ui: {
                theme: 'light',
                currentView: 'projects',
                sortMyTasksByDate: 'asc',
                unsubscribeProjects: null,
                unsubscribeCompleted: null,
                unsubscribeUsers: null,
            }
        };

        const sidebar = document.getElementById('sidebar');
        const menuToggle = document.getElementById('menu-toggle');
        const mobileHeaderTitle = document.getElementById('mobile-header-title');
        const mobileThemeSwitcher = document.getElementById('mobile-theme-switcher');
        const desktopThemeSwitcher = document.getElementById('desktop-theme-switcher');

        const mainNav = document.getElementById('main-nav');
        const projectsListEl = document.getElementById('projects-list');
        const completedProjectsSection = document.getElementById('completed-projects-section');
        const completedProjectsListEl = document.getElementById('completed-projects-list');
        const projectNameHeaderEl = document.getElementById('project-name-header');
        const projectMembersHeaderEl = document.getElementById('project-members-header');
        const kanbanBoardEl = document.getElementById('kanban-board');
        const sortBtn = document.getElementById('sort-btn');
        const searchInput = document.getElementById('search-input');
        const projectActionsEl = document.getElementById('project-actions');
        const editProjectBtn = document.getElementById('edit-project-btn');
        const completeProjectBtn = document.getElementById('complete-project-btn');
        const userEmailDisplay = document.getElementById('user-email-display');
        const logoutBtn = document.getElementById('logout-btn');
        const newProjectBtn = document.getElementById('new-project-btn');

        const taskModal = {
            overlay: document.getElementById('task-modal'),
            title: document.getElementById('modal-task-title'),
            completed: document.getElementById('modal-task-completed'),
            description: document.getElementById('modal-task-description'),
            subtasksList: document.getElementById('modal-subtasks-list'),
            status: document.getElementById('modal-task-status'),
            assignee: document.getElementById('modal-task-assignee'),
            priority: document.getElementById('modal-task-priority'),
            dueDate: document.getElementById('modal-task-dueDate'),
            saveBtn: document.getElementById('save-task-btn'),
        };
        const newProjectModal = {
            overlay: document.getElementById('new-project-modal'),
            form: document.getElementById('new-project-form'),
            nameInput: document.getElementById('new-project-name'),
            membersContainer: document.getElementById('new-project-members'),
            tasksTextarea: document.getElementById('new-project-tasks'),
        };
        const editProjectModal = {
            overlay: document.getElementById('edit-project-modal'),
            form: document.getElementById('edit-project-form'),
            nameInput: document.getElementById('edit-project-name'),
            membersContainer: document.getElementById('edit-project-members'),
        };
        const newTaskModal = {
            overlay: document.getElementById('new-task-modal'),
            form: document.getElementById('new-task-form'),
            title: document.getElementById('new-task-title'),
            description: document.getElementById('new-task-description'),
            assignee: document.getElementById('new-task-assignee'),
            dueDate: document.getElementById('new-task-dueDate'),
            priority: document.getElementById('new-task-priority'),
        };
        const searchModal = {
            overlay: document.getElementById('search-modal'),
            input: document.getElementById('modal-search-input'),
            resultsList: document.getElementById('search-results-list'),
        };
        const notificationModal = {
            overlay: document.getElementById('notification-modal'),
            message: document.getElementById('notification-message'),
        };
        
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const showRegisterBtn = document.getElementById('show-register');
        const showLoginBtn = document.getElementById('show-login');
        const authErrorLogin = document.getElementById('auth-error-login');
        const authErrorRegister = document.getElementById('auth-error-register');

        // Klonowanie przełącznika motywu dla widoku mobilnego
        mobileThemeSwitcher.appendChild(desktopThemeSwitcher.cloneNode(true));
        
        const findUser = (userId) => state.users.find(u => u.id === userId);
        const findProject = (projectId) => state.projects.find(p => p.id === projectId);
        const findCompletedProject = (projectId) => state.completedProjects.find(p => p.id === projectId);
        const findTask = (taskId) => {
            const allProjects = [...state.projects, ...state.completedProjects];
            for (const project of allProjects) {
                const task = (project.tasks || []).find(t => t.id === taskId);
                if (task) return { task, project };
            }
            return { task: null, project: null };
        };
        const saveUiState = () => localStorage.setItem(`teamFlowUiState_${appId}`, JSON.stringify(state.ui));
        const loadUiState = () => {
            const savedUiState = localStorage.getItem(`teamFlowUiState_${appId}`);
            if (savedUiState) {
                const loadedUi = JSON.parse(savedUiState);
                state.ui = { ...state.ui, ...loadedUi, 
                    unsubscribeProjects: state.ui.unsubscribeProjects,
                    unsubscribeCompleted: state.ui.unsubscribeCompleted,
                    unsubscribeUsers: state.ui.unsubscribeUsers
                };
            }
        };

        function render() {
            if(!state.currentUser) return;
            applyTheme();
            renderSidebar();
            sortBtn.style.display = state.ui.currentView === 'my-tasks' ? 'flex' : 'none';
            if (state.ui.currentView === 'projects') {
                renderCurrentProjectView();
            } else {
                renderMyTasksView();
            }
        }

        function renderSidebar() {
            mainNav.querySelector('a').classList.toggle('active', state.ui.currentView === 'my-tasks');
            const renderProjectList = (projects, listEl) => {
                listEl.innerHTML = '';
                (projects || []).forEach(project => {
                    const li = document.createElement('li');
                    li.className = 'nav-item';
                    li.innerHTML = `<a href="#" data-project-id="${project.id}" class="${project.id === state.currentProjectId && state.ui.currentView === 'projects' ? 'active' : ''}"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg><span>${project.name}</span></a>`;
                    listEl.appendChild(li);
                });
            };
            renderProjectList(state.projects, projectsListEl);
            if(state.completedProjects.length > 0) {
                completedProjectsSection.style.display = 'block';
                renderProjectList(state.completedProjects, completedProjectsListEl);
            } else {
                completedProjectsSection.style.display = 'none';
            }
        }

        function renderCurrentProjectView() {
            const project = findProject(state.currentProjectId) || findCompletedProject(state.currentProjectId);
            const isCompleted = !!findCompletedProject(state.currentProjectId);
            const isOwner = project && project.ownerId === state.currentUser.uid;
            projectActionsEl.style.display = project && !isCompleted && isOwner ? 'flex' : 'none';
            if (!project) {
                 projectNameHeaderEl.textContent = 'Wybierz projekt';
                 mobileHeaderTitle.textContent = 'Projekty';
                 projectMembersHeaderEl.innerHTML = '';
                 kanbanBoardEl.innerHTML = '<p>Wybierz projekt lub stwórz nowy, aby zacząć.</p>';
                 return;
            }
            projectNameHeaderEl.textContent = project.name;
            mobileHeaderTitle.textContent = project.name;
            projectMembersHeaderEl.innerHTML = '';
            (project.members || []).forEach(memberId => {
                const user = findUser(memberId);
                if (user) {
                    const avatar = document.createElement('div');
                    avatar.className = 'avatar';
                    avatar.style.backgroundColor = user.avatarColor || '#ccc';
                    avatar.textContent = user.name ? user.name.split(' ').map(n => n[0]).join('') : user.email.substring(0,2).toUpperCase();
                    avatar.title = user.name || user.email;
                    projectMembersHeaderEl.appendChild(avatar);
                }
            });
            renderKanbanBoard(project.tasks || [], !isCompleted);
        }

        function renderMyTasksView() {
            projectNameHeaderEl.textContent = 'Moje zadania';
            mobileHeaderTitle.textContent = 'Moje zadania';
            projectMembersHeaderEl.innerHTML = '';
            projectActionsEl.style.display = 'none';
            let myTasks = state.projects.flatMap(p => 
                (p.tasks || [])
                    .filter(t => t.assignee === state.currentUser.uid)
                    .map(t => ({ ...t, projectName: p.name }))
            );
            myTasks.sort((a, b) => {
                const dateA = a.dueDate ? new Date(a.dueDate) : 0;
                const dateB = b.dueDate ? new Date(b.dueDate) : 0;
                if (!dateA) return 1; if (!dateB) return -1;
                return state.ui.sortMyTasksByDate === 'asc' ? dateA - dateB : dateB - dateA;
            });
            renderKanbanBoard(myTasks, false);
        }

        function renderKanbanBoard(tasks, isInteractive) {
            kanbanBoardEl.innerHTML = '';
            Object.keys(STATUSES).forEach(statusKey => {
                const column = document.createElement('div');
                column.className = 'kanban-column';
                column.dataset.status = statusKey;
                const tasksInColumn = (tasks || []).filter(t => t.status === statusKey);
                const addTaskBtnHTML = (isInteractive && statusKey === 'todo') ? `<button class="add-task-icon-btn" title="Dodaj nowe zadanie">+</button>` : '';
                column.innerHTML = `<div class="kanban-column-header"><h3>${STATUSES[statusKey]}</h3><span class="task-count">${tasksInColumn.length}</span>${addTaskBtnHTML}</div><ul class="kanban-tasks">${tasksInColumn.map(task => createTaskCardHTML(task, isInteractive)).join('')}</ul>`;
                kanbanBoardEl.appendChild(column);
            });
        }
        
        function createTaskCardHTML(task, isInteractive) {
            const assignee = findUser(task.assignee);
            const isCompleted = task.status === 'done';
            const priorityClass = task.priority === 'high' ? 'priority-high' : '';
            const projectNameHTML = task.projectName ? `<span class="task-project-name">${task.projectName}</span>` : '';
            const dueDateHTML = task.dueDate ? `
                <div class="task-detail">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75m-18 0h18" /></svg>
                    <span>${new Date(task.dueDate).toLocaleDateString('pl-PL')}</span>
                </div>` : '';

            return `<li class="task-card ${isCompleted ? 'completed' : ''} ${priorityClass}" ${isInteractive ? 'draggable="true"' : ''} data-task-id="${task.id}">
                <input type="checkbox" class="task-card-checkbox" data-task-id="${task.id}" ${isCompleted ? 'checked' : ''} ${isInteractive ? '' : 'disabled'}>
                ${projectNameHTML}
                <h4>${task.title}</h4>
                <div class="task-meta">
                    <div class="task-details">${dueDateHTML}</div>
                    <div class="task-assignee">${assignee ? `<div class="avatar" style="background-color: ${assignee.avatarColor || '#ccc'}" title="${assignee.name || assignee.email}">${(assignee.name || assignee.email).substring(0,2).toUpperCase()}</div>` : ''}</div>
                </div>
            </li>`;
        }

        function applyTheme() {
            const isDark = state.ui.theme === 'dark';
            document.body.classList.toggle('dark-mode', isDark);
            document.querySelectorAll('.theme-switcher').forEach(switcher => {
                switcher.querySelector('#theme-dark')?.classList.toggle('active', isDark);
                switcher.querySelector('#theme-light')?.classList.toggle('active', !isDark);
            });
        }
        
        function openModal(modal) { modal.classList.add('visible'); }
        function closeModal(modal) { modal.classList.remove('visible'); }
        function showNotification(message) {
            notificationModal.message.textContent = message;
            openModal(notificationModal.overlay);
        }

        function openTaskModal(taskId) {
            const { task, project } = findTask(taskId);
            if (!task || !project) return;
            taskModal.overlay.dataset.taskId = taskId;
            taskModal.title.textContent = task.title;
            taskModal.completed.checked = task.status === 'done';
            taskModal.description.value = task.description || '';
            taskModal.priority.value = task.priority;
            taskModal.dueDate.value = task.dueDate;
            taskModal.status.innerHTML = Object.keys(STATUSES).map(key => `<option value="${key}" ${task.status === key ? 'selected' : ''}>${STATUSES[key]}</option>`).join('');
            
            taskModal.assignee.innerHTML = '<option value="">Nikt</option>' + (project.members || []).map(memberId => {
                const user = findUser(memberId);
                return user ? `<option value="${user.id}" ${task.assignee === user.id ? 'selected' : ''}>${user.name || user.email}</option>` : '';
            }).join('');

            taskModal.subtasksList.innerHTML = task.subtasks?.map(sub => `<li class="subtask-item"><input type="checkbox" ${sub.done ? 'checked' : ''}><span>${sub.text}</span></li>`).join('') || '';
            openModal(taskModal.overlay);
        }

        async function saveTaskFromModal() {
            const taskId = taskModal.overlay.dataset.taskId;
            const { task, project } = findTask(taskId);
            if (!task || !project) return;
            
            const oldStatus = task.status;
            const updatedTask = {...task,
                description: taskModal.description.value,
                status: taskModal.status.value,
                assignee: taskModal.assignee.value,
                priority: taskModal.priority.value,
                dueDate: taskModal.dueDate.value,
            };
            if (taskModal.completed.checked && updatedTask.status !== 'done') updatedTask.status = 'done';
            else if (!taskModal.completed.checked && updatedTask.status === 'done') updatedTask.status = 'inprogress';
            
            const projectDocRef = findProject(project.id) ? doc(projectsRef, project.id) : doc(completedProjectsRef, project.id);
            const updatedTasks = project.tasks.map(t => t.id === taskId ? updatedTask : t);
            await updateDoc(projectDocRef, { tasks: updatedTasks });
            if (oldStatus !== 'done' && updatedTask.status === 'done') showConfetti();
            closeModal(taskModal.overlay);
        }
        
        function openNewTaskModal() {
            const project = findProject(state.currentProjectId);
            if (!project) return;
            newTaskModal.form.reset();
             newTaskModal.assignee.innerHTML = '<option value="">Nikt</option>' + (project.members || []).map(memberId => {
                const user = findUser(memberId);
                return user ? `<option value="${user.id}">${user.name || user.email}</option>` : '';
            }).join('');
            openModal(newTaskModal.overlay);
        }

        function openEditProjectModal(projectId) {
            const project = findProject(projectId);
            if (!project) return;
            editProjectModal.overlay.dataset.projectId = projectId;
            editProjectModal.nameInput.value = project.name;
            editProjectModal.membersContainer.innerHTML = state.users.map(user => 
                `<div class="member-option"><input type="checkbox" id="edit-user-sel-${user.id}" value="${user.id}" ${project.members.includes(user.id) ? 'checked' : ''}><label for="edit-user-sel-${user.id}">${user.name || user.email}</label></div>`
            ).join('');
            openModal(editProjectModal.overlay);
        }

        function showConfetti() {
            const container = document.createElement('div');
            container.className = 'confetti-container';
            document.body.appendChild(container);
            const colors = ['#ef4444', '#3b82f6', '#22c55e', '#f97316', '#8b5cf6', '#ec4899'];
            for (let i = 0; i < 100; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = `${Math.random() * 100}vw`;
                confetti.style.animationDelay = `${Math.random() * 2}s`;
                confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                container.appendChild(confetti);
            }
            setTimeout(() => container.remove(), 5000);
        }

        // ============================
        // OBSŁUGA ZDARZEŃ (EVENT LISTENERS)
        // ============================
        
        // --- Uwierzytelnianie ---
        showRegisterBtn.addEventListener('click', () => { loginForm.style.display = 'none'; registerForm.style.display = 'block'; });
        showLoginBtn.addEventListener('click', () => { registerForm.style.display = 'none'; loginForm.style.display = 'block'; });

        registerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('register-name').value.trim();
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            if (!name) {
                authErrorRegister.textContent = 'Nazwa użytkownika jest wymagana.';
                return;
            }
            authErrorRegister.textContent = '';
            const submitBtn = e.target.querySelector('button[type="submit"]');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Rejestrowanie...';
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                await setDoc(doc(usersRef, user.uid), {
                    uid: user.uid,
                    email: user.email,
                    name: name,
                    avatarColor: '#'+Math.floor(Math.random()*16777215).toString(16).padStart(6, '0')
                });
            } catch (error) {
                console.error("Błąd rejestracji:", error);
                authErrorRegister.textContent = error.message;
            } finally {
                 submitBtn.disabled = false;
                 submitBtn.textContent = 'Zarejestruj się';
            }
        });

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            authErrorLogin.textContent = '';
            const submitBtn = e.target.querySelector('button[type="submit"]');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Logowanie...';
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                console.error("Błąd logowania:", error);
                authErrorLogin.textContent = "Nieprawidłowy email lub hasło.";
            } finally {
                 submitBtn.disabled = false;
                 submitBtn.textContent = 'Zaloguj się';
            }
        });
        
        logoutBtn.addEventListener('click', () => signOut(auth));

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const userDoc = await getDoc(doc(usersRef, user.uid));
                state.currentUser = userDoc.exists() ? { uid: user.uid, ...userDoc.data() } : { uid: user.uid, email: user.email };
                
                authOverlay.style.display = 'none';
                appContainer.classList.remove('hidden');
                loadingOverlay.style.display = 'flex';
                userEmailDisplay.textContent = state.currentUser.email;
                setupFirestoreListeners(user.uid);
            } else {
                state.currentUser = null;
                appContainer.classList.add('hidden');
                authOverlay.style.display = 'flex';
                loadingOverlay.style.display = 'none';
                if (state.ui.unsubscribeProjects) state.ui.unsubscribeProjects();
                if (state.ui.unsubscribeCompleted) state.ui.unsubscribeCompleted();
                if (state.ui.unsubscribeUsers) state.ui.unsubscribeUsers();
            }
        });
        
        function setupFirestoreListeners(userId) {
            if (!userId) return;
            if (state.ui.unsubscribeUsers) state.ui.unsubscribeUsers();
            state.ui.unsubscribeUsers = onSnapshot(query(usersRef), (snapshot) => {
                state.users = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                render();
            }, (error) => console.error("Błąd odczytu użytkowników:", error));

            if (state.ui.unsubscribeProjects) state.ui.unsubscribeProjects();
            const projectsQuery = query(projectsRef, where("members", "array-contains", userId));
            state.ui.unsubscribeProjects = onSnapshot(projectsQuery, (snapshot) => {
                state.projects = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (!state.currentProjectId || (!findProject(state.currentProjectId) && !findCompletedProject(state.currentProjectId))) {
                    state.currentProjectId = state.projects.length > 0 ? state.projects[0].id : null;
                }
                loadingOverlay.style.display = 'none';
                render();
            }, (error) => {
                console.error("Błąd odczytu projektów:", error);
                loadingOverlay.innerHTML = `<p>Błąd dostępu do bazy danych.<br><small>Komunikat: ${error.message}</small><br><br><b>Ważne:</b> Upewnij się, że utworzyłeś/aś wymagany indeks w Firestore (zakładka Indexes -> Single Field).</p>`;
            });
            
            if (state.ui.unsubscribeCompleted) state.ui.unsubscribeCompleted();
             const completedQuery = query(completedProjectsRef, where("members", "array-contains", userId));
            state.ui.unsubscribeCompleted = onSnapshot(completedQuery, (snapshot) => {
                state.completedProjects = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                render();
            }, (error) => console.error("Błąd odczytu zakończonych projektów:", error));
        }
        
        loadUiState();
        
        // --- Interakcje w aplikacji ---
        const handleProjectLinkClick = (e) => {
            e.preventDefault();
            const link = e.target.closest('a');
            if (link) {
                state.currentProjectId = link.dataset.projectId;
                state.ui.currentView = 'projects';
                saveUiState();
                render();
                sidebar.classList.remove('open');
            }
        };
        projectsListEl.addEventListener('click', handleProjectLinkClick);
        completedProjectsListEl.addEventListener('click', handleProjectLinkClick);
        
        mainNav.addEventListener('click', (e) => {
            e.preventDefault();
            const link = e.target.closest('a');
            if(link) {
                state.ui.currentView = link.dataset.view;
                saveUiState();
                render();
                sidebar.classList.remove('open');
            }
        });

        newProjectBtn.addEventListener('click', () => {
             newProjectModal.form.reset();
             newProjectModal.membersContainer.innerHTML = state.users.map(user => 
                `<div class="member-option"><input type="checkbox" id="new-user-sel-${user.id}" value="${user.id}" ${user.id === state.currentUser.uid ? 'checked disabled' : ''}><label for="new-user-sel-${user.id}">${user.name || user.email}</label></div>`
            ).join('');
             openModal(newProjectModal.overlay);
        });

        newProjectModal.form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const newName = newProjectModal.nameInput.value.trim();
            if (!newName) return;
            const selectedMembers = Array.from(newProjectModal.membersContainer.querySelectorAll('input:checked')).map(input => input.value);
            if (!selectedMembers.includes(state.currentUser.uid)) {
                selectedMembers.push(state.currentUser.uid);
            }
            const taskTitles = newProjectModal.tasksTextarea.value.split('\n').map(t => t.replace(/^-/, '').trim()).filter(Boolean);
            const newProject = {
                name: newName,
                ownerId: state.currentUser.uid,
                members: selectedMembers,
                tasks: taskTitles.map((title, i) => ({
                    id: `task${Date.now() + i}`, title, description: '', status: 'todo', assignee: null, priority: 'medium', dueDate: null, subtasks: []
                }))
            };
            const docRef = await addDoc(projectsRef, newProject);
            state.currentProjectId = docRef.id;
            state.ui.currentView = 'projects';
            saveUiState();
            closeModal(newProjectModal.overlay);
        });
        
        editProjectBtn.addEventListener('click', () => openEditProjectModal(state.currentProjectId));

        editProjectModal.form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const projectId = editProjectModal.overlay.dataset.projectId;
            const newName = editProjectModal.nameInput.value.trim();
            if (!projectId || !newName) return;
            const selectedMembers = Array.from(editProjectModal.membersContainer.querySelectorAll('input:checked')).map(input => input.value);
            if (!selectedMembers.includes(state.currentUser.uid)) {
                selectedMembers.push(state.currentUser.uid);
            }
            await updateDoc(doc(projectsRef, projectId), { name: newName, members: selectedMembers });
            closeModal(editProjectModal.overlay);
        });

        completeProjectBtn.addEventListener('click', async () => {
            const project = findProject(state.currentProjectId);
            if (!project || (project.tasks || []).some(t => t.status !== 'done')) {
                showNotification("Wszystkie zadania muszą być ukończone, aby zamknąć projekt.");
                return;
            }
            try {
                await setDoc(doc(completedProjectsRef, project.id), project);
                await deleteDoc(doc(projectsRef, project.id));
                state.currentProjectId = state.projects.length > 0 ? state.projects[0].id : null;
                saveUiState();
            } catch (error) {
                console.error("Błąd zamykania projektu:", error);
                showNotification("Błąd podczas zamykania projektu.");
            }
        });
        
        newTaskModal.form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const title = newTaskModal.title.value.trim();
            if(!title) return;
            const project = findProject(state.currentProjectId);
            if(!project) return;
            const newTask = {
                id: `task${Date.now()}`, title,
                description: newTaskModal.description.value,
                status: 'todo', 
                assignee: newTaskModal.assignee.value || null,
                priority: newTaskModal.priority.value,
                dueDate: newTaskModal.dueDate.value || null,
                subtasks: []
            };
            await updateDoc(doc(projectsRef, project.id), {
                tasks: [...(project.tasks || []), newTask]
            });
            closeModal(newTaskModal.overlay);
        });

        kanbanBoardEl.addEventListener('click', (e) => {
            if (e.target.closest('.task-card-checkbox')) {
                const checkbox = e.target.closest('.task-card-checkbox');
                const taskId = checkbox.dataset.taskId;
                const { task, project } = findTask(taskId);
                if(task) {
                    const oldStatus = task.status;
                    task.status = checkbox.checked ? 'done' : 'todo';
                    const projectDocRef = findProject(project.id) ? doc(projectsRef, project.id) : doc(completedProjectsRef, project.id);
                    const updatedTasks = project.tasks.map(t => t.id === taskId ? task : t);
                    updateDoc(projectDocRef, { tasks: updatedTasks });
                    if (oldStatus !== 'done' && task.status === 'done') showConfetti();
                }
            } else if (e.target.closest('.task-card')) {
                openTaskModal(e.target.closest('.task-card').dataset.taskId);
            } else if (e.target.closest('.add-task-icon-btn')) {
                openNewTaskModal();
            }
        });

        document.querySelectorAll('.modal-overlay').forEach(overlay => {
            overlay.addEventListener('click', e => {
                if (e.target === overlay || e.target.closest('.modal-close-btn')) {
                    closeModal(overlay);
                }
            });
        });

        taskModal.saveBtn.addEventListener('click', saveTaskFromModal);
        
        document.querySelectorAll('.theme-switcher').forEach(switcher => {
            switcher.addEventListener('click', e => {
                const button = e.target.closest('button');
                if(!button) return;

                if(button.id.includes('light')) {
                    state.ui.theme = 'light';
                } else if (button.id.includes('dark')) {
                    state.ui.theme = 'dark';
                }
                saveUiState();
                applyTheme();
            });
        });

        searchInput.addEventListener('click', () => {
            searchModal.resultsList.innerHTML = '<li class="search-result-item"><p>Zacznij pisać...</p></li>';
            openModal(searchModal.overlay);
            searchModal.input.focus();
        });
        searchModal.input.addEventListener('input', (e) => {
            const term = e.target.value;
            const results = performGlobalSearch(term);
            renderSearchResults(results);
        });
        searchModal.resultsList.addEventListener('click', (e) => {
            const item = e.target.closest('.search-result-item');
            if (item && item.dataset.taskId) {
                state.currentProjectId = item.dataset.projectId;
                state.ui.currentView = 'projects';
                saveUiState();
                render();
                closeModal(searchModal.overlay);
                openTaskModal(item.dataset.taskId);
            }
        });

        menuToggle.addEventListener('click', () => {
            sidebar.classList.toggle('open');
        });

        let draggedTaskId = null;
        kanbanBoardEl.addEventListener('dragstart', (e) => {
            if (findCompletedProject(state.currentProjectId)) return;
            const taskCard = e.target.closest('.task-card');
            if (taskCard) {
                draggedTaskId = taskCard.dataset.taskId;
                setTimeout(() => taskCard.classList.add('dragging'), 0);
            }
        });
        kanbanBoardEl.addEventListener('dragend', (e) => {
            e.target.closest('.task-card')?.classList.remove('dragging');
        });
        kanbanBoardEl.addEventListener('dragover', (e) => e.preventDefault());
        kanbanBoardEl.addEventListener('drop', async (e) => {
            e.preventDefault();
            const column = e.target.closest('.kanban-column');
            if (column && draggedTaskId) {
                const newStatus = column.dataset.status;
                const { task, project } = findTask(draggedTaskId);
                if (task && task.status !== newStatus) {
                    const oldStatus = task.status;
                    task.status = newStatus;
                    const projectDocRef = doc(projectsRef, project.id);
                    const updatedTasks = project.tasks.map(t => t.id === draggedTaskId ? task : t);
                    await updateDoc(projectDocRef, { tasks: updatedTasks });
                    if (oldStatus !== 'done' && newStatus === 'done') showConfetti();
                }
            }
        });
    });
    </script>
</body>
</html>
