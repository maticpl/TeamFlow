<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>TeamFlow</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg-primary:#f4f5f7;--bg-secondary:#fff;--bg-tertiary:#e9eaec;--bg-overlay:rgba(0,0,0,.5);
      --text-primary:#172b4d;--text-secondary:#5e6c84;--text-on-accent:#fff;--border-color:#dfe1e6;
      --accent-primary:#4f46e5;--accent-hover:#4338ca;--danger-primary:#dc2626;--success-primary:#16a34a;
      --priority-high-bg:#fef9c3;--priority-high-border:#fde047;--shadow-sm:0 1px 2px rgba(0,0,0,.05);
      --shadow-md:0 4px 6px -1px rgba(0,0,0,.1),0 2px 4px -2px rgba(0,0,0,.1);
      --shadow-lg:0 10px 15px -3px rgba(0,0,0,.1),0 4px 6px -4px rgba(0,0,0,.1);--radius:10px;
      --font:'Inter',sans-serif
    }
    .dark-mode{
      --bg-primary:#1f2937;--bg-secondary:#374151;--bg-tertiary:#4b5563;--text-primary:#f9fafb;--text-secondary:#d1d5db;--border-color:#4b5563;
      --priority-high-bg:#4f46e5;--priority-high-border:#6d28d9
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:var(--font);background:var(--bg-primary);color:var(--text-primary);line-height:1.5;overflow:hidden}
    .app-container{display:flex;height:100vh}
    .app-container.hidden{display:none}
    /* AUTH */
    #auth-overlay{position:fixed;inset:0;background:var(--bg-primary);display:flex;align-items:center;justify-content:center;z-index:1000}
    .auth-container{background:var(--bg-secondary);padding:32px;border-radius:14px;box-shadow:var(--shadow-lg);width:min(420px,92vw)}
    .auth-form .form-group{margin:10px 0}
    .auth-form label{display:block;margin-bottom:6px;font-weight:600}
    .auth-form input{width:100%;padding:10px;border:1px solid var(--border-color);border-radius:10px;background:var(--bg-primary);color:var(--text-primary)}
    .btn{padding:10px 14px;border-radius:10px;border:none;font-weight:700;cursor:pointer}
    .btn-primary{background:var(--accent-primary);color:#fff}
    .btn-secondary{background:var(--bg-tertiary)}
    .auth-form .btn{width:100%;margin-top:10px}
    .auth-toggle{margin-top:12px;font-size:14px}
    .auth-toggle a{color:var(--accent-primary);cursor:pointer}
    .error-message{min-height:20px;color:var(--danger-primary);font-size:13px;margin-top:8px}
    /* LAYOUT */
    .sidebar{width:270px;background:var(--bg-secondary);border-right:1px solid var(--border-color);padding:20px;display:flex;flex-direction:column}
    .sidebar-header{display:flex;gap:10px;align-items:center;margin-bottom:16px}
    .logo{width:32px;height:32px;border-radius:8px;background:var(--accent-primary);display:grid;place-items:center;color:#fff}
    .search-bar{position:relative;margin-bottom:12px}
    .search-bar input{width:100%;padding:8px 12px 8px 34px;border:1px solid var(--border-color);border-radius:10px;background:var(--bg-primary)}
    .nav-section h2{font-size:12px;color:var(--text-secondary);text-transform:uppercase;margin:8px 0}
    .nav-list{list-style:none;overflow:auto;max-height:calc(100vh - 420px)}
    .nav-item a{display:flex;gap:10px;align-items:center;padding:8px;border-radius:10px;color:inherit;text-decoration:none}
    .nav-item a:hover{background:var(--bg-tertiary)}
    .nav-item a.active{background:var(--accent-primary);color:#fff}
    .new-project-btn{margin-top:12px}
    .sidebar-footer{margin-top:auto;border-top:1px solid var(--border-color);padding-top:12px;font-size:12px;color:var(--text-secondary)}
    .main-content{flex:1;display:flex;flex-direction:column;padding:20px;overflow:hidden}
    .main-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
    .project-title-wrapper{display:flex;gap:12px;align-items:center}
    .project-actions button{background:none;border:1px solid var(--border-color);padding:6px 10px;border-radius:10px;color:var(--text-secondary);cursor:pointer}
    .project-actions .complete{border-color:var(--danger-primary);color:#fff;background:var(--danger-primary)}
    .header-actions{display:flex;gap:8px;align-items:center}
    .header-btn{background:none;border:none;padding:6px;border-radius:50%;cursor:pointer;color:var(--text-secondary)}
    .header-btn:hover{background:var(--bg-tertiary)}
    .header-btn.active{color:var(--accent-primary)}
    /* KANBAN */
    .kanban-board{display:grid;grid-template-columns:repeat(3,1fr);gap:16px;height:100%;overflow:auto}
    .kanban-column{background:var(--bg-tertiary);border-radius:12px;padding:12px;display:flex;flex-direction:column}
    .kanban-column-header{display:flex;gap:8px;align-items:center;margin-bottom:8px}
    .task-count{margin-left:auto;font-size:12px;background:var(--border-color);padding:2px 8px;border-radius:999px}
    .kanban-tasks{list-style:none;overflow:auto}
    .task-card{background:var(--bg-secondary);border-left:4px solid transparent;border-radius:12px;padding:12px 12px 12px 38px;margin-bottom:10px;box-shadow:var(--shadow-sm);position:relative;cursor:pointer}
    .task-card.priority-high{background:var(--priority-high-bg);border-left-color:var(--priority-high-border)}
    .task-card .task-card-checkbox{position:absolute;left:10px;top:12px;width:18px;height:18px}
    .task-card.completed h4{text-decoration:line-through;color:var(--text-secondary)}
    /* MODALS */
    .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:1100}
    .modal-overlay.visible{display:flex}
    .modal{background:var(--bg-secondary);border-radius:14px;box-shadow:var(--shadow-lg);width:min(860px,94vw);max-height:90vh;display:flex;flex-direction:column}
    .modal-header,.modal-footer{padding:14px 16px;border-bottom:1px solid var(--border-color);display:flex;justify-content:space-between;align-items:center}
    .modal-footer{border-bottom:none;border-top:1px solid var(--border-color)}
    .task-modal-content{display:flex;gap:0;overflow:hidden}
    .task-modal-main{flex:1;padding:16px;overflow:auto;border-right:1px solid var(--border-color)}
    .task-modal-sidebar{width:260px;padding:16px;background:var(--bg-primary)}
    .form-modal-content{padding:16px;overflow:auto}
    .form-group{margin-bottom:14px}
    .form-group input,.form-group select,.form-group textarea{width:100%;padding:10px;border:1px solid var(--border-color);border-radius:10px;background:var(--bg-primary)}
    .members-selection{display:flex;flex-direction:column;gap:8px;background:var(--bg-primary);padding:10px;border-radius:10px;max-height:150px;overflow:auto}
    .avatar{width:28px;height:28px;border-radius:50%;background:#999;color:#fff;display:flex;align-items:center;justify-content:center;font-weight:700;border:2px solid var(--bg-secondary)}
    #loading-overlay{position:fixed;inset:0;background:rgba(255,255,255,.8);display:none;align-items:center;justify-content:center;z-index:1200}
    .dark-mode #loading-overlay{background:rgba(0,0,0,.8);color:#fff}
    @media(max-width:768px){
      .app-container{flex-direction:column}
      .kanban-board{display:block}
      .kanban-column{margin-bottom:16px}
    }
  </style>
</head>
<body>
<div id="loading-overlay"><p>Ładowanie…</p></div>

<!-- AUTH -->
<div id="auth-overlay">
  <div class="auth-container">
    <form id="login-form" class="auth-form">
      <h2>Zaloguj się</h2>
      <div class="form-group"><label for="login-email">Email</label><input id="login-email" type="email" required></div>
      <div class="form-group"><label for="login-password">Hasło</label><input id="login-password" type="password" required></div>
      <button class="btn btn-primary" type="submit">Zaloguj się</button>
      <p id="auth-error-login" class="error-message"></p>
      <p class="auth-toggle">Nie masz konta? <a id="show-register">Zarejestruj się</a></p>
    </form>
    <form id="register-form" class="auth-form" style="display:none">
      <h2>Stwórz konto</h2>
      <div class="form-group"><label for="register-name">Nazwa użytkownika</label><input id="register-name" required></div>
      <div class="form-group"><label for="register-email">Email</label><input id="register-email" type="email" required></div>
      <div class="form-group"><label for="register-password">Hasło (min. 6 znaków)</label><input id="register-password" type="password" minlength="6" required></div>
      <button class="btn btn-primary" type="submit">Zarejestruj się</button>
      <p id="auth-error-register" class="error-message"></p>
      <p class="auth-toggle">Masz już konto? <a id="show-login">Zaloguj się</a></p>
    </form>
  </div>
</div>

<!-- APP -->
<div class="app-container hidden">
  <aside class="sidebar">
    <div class="sidebar-header">
      <div class="logo"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg></div>
      <h1>TeamFlow</h1>
    </div>

    <div class="search-bar">
      <svg style="position:absolute;left:10px;top:50%;transform:translateY(-50%);" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
      <input id="search-input" placeholder="Szukaj..." readonly>
    </div>

    <nav class="nav-section">
      <ul class="nav-list" id="projects-list"></ul>
    </nav>

    <nav class="nav-section" id="completed-projects-section" style="display:none">
      <h2>Zakończone projekty</h2>
      <ul class="nav-list" id="completed-projects-list"></ul>
    </nav>

    <button id="new-project-btn" class="btn btn-primary new-project-btn">+ Nowy projekt</button>

    <div class="sidebar-footer">
      <div>Zalogowano jako:<br><span id="user-email-display"></span></div>
      <button id="logout-btn" class="btn btn-secondary" style="width:100%;margin-top:10px">Wyloguj</button>
    </div>
  </aside>

  <main class="main-content">
    <header class="main-header">
      <div class="project-title-wrapper">
        <div>
          <h2 id="project-name-header">Wybierz projekt</h2>
          <div id="project-members-header" class="project-members"></div>
        </div>
        <div class="project-actions" id="project-actions" style="display:none">
          <button id="edit-project-btn">Edytuj projekt</button>
          <button id="complete-project-btn" class="complete">Zakończ projekt</button>
        </div>
      </div>
      <div class="header-actions">
        <button id="notification-toggle-btn" class="header-btn" title="Powiadomienia">
          <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M14.86 17.08a23.85 23.85 0 005.45-1.31A8.97 8.97 0 0118 9.75V9a6 6 0 00-12 0v.75a8.97 8.97 0 01-2.31 6.02c1.73.64 3.56 1.08 5.46 1.31m5.71 0a24.26 24.26 0 01-5.71 0m5.71 0a3 3 0 11-5.71 0"/></svg>
        </button>
        <div class="theme-switcher">
          <button id="theme-light" class="header-btn" title="Jasny">☀️</button>
          <button id="theme-dark" class="header-btn" title="Ciemny">🌙</button>
        </div>
      </div>
    </header>

    <section class="kanban-board" id="kanban-board"></section>
    <div style="margin-top:10px">
      <button id="add-task-fab" class="btn btn-primary">+ Dodaj zadanie</button>
    </div>
  </main>
</div>

<!-- MODAL: NOWY PROJEKT -->
<div class="modal-overlay" id="new-project-modal">
  <div class="modal">
    <form id="new-project-form">
      <div class="modal-header"><h2>Nowy projekt</h2><button type="button" class="header-btn modal-close">✖</button></div>
      <div class="form-modal-content">
        <div class="form-group"><label for="new-project-name">Nazwa</label><input id="new-project-name" required></div>
        <div class="form-group">
          <label>Członkowie zespołu</label>
          <div id="new-project-members" class="members-selection"></div>
        </div>
        <div class="form-group">
          <label for="new-project-tasks">Zadania startowe (każde w nowej linii)</label>
          <textarea id="new-project-tasks" rows="4" placeholder="- Przygotować brief&#10;- Ustalić kickoff"></textarea>
        </div>
      </div>
      <div class="modal-footer"><button type="button" class="btn btn-secondary modal-close">Anuluj</button><button class="btn btn-primary" type="submit">Utwórz</button></div>
    </form>
  </div>
</div>

<!-- MODAL: EDYCJA PROJEKTU -->
<div class="modal-overlay" id="edit-project-modal">
  <div class="modal">
    <form id="edit-project-form">
      <div class="modal-header"><h2>Edytuj projekt</h2><button type="button" class="header-btn modal-close">✖</button></div>
      <div class="form-modal-content">
        <div class="form-group"><label for="edit-project-name">Nazwa</label><input id="edit-project-name" required></div>
        <div class="form-group">
          <label>Członkowie zespołu</label>
          <div id="edit-project-members" class="members-selection"></div>
        </div>
      </div>
      <div class="modal-footer"><button type="button" class="btn btn-secondary modal-close">Anuluj</button><button class="btn btn-primary" type="submit">Zapisz</button></div>
    </form>
  </div>
</div>

<!-- MODAL: NOWE ZADANIE -->
<div class="modal-overlay" id="new-task-modal">
  <div class="modal">
    <form id="new-task-form">
      <div class="modal-header"><h2>Dodaj zadanie</h2><button type="button" class="header-btn modal-close">✖</button></div>
      <div class="form-modal-content">
        <div class="form-group" id="new-task-project-group">
          <label for="new-task-project">Projekt</label>
          <select id="new-task-project"></select>
        </div>
        <div class="form-group"><label for="new-task-title">Tytuł</label><input id="new-task-title" required></div>
        <div class="form-group">
          <label>Typ zadania</label>
          <div style="display:flex;gap:10px">
            <label><input type="radio" name="task-type" value="single" checked> Jednoosobowe</label>
            <label><input type="radio" name="task-type" value="multi"> Wieloosobowe</label>
          </div>
        </div>
        <div class="form-group" id="new-task-assignee-single-wrapper">
          <label for="new-task-assignee-select">Przypisz do</label>
          <select id="new-task-assignee-select"></select>
        </div>
        <div class="form-group" id="new-task-assignee-multi-wrapper" style="display:none">
          <label>Wybierz osoby</label>
          <div id="new-task-assignee-multi-list" class="members-selection"></div>
        </div>
        <div class="form-group"><label for="new-task-description">Opis</label><textarea id="new-task-description" rows="3"></textarea></div>
        <div style="display:flex;gap:16px">
          <div class="form-group" style="flex:1"><label for="new-task-dueDate">Termin</label><input type="datetime-local" id="new-task-dueDate"></div>
          <div class="form-group" style="flex:1"><label for="new-task-priority">Priorytet</label>
            <select id="new-task-priority"><option value="low">Niski</option><option value="medium" selected>Średni</option><option value="high">Wysoki</option></select>
          </div>
        </div>
      </div>
      <div class="modal-footer"><button type="button" class="btn btn-secondary modal-close">Anuluj</button><button class="btn btn-primary" type="submit">Zapisz</button></div>
    </form>
  </div>
</div>

<!-- MODAL: PODGLĄD/EDYCJA ZADANIA -->
<div class="modal-overlay" id="task-modal">
  <div class="modal">
    <div class="modal-header"><h2>Szczegóły zadania</h2><button type="button" class="header-btn modal-close">✖</button></div>
    <div class="task-modal-content">
      <div class="task-modal-main">
        <div style="display:flex;align-items:flex-start;gap:10px;margin-bottom:10px">
          <input type="checkbox" id="modal-task-completed">
          <h3 id="modal-task-title" style="font-size:22px"></h3>
        </div>
        <div class="form-group"><label for="modal-task-description">Opis</label><textarea id="modal-task-description" rows="6"></textarea></div>
        <div id="modal-completion-status-section" style="display:none">
          <h4 style="font-size:14px;color:var(--text-secondary);margin-bottom:6px">Status ukończenia (zadanie wieloosobowe)</h4>
          <ul id="modal-completion-status-list" style="list-style:none;display:flex;flex-direction:column;gap:6px"></ul>
        </div>
      </div>
      <div class="task-modal-sidebar">
        <div class="form-group"><label for="modal-task-status">Status</label>
          <select id="modal-task-status">
            <option value="todo">Do realizacji</option>
            <option value="inprogress">W trakcie realizacji</option>
            <option value="done">Wykonane</option>
          </select>
        </div>
        <div class="form-group"><label for="modal-task-priority">Priorytet</label>
          <select id="modal-task-priority"><option value="low">Niski</option><option value="medium">Średni</option><option value="high">Wysoki</option></select>
        </div>
        <div class="form-group"><label for="modal-task-dueDate">Termin</label><input type="datetime-local" id="modal-task-dueDate"></div>
        <div class="form-group"><label>Przypisani</label><div id="modal-task-assignees-list" class="members-selection"></div></div>
        <button id="save-task-btn" class="btn btn-primary" type="button">Zapisz zmiany</button>
      </div>
    </div>
  </div>
</div>

<!-- MODAL: POWIADOMIENIE -->
<div class="modal-overlay" id="notification-modal">
  <div class="modal" style="max-width:420px">
    <div class="modal-header"><h2 id="notification-title">Powiadomienie</h2><button type="button" class="header-btn modal-close">✖</button></div>
    <div class="form-modal-content"><p id="notification-message"></p></div>
    <div class="modal-footer"><button type="button" class="btn btn-primary modal-close">OK</button></div>
  </div>
</div>

<script type="module">
/** 1) Importy Firebase */
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, collection, doc, getDoc, setDoc, addDoc, updateDoc, deleteDoc, onSnapshot, query, where, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
import { getMessaging, getToken, onMessage } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-messaging.js";

/** 2) KONFIG — ZOSTAWIAM tak jak chcesz („cofingAPI”) */
const firebaseConfig = {
  apiKey: "__API_KEY__",
  authDomain: "__AUTH_DOMAIN__",
  projectId: "__PROJECT_ID__",
  storageBucket: "__STORAGE_BUCKET__",
  messagingSenderId: "__MESSAGING_SENDER_ID__",
  appId: "__APP_ID__"
};

/** 3) Inicjalizacja */
const app = initializeApp(firebaseConfig);
const db  = getFirestore(app);
const auth = getAuth(app);
// Jeśli masz publiczny VAPID KEY, możesz dodać: const VAPID_KEY = "__VAPID_KEY__";

/** 4) Ścieżki Firestore — ważne by widzieć stare dane */
const appId = "default-app-id"; // zmień jeśli wcześniej użyłeś innego
const projectsRef = collection(db, `artifacts/${appId}/public/data/projects`);
const completedProjectsRef = collection(db, `artifacts/${appId}/public/data/completedProjects`);
const usersRef = collection(db, `artifacts/${appId}/public/data/users`);

/** 5) Stan i referencje DOM */
const state = {
  currentUser: null,
  users: [],
  projects: [],
  completedProjects: [],
  currentProjectId: null,
  ui: { theme: localStorage.getItem("tf_theme") || "light" },
  unsub: { projects:null, completed:null, users:null }
};

const loadingOverlay = document.getElementById("loading-overlay");
const authOverlay = document.getElementById("auth-overlay");
const appContainer = document.querySelector(".app-container");
const userEmailDisplay = document.getElementById("user-email-display");

const projectsListEl = document.getElementById("projects-list");
const completedSection = document.getElementById("completed-projects-section");
const completedListEl = document.getElementById("completed-projects-list");
const projectNameHeaderEl = document.getElementById("project-name-header");
const projectMembersHeaderEl = document.getElementById("project-members-header");
const projectActionsEl = document.getElementById("project-actions");
const editProjectBtn = document.getElementById("edit-project-btn");
const completeProjectBtn = document.getElementById("complete-project-btn");
const kanbanBoardEl = document.getElementById("kanban-board");
const addTaskFab = document.getElementById("add-task-fab");

const loginForm = document.getElementById("login-form");
const registerForm = document.getElementById("register-form");
const showRegisterBtn = document.getElementById("show-register");
const showLoginBtn = document.getElementById("show-login");
const authErrorLogin = document.getElementById("auth-error-login");
const authErrorRegister = document.getElementById("auth-error-register");
const logoutBtn = document.getElementById("logout-btn");

const newProjectModal = document.getElementById("new-project-modal");
const newProjectForm = document.getElementById("new-project-form");
const newProjectName = document.getElementById("new-project-name");
const newProjectMembersBox = document.getElementById("new-project-members");
const newProjectTasks = document.getElementById("new-project-tasks");
const newProjectBtn = document.getElementById("new-project-btn");

const editProjectModal = document.getElementById("edit-project-modal");
const editProjectForm = document.getElementById("edit-project-form");
const editProjectName = document.getElementById("edit-project-name");
const editProjectMembersBox = document.getElementById("edit-project-members");

const newTaskModal = document.getElementById("new-task-modal");
const newTaskForm = document.getElementById("new-task-form");
const newTaskProjectGroup = document.getElementById("new-task-project-group");
const newTaskProject = document.getElementById("new-task-project");
const newTaskTitle = document.getElementById("new-task-title");
const newTaskAssigneeSelect = document.getElementById("new-task-assignee-select");
const newTaskAssigneeSingleWrapper = document.getElementById("new-task-assignee-single-wrapper");
const newTaskAssigneeMultiWrapper = document.getElementById("new-task-assignee-multi-wrapper");
const newTaskAssigneeMultiList = document.getElementById("new-task-assignee-multi-list");
const newTaskDescription = document.getElementById("new-task-description");
const newTaskDueDate = document.getElementById("new-task-dueDate");
const newTaskPriority = document.getElementById("new-task-priority");

const taskModal = document.getElementById("task-modal");
const modalTaskTitle = document.getElementById("modal-task-title");
const modalTaskCompleted = document.getElementById("modal-task-completed");
const modalTaskDescription = document.getElementById("modal-task-description");
const modalTaskStatus = document.getElementById("modal-task-status");
const modalTaskPriority = document.getElementById("modal-task-priority");
const modalTaskDueDate = document.getElementById("modal-task-dueDate");
const modalTaskAssigneesList = document.getElementById("modal-task-assignees-list");
const modalCompletionSection = document.getElementById("modal-completion-status-section");
const modalCompletionList = document.getElementById("modal-completion-status-list");
const saveTaskBtn = document.getElementById("save-task-btn");

const notificationToggleBtn = document.getElementById("notification-toggle-btn");
const notificationModal = document.getElementById("notification-modal");
const notificationTitle = document.getElementById("notification-title");
const notificationMessage = document.getElementById("notification-message");

/** 6) Pomocnicze */
const STATUSES = { todo:"Do realizacji", inprogress:"W trakcie realizacji", done:"Wykonane" };

function openModal(el){ el.classList.add("visible"); }
function closeModal(el){ el.classList.remove("visible"); }
document.querySelectorAll(".modal .modal-close").forEach(b => b.addEventListener("click", e => closeModal(e.target.closest(".modal-overlay"))));
document.querySelectorAll(".modal .btn.modal-close").forEach(b => b.addEventListener("click", e => closeModal(e.target.closest(".modal-overlay"))));

function initialsFrom(user){
  return (user?.name || user?.email || "?").split(" ").map(s=>s[0]).join("").slice(0,2).toUpperCase();
}
function findUser(uid){ return state.users.find(u => u.id === uid); }
function findProject(id){ return state.projects.find(p => p.id === id); }
function findCompletedProject(id){ return state.completedProjects.find(p => p.id === id); }
function migrateTask(task){
  const t = {...task};
  if(!t.type){ t.type = 'single'; }
  if(!t.assignees){ t.assignees = t.assignee ? [t.assignee] : []; }
  if(!t.completedBy){ t.completedBy = (t.status==='done' && t.assignees) ? [...t.assignees] : []; }
  if(!t.priority){ t.priority = 'medium'; }
  return t;
}

/** 7) Motyw */
function applyTheme(){
  document.body.classList.toggle("dark-mode", state.ui.theme === "dark");
  document.getElementById("theme-light").classList.toggle("active", state.ui.theme==="light");
  document.getElementById("theme-dark").classList.toggle("active", state.ui.theme==="dark");
}
applyTheme();
document.getElementById("theme-light").onclick = ()=>{ state.ui.theme="light"; localStorage.setItem("tf_theme","light"); applyTheme(); };
document.getElementById("theme-dark").onclick  = ()=>{ state.ui.theme="dark";  localStorage.setItem("tf_theme","dark");  applyTheme(); };

/** 8) AUTH */
showRegisterBtn.onclick = ()=>{ loginForm.style.display="none"; registerForm.style.display="block"; };
showLoginBtn.onclick = ()=>{ registerForm.style.display="none"; loginForm.style.display="block"; };

registerForm.addEventListener("submit", async (e)=>{
  e.preventDefault();
  authErrorRegister.textContent="";
  const name = document.getElementById("register-name").value.trim();
  const email = document.getElementById("register-email").value.trim();
  const password = document.getElementById("register-password").value;
  if(!name){ authErrorRegister.textContent="Nazwa użytkownika jest wymagana."; return; }
  const btn = registerForm.querySelector("button[type='submit']");
  btn.disabled=true; btn.textContent="Rejestrowanie…";
  try{
    const cred = await createUserWithEmailAndPassword(auth,email,password);
    await setDoc(doc(usersRef, cred.user.uid), {
      uid: cred.user.uid, email: cred.user.email, name,
      avatarColor: '#'+Math.floor(Math.random()*16777215).toString(16).padStart(6,'0')
    });
  }catch(err){ console.error(err); authErrorRegister.textContent = err.message; }
  finally{ btn.disabled=false; btn.textContent="Zarejestruj się"; }
});

loginForm.addEventListener("submit", async (e)=>{
  e.preventDefault();
  authErrorLogin.textContent="";
  const email = document.getElementById("login-email").value.trim();
  const password = document.getElementById("login-password").value;
  const btn = loginForm.querySelector("button[type='submit']");
  btn.disabled=true; btn.textContent="Logowanie…";
  try{ await signInWithEmailAndPassword(auth,email,password); }
  catch(err){ console.error(err); authErrorLogin.textContent="Nieprawidłowy email lub hasło."; }
  finally{ btn.disabled=false; btn.textContent="Zaloguj się"; }
});

logoutBtn.onclick = ()=>signOut(auth);

/** 9) Dzwonek powiadomień */
function updateNotificationBellUI(){
  if(Notification.permission === "granted"){ notificationToggleBtn.classList.add("active"); notificationToggleBtn.title="Powiadomienia włączone"; }
  else { notificationToggleBtn.classList.remove("active"); notificationToggleBtn.title="Kliknij, aby włączyć powiadomienia"; }
}
updateNotificationBellUI();

async function requestNotificationPermission(){
  if(!("Notification" in window)){ showNotify("Twoja przeglądarka nie wspiera powiadomień."); return; }
  const p = await Notification.requestPermission();
  updateNotificationBellUI();
  if(p!=="granted") return;
  try{
    const messaging = getMessaging(app);
    // Jeśli masz VAPID: const token = await getToken(messaging,{ vapidKey: VAPID_KEY });
    const token = await getToken(messaging);
    if(token && state.currentUser){
      const userRef = doc(usersRef, state.currentUser.uid);
      const docSnap = await getDoc(userRef);
      const tokens = docSnap.exists() ? (docSnap.data().fcmTokens||[]) : [];
      if(!tokens.includes(token)){ await updateDoc(userRef, { fcmTokens:[...tokens, token] }); }
    }
    onMessage(messaging, (payload)=>{
      showNotify("Nowa wiadomość: "+(payload?.notification?.title || "Bez tytułu"));
    });
  }catch(e){ console.warn("FCM token error (to normalne lokalnie):", e); }
}
notificationToggleBtn.onclick = requestNotificationPermission;

function showNotify(msg,title="Powiadomienie"){
  notificationTitle.textContent = title;
  notificationMessage.textContent = msg;
  openModal(notificationModal);
}

/** 10) Render sidebar i projekty */
function renderSidebar(){
  // projekty aktywne
  projectsListEl.innerHTML="";
  state.projects.forEach(p=>{
    const li = document.createElement("li");
    li.className="nav-item";
    li.innerHTML = `<a href="#" data-id="${p.id}" class="${p.id===state.currentProjectId?'active':''}">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
      <span>${p.name}</span></a>`;
    li.querySelector("a").onclick = (e)=>{ e.preventDefault(); state.currentProjectId=p.id; renderCurrentProject(); };
    projectsListEl.appendChild(li);
  });
  // zakończone
  if(state.completedProjects.length>0){
    completedSection.style.display="block";
    completedListEl.innerHTML="";
    state.completedProjects.forEach(p=>{
      const li=document.createElement("li");
      li.className="nav-item";
      li.innerHTML=`<a href="#" data-id="${p.id}" class="${p.id===state.currentProjectId?'active':''}"><span>🏁 ${p.name}</span></a>`;
      li.querySelector("a").onclick=(e)=>{ e.preventDefault(); state.currentProjectId=p.id; renderCurrentProject(true); };
      completedListEl.appendChild(li);
    });
  }else completedSection.style.display="none";
}

/** 11) Render projektu i kanbana */
function renderCurrentProject(isCompleted=false){
  const project = isCompleted ? findCompletedProject(state.currentProjectId) : findProject(state.currentProjectId);
  const owner = project?.ownerId;
  const editable = !!project && !isCompleted && owner === state.currentUser?.uid;

  projectActionsEl.style.display = editable ? "flex" : "none";
  projectNameHeaderEl.textContent = project ? project.name : "Wybierz projekt";
  projectMembersHeaderEl.innerHTML="";
  (project?.members||[]).forEach(uid=>{
    const u=findUser(uid); if(!u) return;
    const div=document.createElement("div"); div.className="avatar"; div.style.background=u.avatarColor||"#999"; div.title=u.name||u.email; div.textContent=initialsFrom(u);
    projectMembersHeaderEl.appendChild(div);
  });

  renderKanbanBoard(project ? (project.tasks||[]).map(migrateTask) : [], editable);
}

function renderKanbanBoard(tasks, interactive){
  kanbanBoardEl.innerHTML="";
  Object.keys(STATUSES).forEach(statusKey=>{
    const col=document.createElement("div"); col.className="kanban-column"; col.dataset.status=statusKey;
    const inCol=(tasks||[]).filter(t=>t.status===statusKey);
    const header=document.createElement("div"); header.className="kanban-column-header";
    header.innerHTML=`<h3>${STATUSES[statusKey]}</h3><span class="task-count">${inCol.length}</span>`;
    if(interactive && statusKey==="todo"){
      const addBtn=document.createElement("button"); addBtn.className="btn btn-secondary"; addBtn.textContent="+";
      addBtn.title="Dodaj zadanie"; addBtn.onclick=()=>openNewTaskModal();
      header.appendChild(addBtn);
    }
    const list=document.createElement("ul"); list.className="kanban-tasks";
    inCol.forEach(task=> list.appendChild(taskCard(task,interactive)));
    col.appendChild(header); col.appendChild(list);
    if(interactive){
      // dragover
      col.addEventListener("dragover", e=>{ e.preventDefault(); });
      col.addEventListener("drop", async (e)=>{
        const taskId = e.dataTransfer.getData("text/plain");
        await moveTaskToStatus(taskId, statusKey);
      });
    }
    kanbanBoardEl.appendChild(col);
  });
}

function taskCard(task, interactive){
  const li=document.createElement("li");
  const isDone = task.status==="done";
  li.className = "task-card"+(task.priority==="high"?" priority-high":"")+(isDone?" completed":"");
  li.dataset.taskId = task.id;
  if(interactive){ li.setAttribute("draggable","true"); li.ondragstart=(e)=>{ e.dataTransfer.setData("text/plain", task.id); }; }
  li.innerHTML = `
    <input type="checkbox" class="task-card-checkbox" ${isDone?"checked":""} ${interactive?"":"disabled"}>
    <h4>${task.title}</h4>
    <div class="task-meta" style="display:flex;justify-content:space-between;align-items:center">
      <div class="task-details" style="display:flex;gap:10px;color:var(--text-secondary);font-size:12px">
        ${task.dueDate?`<span>📅 ${new Date(task.dueDate).toLocaleString('pl-PL')}</span>`:""}
        ${task.type==="multi"?"👥":""}
      </div>
      <div class="task-assignees" style="display:flex;gap:4px">
        ${(task.assignees||[]).map(uid=>{ const u=findUser(uid); return u?`<div class="avatar" style="width:24px;height:24px;border-color:var(--bg-tertiary);background:${u.avatarColor||"#999"}" title="${u.name||u.email}">${initialsFrom(u)}</div>`:""; }).join("")}
      </div>
    </div>`;
  li.querySelector(".task-card-checkbox").onchange = async (e)=>{
    const newStatus = e.target.checked?"done":"todo";
    await moveTaskToStatus(task.id, newStatus, true);
  };
  li.onclick = (e)=>{ if(e.target.classList.contains("task-card-checkbox")) return; openTaskModal(task.id); };
  return li;
}

/** 12) CRUD: projekty */
newProjectBtn.onclick = async ()=>{
  // lista wszystkich userów do wyboru
  renderMembersChecklist(newProjectMembersBox, state.users.map(u=>u.id));
  newProjectName.value = "";
  newProjectTasks.value = "";
  openModal(newProjectModal);
};
newProjectForm.onsubmit = async (e)=>{
  e.preventDefault();
  const name = newProjectName.value.trim();
  const memberIds = Array.from(newProjectMembersBox.querySelectorAll("input[type=checkbox]:checked")).map(c=>c.value);
  const lines = newProjectTasks.value.split("\n").map(s=>s.trim()).filter(Boolean);
  const tasks = lines.map(line=>({ id: crypto.randomUUID(), title: line, description:"", status:"todo", type:"single", assignees:[], completedBy:[], priority:"medium", createdAt:Date.now() }));
  const docRef = await addDoc(projectsRef, { name, ownerId: state.currentUser.uid, members: memberIds, tasks });
  state.currentProjectId = docRef.id;
  closeModal(newProjectModal);
};
editProjectBtn.onclick = ()=>{
  const p=findProject(state.currentProjectId); if(!p) return;
  editProjectName.value = p.name;
  renderMembersChecklist(editProjectMembersBox, p.members||[]);
  openModal(editProjectModal);
};
editProjectForm.onsubmit = async (e)=>{
  e.preventDefault();
  const p=findProject(state.currentProjectId); if(!p) return;
  const memberIds = Array.from(editProjectMembersBox.querySelectorAll("input[type=checkbox]:checked")).map(c=>c.value);
  await updateDoc(doc(projectsRef, p.id), { name: editProjectName.value.trim(), members: memberIds });
  closeModal(editProjectModal);
};
completeProjectBtn.onclick = async ()=>{
  const p=findProject(state.currentProjectId); if(!p) return;
  const batch = writeBatch(db);
  const src = doc(projectsRef, p.id);
  const target = doc(completedProjectsRef, p.id);
  batch.set(target, p); batch.delete(src);
  await batch.commit();
  state.currentProjectId = p.id; // pozostaniemy na projekcie (teraz zakończonym)
};

/** 13) CRUD: zadania */
addTaskFab.onclick = openNewTaskModal;
function openNewTaskModal(){
  // jeżeli nie wybrano projektu – pokaż select z wszystkimi
  const hasProject = !!state.currentProjectId;
  newTaskProjectGroup.style.display = hasProject ? "none" : "block";
  newTaskProject.innerHTML = state.projects.map(p=>`<option value="${p.id}">${p.name}</option>`).join("");
  newTaskTitle.value = "";
  newTaskDescription.value = "";
  newTaskDueDate.value = "";
  newTaskPriority.value = "medium";
  // typ zadania
  document.querySelector("input[name='task-type'][value='single']").checked = true;
  newTaskAssigneeSingleWrapper.style.display="block";
  newTaskAssigneeMultiWrapper.style.display="none";
  // członkowie dla aktualnego lub wskazanego projektu
  const projectId = hasProject ? state.currentProjectId : (state.projects[0]?.id || null);
  populateAssigneesControls(projectId);
  openModal(newTaskModal);
}
function populateAssigneesControls(projectId){
  const p = findProject(projectId);
  const members = (p?.members||[]).map(uid=>findUser(uid)).filter(Boolean);
  newTaskAssigneeSelect.innerHTML = members.map(u=>`<option value="${u.id}">${u.name||u.email}</option>`).join("");
  renderMembersChecklist(newTaskAssigneeMultiList, members.map(u=>u.id));
}
document.getElementById("new-task-project").onchange = (e)=> populateAssigneesControls(e.target.value);
document.querySelectorAll("input[name='task-type']").forEach(r=>{
  r.onchange = ()=>{
    const isSingle = document.querySelector("input[name='task-type']:checked").value==="single";
    newTaskAssigneeSingleWrapper.style.display = isSingle ? "block":"none";
    newTaskAssigneeMultiWrapper.style.display = isSingle ? "none":"block";
  };
});
newTaskForm.onsubmit = async (e)=>{
  e.preventDefault();
  const isSingle = document.querySelector("input[name='task-type']:checked").value==="single";
  const projectId = state.currentProjectId || newTaskProject.value;
  const p = findProject(projectId); if(!p){ closeModal(newTaskModal); return; }
  const assignees = isSingle ? [newTaskAssigneeSelect.value] : Array.from(newTaskAssigneeMultiList.querySelectorAll("input[type=checkbox]:checked")).map(c=>c.value);
  const newTask = {
    id: crypto.randomUUID(),
    title: newTaskTitle.value.trim(),
    description: newTaskDescription.value.trim(),
    status: "todo",
    type: isSingle ? "single":"multi",
    assignees,
    completedBy: [],
    priority: newTaskPriority.value,
    dueDate: newTaskDueDate.value || null,
    createdAt: Date.now()
  };
  await updateDoc(doc(projectsRef, p.id), { tasks: [...(p.tasks||[]), newTask] });
  state.currentProjectId = p.id;
  closeModal(newTaskModal);
};
async function moveTaskToStatus(taskId, statusKey, fromCheckbox=false){
  // nie pozwalamy oznaczyć multi jako done, dopóki nie ukończą wszyscy
  const { task, project, isCompletedProject } = locateTask(taskId);
  if(!task || !project) return;
  if(task.type==="multi" && statusKey==="done" && (task.completedBy||[]).length < (task.assignees||[]).length){
    showNotify("Nie można oznaczyć jako 'Wykonane', dopóki wszyscy przypisani nie ukończą swojej części.","Błąd");
    renderCurrentProject(isCompletedProject); // odśwież
    return;
  }
