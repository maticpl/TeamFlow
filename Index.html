<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>TeamFlow ‚Äî naprawiona wersja</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg-primary:#f4f5f7;--bg-secondary:#fff;--bg-tertiary:#e9eaec;--bg-overlay:rgba(0,0,0,.5);
      --text-primary:#172b4d;--text-secondary:#5e6c84;--text-on-accent:#fff;--border-color:#dfe1e6;
      --accent-primary:#4f46e5;--accent-hover:#4338ca;--danger-primary:#dc2626;--success-primary:#16a34a;
      --shadow-sm:0 1px 2px rgba(0,0,0,.05);--shadow-md:0 4px 6px -1px rgba(0,0,0,.1),0 2px 4px -2px rgba(0,0,0,.1);
      --shadow-lg:0 10px 15px -3px rgba(0,0,0,.1),0 4px 6px -4px rgba(0,0,0,.1);--border-radius:8px;
      --font-family:'Inter',sans-serif
    }
    .dark-mode{
      --bg-primary:#1f2937;--bg-secondary:#374151;--bg-tertiary:#4b5563;--text-primary:#f9fafb;--text-secondary:#d1d5db;--border-color:#4b5563
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:var(--font-family);background:var(--bg-primary);color:var(--text-primary);line-height:1.5;overflow:hidden}
    .app-container{display:flex;height:100vh}
    .app-container.hidden{display:none}
    /* Auth */
    #auth-overlay{position:fixed;inset:0;background:var(--bg-primary);display:flex;align-items:center;justify-content:center;z-index:1001}
    .auth-container{background:var(--bg-secondary);padding:32px;border-radius:12px;box-shadow:var(--shadow-lg);width:90%;max-width:420px}
    .auth-container h2{margin-bottom:16px}
    .auth-form .form-group{margin:12px 0}
    .auth-form label{display:block;margin-bottom:6px;font-weight:600}
    .auth-form input{width:100%;padding:10px;border-radius:8px;border:1px solid var(--border-color);background:var(--bg-primary);color:var(--text-primary)}
    .btn{padding:10px 14px;border-radius:10px;border:none;font-weight:700;cursor:pointer}
    .btn-primary{background:var(--accent-primary);color:#fff}
    .btn-secondary{background:var(--bg-tertiary)}
    .auth-form .btn{width:100%;margin-top:8px}
    .auth-toggle{margin-top:12px;font-size:14px}
    .auth-toggle a{color:var(--accent-primary);cursor:pointer}
    .error-message{min-height:20px;color:var(--danger-primary);font-size:13px;margin-top:8px}
    /* Sidebar / Main */
    .sidebar{width:260px;background:var(--bg-secondary);border-right:1px solid var(--border-color);padding:20px;display:flex;flex-direction:column}
    .sidebar-header{display:flex;gap:8px;align-items:center;margin-bottom:20px}
    .sidebar .logo{width:32px;height:32px;border-radius:8px;background:var(--accent-primary);display:grid;place-items:center;color:#fff}
    .nav-list{list-style:none;overflow:auto;max-height:calc(100vh - 400px)}
    .nav-item a{display:flex;gap:10px;align-items:center;padding:8px;border-radius:8px;color:inherit;text-decoration:none}
    .nav-item a:hover{background:var(--bg-tertiary)}
    .nav-item a.active{background:var(--accent-primary);color:#fff}
    .new-project-btn{margin-top:16px}
    .sidebar-footer{margin-top:auto;border-top:1px solid var(--border-color);padding-top:12px;font-size:12px;color:var(--text-secondary)}
    .main-content{flex:1;display:flex;flex-direction:column;padding:20px;overflow:hidden}
    .main-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
    .header-actions{display:flex;gap:10px;align-items:center}
    .header-btn{background:none;border:none;padding:6px;border-radius:50%;cursor:pointer;color:var(--text-secondary)}
    .header-btn:hover{background:var(--bg-tertiary)}
    .header-btn.active{color:var(--accent-primary)}
    .kanban-board{display:grid;grid-template-columns:repeat(3,1fr);gap:16px;overflow:auto}
    .kanban-column{background:var(--bg-tertiary);border-radius:10px;padding:12px;display:flex;flex-direction:column}
    .kanban-column-header{display:flex;gap:8px;align-items:center;margin-bottom:8px}
    .task-count{font-size:12px;background:var(--border-color);padding:2px 8px;border-radius:999px}
    .kanban-tasks{list-style:none;overflow:auto}
    .task-card{background:var(--bg-secondary);border-radius:10px;box-shadow:var(--shadow-sm);padding:12px;margin-bottom:10px;position:relative}
    .task-card.completed h4{text-decoration:line-through;color:var(--text-secondary)}
    /* Modale ma≈Çe */
    .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:1100}
    .modal-overlay.visible{display:flex}
    .modal{background:var(--bg-secondary);border-radius:12px;box-shadow:var(--shadow-lg);width:min(92vw,480px)}
    .modal-header,.modal-footer{padding:14px 16px;border-bottom:1px solid var(--border-color);display:flex;justify-content:space-between;align-items:center}
    .modal-footer{border-bottom:none;border-top:1px solid var(--border-color)}
    .form-modal-content{padding:16px}
    #loading-overlay{position:fixed;inset:0;background:rgba(255,255,255,.8);display:none;align-items:center;justify-content:center;z-index:1200}
    .dark-mode #loading-overlay{background:rgba(0,0,0,.8);color:#fff}
    @media(max-width:768px){.app-container{flex-direction:column}.sidebar{position:fixed;transform:translateX(-100%);transition:transform .25s;height:100vh;z-index:1201}.sidebar.open{transform:translateX(0)}.main-header{position:sticky;top:0;background:var(--bg-secondary);padding:10px;z-index:5}}
  </style>
</head>
<body>
<div id="loading-overlay"><p>≈Åadowanie‚Ä¶</p></div>

<!-- AUTH -->
<div id="auth-overlay">
  <div class="auth-container">
    <form id="login-form" class="auth-form">
      <h2>Zaloguj siƒô</h2>
      <div class="form-group"><label for="login-email">Email</label><input id="login-email" type="email" required></div>
      <div class="form-group"><label for="login-password">Has≈Ço</label><input id="login-password" type="password" required></div>
      <button class="btn btn-primary" type="submit">Zaloguj siƒô</button>
      <p id="auth-error-login" class="error-message"></p>
      <p class="auth-toggle">Nie masz konta? <a id="show-register">Zarejestruj siƒô</a></p>
    </form>

    <form id="register-form" class="auth-form" style="display:none">
      <h2>Stw√≥rz konto</h2>
      <div class="form-group"><label for="register-name">Nazwa u≈ºytkownika</label><input id="register-name" type="text" required></div>
      <div class="form-group"><label for="register-email">Email</label><input id="register-email" type="email" required></div>
      <div class="form-group"><label for="register-password">Has≈Ço (min. 6 znak√≥w)</label><input id="register-password" type="password" minlength="6" required></div>
      <button class="btn btn-primary" type="submit">Zarejestruj siƒô</button>
      <p id="auth-error-register" class="error-message"></p>
      <p class="auth-toggle">Masz ju≈º konto? <a id="show-login">Zaloguj siƒô</a></p>
    </form>
  </div>
</div>

<!-- APP -->
<div class="app-container hidden">
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <div class="logo">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
      </div>
      <h1>TeamFlow</h1>
    </div>

    <nav class="nav-section">
      <ul class="nav-list" id="main-nav">
        <li class="nav-item">
          <a href="#" class="active" data-view="my-tasks">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z"/><path d="M4.5 20.12a7.5 7.5 0 0115 0A17.93 17.93 0 0112 21.75c-2.68 0-5.22-.58-7.5-1.63z"/></svg>
            <span>Moje zadania</span>
          </a>
        </li>
      </ul>
    </nav>

    <nav class="nav-section">
      <h2 style="font-size:12px;color:var(--text-secondary);text-transform:uppercase;margin:8px 0">Moje projekty</h2>
      <ul class="nav-list" id="projects-list"></ul>
    </nav>

    <button class="btn btn-primary new-project-btn" id="new-project-btn">+ Nowy projekt</button>

    <div class="sidebar-footer">
      <div>Zalogowano jako:<br><span id="user-email-display"></span></div>
      <button id="logout-btn" class="btn btn-secondary" style="width:100%;margin-top:10px">Wyloguj</button>
    </div>
  </aside>

  <main class="main-content">
    <header class="main-header">
      <div class="project-title-wrapper">
        <div>
          <h2 id="project-name-header">Moje zadania</h2>
          <div id="project-members-header" class="project-members"></div>
        </div>
      </div>
      <div class="header-actions">
        <button id="notification-toggle-btn" class="header-btn" title="ZarzƒÖdzaj powiadomieniami">
          <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path d="M14.86 17.08a23.85 23.85 0 005.45-1.31A8.97 8.97 0 0118 9.75V9a6 6 0 00-12 0v.75a8.97 8.97 0 01-2.31 6.02c1.73.64 3.56 1.08 5.46 1.31m5.71 0a24.26 24.26 0 01-5.71 0m5.71 0a3 3 0 11-5.71 0"/>
          </svg>
        </button>
        <div class="theme-switcher" id="theme-switcher">
          <button id="theme-light" class="header-btn" title="Tryb jasny">‚òÄÔ∏è</button>
          <button id="theme-dark" class="header-btn" title="Tryb ciemny">üåô</button>
        </div>
      </div>
    </header>

    <section class="kanban-board" id="kanban-board">
      <!-- kolumny renderowane w JS -->
    </section>
  </main>
</div>

<!-- Notyfikacja modal -->
<div class="modal-overlay" id="notification-modal">
  <div class="modal">
    <div class="modal-header">
      <h3 id="notification-title">Powiadomienie</h3>
      <button class="header-btn" id="notification-close-x" title="Zamknij">‚úñ</button>
    </div>
    <div class="form-modal-content">
      <p id="notification-message"></p>
    </div>
    <div class="modal-footer">
      <button class="btn btn-primary" id="notification-ok">OK</button>
    </div>
  </div>
</div>

<script type="module">
/**
 * 1) Firebase importy
 */
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, collection, doc, setDoc, getDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
import { getMessaging, getToken, onMessage, isSupported } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-messaging.js";

/**
 * 2) KONFIGURACJA ‚Äî zostaw jak masz (Tw√≥j ‚ÄûcofingAPI‚Äù)
 */
const firebaseConfig = {
  apiKey: "__API_KEY__",
  authDomain: "__AUTH_DOMAIN__",
  projectId: "__PROJECT_ID__",
  storageBucket: "__STORAGE_BUCKET__",
  messagingSenderId: "__MESSAGING_SENDER_ID__",
  appId: "__APP_ID__"
};

/**
 * 3) Inicjalizacja
 */
const app  = initializeApp(firebaseConfig);
const db   = getFirestore(app);
const auth = getAuth(app);
// (opcjonalnie) uzupe≈Çnij, je≈ºeli masz klucz: const VAPID_KEY = "__TWOJ_PUBLICZNY_VAPID_KEY__";

/**
 * 4) Prosty stan aplikacji i referencje DOM
 */
const state = {
  currentUser: null,
  ui: { theme: localStorage.getItem("tf_theme") || "light" }
};

const loadingOverlay = document.getElementById("loading-overlay");
const authOverlay    = document.getElementById("auth-overlay");
const appContainer   = document.querySelector(".app-container");
const userEmailDisplay = document.getElementById("user-email-display");

const loginForm = document.getElementById("login-form");
const registerForm = document.getElementById("register-form");
const showRegisterBtn = document.getElementById("show-register");
const showLoginBtn = document.getElementById("show-login");
const authErrorLogin = document.getElementById("auth-error-login");
const authErrorRegister = document.getElementById("auth-error-register");

const notificationToggleBtn = document.getElementById("notification-toggle-btn");
const notificationModal = document.getElementById("notification-modal");
const notificationTitle = document.getElementById("notification-title");
const notificationMessage = document.getElementById("notification-message");
const notifOk = document.getElementById("notification-ok");
const notifCloseX = document.getElementById("notification-close-x");

const themeSwitcher = document.getElementById("theme-switcher");
const themeLight = document.getElementById("theme-light");
const themeDark  = document.getElementById("theme-dark");

const kanbanBoardEl = document.getElementById("kanban-board");
const projectsListEl = document.getElementById("projects-list");
const projectNameHeaderEl = document.getElementById("project-name-header");
const logoutBtn = document.getElementById("logout-btn");

function openModal(el){ el.classList.add("visible"); }
function closeModal(el){ el.classList.remove("visible"); }
notifOk.addEventListener("click", ()=> closeModal(notificationModal));
notifCloseX.addEventListener("click", ()=> closeModal(notificationModal));

/**
 * 5) UI: motyw
 */
function applyTheme(){
  document.body.classList.toggle("dark-mode", state.ui.theme === "dark");
  themeLight.classList.toggle("active", state.ui.theme === "light");
  themeDark.classList.toggle("active", state.ui.theme === "dark");
}
applyTheme();

themeLight.addEventListener("click", ()=>{ state.ui.theme="light"; localStorage.setItem("tf_theme","light"); applyTheme(); });
themeDark.addEventListener("click", ()=>{ state.ui.theme="dark";  localStorage.setItem("tf_theme","dark");  applyTheme(); });

/**
 * 6) AUTH ‚Äî logowanie/rejestracja
 */
showRegisterBtn.addEventListener("click", ()=>{
  loginForm.style.display = "none";
  registerForm.style.display = "block";
});
showLoginBtn.addEventListener("click", ()=>{
  registerForm.style.display = "none";
  loginForm.style.display = "block";
});

registerForm.addEventListener("submit", async (e)=>{
  e.preventDefault();
  authErrorRegister.textContent = "";
  const name = document.getElementById("register-name").value.trim();
  const email = document.getElementById("register-email").value.trim();
  const password = document.getElementById("register-password").value;
  if(!name){ authErrorRegister.textContent = "Nazwa u≈ºytkownika jest wymagana."; return; }
  const submitBtn = registerForm.querySelector('button[type="submit"]');
  submitBtn.disabled = true; submitBtn.textContent = "Rejestrowanie‚Ä¶";
  try{
    const cred = await createUserWithEmailAndPassword(auth, email, password);
    // zapisz u≈ºytkownika do kolekcji users
    await setDoc(doc(collection(db, "artifacts/default-app-id/public/data/users"), cred.user.uid), {
      uid: cred.user.uid, email: cred.user.email, name,
      avatarColor: '#'+Math.floor(Math.random()*16777215).toString(16).padStart(6,'0'),
      createdAt: new Date().toISOString()
    });
  }catch(err){
    console.error(err);
    authErrorRegister.textContent = err.message;
  }finally{
    submitBtn.disabled = false; submitBtn.textContent = "Zarejestruj siƒô";
  }
});

loginForm.addEventListener("submit", async (e)=>{
  e.preventDefault();
  authErrorLogin.textContent = "";
  const email = document.getElementById("login-email").value.trim();
  const password = document.getElementById("login-password").value;
  const submitBtn = loginForm.querySelector('button[type="submit"]');
  submitBtn.disabled = true; submitBtn.textContent = "Logowanie‚Ä¶";
  try{
    await signInWithEmailAndPassword(auth, email, password);
  }catch(err){
    console.error(err);
    authErrorLogin.textContent = "Nieprawid≈Çowy email lub has≈Ço.";
  }finally{
    submitBtn.disabled = false; submitBtn.textContent = "Zaloguj siƒô";
  }
});

logoutBtn.addEventListener("click", ()=> signOut(auth));

onAuthStateChanged(auth, async (user)=>{
  if(user){
    state.currentUser = user;
    userEmailDisplay.textContent = user.email || "(brak email)";
    authOverlay.style.display = "none";
    appContainer.classList.remove("hidden");
    loadingOverlay.style.display = "none";
    renderMyTasks(); // prosta lista demo
    // od≈õwie≈º ikonƒô dzwonka
    updateNotificationBellUI();
    // nas≈Çuchiwanie wiadomo≈õci w oknie (FCM)
    if(await isSupported()){
      const messaging = getMessaging(app);
      onMessage(messaging, (payload)=>{
        showNotification(`Nowa wiadomo≈õƒá`, JSON.stringify(payload));
      });
    }
  }else{
    state.currentUser = null;
    appContainer.classList.add("hidden");
    authOverlay.style.display = "flex";
    loadingOverlay.style.display = "none";
  }
});

/**
 * 7) Prosty render zada≈Ñ (placeholder ‚Äî ≈ºeby UI ≈ºy≈Ç)
 */
function renderMyTasks(){
  projectNameHeaderEl.textContent = "Moje zadania";
  kanbanBoardEl.innerHTML = `
    <div class="kanban-column" data-status="todo">
      <div class="kanban-column-header"><h3>Do realizacji</h3><span class="task-count">1</span></div>
      <ul class="kanban-tasks">
        <li class="task-card"><h4>Przyk≈Çadowe zadanie</h4><div style="font-size:12px;color:var(--text-secondary)">Demo kolumna</div></li>
      </ul>
    </div>
    <div class="kanban-column" data-status="inprogress">
      <div class="kanban-column-header"><h3>W trakcie</h3><span class="task-count">0</span></div>
      <ul class="kanban-tasks"></ul>
    </div>
    <div class="kanban-column" data-status="done">
      <div class="kanban-column-header"><h3>Wykonane</h3><span class="task-count">0</span></div>
      <ul class="kanban-tasks"></ul>
    </div>`;
  projectsListEl.innerHTML = ""; // hook pod listƒô projekt√≥w
}

/**
 * 8) Powiadomienia (dzwonek)
 *  - pro≈õba o permission
 *  - rejestracja (opcjonalnego) SW w locie
 *  - pobranie tokenu (je≈õli chcesz, dodaj VAPID_KEY)
 */
function showNotification(title, msg){
  notificationTitle.textContent = title || "Powiadomienie";
  notificationMessage.textContent = msg || "";
  openModal(notificationModal);
}

function updateNotificationBellUI(){
  if(!("Notification" in window)){ notificationToggleBtn.classList.remove("active"); notificationToggleBtn.title="Powiadomienia nieobs≈Çugiwane"; return;}
  if(Notification.permission === "granted"){
    notificationToggleBtn.classList.add("active");
    notificationToggleBtn.title = "Powiadomienia w≈ÇƒÖczone";
  }else if(Notification.permission === "denied"){
    notificationToggleBtn.classList.remove("active");
    notificationToggleBtn.title = "Zablokowane w przeglƒÖdarce";
  }else{
    notificationToggleBtn.classList.remove("active");
    notificationToggleBtn.title = "Kliknij, aby w≈ÇƒÖczyƒá";
  }
}

async function ensureMessagingSW(){
  if(!("serviceWorker" in navigator)) return null;
  // Minimalny SW dla FCM (compat w SW jest dozwolony)
  const swCode = `
    importScripts('https://www.gstatic.com/firebasejs/9.6.11/firebase-app-compat.js');
    importScripts('https://www.gstatic.com/firebasejs/9.6.11/firebase-messaging-compat.js');
    firebase.initializeApp(${JSON.stringify(firebaseConfig)});
    const messaging = firebase.messaging();
    messaging.onBackgroundMessage((payload)=>{ /* opcjonalnie: showNotification */ });
  `;
  const blob = new Blob([swCode], {type:"text/javascript"});
  const url  = URL.createObjectURL(blob);
  try{
    return await navigator.serviceWorker.register(url);
  }catch(e){
    console.warn("Nie uda≈Ço siƒô zarejestrowaƒá SW (ok dla prostego podglƒÖdu):", e);
    return null;
  }
}

async function requestNotificationPermission(){
  if(!("Notification" in window)){ showNotification("Powiadomienia","Twoja przeglƒÖdarka nie wspiera Notification API."); return; }
  try{
    const perm = await Notification.requestPermission();
    if(perm !== "granted"){
      updateNotificationBellUI();
      showNotification("Powiadomienia","Aby otrzymywaƒá powiadomienia, w≈ÇƒÖcz je w przeglƒÖdarce.");
      return;
    }
    updateNotificationBellUI();
    // Opcjonalny token FCM:
    if(await isSupported()){
      const swReg = await ensureMessagingSW(); // nie jest wymagane w ka≈ºdym scenariuszu, ale pomaga dla push
      const messaging = getMessaging(app);
      // Je≈õli masz VAPID_KEY, odkomentuj:
      // const token = await getToken(messaging, { vapidKey: VAPID_KEY, serviceWorkerRegistration: swReg || undefined });
      const token = await getToken(messaging, { serviceWorkerRegistration: swReg || undefined });
      if(token){
        console.log("FCM token:", token);
        showNotification("Powiadomienia", "W≈ÇƒÖczono. Token pobrany (patrz konsola).");
        // tu mo≈ºesz zapisaƒá token do users/{uid}
        // if(state.currentUser){ await setDoc(doc(db,'artifacts/default-app-id/public/data/users', state.currentUser.uid), { fcmTokens: [token] }, { merge:true }); }
      }else{
        showNotification("Powiadomienia","Nie uda≈Ço siƒô pobraƒá tokenu FCM (to normalne na http/bez VAPID).");
      }
    }
  }catch(err){
    console.error(err);
    showNotification("B≈ÇƒÖd powiadomie≈Ñ", String(err?.message||err));
  }
}
notificationToggleBtn.addEventListener("click", requestNotificationPermission);

/**
 * Inicjalny stan dzwonka
 */
updateNotificationBellUI();
</script>
</body>
</html>
