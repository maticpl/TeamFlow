
<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TeamFlow</title>
    <link rel="icon" type="image/png" href="favicon2.png"> <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Poppins:wght@700&display=swap" rel="stylesheet">
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.14/index.global.min.js'></script>
    <script src='https://cdn.jsdelivr.net/npm/@fullcalendar/core/locales/pl.global.min.js'></script>
     <script src='https://cdn.jsdelivr.net/npm/rrule@2.8.1/dist/es5/rrule.min.js'></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/croppie/2.6.5/croppie.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/croppie/2.6.5/croppie.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>

    <script src="https://unpkg.com/@popperjs/core@2"></script>
    <script src="https://unpkg.com/tippy.js@6"></script>

    <link rel="stylesheet" href="https://unpkg.com/tributejs@5.1.3/dist/tribute.css" />
    <script src="https://unpkg.com/tributejs@5.1.3/dist/tribute.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <style>
        
        @keyframes animated-gradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        :root {
            --bg-primary: #f4f5f7;
            --bg-secondary: #ffffff;
            --bg-tertiary: #e9eaec;
            --bg-overlay: rgba(0, 0, 0, 0.5);
            --text-primary: #172b4d;
            --text-secondary: #5e6c84;
            --text-on-accent: #ffffff;
            --border-color: #dfe1e6;
            --accent-primary: #4f46e5;
            --accent-hover: #4338ca;
            --danger-primary: #dc2626;
            --danger-hover: #b91c1c;
            --danger-border: #fca5a5; /* Nowa zmienna dla ostylowania przycisku usuwania */
            --success-primary: #16a34a;
            --priority-low-border: var(--success-primary); /* <-- NOWA ZMIENNA */
            --priority-high-bg: #fef9c3;
            --priority-high-border: #fde047;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
            --border-radius: 8px;
            --font-family: 'Inter', sans-serif;
            --font-family-header: 'Poppins', sans-serif; /* <-- ZMIENIONO WARTO */
        }
        .dark-mode {
            --bg-primary: #1f2937;
            --bg-secondary: #374151;
            --bg-tertiary: #4b5563;
            --text-primary: #f9fafb;
            --text-secondary: #d1d5db;
            --border-color: #4b5563;
            --success-primary: #22c55e;
            --priority-high-bg: #4f46e5;
            --priority-high-border: #fde047;
            --danger-border: #ef4444; /* Dostosowanie koloru w trybie ciemnym */
        }
        /* === NOWE ZMIENNE DLA IKONY BUD呕ETU === */
        :root {
            --icon-fill-light: var(--text-primary);
            --icon-accent-light: #ffd166;
        }
        .dark-mode {
            --icon-fill-light: var(--text-primary); /* Biay w trybie ciemnym */
            --icon-accent-light: #f59e0b; /* Bardziej widoczny bursztyn */
        }
        /* === NOWA REGUA: Style dla siatki bud偶etu (Desktop) === */
        .project-details-budget-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-bottom: 12px;
            font-size: 13px;
            text-align: center;
        }
        /* === KONIEC NOWEJ REGUY === */
        /* === NOWA REGUA: Style dla kontenera akcji grup === */
        .group-action-container {
            border: 1px solid var(--accent-primary);
            border-radius: var(--border-radius);
            padding: 4px;
            margin-bottom: 4px;
        }
        /* === KONIEC NOWEJ REGUY === */
        /* === KONIEC NOWYCH ZMIENNYCH === */
        .comment-item {
            position: relative; /* Potrzebne do pozycjonowania przycisku */
            margin-bottom: 12px;
            padding: 8px 12px;
            background-color: var(--bg-primary);
            border-radius: var(--border-radius);
            font-size: 14px;
        }

        .delete-comment-btn {
            position: absolute;
            top: 4px;
            right: 8px;
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 20px;
            line-height: 1;
            cursor: pointer;
            padding: 2px 4px;
            border-radius: 4px;
            opacity: 0.5;
            transition: opacity 0.2s, background-color 0.2s;
        }

        .comment-item:hover .delete-comment-btn {
            opacity: 1;
        }

        .delete-comment-btn:hover {
            background-color: var(--border-color);
            color: var(--danger-primary);
        }
        /* === NOWA REGUA: Korekta rozmiaru czcionki dla etykiety Czonkowie w szczeg贸ach projektu === */
        #project-details-modal .project-details-info strong {
            font-size: 14px; /* Wymu ten sam rozmiar, co dla tekstu w paragrafie */
        }
        /* === KONIEC NOWEJ REGUY === */
        /* === NOWA REGUA dla HTML === */
        html {
            height: 100%;         /* Upewnia si, 偶e html zajmuje ca wysoko */
            width: 100%;          /* Upewnia si, 偶e html zajmuje ca szeroko */
            box-sizing: border-box; /* Zapewnia poprawne obliczanie wymiar贸w */
            overflow: hidden;      /* Zapobiega paskom przewijania na poziomie html */
        }
        /* === KONIEC NOWEJ REGUY === */

        * { margin: 0; padding: 0; box-sizing: border-box; }
       body {
            font-family: var(--font-family);
            /* === ZMIANA TA === */
            /* Zwikszono krycie na 0.4, aby to byo ciemniejsze */
            background: linear-gradient(180deg, rgba(79, 70, 229, 0.7) 0%, var(--bg-primary) 50%);
            /* === KONIEC ZMIANY TA === */
            color: var(--text-primary);
            line-height: 1.5;
            overflow: hidden;
            transition: background-color 0.3s, color 0.3s;
            zoom: 0.8; /* <<< Ta linia zostanie usunita */
            width: 100%;
            height: 100%;
            box-sizing: border-box;
        }
        #auth-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            /* Utrzymanie ta aplikacji */
            background: linear-gradient(180deg, rgba(79, 70, 229, 0.7) 0%, var(--bg-primary) 50%);
            display: flex; /* Pozostawiamy flex, aby dzieci mogy si ukada */
            align-items: center;   /* PRZYWRCONO: Centrowanie w pionie */
            justify-content: center; /* PRZYWRCONO: Centrowanie w poziomie */
            z-index: 10001;
        }
        .auth-container { 
            background-color: var(--bg-secondary); 
            padding: 40px; 
            border-radius: var(--border-radius); 
            box-shadow: var(--shadow-lg); 
            width: 90%; 
            max-width: 400px; 
            text-align: center;
        }
        .auth-container h2 { margin-bottom: 24px; }
        /* === NOWE STYLE DLA LAYOUTU ZALOGOWANIA === */
        /* === NOWE STYLE DLA LAYOUTU ZALOGOWANIA === */
        .auth-wrapper {
            display: flex;
            width: 95%; /* Zachowano dla lekkiego marginesu na skrajach */
            /* USUNITO: max-width: 1400px; */
            height: 90%; /* Zachowano dla lekkiego marginesu g贸ra/d贸 */
            /* USUNITO: max-height: 800px; */
            overflow: hidden;
            /* USUNITO: border-radius: var(--border-radius); */
            /* USUNITO: box-shadow: var(--shadow-lg); */
            background-color: transparent;
        }
        auth-form-column {
            flex-shrink: 0;
            width: 380px;
            background-color: var(--bg-secondary);
            display: flex;
            align-items: flex-start; /* ZMIENIONO: Wyr贸wnanie do g贸ry */
            justify-content: center; /* Centrowanie formularza w poziomie pozostaje */
            padding: 0 30px;
            border-top-left-radius: var(--border-radius);
            border-bottom-left-radius: var(--border-radius);
            border-top-right-radius: 0;
            border-bottom-right-radius: 0;
            box-shadow: -10px 0px 15px -3px rgba(0, 0, 0, 0.1), -4px 0px 6px -4px rgba(0, 0, 0, 0.1);
        }
        /* ... reszta styl贸w ... */
      .auth-promo-column {
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: flex-start;
            padding: 40px 40px 50px 80px; /* Zachowujemy odstpy */
            overflow-y: auto;
            flex-grow: 1; /* PRZYWRCONO/DODANO: Kolumna ma rosn */
            flex-basis: 0; /* DODANO: Punkt startowy dla wzrostu */
            scrollbar-width: none;
            -ms-overflow-style: none;
            color: var(--text-primary);
        }
        .auth-promo-column::-webkit-scrollbar {
            display: none;
        }
       .auth-promo-header {
             display: flex;
             align-items: center;
             gap: 20px;
             margin-bottom: 30px;
             /* USUNITO: margin-top: 50px; */
             width: 100%;
        }
        /* Styl dla LOGO - Bez zmian */
        .auth-promo-column img.logo-img {
            width: auto;
            height: 160px; /* ZWIKSZONO: Logo bdzie wiksze */
            margin-bottom: 0;
        }
         /* Styl dla Du偶ej Ilustracji (Strona4) */
        .auth-promo-column img.large-illustration {
            max-width: 1100px; /* Zwiksz t warto */
            height: auto;
            margin-top: 30px;
            margin-bottom: 0;
            border-radius: 0;
            box-shadow: none;
            object-fit: contain;
            /* Dodaj wyrodkowanie, jeli max-width jest mniejsze ni偶 szeroko kolumny */
            margin-left: auto;
            margin-right: auto;
            display: block;
        }
       
        /* Styl dla tekstu promocyjnego (nag贸wek i paragraf) */
        .auth-promo-column h2 {
            font-size: 22px;
            font-family: var(--font-family-header);
            font-weight: 700;
            color: var(--text-primary); /* ZMIENIONO: Na domylny kolor tekstu (ciemny) */
            margin-bottom: 0;
            white-space: normal;
            line-height: 1.3;
            margin-top: 2em;
        }
        /* NOWE style dla pojedynczego obrazu promo */
        .promo-single-image {
            display: block; /* Umo偶liwia ustawienie margines贸w auto */
            width: 140%; /* ZWIKSZONO: Obrazek bdzie szerszy */
            max-width: 1100px; /* ZWIKSZONO: Wiksza maksymalna szeroko */
            height: auto; /* Wysoko dopasuje si automatycznie */
            margin: 0 auto 30px auto; /* Wyrodkowanie (g贸ra 0, lewo/prawo auto, d贸 30px) */
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-md);
            object-fit: contain; /* Zachowujemy contain, aby cay obraz by widoczny */
        }
        /* Styl dla tekstu promocyjnego (paragraf) - bez zmian */
        .auth-promo-column p {
            font-size: 14px;
            line-height: 1.6;
            color: var(--text-primary); /* Upewnij si, 偶e to jest --text-primary jak ustalilimy */
            text-align: left;
            margin-bottom: 0; /* Margines dodany do ilustracji Strona4 poni偶ej */
        }
        
        /* Poprawka dla kontenera formularza (aby nie zajmowa caej kolumny) */
        .auth-form-column {
            flex-shrink: 0; /* ZAPEWNIONO: Kolumna si nie kurczy */
            width: 400px; /* Utrzymujemy sta szeroko */
            background-color: var(--bg-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 30px;
            border-top-left-radius: var(--border-radius);
            border-bottom-left-radius: var(--border-radius);
            border-top-right-radius: 0;
            border-bottom-right-radius: 0;
            box-shadow: -10px 0px 15px -3px rgba(0, 0, 0, 0.1), -4px 0px 6px -4px rgba(0, 0, 0, 0.1);
            /* USUNITO (jeli byo): margin-left: auto; */
        }
        /* Kontener formularza - Przywr贸cono oryginalny padding */
        .auth-form-column .auth-container {
            width: 100%;
            max-width: 340px;
            /* ZMIENIONO: Przywr贸cono padding 40px dookoa */
            padding: 40px;
            box-shadow: none;
        }
        /* Styl dla wikszego tekstu promocyjnego */
       
        .auth-promo-column p {
            font-size: 14px;
            line-height: 1.6;
            color: var(--text-secondary);
            text-align: justify;
            margin-bottom: 24px;
        }
        
        /* === KONIEC NOWYCH STYLI === */
        #register-form { display: none; }
        .auth-form .form-group { text-align: left; }
        .auth-form .btn { width: 100%; margin-top: 16px; }
        .auth-form .btn:disabled { background-color: var(--bg-tertiary); cursor: wait; }
        .auth-toggle { margin-top: 24px; font-size: 14px; }
        .auth-toggle a { color: var(--accent-primary); font-weight: 500; cursor: pointer; }
        .error-message { color: var(--danger-primary); margin-top: 16px; font-size: 14px; min-height: 20px; }
        .app-container {
             display: flex;
             height: 100%;         /* <--- ZMIANA: Przywr贸cono 100% (odziedziczone z body) */
             width: 100%;          /* <--- ZMIANA: Ustawiono 100% (odziedziczone z body) */
             position: relative;
             /* Usunito transform: scale(0.9); */
             /* Usunito transform-origin: top center; */
        }
        .app-container.hidden { display: none; }
        .sidebar { 
    width: 260px; 
    background-color: var(--bg-secondary); 
    border-right: 1px solid var(--border-color); 
    /* Zmieniamy padding: 24px na (g贸ra, prawo, d贸, lewo) */
    padding: 0px 16px 24px 16px; /* Zmniejszony g贸rny, zachowany dolny i boczne */
    display: flex; 
    flex-direction: column; 
    /* ZMIANA: Dodano 'width' i 'padding' do animacji */
    transition: background-color 0.3s, border-color 0.3s, transform 0.3s ease-in-out, width 0.3s ease-in-out, padding-left 0.3s ease-in-out, padding-right 0.3s ease-in-out;
    flex-shrink: 0; 
}
       .main-content {
    flex-grow: 1;
    padding: 24px;
    display: flex;
    flex-direction: column;
    overflow-y: auto; /* <<< POPRAWKA: Przywr贸cono przewijanie pionowe */
    overflow-x: hidden; /* <<< DODANO: Zapobiega poziomemu przewijaniu g贸wnego kontenera */
             width: 0; 
}
        .sidebar-footer { margin-top: auto; border-top: 1px solid var(--border-color); padding-top: 16px; }
        .sidebar-scrollable-area {
    flex-grow: 1;
    overflow-y: auto;
    min-height: 0; /* Wa偶na poprawka dla elastycznego ukadu w niekt贸rych przegldarkach */
    display: flex;
    flex-direction: column;
}
        /* Style dla listy wyboru projekt贸w do przeniesienia zadania */
        .project-selection-item {
            display: block;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            margin-bottom: 8px;
            cursor: pointer;
        }
        .project-selection-item:hover {
            background-color: var(--bg-tertiary);
        }
        .project-selection-item input {
            margin-right: 12px;
        }
        .project-selection-item label {
            cursor: pointer;
        }
        
        /* NOWE STYLE DLA PRZYCISKW W STOPCE */
        .sidebar-footer-buttons {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }
        .sidebar-footer-buttons .btn {
            flex: 1;
            width: 100%;
        }

        .sidebar-footer .user-info { font-size: 12px; color: var(--text-secondary); margin-bottom: 8px; word-break: break-all; }
        #logout-btn { width: 100%; background: none; border: 1px solid var(--border-color); color: var(--text-secondary); }
        #logout-btn:hover { background-color: var(--bg-tertiary); }
      

/* Upewnijmy si, 偶e sam kontener nag贸wka (sidebar-header) jest dobrze wyrodkowany */
.sidebar-header { 
    display: flex; 
    flex-direction: row; /* ZMIANA: z column na row */
    align-items: center; 
    justify-content: space-between; /* ZMIANA: Dodano justowanie */
    gap: 0;
    margin-bottom: 0;
    padding: 0; 
    height: 146px; /* <-- ZMIANA: Zwikszono wysoko z 100px na 146px, aby zrobi miejsce */
    padding-left: 16px; /* Wyr贸wnanie dla logo */
    transition: padding-left 0.3s ease-in-out; /* Animacja wcicia logo */
    /* Usunito pointer-events i user-select, aby przycisk dziaa */
}

/* === POCZTEK NOWEGO KODU (POCZONA I POPRAWIONA REGUA) === */
#app-logo {
    /* Rozmiar w stanie ROZWINITYM */
    height: 126px;   /* <-- ZMIANA: Zwikszono wysoko z 80px na 126px (80 + 46) */
    width: auto;    /* Szeroko dopasuje si automatycznie */
    max-width: 100%;  /* Zapobiega "wylaniu si" logo */
    
    /* Waciwoci interakcji i animacji */
    pointer-events: none; 
    user-select: none;
    /* Dodajemy 'height' i 'width' do animacji dla pynnego przejcia */
    transition: opacity 0.2s ease-in-out, max-height 0.3s ease-in-out, width 0.3s ease-in-out, height 0.3s ease-in-out;

    /* Ta regua jest teraz zduplikowana przez 'height: 50px', ale nie szkodzi */
    max-height: 126px; /* <-- ZMIANA: Zwikszono max-height z 80px na 126px */
}
/* <<< NOWA REGUA 1: Domylnie UKRYJ mini-logo i ustaw mu rozmiar >>> */
#mini-logo {
    display: none;
    width: auto;
    height: 50px; /* Rozsdny rozmiar dla mini-logo */
    pointer-events: none;
    user-select: none;
    transition: opacity 0.3s ease-in-out, max-height 0.3s ease-in-out;
}
/* <<< KONIEC NOWEJ REGUY 1 >>> */
#sidebar-toggle-btn {
    padding: 6px; /* Mniejszy padding dla przycisku w sidebarze */
    margin: 4px; /* May margines od krawdzi */
    transition: transform 0.3s ease-in-out, background-color 0.2s;
    flex-shrink: 0; /* Zapobiegaj kurczeniu si przycisku */
    margin-right: 8px; /* Odstp od krawdzi w stanie rozwinitym */
}
#sidebar-toggle-btn svg {
    width: 20px;
    height: 20px;
}

/* === NOWE STYLE DLA STANU ZWINITEGO (Mini-Sidebar) === */

/* Obr贸t przycisku */
.app-container.sidebar-collapsed #sidebar-toggle-btn {
    transform: rotate(180deg);
}

/* Zwi sidebar */
.app-container.sidebar-collapsed .sidebar {
    width: 72px; /* Nowa szeroko (np. 72px) */
    padding-left: 4px; /* May padding na ikony */
    padding-right: 4px;
}

/* Wyrodkuj przycisk zwijania w zwinitym nag贸wku */
.app-container.sidebar-collapsed .sidebar-header {
    /* <<< ZMIENIONA REGUA: U偶ywamy teraz kolumny, aby elementy uo偶yy si pionowo >>> */
    flex-direction: column; 
    justify-content: center; 
    /* <<< ZMIENIONA REGUA: Ustawiamy sta wysoko, aby pomieci mini-logo i przycisk >>> */
    height: 100px; 
    padding-left: 0;
    padding-right: 0; /* Upewnij si, 偶e nie ma paddingu */
}

/* Ukryj logo */
.app-container.sidebar-collapsed #app-logo {
    opacity: 0;
    max-height: 0; /* Zwi logo, aby nie zajmowao miejsca */
    pointer-events: none;
}

/* <<< NOWA REGUA 2: Poka偶 mini-logo i ustaw je na g贸rze >>> */
.app-container.sidebar-collapsed #mini-logo {
    display: block; /* Poka偶 ukryty element */
    height: 50px;   /* Zapewnij wysoko (ju偶 zdefiniowana, ale powtarzamy) */
    margin-top: 10px; /* Odstp od g贸ry sidebara */
    margin-bottom: 0;
    flex-shrink: 0; /* Zapobiegaj kurczeniu si */
}

/* <<< NOWA REGUA 3: Dodaj margines do przycisku, aby by na dole >>> */
.app-container.sidebar-collapsed #sidebar-toggle-btn {
    /* Resetujemy transform (obr贸t jest ok, ale nie chcemy przesunicia) */
    transform: rotate(180deg);
    margin-top: auto; /* Wypchnij przycisk na d贸 */
    margin-bottom: 0;
}
/* <<< KONIEC NOWYCH REGU >>> */

/* Ukryj tekst w linkach nawigacji */
.app-container.sidebar-collapsed .nav-item span {
    display: none;
}

/* Wyrodkuj ikony nawigacji */
.app-container.sidebar-collapsed .nav-item a {
    justify-content: center;
    padding: 6px; /* Mniejszy padding dla samych ikon */
}

/* === POCZTEK POPRAWKI: Ukrywanie tekstu H2 i pokazywanie ikon === */

        
       /* 1. Ukryj tekst we wszystkich nag贸wkach sekcji (ale nie ikony) */
       .app-container.sidebar-collapsed .nav-section h2 {
            text-align: center;
            
            /* === POPRAWKA CENTROWANIA IKON === */
            padding: 0; /* Usuwamy padding na rzecz flexbox */
            width: 100%; /* Wypenij 64px dostpne w sidebarze */
            height: 36px; /* Dopasuj wysoko do wysokoci ikon nawigacji (ikona 24px + 2*6px padding) */
            /* === KONIEC POPRAWKI === */

            margin-top: 8px;
            margin-bottom: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 0; 
            color: transparent;
            cursor: default;
        }

        /* 2. Ustaw ikon i przywr贸 font-size dla ULUBIONYCH PROJEKTW */
        .app-container.sidebar-collapsed .sidebar-scrollable-area > .nav-section:first-child h2 {
            cursor: pointer; /* Zr贸b klikalnym tylko ten nag贸wek */
        }
        .app-container.sidebar-collapsed .sidebar-scrollable-area > .nav-section:first-child h2::before {
            content: "わ";
            font-size: 24px; 
            line-height: 1;
            color: var(--danger-primary);
            
            /* === POPRAWKA CENTROWANIA (Usunicie nadmiarowych regu) === */
            padding: 0; /* Usuwamy padding */
            height: 24px; /* Zachowujemy rozmiar */
            width: 24px;  /* Zachowujemy rozmiar */
            /* Usuwamy display:flex, align-items, justify-content (rodzic H2 ju偶 centruje) */
            /* Usuwamy box-sizing (padding: 0 sprawia, 偶e jest niepotrzebny) */
            /* === KONIEC POPRAWKI === */
        }
        
        /* 3. Ustaw ikon i przywr贸 font-size dla ZAKOCZONYCH PROJEKTW */
        .app-container.sidebar-collapsed #completed-projects-list + .nav-section h2::before {
             content: "";
             font-size: 24px; 
             line-height: 1;
             padding: 1px; 
             color: var(--text-primary); /* U偶yj domylnego koloru tekstu */
             /* === NOWA KOREKTA WYRWNANIA === */
             height: 24px; /* Dopasuj do wysokoci SVG */
             width: 24px;  /* Dopasuj do szerokoci SVG */
             display: flex; /* U偶yj flex do centrowania emoji w pudeku */
             align-items: center;
             justify-content: center;
             box-sizing: content-box; /* Upewnij si, 偶e padding dodaje si do wymiaru */
        }

        /* 4. Usuwamy star, niedziaajc regu (teraz jest pusta) */
        .app-container.sidebar-collapsed .nav-section h2 span {
            /* Ta regua nie jest ju偶 potrzebna */
            display: none;
        }
        /* === KONIEC POPRAWKI === */

/* Zmodyfikuj pasek wyszukiwania */
        .search-bar { 
            position: relative; 
            margin: 0 0 4px 0; 
            /* DODANO: Ustawienie na Flex, aby kontrolowa szeroko */
            display: flex;
            align-items: center;
        }
        /* ... reszta .search-bar */
        
       /* Zmie zachowanie paska wyszukiwania w stanie zwinitym */
        /* POPRAWKA: Dodano .sidebar, aby styl dotyczy TYLKO paska bocznego, a nie modala */
        .app-container.sidebar-collapsed .sidebar .search-bar {
            /* UWAGA: Usuwamy display: none, aby pasek si skurczy, ale pozosta widoczny */
            padding: 0 4px; 
            height: 32px;
        }
        
        /* Ukryj pole tekstowe input i ikony SVG - TYLKO W SIDEBARZE */
        .app-container.sidebar-collapsed .sidebar .search-bar input {
            opacity: 0;
            width: 0;
            padding: 0;
            border: none;
            pointer-events: none; 
        }

        /* Poka偶 ikon SVG (lup) - TYLKO W SIDEBARZE */
        .app-container.sidebar-collapsed .sidebar .search-bar svg {
            position: static; 
            transform: none;
            margin: 0 auto; 
            width: 24px;
            height: 24px;
            cursor: pointer; 
        }

.app-container.sidebar-collapsed #resources-btn span {
    display: none;
}
/* Ukryj strzak w "Zasoby" */
.app-container.sidebar-collapsed #resources-btn svg {
    display: none;
}

/* === NOWA REGUA: Stylowanie kontenera przycisku w trybie zwinitym (NAPRAWA KLIKNICIA) === */
.app-container.sidebar-collapsed #resources-btn {
    justify-content: center; /* Wyrodkowanie ikony pseudo-elementu */
    padding-top: 8px; 
    padding-bottom: 8px;
    height: 40px; /* Staa wysoko, aby przycisk by klikalny */
    width: 100%;
    overflow: hidden;
}

/* === NOWA REGUA: Ikona "Narzdzia" dla zwinitego sidebara === */
        .app-container.sidebar-collapsed #resources-btn::before {
            content: "";
            width: 20px; 
            height: 20px;
            /* Zoptymalizowana ikona SVG dostarczona przez u偶ytkownika */
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="currentColor" d="M21.8 6.1l-3.3 1.4-2-2 1.4-3.3A6.5 6.5 0 0 0 12 6.5c0 .6.1 1.2.3 1.7L3.5 17c-.8.8-.8 2 0 2.8l.7.7c.8.8 2 .8 2.8 0l8.8-8.8c.5.2 1.1.3 1.7.3a6.5 6.5 0 0 0 4.3-5.9z"/></svg>');
            background-repeat: no-repeat;
            background-size: cover;
        }



/* === ZMODYFIKOWANA REGUA: Ukryj tekst "+ Nowy Projekt" i ustaw kolor ikony === */
.app-container.sidebar-collapsed .new-project-btn {
    font-size: 0; /* To ukryje tekst */
    color: var(--text-on-accent); /* Ustawia 'currentColor' dla ikony SVG na biay */
    
    /* === POPRAWKI CENTROWANIA I ROZMIARU === */
    padding: 0; /* Usuwamy padding, aby uzyska pen kontrol */
    /* Ustawiamy wysoko r贸wn szerokoci (72px - 4px lewo - 4px prawo = 64px) */
    height: 64px; 
    display: flex;
    justify-content: center;
    align-items: center;
    /* === KONIEC POPRAWEK === */
}

/* === ZMODYFIKOWANA REGUA: Ustaw ikon SVG (wiksz) === */
.app-container.sidebar-collapsed .new-project-btn::before {
    content: ""; /* Zmie content z "+" na "" */
    display: block; /* Nadaj elementowi wymiary */
    
    /* ZMIANA: Twarde zakodowanie koloru biaego (#ffffff -> %23ffffff) w SVG */
    background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 7.5A1.5 1.5 0 0 1 4.5 6h3.5l1.5 1.8H19a1 1 0 0 1 1 1v7.7a1 1 0 0 1-1 1H4.5A1.5 1.5 0 0 1 3 16.0V7.5z" fill="none" stroke="%23ffffff" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/><path d="M15 11.5v4M17 13.5h-4" fill="none" stroke="%23ffffff" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>');
    background-repeat: no-repeat;
    background-size: contain;
    background-position: center;

    /* === POPRAWKA ROZMIARU === */
    width: 36px; /* ZWIKSZONO: Ikona bdzie znacznie wiksza */
    height: 36px; /* ZWIKSZONO: Ikona bdzie znacznie wiksza */
    /* === KONIEC POPRAWKI === */
    
    /* USUNITO: color: var(--text-on-accent); (Niepotrzebne, kolor jest w SVG) */

    /* Usu style dla tekstu "+" */
    font-size: 0; 
    font-weight: normal;
}

/* Ukryj menu zasob贸w, jeli jest otwarte (na wszelki wypadek) */
/* ZMIANA: Usuwamy display: none dla #resources-menu w trybie zwinitym.
   Menu jest domylnie ukryte przez style klasy .flyout-menu (visibility: hidden, opacity: 0).
   Dziki temu JS mo偶e je pokaza dodajc klas .open. */
.app-container.sidebar-collapsed #resources-menu {
    /* display: none; <--- USUNITE */
}
/* Ukryj e-mail i przycisk wylogowania (tekstowy) */
.app-container.sidebar-collapsed .sidebar-footer .user-info,
.app-container.sidebar-collapsed #logout-btn {
    display: none;
}

/* Ukryj tekst w przeczniku grup */
.app-container.sidebar-collapsed #group-switcher-toggle span,
.app-container.sidebar-collapsed #group-switcher-toggle svg {
    display: none;
}

/* Ukryj tekst w przeczniku grup */
        .app-container.sidebar-collapsed #group-switcher-toggle span,
        .app-container.sidebar-collapsed #group-switcher-toggle svg {
            display: none;
        }

        /* Zmie przecznik grup w ikon */
        .app-container.sidebar-collapsed #group-switcher-toggle {
            justify-content: center;
            padding-top: 8px; /* Zmniejszam padding */
            padding-bottom: 8px;
            height: 40px; /* Staa wysoko */
            overflow: hidden;
            /* DODANO: Wymuszamy wyrodkowanie w zwinitym pasku */
            width: 100%; 
        }

        /* U偶yjemy ikony SVG jako elementu ta/pseudo-elementu */
        /* U偶yjemy ikony SVG jako elementu ta/pseudo-elementu */
        .app-container.sidebar-collapsed #group-switcher-toggle::before {
            content: "";
            width: 24px;
            height: 24px;
            /* NOWA IKONA GRUPY (dostarczona przez u偶ytkownika, zoptymalizowana) */
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><circle cx="12" cy="7.5" r="2.3" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/><path d="M7 18c0-2.4 2.6-4.2 5-4.2s5 1.8 5 4.2" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/><circle cx="6" cy="10" r="1.5" fill="none" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/><path d="M3.5 18c0-1.9 1.7-3.2 3.5-3.2" fill="none" stroke="currentColor" stroke-width="1.4" stroke-linecap="round"/><circle cx="18" cy="10" r="1.5" fill="none" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/><path d="M17.9 14.8c1.8 0 3.6 1.3 3.6 3.2" fill="none" stroke="currentColor" stroke-width="1.4" stroke-linecap="round"/></svg>');
            background-repeat: no-repeat;
            background-size: cover;
            /* Usunito filtr 'invert', poniewa偶 nowa ikona u偶ywa 'currentColor' */
        }

/* Zwi przyciski stopki (AI, Ustawienia) do samych ikon */
.app-container.sidebar-collapsed .sidebar-footer-buttons {
    flex-direction: column; /* Ustaw ikony jedna pod drug */
    gap: 4px; /* Mniejszy odstp */
}
.app-container.sidebar-collapsed .sidebar-footer-buttons .btn {
    padding: 8px; /* Mniejszy padding */
}
/* === KONIEC NOWYCH STYLI === */

        .search-bar { 
    position: relative; 
    /* Ustawiamy margin na 4px dla dou i 0px dla g贸ry */
    margin: 0 0 4px 0; 
}
        .search-bar input { width: 100%; padding: 8px 12px 8px 32px; border-radius: var(--border-radius); border: 1px solid var(--border-color); background-color: var(--bg-primary); color: var(--text-primary); font-size: 14px; }
        .search-bar svg { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); width: 16px; height: 16px; color: var(--text-secondary); }
        .nav-section { 
    margin-bottom: 4px; /* Ostra redukcja marginesu dolnego */
}
        .nav-section h2 { 
    font-size: 11px; 
    font-weight: 600; 
    color: var(--text-secondary); 
    text-transform: uppercase; 
    letter-spacing: 0.5px; 
    margin-bottom: 4px; 
    margin-top: 0; /* Usunicie odstpu na g贸rze nag贸wka sekcji */
    padding: 0 4px; 
}

        .nav-list { 
            list-style: none;  
            /* Usunito max-height, aby flexbox sam zarzdza wysokoci */
        }

        .nav-item a { 
    display: flex; 
    align-items: center; 
    gap: 8px; /* Zmniejszamy odstp ikona-tekst */
    padding: 4px 6px; /* Zmniejszamy pionowy i poziomy padding */
    border-radius: var(--border-radius); 
    text-decoration: none; 
    color: var(--text-primary); 
    font-weight: 500; 
    font-size: 12px; /* Zmniejszamy rozmiar czcionki */
    transition: background-color 0.2s, color 0.2s; 
    line-height: 1.2; 
}

        .nav-item a:hover { 
            background-color: var(--bg-tertiary); 
        }

        .nav-item a.active { 
            background-color: var(--accent-primary); 
            color: var(--text-on-accent); 
        }

        .nav-item svg {
            width: 24px;          /* standardowa siatka ikon */
            height: 24px;
            flex-shrink: 0;
            display: block;       /* eliminuje przycinanie inline */
            overflow: visible;    /* nie ucina obrysu */
            padding: 1px;         /* minimalny margines bezpieczestwa */
        }

        /* opcjonalnie: gdy stroke w svg wyglda dziwnie przy skalowaniu */
        .nav-item svg * {
            vector-effect: non-scaling-stroke;
        }

        /* POPRAWKA: Dodatkowy margines tylko dla ikony projektu */
        #projects-list .nav-item a svg, 
#completed-projects-list .nav-item a svg {
    margin-left: 2px;
}

        .new-project-btn { 
            width: 100%; 
            padding: 10px; 
            border-radius: var(--border-radius); 
            border: none; 
            background-color: var(--accent-primary); 
            color: var(--text-on-accent); 
            font-size: 14px; 
            font-weight: 600; 
            cursor: pointer; 
            transition: background-color 0.2s; 
        }

        .new-project-btn:hover { 
            background-color: var(--accent-hover); 
        }

        .mobile-header { 
            display: none; 
        }
        .main-header {
            display: flex;
            justify-content: space-between;
            /* === ZMIANA WYRWNANIA === */
            align-items: flex-start; /* Wyr贸wnaj elementy do g贸ry */
            /* === KONIEC ZMIANY === */
            flex-shrink: 0;
            background-color: var(--bg-secondary);
            padding: 16px 24px;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 0;
            /* === POPRAWIONE ZAOKRGLENIE === */
            border-radius: var(--border-radius); /* Zaokrglenie wszystkich rog贸w */
            /* === KONIEC POPRAWKI === */
            position: relative;
        }
        /* Dodatkowa regua, aby g贸wna tre miaa odstp od nag贸wka */
        .kanban-board, #calendar-view, #mobile-calendar-wrapper, .dashboard-view, .my-day-view, .all-projects-view {
             margin-top: 24px;
        }
        .project-title-wrapper { display: flex; align-items: center; gap: 16px; }
        .project-title h2#project-name-header {
            font-size: 30px; 
            font-family: var(--font-family-header);
            font-weight: 700; /* <-- PRZYWRCONO pogrubienie dla Poppins */
        }
        .project-actions button {
            /* Usunito background: none; */
            border: 1px solid transparent; /* Domylnie przezroczysta ramka, zachowuje rozmiar */
            color: var(--text-secondary);
            padding: 6px 12px;
            font-size: 13px;
            font-weight: 500;
            border-radius: var(--border-radius);
            cursor: pointer;
            margin-left: 8px;
            transition: background-color 0.2s, color 0.2s, border-color 0.2s; /* Dodano border-color do transition */
            display: flex;
            align-items: center;
            gap: 6px;
            background-color: transparent; /* Jawne ustawienie przezroczystego ta */
        }

        /* === NOWE STYLE DLA PRZYCISKW SZCZEGY i EDYTUJ === */
        .project-actions #project-details-btn,
        .project-actions #edit-project-btn {
            border-color: var(--accent-primary); /* Niebieska ramka */
            color: var(--accent-primary);       /* Niebieski tekst/ikona */
        }
        .project-actions #project-details-btn:hover,
        .project-actions #edit-project-btn:hover {
            background-color: var(--accent-primary); /* Niebieskie to */
            color: var(--text-on-accent);          /* Biay tekst/ikona */
            border-color: var(--accent-primary); /* Utrzymanie koloru ramki dla sp贸jnoci */
        }
        /* === KONIEC NOWYCH STYLI === */

        /* === ZMODYFIKOWANE STYLE DLA PRZYCISKU ZAKOCZ === */
        .project-actions .complete-project-btn {
             /* U偶ywamy --success-primary dla zielonego */
             border-color: var(--success-primary);
             color: var(--success-primary);
        }
        .project-actions .complete-project-btn:hover {
            border-color: var(--success-primary);
            background-color: var(--success-primary);
            color: var(--text-on-accent); /* Zmieniono z 'white' na zmienn */
        }
        /* === KONIEC MODYFIKACJI === */

        /* === ZMODYFIKOWANE STYLE DLA PRZYCISKU USU === */
        .project-actions .delete-project-btn {
            border-color: var(--danger-primary); /* Czerwona ramka (byo danger-border) */
            color: var(--danger-primary);
        }
        .project-actions .delete-project-btn:hover {
            border-color: var(--danger-hover);
            background-color: var(--danger-hover);
            color: var(--text-on-accent); /* Zmieniono z 'white' na zmienn */
        }
        /* === KONIEC MODYFIKACJI === */

        /* Styl dla ikon wewntrz przycisk贸w (bez zmian) */
        .project-actions button svg {
             width: 16px;
             height: 16px;
             /* Kolor ikony dziedziczony z przycisku (color) */
        }
        /* === NOWE STYLE DLA PRZYCISKU 'AKTUALNA DATA' W MJ DZIE === */
        #my-day-today,
        #my-day-today-mobile {
            /* Nadpisuje domylny .btn-secondary */
            background-color: transparent !important;
            border: 1px solid var(--accent-primary);
            color: var(--accent-primary);
            padding: 4px 8px; 
            font-size: 12px;
        }

        #my-day-today:hover,
        #my-day-today-mobile:hover {
            background-color: var(--accent-primary) !important;
            color: var(--text-on-accent) !important;
            border-color: var(--accent-primary);
        }
        /* === KONIEC NOWYCH STYLI === */

        .project-members { display: flex; align-items: center; margin-top: 4px; }
        .avatar {
    width: 42px; /* Ten rozmiar z poprzedniej zmiany jest OK dla nag贸wk贸w */
    height: 42px;
    font-size: 16px;
    object-fit: cover;
    background-size: cover;
    background-position: center;
    border-radius: 50%;
    background-color: #ccc;
    color: var(--text-on-accent);
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    border: 2px solid var(--bg-secondary);
    margin-left: -10px; /* <-- ZMIANA TUTAJ */
}
        .project-members .avatar:first-child { margin-left: 0; }
        .header-actions { display: flex; align-items: center; gap: 16px; }
        .header-btn {
    background: none;
    border: none;
    padding: 6px;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--text-secondary);
    transition: background-color 0.2s, color 0.2s;
}
        /* === NOWA REGUA DLA STRZAEK NAWIGACJI DATY (desktop) === */
        #my-day-nav .header-btn {
            font-size: 24px;   /* <-- Zwikszenie rozmiaru */
            font-weight: 900;  /* <-- Maksymalne pogrubienie */
            padding: 4px;      /* Dopasowanie paddingu */
            line-height: 1;    /* Lepsze centrowanie */
        }
        /* === KONIEC NOWEJ REGUY === */
.header-btn:hover {
    background-color: var(--bg-tertiary);
}
.header-btn.active {
    color: var(--accent-primary);
}
.header-btn { /* Dodajemy pozycjonowanie do og贸lnej klasy przycisku */
            position: relative;
        }
        .header-btn.has-notifications {
            color: var(--accent-primary) !important; /* Wymu niebieski kolor ikony */
        }
        /* === NOWA REGUA: Kolor ikony czatu z nowymi wiadomociami === */
        .header-btn.has-unread {
            color: var(--accent-primary) !important; /* Wymu niebieski kolor ikony */
        }
        .notification-badge {
            position: absolute;
            top: 2px;
            right: 2px;
            background-color: var(--danger-primary);
            color: white;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            font-size: 10px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid var(--bg-secondary);
        }
        #notifications-modal .modal {
            max-width: 500px;
            height: 70vh; /* Dostosowanie wysokoci dla listy */
        }
        .notifications-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .notification-item {
            display: flex;
            gap: 12px;
            padding: 12px 8px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .notification-item:hover {
            background-color: var(--bg-tertiary);
        }
        .notification-item.is-read {
            opacity: 0.6;
        }
        .notification-icon {
            flex-shrink: 0;
            width: 24px;
            height: 24px;
            margin-top: 2px;
        }
        .notification-content p {
            margin: 0;
            font-size: 14px;
            line-height: 1.4;
        }
        .notification-content .notification-time {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 4px;
        }
        /* === STYLE DLA HISTORII ZGOSZE === */
        .support-ticket-item {
            background-color: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 12px 16px;
            margin-bottom: 10px;
            transition: background-color 0.2s;
        }
        .support-ticket-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }
        .support-ticket-subject {
            font-weight: 600;
            font-size: 14px;
            color: var(--text-primary);
        }
        .support-ticket-date {
            font-size: 11px;
            color: var(--text-secondary);
        }
        .support-ticket-message {
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.4;
            /* Ograniczenie do 2 linii */
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden; 
        }
        .support-ticket-status {
            font-size: 10px;
            text-transform: uppercase;
            padding: 2px 6px;
            border-radius: 4px;
            background-color: var(--bg-tertiary);
            color: var(--text-secondary);
            margin-left: 8px;
        }
.header-btn svg {
    width: 22px;
    height: 22px;
}
        #toggle-chat-btn svg {
            width: 32px;  /* 2x powikszenie (z 22px) */
            height: 32px; /* 2x powikszenie (z 22px) */
            transform: translateY(2px);
        }
        /* === NOWA REGUA DLA IKONY MOBILNEJ === */
        #toggle-chat-btn-mobile svg {
            width: 32px;  /* 2x powikszenie (z 22px) */
            height: 32px; /* 2x powikszenie (z 22px) */
            transform: translateY(2px);
        }
        /* === KONIEC NOWEJ REGUY === */
        .sort-btn {
             display: flex;
             align-items: center;
             padding: 6px 8px;
             border: 1px solid var(--border-color); /* <--- DODANO domyln ramk */
             border-radius: var(--border-radius);
             background-color: transparent; /* <--- ZMIENIONO to na przezroczyste */
             color: var(--text-secondary);
             font-weight: 500;
             cursor: pointer;
             transition: background-color 0.2s, color 0.2s, border-color 0.2s; /* Dodano transition dla hover */
        }
        /* === NOWY STYL DLA IKONY SVG W PRZYCISKU SORTOWANIA === */
        .sort-btn svg {
            width: 16px;  /* Dopasowanie rozmiaru do innych ikon */
            height: 16px;
            /* Kolor dziedziczony z .sort-btn (color) */
        }
        /* === KONIEC NOWEGO STYLU === */

        /* Dodajmy te偶 styl hover dla sp贸jnoci */
        .sort-btn:hover {
            background-color: var(--bg-tertiary);
            border-color: var(--bg-tertiary); /* Mo偶na zmieni kolor ramki przy hover */
        }

        
        /* === KONIEC NOWYCH STYLI === */
        .theme-switcher { display: flex; align-items: center; background-color: var(--bg-tertiary); padding: 4px; border-radius: 20px; }
        .theme-switcher button { background: none; border: none; padding: 6px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; color: var(--text-secondary); }
        .theme-switcher button.active { background-color: var(--bg-secondary); color: var(--accent-primary); box-shadow: var(--shadow-sm); }
        .theme-switcher svg { width: 18px; height: 18px; }
        .kanban-board { 
            display: flex; 
            gap: 6px; 
            flex-grow: 1; 
            overflow-x: auto; 
            overflow-y: visible; 
            min-height: 0; 
            
            /* ZMIANA 1: Ustawienie min-width: 100% zmusza kontener do rozszerzania si poza granice widoku, gdy kolumny si nie mieszcz. */
            min-width: 100%; 
            width: 100%; /* Upewnia, 偶e zajmuje pocztkowe 100% */
            
            flex-wrap: nowrap; 
            padding-bottom: 16px; 
        }
        
        /* ZMIANA KRYTYCZNA: Nadpisanie dla widok贸w, kt贸re maj zajmowa ca szeroko i nie scrollowa poziomo */
        .my-day-view, .dashboard-view {
             flex-wrap: wrap; /* Zezw贸l na zawijanie (domylnie niepotrzebne, ale bezpieczne) */
             min-width: 0;    /* Nie wymuszaj minimalnej szerokoci */
             overflow-x: hidden; /* Usu przewijanie poziome */
             padding-bottom: 0; /* Usu dolny padding kanban (by nie przeszkadza w centrowaniu) */
        }
       /* === NOWA REGUA: CIENIE BOCZNE (FADE EFFECT) === */
        
        /* 1. Cie na PRAWEJ krawdzi (element ::after) */
        .kanban-board::after {
            content: "";
            position: absolute;
            top: 0;
            right: 0;
            height: calc(100% - 16px); /* Zostaw miejsce na pasek poziomy (padding-bottom: 16px) */
            width: 40px; /* Szeroko cienia */
            pointer-events: none; /* KLUCZOWE: Umo偶liwia klikanie na kolumny pod spodem */
            transition: opacity 0.3s ease-in-out;
            
            /* Gradient: Od przezroczystego do koloru ta aplikacji */
            background: linear-gradient(to left, 
                var(--bg-primary) 0%,        /* Mocniejsze wtopienie w kolor ta (prawo) */
                rgba(0, 0, 0, 0.4) 5%,       /* MOCNY CIENIE (5%) */
                rgba(0, 0, 0, 0) 100%        /* Cakowita przezroczysto */
            );
            
            opacity: 1; /* Domylnie widoczny */
            z-index: 10;
        }
        
        /* 2. Cie na LEWEJ krawdzi (element ::before) */
        .kanban-board::before {
             content: "";
             position: absolute;
             top: 0;
             left: 0;
             height: calc(100% - 16px); /* Zostaw miejsce na pasek poziomy */
             width: 40px;
             pointer-events: none;
             transition: opacity 0.3s ease-in-out;
             
             /* Gradient: Od koloru ta aplikacji do przezroczystego */
             background: linear-gradient(to right, 
                var(--bg-primary) 0%,        /* Mocniejsze wtopienie w kolor ta (lewo) */
                rgba(0, 0, 0, 0.4) 5%,       /* MOCNY CIENIE (5%) */
                rgba(0, 0, 0, 0) 100%        /* Cakowita przezroczysto */
             );
             
             opacity: 0; /* Domylnie ukryty, pokazywany przy przewiniciu */
             z-index: 10;
        }

        /* KLASA DLA UKRYCIA PRAWEGO CIENIA (gdy przewinito do koca) */
        .kanban-board.fade-end::after {
            opacity: 0;
        }
        
        /* KLASA DLA POKAZANIA LEWEGO CIENIA (gdy przewinito W PRAWO) */
        /* Ten cie powinien by widoczny ZAWSZE, gdy scrollLeft > 0 */
        .kanban-board.fade-start::before {
            opacity: 1;
        }

        /* KLASA DLA UKRYCIA LEWEGO CIENIA (gdy scrollLeft jest 0) */
        /* To jest kluczowe, aby cie znikn na pozycji pocztkowej */
        .kanban-board:not(.fade-start)::before {
             opacity: 0;
        }
        /* === KONIEC NOWEJ REGUY === */
        /* === NOWE STYLE DLA MINI-KANBAN NA DASHBOARDZIE === */
        .kanban-board-mini {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            padding-bottom: 2px !important; 
        }
        
        /* 1. Ustawiamy sztywn wysoko dla KOLUMNY */
        .kanban-board-mini .kanban-column {
            height: 95vh; /* ZMIANA: Zwikszono z 70vh na 85vh (bardzo dugie kolumny) */
            min-height: 700px; /* ZMIANA: Zwikszono minimum, 偶eby na du偶ych monitorach te偶 byy dugie */
            display: flex;
            flex-direction: column;
        }
        /* 2. Lista zada wypenia ca kolumn (a偶 do dou) */
        .kanban-board-mini .kanban-tasks {
            flex-grow: 1; /* Rozcignij si, by wypeni kolumn */
            max-height: none; /* Usuwamy stare ograniczenie, teraz decyduje rodzic (.kanban-column) */
            overflow-y: auto; /* Scrolluj wewntrz, jeli zada jest wicej ni偶 70vh */
            min-height: 0;
            
            /* Stylizacja paska wewntrz kolumny (dla Firefoxa) */
            scrollbar-width: thin;
            scrollbar-color: var(--border-color) transparent;
        }

        /* Stylizacja paska wewntrz kolumny (dla Webkit - Chrome, Edge, Safari) */
        .kanban-board-mini .kanban-tasks::-webkit-scrollbar {
            width: 6px;
        }
        .kanban-board-mini .kanban-tasks::-webkit-scrollbar-thumb {
            background-color: var(--border-color);
            border-radius: 3px;
        }
        /* === KONIEC NOWYCH STYLI === */
        /* === POCZTEK NOWEJ REGUY DLA DASHBOARDU === */
        .dashboard-view,
        .my-day-view {
             /* Ustawia elastyczny kontener wewntrz main-content */
             display: flex;
             flex-direction: column;
             flex-grow: 1; 
             /* ZMIANA: Dodajemy 100% szerokoci i reset margines贸w */
             width: 100%; 
             margin: 0;
             
             /* ZMIANA: Zmniejszono padding z 300px na 24px, aby usun pust przestrze */
             padding: 0 0 24px 0; 
             
             min-height: 0; 
        }
        /* KONIEC NOWEGO KODU */
        /* === KONIEC NOWEJ REGUY DLA DASHBOARDU === */

       .kanban-column { 
            background-color: var(--bg-tertiary); 
            border-radius: var(--border-radius); 
            padding: 12px; 
            display: flex; 
            flex-direction: column; 
            max-height: 100%; 
            
            /* KLUCZOWA ZMIANA: flex: 1 0 450px */
            flex: 1 0 450px; /* ZMIANA: Zezwala na ROZCIGANIE (flex-grow: 1) */
            
            /* USUNITO: width: 450px; */
            
            min-width: 450px; /* Dodatkowe zabezpieczenie minimalnej szerokoci */
            max-width: 100%; 
        }
        .kanban-column-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; padding: 0 4px; gap: 8px; }
        .kanban-column-header h3 { font-size: 14px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-secondary); white-space: nowrap; }
        .task-count { font-size: 12px; font-weight: 600; background-color: var(--border-color); color: var(--text-secondary); padding: 2px 8px; border-radius: 10px; margin-left: auto; user-select: none; cursor: default; }
        /* === NOWA REGUA: Ustawienie kursora i stylu dla sumy wysiku === */
        .task-estimation-sum {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            padding: 2px 8px;
            border-radius: 10px;
            background-color: var(--bg-primary); /* Lepsze dopasowanie do ta */
            user-select: none;
            cursor: default;
        }
        /* === POCZTEK NOWEGO KODU: Style zwijania kolumn === */
        .kanban-column {
            transition: width 0.3s ease-in-out, min-width 0.3s ease-in-out; /* Animacja zwijania */
            
            /* USUNITO: min-width: 320px; */
            /* USUNITO: width: 320px; */
            
            /* Wyjanienie: Usunlimy sta szeroko 320px. 
               Teraz kolumna automatycznie pobierze szeroko 360px 
               z reguy .kanban-board (grid-auto-columns: 360px), 
               co naprawia problem szerokoci i przewijania. */
        }
        
        .collapse-column-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px;
            color: var(--text-secondary);
            margin-left: 8px; /* Odstp od tytuu */
            transition: transform 0.3s ease-in-out;
        }
        .collapse-column-btn svg {
            width: 18px;
            height: 18px;
        }

       /* Stan zwinity */
        /* Stan zwinity */
        .kanban-column.collapsed {
            width: 40px; 
            min-width: 40px; 
            max-width: 40px;
            
            flex-shrink: 0;
            flex-basis: 40px; /* <<< DODANO: Zapewnia, 偶e kolumna zajmuje tylko 40px, gdy jest zwinita */
            
            background-color: var(--bg-primary); 
        }
        .kanban-column.collapsed .kanban-column-header {
            /* USUNITO: writing-mode: vertical-rl; */
            /* USUNITO: transform: rotate(180deg); */
            flex-direction: column; /* ZMIANA: Ustawiamy ukad pionowy */
            justify-content: space-between; /* ZMIANA: Rozsuwamy tytu na g贸r, przycisk na d贸 */
            align-items: center; /* ZMIANA: Centrujemy w poziomie (w osi 40px) */
            padding: 16px 0; /* ZMIANA: 16px odstpu na g贸rze i dole */
            height: 100%; /* << TUTAJ BYA ZMIANA, kt贸ra dziaaa, ale jest ukryta */
            cursor: pointer;
        }
        
        .kanban-column.collapsed .kanban-column-header h3 {
            writing-mode: vertical-rl; /* ZMIANA: Przeniesiono styl do samego tekstu */
            transform: rotate(180deg); /* ZMIANA: Obracamy tekst, aby czyta si od dou do g贸ry */
            padding-bottom: 0; /* ZMIANA: Usuwamy stary padding */
            white-space: nowrap;
            margin-top: 8px; /* ZMIANA: Odstp od g贸ry */
        }

        /* Obr贸 przycisk zwijania */
        .kanban-column.collapsed .collapse-column-btn {
            transform: rotate(180deg); /* Obraca lewy chevron (z KROKU 1) w prawy */
            margin: 0;
            padding: 4px; /* ZMIANA: Przywracamy padding dla klikalnoci */
            margin-bottom: 8px; /* ZMIANA: Odstp od dou */
        }
        
        /* Ukryj ca reszt w nag贸wku (filtry, przycisk +) */
        .kanban-column.collapsed .completed-tasks-filter,
        .kanban-column.collapsed .add-task-icon-btn {
            display: none;
        }

        /* === POPRAWKA DLA ZWINITEJ KOLUMNY (Licznik zada na rodku, godziny ukryte) === */
        
        /* 1. Kontener licznik贸w w zwinitej kolumnie */
        .kanban-column.collapsed .kanban-header-counts {
            display: flex; 
            flex-direction: column; 
            align-items: center; /* Centrowanie w poziomie */
            justify-content: center;
            margin: 0; 
            order: -1; /* Przesunicie na sam g贸r kolumny (nad pionowy tekst) */
            padding-bottom: 8px; 
            width: 100%; 
        }

        /* 2. Licznik zada - widoczny, wyrodkowany */
        .kanban-column.collapsed .task-count {
            margin: 0 auto !important; /* Wymu wyrodkowanie */
            padding: 2px 5px;          /* Optymalny padding */
            font-size: 11px;           /* Czytelny rozmiar, ale mniejszy ni偶 standardowo */
            line-height: 1;
            max-width: 100%;
            width: auto;
            display: inline-block;
        }

        /* 3. Licznik godzin/wysiku - CAKOWICIE UKRYTY */
        .kanban-column.collapsed .task-estimation-sum {
            display: none !important;
        }
        /* === KONIEC POPRAWKI === */
        /* Ukryj list zada */
        .kanban-column.collapsed .kanban-tasks {
            display: none;
        }
        /* === KONIEC NOWEGO KODU === */
        .kanban-tasks { list-style: none; flex-grow: 1; overflow-y: auto; padding-right: 4px; }
        .kanban-tasks::-webkit-scrollbar { width: 6px; }
        .kanban-tasks::-webkit-scrollbar-thumb { background-color: var(--border-color); border-radius: 3px; }
         /* --- ZMIANA: .task-card jest teraz tylko logicznym kontenerem (przezroczystym) --- */
         .task-card {
            background-color: transparent; /* To przezroczyste */
            border: none;                 /* Brak ramki */
            box-shadow: none;             /* Brak cienia */
            padding: 0;                   /* Brak paddingu */
            margin-bottom: 4px;           /* Odstp midzy rodzinami zada */
            position: relative;
            cursor: default;              /* Kursor domylny na kontenerze */
            transition: all 0.2s;
         }

         /* --- NOWA KLASA: To jest teraz wizualny "biay kafelek" g贸wnego zadania --- */
         .task-card-main-content,
         .my-day-task-item { 
            background-color: var(--bg-secondary);
            border-radius: var(--border-radius);
            padding: 12px; 
            box-shadow: var(--shadow-sm);
            cursor: pointer; /* Kursor apki tylko na kafelku */
            position: relative;
            border: 1px solid var(--accent-primary);
            z-index: 2; /* Wa偶ne: musi by nad lini czc */
         }
         
         /* Przeniesienie styli priorytet贸w na wewntrzny content */
         .task-card-main-content.priority-high {
            border-top: 4px solid var(--priority-high-border);
            padding-top: 8px; 
        }
        .task-card-main-content.priority-low {
             border-top: 6px solid var(--priority-low-border);
             padding-top: 6px; 
        }
        
        /* Hover dziaa na wewntrzny element */
        .task-card-main-content:hover { box-shadow: var(--shadow-md); }
        
        /* Style drag & drop */
        .task-card.dragging .task-card-main-content { opacity: 0.5; transform: rotate(3deg); }
        /* === NOWA REGUA: Ukrywanie podzada podczas przenoszenia rodzica === */
        /* To sprawia, 偶e placeholder na licie zajmuje tylko tyle miejsca co karta g贸wna */
        .task-card.dragging .subtask-family-container, 
        .task-card.dragging .kanban-subtask-list-container,
        .task-card-drag .subtask-family-container, 
        .task-card-drag .kanban-subtask-list-container {
             display: none !important;
        }
        /* === KONIEC === */

        /* --- NOWE STYLE DLA DRZEWA PODZADA --- */
        
        /* Kontener na rodzin podzada */
        /* --- NOWE STYLE DLA PODZADA (BEZ LINII) --- */
        
        /* Kontener na rodzin podzada */
        .subtask-family-container {
            /* Wcicie od lewej krawdzi, aby zachowa hierarchi wizualn */
            margin-left: 32px; 
            
            /* USUNITO PADDING I OBRAMOWANIE (LINIE) */
            padding-left: 0; 
            border-left: none; 
            
            background: transparent !important;
            margin-top: 0;
            padding-top: 2px;
            padding-bottom: 2px;
        }

        /* Wizualny kafelek podzadania */
        .subtask-visual-card {
            position: relative;
            background-color: var(--bg-secondary); 
            border-radius: var(--border-radius);
            
            /* Kompaktowe wntrze */
            padding: 6px 10px; 
            
            /* Minimalny odstp midzy kafelkami */
            margin-bottom: 1px; 
            /* Dodatkowy margines g贸ry dla pierwszego elementu */
            margin-top: 1px;
            
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
            cursor: pointer;
            
            opacity: 0.85; 
            transition: all 0.2s;
            z-index: 1; 
        }
        
        /* USUNICIE POZIOMEJ LINII */
        .subtask-visual-card::before {
            content: none !important;
            display: none !important;
        }

        /* ZABEZPIECZENIE: Usuwamy inne pseudoelementy */
        .subtask-visual-card::after {
            content: none !important;
            display: none !important;
        }

        /* Efekt po najechaniu myszk */
        .subtask-visual-card:hover {
            opacity: 1; 
            transform: translateX(2px); 
            box-shadow: var(--shadow-md);
            border-color: var(--accent-primary); 
            z-index: 10;
        }

        /* Styl przekrelenia dla ukoczonych */
        .subtask-visual-card.completed h5 {
            text-decoration: line-through;
            color: var(--text-secondary);
        }

        /* Checkbox w podzadaniu */
        .subtask-visual-card .subtask-card-checkbox {
            position: absolute;
            left: 8px;
            top: 8px;
            width: 14px;
            height: 14px;
            cursor: pointer;
        }
        
        /* Tytu podzadania */
        .subtask-visual-card h5 {
            font-size: 13px;
            font-weight: 600;
            margin: 0 0 4px 0;
            padding-left: 20px;
            color: var(--text-primary);
            line-height: 1.2;
        }

        /* Ikony w podzadaniu */
        .subtask-visual-icons {
            display: flex;
            justify-content: flex-end;
            gap: 4px;
            margin-bottom: 2px;
            padding-left: 20px;
        }

        /* Stopka podzadania */
        .subtask-visual-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-left: 20px;
            font-size: 10px;
            color: var(--text-secondary);
        }

         /* === NOWA REGUA: Karta z dwoma rzdami ikon (Unikanie nakadania awatar贸w) === */
         .task-card.has-double-row-icons {
            min-height: 120px; /* Zwikszono do 120px dla pewnoci */
            display: flex;
            flex-direction: column;
            /* justify-content: space-between; <--- USUNITE, margin-top: auto dziaa lepiej */
         }
         
         /* Wymu, aby stopka kafelka (data, awatary) zawsze bya na samym dole */
         .task-card.has-double-row-icons .task-meta {
            margin-top: auto; 
         }
         /* === KONIEC NOWEJ REGUY === */

         /* === NOWA REGUA: Przywr贸cenie paddingu dla M贸j Dzie === */
         .my-day-task-item {
            padding-left: 36px;
         }
         /* === KONIEC NOWEJ REGUY === */
       .task-card.priority-high {
            border-top: 4px solid var(--priority-high-border);
            padding-top: 8px; /* Zmniejszamy g贸rny padding, bo ramka zajmuje miejsce */
        }
        /* === NOWA REGUA DLA NISKIEGO PRIORYTETU === */
        .task-card.priority-low {
             border-top: 6px solid var(--priority-low-border);
             padding-top: 6px; /* Dopasowanie do ramki 6px */
        }
        .task-card:hover { box-shadow: var(--shadow-md); }
        .task-card.dragging { opacity: 0.5; transform: rotate(3deg); }
        .task-card-checkbox { position: absolute; left: 12px; top: 14px; width: 18px; height: 18px; cursor: pointer; }
        .task-project-name { font-size: 11px; font-weight: 600; color: var(--text-secondary); margin-bottom: 4px; display: block; padding-left: 24px; /* <<< DODANA LINIA */ }
        .task-card h4 { 
            padding-left: 24px;
            font-size: 15px; 
            font-weight: 600; 
            margin-bottom: 4px; /* Zmniejszamy margines dolny, bo zaraz pod nim bd ikony */
            /* === NOWE REGUY SKRACANIA TEKSTU (DLA ZADA) === */
            /* Zezwalamy na zawijanie tekstu, skoro mamy cay wiersz */
            white-space: normal; 
            word-break: break-word;
            /* Resetujemy max-width, bo nic nie blokuje prawej strony */
            display: block; 
            max-width: 100%; 
            padding-right: 8px;
        }
        .task-card.completed h4 { text-decoration: line-through; color: var(--text-secondary); }
        .task-meta { display: flex; justify-content: space-between; align-items: flex-end; }
        .task-details { display: block; } /* ZMIANA: z flex na block, aby daty ukaday si wierszami */
        .task-detail { display: flex; align-items: center; gap: 4px; font-size: 12px; color: var(--text-secondary); }
        /* === NOWA REGUA: Dodaje odstp 4px midzy datami, jeli s jedna pod drug === */
        .task-details .task-detail { 
            margin-bottom: 4px; 
        }
        .task-details .task-detail:last-child {
            margin-bottom: 0; /* Usuwa margines z ostatniego elementu (daty zakoczenia) */
        }
        /* === KONIEC NOWEJ REGUY === */
        .task-detail svg { width: 15px; height: 15px; }
        .task-assignees { display: flex; }
        .task-assignees .avatar { width: 24px; height: 24px; font-size: 12px; border-color: var(--bg-tertiary); }
        /* NOWY STYL: Ikona bud偶etu - Powikszenie dla kafelk贸w i zakadek */
        /* U偶ywamy dedykowanych klas dla powikszenia ikony bud偶etu */
        .task-detail-budget { /* DODANA REGUA DLA PRZESUNICIA */
             transform: translateY(-2px); /* Przesunicie caego kontenera ikony w g贸r o 2px */
        }
        .task-detail-budget svg, /* dla kafelka zadania */
        .task-modal-tab#task-tab-taskBudget svg, /* dla zakadki Edycji */
        .task-modal-tab#new-task-tab-taskBudget svg { /* dla zakadki Dodawania */
             width: 32px !important;
             height: 32px !important;
        }
        /* NOWA REGUA: Powikszenie pozostaych ikon w rogu kafelka do 20px */
        .task-card-icons .task-detail svg {
             width: 18px;
             height: 18px;
        }
        /* NOWY STYL: Ikona cyklicznoci */
        .task-detail.recurring svg { color: var(--accent-primary); }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--bg-overlay); display: flex; align-items: center; justify-content: center; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; z-index: 1000; }
        /* NOWA REGUA: Podnosimy z-index dla modal贸w, kt贸re maj wywietla si na wierzchu innych modal贸w. */
        #confirmation-modal {
             z-index: 1010; /* Ustawiamy wy偶sz warto ni偶 1000 */
        }
        #transfer-ownership-modal {
             z-index: 1010; /* R贸wnie偶 dla tego, by obsu偶y przypadek przekazywania wasnoci */
        }
        #notification-modal { /* NOWA REGUA DLA POWIADOMIE */
             z-index: 1015; /* Powiadomienia s na wierzchu modali 1010 */
        }
        /* KONIEC NOWYCH REGU */
        .modal-overlay.visible { opacity: 1; visibility: visible; }
          .modal { background-color: var(--bg-secondary); border-radius: var(--border-radius); box-shadow: var(--shadow-lg); width: 90%; max-width: 800px; display: flex; flex-direction: column; transform: scale(0.95); transition: transform 0.3s; height: 80vh; max-height: 90vh; }
        /* === MODYFIKACJA: Dodano #settings-modal .modal oraz height: auto === */
        #notification-modal .modal, 
        #confirmation-modal .modal, 
        #change-password-modal .modal,
        #settings-modal .modal { 
            max-width: 420px; /* Zwikszyem lekko max-width, aby pasowao do tego z HTML */
            height: auto; /* <-- KLUCZOWA ZMIANA: Pozw贸l modalowi dopasowa wysoko */
            max-height: 90vh; /* <-- ZACHOWANE: Jako zabezpieczenie */
        }
        /* === KONIEC MODYFIKACJI === */
        /* NOWA REGUA: Dodajemy max-width dla modala edycji szablonu i resetujemy wysoko do auto dla centrowania */
        #template-edit-modal .modal { 
            max-width: 600px; 
            height: auto; 
            max-height: 90vh;
        } 
        /* === POCZTEK: NOWE STYLE DLA MODALA SZCZEGW PROJEKTU === */
        #project-details-modal .form-modal-content {
            grid-template-columns: 1fr; /* Domylnie jedna kolumna */
        }

        /* Ukad dwukolumnowy dla wikszych ekran贸w */
        @media (min-width: 768px) {
            #project-details-modal .form-modal-content {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        .modal-overlay.visible .modal { transform: scale(1); }
        
        /* === NOWE: Poszerzenie okien projektu (dla widoku 2-kolumnowego) === */
        #new-project-modal .modal,
        #edit-project-modal .modal {
            max-width: 1100px; /* Zwikszono szeroko tylko dla tych dw贸ch okien */
            width: 95%; /* Responsywne zabezpieczenie */
        }
        /* === KONIEC ZMIANY === */

        /* === NOWE: Sztywne wymiary dla GWNEGO okna zadania === */
       body #task-modal .modal {
            width: 1000px !important; 
            max-width: 98vw !important; /* Lekko szersze zabezpieczenie */
            
            /* Wymuszamy wysoko na 95% ekranu */
            height: 95vh !important; 
            max-height: 98vh !important;
            
            /* Zapewniamy poprawny ukad wewntrzny */
            display: flex !important;
            flex-direction: column !important;
        }
        /* === KONIEC === */
        .modal-header { padding: 16px 24px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
        .modal-header h2 { font-size: 18px; }
        .modal-close-btn { background: none; border: none; cursor: pointer; color: var(--text-secondary); padding: 4px; font-size: 24px; line-height: 1; }
        .modal-close-btn:hover { color: var(--text-primary); }
        .task-modal-content { 
            display: flex; 
            flex-direction: column; 
            overflow: hidden; 
            height: 100%; /* WA呕NE: Wymusza, aby flexbox zaj ca wysoko modala */
        }
        .task-modal-main { 
            flex-shrink: 0; 
            padding: 24px;
            padding-bottom: 0; /* ZMIANA: Usuwamy dolny padding, bo nie jest ju偶 potrzebny */
        }
        
        /* === POCZTEK NOWYCH I POPRAWIONYCH STYLI DLA ZAKADEK === */

        /* Nowy wrapper, kt贸ry zajmie ca pozosta przestrze */
        .task-modal-interactive-area {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden; /* Zapobiega "wypychaniu" element贸w poza modal */
            min-height: 0; /* Kluczowa poprawka dla zagnie偶d偶onego flexboxa */
        }

        .task-modal-tabs {
            display: flex;
            /* gap: 8px; */ /* <<< USUNITE */
            padding: 0 24px 16px 24px;
            border-bottom: 1px solid var(--border-color);
            /* flex-wrap: nowrap; */ /* <<< USUNITE */
            flex-shrink: 0; 
            align-items: center; 
            justify-content: space-between; /* <<< DODANE: Rozdziela wrapper ikon od przycisku */
        }
        
        /* === NOWA REGUA: Wrapper dla ikon zakadek === */
        .task-modal-tabs-wrapper {
            display: flex;
            gap: 8px; /* Przeniesione z .task-modal-tabs */
            flex-wrap: nowrap; /* Zapobiega zawijaniu si samych ikon */
            overflow-x: auto; /* Dodaje przewijanie dla ikon, jeli si nie mieszcz */
            overflow-y: hidden;
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
        .task-modal-tabs-wrapper::-webkit-scrollbar {
            display: none; /* Chrome, Safari, Opera */
        }
        /* === KONIEC NOWEJ REGUY === */
        .task-modal-tab {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            border-radius: var(--border-radius);
            background: none;
            border: 1px solid transparent;
            cursor: pointer;
            font-size: 14px;
            /* KLUCZOWA ZMIANA: Reset pozycjonowania i margin */
            position: relative;
            margin: 0 !important;
            font-weight: 500;
            color: var(--text-secondary);
            transition: background-color 0.2s, color 0.2s, transform 0.2s; /* DODANO: transition dla transformacji */
        }
        .task-modal-tab:hover {
            background-color: var(--bg-tertiary);
            color: var(--text-primary);
            transform: scale(1.1); /* DODANO: Powikszenie przycisku po najechaniu */
        }
        
        /* NOWA REGUA: Ukrywamy tekst wewntrz przycisku */
        .task-modal-tab span {
            display: none;
        }
        .task-modal-tab.active {
            background-color: var(--accent-primary);
            color: var(--text-on-accent);
        }
        .task-modal-tab svg {
            width: 18px;
            height: 18px;
        }
        /* === NOWA REGUA: Styl dla przycisku "Wybierz banner" w pasku zakadek === */
        #open-cover-gallery-btn,
        #new-task-open-cover-gallery-btn {
            background-color: var(--accent-primary);
            color: var(--text-on-accent);
            padding: 8px 12px;
            font-size: 14px;
            font-weight: 500;
            border-radius: var(--border-radius);
            cursor: pointer;
            border: none;
            /* margin-left: auto; */ /* <<< USUNITE */
            transition: background-color 0.2s;
            white-space: nowrap; /* Zapobiega amaniu tekstu */
            flex-shrink: 0; /* <<< DODANE: Zapobiega kurczeniu si przycisku */
        }
        #open-cover-gallery-btn:hover,
        #new-task-open-cover-gallery-btn:hover {
            background-color: var(--accent-hover);
        }
        
        /* === DODANA REGUA: Styl dla przycisku w trybie "Usu szablon" === */
        #open-cover-gallery-btn.is-danger-btn,
        #new-task-open-cover-gallery-btn.is-danger-btn {
            background-color: var(--danger-primary);
        }
        #open-cover-gallery-btn.is-danger-btn:hover,
        #new-task-open-cover-gallery-btn.is-danger-btn:hover {
            background-color: var(--danger-hover);
        }
        /* === KONIEC DODANEJ REGUY === */
        /* Ten kontener rozciga si i dostaje wasny pasek przewijania */
        .task-modal-tabs-content {
            padding: 24px;
            background-color: var(--bg-primary);
            overflow-y: auto; 
            flex-grow: 1;
        }
        .task-modal-tab-content {
            display: none; 
        }
        .task-modal-tab-content.active {
            display: block; 
        }
        .task-modal-tab-content label {
            display: block;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }
        .task-modal-tab-content select, 
        .task-modal-tab-content input {
            width: 100%;
            padding: 8px;
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
            background-color: var(--bg-secondary);
            color: var(--text-primary);
        }
        .task-modal-title { display: flex; align-items: flex-start; gap: 12px; margin-bottom: 16px; }
        .task-modal-title input[type="checkbox"] { margin-top: 8px; width: 18px; height: 18px; }
        .task-modal-title h3 { font-size: 22px; font-weight: 600; }
        .task-modal-section { margin-bottom: 24px; }
        .task-modal-section h4 { font-size: 14px; font-weight: 600; color: var(--text-secondary); margin-bottom: 8px; }
        .task-modal-section .activity-list {
            max-height: 200px;
        }
        #tab-content-description.active {
                display: flex;
                height: 100%;
            }
            #tab-content-description textarea { width: 100%; flex-grow: 1; padding: 8px; border-radius: var(--border-radius); border: 1px solid var(--border-color); background-color: var(--bg-primary); font-family: var(--font-family); font-size: 14px; resize: vertical; }
            
            /* === POCZTEK NOWEGO KODU: Rozcignicie pola opisu w "Dodaj nowe zadanie" === */
            #tab-new-task-description.active {
                display: flex;
                flex-direction: column; /* Upewnij si, 偶e jest to kolumna */
                height: 100%; /* Wypenij wysoko kontenera .task-modal-tabs-content */
            }
            #tab-new-task-description textarea {
                width: 100%;
                flex-grow: 1; /* Pozw贸l textarea rosn, aby wypeni przestrze */
                /* Nadpisz atrybut rows="6" z HTML */
                height: 100%; 
                padding: 8px; /* Dodajemy padding, kt贸ry jest zdefiniowany w klasie .form-group textarea */
                border-radius: var(--border-radius);
                border: 1px solid var(--border-color);
                background-color: var(--bg-primary);
                font-family: var(--font-family);
                font-size: 14px;
                resize: vertical; /* Pozw贸l na rczn zmian rozmiaru, jeli potrzeba */
            }
            /* === KONIEC NOWEGO KODU === */

        .completion-status-item { display: flex; align-items: center; justify-content: space-between; padding: 8px; border-radius: var(--border-radius); transition: background-color 0.2s; }
        .completion-status-item:hover { background-color: var(--bg-tertiary); }
        .completion-status-item .user-info { display: flex; align-items: center; gap: 8px; }
        .completion-status-item .user-info .avatar { width: 28px; height: 28px; font-size: 12px; margin: 0; }
        .completion-status-item .status-indicator { font-size: 12px; font-weight: 600; padding: 2px 8px; border-radius: 12px; }
        .completion-status-item .status-indicator.done { background-color: var(--success-primary); color: white; }
        .completion-status-item .status-indicator.pending { background-color: var(--border-color); color: var(--text-secondary); }
        .sidebar-detail { margin-bottom: 16px; }
        .sidebar-detail label { display: block; font-size: 12px; font-weight: 600; color: var(--text-secondary); margin-bottom: 4px; }
        .sidebar-detail select, .sidebar-detail input { width: 100%; padding: 8px; border-radius: var(--border-radius); border: 1px solid var(--border-color); background-color: var(--bg-secondary); color: var(--text-primary); }
        .form-modal-content { padding: 24px; overflow-y: auto; flex-grow: 1; }
        .form-group { margin-bottom: 16px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 500; }
        .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 10px; border-radius: var(--border-radius); border: 1px solid var(--border-color); background-color: var(--bg-primary); font-family: var(--font-family); font-size: 14px; color: var(--text-primary); }
        .form-group textarea { resize: vertical; }
        /* NOWY STYL: Kontener dla opcji cyklicznoci */
        .recurrence-options {
            background-color: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 12px;
            margin-top: 8px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .form-group-checkbox {
            display: flex;
            align-items: center;
            gap: 12px; /* Zwikszono odstp z 8px na 12px */
        }
        .form-group-checkbox input[type="checkbox"] {
            width: auto;
        }
        .form-group-checkbox label {
            margin-bottom: 0;
            font-weight: normal;
        }

        .task-type-selection { display: flex; gap: 10px; margin-bottom: 16px; }
        .task-type-selection label { flex: 1; padding: 10px; border: 1px solid var(--border-color); border-radius: var(--border-radius); text-align: center; cursor: pointer; }
        .task-type-selection input { display: none; }
        .task-type-selection input:checked + label { background-color: var(--accent-primary); color: white; border-color: var(--accent-primary); }
        
        .members-selection-pills {
    /* Usunlimy display: flex i flex-wrap, aby elementy ukaday si pionowo */
    gap: 8px;
    background-color: var(--bg-primary);
    padding: 12px;
    border-radius: var(--border-radius);
    max-height: 250px; /* Zwikszamy nieco wysoko dla lepszej nawigacji */
    overflow-y: auto;
}
        .member-pill {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 4px 10px;
            border-radius: 16px;
            background-color: var(--bg-tertiary);
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s, box-shadow 0.2s;
            border: 1px solid var(--border-color);
        }
        .member-pill:hover {
            box-shadow: var(--shadow-sm);
            border-color: var(--accent-hover);
        }
        .member-pill.selected {
            background-color: var(--accent-primary);
            color: var(--text-on-accent);
            border-color: var(--accent-primary);
        }
        .member-pill.disabled {
            cursor: not-allowed;
            opacity: 0.7;
            background-color: var(--bg-tertiary);
            color: var(--text-secondary);
        }
        .member-pill-avatar {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: 600;
            color: var(--text-on-accent);
        }
        .member-pill.selected .member-pill-avatar {
             /* Mo偶na doda obram贸wk dla lepszego kontrastu */
            border: 1px solid rgba(255, 255, 255, 0.5);
        }

        /* === NOWE STYLE DLA WYBORU CZONKW (2 KOLUMNY) === */
        .members-dual-view {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            height: 350px; /* Staa wysoko dla obu kolumn */
        }
        
        /* Styl dla kontener贸w wewntrz siatki */
        .members-column {
            display: flex;
            flex-direction: column;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            background-color: var(--bg-primary);
            overflow: hidden;
        }
        
        .members-column-header {
            padding: 8px 12px;
            background-color: var(--bg-tertiary);
            font-weight: 600;
            font-size: 12px;
            color: var(--text-secondary);
            border-bottom: 1px solid var(--border-color);
            text-transform: uppercase;
        }

        .members-scroll-area {
            flex-grow: 1;
            overflow-y: auto;
            padding: 8px;
        }

        /* Prawa kolumna - lista wybranych */
        .selected-member-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            /* ZMIANA: Zwikszono padding z lewej strony z 8px na 12px (lub wicej wg uznania) */
            padding: 6px 8px 6px 12px; 
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            margin-bottom: 6px;
            font-size: 13px;
        }
        
        /* DODATKOWO: Upewnijmy si, 偶e awatar nie ma ujemnego marginesu w tym widoku */
        .selected-member-row .avatar {
            margin-left: 0 !important; /* Resetuje ewentualne style z innych kontekst贸w */
            margin-right: 8px; /* Odstp od tekstu */
        }
        
        .selected-member-info {
            display: flex;
            align-items: center;
            gap: 8px;
            overflow: hidden;
        }
        
        .selected-member-role {
            font-size: 10px;
            padding: 1px 6px;
            border-radius: 10px;
            background-color: var(--bg-tertiary);
            color: var(--text-secondary);
            white-space: nowrap;
            margin-left: 4px;
        }
        
        .selected-member-remove {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 16px;
            padding: 0 4px;
            margin-left: 8px;
        }
        .selected-member-remove:hover {
            color: var(--danger-primary);
        }

        /* === NOWE STYLE: Przyciski r贸l w prawej kolumnie === */
        .role-actions {
            display: flex;
            gap: 4px;
            margin-left: auto; /* Wypycha przyciski na prawo */
            padding-right: 8px;
            border-right: 1px solid var(--border-color);
            margin-right: 8px;
        }

        .role-btn {
            background: none;
            border: 1px solid transparent;
            cursor: pointer;
            padding: 2px;
            border-radius: 4px;
            color: var(--text-secondary);
            opacity: 0.5;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .role-btn:hover {
            background-color: var(--bg-tertiary);
            opacity: 1;
        }

        /* Stan aktywny dla przycisk贸w */
        .role-btn.active {
            opacity: 1;
            background-color: rgba(79, 70, 229, 0.1); /* To akcentu */
            border-color: rgba(79, 70, 229, 0.2);
        }
        
        /* Kolor Korony (Admin) */
        .role-btn.active.is-admin-btn svg {
            color: #f59e0b; /* Bursztyn */
            fill: #f59e0b;
        }
        
        /* Kolor Kwadratu (Super User) */
        .role-btn.active.is-superuser-btn svg {
            color: #f59e0b; 
            stroke: #f59e0b; /* Kolorujemy linie (obrys) na 偶贸to */
            fill: rgba(245, 158, 11, 0.2); /* rodek ikony jest lekko 偶贸ty, ale przezroczysty, 偶eby nie zakrywa detali */
        }

        /* Dodatkowa regua: Zmiana ta przycisku na 偶贸te (nadpisuje domylne niebieskie) */
        .role-btn.active.is-superuser-btn {
            background-color: rgba(245, 158, 11, 0.1); 
            border-color: rgba(245, 158, 11, 0.2);
        }
        /* === KONIEC === */

        @media (max-width: 768px) {
            .members-dual-view {
                grid-template-columns: 1fr; /* Na mobile jedna pod drug */
                height: auto;
            }
            .members-column {
                height: 250px;
            }
        }
        /* === KONIEC NOWYCH STYLI === */

        .member-option { display: flex; align-items: center; gap: 8px; font-size: 14px; padding: 4px; }
        .modal-footer { padding: 16px 24px; border-top: 1px solid var(--border-color); display: flex; justify-content: flex-end; gap: 8px; background-color: var(--bg-secondary); flex-shrink: 0; }
        .btn { padding: 10px 16px; border-radius: var(--border-radius); border: none; cursor: pointer; font-weight: 600; font-size: 14px; }
        .btn-primary { background-color: var(--accent-primary); color: var(--text-on-accent); }
        .btn-danger { background-color: var(--danger-primary); color: var(--text-on-accent); }
        /* NOWA KLASA: Zielony przycisk sukcesu */
        .btn-success { background-color: var(--success-primary); color: var(--text-on-accent); }
        .btn-success:hover { background-color: #15803d; } /* Ciemniejszy zielony na hover */
        /* KONIEC */
        .btn-secondary { background-color: var(--bg-tertiary); color: var(--text-primary); }
        .modal form {
    display: flex;
    flex-direction: column;
    height: 100%;
    overflow: hidden;
}
        .confetti-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9999; overflow: hidden; }
        .confetti { position: absolute; width: 8px; height: 16px; background: #f00; opacity: 0; animation: fall 4s linear forwards; }
        @keyframes fall { 0% { transform: translateY(-10vh) rotateZ(0deg); opacity: 1; } 100% { transform: translateY(110vh) rotateZ(720deg); opacity: 0; } }
        .search-results-list { list-style: none; max-height: 50vh; overflow-y: auto; }
        .search-result-item:last-child { border-bottom: none; }
        .search-result-item:hover { background-color: var(--bg-tertiary); }
        .search-result-item h4 { font-size: 15px; font-weight: 600; margin-bottom: 4px; }
        .search-result-item p { font-size: 12px; color: var(--text-secondary); }
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(255, 255, 255, 0.8); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 10000; color: var(--text-primary); font-size: 18px; text-align: center; padding: 20px; }
        .dark-mode #loading-overlay { background-color: rgba(0, 0, 0, 0.8); }
        .fab-add-task { 
            display: none; 
            position: fixed; 
            bottom: 24px; 
            right: 24px; 
            width: 56px; 
            height: 56px; 
            border-radius: 50%; 
            background-color: var(--accent-primary); 
            color: white; 
            border: none; 
            box-shadow: var(--shadow-lg); 
            font-size: 28px; 
            line-height: 56px; 
            text-align: center; 
            cursor: pointer; 
            z-index: 1002; 
            /* === ZMIANA: Dodano 'right' do transition === */
            transition: opacity 0.3s, transform 0.3s, right 0.3s ease-in-out;
        }
        
        /* === NOWE REGUY GLOBALNE (przeniesione z media query) === */
        /* Style dla czerwonego przycisku */
        .fab-add-task-special {
            /* display: block; <-- USUNITE (Logika JS kontroluje display) */
            background-color: var(--danger-primary) !important;
            bottom: 96px;
            /* === ZMIANA: Dodano 'right' do transition === */
            transition: opacity 0.3s, transform 0.3s, right 0.3s ease-in-out;
        }
        
        /* === NOWE REGUY GLOBALNE (przeniesione z media query) === */
        /* Style dla czerwonego przycisku */
        .fab-add-task-special {
            /* display: block; <-- USUNITE (Logika JS kontroluje display) */
            background-color: var(--danger-primary) !important;
            bottom: 96px;
            transition: opacity 0.3s, transform 0.3s;
        }
        
        /* Style dla ukrywania czerwonego przycisku */
        .fab-add-task-special.hidden {
            opacity: 0;
            transform: scale(0.5);
            pointer-events: none;
        }
        /* === KONIEC NOWYCH REGU GLOBALNYCH === */
        /* === NOWE STYLE DLA ROZWIJANEGO MENU FAB (Wersja Poprawiona) === */

        /* Kontener menu - pozycjonowany tam, gdzie normalnie jest czerwony przycisk */
        .fab-menu-container {
            position: fixed;
            bottom: 96px; /* Pozycja startowa menu (nad niebieskim FAB) */
            right: 24px;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 16px;
            z-index: 1001;
            /* === ZMIANA: Dodano 'right' do transition === */
            transition: opacity 0.2s ease, transform 0.2s ease, right 0.3s ease-in-out;
        }
        /* === POCZTEK: NOWE STYLE DLA PRZESUWANIA FAB PRZEZ PANEL AI (DESKTOP) === */
        @media (min-width: 769px) {
            /* Szeroko panelu AI (380px) + domylny odstp (24px) = 404px */
            .app-container.ai-panel-is-open #fab-menu-toggle {
                right: 404px;
            }

            .app-container.ai-panel-is-open .fab-menu-container {
                right: 404px;
            }

            .app-container.ai-panel-is-open #fab-add-special-task {
                right: 404px;
            }
        }
        /* === KONIEC: NOWE STYLE DLA PRZESUWANIA FAB === */
        .fab-menu-container.hidden {
            opacity: 0;
            transform: translateY(30px); /* Lekka animacja w d贸 przy znikaniu */
            pointer-events: none;
        }

        .fab-menu-item {
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            /* Animacja pojawiania si element贸w menu (od dou do g贸ry) */
            opacity: 0;
            transform: translateY(10px);
            transition: opacity 0.2s ease, transform 0.2s ease;
        }

        /* Etykieta (dymek) */
        .fab-menu-label {
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            padding: 6px 12px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-md);
            font-size: 14px;
            font-weight: 600;
            white-space: nowrap;
        }

        /* Przycisk wewntrz menu */
        .fab-menu-btn {
            width: 56px; 
            height: 56px; 
            font-size: 28px; 
            line-height: 56px; 
        }
        
        /* Animacja pojawiania si element贸w menu (jeden po drugim) */
        .fab-menu-container:not(.hidden) .fab-menu-item {
            opacity: 1;
            transform: translateY(0);
        }
        /* Op贸藕nienie dla drugiego elementu (sonda偶) */
        .fab-menu-container:not(.hidden) .fab-menu-item:first-child {
             transition-delay: 0.1s;
        }
         /* Op贸藕nienie dla pierwszego elementu (zadanie) */
        .fab-menu-container:not(.hidden) .fab-menu-item:last-child {
             transition-delay: 0.05s;
        }


        /* Przycisk przecznika (niebieski) - jego pozycja (bottom: 24px) jest ju偶 w .fab-add-task */
        #fab-menu-toggle {
            transition: transform 0.3s ease;
            z-index: 1002; /* Nad menu */
        }

        /* Styl "zamknij" (X) dla niebieskiego przycisku */
        #fab-menu-toggle.active {
            transform: rotate(45deg);
        }

        /* Czerwony przycisk (oryginalny specjalny) */
        #fab-add-special-task {
            /* Pozycja (bottom: 96px) i kolor (danger) s ju偶 w .fab-add-task-special */
            /* Dodajemy tylko transition dla pynnego ruchu */
            transition: bottom 0.3s ease, transform 0.3s ease;
            z-index: 1002; /* Na tym samym poziomie co przecznik */
        }
        
        /* === KLUCZOWA REGUA: Przesunicie czerwonego przycisku === */
        /* Gdy menu JEST widoczne, przesu czerwony przycisk w g贸r */
        .fab-menu-container:not(.hidden) + #fab-add-special-task {
            /* Przesuwamy o 144px (wysoko 2 przycisk贸w + 2x odstp) */
            /* Nowa pozycja = 96px (stara) + 144px = 240px */
            bottom: 240px; 
        }
        .sidebar-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.4); z-index: 1999; }
        /* Nowe style dla komentarzy i aktywnoci */
        .comment-input-area {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }
        .comment-input-area textarea {
            flex-grow: 1;
            min-height: 40px;
            max-height: 100px;
            padding: 8px;
            resize: vertical;
        }
        .comments-list, .activity-list {
            list-style: none;
            overflow-y: auto;
            border-top: 1px solid var(--border-color);
            padding-top: 12px;
        }
        .comment-item {
            margin-bottom: 12px;
            padding: 8px 12px;
            background-color: var(--bg-primary);
            border-radius: var(--border-radius);
            font-size: 14px;
        }
        .comment-author {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }
        .activity-item {
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 8px;
            border-left: 3px solid var(--border-color);
            padding-left: 10px;
        }
        .activity-item strong {
            color: var(--text-primary);
        }
        .activity-item span.status-change {
            font-weight: 500;
            padding: 1px 6px;
            border-radius: 4px;
            /* Celowo usunlimy std 'color: white;', aby nie by domylnie biay */
        }
        /* Wymuszenie usunicia stylu listy dla aktywnoci na dashboardzie */
        #dashboard-activity-list {
            list-style: none !important; /* Usuwa znacznik listy (kropk) */
            padding-left: 0 !important; /* Usuwa domylne wcicie listy */
            margin-left: 0 !important; /* Dodatkowe zabezpieczenie przed wciciem */
        }
        .status-todo { 
            background-color: var(--danger-primary); 
            color: var(--text-on-accent); /* Zapewnia biay kolor tekstu */
        }
        .status-inprogress { 
            background-color: var(--accent-primary);
            color: var(--text-on-accent); /* Zapewnia biay kolor tekstu */
        }
        .status-done { 
            background-color: var(--success-primary);
            color: var(--text-on-accent); 
        }

        /* NOWE STYLE DLA PASKA POSTPU */
        .progress-bar-container {
            width: 100%;
            height: 10px;
            background-color: var(--bg-tertiary);
            border-radius: 5px;
            margin-top: 12px;
            overflow: hidden;
            box-shadow: var(--shadow-sm);
        }
        .progress-bar-fill {
            height: 100%;
            background-color: var(--success-primary);
            width: 0%;
            transition: width 0.5s ease-out;
            border-radius: 5px;
        }
        .progress-text {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-secondary);
            margin-top: 4px;
        }
        /* === POCZTEK: NOWE STYLE DLA KAFELKW NA DASHBOARDZIE === */
        .dashboard-card {
            background-color: var(--bg-secondary);
            border-radius: var(--border-radius);
            padding: 20px;
            border: 1px solid var(--accent-primary); /* <-- ZMIANA: Ramka domylnie niebieska */
            box-shadow: var(--shadow-sm);
            display: flex; 
            flex-direction: column; 
            transition: transform 0.2s, box-shadow 0.2s; /* <-- ZMIANA: Usunicie transition dla border-color */
        }
        /* === KONIEC: NOWE STYLE DLA KAFELKW NA DASHBOARDZIE === */
        /* Style dla Pulpitu/Dashboard */
         /* Style dla Pulpitu/Dashboard */
         .dashboard-grid {
            display: grid; /* ZMIANA Z FLEX NA GRID */
            grid-template-columns: repeat(3, 1fr); /* Wprowadzamy 3 r贸wne kolumny */
            align-items: stretch;
            gap: 24px;
            margin-bottom: 24px;
        }
         
        .kpi-column {
            /* USUNITO: Ju偶 niepotrzebne, przechodzimy na nowy ukad grid */
            /* flex: 1 0 0; 
            display: flex;
            flex-direction: column;
            gap: 24px; */
             /* Zastpienie: Wprowadzamy Grid, aby kafelki wewntrz si r贸wnay */
             display: grid;
             grid-template-columns: 1fr;
             gap: 24px;
             /* Dodajemy now klas do maych kafelk贸w KPI, 
             aby wymusi tak sam wysoko dla ka偶dego rzdu. */
             /* Te style bd teraz w .dashboard-card */
        }
        .kpi-column .dashboard-card {
            /* USUNITO: flex: 1; */
            /* Zostawiamy min-height jako zabezpieczenie */
            cursor: pointer; 
            transition: transform 0.2s, box-shadow 0.2s;
            min-height: 180px;
        }
        /* --- NOWE STYLE DLA UJEDNOLICENIA KAFELKW KPI --- */
        /* U偶yjemy nowej klasy `kpi-mini-card` dla wszystkich maych kafelk贸w */
        .kpi-mini-card {
            /* Wymusza ten sam rozmiar dla wszystkich 5 kafelk贸w KPI */
             min-height: 180px; /* Utrzymana wysoko z poprzedniego .dashboard-card */
        }
        .dashboard-card:hover {
            transform: translateY(-2px); /* <-- ZMIANA: Usunicie border-color */
        }
        
        /* Usuwamy ca regu .action-column {} */

        /* Nowa regua dla kart akcji, kt贸re s teraz dziemi .dashboard-grid */
        .dashboard-grid > .dashboard-card {
            flex: 1.5 0 0; /* Ustawienie proporcji dla kart akcji */
            display: flex;
            flex-direction: column;
            min-height: 0;
            overflow: hidden; /* <-- DODANA LINIA */
        }

        /* Aktualizujemy selektor dla list wewntrz tych kart */
        .dashboard-grid > .dashboard-card .overdue-list-container,
        .dashboard-grid > .dashboard-card .activity-list {
            flex-grow: 1;
            min-height: 0; /* Wa偶na poprawka dla poprawnego dziaania flexbox */
            overflow-y: auto;
            max-height: none; /* <-- KLUCZOWA ZMIANA */
            height: 0; /* <-- DODANA LINIA */
        }
        /* === NOWE REGUY: Efekt "Mgy" i Napisu dla Dashboardu (tryb edycji) === */
        
        /* Styl dla pseudo-elementu ::before, kt贸ry tworzy "mg" */
        .dashboard-grid.layout-edit-mode .dashboard-card::before {
            content: ''; /* Wymagane dla pseudo-element贸w */
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5); /* P贸przezroczyste czarne to */
            border-radius: var(--border-radius); /* Dopasowanie zaokrglenia */
            opacity: 0; /* Domylnie ukryte */
            transition: opacity 0.2s ease-in-out; /* Pynne pojawianie si */
            z-index: 1; /* Upewniamy si, 偶e jest nad treci, ale pod tekstem */
            pointer-events: none; /* Ignoruje kliknicia myszk */
        }

        /* Styl dla pseudo-elementu ::after, kt贸ry tworzy napis */
        .dashboard-grid.layout-edit-mode .dashboard-card::after {
            content: 'Chwy i przenie'; /* Tekst do wywietlenia */
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%); /* Wyrodkowanie tekstu */
            color: white;
            font-weight: 600;
            font-size: 14px;
            opacity: 0; /* Domylnie ukryte */
            transition: opacity 0.2s ease-in-out; /* Pynne pojawianie si */
            z-index: 2; /* Upewniamy si, 偶e jest nad "mg" */
            pointer-events: none; /* Ignoruje kliknicia myszk */
            text-shadow: 1px 1px 2px rgba(0,0,0,0.7); /* Cie dla lepszej czytelnoci */
        }

        /* Pokazujemy "mg" i napis po najechaniu myszk na kafelek W TRYBIE EDYCJI */
        .dashboard-grid.layout-edit-mode .dashboard-card:hover::before,
        .dashboard-grid.layout-edit-mode .dashboard-card:hover::after {
            opacity: 1;
        }

        /* Zmieniamy kursor na apk w trybie edycji */
        .dashboard-grid.layout-edit-mode .dashboard-card {
            cursor: grab;
        }

        /* Wa偶ne: ukrywamy uchwyt kropkowy, jeli istnieje w trybie edycji, aby nie kolidowa */
        .dashboard-grid.layout-edit-mode .dashboard-card-handle {
            display: none;
        }
        
        /* === KONIEC NOWYCH REGU === */
        
        /* Ulepszenie wygldu kart w Dashboardzie */
        .dashboard-grid .dashboard-card:first-child h3 {
             color: var(--danger-primary);
        }

        /* Nowe style dla kafelk贸w w modalach (widok szczeg贸贸w) */
        .dashboard-detail-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 12px;
            max-height: 70vh;
            overflow-y: auto;
            padding: 12px;
            background-color: var(--bg-primary);
            border-radius: var(--border-radius);
        }
        .dashboard-detail-list .task-card {
            margin-bottom: 0; /* Usuwamy marginesy pionowe dla kafelk贸w w siatce */
            padding-right: 12px;
        }
        /* === POCZTEK: NOWE STYLE DLA AKORDEONU SUBZADA === */
        .subtasks-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 4px;
            margin-bottom: 8px; /* Zastpuje margines z przycisku */
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            user-select: none;
        }
        .subtasks-header h4 {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-secondary);
            margin: 0;
        }

        /* 尖尖 NOWE STYLE KONTROLEK 尖尖 */
        .subtasks-toggle-controls {
            display: flex;
            align-items: center;
            gap: 4px; /* Odstp midzy tekstem a strzak */
            color: var(--text-secondary);
        }
        .subtasks-toggle-controls .toggle-text {
            font-size: 12px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .subtasks-toggle-controls .chevron {
            width: 18px; /* Lekkie zmniejszenie */
            height: 18px;
            transition: transform 0.3s ease;
            /* Domylnie strzaka jest w g贸r (0deg) */
        }
        /* Stan zwinity - strzaka obraca si o 180 stopni (w d贸) */
        .subtasks-header.collapsed .chevron {
            transform: rotate(180deg);
        }
        /* 测测 KONIEC NOWYCH STYLI 测测 */
        
        .subtasks-collapsible-area {
            /* Ustawiamy du偶 wysoko, aby animacja dziaaa poprawnie */
            max-height: 500px; /* (Wysoko listy (250px) + przycisk + marginesy) */
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        /* Stan zwinity - wysoko 0 */
        .subtasks-collapsible-area.collapsed {
            max-height: 0;
        }

        /* Poprawka: Przycisk dodawania jest teraz wewntrz zwijanego bloku */
        .subtasks-collapsible-area #add-subtask-btn-main {
             margin-bottom: 16px;
        }
        /* Style dla mobilnego (wymu stackowanie) */
        @media (max-width: 768px) {
            
            /* NOWA LOGIKA: Ukryj kolumn promo na maych ekranach i pozw贸l formularzowi zaj 100% szerokoci */
            .auth-wrapper {
                 width: 100%; 
                 height: 100%; 
                 max-height: none;
                 box-shadow: none; 
                 background-color: var(--bg-primary); /* Pasuje do ta body */
                 border-radius: 0;
            }
            .auth-promo-column {
                 display: none; /* Ukryj ca kolumn promocyjn */
            }
            /* DODANO: Poka偶 i ostyluj logo na widoku mobilnym */
            .auth-mobile-logo {
                display: block;
                width: 130px; /* Rozsdny rozmiar dla logo */
                height: auto;
                margin: 0 auto 24px auto; /* Centrowanie i dolny margines */
            }
            .auth-form-column {
                 width: 100%; /* Rozcignij kolumn formularza na ca szeroko */
                 /* DODANO: Reset styl贸w desktopowych, kt贸re psuj widok mobilny */
                 padding: 0 15px; /* Mniejszy padding boczny na mobilnym */
                 border-radius: 0;
                 box-shadow: none;
            }
            
           
            .auth-form-column .auth-container {
                 box-shadow: none; /* Upewnij si, 偶e nie ma cienia na kontenerze */
            }
            
            .app-container { flex-direction: column; overflow-y: auto; }
            .sidebar { position: fixed; top: 0; left: 0; height: 100%; z-index: 2000; transform: translateX(-100%); border-right: 1px solid var(--border-color); }
            .sidebar.open { transform: translateX(0); box-shadow: var(--shadow-lg); }
            .sidebar.open + .sidebar-overlay { display: block; }
            
            /* === POPRAWKA 1: Zapewnienie, 偶e g贸wna tre si przewija, a nie jest ucinana === */
            .main-content { 
            padding: 16px; 
            padding-top: 70px; 
            overflow: visible;
            height: auto;
            width: 100%; /* <-- TO JEST OSTATECZNA POPRAWKA */
            }

            .mobile-header { display: flex; align-items: center; justify-content: space-between; position: fixed; top: 0; left: 0; width: 100%; background-color: var(--bg-secondary); padding: 12px 16px; box-shadow: var(--shadow-sm); z-index: 1001; }
            #menu-toggle { background: none; border: none; cursor: pointer; padding: 4px; }
            #menu-toggle svg { width: 24px; height: 24px; color: var(--text-primary); }
            .mobile-header h2#mobile-header-title {
            font-size: 25px; 
            font-family: var(--font-family-header);
            font-weight: 700; /* <-- PRZYWRCONO pogrubienie dla Poppins */
        }
            .main-header { display: none; }

            /* === POPRAWKA 2: Zmiana ukadu Kanban na pionowy === */
            .kanban-board { 
                display: block;    /* Zamiast grid, kolumny bd jedna pod drug */
                overflow: visible; /* Usuwamy przewijanie boczne */
                height: auto;      /* Wysoko dopasowuje si do zawartoci */
            }
           .kanban-column { 
            min-height: 200px; 
            margin-bottom: 24px; /* Dodajemy odstp midzy kolumnami */
            display: block;      /* <-- TO JEST KLUCZOWA POPRAWKA */
            }
            /* === NOWA REGUA: Mini-kanban na mobilnych === */
            .kanban-board-mini {
                display: block; /* Kolumny jedna pod drug */
                overflow: visible;
                height: auto;
            }
            /* === KONIEC NOWEJ REGUY === */
            .kanban-tasks { 
                overflow-y: visible; /* Wyczamy wewntrzne przewijanie listy zada */
                max-height: none;    /* Usuwamy ograniczenie wysokoci */
            }

            .modal { width: 95vw; max-height: 85vh; }
            /* === NOWA REGUA: Poprawka zakadek w modalach na mobilnych === */
            .task-modal-tabs {
                flex-direction: column; /* Ustawia ukad pionowy (jedna linia pod drug) */
                align-items: stretch; /* Rozciga oba elementy na pen szeroko */
                gap: 12px; /* Dodaje odstp midzy lini ikon a przyciskiem bannera */
                padding-bottom: 12px; /* Lekko zmniejszamy dolny padding dla zgrabniejszego wygldu */
            }
            
            /* Upewnijmy si, 偶e przycisk bannera ma pen szeroko i wyrodkowany tekst */
            #open-cover-gallery-btn,
            #new-task-open-cover-gallery-btn {
                width: 100%;
                text-align: center; 
            }
            /* === KONIEC NOWEJ REGUY === */
           /* === NOWA REGUA: Poprawka dla modala szablon贸w na mobilnym === */
            #project-templates-modal .modal {
                flex-direction: column; /* UKAD PIONOWY: Ustawia kolumny jedna pod drug */
                height: 85vh; /* U偶yj niemal penej wysokoci ekranu */
            }
            #project-templates-modal > .modal > div:first-child { /* Lewa kolumna (lista szablon贸w) */
                width: 100%; /* Pena szeroko */
                border-right: none; /* Usu boczn ramk */
                border-bottom: 1px solid var(--border-color); /* Dodaj ramk na dole */
                height: auto; /* Pozw贸l jej si skurczy */
                flex-shrink: 0; /* Niech si nie kurczy */
                max-height: 40%; /* Ogranicz wysoko listy do 40% ekranu */
            }
            #template-details-view { /* Prawa kolumna (szczeg贸y szablonu) */
                width: 100%; /* Pena szeroko */
                flex-grow: 1; /* Wypenij reszt dostpnego miejsca */
                min-height: 0; /* Wa偶ne dla poprawnego dziaania flexbox */
            }
            /* === KONIEC NOWEJ REGUY === */
            .task-modal-content { flex-direction: column; overflow-y: auto; }
            .task-modal-sidebar { width: 100%; border-top: 1px solid var(--border-color); border-right: none; }
            .task-modal-main, .task-modal-sidebar {
            overflow-y: visible;
            border-right: none; /* Usuwamy te偶 ewentualn lini oddzielajc */
        }
            /* === NOWE REGUY: Responsywno Modala Szczeg贸贸w Projektu === */
        #project-details-modal .project-details-budget-grid {
            /* Zmieniamy siatk z 4-kolumnowej na 2-kolumnow */
            grid-template-columns: repeat(2, 1fr);
            gap: 16px; /* Zwikszamy odstp dla czytelnoci */
        }
        #details-budget-tasks-table-container table {
            border: none; /* Usuwamy ramk tabeli */
        }
        #details-budget-tasks-table-container thead {
            /* Cakowicie ukrywamy nag贸wki tabeli na mobilnych */
            display: none;
        }
        #details-budget-tasks-table-container tr.task-cost-row {
            /* Ka偶dy wiersz staje si "kart" */
            display: block;
            width: 100%;
            margin-bottom: 12px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 8px 12px;
        }
        #details-budget-tasks-table-container td {
            /* Kom贸rki ukadaj si pionowo */
            display: block;
            width: 100%;
            text-align: right !important; /* Wymu wyr贸wnanie wartoci do prawej */
            padding: 4px 0;
            border-bottom: 1px dashed var(--border-color); /* Linia oddzielajca */
            min-height: 28px; /* Minimalna wysoko dla r贸wnego wygldu */
        }
        #details-budget-tasks-table-container td:last-child {
            border-bottom: none; /* Usu lini pod ostatnim elementem */
        }
        #details-budget-tasks-table-container td::before {
            /* Tutaj u偶ywamy 'data-label' dodanego w JS */
            content: attr(data-label);
            float: left;
            font-weight: 600;
            color: var(--text-secondary);
            margin-right: 10px;
        }
        #details-budget-tasks-table-container tfoot td {
            /* Poprawka dla stopki tabeli */
            display: flex;
            justify-content: space-between;
            font-size: 14px;
        }
        #details-budget-tasks-table-container tfoot td::before {
            content: none; /* Stopka nie potrzebuje etykiet */
        }
        /* === KONIEC NOWYCH REGU === */
            /* === POPRAWKA 3: Lepsza widoczno przycisku FAB === */
            .fab-add-task { 
                /* display: block; <-- USUNITE (Kontrolowane przez JS) */
                position: fixed; 
                bottom: 24px; 
                right: 24px; 
                width: 56px; 
                height: 56px; 
                border-radius: 50%; 
                background-color: var(--accent-primary); 
                color: white; 
                border: none; 
                box-shadow: var(--shadow-lg); 
                font-size: 28px; 
                line-height: 56px; 
                text-align: center; 
                cursor: pointer; 
                z-index: 1002;
                /* transition: opacity 0.3s, transform 0.3s; <-- USUNITE (przeniesione do globalnej) */
            }

            /* Style dla czerwonego przycisku, teraz jako osobna regua */
            .fab-add-task-special {
                /* display: block; <-- USUNITE (Kontrolowane przez JS) */
                /* background-color: var(--danger-primary); <-- USUNITE (przeniesione do globalnej) */
                bottom: 96px;
                /* transition: opacity 0.3s, transform 0.3s; <-- USUNITE (przeniesione do globalnej) */
            }
            /* === POCZTEK: NOWE STYLE DLA MOBILNEGO MENU AKCJI PROJEKTU === */
        #mobile-project-actions-toggle {
            /* Style przycisku (ikony trzech kropek) w nag贸wku mobilnym */
        }

        .mobile-actions-menu {
            position: fixed; /* Pozycjonowanie wzgldem okna przegldarki */
            top: 58px; /* Pozycja pod mobilnym nag贸wkiem (wysoko nag贸wka + may odstp) */
            right: 10px; /* Wyr贸wnanie do prawej krawdzi */
            background-color: var(--bg-secondary);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border-color);
            z-index: 1005; /* Musi by nad treci, ale pod overlayem sidebar */
            min-width: 180px; /* Minimalna szeroko menu */
            overflow: hidden; /* Ukrywa ewentualne wystajce elementy */
            padding: 4px 0; /* May padding g贸ra/d贸 */
        }

        .mobile-actions-menu ul {
            list-style: none; /* Usuwa kropki listy */
            margin: 0;
            padding: 0;
        }

        .mobile-actions-menu li a {
            display: block; /* Linki jako bloki zajmujce ca szeroko */
            padding: 10px 16px; /* Wewntrzne odstpy link贸w */
            text-decoration: none; /* Usuwa podkrelenie */
            color: var(--text-primary);
            font-size: 14px;
            font-weight: 500;
            transition: background-color 0.2s; /* Pynne przejcie ta */
        }

        .mobile-actions-menu li a:hover {
            background-color: var(--bg-tertiary); /* To przy najechaniu myszk */
        }

        .mobile-actions-menu li a.danger {
            color: var(--danger-primary); /* Kolor dla opcji "Usu" */
        }

         .mobile-actions-menu li a.danger:hover {
            background-color: rgba(220, 38, 38, 0.1); /* Lekkie czerwone to dla Usu przy hover */
        }
        /* === KONIEC: NOWE STYLE DLA MOBILNEGO MENU AKCJI PROJEKTU === */

        /* Poprawka dla kontenera akcji w nag贸wku mobilnym, aby nowy przycisk si zmieci */
        @media (max-width: 768px) {
            .mobile-header .header-actions {
                 gap: 8px; /* Zmniejszamy odstp midzy ikonami w nag贸wku mobilnym */
            }
             .mobile-header .header-actions .header-btn {
                 padding: 4px; /* Lekko zmniejszamy padding ikon */
            }
        }

            /* Style dla ukrywania czerwonego przycisku, r贸wnie偶 osobno */
            .fab-add-task-special.hidden {
                /* opacity: 0; <-- USUNITE (przeniesione do globalnej) */
                /* transform: scale(0.5); <-- USUNITE (przeniesione do globalnej) */
                /* pointer-events: none; <-- USUNITE (przeniesione do globalnej) */
            }
            .add-task-icon-btn { display: none; }
                    
            .dashboard-grid {
                flex-direction: column; /* <-- ZMIANA: Ustawia pionowy ukad dla mobilnych */
                grid-template-columns: 1fr; /* Dodana regua z .action-column */
            }

            /* 尖尖 POCZTEK SCALONYCH I POPRAWIONYCH STYLW 尖尖 */
            .dashboard-grid {
                 grid-template-columns: 1fr; /* ZMIANA: Wymu 1 kolumn na mobilnych */
            }
            .kpi-column,
            .dashboard-grid > .dashboard-card {
                /* flex: auto; */  /* Resetuje 'flex-grow' i 'flex-basis' z desktopu */
                width: 100%; /* Wymusza pen szeroko */
            }

            .dashboard-grid > .dashboard-card .overdue-list-container,
            .dashboard-grid > .dashboard-card .activity-list {
                height: auto;        /* Resetujemy wysoko do auto */
                flex-grow: 1;        /* Pozwalamy licie rosn */
                overflow-y: visible; /* Wyczamy wewntrzne przewijanie */
                min-height: 150px;   /* Dodajemy minimaln wysoko, aby puste listy nie znikay */
            }
            
             .kpi-column .dashboard-card {
                 min-height: 150px; /* Przeniesiona regua */
            }
             /* 测测 KONIEC SCALONYCH I POPRAWIONYCH STYLW 测测 */

            /* 尖尖 POCZTEK NOWYCH STYLI CSS DLA MOBILNEGO KALENDARZA 尖尖 */
            #mobile-calendar-wrapper {
                color: var(--text-primary);
            }
            #mobile-calendar-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 8px 0;
            }
            #mobile-calendar-header h3 {
                font-size: 18px;
                font-weight: 600;
            }
            #mobile-calendar-header button {
                background: none;
                border: none;
                color: var(--text-primary);
                font-size: 24px;
                font-weight: bold;
                cursor: pointer;
                padding: 0 16px;
            }
            #mobile-calendar-weekdays, #mobile-calendar-grid {
                display: grid;
                grid-template-columns: repeat(7, 1fr);
                text-align: center;
                gap: 4px;
            }
            #mobile-calendar-weekdays {
                font-size: 12px;
                font-weight: 500;
                color: var(--text-secondary);
                margin-bottom: 8px;
            }
            .mobile-calendar-day {
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: flex-start;
                padding: 4px 0;
                border-radius: var(--border-radius);
                cursor: pointer;
                border: 2px solid transparent;
                min-height: 50px; /* Zapewnia sta wysoko */
                transition: background-color 0.2s, border-color 0.2s;
            }
            .mobile-calendar-day.other-month {
                opacity: 0.4;
            }
            .mobile-calendar-day span {
                font-size: 15px;
                font-weight: 500;
                margin-bottom: 4px;
            }
            .mobile-calendar-day.today span {
                background-color: var(--danger-primary);
                color: white;
                border-radius: 50%;
                width: 26px;
                height: 26px;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            .mobile-calendar-day.selected {
                border-color: var(--accent-primary);
                background-color: rgba(79, 70, 229, 0.1);
            }
            .mobile-calendar-day .activity-indicators {
                display: flex;
                gap: 2px;
                height: 4px;
            }
            .mobile-calendar-day .activity-indicator {
                width: 10px;
                height: 4px;
                border-radius: 2px;
            }
            .mobile-calendar-day .indicator-todo { background-color: var(--danger-primary); }
            .mobile-calendar-day .indicator-inprogress { background-color: var(--accent-primary); }
            
            #mobile-calendar-task-list-container {
                flex-grow: 1;
                margin-top: 16px;
                padding-top: 16px;
                border-top: 1px solid var(--border-color);
                overflow-y: auto;
            }
            #mobile-calendar-selected-day-header {
                font-size: 16px;
                margin-bottom: 12px;
                padding: 0 4px;
            }
            #mobile-calendar-task-list {
                list-style: none;
            }
            .mobile-calendar-task-item {
                display: flex;
                align-items: flex-start;
                padding: 12px 8px;
                margin-bottom: 8px;
                border-left: 4px solid var(--accent-primary);
                background-color: var(--bg-secondary);
                border-radius: var(--border-radius);
                box-shadow: var(--shadow-sm);
                cursor: pointer;
            }
            .mobile-calendar-task-item.todo {
                border-left-color: var(--danger-primary);
            }
            .mobile-calendar-task-item-time {
                font-size: 14px;
                font-weight: 600;
                width: 60px;
                color: var(--text-secondary);
            }
            .mobile-calendar-task-item-title {
                font-size: 15px;
                font-weight: 500;
            }
            .mobile-calendar-task-item-details {
    display: flex;
    flex-direction: column;
}
.mobile-calendar-task-project-name {
    font-size: 11px;
    font-weight: 600;
    color: var(--text-secondary);
    margin-bottom: 2px;
}

            .no-tasks-message {
                text-align: center;
                padding: 20px;
                color: var(--text-secondary);
                font-style: italic;
            }
            
            /* === NOWE STYLE DLA PUSTEGO STANU PRODUKTYWNOCI (Ludek AI) === */
           /* === FINALNA POPRAWKA CENTROWANIA (CSS GRID) === */
            #my-day-empty-state {
                /* U偶ywamy Flexboxa, kt贸ry jest bardziej przewidywalny dla centrowania (place-items ma mniejsze wsparcie) */
                display: flex; 
                flex-direction: column; 
                align-items: center; 
                justify-content: center; 
                /* KLUCZOWA ZMIANA: Dodajemy text-align: center! */
                text-align: center; /* Wymu centrowanie element贸w inline i blokowych o staej szerokoci */

                /* Zmuszamy element, aby ur贸s i zaj cae wolne miejsce w .main-content */
                flex-grow: 1;
                width: 100%; 
                height: auto; 
                min-height: 0;
                
                /* Resetujemy marginesy */
                margin: 0 !important;
                padding: 0 !important;
                
                /* Lekkie przesunicie w g贸r dla lepszego efektu wizualnego */
                padding-bottom: 10vh !important; 
            }

            .ai-empty-state-wrapper {
                width: 100%;
                max-width: 500px; /* Szeroko dymka */
                
                display: flex;
                flex-direction: column;
                align-items: center; 
                justify-content: center;
                
                /* Resetujemy margines poziomy, ale dodajemy auto, aby da mu szans centrowania jako blok wewntrz flexa */
                margin: 0 auto; /* PRZYWRCONO: Centrowanie bloku o max-width */
            }
            
            .ai-character-img {
                display: block;
                /* Ograniczamy wielko obrazka, 偶eby nie rozpycha widoku na maych ekranach */
                max-width: 200px; 
                height: auto;
                margin: 0 auto 20px auto; /* Centrowanie obrazka + odstp od dymka */
            }
            /* === KONIEC POPRAWKI === */
            /* Dymek - bazuje na kartach, ale dodaje pozycjonowanie */
            .ai-speech-bubble {
                max-width: 450px;
                padding: 20px 25px;
                background-color: var(--bg-secondary);
                border-radius: var(--border-radius);
                box-shadow: var(--shadow-lg);
                border: 2px solid var(--accent-primary);
                position: relative;
                margin-top: 20px;
                /* KLUCZOWA ZMIANA: Ustawiamy wyr贸wnanie tekstu na lew */
                text-align: left; /* Wymu wyr贸wnanie tekstu do lewej wewntrz dymka */
            }
            /* OGONEK DYMKA (CSS Triangle) */
            .ai-speech-bubble::before {
                content: "";
                position: absolute;
                top: -16px;
                left: 50%;
                transform: translateX(-50%);
                border-left: 10px solid transparent;
                border-right: 10px solid transparent;
                border-bottom: 16px solid var(--accent-primary);
            }
            .ai-speech-bubble::after {
                content: "";
                position: absolute;
                top: -12px;
                left: 50%;
                transform: translateX(-50%);
                border-left: 8px solid transparent;
                border-right: 8px solid transparent;
                border-bottom: 12px solid var(--bg-secondary);
            }
            /* Styl dla tekstu wewntrz dymka */
            .ai-speech-bubble h2 {
                font-family: var(--font-family-header);
                font-size: 22px;
                color: var(--accent-primary);
                /* ZMIANA: Zmniejszenie marginesu po h2, aby tekst by bardziej sp贸jny */
                margin-bottom: 8px; 
            }
            .ai-speech-bubble p {
                 font-style: normal;
                 font-size: 15px;
                 line-height: 1.6;
                 color: var(--text-primary);
                 /* ZMIANA: Dodanie marginesu przed przyciskami */
                 margin-bottom: 15px; 
            }
            /* === KONIEC NOWYCH STYLI DLA LUDKA I DYMKA === */
             /* 尖尖 POCZTEK NOWYCH STYLI DLA NAWIGACJI "MJ DZIE" 尖尖 */
            #my-day-nav-mobile {
                display: flex; /* Zmienione z none na flex przez JS */
                align-items: center;
                gap: 4px;
                justify-content: center;
                flex-grow: 1; /* Pozwala zaj centraln przestrze */
            }
            #my-day-nav-mobile h2#my-day-date-display-mobile { 
            font-size: 20px; 
            font-family: var(--font-family-header);
            font-weight: 700; /* <-- PRZYWRCONO pogrubienie dla Poppins */
            white-space: nowrap;
            padding: 0 4px;
        }
            /* Dodatkowy nag贸wek "M贸j dzie" */
        #my-day-title-container h2 {
            font-family: var(--font-family-header);
            font-size: 32px; 
            font-weight: 700; /* <-- PRZYWRCONO pogrubienie dla Poppins */
            margin: 0; 
             line-height: 1.2; 
        }
            #my-day-nav-mobile .header-btn {
                padding: 4px;
                font-size: 18px;
                font-weight: bold;
            }
            #my-day-nav-mobile .btn {
                padding: 4px 8px;
                font-size: 12px;
            }
           
            /* 测测 KONIEC NOWYCH STYLI CSS 测测 */
        /* === NOWE REGUY: Pionowe zwijanie kolumn (Mobile) === */
        
            /* 1. Nadpisz style zwinitej kolumny: przywr贸 szeroko, animuj max-height */
            .kanban-column.collapsed {
                width: 100%;
                min-width: 100%;
                max-width: 100%;
                flex-basis: auto;
                flex-shrink: 1; /* Pozw贸l kolumnie si kurczy */
                
                /* KLUCZOWE ZMIANY: Zwijanie w pionie */
                max-height: 50px; /* Wysoko samego nag贸wka */
                min-height: 0; /* Nadpisz mobilne min-height: 200px */
                
                /* Zmie animacj z 'width' na 'max-height' */
                transition: max-height 0.3s ease-out, margin-bottom 0.3s ease-out;
                
                /* "Przytul" do nastpnej kolumny */
                margin-bottom: 8px; 
            }

            /* 2. Zresetuj nag贸wek do ukadu poziomego (anuluj vertical-rl) */
            .kanban-column.collapsed .kanban-column-header {
                flex-direction: row; /* Z 'column' na 'row' */
                justify-content: space-between; /* Rozsu elementy */
                align-items: center;
                
                /* === MODYFIKACJA CENTROWANIA === */
                padding: 0 12px; /* Usu padding g贸ra/d贸, zostaw boczny */
                height: 50px; /* Ustaw sztywn wysoko r贸wn max-height rodzica */
                /* === KONIEC MODYFIKACJI === */
                
                writing-mode: horizontal-tb; /* Kluczowe: Anuluj pionowy tekst */
                transform: none; /* Anuluj obr贸t */
            }

            /* 3. Zresetuj tytu H3 */
            .kanban-column.collapsed .kanban-column-header h3 {
                writing-mode: horizontal-tb;
                transform: none;
                margin: 0;
                padding: 0;
            }

            /* 4. Przywr贸 widok filtr贸w (jeli s) i licznik贸w */
            .kanban-column.collapsed .completed-tasks-filter,
            .kanban-column.collapsed .kanban-header-counts {
                display: flex; /* Poka偶 ponownie */
                flex-direction: row; /* U贸偶 liczniki poziomo */
                align-items: center;
                order: 0; /* Zresetuj kolejno */
                margin: 0;
                padding: 0;
                font-weight: 500; /* Przywr贸 wag czcionki */
            }
            
            /* 5. Zresetuj style czcionek i margines贸w licznik贸w */
            .kanban-column.collapsed .task-count,
            .kanban-column.collapsed .task-estimation-sum {
                font-size: 12px; /* Przywr贸 rozmiar */
                padding: 2px 8px; /* Przywr贸 padding */
                line-height: 1.5;
                margin-left: 4px !important; /* Przywr贸 may margines */
            }
            
            /* 6. Upewnij si, 偶e task-count wraca na swoj pozycj (auto) */
            .kanban-column.collapsed .task-count {
                margin-left: auto !important;
            }
            /* === KONIEC NOWYCH REGU === */

        }
        
         /* === POCZTEK: NOWE STYLE DLA KALENDARZA === */
         #calendar-view {
            flex-grow: 1; /* Sprawia, 偶e kalendarz wypenia ca dostpn wysoko */
            min-height: 600px; /* NOWA LINIA: Gwarantuje minimaln wysoko dla widok贸w siatki */
        }

        /* Ustawienie zmiennych kolor贸w dla FullCalendar */
        :root {
            --fc-border-color: var(--border-color);
            --fc-daygrid-event-dot-width: 8px;
            --fc-list-event-dot-width: 8px;
            --fc-event-bg-color: var(--accent-primary);
            --fc-event-border-color: var(--accent-primary);
            --fc-event-text-color: var(--text-on-accent);
            --fc-day-today-bg-color: rgba(79, 70, 229, 0.08); /* Lekkie podwietlenie dzisiejszego dnia */
        }
        
        .dark-mode {
            --fc-day-today-bg-color: rgba(79, 70, 229, 0.2);
        }

        /* Poprawki wizualne */
        .fc .fc-toolbar-title {
            font-size: 1.25em; /* Troch wikszy tytu miesica */
        }
        .fc .fc-button {
            background-color: var(--bg-tertiary) !important;
            color: var(--text-primary) !important;
            border: 1px solid var(--border-color) !important;
            box-shadow: none !important;
            text-transform: capitalize;
        }
        .fc .fc-button-primary:hover {
            background-color: var(--border-color) !important;
        }
        .fc-event {
            cursor: pointer;
            padding: 2px 4px;
            font-size: 13px;
            border-radius: 4px !important;
        }
        /* === KONIEC: NOWE STYLE DLA KALENDARZA === */
         /* === POCZTEK: NOWE STYLE DLA ZMODERNIZOWANEGO PULPITU === */

        /* Lepszy wygld kontenera na op贸藕nione zadania */
        .overdue-list-container {
            overflow-y: auto;
            padding: 4px;
        }
        /* Dodajemy odstp midzy kartami w licie op贸藕nionych */
        .overdue-list-container .task-card {
            margin-bottom: 8px;
        }

        /* Style dla nowego, nowoczesnego wykresu */
        .modern-chart {
            display: flex;
            flex-direction: column;
            gap: 16px; /* Odstp midzy wierszami wykresu */
            margin-top: 16px;
        }
        .chart-row {
            width: 100%;
        }
        .chart-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
            font-size: 14px;
            color: var(--text-secondary);
        }
        .chart-label strong {
            font-weight: 600;
            color: var(--text-primary);
            background-color: var(--bg-tertiary);
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
        }
        .chart-bar-wrapper {
            height: 12px;
            background-color: var(--bg-tertiary);
            border-radius: 6px;
            overflow: hidden;
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.05);
        }
        .chart-bar-fill {
            height: 100%;
            border-radius: 6px;
            transition: width 0.6s cubic-bezier(0.25, 1, 0.5, 1); /* Pynna animacja */
        }
        .chart-bar-fill.todo {
            background: linear-gradient(90deg, var(--danger-hover), var(--danger-primary));
        }
        .chart-bar-fill.inprogress {
            background: linear-gradient(90deg, var(--accent-hover), var(--accent-primary));
        }

        /* === NOWE STYLE DLA KAFELKA KPI BUD呕ETU (Z ROZWIJANYMI SZCZEGAMI) === */
        
        /* Wykres koowy - bez zmian */
        .budget-kpi-circle {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            display: grid;
            place-items: center;
            background: conic-gradient(
                var(--accent-primary) calc(var(--progress-percent, 0) * 1%), 
                var(--bg-tertiary) calc(var(--progress-percent, 0) * 1%)
            );
            margin: 12px auto 8px auto;
            transition: background 0.5s ease-out;
            position: relative; 
        }
        .budget-kpi-circle::before {
            content: '';
            position: absolute;
            width: 85%;
            height: 85%;
            background-color: var(--bg-secondary);
            border-radius: 50%;
        }
        /* === STYLE DLA PASKW PROPORCJI (BUD呕ET OSOBY) === */
        /* Ten styl definiuje kontener paska */
        .budget-kpi-ratio-bar {
            display: flex;
            height: 16px; /* Wysoko paska */
            width: 100%;
            background-color: var(--bg-tertiary);
            border-radius: 8px;
            overflow: hidden;
            margin: 16px 0 8px 0; /* Odstpy */
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.05);
        }
        /* Ten styl definiuje segmenty (kolory) wewntrz paska */
        .budget-kpi-ratio-segment {
            height: 100%;
            transition: width 0.5s ease-out;
        }
        /* Kolor dla kwot ZAREZERWOWANYCH (Niebieski/Fioletowy) */
        .budget-kpi-ratio-segment.bar-reserved {
            background: linear-gradient(90deg, var(--accent-hover), var(--accent-primary));
        }
        /* Kolor dla kwot WYDANYCH (Zielony) */
        .budget-kpi-ratio-segment.bar-spent {
            background: linear-gradient(90deg, var(--success-primary), #16a34a);
        }
        /* Upewnijmy si, 偶e style dla modala te偶 tu s */
        .chart-bar-fill.bar-total {
            background: linear-gradient(90deg, #f59e0b, #fde047);
        }
        .budget-kpi-percentage {
            position: relative;
            font-size: 28px;
            font-weight: 700;
            color: var(--accent-primary);
        }
        .budget-kpi-circle.over-budget {
             background: conic-gradient(
                var(--danger-primary) calc(var(--progress-percent, 0) * 1%), 
                var(--bg-tertiary) calc(var(--progress-percent, 0) * 1%)
            );
        }
        .budget-kpi-circle.over-budget .budget-kpi-percentage {
            color: var(--danger-primary);
        }

        /* NOWY: Styl dla zwijanego kontenera (na liczby) */
        .budget-kpi-details {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        .budget-kpi-details.expanded {
            max-height: 200px; /* Wystarczajco, by zmieci liczby */
        }
        
        /* NOWY: Styl dla liczb wewntrz zwijanego kontenera */
        .budget-kpi-summary-numbers {
            font-size: 14px;
            color: var(--text-secondary);
            text-align: center;
            margin: 16px 0;
            padding: 0 10px;
        }
        .budget-kpi-summary-numbers strong {
            display: block;
            font-size: 24px; /* Troch mniejsze ni偶 w poprzednim planie */
            font-weight: 700;
            color: var(--text-primary);
            line-height: 1.2;
            word-break: break-word;
        }
        .budget-kpi-summary-numbers span {
            font-size: 12px;
            text-transform: uppercase;
        }

        /* NOWY: Styl dla stopki kafelka z przyciskiem */
        .budget-kpi-footer {
            text-align: right;
            border-top: 1px solid var(--border-color);
            padding-top: 10px;
            margin-top: 10px;
        }
        
        /* NOWY: Styl samego przycisku "Szczeg贸y" */
        .js-toggle-budget-details {
            background: none;
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            padding: 4px 10px;
            font-size: 12px;
            font-weight: 500;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        .js-toggle-budget-details:hover {
            background-color: var(--bg-tertiary);
            border-color: var(--accent-primary);
            color: var(--accent-primary);
        }
        .js-toggle-budget-details .chevron {
            width: 14px;
            height: 14px;
            stroke-width: 2.5px;
            transition: transform 0.3s ease;
            transform: rotate(0deg); /* Domylnie strzaka w d贸 */
        }
        .js-toggle-budget-details.expanded .chevron {
            transform: rotate(180deg); /* Obr贸t przy rozwijaniu */
        }
        /* === KONIEC STYLI KPI BUD呕ETU === */
        /* === NOWE STYLE: Lista bud偶et贸w u偶ytkownik贸w w modalu === */
        .user-budget-list {
            display: flex;
            flex-direction: column;
            gap: 20px;
            /* Usuwamy klas .dashboard-detail-list, wic padding dodajemy tutaj */
            padding: 8px;
        }
        .user-budget-row {
            display: grid;
            grid-template-columns: 200px 1fr; /* Kolumna na awatar/nazw i kolumna na wykresy */
            gap: 24px;
            align-items: flex-start;
            padding: 16px;
            background-color: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
        }
        .user-budget-info {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            gap: 8px;
        }
        .user-budget-info .avatar {
            width: 56px; /* Nieco wikszy awatar w tym widoku */
            height: 56px;
            font-size: 20px;
            margin: 0; /* Resetowanie margines贸w z .avatar */
        }
        .user-budget-info h4 {
            font-size: 15px;
            font-weight: 600;
            word-break: break-word; /* Zamanie dugich nazw/maili */
        }
        /* Dostosowanie wykres贸w w modalu */
        .user-budget-bars .modern-chart {
            margin-top: 0; /* Reset marginesu z .modern-chart */
        }

        /* Responsywno dla modala na mobilce */
        @media (max-width: 768px) {
            .user-budget-row {
                grid-template-columns: 1fr; /* Jedna kolumna */
                gap: 16px;
            }
            .user-budget-info {
                flex-direction: row; /* Awatar obok nazwy */
                text-align: left;
                border-bottom: 1px solid var(--border-color);
                padding-bottom: 12px;
            }
            .user-budget-info .avatar {
                width: 42px;
                height: 42px;
                font-size: 16px;
            }
        }
        /* === KONIEC NOWYCH STYLI === */
         /* === POCZTEK: STYLE DLA ZACZNIKW === */
        .attachments-list {
            list-style: none;
            margin-bottom: 12px;
        }
        .attachment-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px;
            background-color: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            margin-bottom: 8px;
        }
        .attachment-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .attachment-info svg {
            width: 20px;
            height: 20px;
            color: var(--text-secondary);
            flex-shrink: 0;
        }
        .attachment-name {
            font-weight: 500;
            color: var(--accent-primary);
            text-decoration: none;
        }
        .attachment-name:hover {
            text-decoration: underline;
        }
        .delete-attachment-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 20px;
            opacity: 0.6;
        }
        .delete-attachment-btn:hover {
            color: var(--danger-primary);
            opacity: 1;
        }
        .staged-attachment-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 8px;
    background-color: var(--bg-primary);
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius);
    margin-bottom: 8px;
}
.staged-attachment-info {
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 14px;
    font-weight: 500;
}
.staged-attachment-info svg {
    width: 20px;
    height: 20px;
    color: var(--text-secondary);
    flex-shrink: 0;
}
.delete-staged-attachment-btn {
     background: none;
    border: none;
    color: var(--text-secondary);
    cursor: pointer;
    font-size: 20px;
    opacity: 0.6;
}
.delete-staged-attachment-btn:hover {
    color: var(--danger-primary);
    opacity: 1;
}
        /* === KONIEC: STYLE DLA ZACZNIKW === */
       /* === NOWE STYLE DLA KOLOROWANIA RCZNEGO === */
        
        /* Kontener na przyciski akcji wizualnych (Banner + To) w modalu */
        .task-visual-actions {
            display: flex;
            flex-direction: column; /* Ukad pionowy: jeden pod drugim */
            gap: 8px;
            margin-left: 12px;
            flex-shrink: 0;
        }
        
        /* Siatka kolor贸w w modalu */
        #background-colors-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 12px;
            padding: 8px;
        }

        .color-swatch-item {
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 8px;
            text-align: center;
            cursor: pointer;
            transition: border-color 0.2s, box-shadow 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }
        .color-swatch-item:hover {
            border-color: var(--accent-primary);
            box-shadow: var(--shadow-sm);
        }
        .color-swatch-item.selected {
            border-color: var(--accent-primary);
            background-color: rgba(79, 70, 229, 0.05);
            font-weight: 600;
        }

        .color-preview-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-sm);
        }
        /* === KONIEC NOWYCH STYLI === */
/* === POCZTEK: NOWE STYLE DLA WIDOKU WSZYSTKICH PROJEKTW === */
        .all-projects-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }
        .project-tile {
            background-color: var(--bg-secondary);
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--shadow-md);
            display: flex;
            flex-direction: column;
            gap: 12px;
            transition: transform 0.2s, box-shadow 0.2s;
            border: 1px solid var(--border-color);
            position: relative; /* Dodane dla pozycjonowania ramki */
            border-top: 5px solid transparent; /* Domylna grubo, aby nie "skakao" */
        }
        
        /* NOWA REGUA: Wysoki Priorytet */
        .project-tile.priority-high {
            border-top-color: var(--priority-high-border);
        }

        .project-tile:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }
        .project-tile.owner { background-color: var(--bg-secondary); }
        .project-tile.member { background-color: #e0e7ff; } /* Bardziej widoczny niebieski */
        .project-tile.other { background-color: #fffacd; } /* Jasny 偶贸ty */
        .dark-mode .project-tile.member { background-color: #313b5b; } /* Dostosowany niebieski dla trybu ciemnego */
        .dark-mode .project-tile.other { background-color: #5a5a42; }
        
        .project-tile-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }
        .project-tile-header h3 {
            font-size: 18px;
            font-weight: 600;
            /* === NOWE REGUY SKRACANIA TEKSTU === */
            max-width: 65%; /* Ograniczenie szerokoci do 65% kafelka */
            white-space: nowrap; /* Zapobieganie zawijaniu tekstu */
            overflow: hidden; /* Ukrywanie tekstu poza krawdzi */
            text-overflow: ellipsis; /* Dodawanie wielokropka na kocu */
            /* === KONIEC NOWYCH REGU === */
            margin-right: 12px;
            cursor: pointer;
        }
        .project-tile-header h3:hover {
            color: var(--accent-primary);
        }
        /* Styl dla pseudo-elementu ::before, kt贸ry tworzy "mg" */
.all-projects-grid.layout-edit-mode .project-tile::before {
    content: ''; /* Wymagane dla pseudo-element贸w */
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5); /* P贸przezroczyste czarne to */
    border-radius: var(--border-radius); /* Dopasowanie zaokrglenia */
    opacity: 0; /* Domylnie ukryte */
    transition: opacity 0.2s ease-in-out; /* Pynne pojawianie si */
    z-index: 1; /* Upewniamy si, 偶e jest nad treci, ale pod tekstem */
    pointer-events: none; /* Ignoruje kliknicia myszk */
}

/* Styl dla pseudo-elementu ::after, kt贸ry tworzy napis */
.all-projects-grid.layout-edit-mode .project-tile::after {
    content: 'Chwy i przenie'; /* Tekst do wywietlenia */
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%); /* Wyrodkowanie tekstu */
    color: white;
    font-weight: 600;
    font-size: 14px;
    opacity: 0; /* Domylnie ukryte */
    transition: opacity 0.2s ease-in-out; /* Pynne pojawianie si */
    z-index: 2; /* Upewniamy si, 偶e jest nad "mg" */
    pointer-events: none; /* Ignoruje kliknicia myszk */
    text-shadow: 1px 1px 2px rgba(0,0,0,0.7); /* Cie dla lepszej czytelnoci */
}

/* Pokazujemy "mg" i napis po najechaniu myszk na kafelek W TRYBIE EDYCJI */
.all-projects-grid.layout-edit-mode .project-tile:hover::before,
.all-projects-grid.layout-edit-mode .project-tile:hover::after {
    opacity: 1;
}

/* Zmieniamy kursor na apk w trybie edycji (ta regua ju偶 mo偶e istnie, upewnij si) */
.all-projects-grid.layout-edit-mode .project-tile {
    cursor: grab;
}

/* === KONIEC: NOWE STYLE DLA EFEKTU "MGY" === */
        .favorite-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px;
            color: var(--text-secondary);
        }
        .favorite-btn svg {
    width: 24px;
    height: 24px;
    transition: fill 0.2s, stroke 0.2s, transform 0.2s;
    fill: none; /* Usuwa wypenienie (rodek bdzie przezroczysty) */
    stroke: var(--text-secondary); /* Ustawia kolor ramki */
    stroke-width: 2px; /* Ustawia grubo ramki, aby bya widoczna */
}
.favorite-btn.is-favorite svg {
    fill: #f43f5e; /* Wypenia serce na czerwono po klikniciu */
    stroke: #f43f5e; /* Zmienia te偶 kolor ramki na czerwony dla jednolitego efektu */
}
        .favorite-btn:hover svg {
            transform: scale(1.15);
        }
        .project-tile-details {
            font-size: 13px;
            color: var(--text-secondary);
        }
        .project-tile-owner, .project-tile-members-list {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .project-tile-members {
            display: flex;
            margin-top: 8px;
        }
        .project-tile-members .avatar {
            width: 28px;
            height: 28px;
            font-size: 12px;
        }
        /* === KONIEC: NOWE STYLE DLA WIDOKU WSZYSTKICH PROJEKTW === */
        /* === POCZTEK: NOWE STYLE DLA USTAWIE I AWATARW === */

/* Powikszenie awatar贸w w caej aplikacji o ~30% i obsuga <img> */
.avatar {
    width: 42px;
    height: 42px;
    font-size: 16px;
    object-fit: cover; /* Wa偶ne dla zdj w awatarach */
    background-size: cover; /* Dodatkowe wsparcie dla te */
    background-position: center; /* Wyrodkowanie */
}
.task-assignees .avatar {
    width: 42px;
    height: 42px;
    font-size: 16px;
}
.member-pill-avatar {
    width: 26px;
    height: 26px;
    font-size: 12px;
}
.project-tile-members .avatar {
    width: 36px;
    height: 36px;
    font-size: 14px;
}

/* Style dla g贸wnego okna ustawie */
.settings-main-content {
    padding: 24px;
    text-align: center;
}
.settings-profile-header {
    margin-bottom: 24px;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 12px;
}
.avatar-large {
    width: 90px;
    height: 90px;
    border-radius: 50%;
    background-color: var(--bg-tertiary);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 36px;
    font-weight: 600;
    color: var(--text-primary);
    border: 3px solid var(--border-color);
    object-fit: cover;
    background-size: cover;
    background-position: center;
}
.settings-profile-header h3 {
    font-size: 20px;
    font-weight: 600;
}
.settings-actions {
    display: flex;
    flex-direction: column;
    gap: 12px;
}
.settings-actions .btn {
    width: 100%;
}
/* === KONIEC: NOWE STYLE DLA USTAWIE I AWATARW === */
        .avatar.avatar-comment {
    width: 48px;
    height: 48px;
    font-size: 11px;
}
        /* === POCZTEK: Efekt "lupy" dla awatar贸w na kartach zada === */

/* Ta regua sprawia, 偶e efekt dziaa tylko na urzdzeniach z myszk (nie na dotykowych) */
@media (hover: hover) and (min-width: 769px) {
    
    /* Dodajemy pynne przejcie do wszystkich awatar贸w w grupie */
    .task-assignees .avatar {
        transition: transform 0.2s ease-out, margin 0.2s ease-out;
        cursor: pointer;
    }

    /* Kiedy naje偶d偶amy myszk na ca grup awatar贸w... */
    .task-assignees:hover .avatar {
        /* ...wszystkie awatary lekko si od siebie odsuwaj */
        margin-left: -4px;
    }

    /* Kiedy naje偶d偶amy na JEDEN konkretny awatar w grupie... */
    .task-assignees .avatar:hover {
        /* ...powikszamy go i wysuwamy na wierzch, ponad inne */
        transform: scale(2) translateY(-5px);
        z-index: 10;
    }
}

/* === KONIEC: Efekt "lupy" dla awatar贸w === */
        /* === POCZTEK: Style dla ikon w rogu karty zadania === */
/* === NOWA KLASA: Ikona Ostrze偶enia === */
        .task-warning-icon {
            display: inline-flex;
            align-items: center;
            margin-left: 8px; /* Odstp od tytuu */
            vertical-align: middle;
            flex-shrink: 0;
        }
        /* === KONIEC === */
.task-card-icons {
    position: static; 
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    
    /* === ZMIANA: Wyr贸wnanie do prawej === */
    justify-content: flex-end; 
    width: 100%; /* Gwarantuje, 偶e kontener zajmie ca szeroko, 偶eby m贸c wyr贸wna do prawej */
    
    gap: 6px; /* Nieco mniejszy odstp dla estetyki */
    
    /* Pozycjonowanie wiersza */
    margin-top: 4px; 
    margin-bottom: 4px; /* Mniejszy odstp od dou (od awatar贸w) */
    padding-left: 0;    /* USUNITO: Nie potrzebujemy wcicia z lewej */
    
    z-index: 2;
}

/* Ta klasa nie jest ju偶 potrzebna, ale mo偶emy j zostawi pust lub usun */
.task-icons-row {
    display: contents; /* Sprawia, 偶e wrapper znika logicznie */
}

.task-card-icons .task-detail {
    margin: 0;
    padding: 0;
}

/* === KONIEC: Style dla ikon w rogu karty zadania === */
        .department-header {
    font-size: 14px;
    font-weight: 600;
    color: var(--text-secondary);
    text-transform: uppercase;
    margin-top: 20px;
    margin-bottom: 12px;
    padding-bottom: 8px;
    border-bottom: 1px solid var(--border-color);
}
.department-header:first-of-type {
    margin-top: 0;
}
        /* === POCZTEK: Style dla akordeonu dzia贸w === */

.department-group {
    margin-bottom: 8px;
}

.department-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px;
    border-radius: var(--border-radius);
    background-color: var(--bg-tertiary);
    cursor: pointer;
    transition: background-color 0.2s;
}
.department-header:hover {
    background-color: var(--border-color);
}
.department-header .chevron {
    width: 20px;
    height: 20px;
    transition: transform 0.3s ease;
}
.department-header.active .chevron {
    transform: rotate(90deg);
}

.department-users {
    display: flex;
    flex-direction: column; /* Przeniesione z JS: Ukad pionowy */
    gap: 4px;               /* Przeniesione z JS: Odstp */
    padding: 8px 4px;       /* Przeniesione z JS: Padding */
    
    /* Animacja wysokoci i paddingu */
    transition: max-height 0.3s ease-in-out, padding 0.3s ease-in-out, opacity 0.3s ease-in-out;
    overflow: hidden;
    
    /* Domylna maksymalna wysoko dla stanu rozwinitego (musi by du偶a, by pomieci list) */
    max-height: 1000px; 
    opacity: 1;
}

.department-users.collapsed {
    max-height: 0;
    padding-top: 0 !important;    /* !important zapewnia, 偶e nic tego nie nadpisze */
    padding-bottom: 0 !important; /* !important zapewnia, 偶e nic tego nie nadpisze */
    opacity: 0;
    pointer-events: none; /* Zapobiega klikaniu w ukryte elementy */
}
/* === KONIEC: Style dla akordeonu dzia贸w === */
        /* === POCZTEK: Style dla edytora Croppie === */
#croppie-container {
    width: 300px;
    height: 300px;
    margin: 0 auto;
}
        /* NOWE STYLE: Rozciganie list wewntrz kart akcji i wczenie przewijania */
        .action-column .dashboard-card .overdue-list-container,
        .action-column .dashboard-card .activity-list {
            flex-grow: 1; /* Pozwala elementowi rosn i wypenia dostpn przestrze */
            min-height: 0; /* Wa偶na poprawka dla poprawnego dziaania flexbox */
            overflow-y: auto; /* NAJWA呕NIEJSZE: Wcza przewijanie, gdy zawarto si nie mieci */
            max-height: none; /* Usuwamy ewentualne stare ograniczenia wysokoci */
        }
/* === KONIEC: Style dla edytora Croppie === */
        /* === POCZTEK: NOWE STYLE DLA OKADEK KART (COVER IMAGES) === */

        /* 1. Nowy modal do kadrowania okadki (w du偶ej mierze wsp贸dzielony z #crop-photo-modal) */
        #task-cover-croppie-modal .modal {
            max-width: 500px; /* Szerszy dla lepszego kadrowania okadki */
        }
        #task-cover-croppie-container {
            width: 100%; /* Domylnie 400px */
            height: 250px; /* Ni偶szy, bardziej panoramiczny */
            margin: 0 auto;
        }

        /* 2. Style dla kafelka zadania, kt贸ry posiada okadk */
        .task-card.has-cover-image {
            padding-top: 0; /* Usuwamy g贸rny padding, bo okadka przylega */
            padding-left: 0; /* Usuwamy lewy padding dla checkboxa */
            padding-right: 0; /* Usuwamy prawy padding dla ikon */
        }

        /* 3. Kontener na obrazek okadki */
        .task-cover-image {
            width: 100%;
            height: 120px; /* Staa wysoko okadki */
            background-size: cover;
            background-position: center;
            border-top-left-radius: var(--border-radius);
            border-top-right-radius: var(--border-radius);
            position: relative; /* Potrzebne do pozycjonowania checkboxa i ikon */
        }

        /* 4. Modyfikacja checkboxa, gdy jest okadka */
        .task-card.has-cover-image .task-card-checkbox {
            position: absolute; /* Pozycjonowanie wzgldem .task-cover-image */
            top: 8px;
            left: 8px;
            z-index: 3;
            /* P贸przezroczyste to dla widocznoci */
            background-color: rgba(255, 255, 255, 0.7);
            border-radius: 4px;
            padding: 1px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }

        /* 5. Modyfikacja ikon (termin, podzadania), gdy jest okadka */
        .task-card.has-cover-image .task-card-icons {
            position: absolute; /* Pozycjonowanie wzgldem .task-cover-image */
            top: 8px;
            right: 8px;
            z-index: 3;
            /* P贸przezroczyste to dla widocznoci */
            background-color: rgba(255, 255, 255, 0.8);
            padding: 2px 4px;
            border-radius: var(--border-radius);
            box-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }

        /* 6. Modyfikacja reszty zawartoci kafelka (tytu, meta), gdy jest okadka */
        .task-card.has-cover-image .task-project-name,
        .task-card.has-cover-image h4,
        .task-card.has-cover-image .task-meta,
        .task-card.has-cover-image .kanban-subtask-list-container {
            /* Przywracamy padding, kt贸ry usunlimy z .task-card */
            padding-left: 12px;
            padding-right: 12px;
        }

        /* Pierwszy element (zazwyczaj h4 lub .task-project-name) potrzebuje g贸rnego marginesu */
        .task-card.has-cover-image h4,
        .task-card.has-cover-image .task-project-name {
            margin-top: 10px;
        }
        /* Jeli jest i nazwa projektu i tytu, tylko nazwa projektu dostaje margines */
        .task-card.has-cover-image .task-project-name + h4 {
            margin-top: 0;
        }

        /* 7. Style dla nowych przycisk贸w w modalu (zakadka Zaczniki) */
        .attachment-actions-cover {
            display: flex;
            gap: 6px;
            margin-left: 12px; /* Odstp od przycisku usuwania */
        }
        .attachment-actions-cover .btn-cover-action {
            background: none;
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            font-size: 11px;
            font-weight: 500;
            padding: 2px 6px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .attachment-actions-cover .btn-cover-action:hover {
            background-color: var(--bg-tertiary);
            border-color: var(--accent-primary);
            color: var(--accent-primary);
        }
        /* Specjalny styl dla przycisku usuwania okadki */
        .attachment-actions-cover .remove-cover-image-btn {
            border-color: var(--danger-border);
            color: var(--danger-primary);
        }
        .attachment-actions-cover .remove-cover-image-btn:hover {
            background-color: var(--bg-tertiary);
            border-color: var(--danger-primary);
            color: var(--danger-primary);
        }

        /* 8. Poprawka dla .attachment-item, aby pomieci nowe przyciski */
        .attachment-item {
            /* display: flex; (ju偶 jest) */
            /* align-items: center; (ju偶 jest) */
            /* justify-content: space-between; (ju偶 jest) */
        }
        /* Nowy kontener na wszystkie przyciski po prawej */
        .attachment-item-controls {
            display: flex;
            align-items: center;
            gap: 4px;
            flex-shrink: 0; /* Zapobiega zawijaniu si przycisk贸w */
        }
        /* Poprawka dla .attachment-info, aby mogo si kurczy */
        .attachment-info {
            /* display: flex; (ju偶 jest) */
            /* align-items: center; (ju偶 jest) */
            /* gap: 10px; (ju偶 jest) */
            min-width: 0; /* WA呕NE: Pozwala nazwie pliku si skr贸ci (ellipsis) */
        }
        .attachment-name {
            /* ... (istniejce style) ... */
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis; /* Upewnia si, 偶e duga nazwa pliku nie rozpycha modala */
        }


        /* === KONIEC: NOWE STYLE DLA OKADEK KART === */
        /* === POCZTEK: NOWE STYLE DLA MODALA GALERII OKADEK === */
        #cover-templates-modal .modal {
            max-width: 800px; /* Wikszy modal dla galerii */
            height: 70vh; /* Do wysoki, aby pomieci siatk */
        }

        #cover-templates-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 16px;
            padding: 8px;
        }

        .cover-template-item {
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 8px;
            text-align: center;
            cursor: pointer;
            transition: border-color 0.2s, box-shadow 0.2s;
            position: relative;
        }
        .cover-template-item:hover {
            border-color: var(--accent-primary);
            box-shadow: var(--shadow-md);
        }

        .cover-template-item img {
            width: 100%;
            height: 110px;
            object-fit: cover;
            border-radius: var(--border-radius);
            margin-bottom: 8px;
            pointer-events: none; /* Uatwia kliknicie na label */
        }

        .cover-template-item span {
            font-weight: 500;
            font-size: 14px;
            pointer-events: none; /* Uatwia kliknicie na label */
        }

        /* Ukrywamy domylny radio button */
        .cover-template-item input[type="radio"] {
            display: none;
        }

        /* Styl "check" dla wybranej opcji */
        .cover-template-item.selected {
            border-color: var(--accent-primary);
            background-color: rgba(79, 70, 229, 0.05);
        }
        .cover-template-item.selected::after {
            content: '';
            position: absolute;
            top: 14px;
            right: 14px;
            width: 24px;
            height: 24px;
            background-color: var(--accent-primary);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 16px;
            box-shadow: var(--shadow-md);
        }

        /* === KONIEC: NOWE STYLE DLA MODALA GALERII OKADEK === */
        /* === POCZTEK: NOWE STYLE DLA WIDOKU "MJ DZIE" === */
        .my-day-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .my-day-task-item {
            display: flex;
            align-items: center;
            padding: 16px;
            background-color: var(--bg-secondary);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-sm);
            border-left: 5px solid transparent;
            cursor: pointer;
            transition: box-shadow 0.2s, border-color 0.2s;
            position: relative; /* <-- DODANA LINIA */
        }
        .my-day-task-item:hover {
            box-shadow: var(--shadow-md);
        }
        /* Style dla status贸w */
        .my-day-task-item.status-todo {
            border-left-color: var(--danger-primary);
        }
        .my-day-task-item.status-inprogress {
            border-left-color: var(--accent-primary);
        }
        .my-day-task-item-content {
            flex-grow: 1;
            margin-left: 16px;
        }
        .my-day-task-item-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }
        .my-day-task-item-title {
            font-size: 16px;
            font-weight: 600;
            flex: 1 1 0;
            min-width: 0;
            margin-right: 8px;
            color: var(--text-primary); /* NOWA LINIA: Jawne ustawienie koloru tekstu */
        }
        .task-status-pill {
            font-size: 11px;
            font-weight: 600;
            padding: 3px 10px;
            border-radius: 12px;
            text-transform: uppercase;
            color: var(--text-on-accent);
            white-space: nowrap;
            flex-shrink: 0; /* NOWA LINIA: Zapobiega kurczeniu si etykiety */
        }
        .task-status-pill.status-todo {
            background-color: var(--danger-primary);
        }
        .task-status-pill.status-inprogress {
            background-color: var(--accent-primary);
        }
        .my-day-task-item-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 13px;
            color: var(--text-secondary);
        }
        .my-day-project-name {
            font-weight: 500;
        }
        /* === NOWE STYLE DLA LINKU PROJEKTU W WIDOKU MJ DZIE === */
        .my-day-project-name a {
            text-decoration: none; /* Usu domylne podkrelenie */
            color: var(--text-secondary); /* Zmieniono na standardowy kolor tekstu */
            font-weight: 500; /* Standardowa waga, jak reszta metadanych */
            display: inline-block; /* Umo偶liwia transformacj */
            transition: transform 0.15s ease-out, color 0.15s ease-out; /* Pynne przejcie */
            cursor: pointer;
        }

        .my-day-project-name a:hover {
            transform: scale(1.1); /* Powikszenie po najechaniu */
            color: var(--accent-primary); /* Podwietlenie kolorem akcentujcym */
        }
        /* === KONIEC NOWYCH STYLI === */
        .my-day-separator {
            padding: 12px 0 4px 0;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            border-bottom: 2px solid var(--border-color);
        }
        .my-day-task-item.completed {
            opacity: 0.7;
            border-left-color: var(--success-primary);
        }
        .my-day-task-item.completed .task-status-pill {
            background-color: var(--success-primary);
        }
        /* === KONIEC: NOWE STYLE DLA WIDOKU "MJ DZIE" === */

        /* === POCZTEK: STYLE DLA MENU WZMIANEK (TRIBUTE.JS) === */
        .tribute-container {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-lg);
            overflow: hidden;
            font-family: var(--font-family);
        }
        .tribute-container ul {
            list-style: none;
            margin: 0;
            padding: 4px 0;
        }
        .tribute-container li {
            padding: 8px 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .tribute-container li.highlight,
        .tribute-container li:hover {
            background-color: var(--bg-tertiary);
        }
        .tribute-container li.highlight {
            font-weight: 600;
        }
        .tribute-container .avatar-mention {
            width: 24px;
            height: 24px;
            font-size: 11px;
            border-radius: 50%;
            flex-shrink: 0;
        }
        /* === KONIEC: STYLE DLA MENU WZMIANEK (TRIBUTE.JS) === */
        /* === POCZTEK: NOWE STYLE DLA SUBZADA (Wersja 2.1 - Przycisk + Modal) === */

        /* Kontener dla subzada w g贸wnym modalu */
        .subtasks-section {
            margin-top: 20px; /* Odstp od tytuu */
            padding-bottom: 20px; /* Odstp przed zakadkami */
            border-bottom: 1px solid var(--border-color); /* Linia oddzielajca */
            margin-bottom: 20px;
        }

        /* Przycisk "Dodaj podzadanie" */
        #add-subtask-btn-main {
            margin-bottom: 16px;
            display: flex; /* Aby wyrodkowa ikon i tekst */
            align-items: center;
            gap: 8px;
            font-size: 14px; /* Mniejsza czcionka */
            padding: 6px 12px; /* Mniejszy padding */
        }
        #add-subtask-btn-main svg {
            width: 16px;
            height: 16px;
        }

        /* Lista subzada w g贸wnym modalu */
        .subtasks-list-main {
            list-style: none;
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 250px; /* Ograniczenie wysokoci z przewijaniem */
            overflow-y: auto;
            padding-right: 5px; /* Miejsce na pasek przewijania */
        }

        /* Styl pojedynczego subzadania na licie */
        .subtask-item {
            display: flex;
            align-items: center;
            gap: 8px; /* Zmniejszono gap, aby zmieci wicej element贸w */
            padding: 8px 8px;
            background-color: var(--bg-primary);
            border-radius: var(--border-radius);
            border-left: 4px solid var(--border-color);
            transition: background-color 0.2s;
            position: relative;
        }
        
        /* Nowy styl dla uchwytu do przecigania */
        .subtask-drag-handle {
            cursor: grab;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            padding: 2px;
            opacity: 0.5;
        }
        .subtask-drag-handle:hover {
            opacity: 1;
            color: var(--text-primary);
        }

        /* Styl dla daty w podzadaniu */
        .subtask-item-date {
            font-size: 11px;
            color: var(--text-secondary);
            margin-left: auto; /* Przesuwa dat przed awatary */
            margin-right: 8px;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .subtask-item-date.overdue {
            color: var(--danger-primary);
            font-weight: 600;
        }

        /* Poprawka dla kontenera awatar贸w, aby nie u偶ywa margin-left: auto */
        .subtask-assignees {
            display: flex;
            align-items: center;
            /* margin-left: auto; <--- USUNITE (data przejmuje t rol) */
            padding-left: 0;
        }
        .subtask-item:hover {
             background-color: var(--bg-tertiary); /* Efekt hover */
        }

        .subtask-item.completed {
            border-left-color: var(--success-primary);
            opacity: 0.7;
        }
        .subtask-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            flex-shrink: 0;
            cursor: pointer;
        }
        .subtask-item input[type="checkbox"]:disabled {
            cursor: not-allowed;
            opacity: 0.6;
        }
        .subtask-item-title {
            flex-grow: 1;
            font-size: 15px;
            cursor: pointer; /* Tytu jest klikalny do edycji */
        }
        .subtask-item.completed .subtask-item-title {
            text-decoration: line-through;
            color: var(--text-secondary);
        }

        /* Awatary przypisanych os贸b */
        .subtask-assignees {
            display: flex;
            align-items: center;
            margin-left: auto; /* Przesuwa awatary i przyciski na prawo */
            padding-left: 10px;
        }
        .subtask-item .avatar {
            width: 28px;
            height: 28px;
            font-size: 12px;
            margin-left: -6px;
            border: 2px solid var(--bg-primary);
            flex-shrink: 0;
        }
        .subtask-item .avatar:first-child {
            margin-left: 0;
        }

        /* Przyciski akcji (edycja, usuwanie) */
        .subtask-actions {
            display: flex;
            align-items: center;
            gap: 4px;
            opacity: 0; /* Domylnie ukryte */
            transition: opacity 0.2s;
        }
        .subtask-item:hover .subtask-actions {
            opacity: 1; /* Pokazuj przy najechaniu */
        }
        .subtask-action-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 18px;
            line-height: 1;
            cursor: pointer;
            padding: 3px;
            border-radius: 4px;
            display: flex; /* Dla SVG */
            align-items: center;
        }
        .subtask-action-btn svg {
            width: 16px;
            height: 16px;
        }
        .subtask-action-btn:hover {
            background-color: var(--border-color);
        }
        .subtask-action-btn.delete:hover {
            color: var(--danger-primary);
        }
         .subtask-action-btn.edit:hover {
            color: var(--accent-primary);
        }

        /* Style dla nowego modala subzadania */
       #subtask-modal .modal {
            max-width: 900px; /* Mniejszy modal */
            
            /* ZMIANA: Ustawiamy sztywn wysoko, aby okno nie skakao */
            height: 90vh; 
            
            /* ZMIANA: Usuwamy max-height lub ustawiamy je tak samo, 
               ale height: 70vh jest wystarczajce i stabilne */
            max-height: 90vh; 
            
            display: flex;
            flex-direction: column;
        }
        #subtask-modal .members-selection-pills {
             max-height: 150px; /* Mniejsza wysoko dla piguek */
        }
        #subtask-modal .form-modal-content {
             padding-bottom: 0; /* Zmniejsz padding dolny */
        }

        /* === KONIEC: NOWE STYLE DLA SUBZADA (Wersja 2.1) === */
        /* NOWE REGUY: NAPRAWA WIDOKU SZABLONW */
        #project-templates-modal .modal-header {
             /* U偶ywamy domylnego paddingu w poziomie, nadpisujemy go tutaj, aby u偶y w kolejnych reguach. */
             padding: 16px 24px; 
        }
        
        #project-templates-modal > .modal > div:first-child .modal-header {
            /* Nag贸wek lewej kolumny: Usu lini doln, aby pionowa linia moga si z ni poczy. */
            border-bottom: none; 
            /* Utrzymaj padding z g贸ry/dou dla lepszej czytelnoci. */
        }

        #project-templates-modal > .modal > #template-details-view .modal-header {
            /* Nag贸wek prawej kolumny: Upewnij si, 偶e ma lini doln, aby oddzieli nag贸wek od treci. */
             border-bottom: 1px solid var(--border-color); 
        }
        
        #project-templates-modal .form-modal-content {
             /* Usu g贸rny/dolny padding z kontenera treci, aby listy przylegay do nag贸wk贸w i stopki. */
             padding-top: 0; 
             padding-bottom: 0;
        }
        
        #project-templates-modal .modal-footer {
            /* Dodaj g贸rn ramk do stopki prawej kolumny, aby oddzieli od przycisk贸w. */
            border-top: none;
        }

        /* U偶ywamy tego do przywr贸cenia sp贸jnoci stopki */
        #project-templates-modal > .modal > div:first-child .modal-footer {
            border-top: 1px solid var(--border-color);
        }

        /* KONIEC NOWYCH REGU NAPRAWY WIDOKU SZABLONW */
        /* === NOWE REGUY DLA MODALA SZABLONW (DESKTOP) === */
        @media (min-width: 769px) {
            #project-templates-modal .modal {
                max-width: 900px;
                height: 70vh;
                flex-direction: row;
            }
        }
        /* === KONIEC REGU DESKTOP === */
        /* === POCZTEK: NOWE STYLE DLA MODALA SZCZEGW PROJEKTU === */
        #project-details-modal .form-modal-content {
            grid-template-columns: 1fr; /* Domylnie jedna kolumna */
        }

        /* Ukad dwukolumnowy dla wikszych ekran贸w */
        @media (min-width: 768px) {
            #project-details-modal .form-modal-content {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .project-details-info p {
            margin-bottom: 8px;
            font-size: 14px;
        }
         .project-details-info p strong {
             color: var(--text-secondary);
         }

        /* Style dla wykresu bud偶etu (nowoczesne supki CSS) */
        .budget-summary-bar {
            height: 25px;
            background-color: var(--bg-tertiary);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 8px;
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.1);
            position: relative; /* Dla etykiet wewntrz */
        }
        .budget-summary-fill {
            height: 100%;
            border-radius: 4px 0 0 4px; /* Zaokrglenie tylko z lewej */
            transition: width 0.6s ease-out;
            display: flex;
            align-items: center;
            justify-content: flex-end; /* Tekst przy prawej krawdzi wypenienia */
            padding-right: 8px;
            color: white;
            font-size: 12px;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden; /* Ukryj tekst, jeli si nie mieci */
        }
        .budget-fill-items {
            background: linear-gradient(90deg, var(--accent-hover), var(--accent-primary));
        }
        .budget-fill-over { /* Styl dla przekroczenia bud偶etu */
             background: linear-gradient(90deg, var(--danger-hover), var(--danger-primary));
        }
        .budget-label {
             font-size: 13px;
             color: var(--text-secondary);
             display: flex;
             justify-content: space-between;
             margin-bottom: 4px;
        }
        .budget-label strong {
            color: var(--text-primary);
            font-weight: 600;
        }
        #details-budget-chart-container {
             padding: 10px;
             border: 1px solid var(--border-color);
             border-radius: var(--border-radius);
             background-color: var(--bg-primary);
        }
        /* === NOWA REGUA (NAPRAWIAJCA ZWIJANIE PIERWSZEJ SEKCJI) === */
        #details-budget-chart-container.collapsed {
            padding-top: 0;
            padding-bottom: 0;
            border-width: 0 1px; /* Sp贸jne zanikanie ramki */
        }
        /* === KONIEC NOWEJ REGUY === */

        /* Styl dla obszaru wykresu obci偶enia */
        #details-workload-chart-container {
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            background-color: var(--bg-primary);
            padding: 16px;
            display: flex; /* Wyrodkowanie placeholdera */
            align-items: center;
            justify-content: center;
        }
        /* === ETAP 4: NOWE STYLE DLA TABELI KOSZTW ZADA === */
    #details-budget-tasks-table-container table {
        width: 100%;
        border-collapse: collapse;
    }
    #details-budget-tasks-table-container th,
    #details-budget-tasks-table-container td {
        padding: 8px 12px;
        text-align: left;
        border-bottom: 1px solid var(--border-color);
        font-size: 13px;
        background-color: var(--bg-secondary); /* Domylne to dla wierszy */
    }
    #details-budget-tasks-table-container th {
        background-color: var(--bg-tertiary);
        font-weight: 600;
        color: var(--text-secondary);
        position: sticky; /* Przyklejony nag贸wek podczas przewijania */
        top: 0;
        z-index: 1; /* Upewnij si, 偶e nag贸wek jest na wierzchu */
    }
    #details-budget-tasks-table-container tr:last-child td {
        border-bottom: none;
    }
    #details-budget-tasks-table-container td:last-child {
        text-align: right;
        font-weight: 500;
    }
    #details-budget-tasks-table-container .task-cost-row:hover td {
        background-color: var(--bg-tertiary);
    }
    #details-budget-tasks-table-container tfoot td {
        background-color: var(--bg-primary);
        font-weight: 600;
        font-size: 14px;
        border-top: 2px solid var(--border-color);
    }

    /* NOWY STYL: Klikalna nazwa zadania w tabeli bud偶etu */
    #details-budget-tasks-table-container .clickable-task-name {
        cursor: pointer;
        color: var(--accent-primary);
        font-weight: 600;
    }
    #details-budget-tasks-table-container .clickable-task-name:hover {
        text-decoration: underline;
    }
    /* === KONIEC STYLI ETAPU 4 === */
        /* === KONIEC: NOWE STYLE DLA MODALA SZCZEGW PROJEKTU === */
        /* === NOWE STYLE DLA ZWIJANYCH SEKCJI W SZCZEGACH PROJEKTU === */
        .collapsible-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 4px;
            margin-bottom: 0;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            user-select: none;
            transition: background-color 0.2s;
        }
        .collapsible-header:hover {
            background-color: var(--bg-tertiary);
        }
        .collapsible-header h3 {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
        }

        /* NOWY WRAPPER DLA KONTROLEK */
        .collapsible-controls {
            display: flex;
            align-items: center;
            gap: 6px;
            color: var(--text-secondary);
        }
        .collapsible-controls .toggle-text {
            font-size: 12px;
            font-weight: 500;
            text-transform: uppercase;
        }
        
        .collapsible-header .chevron {
            width: 18px;
            height: 18px;
            transition: transform 0.3s ease;
            transform: rotate(180deg); /* Rozwinity (bez .collapsed) = strzaka w GR */
        }
        .collapsible-header.collapsed .chevron {
            transform: rotate(0deg); /* Zwinity (z .collapsed) = strzaka w D (SVG to v) */
        }
        
        /* Styl dla rozwinitej treci */
        .collapsible-content {
            max-height: 600px; /* Maksymalna wysoko do animacji */
            overflow: hidden;
            transition: all 0.3s ease-out; /* Animuj wszystko */
            
            border: 1px solid var(--border-color);
            border-radius: 0 0 var(--border-radius) var(--border-radius);
            border-top: none;
            padding: 16px;
            background-color: var(--bg-primary);
        }
        
        /* Styl dla zwinitej treci - NAPRAWIONY */
        .collapsible-content.collapsed {
            max-height: 0;
            padding-top: 0;
            padding-bottom: 0;
            border-width: 0 1px; /* Ukryj g贸rn i doln ramk, ale zostaw boczne */
            opacity: 0; /* Dodaj zanikanie */
            transition: all 0.3s ease-in;
        }
        
        /* Specyficzne style dla kontener贸w (przeniesione z inline HTML) */
        
        /* Bud偶et - Tabela */
        #details-budget-tasks-table-container.collapsible-content {
             padding: 0; /* Tabela ma wasny padding */
             max-height: 300px; /* Ustawiamy max-height dla stanu rozwinitego */
             overflow-y: auto; /* Wczamy przewijanie dla stanu rozwinitego */
        }
        #details-budget-tasks-table-container.collapsible-content.collapsed {
             max-height: 0;
             padding: 0;
             border-width: 0 1px; /* Zapewnij sp贸jne zanikanie ramki */
        }

         /* Obci偶enie - Wykres */
        #details-workload-chart-container.collapsible-content {
            height: 300px; /* Staa wysoko dla stanu rozwinitego */
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #details-workload-chart-container.collapsible-content.collapsed {
            height: 0; /* Zwijamy wysoko */
            max-height: 0;
            padding-top: 0;
            padding-bottom: 0;
            border-width: 0 1px;
        }
        /* === KONIEC NOWYCH STYLI DLA ZWIJANYCH SEKCJI === */
        /* === POCZTEK NOWYCH STYLI DLA UKADU META PROJEKTU === */
        .project-meta-wrapper {
            display: flex;         /* Ustawia ukad flexbox (elementy obok siebie) */
            align-items: center;   /* Wyr贸wnuje awatary i pasek postpu w pionie */
            gap: 16px;             /* Dodaje odstp 16px midzy awatarami a paskiem postpu */
            margin-top: 8px;       /* Dodaje may odstp od tytuu/akcji powy偶ej */
        }

        #project-progress {
            /* Usunito margin-top: 16px; (jeli istnia w CSS) */
            flex-grow: 1;          /* Pozwala paskowi postpu zaj dostpn przestrze */
            /* Inne istniejce style dla #project-progress pozostaj bez zmian */
        }
        /* === KONIEC NOWYCH STYLI === */

        /* Istniejce style dla .project-members pozostaj bez zmian */
        .project-members { 
            display: flex; 
            align-items: center; 
            /* margin-top: 4px; */ /* Ten margin mo偶e by ju偶 niepotrzebny lub wymaga dostosowania */
            flex-shrink: 0;      /* Zapobiega kurczeniu si sekcji awatar贸w */
        }
        /* === NOWE STYLE SPECJALNIE DLA PRZYCISKW "Edytuj ukad" === */
        #edit-dashboard-layout-btn,
        #edit-projects-layout-btn {
            gap: 6px; /* Przywracamy odstp midzy ikon a tekstem */
            padding: 6px 12px; /* Przywracamy oryginalny padding */
            border-color: var(--accent-primary); /* Niebieska ramka */
            color: var(--accent-primary);       /* Niebieski tekst/ikona */
            background-color: transparent; /* Upewniamy si, 偶e to jest przezroczyste */
        }

        #edit-dashboard-layout-btn:hover,
        #edit-projects-layout-btn:hover {
            background-color: var(--accent-primary); /* Niebieskie to przy najechaniu */
            color: var(--text-on-accent);          /* Biay tekst/ikona przy najechaniu */
            border-color: var(--accent-primary); /* Utrzymanie koloru ramki dla sp贸jnoci */
        }
        /* === KONIEC NOWYCH STYLI === */
        /* Zastosowano czcionk Kaushan Script dla daty M贸j Dzie (desktop) */
        h2#my-day-date-display {
            font-size: 32px; 
            font-family: var(--font-family-header);
            font-weight: 700; /* <-- PRZYWRCONO pogrubienie dla Poppins */
        }
        /* === NOWA REGUA DLA TYTUU "M贸j dzie" === */
        #my-day-nav h2#my-day-view-title { /* Stylizujemy nowy tytu */
            font-family: var(--font-family-header);
            font-size: 32px;
            margin: 0 24px 0 0; /* Dodajemy du偶y margines z prawej, aby oddzieli od nawigacji */
            line-height: 1.2;
        }
        /* DODANO: Domylne ukrycie logo mobilnego na desktopie */
        .auth-mobile-logo {
            display: none;
        }
        /* === KONIEC NOWEJ REGUY === */
        /* === NOWE REGUY: Poprawa wygldu list zada w Dashboard Details Modal i Upcoming Tasks === */
        #dashboard-details-content .task-card,
        #dashboard-upcoming-list .task-card {
            list-style: none; /* Usuwa czarne kropki */
            margin-left: 0;   /* Usuwa ewentualne wcicie listy */
        }
        #dashboard-details-content,
        #dashboard-upcoming-list {
             padding-left: 0; /* Usuwa ewentualne dopenienie kontenera listy */
        }
        /* === KONIEC NOWYCH REGU === */
        
        /* === NOWE STYLE DLA KAFELKA SONDAR呕U === */
        .poll-card {
            background-color: var(--bg-secondary);
            border-radius: var(--border-radius);
            padding: 12px; /* <-- ZMIENIONO (powr贸t do 12px) */
            margin-bottom: 12px;
            box-shadow: var(--shadow-sm);
            cursor: pointer; 
            transition: all 0.2s;
            position: relative;
            /* Powr贸t do standardowej, niebieskiej ramki jak w zadaniu */
            border: 1px solid var(--accent-primary); /* <-- ZMIENIONO */
        }

        /* Dodatkowa regua dla trybu ciemnego */
        .dark-mode .poll-card {
             /* Ta regua pozostaje pusta/nieu偶ywana */
        }

        /* === NOWE STYLE DLA NAGWKA WACICIELA SONDAR呕U === */
        .poll-card-header {
            /* U偶ywamy koloru ta "innego czonka" */
            background-color: var(--task-bg-other-member);
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-secondary);
            text-transform: uppercase;
            font-weight: 600;
            /* Nowe marginesy i paddingi, aby stworzy sekcj nag贸wka */
            margin: -12px -12px 12px -12px; /* Negatywny margines "wyciga" to do krawdzi kafelka */
            padding: 8px 12px; /* Wewntrzny padding dla nag贸wka */
            border-bottom: 1px solid var(--border-color); /* Linia oddzielajca */
            border-top-left-radius: var(--border-radius); /* Zaokrglenie rog贸w */
            border-top-right-radius: var(--border-radius);
        }

        .poll-card-header .poll-label {
            font-size: 15px; /* Ustawiamy jeden, sp贸jny rozmiar */
            margin-right: auto; 
        }
        
        .poll-card-header .poll-owner-text {
            font-size: 11px; /* Mniejszy tekst "waciciel:" */
        }

        .poll-card-header .avatar {
            width: 24px; /* Mniejszy awatar pasujcy do nag贸wka */
            height: 24px;
            font-size: 11px;
            margin-left: 0 !important;
        }
        /* === KONIEC NOWYCH STYLI === */
        .poll-card:hover {
            box-shadow: var(--shadow-md);
        }

        .poll-card h4 {
            font-size: 15px; 
            font-weight: 600; 
            margin-bottom: 12px; 
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: block; 
            max-width: 80%; /* Dajemy miejsce na ikon */
        }

        .poll-card-icon {
            display: none; /* <-- DODANA LINIA */
            position: absolute;
            top: 10px;
            right: 10px;
            color: var(--success-primary);
        }
        .poll-card-icon svg {
            width: 20px;
            height: 20px;
        }

        .poll-options {
            display: flex;
            flex-direction: column;
            gap: 8px; /* Odstp midzy opcjami */
            margin-bottom: 12px;
        }

        /* --- Style dla opcji (przyciski) --- */
        .poll-option-item {
            width: 100%;
        }
        .poll-vote-btn {
            width: 100%;
            padding: 8px 12px;
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
            background-color: var(--bg-primary);
            color: var(--text-primary);
            font-weight: 500;
            font-size: 14px;
            cursor: pointer;
            text-align: left;
            transition: background-color 0.2s, border-color 0.2s;
        }
        .poll-vote-btn:hover {
            background-color: var(--bg-tertiary);
            border-color: var(--accent-primary);
        }
        /* Zablokowany przycisk podczas gosowania */
        .poll-vote-btn:disabled {
            background-color: var(--bg-tertiary);
            color: var(--text-secondary);
            cursor: wait;
        }

        /* --- Style dla opcji (wyniki) --- */
        .poll-option-result {
            font-size: 13px;
            font-weight: 500;
        }
        .poll-option-result.voted {
            color: var(--accent-primary); /* Podwietl opcj, na kt贸r zagosowa u偶ytkownik */
            font-weight: 700;
        }
        .poll-result-bar-container {
            width: 100%;
            height: 10px;
            background-color: var(--bg-tertiary);
            border-radius: 5px;
            margin-top: 2px;
            overflow: hidden;
        }
        .poll-result-bar-fill {
            height: 100%;
            background-color: var(--accent-primary); /* <-- ZMIANA: Kolor paska na niebieski */
            width: 0%; /* Ustawiane przez JS */
            transition: width 0.5s ease-out;
            border-radius: 5px;
        }
        .poll-result-text {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .poll-vote-count {
            font-size: 12px;
            color: var(--text-secondary);
        }

        /* Meta (avatary i data) - u偶ywa styl贸w .task-meta */
        .poll-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 8px;
        }
        .poll-details {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .poll-detail {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 12px;
            color: var(--text-secondary);
        }
        .poll-detail svg {
            width: 15px;
            height: 15px;
        }
        .poll-assignees {
            display: flex;
        }
        .poll-assignees .avatar {
            width: 24px;
            height: 24px;
            font-size: 12px;
            border-color: var(--bg-tertiary);
        }
        /* === KONIEC STYLI DLA KAFELKA SONDAR呕U === */
        /* === NOWE STYLE DLA PRZECZNIKA (SUWAKA) - POPRAWIONA STRUKTURA === */
        
        /* 1. G贸wny kontener (teraz jest to <label>) */
        /* 1. G贸wny kontener - POPRAWKA: U偶ywamy Grid i specyficznego selektora */
        label.toggle-switch {
            display: grid; /* <-- ZMIANA: Z Flex na Grid */
            grid-template-columns: auto 1fr; /* Kolumna dla suwaka (auto) i tekst (1fr) */
            gap: 12px; /* Odstp midzy suwakiem a tekstem */
            align-items: center;
            cursor: pointer;
            font-weight: 500;
            margin-bottom: 0; /* <-- WA呕NE: Nadpisuje margin z .form-group label */
            min-width: 0;
            /* Usunito 'white-space' i 'overflow' z rodzica */
        }
        
        /* 2. Ukryty, prawdziwy checkbox (teraz wewntrz <label>) */
        .toggle-switch input[type="checkbox"] {
            display: none; 
        }

       /* 3. Wizualny suwak */
        .toggle-switch-slider {
            position: relative;
            width: 40px;
            height: 22px;
            background-color: var(--bg-tertiary);
            border-radius: 11px;
            transition: background-color 0.2s;
            border: 1px solid var(--border-color);
            /* USUNITE: flex-shrink: 0; (nie jest ju偶 w flexbox) */
        }

        /* 4. Kropka wewntrz suwaka */
        .toggle-switch-slider::before {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background-color: var(--bg-secondary);
            top: 2px;
            left: 3px;
            transition: transform 0.2s;
            box-shadow: var(--shadow-sm);
        }

        /* 5. Tekst obok suwaka */
        .toggle-switch-text {
            /* USUNITE: margin-left: 12px; (obsuguje to 'gap' w gridzie) */
            white-space: nowrap;     /* Tekst w jednej linii */
            overflow: hidden;        /* Ukryj nadmiarowy tekst */
            text-overflow: ellipsis; /* Poka偶 "..." */
            
            /* USUNITE: Waciwoci Flex (flex-grow, flex-shrink) */
            
            /* ZOSTAWIONE: To jest kluczowe dla ucinania tekstu w gridzie */
            min-width: 0;    
        }

        /* 6. ZMIANA STANU: U偶ywamy selektora rodzestwa (~), bo input jest teraz obok */
        .toggle-switch input[type="checkbox"]:checked ~ .toggle-switch-slider {
            background-color: var(--success-primary);
            border-color: var(--success-primary);
        }
        .toggle-switch input[type="checkbox"]:checked ~ .toggle-switch-slider::before {
            transform: translateX(17px);
        }
        /* === NOWE STYLE DLA MENU "ZASOBY I NARZDZIA" (Wysuwane) === */
        
        /* 1. Animacja dla ikony strzaki (chevron) */
        #resources-btn svg {
            transition: transform 0.3s ease-in-out;
        }
        
        /* 2. Styl dla strzaki, gdy menu jest otwarte (obr贸t o 180 stopni) */
        #resources-btn.open svg {
            transform: rotate(180deg);
        }

        

        /* Klasa aktywowana przez JS, gdy pasek JEST zwinity i kursor nad ikon */
        /* USUNITO: Regua #resources-menu.flyout-open */
        
        /* Usuwamy star logik otwierania/ukrywania zasob贸w w WIDOKU ROZWINITYM */
       .app-container:not(.sidebar-collapsed) #resources-menu {
            /* Nadpisuje style flyout, aby menu byo czci paska */
            position: static;
            width: 100%;
            padding: 0;
            border: none;
            box-shadow: none;
            transform: none;
            transition: max-height 0.3s ease-in-out; /* <- WA呕NA ZMIANA: Przywracamy animacj dla akordeonu */
            
            /* Resetowanie styli flyout (z Kroku 1) */
            left: auto;
            top: auto;
            
            /* Przywracamy star logik open/close dla rozwinitego sidebara: */
            max-height: 0;
            overflow: hidden;
            opacity: 1;
            visibility: visible;
        }
        .app-container:not(.sidebar-collapsed) #resources-menu.open {
            max-height: 120px;
        }
        /* === KONIEC NOWYCH STYLI === */
        /* NOWA REGUA: Statyczny blok stopki */
        .sidebar-static-footer-content {
            flex-shrink: 0; /* Kluczowa regua: Blok si nie kurczy */
            padding-top: 8px; /* Odstp od listy ulubionych powy偶ej */
        }
        /* === KONIEC NOWYCH STYLI === */
        /* === NOWE STYLE DLA MODALA CZATU AI === */
        #ai-help-modal .form-modal-content {
            display: flex;
            flex-direction: column;
            gap: 16px;
            background-color: var(--bg-primary);
        }

        #ai-chat-footer {
            display: flex;
            gap: 8px;
            padding: 12px 24px; /* Mniejszy padding g贸ra/d贸 */
            border-top: 1px solid var(--border-color);
        }

        #ai-chat-input {
            flex-grow: 1; /* Input zajmuje ca woln przestrze */
            padding: 10px;
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 14px;
        }
        
        #ai-chat-send-btn {
            flex-shrink: 0; /* Przycisk si nie kurczy */
            padding: 10px; /* Kwadratowy przycisk */
        }
        #ai-chat-send-btn:disabled {
            background-color: var(--bg-tertiary);
            cursor: wait;
        }

        .ai-chat-message {
            display: flex;
            max-width: 85%;
        }
        .ai-chat-bubble {
            padding: 10px 14px;
            border-radius: 12px;
            font-size: 14px;
            line-height: 1.4;
        }

        /* Dymek bota (po lewej) */
        .ai-chat-message.bot {
            justify-content: flex-start;
        }
        .ai-chat-message.bot .ai-chat-bubble {
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }
        
        /* Dymek u偶ytkownika (po prawej) */
        .ai-chat-message.user {
            justify-content: flex-end;
            align-self: flex-end;
        }
        .ai-chat-message.user .ai-chat-bubble {
            background-color: var(--accent-primary);
            color: var(--text-on-accent);
        }
        
        /* Dymek adowania (spinner) */
        .ai-chat-message.loading .ai-chat-bubble {
            padding: 10px 14px;
            display: flex;
            gap: 8px;
            align-items: center;
            font-style: italic;
            color: var(--text-secondary);
        }
        /* Prosty spinner CSS */
        .ai-spinner {
            width: 16px;
            height: 16px;
            border: 2px solid var(--border-color);
            border-top-color: var(--accent-primary);
            border-radius: 50%;
            animation: ai-spin 1s linear infinite;
        }
        @keyframes ai-spin {
            to { transform: rotate(360deg); }
        }
        /* === KONIEC STYLI DLA MODALA CZATU AI === */
        /* === POCZTEK: NOWE STYLE DLA PODZADA NA KANBANIE === */

       /* 1. Styl dla klikalnych trigger贸w (ikony "2/5", "1/3" multi oraz listy kontrolnej) */
        /* G贸wne zadanie ORAZ Podzadania */
        /* 1. Styl dla klikalnych trigger贸w (G贸wne zadanie ORAZ Podzadania) */
        .task-card-icons .js-toggle-subtasks,
        .task-card-icons .js-toggle-multi-status,
        .task-card-icons .js-toggle-checklist,
        .subtask-visual-icons .js-toggle-multi-status, /* <--- NAPRAWA DLA PODZADA */
        .subtask-visual-icons .js-toggle-checklist {   /* <--- NAPRAWA DLA PODZADA */
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .task-card-icons .js-toggle-subtasks:hover,
        .task-card-icons .js-toggle-multi-status:hover,
        .task-card-icons .js-toggle-checklist:hover,
        .subtask-visual-icons .js-toggle-multi-status:hover, /* <--- NAPRAWA DLA PODZADA */
        .subtask-visual-icons .js-toggle-checklist:hover {   /* <--- NAPRAWA DLA PODZADA */
            transform: scale(1.25); 
            color: var(--accent-primary); 
        }

        /* Styl ukrywania dla rodziny podzada (Kafelki) */
        .subtask-family-container.collapsed {
            display: none;
        }

        /* 2. G贸wny kontener na list podzada, status贸w multi ORAZ listy kontrolnej */
        .kanban-subtask-list-container,
        .kanban-multi-status-container,
        .kanban-checklist-container { /* <<< DODANO NOW KLAS */
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out, margin-top 0.3s ease-out, padding-top 0.3s ease-out;
            margin-top: 0;
            padding-top: 0;
            background-color: var(--bg-primary); /* Lekkie to dla odr贸偶nienia */
            border-radius: 4px;
        }
        
        /* 3. Styl kontenera w stanie rozwinitym */
        .kanban-subtask-list-container:not(.collapsed),
        .kanban-multi-status-container:not(.collapsed),
        .kanban-checklist-container:not(.collapsed) { /* <<< DODANO NOW KLAS */
            max-height: 250px; /* Troch wicej miejsca */
            overflow-y: auto;
            margin-top: 10px;
            padding: 8px;
            border-top: 1px dashed var(--border-color);
        }

        /* 4. Styl listy wewntrz kontenera */
        .kanban-subtask-list {
            list-style: none;
            display: flex;
            flex-direction: column;
            gap: 6px; /* Mniejszy odstp midzy podzadaniami */
        }
        
        /* 5. Styl pojedynczego elementu (wiersza) podzadania */
        .kanban-subtask-item {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 13px;
    padding: 4px 4px; /* Nieco wikszy padding dla awatar贸w */
    border-radius: 4px;
}

/* NOWE STYLE: Kontener na awatary w podzadaniach na KANBANIE */
.kanban-subtask-assignees {
    display: flex;
    margin-left: auto; /* Przesu na praw stron */
    padding-left: 8px;
}

/* Bardzo mae awatary na kafelku (18px) */
.kanban-subtask-assignees .avatar {
    width: 18px;
    height: 18px;
    font-size: 9px;
    margin-left: -4px; /* Lekkie nakadanie si */
    border: 1px solid var(--bg-secondary);
    margin-top: 0; 
    margin-bottom: 0;
}
.kanban-subtask-assignees .avatar:first-child {
    margin-left: 0;
}
        .kanban-subtask-item:hover {
            background-color: var(--bg-primary);
        }

        /* 6. Styl checkboxa */
        .kanban-subtask-checkbox {
            width: 16px;
            height: 16px;
            flex-shrink: 0;
            cursor: pointer;
        }
        .kanban-subtask-checkbox:disabled {
            cursor: not-allowed;
            opacity: 0.6;
        }
        
        /* 7. Styl dla ukoczonego podzadania (przekrelenie) */
        .kanban-subtask-item.completed span {
            text-decoration: line-through;
            color: var(--text-secondary);
        }
    
       
        /* === KONIEC: NOWE STYLE DLA PODZADA NA KANBANIE === */
        /* === POCZTEK: NOWE STYLE DLA DZWONKA POWIADOMIE O ZADANIU === */
        
        /* 1. Styl przycisku (wrapperka) dla dzwonka */
        .task-subscription-bell {
            background: none;
            border: none;
            cursor: pointer;
            padding: 2px 4px 0px 4px; /* Dopasowanie pionowe obok daty */
            border-radius: 4px;
            display: inline-flex; /* Aby wyrodkowa SVG wewntrz */
            align-items: center;
            justify-content: center;
            margin-left: 4px; /* Odstp od daty */
            opacity: 0.6; /* Domylnie lekko wygaszony */
            transition: opacity 0.2s, transform 0.2s;
        }

        /* 2. Styl samego SVG (domylnie szary) */
        .task-subscription-bell svg {
            width: 16px;
            height: 16px;
            color: var(--text-secondary); /* Domylny kolor (szary) */
            fill: none;
            stroke-width: 2px;
            transition: all 0.2s ease-out;
        }
        
        /* 3. Efekt hover na dzwonku (zwikszamy widoczno) */
        .task-card:hover .task-subscription-bell {
             opacity: 1;
        }
        .task-subscription-bell:hover svg {
            transform: scale(1.1);
        }

        /* 4. Styl dla AKTYWNEGO dzwonka (niebieski) */
        .task-subscription-bell.subscribed {
            opacity: 1; /* Zawsze w peni widoczny, jeli aktywny */
        }
        
        .task-subscription-bell.subscribed svg {
            color: var(--accent-primary); /* Niebieska ramka */
            fill: var(--accent-primary);   /* Niebieskie wypenienie */
            /* USUNITO: animation: bell-ring-wow 0.6s ease-in-out; */
        }

        /* === NOWA REGUA DLA SAMEJ ANIMACJI === */
        .task-subscription-bell.animate-ring svg {
            /* Uruchom animacj "dzwonienia" tylko po dodaniu tej klasy */
            animation: bell-ring-wow 0.6s ease-in-out;
        }
        /* 5. Animacja "dzwonienia" (Keyframes) */
        @keyframes bell-ring-wow {
            0% {
                transform: scale(1) rotate(0deg);
                color: var(--accent-primary);
            }
            20% {
                transform: scale(1.4) rotate(-20deg);
                color: #f59e0b; /* Bursztynowy rozbysk */
            }
            40% {
                transform: scale(1.4) rotate(20deg);
                color: var(--accent-primary);
            }
            60% {
                transform: scale(1.4) rotate(-15deg);
                color: #f59e0b;
            }
            80% {
                transform: scale(1.4) rotate(15deg);
                color: var(--accent-primary);
            }
            100% {
                transform: scale(1) rotate(0deg);
                color: var(--accent-primary);
            }
        }
        /* === NOWE STYLE DLA DZWONKA PODZADANIA === */
        .subtask-subscription-bell {
            background: none;
            border: none;
            cursor: pointer;
            padding: 2px 4px 0px 4px; /* Dopasowanie pionowe obok daty */
            border-radius: 4px;
            display: inline-flex; /* Aby wyrodkowa SVG wewntrz */
            align-items: center;
            justify-content: center;
            margin-left: 4px; /* Odstp od daty */
            opacity: 0.6; /* Domylnie lekko wygaszony */
            transition: opacity 0.2s, transform 0.2s;
        }
        
        .subtask-subscription-bell:hover {
            opacity: 1;
            transform: scale(1.1);
        }
        
        .subtask-subscription-bell.subscribed {
             opacity: 1; /* Zawsze w peni widoczny, jeli aktywny */
        }

        .subtask-subscription-bell svg {
            width: 16px;
            height: 16px;
            color: var(--text-secondary); /* Domylnie szary obrys */
            fill: none;   /* Domylnie brak wypenienia */
            stroke-width: 2px;
            transition: all 0.2s ease-out;
        }

        .subtask-subscription-bell:hover svg {
            color: var(--accent-primary); /* Niebieski obrys po najechaniu */
            transform: scale(1.1);
        }

        /* Styl dla AKTYWNEGO dzwonka (niebieski i wypeniony) */
        .subtask-subscription-bell.subscribed svg {
            color: var(--accent-primary); 
            fill: var(--accent-primary);
        }
        
        /* Animacja dzwonienia (taka sama jak w g贸wnym) */
        .subtask-subscription-bell.animate-ring svg {
            /* Uruchom animacj "dzwonienia" tylko po dodaniu tej klasy */
            animation: bell-ring-wow 0.6s ease-in-out;
        }
        /* 5. Animacja "dzwonienia" (Keyframes) */
        @keyframes bell-ring-wow {
            0% {
                transform: scale(1) rotate(0deg);
                color: var(--accent-primary);
            }
            20% {
                transform: scale(1.4) rotate(-20deg);
                color: #f59e0b; /* Bursztynowy rozbysk */
            }
            40% {
                transform: scale(1.4) rotate(20deg);
                color: var(--accent-primary);
            }
            60% {
                transform: scale(1.4) rotate(-15deg);
                color: #f59e0b;
            }
            80% {
                transform: scale(1.4) rotate(15deg);
                color: var(--accent-primary);
            }
            100% {
                transform: scale(1) rotate(0deg);
                color: var(--accent-primary);
            }
        }
        /* === KONIEC NOWYCH STYLI === */
        /* === POCZTEK: NOWE STYLE DLA IKONY POWIZANIA (ACUCH) === */
        
       /* 1. Styl przycisku (wrapperka) dla acucha */
        .task-link-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 2px 4px 0px 4px;
            border-radius: 4px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-left: 4px;
            /* USUNITO: opacity: 0.6; */
            transition: opacity 0.2s, transform 0.2s, color 0.2s;
        }

        /* 2. Styl samego SVG (domylnie szary) */
        .task-link-btn svg {
            width: 16px;
            height: 16px;
            color: var(--text-secondary); /* Domylny kolor (szary) */
            transition: all 0.2s ease-out;
        }
        
        /* 3. Efekt hover na przycisku (zwikszamy widoczno) */
        .task-card:hover .task-link-btn {
             opacity: 1;
        }
        .task-link-btn:hover svg {
            transform: scale(1.1);
        }

        /* 4. Styl dla AKTYWNEGO powizania (niebieski) */
        .task-link-btn.linked {
            opacity: 1; /* Zawsze w peni widoczny, jeli aktywny */
        }
        
        .task-link-btn.linked svg {
            color: var(--accent-primary); /* Niebieska ramka */
        }
        
        /* 5. Styl dla zepsutego powizania (jeli zadanie blokujce nie istnieje) */
        .task-link-btn.broken svg {
            color: var(--danger-primary); /* Czerwony */
            opacity: 0.8;
        }
        
        /* === KONIEC NOWYCH STYLI === */
        /* === NOWE STYLE: TRYB ZAZNACZANIA WIELOKROTNEGO === */

        /* 1. Przycisk "Zaznacz" (u偶ywa styl贸w .sort-btn) */
        #select-mode-toggle-btn {
            /* Domylnie u偶ywa styl贸w .sort-btn (szara ramka) */
        }

        /* 2. Przycisk w stanie aktywnym ("Anuluj") */
        #select-mode-toggle-btn.active {
            border-color: var(--accent-primary);
            background-color: var(--accent-primary);
            color: var(--text-on-accent);
        }

        /* 3. Pasek akcji masowych */
        #bulk-action-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 24px;
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-md);
            margin-bottom: 16px; /* Odstp od tablicy kanban */
            z-index: 10; /* Na wierzchu */

            /* Animacja pojawiania si */
            opacity: 0;
            transform: translateY(-20px);
            transition: opacity 0.2s ease-out, transform 0.2s ease-out;
        }
        #bulk-action-bar.visible {
            opacity: 1;
            transform: translateY(0);
        }
        #bulk-action-count {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }
        .bulk-action-buttons {
            display: flex;
            gap: 8px;
        }

       /* === FINALNE STYLE: TRYB ZAZNACZANIA (ROZDZIELONE) === */

        /* --- 1. STAN NIEAKTYWNY (Wyszarzenie) --- */
        .main-content.select-mode-active .task-card.non-selectable > .task-card-main-content,
        .main-content.select-mode-active .subtask-visual-card.non-selectable {
            opacity: 0.5;
            pointer-events: none;
        }

        /* --- 2. PODSTAWOWE ZACHOWANIE --- */
        .main-content.select-mode-active .task-card.selectable,
        .main-content.select-mode-active .subtask-visual-card.selectable {
            cursor: pointer; 
        }

        /* ================================================== */
        /* A. ZADANIA GWNE (Celujemy w .task-card-main-content) */
        /* ================================================== */
        
        /* MGA (To) */
        .main-content.select-mode-active .task-card.selectable > .task-card-main-content::before {
            content: '';
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            border-radius: var(--border-radius);
            z-index: 20;
            opacity: 0;
            transition: opacity 0.15s, background-color 0.15s;
            pointer-events: none;
        }

        /* NAPIS */
        .main-content.select-mode-active .task-card.selectable > .task-card-main-content::after {
            content: 'Zaznacz';
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-weight: 600;
            font-size: 16px;
            z-index: 21;
            pointer-events: none;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
            opacity: 0;
            transition: opacity 0.15s;
        }

        /* HOVER: Poka偶 ciemn mg i napis */
        .main-content.select-mode-active .task-card.selectable > .task-card-main-content:hover::before {
            background-color: rgba(0, 0, 0, 0.4);
            opacity: 1;
        }
        .main-content.select-mode-active .task-card.selectable > .task-card-main-content:hover::after {
            opacity: 1;
        }

        /* SELECTED: Niebieska ramka + Niebieska mga */
        .main-content.select-mode-active .task-card.selected > .task-card-main-content {
            box-shadow: 0 0 0 3px var(--accent-primary), var(--shadow-md);
            transform: scale(1.02);
            border-color: transparent;
            z-index: 15;
        }
        .main-content.select-mode-active .task-card.selected > .task-card-main-content::before {
            background-color: rgba(79, 70, 229, 0.15); /* Niebieska mga */
            opacity: 1;
        }
        /* SELECTED + HOVER: Ciemniejszy niebieski + Zmiana napisu */
        .main-content.select-mode-active .task-card.selected > .task-card-main-content:hover::before {
            background-color: rgba(79, 70, 229, 0.35);
        }
        .main-content.select-mode-active .task-card.selected > .task-card-main-content:hover::after {
            content: 'Odznacz';
        }


        /* ================================================== */
        /* B. PODZADANIA (Celujemy bezporednio w .subtask-visual-card) */
        /* ================================================== */

        .main-content.select-mode-active .subtask-visual-card.selectable {
            position: relative !important; /* KLUCZOWE: Wymusza baz dla ::before/::after */
            overflow: visible !important;  /* KLUCZOWE: Pozwala wywietli elementy wychodzce */
        }

        /* MGA (To) */
        .main-content.select-mode-active .subtask-visual-card.selectable::before {
            /* ZMIANA: Wymuszamy content i display, aby nadpisa ukrywanie linii (reguy z linii ~2415) */
            content: '' !important;
            display: block !important;
            
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            border-radius: var(--border-radius);
            z-index: 50; /* Bardzo wysoki index, by przykry tre podzadania */
            opacity: 0;
            transition: opacity 0.15s, background-color 0.15s;
            pointer-events: none;
            
            /* Reset styl贸w linii (na wypadek gdyby co jeszcze przebijao) */
            border: none !important;
            background: transparent; /* Domylnie przezroczysty, zmienia si na hover/selected */
        }

        /* NAPIS */
        .main-content.select-mode-active .subtask-visual-card.selectable::after {
            /* ZMIANA: Wymuszamy content i display */
            content: 'Zaznacz' !important;
            display: block !important;
            
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-weight: 600;
            font-size: 14px; /* Nieco mniejszy ni偶 w g贸wnym zadaniu */
            z-index: 51; /* Nad mg */
            pointer-events: none;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
            opacity: 0;
            transition: opacity 0.15s;
            
            /* Reset styl贸w */
            border: none !important;
        }

        /* HOVER: Poka偶 ciemn mg i napis */
        .main-content.select-mode-active .subtask-visual-card.selectable:hover::before {
            background-color: rgba(0, 0, 0, 0.4);
            opacity: 1;
        }
        .main-content.select-mode-active .subtask-visual-card.selectable:hover::after {
            opacity: 1;
        }

        /* SELECTED: Niebieska ramka + Niebieska mga */
        .main-content.select-mode-active .subtask-visual-card.selected {
            box-shadow: 0 0 0 3px var(--accent-primary), var(--shadow-md);
            transform: scale(1.02);
            border-color: transparent;
            z-index: 15;
        }
        .main-content.select-mode-active .subtask-visual-card.selected::before {
            background-color: rgba(79, 70, 229, 0.15); /* Niebieska mga */
            opacity: 1;
        }

        /* SELECTED + HOVER */
        .main-content.select-mode-active .subtask-visual-card.selected:hover::before {
            background-color: rgba(79, 70, 229, 0.35);
        }
        .main-content.select-mode-active .subtask-visual-card.selected:hover::after {
            /* ZMIANA: Wymuszamy zmian tekstu */
            content: 'Odznacz' !important;
        }
        /* 7. Styl dla przycisk贸w na pasku akcji masowych */
        #bulk-action-bar .btn-primary:hover {
            background-color: var(--accent-hover);
        }
        #bulk-action-bar .btn-danger:hover {
            background-color: var(--danger-hover);
        }

        /* === KONIEC NOWYCH STYLI === */
        /* === NOWE STYLE DLA PANELU CZATU PROJEKTU === */
        .chat-panel {
            position: fixed;
            top: 0;
            right: 0;
            width: 380px;
            height: 100%;
            background-color: var(--bg-secondary);
            border-left: 1px solid var(--border-color);
            box-shadow: var(--shadow-lg);
            z-index: 1020; /* Wy偶ej ni偶 modale (1000) i overlay paska (1001) */
            display: flex;
            flex-direction: column;
            transform: translateX(100%);
            transition: transform 0.3s ease-in-out;
            visibility: hidden;
        }
        .chat-panel.open {
            transform: translateX(0);
            visibility: visible;
        }
        
        /* Nag贸wek panelu czatu (wsp贸dzielony z modal-header) */
        .chat-panel-header {
            padding: 16px 24px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }
        .chat-panel-header h3 {
            font-size: 18px;
            margin: 0;
        }
        
        /* Kontener na wiadomoci */
        .chat-panel-content {
            flex-grow: 1;
            overflow-y: auto;
            padding: 16px 24px;
            display: flex;
            flex-direction: column-reverse; /* Nowe wiadomoci na dole */
            background-color: var(--bg-primary);
        }
        .chat-messages {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        /* Pojedyncza wiadomo (style dla .chat-message-item, .is-me, .is-other dodam p贸藕niej z logik JS) */
        
        /* Stopka z inputem */
        .chat-panel-footer {
            display: flex;
            gap: 8px;
            padding: 16px 24px;
            border-top: 1px solid var(--border-color);
            background-color: var(--bg-secondary);
            flex-shrink: 0;
        }
        .chat-panel-footer textarea {
            flex-grow: 1;
            padding: 10px;
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
            background-color: var(--bg-primary);
            font-family: var(--font-family);
            font-size: 14px;
            color: var(--text-primary);
            resize: none;
            max-height: 80px;
        }
        .chat-panel-footer .btn {
            flex-shrink: 0;
            padding: 10px; /* Kwadratowy przycisk */
        }

        /* Dostosowanie na mobilnych */
        @media (max-width: 768px) {
            .chat-panel {
                width: 100%; /* Pena szeroko na mobilnych */
                z-index: 2001; /* Wy偶ej ni偶 sidebar (2000) */
            }

            /* === POCZTEK ZMIANY: Pene nadpisanie styl贸w AI dla mobile (overlay) === */
            .ai-chat-sidebar {
                position: fixed; /* Nakadka na ca tre */
                top: 0;
                right: 0;
                width: 100%; /* Pena szeroko */
                height: 100%;
                z-index: 2001; /* Wy偶ej ni偶 sidebar */
                border-left: none; /* Usu ramk z desktopa */
                
                /* Ukrywanie przez transform (jak w chat-panel) */
                transform: translateX(100%);
                visibility: hidden;
                /* Animacja transform, a NIE width */
                transition: transform 0.3s ease-in-out, visibility 0.3s;
            }
            
            .ai-chat-sidebar.open {
                transform: translateX(0); /* Wsu na ekran */
                visibility: visible;
                width: 100% !important;
            }
            
            /* === KLUCZOWA POPRAWKA: Zwikszenie specyficznoci selektora === */
            /* U偶ywamy dw贸ch klas, aby ta regua bya "silniejsza" ni偶 regua desktopowa */
            .ai-chat-sidebar .ai-chat-sidebar-content {
                width: 100%;
            }
            /* === KONIEC ZMIANY === */
        }
        
        /* Style dla pojedynczego bloku wiadomoci */
        .chat-message-item {
            display: flex;
            flex-direction: column;
            max-width: 85%; /* Wiadomoci nie zajmuj 100% szerokoci */
        }
        .message-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
            padding: 0 2px;
        }
        .message-sender {
            font-weight: 600;
            font-size: 13px;
        }
        .message-time {
            font-size: 11px;
            color: var(--text-secondary);
        }
        .message-content-wrapper {
            display: flex;
            gap: 8px;
            align-items: flex-end; /* Awatar na dole dymka */
        }
        .message-bubble {
            padding: 10px 14px;
            border-radius: var(--border-radius);
            font-size: 14px;
            line-height: 1.4;
            word-wrap: break-word; /* Zamanie dugich s贸w */
        }
        .message-bubble p {
            margin: 0;
        }

        /* Wiadomoci innych (po lewej) */
        .chat-message-item.is-other {
            align-self: flex-start;
        }
        .chat-message-item.is-other .message-bubble {
            background-color: var(--bg-tertiary);
            border-bottom-left-radius: 2px; /* Efekt "ogonka" dymka */
        }
        /* U偶ywamy klasy .avatar-comment (24x24) zdefiniowanej wczeniej */
        .chat-message-item.is-other .avatar-comment {
             flex-shrink: 0;
             margin: 0; /* Resetowanie domylnych margines贸w .avatar */
        }

        /* Moje wiadomoci (po prawej) */
        .chat-message-item.is-me {
            align-self: flex-end;
        }
        .chat-message-item.is-me .message-sender {
            display: none; /* Nie pokazuj mojej nazwy nad moj wiadomoci */
        }
        .chat-message-item.is-me .message-header {
            justify-content: flex-end; /* Czas po prawej */
        }
        .chat-message-item.is-me .message-bubble {
            background-color: var(--accent-primary);
            color: var(--text-on-accent);
            border-bottom-right-radius: 2px; /* Efekt "ogonka" dymka */
        }
        /* === KONIEC STYLI CZATU === */
        /* === POCZTEK: NOWE STYLE DLA PRZYCISKU ADMINISTRATORA PROJEKTU === */

        /* Styl dla przycisku korony w piguce czonka */
        .admin-toggle-btn {
            background: none;
            border: none;
            padding: 0 4px;
            margin-left: auto; /* <-- KLUCZOWE: Przesuwa koron na praw stron piguki */
            cursor: pointer;
            display: flex;
            align-items: center;
            border-radius: 4px;
            opacity: 0.7; /* Zwikszona domylna widoczno */
        }
        
        .admin-toggle-btn svg {
            width: 20px;
            height: 20px;
            /* KROK 1.1: Zmiana domylnego koloru na czarny (obrys) */
            color: var(--text-primary); 
            stroke: currentColor; /* <<< DODANO: Kluczowe, aby obrys przej kolor */
            stroke-width: 2px;
            fill: none;
            transition: all 0.2s ease-out;
        }
        
        /* KROK 1.2: NOWA REGUA - Lepszy kontrast na zaznaczonych (niebieskich) pigukach */
        .member-pill.selected .admin-toggle-btn:not(.is-admin) svg {
            color: var(--text-on-accent); /* Biay obrys na niebieskim tle */
            opacity: 1; /* <<< ZMIANA: Zwikszono widoczno do 100% dla lepszego kontrastu */
        }
        .member-pill.selected .admin-toggle-btn:not(.is-admin):hover svg {
            opacity: 1;
        }


        /* Styl "hover" dla nieaktywnej korony */
        .admin-toggle-btn:not(.is-admin):hover svg {
            opacity: 1;
            transform: scale(1.1);
            /* Kolor hover dziedziczony (czarny lub biay) */
        }

        /* Styl dla aktywnej korony (偶贸ty) */
        .admin-toggle-btn.is-admin {
            opacity: 1;
        }
        .admin-toggle-btn.is-admin svg {
            color: #f59e0b; /* Bursztynowy/Zoty */
            fill: #f59e0b; /* Wypenienie */
        }
        
        /* Styl "hover" dla aktywnej korony (lekkie powikszenie) */
        .admin-toggle-btn.is-admin:hover svg {
            transform: scale(1.1);
        }

        /* === POPRAWIONE STYLE DLA SUPER USERA (ZTY) === */
        .superuser-toggle-btn {
            background: none;
            border: none;
            padding: 0 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            border-radius: 4px;
            opacity: 0.7;
            margin-right: 4px;
            transition: opacity 0.2s;
        }
        
        .superuser-toggle-btn svg {
            width: 20px;
            height: 20px;
            color: var(--text-primary); 
            stroke: currentColor; /* Kluczowe: dziedziczy kolor z rodzica */
            stroke-width: 2px;
            fill: none; /* Domylnie bez wypenienia */
            transition: all 0.2s ease-out;
        }

        /* Hover na nieaktywnym */
        .superuser-toggle-btn:not(.is-superuser):hover svg {
            opacity: 1;
            transform: scale(1.1);
            color: #f59e0b; /* Podwietlenie na 偶贸to przy najechaniu */
        }

        /* Stan AKTYWNY (SuperUser jest wczony) */
        .superuser-toggle-btn.is-superuser {
            opacity: 1;
        }
        
        .superuser-toggle-btn.is-superuser svg {
            /* Wymuszamy kolor 偶贸ty (bursztynowy) - taki sam jak korona admina */
            color: #f59e0b !important; 
            stroke: #f59e0b !important;
            
            /* Delikatne 偶贸te to w rodku ikony, aby bya wyra藕na */
            fill: rgba(245, 158, 11, 0.2) !important; 
        }
        /* === KONIEC POPRAWIONYCH STYLI === */

        /* === KONIEC: NOWE STYLE DLA PRZYCISKU ADMINISTRATORA PROJEKTU === */
        /* === POCZTEK: NOWE STYLE DLA PANELU BOCZNEGO AI (WERSJA HYBRYDOWA) === */
        
        .ai-chat-sidebar {
            /* === ZMIANA: Przywr贸cenie logiki "spychania" (width) dla desktopa === */
            width: 0; /* Domylnie ukryty */
            height: 100%;
            flex-shrink: 0; /* Kluczowe: panel nie bdzie si kurczy */
            background-color: var(--bg-secondary);
            border-left: 1px solid transparent;
            transition: width 0.3s ease-in-out, border-color 0.3s ease-in-out;
            overflow: hidden; /* Ukryj tre podczas zamykania */
            display: flex;
            flex-direction: column;
            /* Usunito position: fixed, transform, z-index itp. z domylnego stylu */
        }

        .ai-chat-sidebar.open {
            /* Stan otwarty: U偶ywam 380px dla sp贸jnoci z drugim panelem czatu */
            width: 380px;
            border-left-color: var(--border-color); /* Poka偶 ramk */
        }
        
        /* Wewntrzny kontener, kt贸ry zapewnia layout flex */
        .ai-chat-sidebar-content {
            display: flex;
            flex-direction: column;
            height: 100%;
            width: 380px; /* Staa szeroko, aby tre nie "skakaa" */
            overflow: hidden;
        }

        /* Upewnij si, 偶e nag贸wek i stopka si nie rozcigaj */
        .ai-chat-sidebar .modal-header,
        .ai-chat-sidebar .modal-footer {
            flex-shrink: 0;
        }
        
        /* Upewnij si, 偶e kontener czatu ronie i si przewija */
        .ai-chat-sidebar .form-modal-content {
            flex-grow: 1;
            overflow-y: auto;
            background-color: var(--bg-primary);
        }
        
        /* Poprawka dla formularza (stopki) */
        .ai-chat-sidebar #ai-help-form {
            display: flex;
            gap: 8px;
            padding: 12px 24px;
            border-top: 1px solid var(--border-color);
            background-color: var(--bg-secondary);
        }
        
        /* === KONIEC: NOWE STYLE DLA PANELU BOCZNEGO AI === */
        /* === POCZTEK ZMIANY: STYL DLA STOPKI MODALA POWITALNEGO === */
       .welcome-modal-footer-prefs label {
            /* Nadpisujemy domylny font-weight: normal */
            font-weight: 500 !important;
            font-size: 13px !important;
            color: var(--text-secondary);
        }
        /* === KONIEC ZMIANY === */

        /* === POCZTEK ZMIANY: Layout powitalnego modala === */
        .welcome-intro-flex {
            display: flex;
            align-items: center; /* Wyr贸wnuje ikon i tekst w pionie */
            gap: 20px; /* Odstp midzy ikon a tekstem */
            margin-bottom: 16px; /* Zachowuje odstp do nastpnego akapitu */
        }
        /* === KONIEC ZMIANY === */
        /* === NOWE STYLE: ROZMOWA GOSOWA AI === */
        #ai-chat-status-bar {
            border-top: 1px solid var(--border-color);
            background-color: var(--bg-primary);
            transition: color 0.3s, background-color 0.3s;
        }
        /* Status: Suchanie */
        #ai-chat-status-bar.listening {
            color: var(--success-primary);
            font-weight: 600;
            background-color: color-mix(in srgb, var(--success-primary) 10%, var(--bg-primary));
        }
        /* Status: Przetwarzanie (po wykryciu mowy) */
        #ai-chat-status-bar.processing {
            color: var(--accent-primary);
            font-weight: 600;
            background-color: color-mix(in srgb, var(--accent-primary) 10%, var(--bg-primary));
        }
        /* Status: M贸wienie (synteza mowy) */
        #ai-chat-status-bar.speaking {
            color: var(--text-primary);
        }

        /* Przycisk mikrofonu */
        #ai-chat-mic-btn {
            /* Domylny styl przycisku btn-secondary */
        }
        /* Przycisk mikrofonu w trybie aktywnym (nasuch) */
        #ai-chat-mic-btn.active {
            background-color: var(--danger-primary);
            color: var(--text-on-accent);
            border-color: var(--danger-primary);
            animation: pulse-mic 1.5s infinite;
        }
        #ai-chat-mic-btn.active:hover {
            background-color: var(--danger-hover);
        }
        
        @keyframes pulse-mic {
            0% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.7); }
            70% { box-shadow: 0 0 0 8px rgba(220, 38, 38, 0); }
            100% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0); }
        }
        /* === KONIEC NOWYCH STYLI === */
       /* === NOWE STYLE: Ustawienia AI (Modal) === */
        /* Ten styl ju偶 istnieje w klasie .header-btn, ale dodajemy go dla pewnoci */
        #ai-settings-btn {
            color: var(--text-secondary);
        }
        #ai-settings-btn:hover {
            background-color: var(--bg-tertiary);
            color: var(--text-primary);
        }
        
        /* Ukad wiersza w modalu ustawie AI */
        .ai-voice-setting-row {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .ai-voice-setting-row label {
            /* Etykieta jest teraz nad list, wic nie jest ju偶 potrzebna */
            /* Zamiast tego stylujemy select, aby zaj ca przestrze */
        }
        .ai-voice-setting-row #ai-voice-select {
            flex-grow: 1; /* Lista zajmuje ca dostpn przestrze */
            /* Zachowujemy style z .form-group input */
            width: 100%;
            padding: 10px;
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
            background-color: var(--bg-primary);
            font-family: var(--font-family);
            font-size: 14px;
            color: var(--text-primary);
        }
        .ai-voice-setting-row #ai-voice-test-btn {
            flex-shrink: 0; /* Przycisk si nie kurczy */
        }
        /* === KONIEC NOWYCH STYLI === */
        /* === NOWE STYLE DLA FLYOUT ULUBIONYCH (POCZTEK) === */
        
        /* 1. Ukryj list ikon ulubionych, gdy sidebar jest zwinity */
        .app-container.sidebar-collapsed #projects-list {
            display: none;
        }

        
        
        /* 3. Spraw, by ten H2 by klikalny (tylko w trybie zwinitym) */
        .app-container.sidebar-collapsed .sidebar-scrollable-area > .nav-section:first-child h2 {
            cursor: pointer;
        }

        /* 4. Style dla nowego menu flyout (wsp贸dzielone z #group-switcher-menu) */
        .flyout-menu {
            position: absolute;
            top: 0; /* JS ustawi to dynamicznie */
            left: 72px; /* Szeroko zwinitego sidebara */
            width: 220px;
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-lg);
            z-index: 3000; /* Nad wszystkim */
            padding: 4px;
            max-height: 250px;
            overflow-y: auto;
            
            /* Domylnie ukryte */
            visibility: hidden;
            opacity: 0;
            transform: translateX(-10px);
            transition: opacity 0.2s, transform 0.2s, visibility 0.2s;
        }
        
        .flyout-menu.open {
            visibility: visible;
            opacity: 1;
            transform: translateX(0);
        }
        
        /* 5. Style dla link贸w <a> wewntrz menu */
        .flyout-menu .flyout-menu-item {
            display: block;
            width: 100%;
            text-align: left;
            padding: 8px 10px;
            font-size: 14px;
            font-weight: 500;
            background: none;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            text-decoration: none;
        }
        .flyout-menu .flyout-menu-item:hover {
            background-color: var(--bg-tertiary);
        }
        .flyout-menu .flyout-menu-item.active {
            background-color: var(--accent-primary);
            color: var(--text-on-accent);
        }
        /* === NOWE STYLE DLA FLYOUT ULUBIONYCH (KONIEC) === */
        /* Dodaj to do sekcji CSS */
#modal-task-edit-indicator {
    color: var(--text-secondary);
    opacity: 0.7;
}
/* Ukrywamy stary przycisk edycji permanentnie przez CSS, 
   cho usuniemy logiczn obsug w JS r贸wnie偶 */
#edit-task-btn {
    display: none !important; 
}
        /* === NOWE STYLE DLA WYSZUKIWARKI U呕YTKOWNIKW === */
.member-search-container {
    position: relative;
    margin-bottom: 12px;
}
.member-search-input {
    width: 100%;
    /* ZMIANA: Usunito lup i przywr贸cono standardowy padding */
    padding: 10px 12px; 
    border-radius: var(--border-radius);
    border: 1px solid var(--border-color);
    background-color: var(--bg-secondary);
    font-size: 14px;
    color: var(--text-primary);
    background-image: none; /* Usunicie ikony lupy */
}
.member-search-results {
    list-style: none;
    margin-top: 4px;
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius);
    background-color: var(--bg-secondary);
    max-height: 200px;
    overflow-y: auto;
    display: none; /* Domylnie ukryte */
    position: absolute;
    width: 100%;
    z-index: 10;
    box-shadow: var(--shadow-md);
}
.member-search-results.visible {
    display: block;
}
.member-search-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 8px 12px;
    border-bottom: 1px solid var(--bg-primary);
    transition: background-color 0.2s;
}
.member-search-item:last-child {
    border-bottom: none;
}
.member-search-item:hover {
    background-color: var(--bg-tertiary);
}
.member-search-info {
    display: flex;
    align-items: center;
    gap: 8px;
}
.member-search-info span {
    font-size: 14px;
    font-weight: 500;
}
.member-search-add-btn {
    background-color: var(--accent-primary);
    color: white;
    border: none;
    padding: 4px 10px;
    border-radius: 4px;
    font-size: 12px;
    cursor: pointer;
    font-weight: 600;
}
.member-search-add-btn:hover {
    background-color: var(--accent-hover);
}
.member-search-add-btn.added {
    background-color: var(--success-primary);
    cursor: default;
}
        /* === STYLE DLA NOWEGO MODALA USTAWIE === */
.settings-container {
    display: flex;
    height: 100%;
    overflow: hidden;
}

/* Sidebar */
.settings-sidebar {
    width: 220px;
    background-color: var(--bg-primary);
    border-right: 1px solid var(--border-color);
    padding: 16px;
    flex-shrink: 0;
}
.settings-nav {
    display: flex;
    flex-direction: column;
    gap: 4px;
}
.settings-nav-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 10px 12px;
    border: none;
    background: none;
    color: var(--text-secondary);
    font-weight: 500;
    font-size: 14px;
    border-radius: var(--border-radius);
    cursor: pointer;
    text-align: left;
    transition: all 0.2s;
}
.settings-nav-item:hover, .settings-nav-item.active {
    background-color: var(--bg-tertiary);
    color: var(--text-primary);
}
.settings-nav-item.active {
    color: var(--accent-primary);
    font-weight: 600;
}
.settings-nav-item svg {
    width: 20px; height: 20px;
}

/* Content */
.settings-content {
    flex-grow: 1;
    padding: 32px;
    overflow-y: auto;
    background-color: var(--bg-secondary);
}
        /* === NOWA REGUA: Obsuga zakadek w ustawieniach === */
.settings-tab-content {
    display: none;
    animation: fadeIn 0.2s ease-out;
}
.settings-tab-content.active {
    display: block;
}
/* === KONIEC NOWEJ REGUY === */
.settings-section.centered {
    display: flex;
    flex-direction: column;
    align-items: center;
    margin-bottom: 32px;
}

/* Avatar */
.settings-avatar-wrapper {
    position: relative;
    width: 100px; height: 100px;
    border-radius: 50%;
    cursor: pointer;
    overflow: hidden;
    border: 2px solid var(--border-color);
    transition: border-color 0.2s;
}
.settings-avatar-wrapper:hover {
    border-color: var(--accent-primary);
}
.settings-avatar-wrapper:hover .avatar-overlay {
    opacity: 1;
}
.avatar-xl {
    width: 100%; height: 100%;
    display: flex; align-items: center; justify-content: center;
    font-size: 36px; font-weight: 600;
    background-color: var(--bg-tertiary); color: var(--text-secondary);
}
.avatar-xl img {
    width: 100%; height: 100%; object-fit: cover;
}
.avatar-overlay {
    position: absolute; top: 0; left: 0;
    width: 100%; height: 100%;
    background-color: rgba(0, 0, 0, 0.4);
    display: flex; align-items: center; justify-content: center;
    opacity: 0; transition: opacity 0.2s;
}
.avatar-overlay svg {
    width: 32px; height: 32px; color: white;
}
.settings-hint {
    font-size: 12px; color: var(--text-secondary); margin-top: 8px;
}

@media (max-width: 768px) {
    .settings-container { flex-direction: column; }
    .settings-sidebar { width: 100%; border-right: none; border-bottom: 1px solid var(--border-color); padding: 8px; }
}
        /* Style specyficzne dla modala zarzdzania grup (bazuj na settings) */
.manage-tab-content {
    display: none;
    animation: fadeIn 0.2s ease-out;
}
.manage-tab-content.active {
    display: block;
}

/* Drobna poprawka dla listy w tym modalu, aby wygldaa profesjonalniej */
#manage-group-modal .attachment-item {
    padding: 12px;
    border: 1px solid var(--border-color);
    background-color: var(--bg-secondary); /* Biae to na licie */
    margin-bottom: 8px;
    border-radius: var(--border-radius);
    transition: transform 0.1s, box-shadow 0.1s;
}
#manage-group-modal .attachment-item:hover {
    transform: translateY(-1px);
    box-shadow: var(--shadow-sm);
}
        /* === STYLE DLA AKADEMII (TUTORIAL) === */

/* Elementy drzewa nawigacji */
.tutorial-tree-item {
    margin-bottom: 2px;
}

.tutorial-tree-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 12px;
    cursor: pointer;
    border-radius: var(--border-radius);
    font-weight: 600;
    color: var(--text-primary);
    transition: background-color 0.2s;
    user-select: none;
}
.tutorial-tree-header:hover {
    background-color: var(--bg-tertiary);
}
.tutorial-tree-header .chevron {
    width: 16px; height: 16px;
    transition: transform 0.3s;
    color: var(--text-secondary);
}
.tutorial-tree-header.expanded .chevron {
    transform: rotate(180deg);
}

/* Kontener podkategorii (ukryty domylnie) */
.tutorial-tree-children {
    display: none;
    flex-direction: column;
    margin-top: 2px;
}
.tutorial-tree-children.visible {
    display: flex;
}

/* Link do tematu (kocowy element) */
.tutorial-topic-link {
    padding: 8px 12px 8px 34px; /* Wcicie dla poziomu */
    font-size: 13px;
    color: var(--text-secondary);
    cursor: pointer;
    border-radius: var(--border-radius);
    text-decoration: none;
    display: block;
    transition: all 0.2s;
    border-left: 2px solid transparent;
    margin-bottom: 1px;
}
.tutorial-topic-link:hover {
    background-color: var(--bg-tertiary);
    color: var(--text-primary);
}
.tutorial-topic-link.active {
    background-color: rgba(79, 70, 229, 0.1);
    color: var(--accent-primary);
    border-left-color: var(--accent-primary);
    font-weight: 600;
}

/* Odtwarzacz Wideo */
.tutorial-video-wrapper {
    width: 100%;
    background-color: #000;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: var(--shadow-lg);
    margin-bottom: 24px;
    /* Format 16:9, ale elastyczny */
    aspect-ratio: 16 / 9;
    display: flex;
    align-items: center;
    justify-content: center;
}

.tutorial-video-wrapper video {
    width: 100%;
    height: 100%;
    object-fit: contain; /* Zapewnia, 偶e cay film jest widoczny */
    display: block;
}

/* Sekcja opisu pod filmem */
.tutorial-description h3 {
    font-size: 24px;
    font-family: var(--font-family-header);
    margin-bottom: 16px;
    color: var(--text-primary);
}
.tutorial-description p {
    line-height: 1.6;
    color: var(--text-secondary);
    margin-bottom: 16px;
    font-size: 15px;
}
.tutorial-description ul {
    margin-bottom: 16px;
    padding-left: 20px;
    color: var(--text-secondary);
}
.tutorial-description li {
    margin-bottom: 8px;
}
        /* Ulepszenie dla penego ekranu: Kontener treci */
.tutorial-content-wrapper {
    max-width: 1100px; /* Ogranicz szeroko treci dla czytelnoci */
    margin: 0 auto;   /* Wyrodkuj tre na du偶ym ekranie */
    width: 100%;
}

/* Powikszenie czcionek dla trybu penoekranowego */
.tutorial-description h3 {
    font-size: 28px; /* Wikszy nag贸wek */
}
.tutorial-description p, 
.tutorial-description li {
    font-size: 16px; /* Wikszy tekst czytany */
}
        /* Styl dla GWNYCH KATEGORII (Poziom 0) */
.tutorial-tree-header.level-0 {
    font-size: 15px;
    font-weight: 700;
    color: var(--text-primary);
    background-color: transparent;
    border-bottom: 1px solid transparent;
    margin-top: 8px;
}
.tutorial-tree-header.level-0:hover {
    background-color: var(--bg-tertiary);
}

/* Styl dla PODKATEGORII ("Midzystyl" - Poziom 1) np. Tablica Kanban */
.tutorial-tree-header.level-1 {
    font-size: 13px;
    font-weight: 600;
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    padding: 8px 12px 8px 24px; /* Wiksze wcicie */
    background-color: transparent;
}
.tutorial-tree-header.level-1:hover {
    color: var(--accent-primary);
    background-color: rgba(79, 70, 229, 0.05);
}
.tutorial-tree-header.level-1 .chevron {
    width: 14px; 
    height: 14px;
}
        /* === NOWE STYLE: TRYB KOMPAKTOWY === */
body.compact-mode {
    font-size: 13px; /* Lekkie zmniejszenie bazowej czcionki */
}

/* Mniejsze karty zada */
body.compact-mode .task-card,
body.compact-mode .poll-card {
    padding: 6px 8px;
    margin-bottom: 6px;
    min-height: 0;
}

/* Mniejszy nag贸wek zadania */
body.compact-mode .task-card h4,
body.compact-mode .poll-card h4 {
    font-size: 13px;
    margin-bottom: 2px;
    padding-left: 20px; /* Dostosowanie do mniejszego checkboxa */
}

/* Mniejszy checkbox */
body.compact-mode .task-card-checkbox {
    top: 8px;
    left: 8px;
    width: 14px;
    height: 14px;
}

/* Bardziej zwarte metadane */
body.compact-mode .task-meta,
body.compact-mode .poll-meta {
    margin-top: 2px;
}
body.compact-mode .task-detail,
body.compact-mode .poll-detail {
    font-size: 11px;
    gap: 2px;
}
body.compact-mode .task-detail svg,
body.compact-mode .poll-detail svg {
    width: 12px;
    height: 12px;
}

/* Zmniejszenie awatar贸w na kartach */
body.compact-mode .task-assignees .avatar,
body.compact-mode .poll-assignees .avatar {
    width: 20px;
    height: 20px;
    font-size: 10px;
    margin-left: -6px;
}

/* Zwarta nawigacja boczna */
body.compact-mode .nav-item a {
    padding: 2px 6px;
    font-size: 11px;
}
body.compact-mode .nav-section h2 {
    margin-bottom: 2px;
    font-size: 10px;
}

/* Zwarte tabele w modalach */
body.compact-mode #details-budget-tasks-table-container th,
body.compact-mode #details-budget-tasks-table-container td {
    padding: 4px 8px;
    font-size: 12px;
}

/* Zwarte listy w modalach (np. komentarze) */
body.compact-mode .comment-item {
    padding: 4px 8px;
    margin-bottom: 6px;
}
/* === KONIEC STYLI KOMPAKTOWYCH === */
/* Wizualny kafelek podzadania */
        .subtask-visual-card {
            /* Wcicie od lewej o ok. 2cm (50px) */
            margin-left: 50px; 
            width: calc(100% - 50px);
            
            /* Wygld bazowy */
            background-color: var(--bg-secondary);
            border-radius: var(--border-radius);
            padding: 10px 12px; /* Nieco mniejszy padding ni偶 g贸wne zadanie */
            margin-top: 4px;
            margin-bottom: 8px;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color); /* Domylna ramka */
            position: relative;
            
            /* NOWE: Przygotowanie pod pasek priorytetu */
            border-top: 4px solid transparent; 

            /* Efekt mgy (DLA RODZINY - ZAGNIE呕D呕ONE) */
            opacity: 0.6; 
            transition: all 0.2s ease-in-out;
            cursor: pointer;
        }

        /* NOWE: Style Priorytet贸w dla Podzada (analogicznie do .task-card) */
        .subtask-visual-card.priority-high {
            border-top-color: var(--priority-high-border); /* 呕贸ty */
             padding-top: 6px; /* Korekta paddingu po dodaniu ramki */
        }
        .subtask-visual-card.priority-low {
            border-top-color: var(--priority-low-border); /* Zielony */
             padding-top: 6px; /* Korekta paddingu po dodaniu ramki */
        }
        /* redni priorytet nie ma koloru (border transparent lub domylny styl) */

/* === NOWA REGUA: Wyra藕niejsze podzadanie, gdy jest ODKLEJONE (niezale偶ne) === */
.subtask-visual-card.is-standalone {
    opacity: 0.90; /* Prawie pena widoczno */
}

/* Pena widoczno po najechaniu */
.subtask-visual-card:hover {
    opacity: 1;
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
    z-index: 5;
    border-color: var(--accent-primary);
}

/* Checkbox w podzadaniu - pozycjonowanie */
.subtask-visual-card .subtask-card-checkbox {
    position: absolute;
    left: 10px;
    top: 12px;
    width: 16px;
    height: 16px;
    cursor: pointer;
}

/* Tytu podzadania */
.subtask-visual-card h5 {
    font-size: 13px;
    font-weight: 600;
    margin-bottom: 6px;
    padding-left: 24px; /* Miejsce na checkbox */
    color: var(--text-primary);
    white-space: normal;
    word-break: break-word;
}

/* Przekrelenie ukoczonego */
.subtask-visual-card.completed h5 {
    text-decoration: line-through;
    color: var(--text-secondary);
}

/* Kontener ikon (kopia logiki z task-card) */
.subtask-visual-icons {
    display: flex;
    justify-content: flex-end;
    gap: 4px;
    margin-bottom: 4px;
    padding-left: 24px;
}

/* Stopka podzadania (daty i awatary) */
.subtask-visual-meta {
    display: flex;
    justify-content: space-between;
    align-items: flex-end;
    padding-left: 24px;
}

/* Styl daty w stopce */
.subtask-visual-date {
    font-size: 11px;
    color: var(--text-secondary);
    display: flex;
    align-items: center;
    gap: 4px;
}

/* === ZMIANA: Style linii czcej dotycz teraz tylko kart zagnie偶d偶onych (.is-nested) === */
.subtask-visual-card.is-nested::before {
    content: '';
    position: absolute;
    left: -25px; /* Poowa wcicia */
    top: -14px; /* Zaczepienie o kart wy偶ej */
    height: calc(100% + 14px);
    width: 20px;
    border-left: 2px solid var(--border-color);
    border-bottom: 2px solid var(--border-color);
    border-bottom-left-radius: 8px;
    pointer-events: none;
    opacity: 0.5;
}

/* === NOWE STYLE: Podzadanie Niezale偶ne (Standalone) === */

/* 1. Reset wcicia i szerokoci dla osieroconego podzadania */
.subtask-visual-card.is-standalone {
    margin-left: 0 !important; 
    width: 100% !important;
    border-left: 1px solid var(--border-color); /* Przywracamy pen ramk */
    margin-top: 8px;
    display: flex;
    flex-direction: column;
}

/* 2. Pasek kontekstu (Niebieskie to z nazw rodzica) */
.subtask-parent-context {
    display: flex;
    align-items: center;
    gap: 6px;
    background-color: rgba(79, 70, 229, 0.08); /* Bardzo jasny niebieski */
    color: var(--accent-primary);
    padding: 4px 8px;
    /* Zaokrglenie tylko u g贸ry, bo jest na szczycie karty */
    border-radius: var(--border-radius) var(--border-radius) 0 0;
    font-size: 10px;
    font-weight: 700;
    text-transform: uppercase;
    border-bottom: 1px solid rgba(79, 70, 229, 0.15);
    /* Negatywne marginesy, aby pasek dotyka krawdzi karty */
    margin: -10px -12px 8px -12px; 
}

/* 3. Korekta nag贸wka w trybie niezale偶nym */
.subtask-visual-card.is-standalone h5 {
    padding-left: 0; /* Checkbox jest obok, nie absolutnie */
    display: flex;
    align-items: flex-start;
    gap: 8px;
}

/* 4. Checkbox w trybie niezale偶nym */
.subtask-visual-card.is-standalone .subtask-card-checkbox {
    position: static; /* Reset pozycji absolutnej */
    margin-top: 2px;
}
/* Ukrycie linii dla pierwszego elementu, jeli chcemy (opcjonalne) */
.subtask-visual-card:first-of-type::before {
    height: 30px; /* Kr贸tsza linia dla pierwszego */
    top: -6px;
}
        /* --- STYLE DLA PODSUMOWA W MODALU ZADANIA --- */
        .summary-list-item {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr;
            gap: 8px;
            padding: 10px 8px;
            border-bottom: 1px solid var(--border-color);
            font-size: 13px;
            align-items: center;
        }
        .summary-list-item:last-child {
            border-bottom: none;
        }
        .summary-list-item span.val {
            text-align: center;
            font-weight: 500;
        }
        
        .budget-summary-item {
            padding: 10px;
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            margin-bottom: 6px;
        }
        .budget-summary-header {
            font-weight: 600;
            font-size: 13px;
            margin-bottom: 4px;
            display: flex;
            justify-content: space-between;
        }
        .budget-summary-details {
            font-size: 12px;
            color: var(--text-secondary);
            padding-left: 8px;
            border-left: 2px solid var(--bg-tertiary);
        }
        .budget-summary-row {
            display: flex;
            justify-content: space-between;
            margin-top: 2px;
        }
       /* === POPRAWIONE STYLE DLA LISTY KONTROLNEJ === */
        .checklist-item-row {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 10px;
            margin-bottom: 8px;
            display: flex;
            flex-direction: column;
            gap: 6px;
            transition: all 0.2s ease;
        }

        .checklist-item-row.completed {
            background-color: rgba(22, 163, 74, 0.05); /* Zielonkawe to */
            border-color: var(--success-primary);
        }

        /* --- GRNY WIERSZ: Checkbox + Tytu + Usu --- */
        .checklist-row-top {
            display: flex;
            align-items: center;
            gap: 12px;
            width: 100%;
        }

        /* KLUCZOWA POPRAWKA: U偶ywamy du偶szego selektora i !important, 
           aby nadpisa globalne "width: 100%" dla input贸w w modalu */
        .task-modal-tab-content .checklist-item-row input.checklist-checkbox {
            width: 20px !important;  /* Sztywna szeroko */
            height: 20px !important;
            margin: 0;
            flex-shrink: 0; /* Nie ciskaj mnie! */
            cursor: pointer;
            accent-color: var(--success-primary);
        }

        .task-modal-tab-content .checklist-item-row input.checklist-input-name {
            width: auto !important; /* Reset szerokoci */
            flex-grow: 1;           /* Rozcignij si na maxa */
            border: none;
            border-bottom: 1px solid transparent;
            border-radius: 0;
            background: transparent;
            padding: 4px 0;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
        }
        
        .checklist-input-name:focus {
            border-bottom-color: var(--accent-primary) !important;
            outline: none;
        }
        
        .checklist-item-row.completed .checklist-input-name {
            text-decoration: line-through;
            color: var(--text-secondary);
        }

        .checklist-delete-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 4px;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .checklist-delete-btn:hover {
            color: var(--danger-primary);
        }

        /* --- DOLNY WIERSZ: Data + Osoba --- */
        .checklist-row-bottom {
            display: flex;
            align-items: center;
            justify-content: space-between;
            /* Wcicie pod tytu (omija checkbox): 20px checkbox + 12px gap = 32px */
            padding-left: 32px; 
        }

        /* Styl dla daty */
        .checklist-date-wrapper {
            display: flex;
            align-items: center;
            gap: 6px;
            background-color: var(--bg-primary);
            padding: 2px 8px;
            border-radius: 4px;
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            font-size: 12px;
        }
        .checklist-date-wrapper svg {
            width: 14px;
            height: 14px;
        }
        
        .task-modal-tab-content .checklist-item-row input.checklist-input-date {
            width: auto !important;
            border: none;
            background: transparent;
            padding: 0;
            font-size: 12px;
            color: var(--text-secondary);
            cursor: pointer;
        }

        /* Styl dla osoby/wyszukiwarki (prawa strona) */
        .checklist-assignee-wrapper {
            position: relative;
        }
        
       .task-modal-tab-content .checklist-item-row input.member-search-input {
            width: 150px !important; /* Sztywna szeroko wyszukiwarki */
            /* ZMIANA: Usunito wcicie na lup */
            padding: 4px 8px;
            height: 28px;
            font-size: 12px;
            background-image: none; /* Pewno, 偶e lupa si nie pojawi */
        }
        
        /* Piguka osoby */
        .checklist-assignee-pill {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 2px 8px 2px 2px;
            background-color: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 14px;
            font-size: 12px;
            font-weight: 500;
            color: var(--text-primary);
        }
        

        /* === ULEPSZONE STYLE DLA EDYTORA TEKSTU (RICH TEXT) - POPRAWKA WIDOCZNOCI I WYSOKOCI === */
        
        /* 1. WYMUSZENIE PENEJ WYSOKOCI DLA KONTENERW ZAKADEK OPISU */
        /* Dotyczy g贸wnego zadania, nowego zadania i podzadania */
        #tab-content-description.active,
        #tab-new-task-description.active,
        #subtask-tab-content-description.active {
            display: flex !important;
            flex-direction: column;
            height: 100%;
            padding-bottom: 0; /* Usuwamy dolny padding, bo edytor ma swoje ramki */
        }

        /* Formularz wewntrz zakadki te偶 musi si rozciga */
        #tab-content-description .form-group,
        #tab-new-task-description .form-group,
        #subtask-tab-content-description .form-group {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            margin-bottom: 0; /* Usuwamy margines, 偶eby edytor dotyka dou */
            height: 100%;
        }

        /* 2. STYLE SAMEGO EDYTORA */
        .rte-container {
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            background-color: var(--bg-secondary);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            /* KLUCZOWE: Rozcignij si na 100% dostpnej wysokoci rodzica */
            flex-grow: 1; 
            height: 100%; 
            min-height: 200px;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .rte-container:focus-within {
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.1);
        }

        .rte-toolbar {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            padding: 6px;
            background-color: var(--bg-tertiary); /* Ciemniejsze to dla lepszego kontrastu paska */
            border-bottom: 1px solid var(--border-color);
            align-items: center;
            flex-shrink: 0; /* Pasek nie mo偶e si kurczy */
        }

        .rte-btn {
            width: 30px;
            height: 30px;
            background: var(--bg-secondary); /* Biae to przycisku */
            border: 1px solid var(--border-color);
            border-radius: 4px;
            cursor: pointer;
            padding: 0;
            /* ZMIANA: U偶ywamy text-primary (ciemniejszy) dla lepszej widocznoci ikon */
            color: var(--text-primary); 
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .rte-btn:hover {
            background-color: var(--bg-primary);
            border-color: var(--accent-primary);
            color: var(--accent-primary);
            transform: translateY(-1px);
            box-shadow: var(--shadow-sm);
        }

        .rte-btn svg {
            width: 16px;
            height: 16px;
            fill: currentColor;
            pointer-events: none;
            /* ZMIANA: Dodajemy filtr dla pewnoci, 偶e s widoczne */
            opacity: 0.9; 
        }
        
        .rte-select {
            /* ZMIANA: Dodano !important, aby nadpisa og贸lne style formularzy w podzadaniach */
            padding: 0 4px !important; 
            height: 30px !important;
            line-height: 28px; /* Centrowanie tekstu w pionie (30px - 2px ramki) */
            
            border-radius: 4px;
            border: 1px solid var(--border-color);
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 12px;
            cursor: pointer;
            outline: none;
            /* === POPRAWKA: Reset szerokoci dla paska narzdzi === */
            width: auto !important; /* Nadpisuje width: 100% z og贸lnych styli modala */
            max-width: 110px;       /* Zapobiega zbyt szerokim listom */
            margin-right: 4px;      /* Odstp od kolejnego elementu */
        }

        .rte-editor {
            flex-grow: 1; /* Rozcignij si, aby wypeni reszt kontenera */
            padding: 16px;
            overflow-y: auto;
            background-color: var(--bg-secondary);
            outline: none;
            font-size: 14px;
            line-height: 1.6;
            color: var(--text-primary);
            height: 100%; /* Zapewnij pen wysoko */
        }
        
        /* Separator w pasku */
        .rte-toolbar > div[style*="width: 1px"] {
            background-color: var(--border-color) !important;
            height: 20px !important;
            margin: 0 6px !important;
        }
        
        /* Style treci */
        .rte-editor ul, .rte-editor ol { padding-left: 24px; margin-bottom: 12px; }
        .rte-editor p { margin-bottom: 8px; }
        .rte-editor table { width: 100%; border-collapse: collapse; margin-bottom: 12px; font-size: 13px; }
        .rte-editor th, .rte-editor td { border: 1px solid var(--border-color); padding: 8px; }
        .rte-editor th { background-color: var(--bg-tertiary); font-weight: 600; }
        .rte-editor blockquote {
            border-left: 4px solid var(--accent-primary);
            margin: 12px 0; padding: 8px 16px;
            background-color: var(--bg-primary); color: var(--text-secondary);
            font-style: italic;
        }
        
        /* Placeholder */
        .rte-editor:empty::before {
            content: attr(data-placeholder);
            color: var(--text-secondary);
            opacity: 0.6;
            pointer-events: none;
            display: block;
        }
        /* === NOWE STYLE DLA OMNI-RADARU === */

        

        /* Piercienie Radaru (Niebieskie) */
        .radar-ring {
            fill: none;
            stroke: var(--accent-primary); /* G贸wny kolor niebieski aplikacji */
            stroke-width: 1;
            stroke-opacity: 0.2; /* Delikatna widoczno */
        }

        /* Osie dzielce projekty */
        .radar-axis {
            stroke: var(--accent-primary);
            stroke-width: 1;
            stroke-opacity: 0.3;
            stroke-dasharray: 4 4; /* Linia przerywana */
        }

        /* To sektora (opcjonalne, dla lepszej czytelnoci) */
        .radar-sector-bg {
            fill: var(--accent-primary);
            fill-opacity: 0.03;
            stroke: none;
            transition: fill-opacity 0.3s;
        }
        .radar-sector-bg:hover {
            fill-opacity: 0.08; /* Podwietlenie sektora po najechaniu */
        }

        /* Etykiety na radarze */
        .radar-label {
            font-family: var(--font-family-header);
            font-size: 11px;
            fill: var(--text-secondary);
            font-weight: 600;
            text-transform: uppercase;
            pointer-events: none; /* Kliknicia przechodz przez tekst */
            text-anchor: middle;
            text-shadow: 0 0 2px var(--bg-secondary); /* Obrys dla czytelnoci */
        }
        
        .radar-project-label {
            font-size: 13px;
            fill: var(--accent-primary);
            font-weight: 700;
        }

        /* Wzy (Zadania) */
        .radar-node {
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            stroke-width: 2px; /* Grubszy obrys */
            stroke: #ffffff;
            paint-order: stroke; /* Obrys nie zjada wypenienia */
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.4)); /* Mocniejszy cie */
        }

        .radar-node:hover {
            stroke: var(--text-primary);
            stroke-width: 3px;
            z-index: 100;
            filter: drop-shadow(0 0 10px var(--accent-primary)); /* Mocne wiecenie */
            transform: scale(1.3); /* Powikszenie */
        }

        /* === STYLE OMNI-RADARU (HIGH TEMP VERSION) === */
        
       /* Kontener z lekkim gradientem gbi */
        #radar-chart-container {
            background: radial-gradient(circle at center, rgba(79, 70, 229, 0.05) 0%, rgba(255,255,255,0) 70%);
        }

        .radar-svg {
            /* ZMIANA: Sztywne wymiary w pikselach. 
               To zmusza przegldark do narysowania du偶ego radaru, 
               nawet jeli nie mieci si na ekranie (obsu偶y to nasz Pan/Zoom). */
            width: 920px; /* ZMNIEJSZONO Z 960px (o ok. 1cm) */
            height: 920px; /* ZMNIEJSZONO Z 960px (o ok. 1cm) */
            
            /* Resetujemy ograniczenia, 偶eby go nie ciskao */
            max-width: none; 
            max-height: none;
            
            overflow: visible;
            
            /* Dziki temu przy starcie bdzie wycentrowany w kontenerze flex */
            display: block; 
        }

        /* Tarcza - ZWIKSZONA WIDOCZNO */
        .radar-ring {
            fill: none;
            stroke: var(--accent-primary);
            stroke-width: 1.5px; /* Grubsza linia */
            stroke-opacity: 0.5; /* Du偶o wy偶sza widoczno (byo 0.2) */
            stroke-dasharray: 4 4; /* Rzadsze kropkowanie dla lepszej czytelnoci */
        }
        
        /* O X/Y - ZWIKSZONA WIDOCZNO */
        .radar-axis {
            stroke: var(--accent-primary);
            stroke-width: 2px; /* Wyra藕na granica sektor贸w */
            stroke-opacity: 0.4; /* Wy偶sza widoczno (byo 0.15) */
            /* Usunito dasharray - linia ciga dla osi wyglda solidniej */
        }

        /* --- SKANER (The Sweep) --- */
        .radar-sweep {
            transform-origin: center;
            animation: radar-spin 4s linear infinite;
            fill: url(#radar-sweep-gradient); /* U偶yjemy gradientu SVG */
            pointer-events: none;
        }

        @keyframes radar-spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* --- WZY (ZADANIA) --- */
        .radar-node {
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            stroke-width: 1.5px;
            stroke: #fff;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2)); /* Cie 3D */
        }

        .radar-node:hover {
            stroke: var(--text-primary);
            stroke-width: 3px;
            z-index: 100;
            filter: drop-shadow(0 0 8px var(--accent-primary)); /* wiecenie przy hover */
            transform: scale(1.5);
        }

        /* Dodajemy ustawienia transformacji dla wszystkich wz贸w */
        .radar-node {
            transform-box: fill-box;
            transform-origin: center;
        }

        /* 1. STAN KRYTYCZNY (Efekt Sonaru) */
        .radar-node.critical {
            fill: var(--danger-primary) !important;
            stroke: #fff;
            animation: radar-ping 4s linear infinite; 
            filter: drop-shadow(0 0 2px var(--danger-primary));
            /* Usunito sztywne r: 6px, rozmiar jest teraz bazowy w SVG */
        }

        @keyframes radar-ping {
            /* Moment uderzenia skanera (Start) */
            0% { 
                transform: scale(1.5); /* Powikszenie */
                fill-opacity: 1; 
                stroke-width: 3px;
                filter: drop-shadow(0 0 12px var(--danger-primary));
            }
            /* Szybkie wygaszanie */
            10% {
                transform: scale(1.2);
                fill-opacity: 0.9;
                stroke-width: 2px;
                filter: drop-shadow(0 0 6px var(--danger-primary));
            }
            /* Stan spoczynku */
            30%, 100% { 
                transform: scale(1); /* Rozmiar bazowy */
                fill-opacity: 0.8; 
                stroke-width: 1px;
                filter: drop-shadow(0 0 2px var(--danger-primary));
            }
        }

       /* 2. STAN "GNICIA" (Stagnation - Szare, mae, zakurzone) */
        .radar-node.stale {
            fill: #9ca3af !important; /* Szary */
            stroke: #d1d5db;
            opacity: 0.6;
        }

        /* 3. STAN "DUCH" (Completed - Tylko obrys, zadania historyczne) */
        .radar-node.completed {
            fill: transparent !important; /* Brak wypenienia */
            stroke: var(--success-primary);
            stroke-width: 1px;
            opacity: 0.3; /* Bardzo sabo widoczne */
            pointer-events: auto; /* Nadal klikalne */
        }
        .radar-node.completed:hover {
            opacity: 1;
            stroke-width: 2px;
            fill: var(--success-primary) !important;
            fill-opacity: 0.1 !important;
        }
        
        /* --- AWATARY NA RADARZE --- */
        .radar-avatar-group {
            transition: transform 0.5s ease-out;
            cursor: pointer;
        }
        .radar-avatar-circle {
            stroke: var(--accent-primary);
            stroke-width: 2px;
            fill: var(--bg-secondary);
            filter: drop-shadow(0 2px 5px rgba(0,0,0,0.3));
        }
        .radar-avatar-text {
            font-size: 10px;
            font-weight: 700;
            fill: var(--text-primary);
            text-anchor: middle;
            pointer-events: none;
        }
        /* Linia czca awatar z centrum (opcjonalne, "grawitacja") */
        .radar-avatar-tether {
            stroke: var(--accent-primary);
            stroke-width: 1;
            stroke-opacity: 0.2;
            stroke-dasharray: 2 2;
        }
        /* Transform-origin musi by ustawione w JS lub przez atrybut dla SVG, tutaj pomocniczo */
        .radar-node { transform-box: fill-box; transform-origin: center; }

        /* Piguki w pasku filtr贸w Radaru */
        #radar-filter-bar .member-pill {
            cursor: pointer;
            border: 1px solid var(--border-color);
            background-color: var(--bg-secondary);
            opacity: 0.7;
            transition: all 0.2s;
        }
        #radar-filter-bar .member-pill:hover {
            opacity: 1;
            background-color: var(--bg-tertiary);
        }
        #radar-filter-bar .member-pill.active {
            opacity: 1;
            background-color: var(--accent-primary);
            color: var(--text-on-accent);
            border-color: var(--accent-primary);
            font-weight: 500;
        }
        /* === NOWE STYLE: CLEAN UI HEADER (Modern) === */
        
        .main-header {
            display: flex;
            justify-content: space-between;
            align-items: center; /* Wyrodkowanie w pionie */
            padding: 12px 24px; /* Nieco mniejszy padding pionowy */
            background-color: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            height: 72px; /* Staa wysoko dla sp贸jnoci */
        }

        /* LEWA STRONA: Tytu i Meta */
        .header-left-section {
            display: flex;
            flex-direction: column; /* Ukad pionowy: Tytu nad Meta */
            justify-content: center;
            gap: 4px;
            min-width: 0; /* Zapobiega rozpychaniu przez dugi tekst */
        }

        .project-title-row {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .project-title-row h2 {
            font-size: 20px; /* Nieco mniejszy, bardziej elegancki */
            font-weight: 700;
            margin: 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: var(--text-primary);
        }

        /* Przycisk Menu Projektu (Trzy kropki) */
        .project-menu-btn {
            background: transparent;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            padding: 2px 4px;
            color: var(--text-secondary);
            transition: background-color 0.2s, color 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .project-menu-btn:hover, .project-menu-btn.active {
            background-color: var(--bg-tertiary);
            color: var(--text-primary);
        }

        /* Dropdown Menu Projektu */
        .project-menu-dropdown {
            position: absolute;
            top: 50px; /* Pod tytuem */
            left: 24px; /* Wyr贸wnane do lewej */
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-lg);
            z-index: 2000;
            min-width: 180px;
            padding: 4px 0;
            display: none; /* Domylnie ukryte */
            opacity: 0;
            transform: translateY(-10px);
            transition: opacity 0.2s, transform 0.2s;
        }
        .project-menu-dropdown.visible {
            display: block;
            opacity: 1;
            transform: translateY(0);
        }

        .project-menu-item {
            display: flex;
            align-items: center;
            gap: 8px;
            width: 100%;
            padding: 8px 12px;
            font-size: 13px;
            font-weight: 500;
            color: var(--text-primary);
            background: none;
            border: none;
            cursor: pointer;
            text-align: left;
        }
        .project-menu-item:hover {
            background-color: var(--bg-tertiary);
        }
        .project-menu-item.danger {
            color: var(--danger-primary);
        }
        .project-menu-item.danger:hover {
            background-color: #fee2e2;
        }
        .project-menu-item svg {
            width: 16px;
            height: 16px;
        }

        /* Meta Dane (pod tytuem) */
        .project-meta-row {
            display: flex;
            align-items: center;
            gap: 16px;
            font-size: 12px;
            color: var(--text-secondary);
            height: 20px; /* Staa wysoko */
        }
        
        /* Pasek postpu - mini wersja */
        .mini-progress-bar {
            width: 100px;
            height: 6px;
            background-color: var(--bg-tertiary);
            border-radius: 3px;
            overflow: hidden;
        }
        .mini-progress-fill {
            height: 100%;
            background-color: var(--success-primary);
            border-radius: 3px;
        }

        /* PRAWA STRONA: Narzdzia */
        .header-right-section {
            display: flex;
            align-items: center;
            gap: 4px; /* May odstp midzy ikonami */
        }

        /* Divider (Pionowa kreska) */
        .header-divider {
            width: 1px;
            height: 24px;
            background-color: var(--border-color);
            margin: 0 8px; /* Odstp od grup */
        }

        /* Uniwersalny przycisk ikony (Zastpuje stare .sort-btn, .header-btn itp.) */
        .header-icon-btn {
            width: 40px; /* ZWIKSZONO z 32px */
            height: 40px; /* ZWIKSZONO z 32px */
            display: flex;
            align-items: center;
            justify-content: center;
            background: transparent;
            border: 1px solid transparent;
            border-radius: 8px; /* Nieco wiksze zaokrglenie przy wikszym przycisku */
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
            
            /* === KLUCZOWA POPRAWKA DLA BADGE'A === */
            position: relative; /* To sprawia, 偶e czerwone k贸ko pozycjonuje si wzgldem TEGO przycisku */
        }
        
        .header-icon-btn:hover {
            background-color: var(--bg-tertiary);
            color: var(--text-primary);
        }
        
        .header-icon-btn.active {
            background-color: rgba(79, 70, 229, 0.1);
            color: var(--accent-primary);
        }
        
        .header-icon-btn svg {
            width: 24px; /* ZWIKSZONO z 18px */
            height: 24px; /* ZWIKSZONO z 18px */
            stroke-width: 1.8px;
        }

        /* --- STYL DLA LICZNIKA (BADGE) --- */
        .header-icon-btn .notification-badge {
            position: absolute;
            top: -2px;          /* Wyjcie lekko poza obrys przycisku */
            right: -2px;
            
            min-width: 18px;    /* Minimalna szeroko dla jednej cyfry */
            height: 18px;
            padding: 0 4px;     /* Padding dla liczb dwucyfrowych (np. 10) */
            
            background-color: var(--danger-primary);
            color: white;
            font-size: 10px;
            font-weight: 700;
            border-radius: 10px; /* Ksztat pastylki */
            
            display: flex;      /* Centrowanie tekstu */
            align-items: center;
            justify-content: center;
            
            /* Biaa obw贸dka oddzielajca licznik od ikony/ta */
            box-shadow: 0 0 0 2px var(--bg-secondary); 
            pointer-events: none; /* Kliknicie w licznik klika w przycisk */
            z-index: 10;
        }

        /* --- STYL DLA NIEBIESKIEJ IKONY (Nieprzeczytane) --- */
        /* Klasy .has-notifications (Dzwonek) i .has-unread (Czat) s nadawane przez JS */
        
        .header-icon-btn.has-notifications,
        .header-icon-btn.has-unread {
            color: var(--accent-primary) !important; /* Wymu niebieski kolor */
            background-color: rgba(79, 70, 229, 0.08); /* Delikatne niebieskie to */
            border-color: rgba(79, 70, 229, 0.2); /* Delikatna ramka */
        }

        /* Opcjonalnie: Pogrubienie ikony, gdy jest co nowego */
        .header-icon-btn.has-notifications svg,
        .header-icon-btn.has-unread svg {
            stroke-width: 2px;
        }
        
        /* Styl dymka (tooltip) jest obsugiwany przez natywny title="" przegldarki 
           lub bibliotek tippy.js, kt贸r masz zaadowan. 
           Dla natywnego title nie potrzebujemy CSS. */

        /* Ukrywanie element贸w w trybie edycji */
        .header-icon-btn span {
            display: none; /* Ukryj tekst, poka偶 tylko ikon */
        }


    </style>

</head>
<body>
    <div id="loading-overlay" style="display: none;">
        <p>adowanie aplikacji...</p>
    </div>

    <div id="auth-overlay">
    <div class="auth-wrapper">
        <div class="auth-promo-column">
   <div class="auth-promo-header">
        <img src="nowo_logo.png" alt="TeamFlow Logo" class="logo-img">
        <h2>Zarzdzaj projektami i zespoem. Usprawnij sw贸j dzie pracy.</h2>
    </div>

    <img src="Strona1.png" alt="Widok listy zada" class="promo-single-image">

    <p>TeamFlow to zaawansowana platforma, kt贸ra z natury czy prostot narzdzia do zapisywania bie偶cych spraw z potg i gbi niezbdn do prowadzenia najwikszych, najbardziej zo偶onych przedsiwzi zespoowych. Osignij pen widoczno i kontrol, niezale偶nie od skali wyzwania.</p>

    <img src="Strona4.png" alt="Wykres obci偶enia zespou" class="large-illustration">
</div>
        
        <div class="auth-form-column">
            <div class="auth-container">
                <img src="nowo_logo.png" alt="TeamFlow Logo" class="auth-mobile-logo">
                <form id="login-form" class="auth-form">
                    <h2>Zaloguj si</h2>
                    <div class="form-group">
                        <label for="login-email">Email</label>
                        <input type="email" id="login-email" required>
                    </div>
                    <div class="form-group">
                        <label for="login-password">Haso</label>
                        <input type="password" id="login-password" required>
                    </div>
                    <button type="submit" class="btn btn-primary">Zaloguj si</button>
                    <p id="auth-error-login" class="error-message"></p>
                    <p class="auth-toggle" style="margin-top: 12px;">
                        <a id="show-password-reset" style="font-weight: 500; cursor: pointer;">Zapomniae hasa?</a>
                    </p>
                    <p class="auth-toggle">Nie masz konta? <a id="show-register">Zarejestruj si</a></p>
                </form>
                <div id="register-success-message" style="display: none; text-align: center;">
                    <h2>Rejestracja udana! </h2>
                    <p style="margin-top: 16px; line-height: 1.6;">
                        Wysalimy link aktywacyjny na Tw贸j adres e-mail: <strong id="success-email-display"></strong>.
                        <br>
                        Prosz, kliknij w link, aby zweryfikowa swoje konto i m贸c si zalogowa.
                    </p>
                    <button id="back-to-login-btn" class="btn btn-primary" style="margin-top: 24px;">Wr贸 do logowania</button>
                </div>
                <form id="password-reset-form" class="auth-form" style="display: none;">
                    <h2>Zresetuj haso</h2>
                    <p style="font-size: 14px; color: var(--text-secondary); margin-bottom: 16px;">Podaj adres e-mail powizany z Twoim kontem, a wylemy Ci link do zresetowania hasa.</p>
                    <div class="form-group">
                        <label for="reset-email">Adres e-mail</label>
                        <input type="email" id="reset-email" required>
                    </div>
                    <button type="submit" class="btn btn-primary">Wylij link</button>
                    <p id="auth-message-reset" class="error-message" style="color: var(--success-primary);"></p>
                    <p class="auth-toggle">Pamitasz haso? <a id="show-login-from-reset">Wr贸 do logowania</a></p>
                </form>

                <form id="register-form" class="auth-form">
                    <h2>Stw贸rz konto</h2>
                    <div class="form-group">
                        <label for="register-name">Nazwa u偶ytkownika</label>
                        <input type="text" id="register-name" required>
                    </div>
                    <div class="form-group">
                        <label for="register-email">Email</label>
                        <input type="email" id="register-email" required>
                    </div>

                    <div class="form-group-checkbox">
                        <input type="checkbox" id="register-team-toggle">
                        <label for="register-team-toggle">Bd korzysta z aplikacji z zespoem</label>
                    </div>

                    <div id="register-team-options" style="display: none; margin-top: 16px; background-color: var(--bg-primary); padding: 12px; border-radius: var(--border-radius);">
                        <div class="form-group" style="display: flex; gap: 20px;">
                            <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 0;">
                                <input type="radio" name="group-action" value="create" checked> Stw贸rz now grup
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 0;">
                                <input type="radio" name="group-action" value="join"> Docz do grupy
                            </label>
                        </div>

                        <div class="form-group">
                            <label for="register-group-name">Nazwa grupy</label>
                            <input type="text" id="register-group-name" placeholder="np. Firma ACME">
                        </div>
                    </div> <div class="form-group">
                        <label for="register-password">Haso (min. 6 znak贸w)</label>
                        <input type="password" id="register-password" required>
                    </div>
                    <div class="form-group">
                        <label for="register-password-confirm">Potwierd藕 haso</label>
                        <input type="password" id="register-password-confirm" required>
                    </div>
                    
                    <button type="submit" class="btn btn-primary">Zarejestruj si</button>
                    <p id="auth-error-register" class="error-message"></p>
                    <p class="auth-toggle">Masz ju偶 konto? <a id="show-login">Zaloguj si</a></p>
                </form>
            </div>
        </div>
    </div>
</div>
    
    <div class="app-container hidden">
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <img src="nowo_logo.png" alt="TeamFlow Logo" id="app-logo">
                <img src="nowo_logo.png" alt="TeamFlow Mini Logo" id="mini-logo"> <button id="sidebar-toggle-btn" class="header-btn" title="Zwi / Rozwi panel">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5L8.25 12l7.5-7.5" />
                    </svg>
                </button>
                </div>

            <div class="search-bar">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" />
                </svg>
                <input type="text" placeholder="Szukaj..." id="search-input">
            </div>

             <nav class="nav-section">
                <ul class="nav-list" id="main-nav">
    <li class="nav-item">
        <a href="#" data-view="my-day">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
               <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z" />
            </svg>
            <span>M贸j dzie</span>
        </a>
    </li>
    <li class="nav-item">
        <a href="#" data-view="my-dashboard">
             <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z" />
            </svg>
            <span>M贸j Dashboard</span>
        </a>
    </li>
    <li class="nav-item">
        <a href="#" data-view="all-projects">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 9.75h16.5v8.25a2.25 2.25 0 01-2.25 2.25H6a2.25 2.25 0 01-2.25-2.25v-8.25z" />
              <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 9.75a2.25 2.25 0 012.25-2.25h4.5a2.25 2.25 0 012.25 2.25M3.75 9.75h16.5" />
            </svg>
            <span>Wszystkie projekty</span>
        </a>
    </li>
    <li class="nav-item" id="inbox-nav-item" style="display: none;">
        <a href="#">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 5.25h16.5a2.25 2.25 0 012.25 2.25v10.5a2.25 2.25 0 01-2.25 2.25H3.75A2.25 2.25 0 011.5 18V7.5a2.25 2.25 0 012.25-2.25z" />
              <path stroke-linecap="round" stroke-linejoin="round" d="M5.25 8.25v.01M5.25 12v.01M5.25 15.75v.01M9 8.25H18M9 12H18M9 15.75H18" />
            </svg>
            <span id="inbox-nav-item-name">Skrzynka zada</span>
        </a>
    </li>
    <li class="nav-item">
        <a href="#" data-view="radar">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24" fill="none">
              <circle cx="12" cy="12" r="9" fill="none" stroke="currentColor" stroke-width="1.4" />
              <circle cx="12" cy="12" r="6" fill="none" stroke="currentColor" stroke-width="1" opacity="0.85"/>
              <circle cx="12" cy="12" r="3" fill="none" stroke="currentColor" stroke-width="0.9" opacity="0.75"/>
              <path d="M12 12 L20.2 7.2 A9 9 0 0 0 12 3 Z" fill="currentColor" fill-opacity="0.30"/>
              <path d="M12 12 L20.2 7.2" stroke="currentColor" stroke-width="1.3" stroke-linecap="round" />
            </svg>
            <span>Omni-Radar</span>
        </a>
    </li>
</ul>
            </nav>

            <div class="sidebar-scrollable-area">
                <nav class="nav-section">
                    <h2>Ulubione projekty</h2>
                    <div id="favorites-flyout-menu" class="flyout-menu"></div>
                    <ul class="nav-list" id="projects-list">
                    </ul>
                </nav>
                
                 <nav class="nav-section" id="completed-projects-section" style="display: none !important;">
                    <h2>Zakoczone projekty</h2>
                    <ul class="nav-list" id="completed-projects-list">
                    </ul>
                </nav>
            </div>

            <div class="sidebar-static-footer-content">
                <button class="btn btn-secondary" id="resources-btn" style="width: 100%; margin-bottom: 0; display: flex; align-items: center; justify-content: center; gap: 6px;">
                    <span>Zasoby i Narzdzia</span>
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" style="width: 16px; height: 16px;">
                      <path stroke-linecap="round" stroke-linejoin="round" d="m19.5 8.25-7.5 7.5-7.5-7.5" />
                    </svg>
                </button>
                
                <div id="resources-menu" class="flyout-menu">
                    <button class="btn btn-secondary" id="open-templates-btn-menu" style="width: 100%; justify-content: flex-start; margin-top: 4px;">
                        Szablony Projekt贸w
                    </button>
                    <button class="btn btn-secondary" id="open-archive-btn-menu" style="width: 100%; justify-content: flex-start; margin-top: 4px;">
                        Archiwum Projekt贸w
                    </button>
                </div>

                <button class="new-project-btn" id="new-project-btn" disabled style="margin-top: 8px;">+ Nowy Projekt</button>

                <div class="sidebar-footer">
    
    <div class="user-info">
        Zalogowano jako:<br><span id="user-email-display"></span>
    </div>
    
    <style>
        #group-switcher {
            position: relative;
            margin-bottom: 8px;
        }
        #group-switcher-toggle {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            padding: 8px 10px;
            background-color: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
        }
        #group-switcher-toggle:hover {
            background-color: var(--bg-tertiary);
        }
        #group-switcher-toggle svg {
            width: 16px;
            height: 16px;
            transition: transform 0.2s;
        }
        #group-switcher-toggle.open svg {
            transform: rotate(180deg);
        }
        /* === POCZTEK ZMIANY: Poprawiona logika CSS dla #group-switcher-menu === */
            
        /* KROK 1: Definicja bazowa dla menu (tryb flyout przy zwinitym sidebarze) */
        /* Usunito 'display: none'. U偶ywamy opacity/visibility dla animacji. */
        #group-switcher-menu {
            position: absolute;
            bottom: 105%; /* Domylnie otwiera si w g贸r (dla widoku mobilnego) */
            left: 0;
            width: 100%;
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-lg);
            z-index: 2001; /* Wy偶ej ni偶 sidebar */
            padding: 4px;
            padding-bottom: 12px; /* <<< DODANO: Odstp na dole, 偶eby nie ucinao guzika */
            max-height: 600px;    /* <<< ZMIANA: Zwikszono z 250px na 600px */
            overflow-y: auto;
            
            /* Logika ukrywania dla flyout (zamiast display: none) */
            visibility: hidden;
            opacity: 0;
            transform: translateY(10px); /* Lekki efekt wysunicia */
            transition: opacity 0.2s, transform 0.2s, visibility 0.2s;
        }

        /* KROK 2: Styl otwarcia dla trybu flyout (u偶ywane przez JS w trybie zwinitym) */
        /* KROK 2: Styl otwarcia dla trybu flyout (u偶ywane przez JS w trybie zwinitym) */
        /* USUNITO: Regua #group-switcher-menu.flyout-open (jest teraz obsugiwana przez .flyout-menu.open) */

        /* === POCZTEK ZMIANY: Poprawka dla widoku mobilnego i desktopowego === */
        /* KROK 3: Logika dla ROZWINITEGO sidebara (TYLKO DESKTOP) */
        /* Ta regua resetuje style flyout i wcza animacj max-height */
        @media (min-width: 769px) {
            .app-container:not(.sidebar-collapsed) #group-switcher-menu {
                position: static;
                width: 100%;
                padding: 0;
                border: none;
                box-shadow: none;
                transform: none;
                transition: max-height 0.3s ease-in-out;
                
                /* Reset styl贸w flyout */
                display: block; 
                visibility: visible;
                opacity: 1;
                bottom: auto;
                left: auto;
                
                /* Logika zwijania dla rozwinitego sidebara */
                max-height: 0;
                overflow: hidden;
            }

           /* KROK 4: Logika otwierania dla ROZWINITEGO sidebara (TYLKO DESKTOP) */
            .app-container:not(.sidebar-collapsed) #group-switcher-menu.open {
                max-height: 600px; /* <<< ZMIANA: Zwikszono z 250px na 600px */
            }
        }
        
        /* KROK 5: NOWA REGUA dla otwierania w trybie MOBILNYM */
        /* (oraz jako fallback dla flyout, jeli JS zawiedzie) */
        #group-switcher-menu.open {
            visibility: visible;
            opacity: 1;
            transform: translateY(0);
        }

        /* === KONIEC ZMIANY === */

        #group-switcher-menu .group-menu-item,
        #group-switcher-menu .group-menu-action {
            display: block;
            width: 100%;
            text-align: left;
            padding: 8px 10px;
            font-size: 14px;
            font-weight: 500;
            background: none;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            color: var(--text-primary);
            
            /* === POCZTEK ZMIANY: Naprawa zawijania tekstu === */
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            /* === KONIEC ZMIANY === */
        }
        #group-switcher-menu .group-menu-item:hover,
        #group-switcher-menu .group-menu-action:hover {
            background-color: var(--bg-tertiary);
        }
        #group-switcher-menu .group-menu-item.active {
            background-color: var(--accent-primary);
            color: var(--text-on-accent);
            font-weight: 600;
        }
        
        /* === NOWE STYLE DLA PRZYCISKW AKCJI W MENU === */
        #group-switcher-menu #manage-groups-btn {
            color: var(--accent-primary);
            font-weight: 600;
        }
        #group-switcher-menu #manage-groups-btn:hover {
            color: var(--text-on-accent);
            background-color: var(--accent-hover);
        }
        
        #group-switcher-menu #invite-member-menu-btn {
            color: var(--success-primary);
            font-weight: 600;
        }
        #group-switcher-menu #invite-member-menu-btn:hover {
            color: var(--text-on-accent);
            background-color: var(--success-primary);
        }
        /* === KONIEC NOWYCH STYLI === */
        
        #group-switcher-menu hr {
            border: none;
            border-top: 1px solid var(--border-color);
            margin: 4px 0;
        }

        /* Usunicie domylnych margines贸w dla przycisk贸w w nowym kontenerze */
        .group-action-container .group-menu-action {
             margin-top: 0 !important;
             padding-top: 8px !important;
             border-top: none !important;
        }
    </style>
    
    <div id="group-switcher">
        <button id="group-switcher-toggle">
            <span id="active-group-name">adowanie grupy...</span>
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="m19.5 8.25-7.5 7.5-7.5-7.5" />
            </svg>
        </button>
        
        <div id="group-switcher-menu" class="flyout-menu">
        <div id="group-switcher-list" class="group-action-container">
                    <span class="group-menu-action">adowanie...</span>
                </div>
                <hr>
                
                <div class="group-action-container">
                    <button class="group-menu-action" id="join-group-btn">Docz do grupy</button>
                    <button class="group-menu-action" id="create-group-btn">+ Stw贸rz now grup</button>
                </div>
                
                <div class="group-action-container">
                    <button class="group-menu-action" id="manage-groups-btn" style="display: none; border-top: none; margin-top: 0; padding-top: 8px;">Zarzdzaj aktywn grup</button>
                    <button class="group-menu-action" id="invite-member-menu-btn" style="display: none; border-top: none; margin-top: 0; padding-top: 8px;">Zapro do grupy</button>
                    <button class="group-menu-action btn-danger" id="leave-group-btn" style="display: none; border-top: none; margin-top: 0; padding-top: 8px; color: var(--danger-primary);">Opu aktywn grup</button>
                </div>
        
        </div>
        </div>
    <div class="sidebar-footer-buttons">
        <button id="open-ai-help-btn" class="btn btn-secondary" title="Pomoc AI">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 20px; height: 20px;">
              <path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904 9 18.75l-.813-2.846a4.5 4.5 0 0 0-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 0 0 3.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 0 0 3.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 0 0-3.09 3.09ZM18.259 8.715 18 9.75l-.259-1.035a3.375 3.375 0 0 0-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 0 0 2.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 0 0 2.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 0 0-2.456 2.456ZM16.894 20.567 16.5 21.75l-.394-1.183a2.25 2.25 0 0 0-1.423-1.423L13.5 18.75l1.183-.394a2.25 2.25 0 0 0 1.423-1.423L16.5 15.75l.394 1.183a2.25 2.25 0 0 0 1.423 1.423l1.183.394-1.183.394a2.25 2.25 0 0 0-1.423 1.423Z" />
            </svg>
        </button>
        <button id="settings-btn" class="btn btn-secondary" title="Ustawienia">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 20px; height: 20px;">
                <path stroke-linecap="round" stroke-linejoin="round" d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.324.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 011.37.49l1.296 2.247a1.125 1.125 0 01-.26 1.431l-1.003.827c-.293.24-.438.613-.438.995s.145.755.438.995l1.003.827c.48.398.668 1.04.26 1.431l-1.296 2.247a1.125 1.125 0 01-1.37.49l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.57 6.57 0 01-.22.128c-.331.183-.581.495-.644.869l-.213 1.28c-.09.543-.56.941-1.11.941h-2.594c-.55 0-1.02-.398-1.11-.94l-.213-1.281c-.063-.374-.313-.686-.645-.87a6.52 6.52 0 01-.22-.127c-.324-.196-.72-.257-1.075-.124l-1.217.456a1.125 1.125 0 01-1.37-.49l-1.296-2.247a1.125 1.125 0 01.26-1.431l1.004-.827c.292-.24.437-.613.437-.995s-.145-.755-.437-.995l-1.004-.827a1.125 1.125 0 01-.26-1.431l1.296-2.247a1.125 1.125 0 011.37.49l1.217.456c.355.133.75.072 1.076-.124.072-.044.146-.087.22-.128.332-.183.582-.495.644-.869l.213-1.28z"></path>
                <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
            </svg>
        </button>
        <button id="logout-btn" class="btn">Wyloguj</button>
    </div>
</div>
        </aside>
        <div class="sidebar-overlay" id="sidebar-overlay"></div>

        <main class="main-content">
             <header class="mobile-header">
    <button id="menu-toggle">
         <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
        </svg>
    </button>

    <button id="back-to-projects-btn-mobile" class="header-btn" title="Wr贸 do wszystkich projekt贸w" style="display: none;">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" style="width: 24px; height: 24px;">
            <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5L3 12m0 0l7.5-7.5M3 12h18" />
        </svg>
    </button>
    <h2 id="mobile-header-title"></h2>

    <div id="my-day-nav-mobile" style="display: none;">
        <button id="my-day-prev-mobile" class="header-btn" title="Poprzedni dzie">&lt;</button>
        <h2 id="my-day-date-display-mobile"></h2>
        <button id="my-day-next-mobile" class="header-btn" title="Nastpny dzie">&gt;</button>
        <button id="my-day-today-mobile" class="btn btn-secondary">Dzi</button>
    </div>

    <div class="header-actions">
         <button id="calendar-toggle-btn-mobile" class="header-btn" title="Poka偶 kalendarz">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 0 1 2.25-2.25h13.5A2.25 2.25 0 0 1 21 7.5v11.25m-18 0A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75m-18 0h18" />
            </svg>
        </button>
        <button id="notification-toggle-btn-mobile" class="header-btn" title="Zarzdzaj powiadomieniami">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M14.857 17.082a23.848 23.848 0 005.454-1.31A8.967 8.967 0 0118 9.75v-.7V9A6 6 0 006 9v.75a8.967 8.967 0 01-2.312 6.022c1.733.64 3.56 1.085 5.455 1.31m5.714 0a24.255 24.255 0 01-5.714 0m5.714 0a3 3 0 11-5.714 0" />
                </svg>
            </button>
            
            <button id="toggle-chat-btn-mobile" class="header-btn" title="Chat Projektu" style="display: none;">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                    <path d="M4 5.5C4 4.6716 4.6716 4 5.5 4h13c0.8284 0 1.5 0.6716 1.5 1.5v8c0 0.8284-0.6716 1.5-1.5 1.5H8.5L5 19V6.5"
                        fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                    <circle cx="9" cy="11" r="0.9" fill="currentColor"/>
                    <circle cx="12" cy="11" r="0.9" fill="currentColor"/>
                    <circle cx="15" cy="11" r="0.9" fill="currentColor"/>
                </svg>
                <span class="notification-badge" style="display: none;"></span>
            </button>
            <button id="mobile-project-actions-toggle" class="header-btn" title="Akcje projektu" style="display: none;">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 24px; height: 24px;">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M12 6.75a.75.75 0 110-1.5.75.75 0 010 1.5zM12 12.75a.75.75 0 110-1.5.75.75 0 010 1.5zM12 18.75a.75.75 0 110-1.5.75.75 0 010 1.5z" />
                </svg>
            </button>
            </div>
    </header>
<div id="mobile-project-actions-menu" class="mobile-actions-menu" style="display: none;">
    <ul>
         <li><a href="#" data-action="filter">Filtruj zadania</a></li>
        <li><a href="#" data-action="sort">Sortuj wg daty</a></li>
        <li><a href="#" data-action="details">Szczeg贸y</a></li>
        <li><a href="#" data-action="edit">Edytuj projekt</a></li>
        <li><a href="#" data-action="complete">Zakocz projekt</a></li>
        <li><a href="#" data-action="delete" class="danger">Usu projekt</a></li>
    </ul>
</div>
            <header class="main-header">
                
                <div class="header-left-section">
                    
                    <div id="my-day-nav" style="display: none; align-items: center; gap: 12px;">
                        <div style="display: flex; align-items: center; gap: 4px;">
                             <button id="my-day-prev" class="header-icon-btn" title="Poprzedni dzie">&lt;</button>
                             <button id="my-day-today" class="btn btn-secondary" style="padding: 4px 12px; font-size: 12px;">Dzi</button>
                             <button id="my-day-next" class="header-icon-btn" title="Nastpny dzie">&gt;</button>
                        </div>
                        <h2 id="my-day-view-title" style="font-size: 20px; font-family: var(--font-family-header); margin: 0;">M贸j dzie</h2>
                        <span id="my-day-date-display" style="font-size: 14px; color: var(--text-secondary);"></span> 
                    </div>

                    <div class="project-title-wrapper" style="display: flex; flex-direction: column;">
                        <div class="project-title-row">
                            <h2 id="project-name-header">Nazwa Projektu</h2>
                            
                            <div style="position: relative;">
                                <button id="project-menu-toggle" class="project-menu-btn" title="Menu Projektu" style="display: none;">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="1"/><circle cx="19" cy="12" r="1"/><circle cx="5" cy="12" r="1"/></svg>
                                </button>
                                <div id="project-menu-dropdown" class="project-menu-dropdown">
                                    <button class="project-menu-item" data-action="details">
                                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M11.25 11.25l.041-.02a.75.75 0 011.063.852l-.708 2.836a.75.75 0 001.063.853l.041-.021M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9-3.75h.008v.008H12V8.25z" /></svg>
                                        Szczeg贸y
                                    </button>
                                    <button class="project-menu-item" data-action="edit">
                                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0115.75 21H5.25A2.25 2.25 0 013 18.75V8.25A2.25 2.25 0 015.25 6H10" /></svg>
                                        Edytuj projekt
                                    </button>
                                    
                                    <button class="project-menu-item" id="manage-columns-menu-item">
                                         <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 4.5v15m6-15v15m-10.875 0h15.75c.621 0 1.125-.504 1.125-1.125V5.625c0-.621-.504-1.125-1.125-1.125H4.125C3.504 4.5 3 5.004 3 5.625v12.75c0 .621.504 1.125 1.125 1.125z" /></svg>
                                         Zarzdzaj kolumnami
                                    </button>
                                    
                                    <button class="project-menu-item" data-action="complete" style="border-top: 1px solid var(--border-color);">
                                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                                        Zakocz projekt
                                    </button>
                                    <button class="project-menu-item danger" data-action="delete">
                                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0" /></svg>
                                        Usu projekt
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="project-meta-row">
                             <div id="project-members-header" class="project-members"></div>
                             <div id="project-progress-container" style="display: flex; align-items: center; gap: 8px; display: none;">
                                 <div class="mini-progress-bar"><div class="mini-progress-fill" style="width: 0%;"></div></div>
                                 <span id="project-progress-text" style="font-size: 11px;">0%</span>
                             </div>
                        </div>
                    </div>
                </div>

                <div class="header-right-section">
                    
                    <button id="sort-btn" class="header-icon-btn" title="Sortuj wg daty" style="display: none;">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 7.5L7.5 3m0 0L12 7.5M7.5 3v13.5m13.5 0L16.5 21m0 0L12 16.5m4.5 4.5V7.5" /></svg>
                    </button>
                    
                    <button id="filter-btn" class="header-icon-btn" title="Filtruj" style="display: none;">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3c2.755 0 5.455.232 8.083.678.533.09.917.556.917 1.096v1.044a2.25 2.25 0 01-.659 1.591l-5.432 5.432a2.25 2.25 0 00-.659 1.591v2.927a2.25 2.25 0 01-1.244 2.013L9.75 21v-6.568a2.25 2.25 0 00-.659-1.591L3.659 7.409A2.25 2.25 0 013 5.818V4.774c0-.54.384-1.006.917-1.096A48.32 48.32 0 0112 3z" /></svg>
                    </button>
                    
                    <div class="header-divider"></div>

                    <button id="select-mode-toggle-btn" class="header-icon-btn" title="Zaznacz wiele zada" style="display: none;">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" /></svg>
                    </button>

                    <button id="calendar-toggle-btn" class="header-icon-btn" title="Przecz widok kalendarza">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 0 1 2.25-2.25h13.5A2.25 2.25 0 0 1 21 7.5v11.25m-18 0A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75m-18 0h18" /></svg>
                    </button>
                    
                    <button id="open-new-window-btn" class="header-icon-btn" title="Otw贸rz projekt w nowym oknie" style="display: none;">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M13.5 6H5.25A2.25 2.25 0 0 0 3 8.25v10.5A2.25 2.25 0 0 0 5.25 21h10.5A2.25 2.25 0 0 0 18 18.75V10.5m-10.5 6L21 3m0 0h-5.25M21 3v5.25" /></svg>
                    </button>

                    <div class="header-divider"></div>

                    <button id="notification-toggle-btn" class="header-icon-btn" title="Powiadomienia">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M14.857 17.082a23.848 23.848 0 0 0 5.454-1.31A8.967 8.967 0 0 1 18 9.75v-.7V9A6 6 0 0 0 6 9v.75a8.967 8.967 0 0 1-2.312 6.022c1.733.64 3.56 1.085 5.455 1.31m5.714 0a24.255 24.255 0 0 1-5.714 0m5.714 0a3 3 0 1 1-5.714 0" /></svg>
                        <span class="notification-badge" style="display: none;"></span>
                    </button>
                    
                    <button id="toggle-chat-btn" class="header-icon-btn" title="Chat Projektu" style="display: none;">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M4 5.5C4 4.6716 4.6716 4 5.5 4h13c0.8284 0 1.5 0.6716 1.5 1.5v8c0 0.8284-0.6716 1.5-1.5 1.5H8.5L5 19V6.5"/><circle cx="9" cy="11" r="0.9" fill="currentColor"/><circle cx="12" cy="11" r="0.9" fill="currentColor"/><circle cx="15" cy="11" r="0.9" fill="currentColor"/></svg>
                        <span class="notification-badge" style="display: none;"></span>
                    </button>
                    
                    <button id="open-trash-btn" class="header-icon-btn" title="Kosz usunitych zada" style="display: none;">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18" /><path d="M8 6l1-2h6l1 2" /><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6" /><path d="M10 11v6" /><path d="M14 11v6" /></svg>
                    </button>
                    
                    <button id="edit-dashboard-layout-btn" class="sort-btn" style="display: none; margin-left: 8px;">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 16px; height: 16px;"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" /></svg>
                        <span>Edytuj ukad KPI</span>
                    </button>
                    <button id="edit-projects-layout-btn" class="sort-btn" style="display: none; margin-left: 8px;">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 16px; height: 16px;"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" /></svg>
                        <span>Edytuj ukad</span>
                    </button>
                    
                    <button id="back-to-projects-btn" class="header-icon-btn" title="Wr贸" style="display: none;">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5L3 12m0 0l7.5-7.5M3 12h18" /></svg>
                    </button>

                </div>
            </header>
            <div id="bulk-action-bar" style="display: none;">
                <span id="bulk-action-count">Zaznaczono: 0</span>
                <div class="bulk-action-buttons">
                    <button id="bulk-assign-btn" class="btn btn-primary" style="padding: 6px 12px; font-size: 13px;">Zmie przypisanego</button>
                    <button id="bulk-delete-btn" class="btn btn-danger" style="padding: 6px 12px; font-size: 13px;">Usu zaznaczone</button>
                </div>
            </div>
            <section class="kanban-board" id="kanban-board">
            </section>

            <div id="calendar-view" style="display: none; height: 100%;"></div>
            
            <div id="radar-view" style="display: none; flex-direction: column; height: 100%; position: relative;">
                <div id="radar-filter-bar" class="members-selection-pills" style="flex-shrink: 0; display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 16px; max-height: none; background: transparent; padding: 0;">
                    </div>
                
                <div id="radar-chart-container" style="flex-grow: 1; display: flex; justify-content: center; align-items: center; overflow: hidden; position: relative;">
                    </div>
            </div>

           <div id="my-day-empty-state" style="display: none;">
                <div class="ai-empty-state-wrapper">
                    <img src="TeamFlowAI.png" alt="TeamFlow AI Asystent" class="ai-character-img">
                    
                    <div class="ai-speech-bubble">
                        <h2>Cze! Nie masz zada zaplowanych na dzisiaj. </h2>
                        <p>
                            Pamitaj, 偶e zawsze mo偶esz:<br>
                            <strong>1.</strong> Zaplanowa nowe zadania na p贸藕niej.
                            <br>
                            <strong>2.</strong> Przejrze Dashboard i zaj si zalegociami.
                        </p>
                        <div style="margin-top: 15px; display: flex; flex-direction: column; gap: 10px; border-top: 1px solid var(--border-color); padding-top: 15px;">
                            <button class="btn btn-primary js-fab-new-task-trigger" style="padding: 8px 14px; width: 100%; text-align: center;"> Zaplanuj Nowe Zadanie</button>
                            <a href="#" data-view="my-dashboard" class="btn btn-secondary js-navigate-to-dashboard" style="padding: 8px 14px; width: 100%; text-align: center;"> Przejd藕 do Dashboardu</a>
                        </div>
                    </div>
                </div>
            </div>
            <div id="mobile-calendar-wrapper" style="display: none; flex-direction: column; height: 100%;">
    <div id="mobile-calendar-header">
        <button id="mobile-calendar-prev-btn">&lt;</button>
        <h3 id="mobile-calendar-month-year"></h3>
        <button id="mobile-calendar-next-btn">&gt;</button>
    </div>
    <div id="mobile-calendar-weekdays">
        <span>Pon</span>
        <span>Wt</span>
        <span>r</span>
        <span>Czw</span>
        <span>Pt</span>
        <span>Sob</span>
        <span>Ndz</span>
    </div>
    <div id="mobile-calendar-grid"></div>
    <div id="mobile-calendar-task-list-container">
        <h4 id="mobile-calendar-selected-day-header">Zadania</h4>
        <ul id="mobile-calendar-task-list">
            </ul>
    </div>
</div>
            <button id="fab-menu-toggle" class="fab-add-task">+</button>
            
            <div id="fab-menu" class="fab-menu-container hidden">
                <div class="fab-menu-item" id="fab-action-new-poll">
                    <span class="fab-menu-label">Nowy sonda偶</span>
                    <button class="fab-add-task fab-menu-btn" style="background-color: #16a34a;" title="Dodaj nowy sonda偶">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" style="width: 28px; height: 28px;">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                    </button>
                </div>
                <div class="fab-menu-item" id="fab-action-new-task">
                    <span class="fab-menu-label">Nowe zadanie</span>
                    <button class="fab-add-task fab-menu-btn" style="background-color: var(--accent-primary);" title="Dodaj nowe zadanie">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" style="width: 28px; height: 28px;">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
                        </svg>
                    </button>
                </div>
            </div>

            <button id="fab-add-special-task" class="fab-add-task fab-add-task-special">+</button>
        </main>
    <aside class="ai-chat-sidebar" id="ai-chat-sidebar">
                <div class="ai-chat-sidebar-content">
                    <div class="modal-header">
                        <img src="TeamFlowAI.png" alt="AI Icon" style="width: 48px; height: 48px; margin-right: 8px; border-radius: 4px;">
                        <h2>TeamFlow AI</h2>
                        
                        <button type="button" id="ai-settings-btn" class="header-btn" title="Ustawienia Asystenta AI" style="display: none; margin-left: auto; margin-right: 4px; padding: 4px;">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 20px; height: 20px;">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.324.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 011.37.49l1.296 2.247a1.125 1.125 0 01-.26 1.431l-1.003.827c-.293.24-.438.613-.438.995s.145.755.438.995l1.003.827c.48.398.668 1.04.26 1.431l-1.296 2.247a1.125 1.125 0 01-1.37.49l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.57 6.57 0 01-.22.128c-.331.183-.581.495-.644.869l-.213 1.28c-.09.543-.56.941-1.11.941h-2.594c-.55 0-1.02-.398-1.11-.94l-.213-1.281c-.063-.374-.313-.686-.645-.87a6.52 6.52 0 01-.22-.127c-.324-.196-.72-.257-1.075-.124l-1.217.456a1.125 1.125 0 01-1.37-.49l-1.296-2.247a1.125 1.125 0 01.26-1.431l1.004-.827c.292-.24.437-.613.437-.995s-.145-.755-.437-.995l-1.004-.827a1.125 1.125 0 01-.26-1.431l1.296-2.247a1.125 1.125 0 011.37.49l1.217.456c.355.133.75.072 1.076.124.072-.044.146-.087.22-.128.332-.183.582-.495.644-.869l.213-1.28z" />
                                <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                            </svg>
                        </button>
                        
                        <button type="button" class="modal-close-btn" id="ai-chat-close-btn">&times;</button>
                    </div>
                    
                    <div class="form-modal-content" id="ai-chat-container">
                        <div class="ai-chat-message bot">
                            <div class="ai-chat-bubble">
                                Cze! Jestem Twoim asystentem. Jak mog Ci pom贸c w obsudze aplikacji TeamFlow?
                            </div>
                        </div>
                    </div>
                    <div id="ai-chat-status-bar" style="display: none; padding: 8px 24px 0 24px; font-size: 13px; font-weight: 500; text-align: center; color: var(--text-secondary);">
                        Status: Oczekuj
                    </div>
                   <form id="ai-help-form" class="modal-footer" id="ai-chat-footer">
                        <input type="text" id="ai-chat-input" placeholder="Wpisz swoje pytanie...">
                        
                        <button type="button" class="btn btn-secondary" id="ai-chat-mic-btn" title="Rozpocznij rozmow gosow" style="display: none; padding: 10px;">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20" height="20" role="img" aria-labelledby="micTitle" fill="currentColor">
                             <title id="micTitle">Microphone</title>
                             <path d="M12 14a3 3 0 0 0 3-3V6a3 3 0 0 0-6 0v5a3 3 0 0 0 3 3z"/>
                             <path d="M19 11a1 1 0 0 0-2 0 5 5 0 0 1-10 0 1 1 0 0 0-2 0 5 5 0 0 0 4 4.9V18a1 1 0 0 0 1 1h4a1 1 0 0 0 1-1v-2.1A5 5 0 0 0 19 11z" opacity="0.4"/>
                             <rect x="10" y="17" width="4" height="1" rx="0.5"/>
                            </svg>
                        </button>
                        <button type="submit" class="btn btn-primary" id="ai-chat-send-btn" title="Wylij">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 20px; height: 20px;">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M6 12 3.269 3.125A59.769 59.769 0 0 1 21.485 12 59.768 59.768 0 0 1 3.27 20.875L6 12Zm0 0h7.5" />
                            </svg>
                        </button>
                    </form>
                </div>
            </aside>
    <div class="modal-overlay" id="task-modal">
        <div class="modal">
            <div class="task-modal-content">
               <div class="task-modal-main">
                <div class="task-modal-title">
    <h3 id="modal-task-title"></h3>
    <input type="text" id="modal-task-title-input" class="form-group" style="font-size: 22px; font-weight: 600; flex-grow: 1; display: none;">
</div>
                
                <p id="modal-task-dependency-link" style="font-size: 13px; color: var(--text-secondary); margin-top: -12px; margin-bottom: 12px; margin-left: 48px; display: none;"></p>
                
                <p id="modal-task-creator-info" style="font-size: 12px; color: var(--text-secondary); margin-top: -8px; margin-bottom: 16px; margin-left: 30px; min-height: 16px;"></p>
                
                <div class="subtasks-section">
                    <div class="subtasks-header" id="subtasks-toggle-btn" title="Poka偶/Ukryj podzadania">
                            <h4>Podzadania <span id="subtasks-counter"></span></h4>
                            
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <button id="subtasks-sort-btn" class="sort-btn" title="Sortuj wg daty" style="padding: 2px 6px; height: 24px; background-color: var(--bg-primary);">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 14px; height: 14px;">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M3 7.5L7.5 3m0 0L12 7.5M7.5 3v13.5m13.5 0L16.5 21m0 0L12 16.5m4.5 4.5V7.5" />
                                    </svg>
                                </button>

                                <div class="subtasks-toggle-controls">
                                    <span class="toggle-text">Zwi</span>
                                    <svg class="chevron" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 15.75l7.5-7.5 7.5 7.5" />
                                    </svg>
                                </div>
                            </div>
                        </div>
                        <div class="subtasks-collapsible-area" id="subtasks-collapsible-area">
                            <button id="add-subtask-btn-main" class="btn btn-secondary">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg>
                                Dodaj podzadanie
                            </button>
                            <ul id="subtasks-list-main" class="subtasks-list-main">
                                </ul>
                        </div>
                        </div>
                    </div>

                <div class="task-modal-interactive-area">
                    <div class="task-modal-tabs">
                        <div class="task-modal-tabs-wrapper"> 
                            <button class="task-modal-tab" data-tab="description" title="Opis">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25H12" /></svg>
                                <span>Opis</span>
                            </button>
                            <button class="task-modal-tab" data-tab="dueDate" title="Terminy">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75m-18 0h18" /></svg>
                                <span>Terminy</span>
                            </button>
                            <button class="task-modal-tab" id="task-tab-effort" data-tab="effort" title="Wysiek (Estymacja)" style="display: none;">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64" width="24" height="24" role="img" aria-label="Zegar">
                                  <circle cx="32" cy="32" r="22" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
                                  <path d="M32 20 L32 34 L42 38" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
                                  <g stroke="currentColor" stroke-width="1.6" stroke-linecap="round">
                                    <line x1="32" y1="8"  x2="32" y2="12"/>
                                    <line x1="32" y1="52" x2="32" y2="56"/>
                                    <line x1="8"  y1="32" x2="12" y2="32"/>
                                    <line x1="52" y1="32" x2="56" y2="32"/>
                                  </g>
                                </svg>
                                <span>Wysiek</span>
                            </button>
                           <button class="task-modal-tab" id="task-tab-taskBudget" data-tab="taskBudget" title="Koszty Zadania" style="display: none;">
                                     <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64" width="32" height="32" role="img">
                                        <style>
                                            /* Dostosowanie kolor贸w dynamicznych */
                                            .bg-main { fill: var(--bg-tertiary); stroke: currentColor; }
                                            .bg-accent { fill: var(--icon-accent-light); stroke: currentColor; }
                                            .stroke { fill: none; stroke: currentColor; stroke-width: 2; }
                                            .text-fill { fill: currentColor; }
                                            /* Styl dla trybu ciemnego */
                                            .dark-mode .bg-main { fill: #374151; }
                                        </style>
                                        <rect x="10" y="20" width="44" height="28" rx="3" ry="3" class="bg-main" stroke-width="2"/>
                                        <rect x="14" y="24" width="44" height="28" rx="3" ry="3" class="bg-accent" stroke-width="2"/>
                                        <circle cx="36" cy="38" r="12" class="stroke" stroke-width="2"/>
                                        <text x="36" y="38" text-anchor="middle" dominant-baseline="central"
                                                font-family="Segoe UI, Arial, sans-serif" font-size="22" font-weight="700" class="text-fill">$</text>
                                    </svg>
                                    <span>Koszty Zadania</span>
                                </button>
                            <button class="task-modal-tab" data-tab="attachments" title="Zaczniki">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M18.375 12.739l-7.693 7.693a4.5 4.5 0 01-6.364-6.364l10.94-10.94A3 3 0 1119.5 7.372L8.552 18.32m.009-.01l-.01.01m5.699-9.4l-7.693 7.693a2.25 2.25 0 003.182 3.182l7.693-7.693a.75.75 0 011.06 1.06l-7.693 7.693a4.5 4.5 0 01-6.364-6.364l10.94-10.94A3 3 0 1119.5 7.372L8.552 18.32" /></svg>
                                <span>Zaczniki</span>
                            </button>
                            <button class="task-modal-tab" data-tab="comments" title="Komentarze">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12.76c0 1.6 1.123 2.994 2.707 3.227 1.087.16 2.185.283 3.293.369V21l4.076-4.076a1.526 1.526 0 011.037-.443 48.282 48.282 0 005.68-.494c1.584-.233 2.707-1.626 2.707-3.228V6.741c0-1.602-1.123-2.995-2.707-3.228A48.394 48.394 0 0012 3c-2.392 0-4.744.175-7.043.513C3.373 3.746 2.25 5.14 2.25 6.741v6.018z" /></svg>
                                    <span>Komentarze</span>
                                </button>
                                <button class="task-modal-tab" data-tab="assignees" title="Osoby">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z" /></svg>
                                    <span>Osoby</span>
                                </button>
                                <button class="task-modal-tab" data-tab="status" title="Status">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9.568 3H5.25A2.25 2.25 0 003 5.25v4.318c0 .597.237 1.17.659 1.591l9.581 9.581c.699.699 1.78.872 2.607.33a18.095 18.095 0 005.223-5.223c.542-.827.369-1.908-.33-2.607L11.16 3.66A2.25 2.25 0 009.568 3z" /><path stroke-linecap="round" stroke-linejoin="round" d="M6 6h.008v.008H6V6z" /></svg>
                                    <span>Status</span>
                                </button>
                                <button class="task-modal-tab" data-tab="priority" title="Priorytet">
                                   <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" /></svg>
                                   <span>Priorytet</span>
                                </button>
                                <button class="task-modal-tab" data-tab="recurrence" title="Cykliczno">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M23 4v6h-6M1 20v-6h6 M3.51 9a9 9 0 0 1 14.85-3.14L23 10M1 14l4.64 4.14A9 9 0 0 0 20.49 15" /></svg>
                                    <span>Cykliczno</span>
                                </button>
                                <button class="task-modal-tab" data-tab="actions" title="Akcje">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.324.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 011.37.49l1.296 2.247a1.125 1.125 0 01-.26 1.431l-1.003.827c-.293.24-.438.613-.438.995s.145.755.438.995l1.003.827c.48.398.668 1.04.26 1.431l-1.296 2.247a1.125 1.125 0 01-1.37.49l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.57 6.57 0 01-.22.128c-.331.183-.581.495-.644.869l-.213 1.28c-.09.543-.56.941-1.11.941h-2.594c-.55 0-1.02-.398-1.11-.94l-.213-1.281c-.063-.374-.313-.686-.645-.87a6.52 6.52 0 01-.22-.127c-.324-.196-.72-.257-1.075-.124l-1.217.456a1.125 1.125 0 01-1.37-.49l-1.296-2.247a1.125 1.125 0 01.26-1.431l1.004-.827c.292-.24.437-.613.437-.995s-.145-.755-.437-.995l-1.004-.827a1.125 1.125 0 01-.26-1.431l1.296-2.247a1.125 1.125 0 011.37.49l1.217.456c.355.133.75.072 1.076.124.072-.044.146-.087.22-.128.332-.183.582-.495.644-.869l.213-1.28z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                                    <span>Akcje</span>
                                </button>
                                <button class="task-modal-tab" data-tab="activity" title="Historia">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18a8.967 8.967 0 00-6 2.292m0-14.25v14.25" /></svg>
                                    <span>Historia</span>
                                </button>
                        </div>
                        
                        <div class="task-visual-actions">
                            <button type="button" id="open-cover-gallery-btn">Wybierz banner</button>
                            <button type="button" id="open-background-color-btn" class="btn btn-secondary" style="font-size: 12px; padding: 6px 10px;">To kafelka</button>
                        </div>
</div>
                    <div class="task-modal-tabs-content">
                        <div id="tab-content-description" class="task-modal-tab-content">
                            <textarea id="modal-task-description" placeholder="Edytuj, aby doda opis."></textarea>
                        </div>
                        <div id="tab-content-dueDate" class="task-modal-tab-content">
                            <label>Data rozpoczcia</label>
                            <div style="display: flex; gap: 8px; margin-bottom: 16px;">
                                <input type="date" id="modal-task-startDate-date" style="flex: 2;">
                                <select id="modal-task-startDate-hour" style="flex: 1;">
                                    <script>
                                        for (let i = 0; i < 24; i++) {
                                            const hour = String(i).padStart(2, '0');
                                            document.write(`<option value="${hour}">${hour}</option>`);
                                        }
                                    </script>
                                </select>
                                <select id="modal-task-startDate-minute" style="flex: 1;">
                                    
                                    <option value="00">00</option>
                                    <option value="15">15</option>
                                    <option value="30">30</option>
                                    <option value="45">45</option>
                                </select>
                            </div>
                            <label>Termin wykonania</label>
                            <div style="display: flex; gap: 8px;">
                                <input type="date" id="modal-task-dueDate-date" style="flex: 2;">
                                <select id="modal-task-dueDate-hour" style="flex: 1;">
                                    <script>
                                        for (let i = 0; i < 24; i++) {
                                            const hour = String(i).padStart(2, '0');
                                            document.write(`<option value="${hour}">${hour}</option>`);
                                        }
                                    </script>
                                </select>
                                <select id="modal-task-dueDate-minute" style="flex: 1;">
                                    
                                    <option value="00">00</option>
                                    <option value="15">15</option>
                                    <option value="30">30</option>
                                    <option value="45">45</option>
                                </select>
                            </div>
                            </div>
                        <div id="tab-content-taskBudget" class="task-modal-tab-content">
                      <div id="budget-single-mode">
                          <div class="form-group-checkbox">
                              <input type="checkbox" id="modal-task-budget-toggle">
                              <label for="modal-task-budget-toggle">Przypisz koszty do zadania</label>
                          </div>
                          <div id="modal-task-budget-details" style="display: none; margin-top: 12px; background-color: var(--bg-primary); padding: 12px; border-radius: var(--border-radius);">
                              <label>Pozycje kosztowe zadania:</label>
                              <ul id="modal-task-budget-items" style="list-style: none; padding: 0; margin-top: 4px;">
                                  <li class="budget-item-empty" style="font-style: italic; color: var(--text-secondary); font-size: 13px;">Brak pozycji kosztowych.</li>
                              </ul>
                              <button type="button" id="modal-task-add-budget-item-btn" class="btn btn-secondary" style="margin-top: 8px; font-size: 13px; padding: 4px 8px;">+ Dodaj pozycj</button>
                              <div style="margin-top: 16px; border-top: 1px dashed var(--border-color); padding-top: 12px; text-align: right; font-size: 14px;">
                                  Cakowity koszt zadania: <strong id="modal-task-budget-total">0.00</strong> <span id="modal-task-budget-currency"></span>
                              </div>
                              <p id="modal-task-budget-error" class="error-message" style="margin-top: 8px; text-align: left;"></p>
                          </div>
                      </div>

                      <div id="budget-summary-mode" style="display: none;">
                          <p style="font-size: 13px; color: var(--text-secondary); margin-bottom: 12px;">
                              Bud偶et tego zadania jest sum koszt贸w jego podzada.
                          </p>
                          <div id="subtask-budget-list-container" style="background-color: var(--bg-primary); border-radius: var(--border-radius); padding: 12px;">
                              </div>
                           <div style="margin-top: 16px; border-top: 1px solid var(--border-color); padding-top: 12px; text-align: right; font-size: 15px;">
                                  Razem z podzada: <strong id="modal-task-budget-summary-total">0.00</strong> <span id="modal-task-budget-summary-currency"></span>
                          </div>
                      </div>
                  </div>

                  <div id="tab-content-effort" class="task-modal-tab-content">
                        <div id="effort-single-mode">
                            <div class="form-group">
                                <label id="modal-task-effort-label" for="modal-task-effort-input">Szacowany wysiek</label>
                                <input type="number" id="modal-task-effort-input" min="0" step="1" placeholder="0">
                                <p id="modal-task-effort-unit" style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;"></p>
                            </div>
                            
                            <div class="form-group" style="margin-top: 20px; border-top: 1px dashed var(--border-color); padding-top: 16px;">
                                <label id="modal-task-actual-effort-label" for="modal-task-actual-effort-input">Rzeczywisty wysiek</label>
                                <input type="number" id="modal-task-actual-effort-input" min="0" step="1" placeholder="0">
                                <p id="modal-task-actual-effort-unit" style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;"></p>
                            </div>
                        </div>

                        <div id="effort-summary-mode" style="display: none;">
                             <p style="font-size: 13px; color: var(--text-secondary); margin-bottom: 12px;">
                                Wysiek jest sumowany z podzada. Edytuj podzadania, aby zmieni wartoci.
                            </p>
                            <div class="summary-table-header" style="display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 8px; padding: 8px; font-size: 12px; font-weight: 600; color: var(--text-secondary); border-bottom: 1px solid var(--border-color);">
                                <span>Podzadanie</span>
                                <span style="text-align: center;">Szacowany</span>
                                <span style="text-align: center;">Rzeczywisty</span>
                            </div>
                            <div id="subtask-effort-list-container" style="max-height: 300px; overflow-y: auto;">
                                </div>
                             <div style="display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 8px; padding: 12px 8px; margin-top: 8px; border-top: 2px solid var(--border-color); font-weight: 700; font-size: 14px;">
                                <span>RAZEM:</span>
                                <span id="effort-summary-total-est" style="text-align: center;">0</span>
                                <span id="effort-summary-total-act" style="text-align: center;">0</span>
                            </div>
                        </div>
                    </div>
                        <div id="tab-content-budget" class="task-modal-tab-content">
                      <p style="font-size: 14px; color: var(--text-secondary);">Miejsce na dane bud偶etowe (Kwota, Waluta) - na razie puste.</p>
                  </div>

                  <div id="tab-content-attachments" class="task-modal-tab-content">
                            <div class="task-modal-section attachments">
                                <ul class="attachments-list" id="attachments-list"></ul>
                                <div class="attachment-actions">
                                    <input type="file" id="attachment-file-input" style="display: none;">
                                    <button type="button" id="add-attachment-btn" class="btn btn-secondary">Dodaj zacznik</button>
                                    <span id="upload-status" style="margin-left: 10px; font-size: 12px; color: var(--text-secondary);"></span>
                                </div>
                            </div>
                        </div>
    
                        <div id="tab-content-comments" class="task-modal-tab-content">
                             <div class="task-modal-section comments">
                                <div class="comment-input-area">
                                    <textarea id="new-comment-text" placeholder="Napisz komentarz..." rows="1"></textarea>
                                    <button class="btn btn-primary" id="add-comment-btn">Dodaj</button>
                                </div>
                                <ul class="comments-list" id="comments-list"></ul>
                            </div>
                        </div>
                        
                        <div id="tab-content-assignees" class="task-modal-tab-content">
                            <div class="form-group">
                                <label>Wyszukaj i przypisz</label>
                                <div class="member-search-container" style="margin-bottom: 8px;">
                                    <input type="text" id="modal-task-member-search" class="member-search-input" placeholder="Wpisz nazw lub e-mail...">
                                    <ul id="modal-task-member-search-results" class="member-search-results"></ul>
                                </div>
                            </div>
                            
                            <div class="members-dual-view">
                                <div class="members-column">
                                    <div class="members-column-header">Dostpni Pracownicy</div>
                                    <div id="modal-task-assignees-accordion" class="members-scroll-area members-selection-pills" style="background: transparent; padding: 8px; border: none;"></div>
                                </div>

                                <div class="members-column">
                                    <div class="members-column-header">Wybrani Wykonawcy</div>
                                    <div id="modal-task-selected-list" class="members-scroll-area">
                                        <p style="color: var(--text-secondary); font-size: 13px; text-align: center; margin-top: 20px;">Brak wybranych os贸b.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div id="tab-content-status" class="task-modal-tab-content">
                            <label for="modal-task-status">Status Zadania</label>
                            <select id="modal-task-status"></select>
                            
                            <div id="modal-multi-task-status-container" style="display: none; margin-top: 16px; padding: 12px; background-color: var(--bg-tertiary); border-radius: var(--border-radius); border: 1px solid var(--border-color);">
                                <h4 style="font-size: 13px; margin-bottom: 8px; color: var(--text-secondary);">Twoja cz zadania (Tryb Wieloosobowy)</h4>
                                <div id="modal-multi-task-action-area"></div>
                                <p style="font-size: 11px; color: var(--text-secondary); margin-top: 8px;">
                                    Zadanie g贸wne zostanie oznaczone jako "Wykonane" automatycznie, gdy wszyscy uczestnicy ukocz swoje czci.
                                </p>
                            </div>
                            </div>
    
                        <div id="tab-content-priority" class="task-modal-tab-content">
                            <label for="modal-task-priority">Priorytet</label>
                            <select id="modal-task-priority">
                                <option value="low">Niski</option>
                                <option value="medium">redni</option>
                                <option value="high">Wysoki</option>
                            </select>
                            
                            <div style="margin-top: 20px; padding-top: 16px; border-top: 1px dashed var(--border-color);">
                                <div class="form-group-checkbox">
                                    <input type="checkbox" id="modal-task-warning-override">
                                    <label for="modal-task-warning-override">Indywidualne ostrze偶enie o terminie</label>
                                </div>
                                <div id="modal-task-warning-wrapper" style="display: none; margin-top: 8px; padding-left: 28px;">
                                    <label style="font-size: 12px; color: var(--text-secondary); display:block; margin-bottom:4px;">Ile dni przed terminem?</label>
                                    <input type="number" id="modal-task-warning-days" min="1" max="60" value="3" placeholder="np. 1" style="width: 80px;">
                                </div>
                            </div>
                        </div>
    
                        <div id="tab-content-recurrence" class="task-modal-tab-content">
                            <div class="form-group-checkbox">
                                <input type="checkbox" id="modal-task-is-recurring">
                                <label for="modal-task-is-recurring">Zadanie cykliczne</label>
                            </div>
                            <div id="modal-task-recurrence-options" style="display: none;">
                                 <div class="recurrence-options">
                                    <label for="modal-task-recurrence-type">Powtarzaj</label>
                                    <select id="modal-task-recurrence-type">
                                        <option value="daily">Codziennie</option>  <option value="weekly">Co tydzie</option>
                                        <option value="biweekly">Co 2 tygodnie</option>
                                        <option value="monthly">Co miesic</option>
                                        <option value="dayOfMonth">Wybrany dzie miesica</option>
                                        <option value="nthDayOfMonth">Co N-ty dzie miesica</option> 
                                    </select>
                                    <div id="modal-task-recurrence-day-wrapper" style="display: none;">
                                        <label for="modal-task-recurrence-day">Dzie</label>
                                        <input type="number" id="modal-task-recurrence-day" min="1" max="31">
                                    </div>
                                    <div id="modal-task-nth-day-options" style="display: none; flex-gap: 8px;">
                                        <select id="modal-task-recurrence-nth">
                                            <option value="1">Pierwszy</option><option value="2">Drugi</option><option value="3">Trzeci</option><option value="4">Czwarty</option><option value="-1">Ostatni</option>
                                        </select>
                                        <select id="modal-task-recurrence-weekday">
                                            <option value="0">Poniedziaek</option><option value="1">Wtorek</option><option value="2">roda</option><option value="3">Czwartek</option><option value="4">Pitek</option><option value="5">Sobota</option><option value="6">Niedziela</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div id="tab-content-actions" class="task-modal-tab-content">
                             <label>Akcje zadania</label>
                             <button type="button" id="move-task-btn" class="btn btn-secondary" style="width: 100%;">Przenie do innego projektu</button>
                        </div>
    
                        <div id="tab-content-activity" class="task-modal-tab-content">
                            <div class="task-modal-section activity-log">
                                <ul class="activity-list" id="activity-list"></ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
             <div class="modal-footer">
    <span id="modal-task-edit-indicator" style="margin-right: auto; font-size: 12px; color: var(--text-secondary); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; display: none; padding: 10px 0;">Mo偶liwa edycja</span>
    
    <button type="button" id="delete-task-btn" class="btn btn-danger" style="margin-right: 8px;">Usu zadanie</button>
    <button type="button" id="edit-task-btn" class="btn btn-secondary" style="margin-right: auto; display: none !important;">Edytuj</button>
    
    <button type="button" id="finish-task-btn" class="btn btn-success" style="display: none; margin-right: 8px;"> Zakocz zadanie</button>
    <button type="button" class="btn btn-secondary modal-close-btn">Anuluj</button>
    <button type="button" id="ok-task-btn" class="btn btn-primary modal-close-btn" style="display: none;">OK</button>
    <button type="button" id="save-task-btn" class="btn btn-primary" style="display: none;">Zapisz zmiany</button>
</div>
        </div>
    </div>
    
    <div class="modal-overlay" id="new-project-modal">
        <div class="modal">
            <form id="new-project-form">
                <div class="modal-header">
                    <h2>Stw贸rz nowy projekt</h2>
                    <button type="button" class="modal-close-btn">&times;</button>
                </div>
                <div class="form-modal-content">
                    <div class="form-group">
                        <label for="new-project-name">Nazwa projektu</label>
                        <input type="text" id="new-project-name" required placeholder="np. Nowa kampania marketingowa">
                    </div>
                    <div class="form-group">
                        <label for="new-project-description">Cel i opis projektu</label>
                        <textarea id="new-project-description" rows="4" placeholder="Wpisz tutaj g贸wny cel lub opis projektu..."></textarea>
                    </div>
                    <div class="form-group" style="display: flex; gap: 16px;">
                        <div style="flex: 1;">
                            <label for="new-project-startDate">Data rozpoczcia</label>
                            <input type="date" id="new-project-startDate" required>
                        </div>
                        <div style="flex: 1;">
                            <label for="new-project-endDate">Data zakoczenia</label>
                            <input type="date" id="new-project-endDate">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="new-project-priority">Priorytet Projektu</label>
                        <select id="new-project-priority">
                            <option value="low">Niski</option>
                            <option value="medium" selected>redni</option>
                            <option value="high">Wysoki</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="new-project-estimation-type">Metoda Szacowania Wysiku</label>
                        <select id="new-project-estimation-type">
                            <option value="none" selected>Brak (Domylnie)</option>
                            <option value="points">Punkty (Story Points)</option>
                            <option value="hours">Godziny (Szacowany czas)</option>
                        </select>
                    </div>
                    <div class="form-group budget-section" style="border-top: 1px solid var(--border-color); padding-top: 16px; margin-top: 16px;">
                        <div class="form-group-checkbox">
                            <input type="checkbox" id="new-project-budget-toggle">
                            <label for="new-project-budget-toggle">Okrel bud偶et projektu</label>
                        </div>

                        <div id="new-project-budget-details" style="display: none; margin-top: 12px; background-color: var(--bg-primary); padding: 12px; border-radius: var(--border-radius);">
                            <div style="display: flex; gap: 16px; margin-bottom: 12px;">
                                <div class="form-group" style="flex: 2; margin-bottom: 0;">
                                    <label for="new-project-budget-amount">Cakowity bud偶et</label>
                                    <input type="number" id="new-project-budget-amount" placeholder="np. 100000" step="0.01">
                                </div>
                                <div class="form-group" style="flex: 1; margin-bottom: 0;">
                                    <label for="new-project-budget-currency">Waluta</label>
                                    <input type="text" id="new-project-budget-currency" placeholder="np. PLN" value="PLN">
                                    </div>
                            </div>

                            <div class="form-group">
                                <label>Pozycje bud偶etowe</label>
                                <ul id="new-project-budget-items" style="list-style: none; padding: 0; margin-top: 4px;">
                                    <li class="budget-item-empty" style="font-style: italic; color: var(--text-secondary); font-size: 13px;">Brak pozycji bud偶etowych.</li>
                                </ul>
                                <button type="button" id="new-project-add-budget-item-btn" class="btn btn-secondary" style="margin-top: 8px; font-size: 13px; padding: 4px 8px;">+ Dodaj pozycj</button>
                            </div>

                            <div style="margin-top: 16px; border-top: 1px dashed var(--border-color); padding-top: 12px; display: flex; align-items: center; justify-content: flex-end;">
                                <div id="new-project-budget-summary" style="font-size: 13px; text-align: right;">
                                    Suma pozycji: <strong id="new-project-budget-items-sum">0</strong><br>
                                    R贸偶nica: <strong id="new-project-budget-difference">0</strong>
                                </div>
                            </div>
                             <p id="new-project-budget-save-error" class="error-message" style="margin-top: 8px; text-align: left;"></p>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Zesp贸 Projektowy</label>
                        <div class="member-search-container" style="margin-bottom: 8px;">
                            <input type="text" id="new-project-member-search" class="member-search-input" placeholder="Wpisz nazw lub e-mail u偶ytkownika...">
                            <ul id="new-project-member-search-results" class="member-search-results"></ul>
                        </div>

                        <div class="members-dual-view">
                            <div class="members-column">
                                <div class="members-column-header">Dostpni Pracownicy</div>
                                <div id="new-project-members" class="members-scroll-area members-selection-pills" style="background: transparent; padding: 8px; border: none;"></div>
                            </div>

                            <div class="members-column">
                                <div class="members-column-header">Wybrani Uczestnicy</div>
                                <div id="new-project-selected-list" class="members-scroll-area">
                                    <p style="color: var(--text-secondary); font-size: 13px; text-align: center; margin-top: 20px;">Brak wybranych os贸b.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary modal-close-btn">Anuluj</button>
                    <button type="submit" class="btn btn-primary">Stw贸rz projekt</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal-overlay" id="edit-project-modal">
        <div class="modal">
            <form id="edit-project-form">
                <div class="modal-header">
                    <h2>Edytuj projekt</h2>
                    <button type="button" class="modal-close-btn">&times;</button>
                </div>
                <div class="form-modal-content">
                    <div class="form-group">
                        <label for="edit-project-name">Nazwa projektu</label>
                        <input type="text" id="edit-project-name" required>
                    </div>
                    <div class="form-group">
                        <label for="edit-project-description">Cel i opis projektu</label>
                        <textarea id="edit-project-description" rows="4" placeholder="Wpisz tutaj g贸wny cel lub opis projektu..."></textarea>
                    </div>
                    <div class="form-group" style="display: flex; gap: 16px;">
                        <div style="flex: 1;">
                            <label for="edit-project-startDate">Data rozpoczcia</label>
                            <input type="date" id="edit-project-startDate" required>
                        </div>
                        <div style="flex: 1;">
                            <label for="edit-project-endDate">Data zakoczenia</label>
                            <input type="date" id="edit-project-endDate">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="edit-project-priority">Priorytet Projektu</label>
                        <select id="edit-project-priority">
                            <option value="low">Niski</option>
                            <option value="medium" selected>redni</option>
                            <option value="high">Wysoki</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="edit-project-estimation-type">Metoda Szacowania Wysiku</label>
                        <select id="edit-project-estimation-type">
                            <option value="none" selected>Brak (Domylnie)</option>
                            <option value="points">Punkty (Story Points)</option>
                            <option value="hours">Godziny (Szacowany czas)</option>
                        </select>
                    </div>
                    <div class="form-group budget-section" style="border-top: 1px solid var(--border-color); padding-top: 16px; margin-top: 16px;">
                        <div class="form-group-checkbox">
                            <input type="checkbox" id="edit-project-budget-toggle">
                            <label for="edit-project-budget-toggle">Okrel bud偶et projektu</label>
                        </div>

                        <div id="edit-project-budget-details" style="display: none; margin-top: 12px; background-color: var(--bg-primary); padding: 12px; border-radius: var(--border-radius);">
                            <div style="display: flex; gap: 16px; margin-bottom: 12px;">
                                <div class="form-group" style="flex: 2; margin-bottom: 0;">
                                    <label for="edit-project-budget-amount">Cakowity bud偶et</label>
                                    <input type="number" id="edit-project-budget-amount" placeholder="np. 100000" step="0.01">
                                </div>
                                <div class="form-group" style="flex: 1; margin-bottom: 0;">
                                    <label for="edit-project-budget-currency">Waluta</label>
                                    <input type="text" id="edit-project-budget-currency" placeholder="np. PLN" value="PLN">
                                    </div>
                            </div>

                            <div class="form-group">
                                <label>Pozycje bud偶etowe</label>
                                <ul id="edit-project-budget-items" style="list-style: none; padding: 0; margin-top: 4px;">
                                    <li class="budget-item-empty" style="font-style: italic; color: var(--text-secondary); font-size: 13px;">Brak pozycji bud偶etowych.</li>
                                </ul>
                                <button type="button" id="edit-project-add-budget-item-btn" class="btn btn-secondary" style="margin-top: 8px; font-size: 13px; padding: 4px 8px;">+ Dodaj pozycj</button>
                            </div>

                            <div style="margin-top: 16px; border-top: 1px dashed var(--border-color); padding-top: 12px; display: flex; align-items: center; justify-content: flex-end;">
                                <div id="edit-project-budget-summary" style="font-size: 13px; text-align: right;">
                                    Suma pozycji: <strong id="edit-project-budget-items-sum">0</strong><br>
                                    R贸偶nica: <strong id="edit-project-budget-difference">0</strong>
                                </div>
                            </div>
                             <p id="edit-project-budget-save-error" class="error-message" style="margin-top: 8px; text-align: left;"></p>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Zesp贸 Projektowy</label>
                        <div class="member-search-container" style="margin-bottom: 8px;">
                            <input type="text" id="edit-project-member-search" class="member-search-input" placeholder="Wpisz nazw lub e-mail u偶ytkownika...">
                            <ul id="edit-project-member-search-results" class="member-search-results"></ul>
                        </div>
                        
                        <div class="members-dual-view">
                            <div class="members-column">
                                <div class="members-column-header">Dostpni Pracownicy</div>
                                <div id="edit-project-members" class="members-scroll-area members-selection-pills" style="background: transparent; padding: 8px; border: none;"></div>
                            </div>

                            <div class="members-column">
                                <div class="members-column-header">Wybrani Uczestnicy</div>
                                <div id="edit-project-selected-list" class="members-scroll-area">
                                    <p style="color: var(--text-secondary); font-size: 13px; text-align: center; margin-top: 20px;">Brak wybranych os贸b.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary modal-close-btn">Anuluj</button>
                    <button type="submit" class="btn btn-primary">Zapisz zmiany</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal-overlay" id="new-task-modal">
    <div class="modal">
        <form id="new-task-form">
            <div class="modal-header">
                <h2>Dodaj nowe zadanie</h2>
                <button type="button" class="modal-close-btn">&times;</button>
            </div>

            <div class="task-modal-main">
                <div class="form-group" id="new-task-project-group">
                    <label for="new-task-project">Projekt</label>
                    <select id="new-task-project"></select>
                </div>
                <div class="form-group">
                    <label for="new-task-title">Tytu zadania</label>
                    <input type="text" id="new-task-title" required placeholder="np. Zaprojektowa nowy landing page">
                </div>
            </div>

            <div class="task-modal-interactive-area">
                <div class="task-modal-tabs" id="new-task-tabs">
   <div class="task-modal-tabs-wrapper"> <button type="button" class="task-modal-tab" data-tab="dueDate" title="Terminy">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75m-18 0h18" /></svg>
        <span>Terminy</span>
    </button>
       <button type="button" class="task-modal-tab" id="new-task-tab-effort" data-tab="effort" title="Wysiek (Estymacja)" style="display: none;">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64" width="24" height="24" role="img" aria-label="Zegar">
          <circle cx="32" cy="32" r="22" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M32 20 L32 34 L42 38" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
          <g stroke="currentColor" stroke-width="1.6" stroke-linecap="round">
            <line x1="32" y1="8"  x2="32" y2="12"/>
            <line x1="32" y1="52" x2="32" y2="56"/>
            <line x1="8"  y1="32" x2="12" y2="32"/>
            <line x1="52" y1="32" x2="56" y2="32"/>
          </g>
        </svg>
        <span>Wysiek</span>
    </button>
   <button type="button" class="task-modal-tab" id="new-task-tab-taskBudget" data-tab="taskBudget" title="Koszty Zadania" style="display: none;">
             <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64" width="32" height="32" role="img">
                <style>
                    /* Dostosowanie kolor贸w dynamicznych */
                    .bg-main { fill: var(--bg-tertiary); stroke: currentColor; }
                    .bg-accent { fill: var(--icon-accent-light); stroke: currentColor; }
                    .stroke { fill: none; stroke: currentColor; stroke-width: 2; }
                    .text-fill { fill: currentColor; }
                    /* Styl dla trybu ciemnego */
                    .dark-mode .bg-main { fill: #374151; }
                </style>
                <rect x="10" y="20" width="44" height="28" rx="3" ry="3" class="bg-main" stroke-width="2"/>
                <rect x="14" y="24" width="44" height="28" rx="3" ry="3" class="bg-accent" stroke-width="2"/>
                <circle cx="36" cy="38" r="12" class="stroke" stroke-width="2"/>
                <text x="36" y="38" text-anchor="middle" dominant-baseline="central"
                        font-family="Segoe UI, Arial, sans-serif" font-size="22" font-weight="700" class="text-fill">$</text>
            </svg>
            <span>Koszty Zadania</span>
        </button>
    <button type="button" class="task-modal-tab" data-tab="description" title="Opis">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25H12" /></svg>
        <span>Opis</span>
    </button>
    <button type="button" class="task-modal-tab" data-tab="assignees" title="Osoby">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z" /></svg>
        <span>Osoby</span>
    </button>
    <button type="button" class="task-modal-tab" data-tab="attachments" title="Zaczniki">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M18.375 12.739l-7.693 7.693a4.5 4.5 0 01-6.364-6.364l10.94-10.94A3 3 0 1119.5 7.372L8.552 18.32m.009-.01l-.01.01m5.699-9.94l-7.693 7.693a2.25 2.25 0 003.182 3.182l7.693-7.693a.75.75 0 011.06 1.06l-7.693 7.693a4.5 4.5 0 01-6.364-6.364l10.94-10.94A3 3 0 1119.5 7.372L8.552 18.32" /></svg>
        <span>Zaczniki</span>
    </button>
   <button type="button" class="task-modal-tab" data-tab="priority" title="Priorytet">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" /></svg>
        <span>Priorytet</span>
    </button>
   <button type="button" class="task-modal-tab" data-tab="recurrence" title="Cykliczno">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M23 4v6h-6M1 20v-6h6 M3.51 9a9 9 0 0 1 14.85-3.14L23 10M1 14l4.64 4.14A9 9 0 0 0 20.49 15" /></svg>
        <span>Cykliczno</span>
    </button>
</div>
    <div class="task-visual-actions">
        <button type="button" id="new-task-open-cover-gallery-btn">Wybierz banner</button>
        <button type="button" id="new-task-open-background-color-btn" class="btn btn-secondary" style="font-size: 12px; padding: 6px 10px;">To kafelka</button>
    </div>
</div>
                <div class="task-modal-tabs-content">
                    <div id="tab-new-task-description" class="task-modal-tab-content">
                        <textarea id="new-task-description" placeholder="Dodaj wicej szczeg贸贸w..." rows="6"></textarea>
                    </div>

                    <div id="tab-new-task-assignees" class="task-modal-tab-content">
                        <div class="form-group">
                            <label>Wyszukaj i przypisz</label>
                            <div class="member-search-container" style="margin-bottom: 8px;">
                                <input type="text" id="new-task-member-search" class="member-search-input" placeholder="Wpisz nazw lub e-mail...">
                                <ul id="new-task-member-search-results" class="member-search-results"></ul>
                            </div>
                        </div>
                        
                        <div class="members-dual-view">
                            <div class="members-column">
                                <div class="members-column-header">Dostpni Pracownicy</div>
                                <div id="new-task-assignees-list" class="members-scroll-area members-selection-pills" style="background: transparent; padding: 8px; border: none;"></div>
                            </div>

                            <div class="members-column">
                                <div class="members-column-header">Wybrani Wykonawcy</div>
                                <div id="new-task-selected-list" class="members-scroll-area">
                                    <p style="color: var(--text-secondary); font-size: 13px; text-align: center; margin-top: 20px;">Brak wybranych os贸b.</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="tab-new-task-attachments" class="task-modal-tab-content">
                        <label>Zaczniki</label>
                        <div class="new-task-attachments-container">
                            <input type="file" id="new-task-attachment-input" style="display: none;" multiple>
                            <button type="button" id="add-new-task-attachment-btn" class="btn btn-secondary">Dodaj zacznik</button>
                            <ul id="new-task-attachments-list" class="attachments-list" style="margin-top: 12px;"></ul>
                        </div>
                    </div>
                    
                    <div id="tab-new-task-dueDate" class="task-modal-tab-content">
                        <div class="form-group" style="margin-bottom: 16px;">
                            <label>Data rozpoczcia</label>
                            <div style="display: flex; gap: 8px;">
                                <input type="date" id="new-task-startDate-date" style="flex: 2;">
                                <select id="new-task-startDate-hour" style="flex: 1;">
                                    
                                    <script>
                                        for (let i = 0; i < 24; i++) {
                                            const hour = String(i).padStart(2, '0');
                                            document.write(`<option value="${hour}">${hour}</option>`);
                                        }
                                    </script>
                                </select>
                                <select id="new-task-startDate-minute" style="flex: 1;">
                                    
                                    <option value="00">00</option>
                                    <option value="15">15</option>
                                    <option value="30">30</option>
                                    <option value="45">45</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Termin wykonania</label>
                            <div style="display: flex; gap: 8px;">
                                <input type="date" id="new-task-dueDate-date" style="flex: 2;">
                                <select id="new-task-dueDate-hour" style="flex: 1;">
                                    
                                    <script>
                                        for (let i = 0; i < 24; i++) {
                                            const hour = String(i).padStart(2, '0');
                                            document.write(`<option value="${hour}">${hour}</option>`);
                                        }
                                    </script>
                                </select>
                                <select id="new-task-dueDate-minute" style="flex: 1;">
                                    
                                    <option value="00">00</option>
                                    <option value="15">15</option>
                                    <option value="30">30</option>
                                    <option value="45">45</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div id="tab-new-task-effort" class="task-modal-tab-content">
                        <div class="form-group">
                            <label id="new-task-effort-label" for="new-task-effort-input">Szacowany wysiek</label>
                            <input type="number" id="new-task-effort-input" min="0" step="1" placeholder="0">
                            <p id="new-task-effort-unit" style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;"></p>
                        </div>
                    </div>
                    <div id="tab-new-task-taskBudget" class="task-modal-tab-content">
                  <div class="form-group-checkbox">
                      <input type="checkbox" id="new-task-budget-toggle">
                      <label for="new-task-budget-toggle">Przypisz koszty do zadania</label>
                  </div>
                  <div id="new-task-budget-details" style="display: none; margin-top: 12px; background-color: var(--bg-primary); padding: 12px; border-radius: var(--border-radius);">
                      <label>Pozycje kosztowe zadania:</label>
                      <ul id="new-task-budget-items" style="list-style: none; padding: 0; margin-top: 4px;">
                          <li class="budget-item-empty" style="font-style: italic; color: var(--text-secondary); font-size: 13px;">Brak pozycji kosztowych.</li>
                      </ul>
                      <button type="button" id="new-task-add-budget-item-btn" class="btn btn-secondary" style="margin-top: 8px; font-size: 13px; padding: 4px 8px;">+ Dodaj pozycj</button>
                      <div style="margin-top: 16px; border-top: 1px dashed var(--border-color); padding-top: 12px; text-align: right; font-size: 14px;">
                          Cakowity koszt zadania: <strong id="new-task-budget-total">0.00</strong> <span id="new-task-budget-currency"></span>
                      </div>
                      <p id="new-task-budget-error" class="error-message" style="margin-top: 8px; text-align: left;"></p>
                  </div>
              </div>
                    <div id="tab-new-task-budget" class="task-modal-tab-content">
                  <p style="font-size: 14px; color: var(--text-secondary);">Miejsce na dane bud偶etowe (Kwota, Waluta) - na razie puste.</p>
              </div>

              <div id="tab-new-task-priority" class="task-modal-tab-content">
                        <div class="form-group">
                            <label for="new-task-priority">Priorytet</label>
                            <select id="new-task-priority">
                                <option value="low">Niski</option>
                                <option value="medium" selected>redni</option>
                                <option value="high">Wysoki</option>
                            </select>
                        </div>
                        
                        <div style="margin-top: 20px; padding-top: 16px; border-top: 1px dashed var(--border-color);">
                            <div class="form-group-checkbox">
                                <input type="checkbox" id="new-task-warning-override">
                                <label for="new-task-warning-override">Indywidualne ostrze偶enie o terminie</label>
                            </div>
                            <div id="new-task-warning-wrapper" style="display: none; margin-top: 8px; padding-left: 28px;">
                                <label style="font-size: 12px; color: var(--text-secondary); display:block; margin-bottom:4px;">Ile dni przed terminem?</label>
                                <input type="number" id="new-task-warning-days" min="1" max="60" value="3" placeholder="np. 1" style="width: 80px;">
                            </div>
                        </div>
                    </div>

                    <div id="tab-new-task-recurrence" class="task-modal-tab-content">
                        <div class="form-group">
                            <div class="form-group-checkbox">
                                <input type="checkbox" id="new-task-is-recurring">
                                <label for="new-task-is-recurring">Zadanie cykliczne</label>
                            </div>
                            <div id="new-task-recurrence-options" class="recurrence-options" style="display: none;">
                                <label for="new-task-recurrence-type">Powtarzaj</label>
                                <select id="new-task-recurrence-type">
                                    <option value="daily">Codziennie</option> <option value="weekly">Co tydzie</option>
                                    <option value="biweekly">Co 2 tygodnie</option>
                                    <option value="monthly">Co miesic</option>
                                    <option value="dayOfMonth">Wybrany dzie miesica</option>
                                    <option value="nthDayOfMonth">Co N-ty dzie miesica</option>
                                </select>

                                <div id="new-task-recurrence-day-wrapper" style="display: none;">
                                    <label for="new-task-recurrence-day">Dzie miesica</label>
                                    <input type="number" id="new-task-recurrence-day" min="1" max="31" placeholder="np. 15">
                                </div>

                                <div id="new-task-nth-day-options" style="display: none; display: flex; gap: 8px;">
                                    <select id="new-task-recurrence-nth">
                                        <option value="1">Pierwszy</option>
                                        <option value="2">Drugi</option>
                                        <option value="3">Trzeci</option>
                                        <option value="4">Czwarty</option>
                                        <option value="-1">Ostatni</option>
                                    </select>
                                    <select id="new-task-recurrence-weekday">
                                        <option value="0">Poniedziaek</option>
                                        <option value="1">Wtorek</option>
                                        <option value="2">roda</option>
                                        <option value="3">Czwartek</option>
                                        <option value="4">Pitek</option>
                                        <option value="5">Sobota</option>
                                        <option value="6">Niedziela</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary modal-close-btn">Anuluj</button>
                <button type="submit" class="btn btn-primary">Zapisz zadanie</button>
            </div>
        </form>
    </div>
</div>

    <div class="modal-overlay" id="search-modal">
        <div class="modal">
            <div class="modal-header">
                <h2>Wyszukaj zadania</h2>
                <button type="button" class="modal-close-btn">&times;</button>
            </div>
            <div class="form-modal-content">
                <div class="search-bar" style="margin-bottom: 24px;">
                     <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" />
                    </svg>
                     <input type="text" placeholder="Wpisz szukan fraz..." id="modal-search-input">
                </div>
                <ul id="search-results-list" class="search-results-list">
                    </ul>
            </div>
        </div>
    </div>
    
    <div class="modal-overlay" id="notification-modal">
        <div class="modal">
             <div class="modal-header">
                <h2 id="notification-title">Powiadomienie</h2>
                <button type="button" class="modal-close-btn">&times;</button>
            </div>
            <div class="form-modal-content">
                <p id="notification-message"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary modal-close-btn">OK</button>
            </div>
        </div>
    </div>
    
    <div class="modal-overlay" id="confirmation-modal">
        <div class="modal">
             <div class="modal-header">
                <h2 id="confirmation-title">Potwierdzenie</h2>
                <button type="button" class="modal-close-btn" data-action="cancel">&times;</button>
            </div>
            <div class="form-modal-content">
                <p id="confirmation-message">Czy na pewno chcesz wykona t akcj?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary modal-close-btn" data-action="cancel">Anuluj</button>
                <button type="button" class="btn btn-danger" id="confirmation-action-btn" data-action="confirm">Potwierd藕</button>
            </div>
        </div>
    </div>
<div class="modal-overlay" id="move-task-modal">
    <div class="modal">
        <div class="modal-header">
            <h2>Przenie zadanie do...</h2>
            <button type="button" class="modal-close-btn">&times;</button>
        </div>
        <div class="form-modal-content">
            <p>Wybierz z listy projekt, do kt贸rego chcesz przenie to zadanie.</p>
            <div id="move-task-project-list" class="form-group">
                </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary modal-close-btn">Anuluj</button>
            <button type="button" id="confirm-move-task-btn" class="btn btn-primary">Przenie</button>
        </div>
    </div>
</div>
   <script type="module">
    // ============================
    // 1. IMPORTY
    // ============================
    const { RRule } = rrule;
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, updatePassword, EmailAuthProvider, reauthenticateWithCredential, sendEmailVerification, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, getDocs, setDoc, addDoc, updateDoc, deleteDoc, onSnapshot, collection, query, writeBatch, where, orderBy, arrayRemove, arrayUnion, limit, Timestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"; // <<< DODANO 'Timestamp'
    import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";
    import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-functions.js";
    import { getMessaging, getToken, onMessage } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-messaging.js";

    // ============================
    // 2. KONFIGURACJA FIREBASE (z placeholderami!)
    // ============================
    const firebaseConfig = {
        apiKey: "AIzaSyDUgw_p1cI4corSOm4vypcNQVNGgXWYNLQ",
        authDomain: "wlasciwa-aplikacja.firebaseapp.com",
        projectId: "wlasciwa-aplikacja",
        storageBucket: "wlasciwa-aplikacja.firebasestorage.app",
        messagingSenderId: "180170656322",
        appId: "1:180170656322:web:48fff7a2092ed2a3437bdb"
    };

    // ============================
    // 3. INICJALIZACJA FIREBASE (poza DOMContentLoaded)
    // ============================
    const appId = "default-app-id";
    let db, auth, app, storage, functions; // Deklarujemy zmienne globalnie w skrypcie

    const loadingOverlay = document.getElementById('loading-overlay');
    const authOverlay = document.getElementById('auth-overlay');
    const appContainer = document.querySelector('.app-container');

    try {
        app = initializeApp(firebaseConfig); // Przypisujemy zainicjalizowan aplikacj
        db = getFirestore(app);
        auth = getAuth(app);
        storage = getStorage(app);
        functions = getFunctions(app, "europe-west1");
    } catch (error) {
        console.error("Bd inicjalizacji Firebase:", error);
        authOverlay.innerHTML = `<div class="auth-container"><h2>Bd Konfiguracji</h2><p>${error.message}</p></div>`;
    }

    // Definicje referencji do kolekcji (musz by tutaj, bo u偶ywaj 'db')
        const projectsRef = collection(db, `artifacts/${appId}/public/data/projects`);
        const completedProjectsRef = collection(db, `artifacts/${appId}/public/data/completedProjects`);
        const usersRef = collection(db, `artifacts/${appId}/public/data/users`);
        const groupsRef = collection(db, `artifacts/${appId}/public/data/groups`);
        const templatesRef = collection(db, `artifacts/${appId}/public/data/projectTemplates`);
        const pollsRef = collection(db, `artifacts/${appId}/public/data/polls`); // <-- NOWA LINIA

    // ============================
    // 4. KLASA EDYTORA TEKSTU (Rich Text Editor)
    // ============================
    class SimpleRichTextEditor {
        constructor(textareaId) {
            this.textarea = document.getElementById(textareaId);
            if (!this.textarea) return;

            this.container = document.createElement('div');
            this.container.className = 'rte-container';

            // 1. Tworzenie paska narzdzi
            this.toolbar = document.createElement('div');
            this.toolbar.className = 'rte-toolbar';
            this.createToolbar();

            // 2. Tworzenie obszaru edycji
            this.editor = document.createElement('div');
            this.editor.className = 'rte-editor';
            this.editor.contentEditable = true;
            
            // Przepisz pocztkow warto
            this.editor.innerHTML = this.textarea.value;

            // 3. Synchronizacja (Editor -> Textarea)
            this.editor.addEventListener('input', () => {
                this.textarea.value = this.editor.innerHTML;
                // Wywoaj event 'input' na textarea, aby inni suchacze (np. autosave) wiedzieli o zmianie
                this.textarea.dispatchEvent(new Event('input', { bubbles: true }));
            });

            // 4. Podmiana w DOM
            this.textarea.style.display = 'none';
            this.textarea.parentNode.insertBefore(this.container, this.textarea);
            this.container.appendChild(this.toolbar);
            this.container.appendChild(this.editor);
            this.container.appendChild(this.textarea); // Przenie textarea do kontenera
        }

        createToolbar() {
            // Definicje przycisk贸w (Zaktualizowane ikony)
            const tools = [
                { 
                    cmd: 'bold', 
                    icon: '<path d="M7 4h6a3 3 0 0 1 0 6H7V4zm0 6h7a3 3 0 0 1 0 6H7v-6z" fill="none" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>', 
                    title: 'Pogrubienie' 
                },
                { 
                    cmd: 'italic', 
                    icon: '<path d="M10 4h8M6 20h8M14 4l-4 16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>', 
                    title: 'Kursywa' 
                },
                { 
                    cmd: 'underline', 
                    icon: '<path d="M7 4v7a5 5 0 0 0 10 0V4" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/> <line x1="5" y1="20" x2="19" y2="20" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>', 
                    title: 'Podkrelenie' 
                },
                { separator: true },
                { 
                    cmd: 'insertUnorderedList', 
                    icon: '<rect x="9" y="5" width="12" height="2" rx="1" fill="currentColor"/> <rect x="9" y="11" width="12" height="2" rx="1" fill="currentColor"/> <rect x="9" y="17" width="12" height="2" rx="1" fill="currentColor"/> <circle cx="4" cy="6" r="1.5" fill="currentColor"/> <circle cx="4" cy="12" r="1.5" fill="currentColor"/> <circle cx="4" cy="18" r="1.5" fill="currentColor"/>', 
                    title: 'Lista punktowana' 
                },
                { 
                    cmd: 'insertOrderedList', 
                    icon: '<rect x="8.5" y="5" width="12.5" height="1.6" rx="0.8" fill="currentColor"/> <rect x="8.5" y="11" width="12.5" height="1.6" rx="0.8" fill="currentColor"/> <rect x="8.5" y="17" width="12.5" height="1.6" rx="0.8" fill="currentColor"/> <path d="M4.8 4.5 L3.8 5.3 M4.8 4.5 L4.8 7.5" stroke="currentColor" stroke-width="1.1" stroke-linecap="round"/> <path d="M4.0 10.0 C4.4 9.6 5.2 9.6 5.6 10.0 C6.0 10.4 6.0 11.0 5.6 11.4 L4.0 12.8 H5.8" fill="none" stroke="currentColor" stroke-width="1.1" stroke-linecap="round" stroke-linejoin="round"/> <path d="M4.0 15.5 C4.5 15.0 5.4 15.0 5.9 15.5 C6.3 15.8 6.3 16.4 5.9 16.7 C6.4 17.0 6.4 17.7 5.9 18.1 C5.4 18.6 4.5 18.6 4.0 18.1" fill="none" stroke="currentColor" stroke-width="1.1" stroke-linecap="round" stroke-linejoin="round"/>', 
                    title: 'Lista numerowana' 
                },
                { separator: true },
                { 
                    cmd: 'justifyLeft', 
                    icon: '<rect x="3" y="5" width="14" height="2" rx="1" fill="currentColor"/> <rect x="3" y="10" width="18" height="2" rx="1" fill="currentColor"/> <rect x="3" y="15" width="12" height="2" rx="1" fill="currentColor"/> <rect x="3" y="20" width="16" height="2" rx="1" fill="currentColor"/>', 
                    title: 'Do lewej' 
                },
                { 
                    cmd: 'justifyCenter', 
                    icon: '<rect x="5" y="5" width="14" height="2" rx="1" fill="currentColor"/> <rect x="3" y="10" width="18" height="2" rx="1" fill="currentColor"/> <rect x="7" y="15" width="10" height="2" rx="1" fill="currentColor"/> <rect x="4" y="20" width="16" height="2" rx="1" fill="currentColor"/>', 
                    title: 'Do rodka' 
                },
                { 
                    cmd: 'justifyRight', 
                    icon: '<rect x="7" y="5" width="14" height="2" rx="1" fill="currentColor"/> <rect x="3" y="10" width="18" height="2" rx="1" fill="currentColor"/> <rect x="9" y="15" width="12" height="2" rx="1" fill="currentColor"/> <rect x="5" y="20" width="16" height="2" rx="1" fill="currentColor"/>', 
                    title: 'Do prawej' 
                },
                { separator: true },
                { 
                    custom: 'createTable', 
                    icon: '<path d="M4 4h16a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2zm0 2v5h16V6H4zm0 7v5h16v-5H4z"/>', 
                    title: 'Wstaw tabel' 
                }
            ];

            // Select dla rozmiaru
            const sizeSelect = document.createElement('select');
            sizeSelect.className = 'rte-select';
            ['3', '1', '2', '4', '5', '6', '7'].forEach(size => { // 3 to default
                const opt = document.createElement('option');
                opt.value = size;
                opt.text = size === '3' ? 'Normalny' : (size > 3 ? `Du偶y ${size-2}` : `May ${size}`);
                if(size === '3') opt.selected = true;
                sizeSelect.appendChild(opt);
            });
            sizeSelect.onchange = () => document.execCommand('fontSize', false, sizeSelect.value);
            this.toolbar.appendChild(sizeSelect);
            
            // Select dla czcionki (podstawowy)
            const fontSelect = document.createElement('select');
            fontSelect.className = 'rte-select';
            ['Inter', 'Arial', 'Courier New', 'Georgia', 'Times New Roman'].forEach(font => {
                const opt = document.createElement('option');
                opt.value = font;
                opt.text = font;
                fontSelect.appendChild(opt);
            });
            fontSelect.onchange = () => document.execCommand('fontName', false, fontSelect.value);
            this.toolbar.appendChild(fontSelect);


            tools.forEach(tool => {
                if (tool.separator) {
                    const sep = document.createElement('div');
                    sep.style.width = '1px';
                    sep.style.height = '20px';
                    sep.style.backgroundColor = 'var(--border-color)';
                    sep.style.margin = '0 4px';
                    this.toolbar.appendChild(sep);
                    return;
                }

                const btn = document.createElement('button');
                btn.className = 'rte-btn';
                btn.type = 'button'; // Wa偶ne, 偶eby nie submitowao formularza
                btn.title = tool.title;
                btn.innerHTML = `<svg viewBox="0 0 24 24" style="width:18px; height:18px;">${tool.icon}</svg>`;

                if (tool.custom === 'createTable') {
                    btn.onclick = (e) => {
                        e.preventDefault();
                        const html = `
                            <table border="1" style="width:100%; border-collapse:collapse; margin-top:8px;">
                                <tbody>
                                    <tr><td>Kom贸rka 1</td><td>Kom贸rka 2</td></tr>
                                    <tr><td>Kom贸rka 3</td><td>Kom贸rka 4</td></tr>
                                </tbody>
                            </table><br>`;
                        document.execCommand('insertHTML', false, html);
                    };
                } else {
                    btn.onclick = (e) => {
                        e.preventDefault();
                        document.execCommand(tool.cmd, false, null);
                    };
                }
                this.toolbar.appendChild(btn);
            });
        }
        
        // Metoda do ustawiania treci z zewntrz (np. przy otwieraniu modala)
        setContent(html) {
            this.editor.innerHTML = html;
            this.textarea.value = html;
        }
        
        // Metoda do czyszczenia
        clear() {
            this.editor.innerHTML = '';
            this.textarea.value = '';
        }
    }
    // ============================
    // 4. GWNA LOGIKA APLIKACJI (wszystko wewntrz DOMContentLoaded)
    // ============================
   document.addEventListener('DOMContentLoaded', () => {
        const MAX_FILE_SIZE = 15 * 1024 * 1024; // <-- DODANA LINIA (15 MB w bajtach)
        let sortableDashboard = null;
        let sortableProjects = null;
        let aiChatHistory = [];
        // === NOWE ZMIENNE: ROZMOWA GOSOWA AI ===
        let speechRecognitionInstance = null;
        let speechSynthesisInstance = window.speechSynthesis;
        let speechUtteranceInstance = null;
        let isConversationModeActive = false; // Czy tryb cigej rozmowy jest wczony
        let speechRecognitionTimer = null; // Timer do restartowania nasuchu
        let userInterruptedSpeech = false; // Flaga przerwania mowy AI
        
        /**
         * Sprawdza, czy aplikacja jest uruchomiona wewntrz Median WebView.
         * @returns {boolean} True, jeli wykryto Median.
         */
        function isMedianWebView() {
            return navigator.userAgent.includes("Median");
        }
        // === KONIEC NOWYCH ZMIENNYCH ===
        let stagedFiles = [];
       // === NOWE ZMIENNE STANU DLA GESTU SWIPE ===
        let chatTouchStartX = 0;
        let chatTouchCurrentX = 0;
        let chatTouchStartY = 0; // Do wykrywania scrolla
        let isChatSwiping = false;
        // === KONIEC NOWYCH ZMIENNYCH ===
       // === POCZTEK ZMIANY: Zmienne stanu dla gestu AI ===
        let aiChatTouchStartX = 0;
        let aiChatTouchCurrentX = 0;
        let aiChatTouchStartY = 0;
        let isAiChatSwiping = false;
        // === KONIEC ZMIANY ===
        // === NOWE REFERENCJE DLA PANELU CZATU ===
        const projectChatPanel = document.getElementById('project-chat-panel');
        const toggleChatBtn = document.getElementById('toggle-chat-btn');
        const toggleChatBtnMobile = document.getElementById('toggle-chat-btn-mobile');
        const closeChatPanelBtn = document.getElementById('close-chat-panel-btn');
        const chatMessagesList = document.getElementById('chat-messages-list');
        const chatMessageInput = document.getElementById('chat-message-input');
        const sendChatMessageBtn = document.getElementById('send-chat-message-btn');
        // === KONIEC NOWYCH REFERENCJI ===
        
       // --- NOWA ZMIENNA STANU TYMCZASOWEGO DLA BANNERA ---
        let newTaskTempBannerData = null;
        // --- KONIEC ZMIENNYCH STANU ---


        // --- Definicja stanu i staych ---
        const STATUSES = {
            todo: 'Do realizacji',
            inprogress: 'W trakcie realizacji',
            done: 'Wykonane'
        };
       // === NOWA FUNKCJA POMOCNICZA ===
        /**
         * Zwraca czyteln nazw statusu zadania, uwzgldniajc kolumny niestandardowe.
         */
        function getTaskStatusLabel(task, project) {
            // 1. Jeli status to 'done', zawsze 'Wykonane'
            if (task.status === 'done') return STATUSES.done;
            
            // 2. Jeli status to 'todo', zawsze 'Do realizacji'
            if (task.status === 'todo') return STATUSES.todo;

            // 3. Jeli status to 'inprogress':
            if (task.status === 'inprogress') {
                // Sprawd藕 czy zadanie ma customColumnId
                if (task.customColumnId) {
                    // Znajd藕 nazw tej kolumny w projekcie
                    const customCol = (project.customColumns || []).find(c => c.id === task.customColumnId);
                    if (customCol) {
                        return customCol.title; // Np. "Do akceptacji"
                    }
                }
                // Jeli nie ma customColumnId lub nie znaleziono kolumny, zwr贸 domylne
                return STATUSES.inprogress; 
            }
            
            return 'Nieznany';
        }
        // === KONIEC NOWEJ FUNKCJI ===
       // Definicja palety kolor贸w dla zada
        const TASK_COLORS = [
            { name: "Domylny (Biay)", value: "var(--bg-secondary)", id: "default" },
            { name: "Czerwony", value: "#fee2e2", id: "red" }, // Jasny czerwony
            { name: "Niebieski", value: "#e0f2fe", id: "blue" }, // Jasny niebieski
            { name: "Zielony", value: "#dcfce7", id: "green" }, // Jasny zielony
            { name: "呕贸ty", value: "#fef9c3", id: "yellow" }, // Jasny 偶贸ty
            { name: "Fioletowy", value: "#f3e8ff", id: "purple" }, // Jasny fiolet
            { name: "Pomaraczowy", value: "#ffedd5", id: "orange" }, // Jasny pomaraczowy
            { name: "Szary", value: "#f3f4f6", id: "gray" } // Jasny szary
        ];
        
        // Zmienna stanu tymczasowego dla koloru nowego zadania
        let newTaskTempColor = null;
let state = {
            currentUser: null, // Bdzie teraz zawiera `groupInfo` i `groupIds`
            users: [], // Bd adowani dynamicznie per grupa
            projects: [], // Bd adowane dynamicznie per grupa
            completedProjects: [], // Bd adowane dynamicznie per grupa
            // === NOWE ZMIENNE GLOBALNE ===
            globalUserProjects: [], // Przechowuje WSZYSTKIE aktywne projekty u偶ytkownika (cross-group)
            globalUserCompletedProjects: [], // Przechowuje WSZYSTKIE zakoczone projekty u偶ytkownika (cross-group)
            // === KONIEC NOWYCH ZMIENNYCH ===
            projectTemplates: [], 
            selectedTemplateId: null, 
            polls: [], // Bd adowane dynamicznie per grupa
            currentProjectId: null,
            notifications: [], // Bd adowane dynamicznie per grupa
            ui: {
                theme: 'light',
                currentView: 'my-day', 
                previousView: null, 
                sidebarCollapsed: false,
                collapsedColumns: {},
                // === POCZTEK ZMIANY ===
                // Nowe pola do zarzdzania aktywn grup
                activeGroupId: null, // Np. "GROUP_ID_A"
                activeGroupInfo: null, // Np. { name: "Moja Firma", role: "owner", ... }
                // === KONIEC ZMIANY ===
                
                dashboardEditMode: false, 
                dashboardLayout: ['my-overdue', 'team-delays', 'upcoming', 'workload', 'activity', 'team-workload'], 
                allProjectsEditMode: false, 
                isCalendarView: false,
                sortMyTasksByDate: 'asc',
                projectSortOrders: {},
                currentProjectFilters: { 
                    assigneeIds: [], 
                    priority: '',
                    dueDate: '',
                    budgetStatus: '',
                    showPolls: true 
                },
                // === NOWE ZMIENNE FILTRA UKOCZONYCH ZADA ===
                projectCompletedFilters: {}, // np. { "project_id_1": "7days", "project_id_2": "all" }
                dashboardCompletedFilter: '7days', // '7days', '14days', '30days', 'all'
                // === KONIEC NOWYCH ZMIENNYCH ===
                // === NOWE ZMIENNE STANU DLA ZAZNACZANIA ===
                isSelectModeActive: false,
                selectedTaskIds: [],
                // === KONIEC ===
                // === ZMIANA: Suchacze pozostaj, ale bd dynamicznie zarzdzane ===
                unsubscribeProjects: null,
                unsubscribeCompleted: null,
                unsubscribeUsers: null, 
                unsubscribeNotifications: null, 
                unsubscribePolls: null, 
                unsubscribeChatMessages: null, // <--- NOWA LINIA
                // === NOWE LISTENERY GLOBALNE ===
                unsubscribeGlobalProjects: null,
                unsubscribeGlobalCompletedProjects: null,
                // === KONIEC ZMIANY ===
                
                chartInstance: null,
                mobileCalendarDate: new Date().toISOString(), 
                mobileCalendarSelectedDate: new Date(new Date().getTime() - (new Date().getTimezoneOffset() * 60000)).toISOString().split('T')[0],
                myDayDate: getLocalDateString(),
            radarSelectedProjectIds: [] // NOWE: Stan dla filtr贸w radaru
        }
    };
   
// NOWA, POPRAWIONA FUNKCJA DO POBIERANIA DATY LOKALNEJ
        function getLocalDateString() {
            const date = new Date();
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0'); // Miesice s 0-indeksowane
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // --- Pobieranie referencji do element贸w HTML ---
        const editDashboardLayoutBtn = document.getElementById('edit-dashboard-layout-btn'); // <-- DODANA LINIA
        const editProjectsLayoutBtn = document.getElementById('edit-projects-layout-btn'); // <-- NOWA LINIA
        const backToProjectsBtn = document.getElementById('back-to-projects-btn'); // <-- DODANA LINIA
        const backToProjectsBtnMobile = document.getElementById('back-to-projects-btn-mobile'); // <-- DODANA LINIA
        const settingsBtn = document.getElementById('settings-btn');
    const photoUploadInput = document.getElementById('photo-upload-input');

    // --- Referencje do element贸w modala Szczeg贸贸w Projektu ---
        const projectDetailsModal = {
            overlay: document.getElementById('project-details-modal'),
            title: document.getElementById('project-details-title'),
            projectName: document.getElementById('details-project-name'),
            projectOwner: document.getElementById('details-project-owner'),
            projectMembers: document.getElementById('details-project-members'),
            projectDescription: document.getElementById('details-project-description'),
            projectStart: document.getElementById('details-project-start'),
            projectEnd: document.getElementById('details-project-end'),
            projectPriority: document.getElementById('details-project-priority'),
            budgetChartContainer: document.getElementById('details-budget-chart-container'),
            workloadChartContainer: document.getElementById('details-workload-chart-container'),
            workloadChartPlaceholder: document.getElementById('workload-chart-placeholder') // Placeholder dla wykresu obci偶enia
        };
        const projectDetailsBtn = document.getElementById('project-details-btn');
        const mobileProjectActionsToggle = document.getElementById('mobile-project-actions-toggle');
        const mobileProjectActionsMenu = document.getElementById('mobile-project-actions-menu'); 
    const changeUsernameModal = {
        overlay: document.getElementById('change-username-modal'),
        form: document.getElementById('change-username-form'),
        input: document.getElementById('new-username-input'),
    };
    const changeSubgroupModal = {
        overlay: document.getElementById('change-subgroup-modal'),
        form: document.getElementById('change-subgroup-form'),
        select: document.getElementById('change-subgroup-select-list'),
    };
        const groupSwitcher = {
            toggle: document.getElementById('group-switcher-toggle'),
            menu: document.getElementById('group-switcher-menu'),
            list: document.getElementById('group-switcher-list'),
            activeName: document.getElementById('active-group-name'),
            manageBtn: document.getElementById('manage-groups-btn'),
            createBtn: document.getElementById('create-group-btn'),
            leaveBtn: document.getElementById('leave-group-btn'),
            inviteBtn: document.getElementById('invite-member-menu-btn') // <-- DODANA TA LINIA
        };
        const notificationToggleBtn = document.getElementById('notification-toggle-btn');
        const sidebar = document.getElementById('sidebar');
        const sidebarOverlay = document.getElementById('sidebar-overlay');
        const menuToggle = document.getElementById('menu-toggle');
        const mobileHeaderTitle = document.getElementById('mobile-header-title');
        const mainNav = document.getElementById('main-nav');
        const projectsListEl = document.getElementById('projects-list');
        const completedProjectsSection = document.getElementById('completed-projects-section');
        const completedProjectsListEl = document.getElementById('completed-projects-list');
        const projectNameHeaderEl = document.getElementById('project-name-header');
        const projectMembersHeaderEl = document.getElementById('project-members-header');
        // NOWE: Kontener paska postpu (zmieniem ID w HTML)
        const projectProgressContainer = document.getElementById('project-progress-container');
        const projectProgressText = document.getElementById('project-progress-text');
        const projectProgressFill = document.querySelector('.mini-progress-fill');

        const kanbanBoardEl = document.getElementById('kanban-board');
        const calendarToggleBtn = document.getElementById('calendar-toggle-btn');
        const calendarViewEl = document.getElementById('calendar-view');
        let calendarInstance = null; // Zmienna do przechowywania instancji kalendarza
        let workloadChartInstance = null;
        let teamWorkloadChartInstance = null; // <-- DODANA LINIA
        const sortBtn = document.getElementById('sort-btn');
        const searchInput = document.getElementById('search-input');
        // USUNITO: projectActionsEl, editProjectBtn, completeProjectBtn, deleteProjectBtn
        // (Bdziemy obsugiwa to przez delegacj zdarze na dropdown menu)
        
        const projectMenuToggle = document.getElementById('project-menu-toggle');
        const projectMenuDropdown = document.getElementById('project-menu-dropdown');
        const userEmailDisplay = document.getElementById('user-email-display');
        const logoutBtn = document.getElementById('logout-btn');
        const newProjectBtn = document.getElementById('new-project-btn');
        const resourcesBtn = document.getElementById('resources-btn');
        const fabMenuToggle = document.getElementById('fab-menu-toggle'); // <-- DODAJ T LINI
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const showRegisterBtn = document.getElementById('show-register');
        const showLoginBtn = document.getElementById('show-login');
        const authErrorLogin = document.getElementById('auth-error-login');
        const authErrorRegister = document.getElementById('auth-error-register');
        const fabAddSpecialTask = document.getElementById('fab-add-special-task');
        // NOWA REFERENCJA: Przycisk otwierania w nowym oknie
        const openNewWindowBtn = document.getElementById('open-new-window-btn'); 
       // DODANE REFERENCJE DO FAB MENU
        const fabMenu = document.getElementById('fab-menu');
        const fabActionNewTask = document.getElementById('fab-action-new-task');
        const fabActionNewPoll = document.getElementById('fab-action-new-poll');
        // KONIEC ZMIAN
   // === DANE AKADEMII (TUTORIAL DATA) ===
    const TUTORIAL_DATA = [
        // 1. PODSTAWY
        {
            id: 'basics', title: 'Podstawy',
            children: [
                { 
                    id: 'b-ui', title: 'Interfejs i Nawigacja', type: 'topic', video: 'assets/videos/Podstawy.mp4', 
                    desc: `
                        <p><strong>Tw贸j pulpit sterowniczy.</strong></p>
                        <ul>
                            <li><strong>Pasek Boczny (Sidebar):</strong> G贸wne centrum sterowania. U偶yj strzaki u g贸ry, aby go zwin (tryb Mini) i zyska wicej miejsca na prac. Ikony w trybie zwinitym nadal s aktywne.</li>
                            <li><strong>G贸rna Belka:</strong> Tu znajdziesz wyszukiwark globaln, przecznik motywu (Jasny/Ciemny) oraz powiadomienia.</li>
                            <li><strong>Pasek Akcji (Mobile):</strong> Na telefonach, kliknij "trzy kropki" w prawym g贸rnym rogu, aby uzyska dostp do menu akcji projektu.</li>
                        </ul>` 
                },
                {
                    id: 'b-views', title: 'Zakadki i Widoki', 
                    children: [
                        { 
                            id: 'v-myday', title: 'M贸j Dzie', type: 'topic', video: 'assets/videos/Mojdzien.mp4', 
                            desc: '<p><strong>Twoje centrum operacyjne.</strong><br>Inteligentna lista, kt贸ra resetuje si ka偶dego ranka. Automatycznie zbiera zadania z terminem na "Dzisiaj" oraz wszystkie zalege (czerwone). To najlepsze miejsce, by zacz prac.</p>' 
                        },
                        { 
                            id: 'v-dashboard', title: 'M贸j Dashboard', type: 'topic', video: 'assets/videos/Mojdashboard.mp4', 
                            desc: '<p><strong>Analityka w czasie rzeczywistym.</strong><br>Spersonalizowany pulpit z kafelkami KPI (np. "Moje op贸藕nienia", "M贸j bud偶et", "Aktywno zespou"). Mo偶esz dowolnie ukada kafelki, klikajc przycisk <strong>"Edytuj ukad"</strong> w nag贸wku.</p>' 
                        },
                        { 
                            id: 'v-all', title: 'Wszystkie Projekty', type: 'topic', video: 'assets/videos/Wszystkieprojekty.mp4', 
                            desc: `
                                <p><strong>Mapa Twoich inicjatyw.</strong></p>
                                <ul>
                                    <li><strong>Kolory kafelk贸w:</strong>
                                        <ul>
                                            <li><strong>Biae to:</strong> Projekty, kt贸rych jeste <strong>Wacicielem</strong> (masz pen kontrol).</li>
                                            <li><strong>Niebieskawe to:</strong> Projekty, w kt贸rych jeste <strong>Czonkiem</strong> (zostae zaproszony).</li>
                                        </ul>
                                    </li>
                                    <li><strong>Ulubione (Serce):</strong> Kliknij ikon serca na kafelku, aby przypi projekt do paska bocznego.</li>
                                    <li><strong>Edytuj ukad:</strong> Mo偶esz rcznie sortowa kolejno projekt贸w metod "przecignij i upu".</li>
                                </ul>` 
                        },
                        { 
                            id: 'v-inbox', title: 'Skrzynka Zada', type: 'topic', video: 'assets/videos/Skrzynkazadan.mp4', 
                            desc: `
                                <p><strong>Poczekalnia dla pomys贸w.</strong><br>To specjalny, prywatny projekt, do kt贸rego trafiaj zadania nieprzypisane do 偶adnego konkretnego projektu.</p>
                                <p><strong>Czerwony Plus:</strong> Gdy u偶ywasz przycisku szybkiego dodawania (+) w prawym dolnym rogu (np. na widoku M贸j Dzie), zadanie domylnie trafi wanie tutaj.</p>` 
                        },
                    ]
                },
                { 
                    id: 'b-search', title: 'Wyszukiwanie', type: 'topic', video: 'assets/videos/Wyszukiwanie.mp4',  
                    desc: '<p><strong>Znajd藕 cokolwiek.</strong><br>Globalna wyszukiwarka (nad menu) przeszukuje tytuy i opisy wszystkich zada we wszystkich projektach. Kliknicie w wynik przeniesie Ci bezporednio do szczeg贸贸w zadania.</p>' 
                }
            ]
        },

        // 2. GRUPY I ZESP
        {
            id: 'groups', title: 'Grupy i Zesp贸',
            children: [
                { 
                    id: 'g-create', title: 'Tworzenie i Zarzdzanie', type: 'topic', video: 'assets/videos/GrupaPodstawy.mp4',  
                    desc: '<p><strong>Twoja wirtualna firma.</strong><br>Grupa to kontener na projekty i ludzi. Mo偶esz posiada wiele grup (np. "Firma A", "Projekt Prywatny") i przecza si midzy nimi w lewym dolnym rogu. Waciciel grupy ma pen kontrol nad usuwaniem u偶ytkownik贸w.</p>' 
                },
                { 
                    id: 'g-sub', title: 'Dziay i Podgrupy', type: 'topic', video: 'assets/videos/Podgrupa.mp4',  
                    desc: '<p><strong>Struktura organizacji.</strong><br>W menu "Zarzdzaj Grup" mo偶esz tworzy dziay (np. IT, HR, Marketing). Uatwia to szybkie filtrowanie pracownik贸w podczas przydzielania zada.</p>' 
                },
                { 
                    id: 'g-invite', title: 'Zapraszanie Czonk贸w', type: 'topic', video: 'assets/videos/Zapro.mp4',  
                    desc: '<p><strong>Rozbuduj zesp贸.</strong><br>Wybierz "Zapro do grupy" w menu grupy. Wpisz e-mail wsp贸pracownika, a system wyle mu link rejestracyjny. Po rejestracji i klikniciu w link, u偶ytkownik wysya prob o doczenie, kt贸r waciciel grupy musi zaakceptowa w panelu "Zarzdzaj Grup".</p>' 
                },
                { 
                    id: 'g-join', title: 'Doczanie do Grupy', type: 'topic', video: 'assets/videos/dolacz.mp4',  
                    desc: '<p><strong>Docz do istniejcego zespou.</strong><br>Jeli znasz dokadn nazw grupy, mo偶esz wysa prob o doczenie. Waciciel grupy zobaczy Twoj prob w panelu "Oczekujcy" i bdzie m贸g j zaakceptowa.</p>' 
                }
            ]
        },

        // 3. PROJEKTY
        {
            id: 'projects', title: 'Projekty',
            children: [
                { 
                    id: 'p-config', 
                    title: 'Tworzenie i Konfiguracja',
                    children: [
                        {
                            id: 'p-name', title: 'Nazwa i Opis', type: 'topic', video: 'assets/videos/ProNazwaOpis.mp4', 
                            desc: '<p><strong>Fundament projektu.</strong><br>Dobra nazwa to podstawa. W opisie warto zawrze g贸wny cel biznesowy, linki do dokumentacji zewntrznej oraz kluczowe zao偶enia.</p>'
                        },
                        {
                            id: 'p-dates', title: 'Daty i Harmonogram', type: 'topic', video: 'assets/videos/ProDaty.mp4', 
                            desc: '<p><strong>Ramy czasowe.</strong><br>Ustaw dat startu i koca projektu. Te daty s kluczowe dla raport贸w. Jeli projekt jest op贸藕niony, daty podwietl si na czerwono.</p>'
                        },
                        {
                            id: 'p-prio', title: 'Priorytet', type: 'topic', video: 'assets/videos/ProPriorytet.mp4', 
                            desc: '<p><strong>Zarzdzanie uwag.</strong><br>Priorytet wpywa na sortowanie projekt贸w. Projekty o wysokim priorytecie maj 偶贸te oznaczenie, a o niskim - zielone.</p>'
                        },
                        {
                            id: 'p-effort', title: 'Wysiek (Estymacja)', type: 'topic', video: 'assets/videos/ProWysilek.mp4', 
                            desc: '<p><strong>Metryka pracy.</strong><br>Wybierz jednostk dla zada w tym projekcie: <strong>Godziny</strong> (dla time-trackingu) lub <strong>Story Points</strong> (dla metodyk Agile/Scrum). Wyb贸r "Brak" ukryje pola estymacji w zadaniach.</p>'
                        },
                        {
                            id: 'p-budget', title: 'Bud偶et Projektu', type: 'topic', video: 'assets/videos/ProBudzet.mp4', 
                            desc: '<p><strong>Kontrola finans贸w.</strong><br>Ustal cakowit kwot bud偶etu i walut. Zdefiniuj kategorie kosztowe (np. "Licencje", "Grafika"). Ka偶de zadanie z przypisanym kosztem bdzie automatycznie pomniejsza dostpny bud偶et ("Zarezerwowane"), a po ukoczeniu stanie si kosztem rzeczywistym ("Wydane").</p>'
                        },
                        {
                            id: 'p-perms', title: 'Uprawnienia (Admin)', type: 'topic', video: 'assets/videos/ProUprawnienia.mp4', 
                            desc: `
                                <p><strong>Hierarchia w projekcie:</strong></p>
                                <ul>
                                    <li><strong>Waciciel:</strong> Tw贸rca projektu. Ma pen kontrol, w tym prawo do usunicia projektu.</li>
                                    <li><strong>Administrator (Ikona Korony):</strong> Mo偶e edytowa ustawienia projektu, zarzdza zadaniami innych, dodawa kolumny Kanban. Waciciel nadaje t rol, klikajc koron przy nazwisku w edycji projektu.</li>
                                    <li><strong>Czonek:</strong> Mo偶e tworzy zadania, edytowa wasne zadania, komentowa i zmienia statusy.</li>
                                </ul>
                            `
                        }
                    ]
                },
                {
                    id: 'p-kanban', 
                    title: 'Tablica Kanban',
                    children: [
                        {
                            id: 'k-nav', title: 'Nawigacja i Opcje', type: 'topic', video: null,
                            desc: `
                                <p><strong>Pasek narzdzi projektu:</strong></p>
                                <ul>
                                    <li><strong>Nowe okno (Strzaka):</strong> Otwiera projekt w osobnej karcie przegldarki - idealne do pracy na wielu monitorach.</li>
                                    <li><strong>Szczeg贸y:</strong> Szybki podgld statystyk, wykresu spalonego bud偶etu i obci偶enia zespou.</li>
                                    <li><strong>Kalendarz:</strong> Przecza widok z tablicy na kalendarz miesiczny/tygodniowy.</li>
                                    <li><strong>Czat:</strong> Otwiera dedykowany panel dyskusyjny dla tego projektu.</li>
                                </ul>
                            `
                        },
                        {
                            id: 'k-filter', title: 'Zaawansowane Filtrowanie', type: 'topic', video: 'assets/videos/Filtrowanie.mp4', 
                            desc: `
                                <p><strong>Znajd藕 ig w stogu siana.</strong><br>Kliknij przycisk "Filtr" w nag贸wku projektu, aby zawzi widok tablicy. Dostpne kryteria:</p>
                                <ul>
                                    <li><strong>Osoba:</strong> Poka偶 zadania przypisane do konkretnego czonka.</li>
                                    <li><strong>Termin:</strong> Op贸藕nione, Nadchodzce (7 dni), Bez terminu.</li>
                                    <li><strong>Status bud偶etowy:</strong> Zadania z przypisanym kosztem vs bezkosztowe.</li>
                                    <li><strong>Sonda偶e:</strong> Opcja ukrycia kafelk贸w gosowania dla przejrzystoci.</li>
                                </ul>
                            `
                        },
                        {
                            id: 'k-cols', title: 'Kolumny i Statusy', type: 'topic', video: 'assets/videos/Kolumny.mp4', 
                            desc: '<p><strong>Tw贸j proces pracy.</strong><br>Standardowo: <em>Do realizacji -> W trakcie -> Wykonane</em>. Administratorzy mog doda <strong>Kolumny Niestandardowe</strong> (np. "Code Review", "Testy QA") u偶ywajc przycisku "Kolumny". Kolejno kolumn mo偶na zmienia przecigajc je w oknie edycji kolumn.</p>'
                        },
                        {
                            id: 'k-tiles', title: 'Kafelki Zada', type: 'topic', video: 'assets/videos/Kafelekzadania.mp4', 
                            desc: `
                                <p><strong>Wizyt贸wka zadania.</strong><br>Kafelek na tablicy to skondensowane centrum informacji. Oznaczenia:</p>
                                <ul>
                                    <li><strong>Banner:</strong> Zdjcie w nag贸wku (okadka) lub kolor ta.</li>
                                    <li><strong>Priorytet:</strong> Kolorowy pasek u g贸ry (呕贸ty = Wysoki, Zielony = Niski).</li>
                                    <li><strong>Ikony (D贸):</strong> Informuj o: trybie wieloosobowym, liczbie podzada, komentarzy, zacznik贸w, cyklicznoci, bud偶ecie oraz powizaniach (acuch).</li>
                                    <li><strong>Interakcja:</strong> Mo偶esz klikn ikon wieloosobowoci lub podzada, aby rozwin list postpu bezporednio na kafelku.</li>
                                    <li><strong>Dzwonek:</strong> Subskrypcja powiadomie o ukoczeniu (dla os贸b nieprzypisanych).</li>
                                </ul>
                            `
                        }
                    ]
                },
                { id: 'p-archive', title: 'Archiwizacja', type: 'topic', video: 'assets/videos/Archiwum.mp4', desc: '<p><strong>Porzdek w projektach.</strong><br>Projekty oznaczone jako "Zakoczone" znikaj z g贸wnej listy i trafiaj do <strong>Archiwum</strong> (dostpne w menu "Zasoby i Narzdzia"). S tam dostpne w trybie "tylko do odczytu" (read-only), ale w ka偶dej chwili mo偶na je przywr贸ci do aktywnoci.</p>' }
            ]
        },

        // 4. ZADANIA
        {
            id: 'tasks', title: 'Zadania (Szczeg贸y)',
            children: [
                { 
                    id: 'tab-desc', title: '1. Opis i Tytu', type: 'topic', 
                    video: 'assets/videos/Opis.mp4', 
                    desc: '<p><strong>Jasna komunikacja.</strong><br>Tytu to nag贸wek kafelka. W polu Opis (wewntrz modala) mo偶esz wpisywa szczeg贸owe wytyczne. Linki wklejone w opis staj si automatycznie klikalne.</p>' 
                },
                { 
                    id: 'tab-date', title: '2. Terminy (Start/Deadline)', type: 'topic', 
                    video: 'assets/videos/WyborTerminu.mp4', 
                    desc: '<p><strong>Planowanie czasu.</strong><br>System obsuguje dwie daty: <strong>Data Rozpoczcia</strong> (kiedy zacz) oraz <strong>Termin Wykonania</strong> (deadline). Mo偶esz ustawi dokadn godzin. Jeli termin minie, data na kafelku zawieci si na czerwono.</p>'
                },
                { 
                    id: 'tab-effort', title: '3. Wysiek (Estymacja)', type: 'topic', 
                    video: 'assets/videos/Wysilek.mp4', 
                    desc: '<p><strong>Plan vs Rzeczywisto.</strong><br>Dostpne tylko w projektach z wczon estymacj. Wpisz <strong>Szacowany</strong> czas/punkty przed prac, a <strong>Rzeczywisty</strong> po zakoczeniu. System poka偶e r贸偶nic kolorami (zielony/czerwony) bezporednio na kafelku.</p>' 
                },
                { 
                    id: 'tab-budget', title: '4. Bud偶et Zadania', type: 'topic', 
                    video: 'assets/videos/Budzet.mp4', 
                    desc: '<p><strong>Alokacja rodk贸w.</strong><br>Mo偶esz przypisa do zadania wiele pozycji kosztowych (wybierajc z definicji projektu). Kwoty te s "Zarezerwowane", dop贸ki zadanie jest aktywne. Po przesuniciu do "Wykonane", staj si kwotami "Wydanymi".</p>' 
                },
                { 
                    id: 'tab-att', title: '5. Zaczniki i Bannery', type: 'topic', 
                    video: 'assets/videos/Zalacznik.mp4', 
                    desc: '<p><strong>Wizualizacja.</strong><br>Przecignij lub dodaj pliki (limit 15 MB na plik). <strong>Banner (Okadka):</strong> Ka偶dy obrazek (.jpg/.png) wgrany do zadania mo偶e opcjonalnie sta si okadk kafelka. Mo偶esz wybra go z Galerii Szablon贸w lub ustawi wasny z zacznik贸w.</p>' 
                },
                { 
                    id: 'tab-comments', title: '6. Komentarze i Wzmianki', type: 'topic', 
                    video: 'assets/videos/Komentarz.mp4', 
                    desc: '<p><strong>Dyskusja w kontekcie.</strong><br>Pisz komentarze w zadaniu. U偶yj znaku <strong>@</strong> (np. @Anna), aby wywoa osob z zespou. Otrzyma ona specjalne powiadomienie, 偶e jest potrzebna w dyskusji.</p>' 
                },
                { 
                    id: 'tab-assignees', title: '7. Osoby i Tryby Pracy', type: 'topic', 
                    video: 'assets/videos/Osoby.mp4', 
                    desc: `
                        <p><strong>Kto za to odpowiada?</strong></p>
                        <ul>
                            <li><strong>Tryb Jednoosobowy:</strong> Standardowy. Jedna osoba odpowiada za cao.</li>
                            <li><strong>Tryb Wieloosobowy:</strong> Zadanie grupowe. Ka偶dy przypisany u偶ytkownik musi klikn "Ukocz moj cz". Zadanie zmieni status na "Wykonane" dopiero, gdy <strong>wszyscy</strong> wykonaj swoj cz pracy.</li>
                        </ul>` 
                },
                { 
                    id: 'tab-status', title: '8. Status i Etapy', type: 'topic', 
                    video: 'assets/videos/Zadstatus.mp4', 
                    desc: `
                        <p><strong>Zarzdzanie procesem.</strong><br>W tym oknie zmienisz aktualny etap pracy nad zadaniem, wybierajc go z listy rozwijanej.</p>
                        <ul>
                            <li><strong>Standardowe:</strong> Do realizacji, W trakcie, Wykonane.</li>
                            <li><strong>Niestandardowe:</strong> Jeli Administrator doda do projektu specjalne kolumny (np. "Testy"), pojawi si one na licie jako podkategorie "W trakcie".</li>
                        </ul>
                        <p>Zmiana statusu automatycznie przesuwa kafelek zadania do odpowiedniej kolumny na tablicy Kanban.</p>` 
                },
                { 
                    id: 'tab-priority', title: '9. Priorytet', type: 'topic', 
                    video: 'assets/videos/Priorytet.mp4', 
                    desc: '<p><strong>Waga zadania.</strong><br>Oznacz zadania jako Wysoki (偶贸ty pasek), redni lub Niski (zielony pasek) priorytet, aby zesp贸 wiedzia, co robi w pierwszej kolejnoci.</p>' 
                },
                { 
                    id: 'tab-recur', title: '10. Cykliczno', type: 'topic', 
                    video: 'assets/videos/Cyklicznosc.mp4', 
                    desc: '<p><strong>Automatyzacja.</strong><br>Ustaw powtarzanie zadania (np. co tydzie, w ka偶dy pitek). Wa偶ne: Nowa kopia zadania z now dat utworzy si <strong>automatycznie w momencie ukoczenia</strong> (przesunicia do "Done") bie偶cego zadania.</p>' 
                },
                { 
                    id: 'tab-actions', title: '11. Akcje i Zale偶noci', type: 'topic', 
                    video: null, 
                    desc: `
                        <p><strong>Zaawansowane operacje.</strong></p>
                        <ul>
                            <li><strong>Przenie:</strong> Przesuwa zadanie do innego projektu (zachowujc histori).</li>
                            <li><strong>Powizania (acuch):</strong> Mo偶esz zablokowa zadanie innym zadaniem ("Zale偶ne od"). System nie pozwoli ukoczy tego zadania, dop贸ki zadanie blokujce nie zostanie wykonane.</li>
                            <li><strong>Dzwonek:</strong> Wcz powiadomienie o ukoczeniu tego zadania (nawet jeli nie jeste do niego przypisany).</li>
                        </ul>` 
                },
                { 
                    id: 'tab-history', title: '12. Historia Zmian', type: 'topic', 
                    video: null, 
                    desc: '<p><strong>Peny audyt.</strong><br>Zakadka "Historia" pokazuje chronologiczny zapis wszystkich zmian: kto zmieni status, kto edytowa opis, kto zmieni priorytet. Idealne do ledzenia postp贸w.</p>' 
                }
            ]
        },

        // 5. ASYSTENT AI
        {
            id: 'ai', title: 'Asystent AI',
            children: [
                { 
                    id: 'ai-intro', title: 'Wprowadzenie i Gos', type: 'topic', video: null, 
                    desc: '<p><strong>Tw贸j inteligentny partner.</strong><br>TeamFlow AI (oparty na modelu Gemini) rozumie kontekst Twoich projekt贸w. Mo偶esz z nim rozmawia tekstowo lub gosowo (ikona mikrofonu w panelu AI). W ustawieniach (ikona rubki w panelu AI) mo偶esz zmieni gos lektora.</p>' 
                },
                { 
                    id: 'ai-agent', title: 'AI jako Agent (Komendy)', type: 'topic', video: null, 
                    desc: `
                        <p>Asystent potrafi wykonywa zmiany w aplikacji za Ciebie. Przykadowe polecenia:</p>
                        <ul>
                            <li><strong>Tworzenie zadania:</strong> "Dodaj zadanie 'Raport roczny' na jutro dla Marka w projekcie Marketing".</li>
                            <li><strong>Tworzenie projektu:</strong> "Stw贸rz projekt 'Nowa Strona WWW' z bud偶etem 15000 PLN".</li>
                            <li><strong>Edycja zadania:</strong> "Zmie priorytet zadania 'Poprawki UI' na wysoki i dodaj opis 'Pilne'".</li>
                            <li><strong>Zarzdzanie kolumnami:</strong> "Dodaj kolumn 'Do akceptacji' w tym projekcie".</li>
                            <li><strong>Usuwanie/Koczenie:</strong> "Oznacz zadanie 'Faktura' jako wykonane".</li>
                        </ul>` 
                },
                { 
                    id: 'ai-analyst', title: 'AI jako Analityk', type: 'topic', video: null, 
                    desc: `
                        <p>Asystent ma dostp do danych "na 偶ywo". Mo偶esz go pyta o analizy:</p>
                        <ul>
                            <li><strong>Obci偶enie:</strong> "Kto w zespole ma najwicej pracy?", "Czy Marek jest przeci偶ony?".</li>
                            <li><strong>Op贸藕nienia:</strong> "Wymie wszystkie op贸藕nione zadania w moich projektach".</li>
                            <li><strong>Bud偶et:</strong> "Jaki jest stan bud偶etu w projekcie X? Czy przekroczylimy limit?".</li>
                            <li><strong>Podsumowania:</strong> "Podsumuj postpy w projekcie 'Marketing' z tego tygodnia".</li>
                        </ul>` 
                }
            ]
        },

        // 6. POZOSTAE
        {
            id: 'others', title: 'Pozostae',
            children: [
                { 
                    id: 'o-templates', title: 'Szablony Projekt贸w', type: 'topic', video: null, 
                    desc: '<p><strong>Oszczdno czasu.</strong><br>W menu "Zasoby" mo偶esz tworzy szablony caych projekt贸w wraz z list zada. Idealne dla powtarzalnych proces贸w (np. "Onboarding pracownika", "Nowa kampania"). Jednym klikniciem stworzysz nowy projekt na bazie szablonu.</p>' 
                },
                { 
                    id: 'o-polls', title: 'Sonda偶e', type: 'topic', video: null, 
                    desc: '<p><strong>Demokracja w zespole.</strong><br>Potrzebujesz opinii? Utw贸rz <strong>Sonda偶</strong> na tablicy Kanban (zielony przycisk w menu "+"). U偶ytkownicy mog gosowa, a system zliczy wyniki, poka偶e lidera i frekwencj. Sonda偶e r贸wnie偶 maj swoje terminy.</p>' 
                },
                { 
                    id: 'o-settings', title: 'Ustawienia Osobiste', type: 'topic', video: null, 
                    desc: '<p><strong>Tw贸j profil.</strong><br>W prawym dolnym rogu paska bocznego (ikona rubki) znajdziesz ustawienia konta. Mo偶esz tam zmieni haso, zaktualizowa swoje zdjcie (z funkcj kadrowania) oraz przypisa si do konkretnego dziau w firmie.</p>' 
                }
            ]
        }
    ];
    // Referencje do element贸w tutoriala
    const tutorialModal = {
        overlay: document.getElementById('tutorial-modal'),
        nav: document.getElementById('tutorial-tree-nav'),
        content: document.getElementById('tutorial-content-area'),
        openBtn: document.getElementById('open-tutorial-btn')
    };

    // Funkcja rekurencyjna do budowania drzewa HTML z obsug poziom贸w
    function buildTutorialTree(items, level = 0) {
        let html = '';
        items.forEach(item => {
            // Oblicz wcicie dla link贸w kocowych (temat贸w)
            // Dla nag贸wk贸w (folder贸w) wcicie jest w CSS
            
            if (item.children) {
                // KATEGORIA (Folder)
                // Domylnie rozwijamy sekcj "Zadania" i "Projekty"
                const isExpanded = (item.id === 'tasks' || item.id === 'projects') ? 'expanded' : '';
                const isVisible = (item.id === 'tasks' || item.id === 'projects') ? 'visible' : '';

                html += `
                    <div class="tutorial-tree-item">
                        <div class="tutorial-tree-header level-${level} ${isExpanded}" onclick="toggleTutorialFolder(this)">
                            <span>${item.title}</span>
                            <svg class="chevron" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
                            </svg>
                        </div>
                        <div class="tutorial-tree-children ${isVisible}">
                            ${buildTutorialTree(item.children, level + 1)}
                        </div>
                    </div>
                `;
            } else {
                // TEMAT (Link kocowy)
                const dataVideo = item.video ? item.video : '';
                // Bezpieczne kodowanie opisu
                const dataDesc = item.desc ? encodeURIComponent(item.desc) : '';
                // Wcicie dla link贸w: Poziom 2 (tematy w podkategoriach) musz by gbiej
                const paddingLeft = 24 + (level * 12); 
                
                html += `
                    <a class="tutorial-topic-link" 
                       style="padding-left: ${paddingLeft}px;"
                       onclick="loadTutorialTopic(this, '${item.title}', '${dataVideo}', '${dataDesc}')">
                       ${item.title}
                       ${item.video ? `
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" style="float:right; margin-top: 1px; opacity: 0.7;">
                          <g fill="currentColor">
                            <rect x="2" y="5" width="20" height="14" rx="2"/>
                            <rect x="3.4" y="7" width="1.4" height="2" rx="0.4" fill="#fff"/>
                            <rect x="3.4" y="11" width="1.4" height="2" rx="0.4" fill="#fff"/>
                            <rect x="3.4" y="15" width="1.4" height="2" rx="0.4" fill="#fff"/>
                            <rect x="19.2" y="7" width="1.4" height="2" rx="0.4" fill="#fff"/>
                            <rect x="19.2" y="11" width="1.4" height="2" rx="0.4" fill="#fff"/>
                            <rect x="19.2" y="15" width="1.4" height="2" rx="0.4" fill="#fff"/>
                            <polygon points="9.2,9 15.2,12 9.2,15" fill="#fff"/>
                          </g>
                        </svg>` : ''}
                    </a>
                `;
            }
        });
        return html;
    }
    // Funkcja globalna do rozwijania folder贸w
    window.toggleTutorialFolder = function(header) {
        header.classList.toggle('expanded');
        const children = header.nextElementSibling;
        children.classList.toggle('visible');
    };

    // Funkcja globalna do adowania treci tematu
    window.loadTutorialTopic = function(link, title, videoFile, encodedDesc) {
        // 1. Zaznacz aktywny link
        const allLinks = tutorialModal.nav.querySelectorAll('.tutorial-topic-link');
        allLinks.forEach(l => l.classList.remove('active'));
        link.classList.add('active');

        // 2. Przygotuj tre
        const desc = encodedDesc ? decodeURIComponent(encodedDesc) : 'Opis dla tej sekcji jest w przygotowaniu.';
        let videoHTML = '';

        if (videoFile) {
            // Wideo: Autoplay, Loop, Wyciszone
            videoHTML = `
                <div class="tutorial-video-wrapper">
                    <video src="${videoFile}" controls autoplay loop muted playsinline></video>
                </div>
            `;
        } else {
            // Placeholder
            videoHTML = `
                <div class="tutorial-video-wrapper" style="display:flex; flex-direction:column; align-items:center; justify-content:center; background-color:var(--bg-tertiary); color:var(--text-secondary);">
                    <div style="margin-bottom:12px; opacity:0.5;">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="48" height="48">
                          <title>Tama video  solid (wycentrowany play)</title>
                          <g fill="currentColor">
                            <rect x="2" y="5" width="20" height="14" rx="2"/>
                            <rect x="3.4" y="7" width="1.4" height="2" rx="0.4" fill="#fff"/>
                            <rect x="3.4" y="11" width="1.4" height="2" rx="0.4" fill="#fff"/>
                            <rect x="3.4" y="15" width="1.4" height="2" rx="0.4" fill="#fff"/>
                            <rect x="19.2" y="7" width="1.4" height="2" rx="0.4" fill="#fff"/>
                            <rect x="19.2" y="11" width="1.4" height="2" rx="0.4" fill="#fff"/>
                            <rect x="19.2" y="15" width="1.4" height="2" rx="0.4" fill="#fff"/>
                            <polygon points="9.2,9 15.2,12 9.2,15" fill="#fff"/>
                          </g>
                        </svg>
                    </div>
                    <p style="font-weight:500;">Wideo instrukta偶owe wkr贸tce dostpne</p>
                </div>
            `;
        }

        // 3. Wywietl tre (z u偶yciem wrappera centrujcego)
        tutorialModal.content.innerHTML = `
            <div class="tutorial-content-wrapper fade-in">
                <h3 style="margin-bottom: 24px; font-size: 28px; color: var(--text-primary);">${title}</h3>
                ${videoHTML}
                <div class="tutorial-description">
                    ${desc}
                </div>
            </div>
        `;
    };

    // Listener otwierania modala (z ustawie)
    if (tutorialModal.openBtn) {
        tutorialModal.openBtn.addEventListener('click', () => {
            // Zbuduj drzewo tylko raz (lub odwie偶 przy otwarciu)
            tutorialModal.nav.innerHTML = buildTutorialTree(TUTORIAL_DATA);
            
            // Zamknij modal ustawie (bo stamtd klikamy)
            closeModal(document.getElementById('settings-modal'));
            
            // Otw贸rz modal tutoriala
            openModal(tutorialModal.overlay);
        });
    }
    
        const newProjectModal = {
            overlay: document.getElementById('new-project-modal'),
            form: document.getElementById('new-project-form'),
            nameInput: document.getElementById('new-project-name'),
            startDateInput: document.getElementById('new-project-startDate'),
            endDateInput: document.getElementById('new-project-endDate'),
            prioritySelect: document.getElementById('new-project-priority'),
            membersContainer: document.getElementById('new-project-members'),
            memberSearchInput: document.getElementById('new-project-member-search'),
            memberSearchResults: document.getElementById('new-project-member-search-results'),
            descriptionTextarea: document.getElementById('new-project-description'),

            // --- SEKCJA BUD呕ETU ---
            budgetToggle: document.getElementById('new-project-budget-toggle'),
            budgetDetails: document.getElementById('new-project-budget-details'),
            budgetAmountInput: document.getElementById('new-project-budget-amount'),
            budgetCurrencyInput: document.getElementById('new-project-budget-currency'),
            budgetItemsList: document.getElementById('new-project-budget-items'),
            addBudgetItemBtn: document.getElementById('new-project-add-budget-item-btn'),
            // USUNITO: saveBudgetBtn i budgetStatusSpan
            budgetSummaryDiv: document.getElementById('new-project-budget-summary'),
            budgetItemsSumStrong: document.getElementById('new-project-budget-items-sum'),
            budgetDifferenceStrong: document.getElementById('new-project-budget-difference'),
            budgetSaveErrorP: document.getElementById('new-project-budget-save-error'),
            // --- KONIEC SEKCJI BUD呕ETU ---
        
            estimationTypeSelect: document.getElementById('new-project-estimation-type')
        };
        const editProjectModal = {
            overlay: document.getElementById('edit-project-modal'),
            form: document.getElementById('edit-project-form'),
            nameInput: document.getElementById('edit-project-name'),
            startDateInput: document.getElementById('edit-project-startDate'),
            endDateInput: document.getElementById('edit-project-endDate'),
            prioritySelect: document.getElementById('edit-project-priority'),
            descriptionTextarea: document.getElementById('edit-project-description'),
            membersContainer: document.getElementById('edit-project-members'),
            memberSearchInput: document.getElementById('edit-project-member-search'),
            memberSearchResults: document.getElementById('edit-project-member-search-results'),

            // --- SEKCJA BUD呕ETU ---
            budgetToggle: document.getElementById('edit-project-budget-toggle'),
            budgetDetails: document.getElementById('edit-project-budget-details'),
            budgetAmountInput: document.getElementById('edit-project-budget-amount'),
            budgetCurrencyInput: document.getElementById('edit-project-budget-currency'),
            budgetItemsList: document.getElementById('edit-project-budget-items'),
            addBudgetItemBtn: document.getElementById('edit-project-add-budget-item-btn'),
            // USUNITO: saveBudgetBtn i budgetStatusSpan
            budgetSummaryDiv: document.getElementById('edit-project-budget-summary'),
            budgetItemsSumStrong: document.getElementById('edit-project-budget-items-sum'),
            budgetDifferenceStrong: document.getElementById('edit-project-budget-difference'),
            budgetSaveErrorP: document.getElementById('edit-project-budget-save-error'),
            // --- KONIEC SEKCJI BUD呕ETU ---
        
            estimationTypeSelect: document.getElementById('edit-project-estimation-type')
        };
       const newTaskModal = {
            overlay: document.getElementById('new-task-modal'),
            form: document.getElementById('new-task-form'),
            projectGroup: document.getElementById('new-task-project-group'),
            projectSelect: document.getElementById('new-task-project'),
            title: document.getElementById('new-task-title'),
            description: document.getElementById('new-task-description'),
            
            // === NOWE REFERENCJE (ZGODNE Z PROJEKTEM/PODZADANIEM) ===
            assigneesList: document.getElementById('new-task-assignees-list'), // Lewa kolumna
            selectedList: document.getElementById('new-task-selected-list'),   // Prawa kolumna (NOWE)
            memberSearchInput: document.getElementById('new-task-member-search'),
            memberSearchResults: document.getElementById('new-task-member-search-results'),
            // === KONIEC ===
            
            // Daty
            startDateDate: document.getElementById('new-task-startDate-date'),
            startDateHour: document.getElementById('new-task-startDate-hour'),
            startDateMinute: document.getElementById('new-task-startDate-minute'),
            dueDateDate: document.getElementById('new-task-dueDate-date'),
            dueDateHour: document.getElementById('new-task-dueDate-hour'),
            dueDateMinute: document.getElementById('new-task-dueDate-minute'),
            
            priority: document.getElementById('new-task-priority'),
            isRecurring: document.getElementById('new-task-is-recurring'),
            recurrenceOptions: document.getElementById('new-task-recurrence-options'),
            recurrenceType: document.getElementById('new-task-recurrence-type'),
            recurrenceDayWrapper: document.getElementById('new-task-recurrence-day-wrapper'),
            recurrenceDay: document.getElementById('new-task-recurrence-day'),
            
            // Bud偶et
            budgetToggle: document.getElementById('new-task-budget-toggle'),
            budgetDetails: document.getElementById('new-task-budget-details'),
            budgetItemsList: document.getElementById('new-task-budget-items'),
            addBudgetItemBtn: document.getElementById('new-task-add-budget-item-btn'),
            budgetTotalSpan: document.getElementById('new-task-budget-total'),
            budgetCurrencySpan: document.getElementById('new-task-budget-currency'),
            budgetErrorP: document.getElementById('new-task-budget-error'),
            budgetTabButton: document.getElementById('new-task-tab-taskBudget'),
            
            // Wizualne
            openCoverGalleryBtn: document.getElementById('new-task-open-cover-gallery-btn'),
            openBackgroundColorBtn: document.getElementById('new-task-open-background-color-btn'),

            // Wysiek
            effortTabButton: document.getElementById('new-task-tab-effort'),
            effortLabel: document.getElementById('new-task-effort-label'),
            effortInput: document.getElementById('new-task-effort-input'),
            effortUnit: document.getElementById('new-task-effort-unit'), // <--- Tu by koniec, teraz jest przecinek

            // === NOWE REFERENCJE DLA OSTRZE呕E (TERAZ S WEWNTRZ) ===
            warningOverride: document.getElementById('new-task-warning-override'),
            warningWrapper: document.getElementById('new-task-warning-wrapper'),
            warningDaysInput: document.getElementById('new-task-warning-days')
        }; // <--- TUTAJ JEST KONIEC OBIEKTU

        // === LISTENER UI (POZA OBIEKTEM) ===
        if (newTaskModal.warningOverride) {
            newTaskModal.warningOverride.addEventListener('change', () => {
                newTaskModal.warningWrapper.style.display = newTaskModal.warningOverride.checked ? 'block' : 'none';
            });
        }

        // === NOWE REFERENCJE DLA KOLOROWANIA (EDYCJA I MODAL) ===
        const taskModalBackgroundColorBtn = document.getElementById('open-background-color-btn');
        const backgroundColorModal = {
            overlay: document.getElementById('background-color-modal'),
            grid: document.getElementById('background-colors-grid')
        };

        const searchModal = {
            overlay: document.getElementById('search-modal'),
            input: document.getElementById('modal-search-input'),
            resultsList: document.getElementById('search-results-list'),
        };
        const moveTaskModal = {
            overlay: document.getElementById('move-task-modal'),
            projectList: document.getElementById('move-task-project-list'),
            confirmBtn: document.getElementById('confirm-move-task-btn')
        };
        const notificationModal = {
            overlay: document.getElementById('notification-modal'),
            title: document.getElementById('notification-title'),
            message: document.getElementById('notification-message'),
        };
       // --- NOWY MODAL FILTROWANIA ---
        const projectFilterModal = {
            overlay: document.getElementById('project-filter-modal'),
            assigneeListContainer: document.getElementById('filter-assignee-list-container'), // <-- ZMIENIONO REFERENCJ
            prioritySelect: document.getElementById('filter-priority'),
            dueDateSelect: document.getElementById('filter-dueDate'),
            budgetStatusSelect: document.getElementById('filter-budgetStatus'),
            pollToggle: document.getElementById('filter-showPolls'), // <-- DODANA LINIA
            applyBtn: document.getElementById('filter-apply-btn'),
            clearBtn: document.getElementById('filter-clear-btn'),
            statusMessage: document.getElementById('filter-status-message'),
        };
        const filterBtn = document.getElementById('filter-btn');
        // --- KONIEC NOWEGO MODALA ---
       const confirmationModal = {
            overlay: document.getElementById('confirmation-modal'),
            title: document.getElementById('confirmation-title'),
            message: document.getElementById('confirmation-message'),
            confirmBtn: document.getElementById('confirmation-action-btn'),
        };
       // === NOWE REFERENCJE DLA MODALA SONDAR呕U ===
        const newPollModal = {
            overlay: document.getElementById('new-poll-modal'),
            form: document.getElementById('new-poll-form'),
            titleInput: document.getElementById('new-poll-title'),
            optionsList: document.getElementById('new-poll-options-list'),
            addOptionBtn: document.getElementById('add-poll-option-btn'),
            deadlineInput: document.getElementById('new-poll-deadline'),
            assigneesContainer: document.getElementById('new-poll-assignees')
        };
        // === KONIEC NOWYCH REFERENCJI ===
      // === NOWE REFERENCJE DLA MODALA SZCZEGW SONDAR呕U ===
        const pollDetailsModal = {
            overlay: document.getElementById('poll-details-modal'),
            title: document.getElementById('poll-details-title'),
            content: document.getElementById('poll-details-content'),
            footer: document.getElementById('poll-details-footer'),
            closePollBtn: document.getElementById('poll-details-close-btn'),
            deletePollBtn: document.getElementById('poll-details-delete-btn'), // <-- ISTNIEJCA LINIA
            changeVoteBtn: document.getElementById('poll-details-change-vote-btn') // <-- DODANA LINIA
        };
        // === KONIEC NOWYCH REFERENCJI ===

        // === NOWA REFERENCJA DLA MODALA TRANSFERU WASNOCI ===
        const transferOwnershipModal = {
            overlay: document.getElementById('transfer-ownership-modal'),
            form: document.getElementById('transfer-ownership-form'),
            select: document.getElementById('new-owner-select'),
            error: document.getElementById('transfer-ownership-error'),
            submitBtn: document.querySelector('#transfer-ownership-form button[type="submit"]')
        };
        // === KONIEC NOWEJ REFERENCJI ===
      // === NOWE REFERENCJE DLA TRYBU ZAZNACZANIA ===
        const selectModeToggleBtn = document.getElementById('select-mode-toggle-btn');
        const bulkActionBar = document.getElementById('bulk-action-bar');
        const bulkActionCount = document.getElementById('bulk-action-count');
        const bulkDeleteBtn = document.getElementById('bulk-delete-btn');
        const bulkAssignBtn = document.getElementById('bulk-assign-btn'); // <-- NOWA LINIA
        const mainContentEl = document.querySelector('.main-content'); // Potrzebne do dodania klasy globalnej
        
        const bulkAssignModal = { // <-- NOWY OBIEKT
            overlay: document.getElementById('bulk-assign-modal'),
            form: document.getElementById('bulk-assign-form'),
            membersList: document.getElementById('bulk-assign-members-list'),
            saveBtn: document.getElementById('bulk-assign-save-btn')
        };
        // === KONIEC ===
        
        // === POCZTEK NOWEGO KODU: Referencje do Modala Kolumn ===
        const manageColumnsBtn = document.getElementById('manage-columns-btn');
        const manageColumnsModal = {
            overlay: document.getElementById('custom-columns-modal'),
            list: document.getElementById('custom-columns-list'),
            addForm: document.getElementById('add-custom-column-form'),
            addInput: document.getElementById('new-column-name-input'),
            saveBtn: document.getElementById('save-custom-columns-btn')
        };
        let customColumnsSortable = null; // Zmienna dla instancji Sortable.js
        // === KONIEC NOWEGO KODU ===

        // === NOWE REFERENCJE DLA MODALI SZABLONW ===
        // ZMIANA: Usunito referencj do 'openTemplatesBtn'.
        // Referencja 'resourcesBtn' jest ju偶 zdefiniowana wczeniej (linia 2758) i jest poprawna.
        const templatesModal = {
            overlay: document.getElementById('project-templates-modal'),
            list: document.getElementById('templates-list'),
            detailsView: document.getElementById('template-details-view'),
            detailsTitle: document.getElementById('template-details-title'),
            detailsContent: document.getElementById('template-details-content'),
            addNewBtn: document.getElementById('add-new-template-btn'),
            editBtn: document.getElementById('edit-template-btn'),
            deleteBtn: document.getElementById('delete-template-btn'),
            createProjectBtn: document.getElementById('create-project-from-template-btn')
        };
        const templateEditModal = {
            overlay: document.getElementById('template-edit-modal'),
            form: document.getElementById('template-edit-form'),
            title: document.getElementById('template-edit-title'),
            idInput: document.getElementById('template-edit-id'),
            nameInput: document.getElementById('template-edit-name'),
            descriptionTextarea: document.getElementById('template-edit-description'),
            tasksList: document.getElementById('template-edit-tasks-list'),
            addTaskBtn: document.getElementById('add-template-task-btn'),
            saveBtn: document.querySelector('#template-edit-form button[type="submit"]') // Znajdujemy przycisk zapisu
        };
        // === KONIEC NOWYCH REFERENCJI ===

       // === NOWE REFERENCJE DLA SUBZADA (Wersja 2.1) ===
        const addSubtaskBtnMain = document.getElementById('add-subtask-btn-main');
        const subtasksListMain = document.getElementById('subtasks-list-main');
        
        // Rozszerzona definicja referencji do modala podzadania
        // 1. Zaktualizuj referencje w obiekcie
        const subtaskModal = {
            overlay: document.getElementById('subtask-modal'),
            form: document.getElementById('subtask-form'),
            modalTitle: document.getElementById('subtask-modal-title'),
            subtaskIdInput: document.getElementById('subtask-modal-id'),
            titleInput: document.getElementById('subtask-modal-title-input'),
            
            tabsContainer: document.getElementById('subtask-tabs'),
            contentsContainer: document.querySelector('#subtask-modal .task-modal-tabs-content'),
            
            descriptionInput: document.getElementById('subtask-description'),
            
            // NOWE POLA DAT (Rozbite na Date, Hour, Minute)
            startDateDate: document.getElementById('subtask-startDate-date'),
            startDateHour: document.getElementById('subtask-startDate-hour'),
            startDateMinute: document.getElementById('subtask-startDate-minute'),
            
            dueDateDate: document.getElementById('subtask-dueDate-date'),
            dueDateHour: document.getElementById('subtask-dueDate-hour'),
            dueDateMinute: document.getElementById('subtask-dueDate-minute'),
            
            startError: document.getElementById('subtask-start-error'), // Pole na bdy
            dueError: document.getElementById('subtask-due-error'),     // Pole na bdy

            // Wysiek
            tabEffort: document.getElementById('subtask-tab-effort'),
            effortInput: document.getElementById('subtask-effort-input'),
            actualEffortInput: document.getElementById('subtask-actual-effort-input'),
            effortUnit: document.getElementById('subtask-effort-unit'),
            effortLabel: document.getElementById('subtask-effort-label'),
            
            // Bud偶et
            tabBudget: document.getElementById('subtask-tab-budget'),
            budgetToggle: document.getElementById('subtask-budget-toggle'),
            budgetDetails: document.getElementById('subtask-budget-details'),
            budgetItemsList: document.getElementById('subtask-budget-items'),
            addBudgetItemBtn: document.getElementById('subtask-add-budget-item-btn'),
            
            // Osoby
            assigneesList: document.getElementById('subtask-modal-assignees-list'), // Lewa kolumna
            selectedList: document.getElementById('subtask-selected-list'),         // Prawa kolumna (NOWE)
            memberSearchInput: document.getElementById('subtask-member-search'),
            memberSearchResults: document.getElementById('subtask-member-search-results'),
            
            // Zaczniki
            attachmentInput: document.getElementById('subtask-attachment-input'),
            addAttachmentBtn: document.getElementById('add-subtask-attachment-btn'),
            attachmentsList: document.getElementById('subtask-attachments-list'),
            
            // Komentarze
            commentInput: document.getElementById('subtask-new-comment'),
            commentsList: document.getElementById('subtask-comments-list'),
            addCommentBtn: document.getElementById('subtask-add-comment-btn'),
            
            // Lista kontrolna
            checklistToggle: document.getElementById('subtask-checklist-toggle'),
            checklistWrapper: document.getElementById('subtask-checklist-wrapper'),
            checklistItemsList: document.getElementById('subtask-checklist-items'),
            addChecklistItemBtn: document.getElementById('add-checklist-item-btn'),
            checklistError: document.getElementById('subtask-checklist-error'),
            
            // NOWE: Referencja do selecta statusu
            statusSelect: document.getElementById('subtask-status-select'),

            // === NOWE REFERENCJE DLA PRIORYTETU I OSTRZE呕E (PODZADANIE) ===
            prioritySelect: document.getElementById('subtask-priority-select'),
            warningOverride: document.getElementById('subtask-warning-override'),
            warningWrapper: document.getElementById('subtask-warning-wrapper'),
            warningDaysInput: document.getElementById('subtask-warning-days'),

            // Przyciski
            saveBtn: document.getElementById('subtask-save-btn'),
            
            // === TU JEST BRAKUJCY PRZYCISK ===
            finishBtn: document.getElementById('finish-subtask-btn')
        };

        // === NOWE LISTENERY UI DLA PODZADANIA (Wklejone w poprawne miejsce - PO definicji obiektu) ===
        if (subtaskModal.warningOverride) {
            subtaskModal.warningOverride.addEventListener('change', () => {
                subtaskModal.warningWrapper.style.display = subtaskModal.warningOverride.checked ? 'block' : 'none';
            });
        }

        // === NOWY LISTENER: Obsuga zakadek w modalu podzadania ===
        subtaskModal.tabsContainer.addEventListener('click', (e) => {
            const tabBtn = e.target.closest('.task-modal-tab');
            if (!tabBtn) return;

            // 1. Deaktywuj wszystkie
            subtaskModal.tabsContainer.querySelectorAll('.task-modal-tab').forEach(btn => btn.classList.remove('active'));
            subtaskModal.contentsContainer.querySelectorAll('.task-modal-tab-content').forEach(content => content.classList.remove('active'));

            // 2. Aktywuj kliknity
            tabBtn.classList.add('active');
            const tabName = tabBtn.dataset.tab;
            const contentId = `subtask-tab-content-${tabName}`;
            const contentDiv = document.getElementById(contentId);
            if (contentDiv) {
                contentDiv.classList.add('active');
            }
        });
        // === KONIEC NOWYCH REFERENCJI ===
        // NOWE REFERENCJE DO FORMULARZA REJESTRACJI
        const registerTeamToggle = document.getElementById('register-team-toggle');
        const registerTeamOptions = document.getElementById('register-team-options');
        const registerGroupNameInput = document.getElementById('register-group-name');
        const registerSubgroupSection = document.getElementById('register-subgroup-section');
        const registerSubgroupSelect = document.getElementById('register-subgroup-select');
        const registerNewSubgroupSection = document.getElementById('register-new-subgroup-section');
        const registerNewSubgroupNameInput = document.getElementById('register-new-subgroup-name');
        const changePasswordModal = {
    overlay: document.getElementById('change-password-modal'),
    form: document.getElementById('change-password-form'),
    currentPassword: document.getElementById('current-password'),
    newPassword: document.getElementById('new-password'),
    confirmPassword: document.getElementById('confirm-password'),
    error: document.getElementById('change-password-error'),
};
       

        // NOWY MODAL: Szczeg贸y zada z Dashboardu
        const dashboardDetailsModal = {
            overlay: document.getElementById('dashboard-details-modal'),
            title: document.getElementById('dashboard-details-title'),
            content: document.getElementById('dashboard-details-content'),
        };
         const manageGroupModal = {
            overlay: document.getElementById('manage-group-modal'),
            subgroupsList: document.getElementById('subgroups-list'),
            addSubgroupForm: document.getElementById('add-subgroup-form'),
            newSubgroupNameInput: document.getElementById('new-subgroup-name-input')
        };
        
        // 尖尖 DODAJ BRAKUJC LINI PONI呕EJ 尖尖
        const openManageGroupBtn = document.getElementById('open-manage-group-btn');
        const openChangeSubgroupBtn = document.getElementById('open-change-subgroup-btn');
        // --- Definicje wszystkich funkcji ---
       // === NOWE REFERENCJE DLA MODALA AI ===
        const aiHelpModal = {
            // ZMIENIONO: 'overlay' na 'sidebar' i ID na 'ai-chat-sidebar'
            sidebar: document.getElementById('ai-chat-sidebar'), 
            form: document.getElementById('ai-help-form'),
            openBtn: document.getElementById('open-ai-help-btn'),
            // DODANO: Referencja do przycisku zamykania
            closeBtn: document.getElementById('ai-chat-close-btn'), 
            container: document.getElementById('ai-chat-container'),
            input: document.getElementById('ai-chat-input'),
            sendBtn: document.getElementById('ai-chat-send-btn'),
            // === DODANE NOWE REFERENCJE GOSOWE ===
            micBtn: document.getElementById('ai-chat-mic-btn'),
            statusBar: document.getElementById('ai-chat-status-bar')
            // === KONIEC DODANYCH REFERENCJI ===
        };
        // === KONIEC NOWYCH REFERENCJI ===
       // === NOWE REFERENCJE DLA MODALA ZAPROSZENIA ===
       
        const inviteMemberModal = {
            overlay: document.getElementById('invite-member-modal'),
            form: document.getElementById('invite-member-form'),
            emailInput: document.getElementById('invite-member-email'),
            error: document.getElementById('invite-member-error'),
            submitBtn: document.querySelector('#invite-member-form button[type="submit"]')
        };
        // === KONIEC NOWYCH REFERENCJI ===
        const myDayNav = {
            container: document.getElementById('my-day-nav'),
            prevBtn: document.getElementById('my-day-prev'),
            nextBtn: document.getElementById('my-day-next'),
            todayBtn: document.getElementById('my-day-today'),
            dateDisplay: document.getElementById('my-day-date-display'),
        };
     const myDayNavMobile = {
            container: document.getElementById('my-day-nav-mobile'),
            prevBtn: document.getElementById('my-day-prev-mobile'),
            nextBtn: document.getElementById('my-day-next-mobile'),
            todayBtn: document.getElementById('my-day-today-mobile'),
            dateDisplay: document.getElementById('my-day-date-display-mobile'),
        };
       const settingsModal = {
        overlay: document.getElementById('settings-modal'),
        avatarWrapper: document.getElementById('settings-avatar-wrapper'),
        avatarPreview: document.getElementById('settings-avatar-preview'),
        nameInput: document.getElementById('settings-name'),
        emailInput: document.getElementById('settings-email'),
        subgroupSelect: document.getElementById('settings-subgroup'),
        // DODANO: Referencja do obecnego hasa
        currentPasswordInput: document.getElementById('settings-current-password'), 
        newPasswordInput: document.getElementById('settings-new-password'),
        confirmPasswordInput: document.getElementById('settings-confirm-password'),
        confirmPasswordGroup: document.getElementById('settings-confirm-password-group'),
        saveBtn: document.getElementById('settings-save-btn')
    };
    
    // Zmienna tymczasowa na zdjcie (Blob) - przechowuje zdjcie zanim klikniesz "Zapisz"
    let tempProfileBlob = null;
       // === POCZTEK ZMIANY: Referencje do modala powitalnego ===
       const welcomeModal = {
            overlay: document.getElementById('welcome-modal'),
            okBtn: document.getElementById('welcome-modal-ok-btn'),
            dontShowCheckbox: document.getElementById('welcome-modal-dont-show-again')
       };
       // === KONIEC ZMIANY ===
       // --- Definicje ikon ---
        const SVG_BUDGET_ICON = `
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64" width="24" height="24" role="img" aria-labelledby="titleDesc">
                <style>
                    /* Dostosowanie kolor贸w dynamicznych */
                    .bg-main { fill: #F2C76B; stroke: currentColor; }
                    .bg-accent { fill: var(--icon-accent-light); stroke: currentColor; }
                    .stroke { fill: none; stroke: currentColor; stroke-width: 2; }
                    .text-fill { fill: currentColor; }
                </style>
                <rect x="10" y="20" width="44" height="28" rx="3" ry="3" class="bg-main" stroke-width="2"/>
                <rect x="14" y="24" width="44" height="28" rx="3" ry="3" class="bg-accent" stroke-width="2"/>
                <circle cx="36" cy="38" r="12" class="stroke" stroke-width="2"/>
                <text x="36" y="38" text-anchor="middle" dominant-baseline="central"
                        font-family="Segoe UI, Arial, sans-serif" font-size="22" font-weight="700" class="text-fill">$</text>
            </svg>
        `;
       // === NOWA IKONA OSTRZE呕ENIA ===
        const SVG_WARNING_ICON = `
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24" role="img" aria-labelledby="warnTitleFilled">
          <title id="warnTitleFilled">Ostrze偶enie - nadchodzcy termin zadania</title>
          <path d="M1 21h22L12 2 1 21z" fill="#FFD54F" />
          <rect x="11" y="7" width="2" height="7" rx="1" fill="#212121"/>
          <circle cx="12" cy="17.5" r="1.25" fill="#212121"/>
        </svg>`;
        // === KONIEC ===
       // --- Koniec Definicji ikon ---
       const taskModal = {
        overlay: document.getElementById('task-modal'),
        title: document.getElementById('modal-task-title'),
        completed: document.getElementById('modal-task-completed'),
        description: document.getElementById('modal-task-description'),
        status: document.getElementById('modal-task-status'),
        assigneesList: document.getElementById('modal-task-assignees-list'),
        completionStatusSection: document.getElementById('modal-completion-status-section'),
        completionStatusList: document.getElementById('modal-completion-status-list'),
        priority: document.getElementById('modal-task-priority'),
        attachmentsList: document.getElementById('attachments-list'),
        addAttachmentBtn: document.getElementById('add-attachment-btn'),
        attachmentFileInput: document.getElementById('attachment-file-input'),
        uploadStatus: document.getElementById('upload-status'),
        
        // Pola dat
        startDateDate: document.getElementById('modal-task-startDate-date'),
        startDateHour: document.getElementById('modal-task-startDate-hour'),
        startDateMinute: document.getElementById('modal-task-startDate-minute'),
        dueDateDate: document.getElementById('modal-task-dueDate-date'),
        dueDateHour: document.getElementById('modal-task-dueDate-hour'),
        dueDateMinute: document.getElementById('modal-task-dueDate-minute'),
        
        saveBtn: document.getElementById('save-task-btn'),
        deleteBtn: document.getElementById('delete-task-btn'),
        editBtn: document.getElementById('edit-task-btn'),
        titleInput: document.getElementById('modal-task-title-input'),
        
        // Akordeon i Wzmianki
        assigneesContainer: document.getElementById('modal-task-assignees-accordion'), // Lewa kolumna
        selectedList: document.getElementById('modal-task-selected-list'),             // Prawa kolumna (NOWE)
        memberSearchInput: document.getElementById('modal-task-member-search'),
        memberSearchResults: document.getElementById('modal-task-member-search-results'),
        
        commentsList: document.getElementById('comments-list'),
        newCommentText: document.getElementById('new-comment-text'),
        addCommentBtn: document.getElementById('add-comment-btn'),
        activityList: document.getElementById('activity-list'),
        isRecurring: document.getElementById('modal-task-is-recurring'),
        recurrenceOptions: document.getElementById('modal-task-recurrence-options'),
        recurrenceType: document.getElementById('modal-task-recurrence-type'),
        recurrenceDayWrapper: document.getElementById('modal-task-recurrence-day-wrapper'),
        moveBtn: document.getElementById('move-task-btn'),
        recurrenceDay: document.getElementById('modal-task-recurrence-day'),
        okBtn: document.getElementById('ok-task-btn'),
        
        // Bud偶et
        budgetToggle: document.getElementById('modal-task-budget-toggle'),
        budgetDetails: document.getElementById('modal-task-budget-details'),
        budgetItemsList: document.getElementById('modal-task-budget-items'),
        addBudgetItemBtn: document.getElementById('modal-task-add-budget-item-btn'),
        budgetTotalSpan: document.getElementById('modal-task-budget-total'),
        budgetCurrencySpan: document.getElementById('modal-task-budget-currency'),
        budgetErrorP: document.getElementById('modal-task-budget-error'),
        budgetTabButton: document.getElementById('task-tab-taskBudget'),
        
        // Wysiek
        effortTabButton: document.getElementById('task-tab-effort'),
        effortLabel: document.getElementById('modal-task-effort-label'),
        effortInput: document.getElementById('modal-task-effort-input'),
        effortUnit: document.getElementById('modal-task-effort-unit'),
        actualEffortLabel: document.getElementById('modal-task-actual-effort-label'),
        actualEffortInput: document.getElementById('modal-task-actual-effort-input'),
        actualEffortUnit: document.getElementById('modal-task-actual-effort-unit'),

        // Ostrze偶enia
        warningOverride: document.getElementById('modal-task-warning-override'),
        warningWrapper: document.getElementById('modal-task-warning-wrapper'),
        warningDaysInput: document.getElementById('modal-task-warning-days'),
        
        // === TU JEST KLUCZOWY PRZYCISK ===
        finishBtn: document.getElementById('finish-task-btn') 
    };
       // --- INICJALIZACJA EDYTORW RICH TEXT ---
    let editorTaskDescription = null;
    let editorNewTaskDescription = null;
    let editorSubtaskDescription = null;
    let editorTemplateDescription = null;

    // Inicjalizujemy je od razu
    editorTaskDescription = new SimpleRichTextEditor('modal-task-description');
    editorNewTaskDescription = new SimpleRichTextEditor('new-task-description');
    editorSubtaskDescription = new SimpleRichTextEditor('subtask-description');
    // Opcjonalnie dla edytora szablon贸w:
    editorTemplateDescription = new SimpleRichTextEditor('template-edit-description');
       // Funkcja pomocnicza do renderowania wiersza listy kontrolnej
        function addChecklistItemUI(itemData = {}, isDisabled = false) {
    const li = document.createElement('li');
    const isCompleted = itemData.isCompleted || false;
    
    // Dodaj klas completed od razu
    li.className = `checklist-item-row ${isCompleted ? 'completed' : ''}`;
    
    // Generowanie unikalnych ID
    const uniqueId = Date.now() + Math.random().toString(36).substr(2, 5);
    const searchInputId = `checklist-search-${uniqueId}`;
    const resultsListId = `checklist-results-${uniqueId}`;
    
    const name = itemData.name || '';
    const date = itemData.date || '';
    const assigneeId = itemData.assigneeId || null;
    
    let assigneePillHTML = '';
    let wrapperClass = 'checklist-search-wrapper checklist-assignee-wrapper';
    let searchDisplay = 'block';
    
    if (assigneeId) {
        const user = findUser(assigneeId);
        if (user) {
            assigneePillHTML = `
                <div class="checklist-assignee-pill" data-user-id="${user.id}">
                    ${renderAvatarHTML(user, 'member-pill-avatar')}
                    <span>${user.name || user.email}</span>
                    <span class="remove-checklist-assignee" style="cursor:pointer; margin-left:4px; color:var(--text-secondary);" title="Usu">&times;</span>
                </div>
            `;
            wrapperClass += ' has-assignee';
            searchDisplay = 'none'; 
        }
    }

    // Ikonka flagi
    const flagIcon = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 3v1.5M3 21v-6m0 0l2.77-.693a9 9 0 0 1 6.208.682l.108.054a9 9 0 0 0 6.086.71l3.114-.732a48.524 48.524 0 0 1-.005-10.499l-3.11.732a9 9 0 0 1-6.085-.711l-.108-.054a9 9 0 0 0-6.208-.682L3 4.5M3 15V4.5" /></svg>`;

    // === NOWA LOGIKA: Pobranie ogranicze daty z formularza podzadania ===
    const minDate = subtaskModal.startDateDate.value || '';
    const maxDate = subtaskModal.dueDateDate.value || '';
    // === KONIEC ===

    // ZMIANA: Dodano obsug isDisabled w inpucie
    li.innerHTML = `
        <div class="checklist-row-top">
            <input type="checkbox" class="checklist-checkbox" 
                   ${isCompleted ? 'checked' : ''} 
                   ${isDisabled ? 'disabled' : ''} 
                   style="${isDisabled ? 'cursor: not-allowed; opacity: 0.6;' : ''}">
            <input type="text" class="checklist-input-name" placeholder="Wpisz tre zadania..." value="${name}" required>
            <button type="button" class="checklist-delete-btn" title="Usu pozycj">&times;</button>
        </div>

        <div class="checklist-row-bottom">
            <div class="checklist-date-wrapper" title="Termin wykonania">
                ${flagIcon}
                <input type="date" class="checklist-input-date" value="${date}" min="${minDate}" max="${maxDate}">
            </div>

            <div class="${wrapperClass}">
                 <input type="text" id="${searchInputId}" class="member-search-input" placeholder="Przypisz..." style="display: ${searchDisplay};">
                 <ul id="${resultsListId}" class="member-search-results" style="top: 30px; right: 0; width: 200px;"></ul>
                 <div class="checklist-assignee-container">${assigneePillHTML}</div>
            </div>
        </div>
    `;
    
    subtaskModal.checklistItemsList.appendChild(li);
            
            // --- LISTENERY DLA TEGO WIERSZA ---

            // 1. Checkbox - zmiana koloru
            const checkbox = li.querySelector('.checklist-checkbox');
            checkbox.addEventListener('change', function() {
                if (this.checked) li.classList.add('completed');
                else li.classList.remove('completed');
            });

            // 2. Wyszukiwarka os贸b (Logika identyczna jak wczeniej)
            const searchInput = li.querySelector(`#${searchInputId}`);
            const resultsList = li.querySelector(`#${resultsListId}`);
            const pillContainer = li.querySelector('.checklist-assignee-container');
            const wrapper = li.querySelector('.checklist-search-wrapper');

            searchInput.addEventListener('input', (e) => {
                const term = e.target.value.toLowerCase().trim();
                if (term.length < 1) {
                    resultsList.classList.remove('visible');
                    return;
                }
                const matches = state.users.filter(u => (u.name || '').toLowerCase().includes(term) || (u.email || '').toLowerCase().includes(term));
                
                if (matches.length === 0) {
                    resultsList.innerHTML = '<li style="padding:4px; font-size:11px;">Brak wynik贸w</li>';
                } else {
                    resultsList.innerHTML = matches.map(u => `
                        <li class="member-search-item" style="cursor:pointer;" data-user-id="${u.id}">
                           <div class="member-search-info" style="font-size:11px;">
                               ${renderAvatarHTML(u, 'avatar-comment')} ${u.name || u.email}
                           </div>
                        </li>
                    `).join('');
                }
                resultsList.classList.add('visible');
            });
            
            resultsList.addEventListener('click', (e) => {
                const item = e.target.closest('.member-search-item');
                if (item) {
                    const userId = item.dataset.userId;
                    const user = findUser(userId);
                    if (user) {
                        pillContainer.innerHTML = `
                            <div class="checklist-assignee-pill" data-user-id="${user.id}">
                                ${renderAvatarHTML(user, 'member-pill-avatar')}
                                <span>${user.name || user.email}</span>
                                <span class="remove-checklist-assignee" style="cursor:pointer; margin-left:4px; color:var(--text-secondary);">&times;</span>
                            </div>
                        `;
                        wrapper.classList.add('has-assignee');
                        searchInput.style.display = 'none';
                        searchInput.value = '';
                        resultsList.classList.remove('visible');
                    }
                }
            });
            
            pillContainer.addEventListener('click', (e) => {
                if (e.target.classList.contains('remove-checklist-assignee')) {
                    pillContainer.innerHTML = '';
                    wrapper.classList.remove('has-assignee');
                    searchInput.style.display = 'block';
                    searchInput.focus();
                }
            });

            document.addEventListener('click', (e) => {
                if (!wrapper.contains(e.target)) {
                    resultsList.classList.remove('visible');
                }
            });
        }
        // === NOWE LISTENERY: Obsuga UI indywidualnych ostrze偶e ===
        
        // 1. Dla Nowego Zadania
        if (newTaskModal.warningOverride) {
            newTaskModal.warningOverride.addEventListener('change', () => {
                newTaskModal.warningWrapper.style.display = newTaskModal.warningOverride.checked ? 'block' : 'none';
            });
        }

        // 2. Dla Edycji Zadania
        if (taskModal.warningOverride) {
            taskModal.warningOverride.addEventListener('change', () => {
                taskModal.warningWrapper.style.display = taskModal.warningOverride.checked ? 'block' : 'none';
            });
        }

        // 3. Dla Podzadania
        if (subtaskModal.warningOverride) {
            subtaskModal.warningOverride.addEventListener('change', () => {
                subtaskModal.warningWrapper.style.display = subtaskModal.warningOverride.checked ? 'block' : 'none';
            });
        }
        // === KONIEC NOWYCH LISTENERW ===
        // Listener przycisku "Dodaj element listy"
        subtaskModal.addChecklistItemBtn.addEventListener('click', () => {
            addChecklistItemUI();
        });
        
        // Listener usuwania wiersza
        subtaskModal.checklistItemsList.addEventListener('click', (e) => {
            if (e.target.classList.contains('checklist-delete-btn')) {
                e.target.closest('li').remove();
            }
        });
        
        // Listener przecznika "Wcz list"
        subtaskModal.checklistToggle.addEventListener('change', () => {
            subtaskModal.checklistWrapper.style.display = subtaskModal.checklistToggle.checked ? 'block' : 'none';
            if(subtaskModal.checklistToggle.checked && subtaskModal.checklistItemsList.children.length === 0) {
                addChecklistItemUI(); // Dodaj jeden pusty wiersz na start
            }
        });
       // === NOWA FUNKCJA: Aktualizacja ogranicze dat w licie kontrolnej ===
        function updateChecklistDateConstraints() {
            const minDate = subtaskModal.startDateDate.value;
            const maxDate = subtaskModal.dueDateDate.value;
            
            // Znajd藕 wszystkie inputy daty w licie kontrolnej
            const dateInputs = subtaskModal.checklistItemsList.querySelectorAll('.checklist-input-date');
            
            dateInputs.forEach(input => {
                if (minDate) input.min = minDate;
                else input.removeAttribute('min');
                
                if (maxDate) input.max = maxDate;
                else input.removeAttribute('max');
                
                // Opcjonalnie: Walidacja wizualna, jeli obecna data wykracza poza nowy zakres
                if (input.value) {
                    if ((minDate && input.value < minDate) || (maxDate && input.value > maxDate)) {
                        input.style.color = 'var(--danger-primary)'; // Oznacz na czerwono jako bd
                    } else {
                        input.style.color = 'var(--text-secondary)'; // Przywr贸 kolor
                    }
                }
            });
        }

        // Podpicie listener贸w pod zmian dat podzadania
        subtaskModal.startDateDate.addEventListener('change', updateChecklistDateConstraints);
        subtaskModal.dueDateDate.addEventListener('change', updateChecklistDateConstraints);
        // === KONIEC NOWEJ FUNKCJI ===
        function initializeCalendar() {
            if (calendarInstance) {
                calendarInstance.destroy();
            }
            const isMobile = window.innerWidth < 768;
            const calendar = new FullCalendar.Calendar(calendarViewEl, {
                locale: 'pl',
                initialView: isMobile ? 'listWeek' : 'timeGridWeek', 
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: isMobile ? 'listWeek,dayGridMonth' : 'dayGridMonth,timeGridWeek,timeGridDay' 
                },
                buttonText: {
                    today: 'Dzisiaj',
                    month: 'Miesic',
                    timeGridWeek: 'Tydzie', 
                    timeGridDay: 'Dzie',
                    listWeek: 'Agenda'
                },
                events: [],
                editable: false,
                eventClick: function(info) {
                    openTaskModal(info.event.id);
                },
                // ================== NOWY HOOK ==================
                eventDidMount: function(info) {
                    tippy(info.el, {
                        // Tworzy tre dymka w HTML, pobierajc dane z extendedProps
                        content: `
                            <div style="text-align: left; padding: 4px;">
                                <div><strong>Projekt:</strong> ${info.event.extendedProps.projectName}</div>
                                <div><strong>Waciciel:</strong> ${info.event.extendedProps.ownerName}</div>
                                <hr style="margin: 4px 0; border-color: #ddd;">
                                <div><strong>Zadanie:</strong> ${info.event.title}</div>
                                <div style="margin-top: 4px;"><em>${info.event.extendedProps.description}</em></div>
                            </div>
                        `,
                        // Pozwala na u偶ycie HTML w treci dymka
                        allowHTML: true,
                    });
                },
                nowIndicator: true, 
                allDaySlot: false, 
                slotMinTime: '06:00:00', 
                slotMaxTime: '22:00:00',
                eventDisplay: 'block'
            });
            calendarInstance = calendar;
            calendar.render();
        }

        function calculateNextDueDate(currentDueDate, recurrenceRule) {
            const baseDate = currentDueDate ? new Date(currentDueDate) : new Date();
            const options = {
                dtstart: baseDate,
                tzid: 'Europe/Warsaw'
            };
            switch (recurrenceRule.type) {
                 case 'daily': // <-- DODANA TA LINIA
                    options.freq = RRule.DAILY; // <-- DODANA TA LINIA
                    options.interval = 1; // <-- DODANA TA LINIA
                    break; // <-- DODANA TA LINIA
                case 'weekly':
                    options.freq = RRule.WEEKLY;
                    options.interval = 1;
                    break;
                case 'biweekly':
                    options.freq = RRule.WEEKLY;
                    options.interval = 2;
                    break;
                case 'monthly':
                    options.freq = RRule.MONTHLY;
                    options.interval = 1;
                    break;
                case 'dayOfMonth':
                    options.freq = RRule.MONTHLY;
                    options.bymonthday = recurrenceRule.day;
                    break;
                case 'nthDayOfMonth':
                    options.freq = RRule.MONTHLY;
                    options.bysetpos = parseInt(recurrenceRule.nth);
                    const weekdays = [RRule.MO, RRule.TU, RRule.WE, RRule.TH, RRule.FR, RRule.SA, RRule.SU];
                    options.byweekday = weekdays[parseInt(recurrenceRule.weekday)];
                    break;
                default:
                    return null;
            }
            const rule = new RRule(options);
            const nextDate = rule.after(baseDate);
            if (!nextDate) return null;
            const pad = (num) => num.toString().padStart(2, '0');
            return `${nextDate.getFullYear()}-${pad(nextDate.getMonth() + 1)}-${pad(nextDate.getDate())}T${pad(baseDate.getHours())}:${pad(baseDate.getMinutes())}`;
        }
        function renderAvatarHTML(user, additionalClass = '') {
    if (!user) return '';
    const baseClass = `avatar ${additionalClass}`;

    if (user.photoURL) {
        // Jeli jest zdjcie, u偶yj tagu <img>
        return `<img src="${user.photoURL}" alt="${user.name || user.email}" class="${baseClass}" title="${user.name || user.email}">`;
    } else {
        // Jeli nie, u偶yj inicja贸w w <div>
        const initials = (user.name || user.email).substring(0, 2).toUpperCase();
        const color = user.avatarColor || '#ccc';
        return `<div class="${baseClass}" style="background-color: ${color}" title="${user.name || user.email}">${initials}</div>`;
    }
}

        function renderAttachments(task) {
            taskModal.attachmentsList.innerHTML = '';
            if (!task.attachments || task.attachments.length === 0) {
                taskModal.attachmentsList.innerHTML = '<li><small>Brak zacznik贸w.</small></li>';
                return;
            }

            const currentCoverUrl = task.coverImage ? task.coverImage.url : null;

            task.attachments.forEach(att => {
                const li = document.createElement('li');
                li.className = 'attachment-item';
                li.dataset.attachmentId = att.id;

                // Sprawdzenie, czy zacznik jest obrazkiem (po rozszerzeniu)
                const isImage = /\.(jpe?g|png|gif|webp)$/i.test(att.name);
                let coverButtonsHTML = '';

                if (isImage) {
                    // Sprawdzamy, czy TEN zacznik jest OBECN okadk
                    // Por贸wnujemy URL, zakadajc, 偶e URL oryginau jest inny ni偶 URL okadki (po przyciciu)
                    // Bezpieczniej jest por贸wna cie偶k do oryginau, jeli j zapiszemy
                    // Na razie sprawdzimy, czy URL okadki (task.coverImage.url) jest R呕NY od URL zacznika (att.url)
                    // ALE PROSTSZE: Sprawdzamy, czy cie偶ka okadki (jeli istnieje) jest inna ni偶 cie偶ka zacznika
                    const isCurrentCover = currentCoverUrl && task.coverImage.originalPath === att.path;

                    if (isCurrentCover) {
                        // Ten obrazek JEST okadk. Poka偶 przycisk "Usu okadk".
                        coverButtonsHTML = `
                            <div class="attachment-actions-cover">
                                <button class="btn-cover-action remove-cover-image-btn" data-task-id="${task.id}" title="Usu banner z kafelka"> U偶yty jako banner</button>
                            </div>
                        `;
                    } else {
                        // To jest obrazek, ale NIE JEST okadk. Poka偶 przycisk "Ustaw jako okadk".
                        coverButtonsHTML = `
                            <div class="attachment-actions-cover">
                                <button class="btn-cover-action set-cover-image-btn" data-task-id="${task.id}" data-attachment-url="${att.url}" data-attachment-path="${att.path}" data-attachment-name="${att.name}">Ustaw jako banner</button>
                            </div>
                        `;
                    }
                }

                let deleteBtnHTML = '';
                if (task.createdBy === state.currentUser.uid || att.uploadedBy === state.currentUser.uid) {
                    deleteBtnHTML = `<button class="delete-attachment-btn" title="Usu zacznik">&times;</button>`;
                }

                // Zmieniona struktura HTML, aby u偶ywa flexbox dla kontrolek
                li.innerHTML = `
                    <div class="attachment-info">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M18.375 12.739l-7.693 7.693a4.5 4.5 0 01-6.364-6.364l10.94-10.94A3 3 0 1119.5 7.372L8.552 18.32m.009-.01l-.01.01m5.699-9.4l-7.693 7.693a2.25 2.25 0 003.182 3.182l7.693-7.693a.75.75 0 011.06 1.06l-7.693 7.693a4.5 4.5 0 01-6.364-6.364l10.94-10.94A3 3 0 1119.5 7.372L8.552 18.32" /></svg>
                        <a href="${att.url}" target="_blank" rel="noopener noreferrer" class="attachment-name" title="Pobierz plik">${att.name}</a>
                    </div>
                    <div class="attachment-item-controls">
                        ${coverButtonsHTML}
                        ${deleteBtnHTML}
                    </div>
                `;
                taskModal.attachmentsList.appendChild(li);
            });
        }
       /**
         * NOWA FUNKCJA POMOCNICZA: Uniwersalne wysyanie powiadomie
         * @param {Array<string>} recipientIds - Tablica ID u偶ytkownik贸w, kt贸rzy maj dosta powiadomienie.
         * @param {string} type - Typ powiadomienia (np. 'task_assigned', 'mention', 'alert', 'unlock').
         * @param {string} message - Tre HTML powiadomienia.
         * @param {object} linkData - Obiekt linku { type: 'task'|'project'|'poll', projectId, taskId, ... }
         */
        // ZMIANA: Dodano parametr preferenceKey na kocu
        async function sendInternalNotification(recipientIds, type, message, linkData, preferenceKey = null) {
            // 1. Filtrujemy: nie wysyaj do samego siebie i usu duplikaty
            let uniqueRecipients = [...new Set(recipientIds)].filter(id => id !== state.currentUser.uid);
            
            // === NOWA LOGIKA: Filtrowanie po preferencjach ===
            if (preferenceKey) {
                uniqueRecipients = uniqueRecipients.filter(userId => {
                    const user = findUser(userId);
                    // Jeli nie ma usera w stanie (np. niezaadowany), wylij domylnie.
                    // Jeli user ma ustawienia, sprawd藕 klucz. Domylnie true (jeli undefined).
                    if (user && user.preferences && user.preferences.notifications) {
                        const prefValue = user.preferences.notifications[preferenceKey];
                        return prefValue !== false; // Domylnie wczone
                    }
                    return true; // Domylnie wczone jeli brak ustawie
                });
            }
            // === KONIEC NOWEJ LOGIKI ===

            if (uniqueRecipients.length === 0) {
                console.log(`[Notification] Wstrzymano wysyanie (${type}) - brak odbiorc贸w lub wyczone w ustawieniach.`);
                return;
            }

            console.log(`[Notification] Wysyanie typu '${type}' do: ${uniqueRecipients.length} os贸b (Key: ${preferenceKey}).`);

            try {
                const batch = writeBatch(db);
                const notificationsRef = collection(db, `artifacts/${appId}/public/data/notifications`);

                uniqueRecipients.forEach(userId => {
                    const newNotifRef = doc(notificationsRef);
                    batch.set(newNotifRef, {
                        userId: userId,
                        creatorId: state.currentUser.uid,
                        groupId: state.ui.activeGroupId,
                        type: type,
                        message: message,
                        isRead: false,
                        timestamp: Date.now(),
                        link: linkData || null
                    });
                });

                await batch.commit();
            } catch (error) {
                console.error("Bd wysyania powiadomie:", error);
            }
        }
  function createMyDayTaskItemHTML(task) {
      console.log("Renderuj zadanie:", task);
            const isCompleted = task.status === 'done';
            const statusText = STATUSES[task.status] || 'Nieznany';
            const completedClass = isCompleted ? 'completed' : '';
            // For completed tasks, the pill and border will always be green
            const statusClassForVisuals = isCompleted ? 'status-done' : `status-${task.status}`;

            const assigneesHTML = (task.assignees || [])
                .map(assigneeId => findUser(assigneeId))
                .filter(Boolean)
                .map(user => renderAvatarHTML(user))
                .join('');
            
            const dueDate = new Date(task.dueDate);
            // Correctly format the full date and time
            const dateTimeString = dueDate.toLocaleString('pl-PL', { day: 'numeric', month: 'long', hour: '2-digit', minute: '2-digit' });
            const isOverdue = new Date(task.dueDate).getTime() < new Date().setHours(0,0,0,0) && !isCompleted;

            return `
               <li class="my-day-task-item ${statusClassForVisuals} ${completedClass}" data-task-id="${task.id}">
                    <input type="checkbox" class="task-card-checkbox" data-task-id="${task.id}" ${isCompleted ? 'checked' : ''}>
                    <div class="my-day-task-item-content">
                        <div class="my-day-task-item-header">
                            <h4 class="my-day-task-item-title">${task.title}</h4>
                            <span class="task-status-pill ${statusClassForVisuals}">${statusText}</span>
                        </div>
                        <div class="my-day-task-item-meta">
                            <div class="my-day-project-name">
                                Z grupy: <strong style="color: var(--text-primary);">${task.groupName}</strong> | Z projektu: <a href="#" data-project-id="${task.projectId}">${task.projectName}</a>
                                | Termin: <span style="${isOverdue ? 'color: var(--danger-primary); font-weight: 600;' : ''}">${dateTimeString}</span>
                            </div>
                            <div class="task-assignees">${assigneesHTML}</div>
                        </div>
                    </div>
                </li>
            `;
        }
        function renderMyDayView() {
            const selectedDate = new Date(state.ui.myDayDate);
            const formattedDate = selectedDate.toLocaleDateString('pl-PL', { day: 'numeric', month: 'short' });
            
            if(myDayNav.dateDisplay) {
                myDayNav.dateDisplay.textContent = selectedDate.toLocaleDateString('pl-PL', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
            }
             if(myDayNavMobile.dateDisplay) {
                myDayNavMobile.dateDisplay.textContent = formattedDate;
            }
            
            projectMembersHeaderEl.innerHTML = '';
            
            // === NAPRAWA BDU: Ukrywanie nowych element贸w zamiast starych ===
            if (projectMenuToggle) projectMenuToggle.style.display = 'none';
            if (projectProgressContainer) projectProgressContainer.style.display = 'none';
            // === KONIEC NAPRAWY ===
            
            // ZMIANA: Dodajemy klas my-day-view, aby aktywowa centrowanie z CSS
            kanbanBoardEl.className = 'my-day-view'; 
            // ZMIANA: Usuwamy atrybut style, bo widoczno bdzie kontrolowana poni偶ej
            kanbanBoardEl.removeAttribute('style');

            // === GWNA ZMIANA: U偶ywamy nowej, globalnej funkcji ===
            const myTasks = getGlobalAllMyTasks();
            // === KONIEC GWNEJ ZMIANY ===
            const selectedDateStartOfDay = new Date(state.ui.myDayDate);
            selectedDateStartOfDay.setHours(0, 0, 0, 0);

            const overdueTasks = myTasks.filter(task => task.dueDate && task.status !== 'done' && new Date(task.dueDate) < selectedDateStartOfDay);
            const activeTasksForDate = myTasks.filter(task => task.dueDate && task.status !== 'done' && task.dueDate.startsWith(state.ui.myDayDate));
            const completedTasksForDate = myTasks.filter(task => task.dueDate && task.status === 'done' && task.dueDate.startsWith(state.ui.myDayDate));
            const emptyStateEl = document.getElementById('my-day-empty-state'); // NOWA REFERENCJA

            overdueTasks.sort((a, b) => new Date(a.dueDate).getTime() - new Date(b.dueDate).getTime());
            activeTasksForDate.sort((a, b) => new Date(a.dueDate).getTime() - new Date(b.dueDate).getTime());
            completedTasksForDate.sort((a, b) => new Date(a.dueDate).getTime() - new Date(b.dueDate).getTime());
            
            if (overdueTasks.length === 0 && activeTasksForDate.length === 0 && completedTasksForDate.length === 0) {
                // ZMIANA: Ukryj kanbanBoardEl i poka偶 nowy pusty stan
                kanbanBoardEl.style.display = 'none';
                // U偶ywamy 'grid', aby aktywowa centrowanie zdefiniowane w CSS (place-items: center)
                if (emptyStateEl) emptyStateEl.style.display = 'grid'; 
            } else {
                // ZMIANA: Poka偶 kanbanBoardEl jako Flex kontener (aby jego dzieci byy centrowane w poziomie) i ukryj pusty stan
                kanbanBoardEl.style.display = 'flex';
                if (emptyStateEl) emptyStateEl.style.display = 'none';
                
                let html = '';
                if (overdueTasks.length > 0) {
                    html += `<li class="my-day-separator">Zalege (${overdueTasks.length})</li>`;
                    html += overdueTasks.map(task => createMyDayTaskItemHTML(task)).join('');
                }
                if (activeTasksForDate.length > 0) {
                    html += `<li class="my-day-separator">Do zrobienia (${activeTasksForDate.length})</li>`;
                    html += activeTasksForDate.map(task => createMyDayTaskItemHTML(task)).join('');
                }
                if (completedTasksForDate.length > 0) {
                    html += `<li class="my-day-separator">Wykonane (${completedTasksForDate.length})</li>`;
                    html += completedTasksForDate.map(task => createMyDayTaskItemHTML(task)).join('');
                }
                
                kanbanBoardEl.innerHTML = `<ul class="my-day-list">${html}</ul>`;
                
                // NOWA LOGIKA: Podpinamy dedykowany listener
                const myDayList = kanbanBoardEl.querySelector('.my-day-list');
                if (myDayList) {
                    myDayList.addEventListener('click', handleMyDayClick, { capture: true });
                }
            }
        }

        function handleMyDayClick(e) {
  const taskItem = e.target.closest('.my-day-task-item');
  if (!taskItem) return;

  if (e.target.matches('.task-card-checkbox')) {
      handleTaskCheckboxClick(e.target, e);
      return; // <-- kluczowe: koczymy obsug
  } else if (e.target.closest('a[data-project-id]')) {
      handleProjectLinkClick(e);
  } else {
      openTaskModal(taskItem.dataset.taskId);
  }
}
        function showConfirmation(title, message, callback, danger = false) {
            confirmationModal.title.textContent = title;
            confirmationModal.message.textContent = message;
            confirmationModal.confirmBtn.onclick = () => {
                closeModal(confirmationModal.overlay);
                callback(true);
            };
            confirmationModal.confirmBtn.classList.toggle('btn-danger', danger);
            confirmationModal.confirmBtn.classList.toggle('btn-primary', !danger);
            openModal(confirmationModal.overlay);
        }
        // === NOWA LOGIKA: Kliknicie na ULUBIONE PROJEKTY (zwinity sidebar) ===
        const favHeader = document.querySelector('.sidebar-scrollable-area > .nav-section:first-child h2');
        const favMenu = document.getElementById('favorites-flyout-menu');
        
        if (favHeader && favMenu) {
            favHeader.addEventListener('click', (e) => {
                e.stopPropagation();

                // Ta logika dziaa TYLKO, gdy sidebar jest zwinity
                if (state.ui.sidebarCollapsed) {
                    
                    // 1. Wypenij menu aktualn list ulubionych
                    const favoriteProjects = state.projects
                        .filter(p => state.currentUser.favorites.includes(p.id))
                        .sort((a, b) => a.name.localeCompare(b.name));

                    if (favoriteProjects.length > 0) {
                        favMenu.innerHTML = favoriteProjects.map(project => `
                            <a href="#" class="flyout-menu-item ${project.id === state.currentProjectId ? 'active' : ''}" data-project-id="${project.id}">
                                ${project.name}
                            </a>
                        `).join('');
                    } else {
                        favMenu.innerHTML = '<span class="flyout-menu-item" style="opacity: 0.7; cursor: default;">Brak ulubionych</span>';
                    }
                    
                    // 2. Ustaw pozycj menu
                    const rect = favHeader.getBoundingClientRect();
                    favMenu.style.position = 'absolute';
                    favMenu.style.left = '72px';
                    favMenu.style.top = `${rect.top}px`;
                    favMenu.style.bottom = 'auto';
                    
                    // 3. Poka偶/Ukryj menu
                    // (Musimy te偶 zamkn menu grupy, jeli byo otwarte)
                    const groupMenu = document.getElementById('group-switcher-menu');
                    if (groupMenu && groupMenu.classList.contains('flyout-open')) {
                        groupMenu.classList.remove('flyout-open');
                        document.getElementById('group-switcher-toggle').classList.remove('open');
                    }
                    
                    favMenu.classList.toggle('open');
                }
            });

            // Listener do klikania link贸w wewntrz menu
            favMenu.addEventListener('click', (e) => {
                e.preventDefault();
                const link = e.target.closest('a[data-project-id]');
                if (link) {
                    handleProjectLinkClick(e); // U偶yj istniejcej funkcji
                    favMenu.classList.remove('open'); // Zamknij menu
                }
            });
        }
        
        // Zamykanie menu "Ulubione" po klikniciu poza nim
        document.addEventListener('click', (e) => {
            if (favHeader && favMenu && favMenu.classList.contains('open') && !favHeader.contains(e.target) && !favMenu.contains(e.target)) {
                favMenu.classList.remove('open');
            }
        });
        // === KONIEC NOWEJ LOGIKI ===
        async function requestNotificationPermission() {
            try {
                const messaging = getMessaging(app);
                const permission = await Notification.requestPermission();
                if (permission === "granted") {
                    const currentToken = await getToken(messaging);
                    if (currentToken && state.currentUser) {
                        const userRef = doc(usersRef, state.currentUser.uid);
                        const userDoc = await getDoc(userRef);
                        if (userDoc.exists()) {
                            const tokens = userDoc.data().fcmTokens || [];
                            if (!tokens.includes(currentToken)) {
                                await updateDoc(userRef, {
                                    fcmTokens: [...tokens, currentToken]
                                });
                            }
                        }
                    }
                }
            } catch (error) {
                console.error("Bd podczas proby o zgod na powiadomienia:", error);
            }
        }

        function findUser(userId) {
            return state.users.find(u => u.id === userId);
        }

        function findProject(projectId) {
            // Krok 1: Przeszukaj projekty z aktywnej grupy (szybsze, dla wikszoci widok贸w)
            let project = state.projects.find(p => p.id === projectId);
            if (project) {
                return project;
            }
            // Krok 2: Jeli nie znaleziono, przeszukaj globaln list (dla "M贸j Dzie")
            project = state.globalUserProjects.find(p => p.id === projectId);
            return project;
        }

        function findCompletedProject(projectId) {
            // Krok 1: Przeszukaj zakoczone projekty z aktywnej grupy
            let project = state.completedProjects.find(p => p.id === projectId);
            if (project) {
                return project;
            }
            // Krok 2: Jeli nie znaleziono, przeszukaj globaln list zakoczonych
            project = state.globalUserCompletedProjects.find(p => p.id === projectId);
            return project;
        }
        // <<< ZMIANA: NOWA FUNKCJA SPRAWDZAJCA BUD呕ET PROJEKTU >>>
        /**
         * Sprawdza, czy bie偶cy aktywny projekt ma zdefiniowany bud偶et (budget.amount > 0).
         * Zakada, 偶e stan aplikacji jest aktualny.
         * @returns {boolean} True, jeli projekt ma bud偶et > 0.
         */
        function checkIfSelectedProjectHasBudget() {
            const projectId = state.currentProjectId;
            if (!projectId) return false; 
            
            const project = findProject(projectId); // Szukaj tylko w aktywnych projektach
            
            // Sprawdzamy, czy projekt istnieje, czy ma pole 'budget', 
            // czy to pole jest obiektem i czy ma pole 'amount' > 0.
            return project && 
                   project.budget && 
                   typeof project.budget === 'object' && 
                   (parseFloat(project.budget.amount) > 0);
        }
        // <<< KONIEC ZMIANY >>>
        function migrateTask(task) {
            if (!task.type) {
                task.type = 'single';
                task.assignees = task.assignee ? [task.assignee] : [];
                task.completedBy = task.status === 'done' && task.assignee ? [task.assignee] : [];
            }
            if (!task.assignees) task.assignees = [];
            if (!task.completedBy) task.completedBy = [];
            // === NOWA LINIA ===
            if (!task.subscribers) task.subscribers = [];
            // === KONIEC NOWEJ LINII ===
            if (!task.comments) task.comments = [];
            
            if (!task.activityLog) task.activityLog = [];
            if (task.recurrence === undefined) task.recurrence = null;
            
            // === POCZTEK NOWEGO KODU: Migracja Rzeczywistego Wysiku ===
            if (task.actualEffort === undefined) {
                // Jeli pole nie istnieje, ustaw je domylnie na warto estymacji (lub null)
                task.actualEffort = task.estimation || null;
            }
            // === KONIEC NOWEGO KODU ===
            
            // === POCZTEK NOWEGO KODU: Migracja Custom Columns ===
            if (task.customColumnId === undefined) {
                task.customColumnId = null; // Domylnie 'null' (g贸wna kolumna 'W trakcie')
            }
            // === KONIEC NOWEGO KODU ===

            // === NOWA LOGIKA: Migracja i inicjalizacja subzada ===
            if (!task.subtasks) {
                task.subtasks = [];
            } else {
                task.subtasks = task.subtasks.map(subtask => {
                    // Migracja ze starego formatu (jeli istniaby w bazie)
                    if (subtask.assigneeId && !subtask.assignees) {
                        return {
                            id: subtask.id,
                            title: subtask.title,
                            assignees: [subtask.assigneeId],
                            isCompleted: subtask.isCompleted,
                            completedBy: subtask.isCompleted ? [subtask.assigneeId] : []
                        };
                    }
                    // Upewnienie si, 偶e istniej tablice w nowym formacie
                    
                    // 1. Obliczamy isCompleted na podstawie starych danych (legacy support)
                    const calculatedIsCompleted = subtask.isCompleted !== undefined ? subtask.isCompleted : ((subtask.assignees || []).length > 0 && (subtask.assignees || []).every(id => (subtask.completedBy || []).includes(id)));
                    
                    // 2. Definiujemy status podzadania. Jeli nie istnieje w bazie, dedukujemy go z isCompleted.
                    // To kluczowe dla nowej logiki Kanban.
                    let derivedStatus = subtask.status;
                    if (!derivedStatus) {
                        derivedStatus = calculatedIsCompleted ? 'done' : 'todo';
                    }

                    return {
                        ...subtask,
                        assignees: subtask.assignees || [],
                        completedBy: subtask.completedBy || [],
                        isCompleted: calculatedIsCompleted,
                        status: derivedStatus // <-- NOWE POLE: Status Kanban dla podzadania
                    };
                });
            }
            // === KONIEC NOWEJ LOGIKI ===
            // NOWA LINIA: Inicjalizacja zale偶noci
            if (task.blockingTaskId && typeof task.blockingTaskId === 'string') {
                // Format 1: Stary string -> migruj do obiektu 'dependency'
                // Przypisz wasno starego powizania do tw贸rcy zadania (najlepsze co mo偶emy zrobi)
                task.dependency = {
                    blockingTaskId: task.blockingTaskId,
                    setByUserId: task.createdBy // Przypisujemy "wasno" linku tw贸rcy zadania
                };
                delete task.blockingTaskId; // Usu stare pole
            
            } else if (task.blockingTaskId && typeof task.blockingTaskId === 'object') {
                // Format 2: Stary obiekt (z poprzedniej pr贸by, np. {id: '...', setBy: '...'}) -> migruj
                 task.dependency = {
                    blockingTaskId: task.blockingTaskId.id,
                    setByUserId: task.blockingTaskId.setBy
                };
                delete task.blockingTaskId; // Usu stare pole

            } else if (!task.dependency) {
                // Format 3: Brak 'dependency' i brak 'blockingTaskId' -> ustaw 'dependency' na null
                task.dependency = null;
            }
            // Jeli 'task.dependency' ju偶 istnieje jako poprawny obiekt, nic nie robimy.
            // === KONIEC NOWEJ LOGIKI ===

            return task;
        }

        function findTask(taskId) {
            // Krok 1: Przeszukaj projekty z aktywnej grupy (standardowe zachowanie)
            const activeProjects = [...state.projects, ...state.completedProjects];
            for (const project of activeProjects) {
                const task = (project.tasks || []).find(t => t.id === taskId);
                if (task) return {
                    task: migrateTask(task),
                    project
                };
            }
            
            // Krok 2: Jeli nie znaleziono, przeszukaj globaln list (dla "M贸j Dzie")
            const globalProjects = [...state.globalUserProjects, ...state.globalUserCompletedProjects];
            for (const project of globalProjects) {
                const task = (project.tasks || []).find(t => t.id === taskId);
                if (task) return {
                    task: migrateTask(task),
                    project
                };
            }

            // Krok 3: Jeli nigdzie nie znaleziono, zwr贸 null
            return {
                task: null,
                project: null
            };
        };
        /**
         * NOWA FUNKCJA: Sprawdza, czy zadanie jest zablokowane przez inne.
         * @param {object} task - Obiekt zadania do sprawdzenia.
         * @returns {object} - { blocked: boolean, taskName: string | null }
         */
        function isTaskBlocked(task) {
            // === ZMIANA: Czytamy teraz z obiektu dependency ===
            const blockingTaskId = task.dependency ? task.dependency.blockingTaskId : null;
            // === KONIEC ZMIANY ===

            // 1. Nie jest zablokowane, jeli nie ma ID blokujcego
            if (!blockingTaskId) {
                return { blocked: false, taskName: null };
            }

            // 2. Znajd藕 zadanie blokujce
            const { task: blockingTask } = findTask(blockingTaskId);

            // 3. Zablokowane, jeli zadanie blokujce istnieje I NIE jest 'done'
            if (blockingTask && blockingTask.status !== 'done') {
                return { blocked: true, taskName: blockingTask.title };
            }

            // 4. Nie jest zablokowane, jeli zadanie blokujce jest 'done'
            // LUB jeli zadanie blokujce nie zostao znalezione (traktujemy jako "osierocone" powizanie)
            return { blocked: false, taskName: null };
        }
       /**
         * NOWA FUNKCJA POMOCNICZA
         * Sprawdza, czy dany u偶ytkownik ma uprawnienia do ukoczenia zadania.
         * @param {string} userId - ID u偶ytkownika do sprawdzenia.
         * @param {object} task - Obiekt zadania.
         * @param {object} project - Obiekt projektu nadrzdnego.
         * @returns {boolean} - True, jeli u偶ytkownik mo偶e ukoczy zadanie.
         */
        function canUserCompleteTask(userId, task, project) {
            if (!userId || !task || !project) {
                return false; // Bezpiecznik
            }

            // 1. Sprawd藕, czy jest Wacicielem Projektu
            if (project.ownerId === userId) {
                return true;
            }

            // 2. Sprawd藕, czy jest Administratorem Projektu
            if ((project.admins || []).includes(userId)) {
                return true;
            }

            // 2b. Sprawd藕, czy jest SuperUserem (NOWE)
            if ((project.superUsers || []).includes(userId)) {
                return true;
            }

            // 3. Sprawd藕, czy jest przypisany do zadania (dziaa dla 'single' i 'multi')
            if ((task.assignees || []).includes(userId)) {
                return true;
            }

            // 4. Jeli zadanie nie ma nikogo przypisanego (lista pusta)
            if ((task.assignees || []).length === 0) {
                // Pozw贸l Wacicielowi lub Adminowi ukoczy (ju偶 sprawdzone powy偶ej)
                // ale pozw贸l te偶 ka偶demu czonkowi projektu "przej" i ukoczy nieprzypisane zadanie.
                if (project.members.includes(userId)) {
                     return true;
                }
            }

            // 5. W przeciwnym razie - brak uprawnie
            return false;
        }
       /**
 * Sprawdza, czy u偶ytkownik ma prawo odhaczy element listy kontrolnej.
 * @param {object} user - Obiekt zalogowanego u偶ytkownika (state.currentUser).
 * @param {object} project - Obiekt projektu.
 * @param {object} task - Obiekt zadania (lub podzadania), do kt贸rego nale偶y lista.
 * @param {object} item - Konkretny element listy kontrolnej.
 * @returns {boolean} True, jeli ma dostp.
 */
function hasChecklistPermission(user, project, task, item) {
    if (!user || !project || !task) return false;
    const userId = user.uid;

    // 1. Waciciel Projektu lub Admin Projektu -> ZAWSZE MO呕E
    if (project.ownerId === userId) return true;
    if ((project.admins || []).includes(userId)) return true;

    // 2. Tw贸rca Zadania (tego konkretnego, w kt贸rym jest lista) -> ZAWSZE MO呕E
    if (task.createdBy === userId) return true;

    // 3. Jeli element listy ma PRZYPISAN OSOB:
    if (item.assigneeId) {
        // Mo偶e tylko ta osoba (lub wy偶ej wymienieni admini/tw贸rcy)
        return item.assigneeId === userId;
    }

    // 4. Jeli element listy NIE MA przypisanej osoby:
    // Pozwalamy ka偶demu, kto jest przypisany do samego Zadania (Task Assignees)
    if ((task.assignees || []).includes(userId)) {
        return true;
    }

    // W przeciwnym razie brak dostpu
    return false;
}
        function getAllMyTasks() {
            const allProjects = [...state.projects, ...state.completedProjects];
            return allProjects.flatMap(p =>
                (p.tasks || [])
                .map(migrateTask)
                .filter(t => t.assignees.includes(state.currentUser.uid))
                .map(t => ({ ...t,
                    projectName: p.name,
                    projectId: p.id
                }))
            );
        }
       /**
         * NOWA FUNKCJA: Pobiera pask list wszystkich zada ORAZ podzada przypisanych do u偶ytkownika.
         * Zmodyfikowana, aby obsugiwa Zasad Rozbie偶noci.
         */
        function getAllMyTasksAndSubtasks() {
            const allProjects = [...state.projects, ...state.completedProjects];
            const myId = state.currentUser.uid;
            let items = [];

            allProjects.forEach(project => {
                const tasks = project.tasks || [];
                
                tasks.forEach(task => {
                    const taskObj = migrateTask(task); 
                    
                    // A. Zadanie G贸wne
                    if ((taskObj.assignees || []).includes(myId)) {
                        items.push({
                            type: 'main',
                            data: taskObj,
                            project: project,
                            status: taskObj.status,
                            customColumnId: taskObj.customColumnId,
                            dueDate: taskObj.dueDate,
                            createdAt: taskObj.createdAt
                        });
                    }

                    // B. Podzadania
                    if (taskObj.subtasks && taskObj.subtasks.length > 0) {
                        taskObj.subtasks.forEach(sub => {
                            if ((sub.assignees || []).includes(myId)) {
                                const subStatus = sub.status || (sub.isCompleted ? 'done' : 'todo');
                                const subColId = sub.customColumnId || null;
                                
                                // === ZASADA ROZBIE呕NOCI (DASHBOARD) ===
                                // Jeli podzadanie ma TEN SAM status i kolumn co rodzic -> jest zagnie偶d偶one (nie dodajemy jako main).
                                // Jeli ma INNY -> jest samodzielne (dodajemy jako main).
                                
                                const parentStatus = taskObj.status;
                                const parentColId = taskObj.customColumnId || null;

                                const isDivergent = (subStatus !== parentStatus) || (subColId !== parentColId);
                                
                                // Jeli jestemy w widoku Dashboard, pokazujemy jako kart TYLKO jeli jest rozbie偶ne
                                // LUB jeli rodzic nie jest przypisany do mnie (wtedy widz tylko podzadanie)
                                const isParentAssignedToMe = (taskObj.assignees || []).includes(myId);

                                if (isDivergent || !isParentAssignedToMe) {
                                    items.push({
                                        type: 'subtask',
                                        data: { sub: sub, parent: taskObj },
                                        project: project,
                                        status: subStatus,
                                        customColumnId: subColId, 
                                        dueDate: sub.dueDate,
                                        createdAt: sub.createdAt || taskObj.createdAt
                                    });
                                }
                            }
                        });
                    }
                });
            });
            
            items.sort((a, b) => {
                 const dateA = a.dueDate ? new Date(a.dueDate).getTime() : Infinity;
                 const dateB = b.dueDate ? new Date(b.dueDate).getTime() : Infinity;
                 return state.ui.sortMyTasksByDate === 'asc' ? dateA - dateB : dateB - dateA;
            });

            return items;
        }
        /**
         * NOWA FUNKCJA (GLOBALNA): Pobiera zadania u偶ytkownika ze WSZYSTKICH grup.
         * U偶ywa globalUserProjects zamiast state.projects.
         */
        function getGlobalAllMyTasks() {
            // U偶ywa nowych, globalnych list projekt贸w
            const allProjects = [...state.globalUserProjects, ...state.globalUserCompletedProjects];
            return allProjects.flatMap(p =>
                (p.tasks || [])
                .map(migrateTask)
                .filter(t => t.assignees.includes(state.currentUser.uid)) // Tylko moje zadania
                .map(t => {
                    // === NOWA LOGIKA: Pobieranie nazwy grupy ===
                    const groupId = p.groupId;
                    const groupName = state.currentUser.groupInfo[groupId] ? state.currentUser.groupInfo[groupId].name : 'Nieznana Grupa';
                    // === KONIEC NOWEJ LOGIKI ===
                    
                    return { ...t,
                        projectName: p.name,
                        projectId: p.id,
                        // === NOWE POLA ===
                        groupId: groupId,
                        groupName: groupName
                        // === KONIEC NOWYCH PL ===
                    };
                })
            );
        }
        function openMoveTaskDialog(taskId, currentProjectId) {
            // Filtrujemy list, aby pokaza tylko projekty, do kt贸rych mo偶na przenie zadanie
            // === POPRAWKA: Dodano warunek !p.isInbox ===
            const availableProjects = state.projects.filter(p => p.id !== currentProjectId && !p.isInbox);
            // === KONIEC POPRAWKI ===

            moveTaskModal.projectList.innerHTML = ''; // Wyczy star list

            if (availableProjects.length === 0) {
                moveTaskModal.projectList.innerHTML = '<p>Brak innych projekt贸w, do kt贸rych mo偶na przenie to zadanie.</p>';
                moveTaskModal.confirmBtn.disabled = true;
            } else {
                availableProjects.forEach(project => {
                    const item = document.createElement('div');
                    item.className = 'project-selection-item';
                    item.innerHTML = `
                            <label>
                                <input type="radio" name="destination-project" value="${project.id}">
                                ${project.name}
                            </label>
                        `;
                    moveTaskModal.projectList.appendChild(item);
                });
                moveTaskModal.confirmBtn.disabled = false;
            }

            // Zapisz potrzebne dane w atrybutach modala
            moveTaskModal.overlay.dataset.taskId = taskId;
            moveTaskModal.overlay.dataset.sourceProjectId = currentProjectId;

            openModal(moveTaskModal.overlay);
        }
       

        function getOverdueTasks(tasks) {
            const now = Date.now();
            return tasks.filter(t =>
                t.dueDate && new Date(t.dueDate).getTime() < now && t.status !== 'done'
            ).sort((a, b) => new Date(a.dueDate).getTime() - new Date(b.dueDate).getTime());
        }

        function getTeamOverdueCount() {
             const myOwnedProjects = state.projects.filter(p => p.ownerId === state.currentUser.uid);
             // 1. Zbierz wszystkie zadania z MOICH projekt贸w
             const allTasksInMyProjects = myOwnedProjects.flatMap(project =>
                 (project.tasks || [])
                     .map(migrateTask)
                     .map(t => ({ ...t, projectId: project.id, projectName: project.name }))
             );

             // 2. Filtruj te zadania, kt贸re s op贸藕nione i NIE s przypisane do mnie
             const now = Date.now();
             const teamOverdueTasks = allTasksInMyProjects.filter(task =>
                 task.dueDate && 
                 new Date(task.dueDate).getTime() < now && 
                 task.status !== 'done' && 
                 !task.assignees.includes(state.currentUser.uid)
             );

             return teamOverdueTasks.length;
        }
       function calculateTeamWorkload(monthFilter = 'all') {
            const teamWorkload = {}; // Obiekt do zliczania, np. { userId: { todo: 0, inprogress: 0, done: 0 } }
            const myId = state.currentUser.uid;
            
            // === NOWE ZMIENNE: Sumy dla caego zespou ===
            let totalTeamTodo = 0;
            let totalTeamInProgress = 0;
            let totalTeamDone = 0;
            // === KONIEC ZMIANY ===

            // 1. Przejd藕 przez wszystkie projekty, w kt贸rych jestem (aktywne, bo only tam liczy si obci偶enie)
            state.projects.forEach(project => {
                // ... (pomidzy jest logika znajdowania otherMembersInProject) ...
                
                // 3. Przejd藕 przez wszystkie zadania w tym projekcie
                (project.tasks || []).forEach(task => {
                    const status = task.status;
                    if (status !== 'todo' && status !== 'inprogress' && status !== 'done') {
                        return; // Pomi zadania o innym statusie (jeli takie istniej)
                    }

                    // === NOWA LOGIKA FILTROWANIA DATY ===
                    if (monthFilter !== 'all') {
                        // Jeli filtr jest aktywny, sprawdzamy dat
                        // Pomi zadanie, jeli nie ma terminu LUB jego termin nie zaczyna si od wybranego YYYY-MM
                        if (!task.dueDate || !task.dueDate.startsWith(monthFilter)) {
                            return; 
                        }
                    }
                    // === KONIEC NOWEJ LOGIKI ===

                    // 4. Sprawd藕, komu jest przypisane to zadanie
                    (task.assignees || []).forEach(assigneeId => {
                        // 5. Zliczaj tylko, jeli przypisany jest kim innym ni偶 ja
                        if (assigneeId !== myId) {
                            // Upewnij si, 偶e ten u偶ytkownik istnieje w naszym obiekcie zliczajcym
                            if (!teamWorkload[assigneeId]) {
                                teamWorkload[assigneeId] = { todo: 0, inprogress: 0, done: 0, name: '' };
                            }
                            // Inkrementuj odpowiedni licznik
                            teamWorkload[assigneeId][status]++;
                            
                            // === NOWA LOGIKA: Inkrementuj sumy globalne ===
                            if (status === 'todo') totalTeamTodo++;
                            if (status === 'inprogress') totalTeamInProgress++;
                            if (status === 'done') totalTeamDone++;
                            // === KONIEC NOWEJ LOGIKI ===
                        }
                    });
                });
            });

            // 6. Przekszta obiekt w posortowan tablic, dodajc nazwy u偶ytkownik贸w
            const workloadArray = Object.keys(teamWorkload).map(userId => {
                const user = findUser(userId);
                const data = teamWorkload[userId];
                return {
                    userId: userId,
                    name: user ? (user.name || user.email) : 'Nieznany U偶ytkownik',
                    todo: data.todo,
                    inprogress: data.inprogress,
                    done: data.done,
                    totalActive: data.todo + data.inprogress // Suma aktywnych do sortowania
                };
            });

            // 7. Posortuj - od najbardziej obci偶onych (aktywnymi zadaniami)
            workloadArray.sort((a, b) => b.totalActive - a.totalActive);

            // === ZMIANA: Zwr贸 obiekt zamiast tablicy ===
            return {
                list: workloadArray,
                totals: {
                    todo: totalTeamTodo,
                    inprogress: totalTeamInProgress,
                    done: totalTeamDone,
                    totalActive: totalTeamTodo + totalTeamInProgress
                }
            };
            // === KONIEC ZMIANY ===
        }
                        
        // === KONIEC NOWEJ FUNKCJI ===
        // === NOWA FUNKCJA: Obliczanie globalnego bud偶etu Waciciela ===
        function calculateGlobalBudgetSummary() {
            if (!state.currentUser) return { totalBudget: 0, totalCommitted: 0, percentage: 0 };

            const myOwnedProjectsWithBudget = state.projects.filter(p => 
                p.ownerId === state.currentUser.uid && // Tylko moje projekty
                p.budget &&                            // Kt贸re maj obiekt bud偶etu
                parseFloat(p.budget.amount) > 0        // I bud偶et jest wikszy ni偶 0
            );

            let globalTotalBudget = 0;
            let globalTotalCommitted = 0; // Zarezerwowane + Wydane

            myOwnedProjectsWithBudget.forEach(project => {
                globalTotalBudget += parseFloat(project.budget.amount) || 0;
                
                // U偶ywamy ju偶 obliczonego budgetSummary z obiektu projektu
                if (project.budgetSummary) {
                    globalTotalCommitted += (project.budgetSummary.totalReserved || 0);
                    globalTotalCommitted += (project.budgetSummary.totalSpent || 0);
                }
            });

            let percentage = 0;
            if (globalTotalBudget > 0) {
                percentage = (globalTotalCommitted / globalTotalBudget) * 100;
            } else if (globalTotalCommitted > 0) {
                // Jeli nie ma bud偶etu, a s koszty, to mamy 100%+ przekroczenia
                percentage = 101; 
            }

            return {
                totalBudget: globalTotalBudget,
                totalCommitted: globalTotalCommitted,
                percentage: percentage, // Mo偶e by > 100
                projects: myOwnedProjectsWithBudget // Zwracamy list do ponownego u偶ycia w modalu
            };
        }
        // === KONIEC NOWEJ FUNKCJI ===
      // === ZAKTUALIZOWANA FUNKCJA (Wersja 2.1): Obliczanie bud偶etu per u偶ytkownik (z podziaem koszt贸w) ===
        function calculateGlobalUserBudgetSummary() {
            const userBudgets = {}; // Obiekt do agregacji: { userId: { name, avatar, reserved, spent, total } }
            let globalReserved = 0; 
            let globalSpent = 0;    
            let globalTotal = 0;    

            // 1. Przejd藕 tylko przez aktywne projekty
            state.projects.forEach(project => {
                
                // === NOWE: FILTR BEZPIECZESTWA ===
                // Dane finansowe projektu widzi tylko Waciciel lub Administrator
                const isOwner = project.ownerId === state.currentUser.uid;
                const isAdmin = (project.admins || []).includes(state.currentUser.uid);

                if (!isOwner && !isAdmin) {
                    return; // Pomi ten projekt, u偶ytkownik nie ma uprawnie finansowych
                }
                // === KONIEC FILTRA ===

                // 2. Przejd藕 przez wszystkie zadania w projekcie
                (project.tasks || []).forEach(task => {
                    // 3. Sprawd藕, czy zadanie ma koszty i osoby
                    if (task.budgetItems && task.budgetItems.length > 0 && task.assignees && task.assignees.length > 0) {
                        
                        // 4. Oblicz cakowity koszt zadania
                        const taskTotalCost = task.budgetItems.reduce((sum, item) => sum + (parseFloat(item.amount) || 0), 0);
                        if (taskTotalCost === 0) return; 

                        // 5. Okrel status kosztu (zarezerwowane / wydane)
                        const isSpent = task.status === 'done';

                        // --- NOWA LOGIKA PODZIAU KOSZTW ---
                        // 6. Podziel koszt zadania r贸wno przez liczb przypisanych os贸b
                        const costPerUser = taskTotalCost / task.assignees.length;
                        // --- KONIEC NOWEJ LOGIKI ---

                        // 7. Przypisz koszt czstkowy do KA呕DEJ osoby
                        (task.assignees || []).forEach(userId => {
                            
                            // 8. Znajd藕 u偶ytkownika
                            const user = findUser(userId);
                            if (!user) return; // Pomi, jeli nie znaleziono

                            // 9. Zainicjuj obiekt dla u偶ytkownika
                            if (!userBudgets[userId]) {
                                userBudgets[userId] = {
                                    userId: userId,
                                    name: user.name || user.email,
                                    avatarHTML: renderAvatarHTML(user), 
                                    reserved: 0,
                                    spent: 0,
                                    total: 0
                                };
                            }

                            // 10. Dodaj KOSZT CZSTKOWY do odpowiedniej kategorii
                            if (isSpent) {
                                userBudgets[userId].spent += costPerUser;
                                globalSpent += costPerUser; // DODAJ DO SUMY GLOBALNEJ
                            } else {
                                userBudgets[userId].reserved += costPerUser;
                                globalReserved += costPerUser; // DODAJ DO SUMY GLOBALNEJ
                            }
                            userBudgets[userId].total += costPerUser;
                            globalTotal += costPerUser; // DODAJ DO SUMY GLOBALNEJ
                        });
                    }
                });
            });

            // 11. Przekszta obiekt w tablic i posortuj
            const sortedUsers = Object.values(userBudgets).sort((a, b) => b.total - a.total);
            
            // 12. ZWR OBIEKT ZAWIERAJCY LIST I SUMY
            // U偶ywamy .toFixed(2) a potem parseFloat(), aby unikn bd贸w zaokrgle
            return {
                list: sortedUsers.map(u => ({
                    ...u,
                    reserved: parseFloat(u.reserved.toFixed(2)),
                    spent: parseFloat(u.spent.toFixed(2)),
                    total: parseFloat(u.total.toFixed(2))
                })),
                totals: {
                    reserved: parseFloat(globalReserved.toFixed(2)),
                    spent: parseFloat(globalSpent.toFixed(2)),
                    total: parseFloat(globalTotal.toFixed(2))
                }
            };
        }
        // === KONIEC ZAKTUALIZOWANEJ FUNKCJI ===
       // === ZAKTUALIZOWANA FUNKCJA (Wersja 2): Renderowanie zawartoci modala "Bud偶et - Osoby" ===
        function renderDashboardUserBudgetDetails(userBudgetList) {
            
            if (userBudgetList.length === 0) {
                return '<p class="no-tasks-message">呕aden ze wsp贸pracownik贸w nie jest przypisany do zada z bud偶etem.</p>';
            }
            
            // Funkcja pomocnicza do formatowania waluty
            const formatCurrency = (value) => {
                 // U偶yjemy PLN jako domylnej, poniewa偶 agregujemy r贸偶ne projekty
                 return value.toLocaleString('pl-PL', { style: 'currency', currency: 'PLN', minimumFractionDigits: 2 });
            }

            // Znajd藕 maksymalny koszt cakowity (user.total), aby proporcjonalnie ustawi paski "Razem"
            // U偶ywamy maxTotal jako 100% dla paska "Razem".
            const maxTotal = Math.max(...userBudgetList.map(u => u.total), 1); // 1 zapobiega dzieleniu przez zero

            const userRowsHTML = userBudgetList.map(user => {
                
                // --- LOGIKA OBLICZE POZOSTAJE BEZ ZMIAN ---
                // Paski "Zarezerwowane" i "Wydane" s skalowane do "Total" DANEGO u偶ytkownika (user.total).
                const userTotalForScaling = user.total > 0 ? user.total : 1; // Unikamy dzielenia przez zero
                const reservedPercent = (user.reserved / userTotalForScaling) * 100;
                const spentPercent = (user.spent / userTotalForScaling) * 100;

                // --- Pasek proporcji (bez zmian w logice, ale u偶yty w nowym miejscu) ---
                const combinedBarHTML = `
                    <div class="chart-label">
                        <span>Stosunek Zarezerwowane / Wydane</span>
                    </div>
                    <div class="chart-bar-wrapper budget-kpi-ratio-bar" title="Zarezerwowane: ${formatCurrency(user.reserved)} | Wydane: ${formatCurrency(user.spent)}">
                        <div class="budget-kpi-ratio-segment bar-reserved" style="width: ${reservedPercent}%;"></div>
                        <div class="budget-kpi-ratio-segment bar-spent" style="width: ${spentPercent}%;"></div>
                    </div>
                `;
                // --- KONIEC PASKW ---

                return `
                    <div class="user-budget-row">
                        <div class="user-budget-info">
                            ${user.avatarHTML}
                            <h4>${user.name}</h4>
                        </div>
                        <div class="user-budget-bars modern-chart">
                            
                            <div class="chart-row">
                                <div class="chart-label">
                                    <span>Zarezerwowane</span>
                                    <strong>${formatCurrency(user.reserved)}</strong>
                                </div>
                            </div>
                            
                            <div class="chart-row">
                                <div class="chart-label">
                                    <span>Wydane</span>
                                    <strong>${formatCurrency(user.spent)}</strong>
                                </div>
                            </div>

                            <div class="chart-row" style="margin-top: 8px; border-top: 1px dashed var(--border-color); padding-top: 8px;">
                                <div class="chart-label">
                                    <span>Razem (Zaanga偶owane)</span>
                                    <strong>${formatCurrency(user.total)}</strong>
                                </div>
                            </div>

                            <div class="chart-row" style="margin-top: 8px;">
                                ${combinedBarHTML}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            // Zwracamy now klas listy, aby style CSS zadziaay
            return `<div class="user-budget-list">${userRowsHTML}</div>`;
        }
        // +++ KONIEC ZAKTUALIZOWANEJ FUNKCJI +++
       // === NOWA FUNKCJA: Renderowanie zawartoci modala "M贸j Bud偶et" ===
        function renderDashboardBudgetDetails(projectsWithBudget) {
            
            if (projectsWithBudget.length === 0) {
                return '<p class="no-tasks-message">Brak projekt贸w z bud偶etem, kt贸rych jeste wacicielem.</p>';
            }

            // Funkcja pomocnicza do formatowania waluty (zakada, 偶e wszystkie s w tej samej)
            const formatCurrency = (value, currency) => {
                 return value.toLocaleString('pl-PL', { style: 'currency', currency: currency || 'PLN', minimumFractionDigits: 2 });
            }

            // Tworzymy list HTML dla ka偶dego projektu
            const projectRowsHTML = projectsWithBudget.map(project => {
                
                const budgetData = project.budget;
                const summaryData = project.budgetSummary;

                const totalBudget = parseFloat(budgetData.amount) || 0;
                const currency = budgetData.currency || 'PLN';

                const totalSpent = summaryData?.totalSpent || 0;
                const totalReserved = summaryData?.totalReserved || 0;
                const availableAmount = totalBudget - totalSpent - totalReserved;
                const totalCommitted = totalSpent + totalReserved;

                let committedPercent = 0;
                if (totalBudget > 0) {
                    committedPercent = (totalCommitted / totalBudget) * 100;
                } else if (totalCommitted > 0) {
                    committedPercent = Infinity;
                }
                const isOverBudgetOverall = totalCommitted > totalBudget;

                // Zwracamy HTML dla pojedynczego wiersza projektu
                return `
                    <div class"budget-detail-row" style="background-color: var(--bg-primary); border: 1px solid var(--border-color); border-radius: var(--border-radius); padding: 12px 16px; margin-bottom: 12px;">
                        
                        <h3 class="budget-detail-project-title" data-project-id="${project.id}" style="font-size: 16px; font-weight: 600; cursor: pointer; margin-bottom: 12px;">
                            ${project.name}
                        </h3>

                        <div class="project-details-budget-grid">
                            <div>
                                <div style="color: var(--text-secondary); font-size: 11px; text-transform: uppercase;">Cakowity Bud偶et</div>
                                <strong style="font-size: 15px;">${formatCurrency(totalBudget, currency)}</strong>
                            </div>
                            <div>
                                <div style="color: var(--text-secondary); font-size: 11px; text-transform: uppercase;">Zarezerwowane</div>
                                <strong style="font-size: 15px; color: ${isOverBudgetOverall ? 'var(--danger-primary)' : 'inherit'};">${formatCurrency(totalReserved, currency)}</strong>
                            </div>
                            <div>
                                <div style="color: var(--text-secondary); font-size: 11px; text-transform: uppercase;">Wydane</div>
                                <strong style="font-size: 15px;">${formatCurrency(totalSpent, currency)}</strong>
                            </div>
                            <div>
                                <div style="color: var(--text-secondary); font-size: 11px; text-transform: uppercase;">Dostpne</div>
                                <strong style="font-size: 15px; color: ${availableAmount < 0 ? 'var(--danger-primary)' : 'var(--success-primary)'};">${formatCurrency(availableAmount, currency)}</strong>
                            </div>
                        </div>

                        <div class="budget-label" style="margin-top: 12px;">
                            <span>Zaanga偶owane / Cakowity bud偶et</span>
                            <span>${committedPercent === Infinity ? '>100' : committedPercent.toFixed(1)}%</span>
                        </div>
                        <div class="budget-summary-bar">
                            <div class="budget-summary-fill ${isOverBudgetOverall ? 'budget-fill-over' : 'budget-fill-items'}" style="width: ${Math.min(committedPercent, 100)}%;">
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            // Zwracamy cay blok HTML
            return `<div class="dashboard-detail-list" style="grid-template-columns: 1fr; padding: 8px;">${projectRowsHTML}</div>`;
        }
        // === KONIEC NOWEJ FUNKCJI ===
        const saveUiState = () => localStorage.setItem(`teamFlowUiState_${appId}`, JSON.stringify(state.ui));
        const loadUiState = () => {
            const savedUiState = localStorage.getItem(`teamFlowUiState_${appId}`);
            if (savedUiState) {
                const loadedUi = JSON.parse(savedUiState);
                
                // === NOWA LINIA: Przygotowanie domylnych wartoci ===
                const defaultCompletedFilters = {
                    projectCompletedFilters: {},
                    dashboardCompletedFilter: '7days'
                };
                
                // === POCZTEK ZMIANY: Dodanie domylnego stanu sidebara I PREFERENCJI ===
                const defaultUiState = {
                    sidebarCollapsed: false,
                    collapsedColumns: {}, 
                    startView: 'auto',         // Domylny widok startowy
                    showConfetti: true,        // Domylnie wczone
                    confirmDelete: true,       // Domylnie wczone
                    expandSubtasksByDefault: true, // <--- NOWE: Domylnie wczone
                    ...defaultCompletedFilters
                };
                // === KONIEC ZMIANY ===

                state.ui = { ...state.ui,
                    ...defaultUiState, // <-- ZMIANA: U偶ycie nowego obiektu domylnego
                    ...loadedUi, // <-- Zaaduj zapisane (nadpisz domylne, jeli istniej)
                    unsubscribeProjects: state.ui.unsubscribeProjects,
                };
            }
            // ZAWSZE ustawiaj dat na dzisiaj podczas adowania aplikacji, ignorujc star warto z pamici
            state.ui.myDayDate = getLocalDateString();
        };
        
        function applyTheme() {
            const isDark = state.ui.theme === 'dark';
            document.body.classList.toggle('dark-mode', isDark);
            document.querySelectorAll('.theme-switcher').forEach(switcher => {
                switcher.querySelector('#theme-dark')?.classList.toggle('active', isDark);
                switcher.querySelector('#theme-light')?.classList.toggle('active', !isDark);
            });
        }

        // === POCZTEK NOWEGO KODU: Logika Zwijania Sidebara ===
        /**
         * Aplikuje stan zwinicia sidebara do DOM (dodaje/usuwa klasy).
         */
        function applySidebarState() {
            const isCollapsed = state.ui.sidebarCollapsed;
            appContainer.classList.toggle('sidebar-collapsed', isCollapsed);
            
            const toggleBtn = document.getElementById('sidebar-toggle-btn');
            if (toggleBtn) {
                toggleBtn.classList.toggle('collapsed', isCollapsed);
                toggleBtn.title = isCollapsed ? "Rozwi panel" : "Zwi panel";
            }
        }

        /**
         * Przecza stan zwinicia sidebara i zapisuje go.
         */
        function toggleSidebar() {
            const wasCollapsed = state.ui.sidebarCollapsed; // Pobierz stan *przed* zmian
            state.ui.sidebarCollapsed = !state.ui.sidebarCollapsed;
            saveUiState();
            applySidebarState();

            // === NOWA LOGIKA CZYSZCZCA ===
            // Jeli wanie ROZWINLIMY sidebar (przechodzimy z collapsed -> expanded)
            if (wasCollapsed && !state.ui.sidebarCollapsed) {
                console.log("Rozwinito sidebar, czyszczenie styli flyout...");
                
                const groupMenu = document.getElementById('group-switcher-menu');
                const resourcesMenu = document.getElementById('resources-menu');
                const favMenu = document.getElementById('favorites-flyout-menu');
                
                // Usu klasy otwarcia
                if (groupMenu) {
                    groupMenu.classList.remove('open', 'flyout-open');
                    // Usu style inline, kt贸re powoduj "przyklejanie"
                    groupMenu.style.cssText = ''; 
                }
                if (resourcesMenu) {
                    resourcesMenu.classList.remove('open', 'flyout-open');
                    resourcesMenu.style.cssText = '';
                }
                if (favMenu) {
                    favMenu.classList.remove('open');
                    favMenu.style.cssText = '';
                }
                
                // Zresetuj przyciski
                const groupToggle = document.getElementById('group-switcher-toggle');
                const resBtn = document.getElementById('resources-btn');
                if (groupToggle) groupToggle.classList.remove('open');
                if (resBtn) resBtn.classList.remove('open');
            }
            // === KONIEC NOWEJ LOGIKI ===
        }
        // === KONIEC NOWEGO KODU ===
        
        function renderMobileCalendar() {
            const calendarWrapper = document.getElementById('mobile-calendar-wrapper');
            if (!calendarWrapper) return;

            calendarWrapper.style.display = 'flex'; // Upewnij si, 偶e kontener jest widoczny

            const grid = document.getElementById('mobile-calendar-grid');
            const monthYearEl = document.getElementById('mobile-calendar-month-year');
            const listHeaderEl = document.getElementById('mobile-calendar-selected-day-header');

            const currentDate = new Date(state.ui.mobileCalendarDate);
            const selectedDate = new Date(state.ui.mobileCalendarSelectedDate);
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();

            monthYearEl.textContent = currentDate.toLocaleString('pl-PL', {
                month: 'long',
                year: 'numeric'
            });

            grid.innerHTML = '';

            const firstDayOfMonth = new Date(year, month, 1);
            const lastDayOfMonth = new Date(year, month + 1, 0);

            const firstDayOfWeek = (firstDayOfMonth.getDay() + 6) % 7; // 0 = Poniedziaek
            const daysInMonth = lastDayOfMonth.getDate();

            const allMyTasks = getAllMyTasks();

            // Dodaj puste kom贸rki dla dni z poprzedniego miesica
            for (let i = 0; i < firstDayOfWeek; i++) {
                grid.innerHTML += `<div class="mobile-calendar-day other-month"></div>`;
            }

            // Dodaj kom贸rki dla dni bie偶cego miesica
            for (let day = 1; day <= daysInMonth; day++) {
                const dayEl = document.createElement('div');
                dayEl.className = 'mobile-calendar-day';

                const dayDate = new Date(year, month, day);
                const dayDateString = new Date(dayDate.getTime() - (dayDate.getTimezoneOffset() * 60000)).toISOString().split('T')[0];
                dayEl.dataset.date = dayDateString;

                // Sprawd藕, czy to dzisiaj
                const today = new Date();
                if (day === today.getDate() && month === today.getMonth() && year === today.getFullYear()) {
                    dayEl.classList.add('today');
                }

                // Sprawd藕, czy to wybrany dzie
                if (dayDateString === state.ui.mobileCalendarSelectedDate) {
                    dayEl.classList.add('selected');
                    listHeaderEl.textContent = `Zadania na ${dayDate.toLocaleDateString('pl-PL', { weekday: 'long', day: 'numeric', month: 'long' })}`;
                }

                // Znajd藕 zadania na ten dzie i dodaj wska藕niki
                const tasksForDay = allMyTasks.filter(t => t.dueDate && t.dueDate.startsWith(dayDateString) && (t.status === 'todo' || t.status === 'inprogress'));
                const hasTodo = tasksForDay.some(t => t.status === 'todo');
                const hasInProgress = tasksForDay.some(t => t.status === 'inprogress');

                let indicatorsHTML = '';
                if (hasTodo) indicatorsHTML += '<div class="activity-indicator indicator-todo"></div>';
                if (hasInProgress) indicatorsHTML += '<div class="activity-indicator indicator-inprogress"></div>';

                dayEl.innerHTML = `
                        <span>${day}</span>
                        <div class="activity-indicators">${indicatorsHTML}</div>
                    `;
                grid.appendChild(dayEl);
            }

            renderMobileCalendarTaskList();
        }

        function renderMobileCalendarTaskList() {
    const taskListEl = document.getElementById('mobile-calendar-task-list');
    const selectedDateStr = state.ui.mobileCalendarSelectedDate;

    const tasksForSelectedDay = getAllMyTasks()
        .filter(t => t.dueDate && t.dueDate.startsWith(selectedDateStr) && (t.status === 'todo' || t.status === 'inprogress'))
        .sort((a, b) => new Date(a.dueDate).getTime() - new Date(b.dueDate).getTime());

    if (tasksForSelectedDay.length === 0) {
        taskListEl.innerHTML = '<li class="no-tasks-message">Brak zaplanowanych zada na ten dzie.</li>';
        return;
    }

    taskListEl.innerHTML = tasksForSelectedDay.map(task => {
        const dueDate = new Date(task.dueDate);
        const time = dueDate.toLocaleTimeString('pl-PL', { hour: '2-digit', minute: '2-digit' });

        // Zmiana jest tutaj - dodajemy div'a z nazw projektu i tytuem
        return `
            <li class="mobile-calendar-task-item ${task.status === 'todo' ? 'todo' : ''}" data-task-id="${task.id}">
                <div class="mobile-calendar-task-item-time">${time}</div>
                <div class="mobile-calendar-task-item-details">
                    <div class="mobile-calendar-task-project-name">${task.projectName}</div>
                    <div class="mobile-calendar-task-item-title">${task.title}</div>
                </div>
            </li>
        `;
    }).join('');
}
       // === POCZTEK LOGIKI OMNI-RADARU ===

/**
 * G贸wny kontroler widoku Radaru.
 */
function renderRadarView() {
    // 1. Zarzdzanie widocznoci kontener贸w
    kanbanBoardEl.style.display = 'none';
    calendarViewEl.style.display = 'none';
    const radarViewEl = document.getElementById('radar-view');
    const mobileCal = document.getElementById('mobile-calendar-wrapper');
    if (mobileCal) mobileCal.style.display = 'none';
    
    if (radarViewEl) radarViewEl.style.display = 'flex';

    // 2. Aktualizacja nag贸wk贸w
    projectNameHeaderEl.textContent = 'Omni-Radar';
    mobileHeaderTitle.textContent = 'Omni-Radar';
    projectMembersHeaderEl.innerHTML = '';
    
    // === CZYSZCZENIE NAGWKA (CLEAN UI) ===
            if (projectMenuToggle) projectMenuToggle.style.display = 'none';
            if (projectProgressContainer) projectProgressContainer.style.display = 'none';
            // === KONIEC ===

            if (sortBtn) sortBtn.style.display = 'none';
            if (filterBtn) filterBtn.style.display = 'none';
            
            // === ZMIANA: Ukrycie ikony kalendarza w Radarze ===
            if (calendarToggleBtn) calendarToggleBtn.style.display = 'none';
            
            // === NOWE: Ukrycie separator贸w (pionowych kresek) w Radarze ===
            document.querySelectorAll('.header-divider').forEach(el => el.style.display = 'none');
            // === KONIEC ZMIANY ===

            // 3. Pobierz projekty (bez Inboxa)
    const allProjects = state.projects.filter(p => !p.isInbox);
    
    // Inicjalizacja domylna: Jeli nic nie zaznaczono, zaznacz wszystkie
    if (state.ui.radarSelectedProjectIds.length === 0) {
        state.ui.radarSelectedProjectIds = allProjects.map(p => p.id);
    }

    // 4. Renderuj pasek filtr贸w (Piguki)
    renderRadarFilters(allProjects);

    // --- NOWO: Inicjalizacja i renderowanie przecznika tryb贸w ---
    if (!state.ui.radarMode) state.ui.radarMode = 'effort'; // Domylny tryb

    const chartContainer = document.getElementById('radar-chart-container');
    // Czycimy kontener, aby nie dublowa przycisk贸w przy przerysowaniu
    chartContainer.innerHTML = ''; 

    const modeSwitcher = document.createElement('div');
    modeSwitcher.className = 'radar-mode-switcher';
    // Style inline dla pozycjonowania absolutnego w rogu radaru (nad SVG)
    modeSwitcher.style.cssText = 'position: absolute; top: 20px; left: 20px; z-index: 10; display: flex; gap: 4px; background: var(--bg-secondary); padding: 4px; border-radius: 8px; border: 1px solid var(--border-color); box-shadow: var(--shadow-sm);';

    const modes = [
        { id: 'effort', label: 'Wysiek', icon: '<path d="M12 6v6h4.5m4.5 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />' },
        { id: 'budget', label: 'Bud偶et', icon: '<path d="M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2Zm0 18a8 8 0 1 1 8-8 8 8 0 0 1-8 8Z" /><path d="M12 16v-4M12 8h.01" />' },
        { id: 'priority', label: 'Priorytet', icon: '<path d="M3 3v1.5M3 21v-6m0 0l2.77-.693a9 9 0 0 1 6.208.682l.108.054a9 9 0 0 0 6.086.71l3.114-.732a48.524 48.524 0 0 1-.005-10.499l-3.11.732a9 9 0 0 1-6.085-.711l-.108-.054a9 9 0 0 0-6.208-.682L3 4.5M3 15V4.5" />' }
    ];

    modes.forEach(m => {
        const btn = document.createElement('button');
        const isActive = state.ui.radarMode === m.id;
        btn.className = `btn btn-sm ${isActive ? 'btn-primary' : 'btn-secondary'}`;
        btn.style.cssText = `padding: 4px 8px; font-size: 11px; display: flex; align-items: center; gap: 4px; ${isActive ? '' : 'border: none; background: transparent;'}`;
        // Wstawiamy SVG bezporednio
        btn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" style="width:14px;height:14px;">${m.icon}</svg> ${m.label}`;
        
        btn.onclick = () => {
            state.ui.radarMode = m.id; // Zapisz wyb贸r
            renderRadarView(); // Przerysuj widok (zaktualizuje przyciski i wykres)
        };
        modeSwitcher.appendChild(btn);
    });
    
    chartContainer.appendChild(modeSwitcher);

    // 5. Rysuj Radar SVG
    drawRadarChart(allProjects);
}
// === KONIEC LOGIKI OMNI-RADARU ===
  /**
 * Renderuje pasek piguek do filtrowania projekt贸w na radarze.
 */
function renderRadarFilters(allProjects) {
    const container = document.getElementById('radar-filter-bar');
    if (!container) return;
    
    container.innerHTML = '';

    // Przycisk "Wszystkie"
    const allBtn = document.createElement('div');
    // Sprawd藕 czy wszystkie dostpne projekty s na licie wybranych
    const areAllSelected = allProjects.length > 0 && allProjects.every(p => state.ui.radarSelectedProjectIds.includes(p.id));
    
    allBtn.className = `member-pill ${areAllSelected ? 'active' : ''}`;
    allBtn.textContent = 'Wszystkie';
    allBtn.style.fontWeight = '700';
    allBtn.style.cursor = 'pointer';
    
    allBtn.onclick = () => {
        if (areAllSelected) {
            state.ui.radarSelectedProjectIds = []; // Odznacz wszystko
        } else {
            state.ui.radarSelectedProjectIds = allProjects.map(p => p.id); // Zaznacz wszystko
        }
        renderRadarView(); // Przerysuj
    };
    container.appendChild(allBtn);

    // Piguki per projekt
    allProjects.forEach(project => {
        const pill = document.createElement('div');
        const isActive = state.ui.radarSelectedProjectIds.includes(project.id);
        
        pill.className = `member-pill ${isActive ? 'active' : ''}`;
        pill.innerHTML = `<span>${project.name}</span>`;
        pill.style.cursor = 'pointer';
        
        pill.onclick = () => {
            if (isActive) {
                state.ui.radarSelectedProjectIds = state.ui.radarSelectedProjectIds.filter(id => id !== project.id);
            } else {
                state.ui.radarSelectedProjectIds.push(project.id);
            }
            // Jeli odznaczono ostatni, automatycznie zaznacz wszystkie (UX fallback)
            if (state.ui.radarSelectedProjectIds.length === 0) {
                 state.ui.radarSelectedProjectIds = allProjects.map(p => p.id);
            }
            renderRadarView();
        };
        container.appendChild(pill);
    });
}
/**
 * Rysuje wykres SVG Omni-Radaru (Wersja z Trybami Widoku: Wysiek, Bud偶et, Priorytet).
 */
function drawRadarChart(allProjects) {
    const container = document.getElementById('radar-chart-container');
    if (!container) return;
    
    // Czycimy kontener
    container.innerHTML = '';

    // === 1. UI: PRZECZNIK TRYBW ===
    // Inicjalizacja domylnego trybu, jeli nie istnieje w stanie
    if (!state.ui.radarMode) state.ui.radarMode = 'effort';

    const modeSwitcher = document.createElement('div');
    modeSwitcher.className = 'radar-mode-switcher';
    // Pozycjonowanie absolutne w lewym g贸rnym rogu kontenera
    modeSwitcher.style.cssText = 'position: absolute; top: 20px; left: 20px; z-index: 10; display: flex; gap: 4px; background: var(--bg-secondary); padding: 4px; border-radius: 8px; border: 1px solid var(--border-color); box-shadow: var(--shadow-sm);';

    const modes = [
        { id: 'effort', label: 'Wysiek', icon: '<path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />' },
        { id: 'budget', label: 'Bud偶et', icon: '<path stroke-linecap="round" stroke-linejoin="round" d="M12 6v12m-3-2.818.879.659c1.171.879 3.07.879 4.242 0 1.172-.879 1.172-2.303 0-3.182C13.536 12.219 12.768 12 12 12c-.725 0-1.45-.22-2.003-.659-1.106-.879-1.106-2.303 0-3.182s2.9-.879 4.006 0l.415.33M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />' },
        { id: 'priority', label: 'Priorytet', icon: '<path stroke-linecap="round" stroke-linejoin="round" d="M3 3v1.5M3 21v-6m0 0l2.77-.693a9 9 0 0 1 6.208.682l.108.054a9 9 0 0 0 6.086.71l3.114-.732a48.524 48.524 0 0 1-.005-10.499l-3.11.732a9 9 0 0 1-6.085-.711l-.108-.054a9 9 0 0 0-6.208-.682L3 4.5M3 15V4.5" />' }
    ];

    modes.forEach(m => {
        const btn = document.createElement('button');
        const isActive = state.ui.radarMode === m.id;
        
        // Stylizacja przycisku (aktywny vs nieaktywny)
        btn.className = `btn btn-sm ${isActive ? 'btn-primary' : 'btn-secondary'}`;
        btn.style.cssText = `padding: 6px 10px; font-size: 12px; display: flex; align-items: center; gap: 6px; cursor: pointer; ${isActive ? '' : 'border: 1px solid transparent; background: transparent;'}`;
        btn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width:16px;height:16px;">${m.icon}</svg> ${m.label}`;
        
        btn.onclick = (e) => {
            e.stopPropagation(); // Zapobiegamy propagacji do ta radaru
            state.ui.radarMode = m.id; // Zmieniamy stan
            renderRadarView(); // Przerysowujemy widok (z nowymi wielkociami kropek)
        };
        modeSwitcher.appendChild(btn);
    });

    container.appendChild(modeSwitcher);
    // ==========================================

    // 2. Konfiguracja Wymiar贸w SVG
    const size = 920; // ZMNIEJSZONO Z 960 (Dopasowanie do CSS)
    const center = size / 2;
    const radius = size / 2 - 140;

    const svgNS = "http://www.w3.org/2000/svg";
    const svg = document.createElementNS(svgNS, "svg");
    svg.setAttribute("viewBox", `0 0 ${size} ${size}`);
    svg.classList.add("radar-svg");

  // --- DEFINICJE ---
    const defs = document.createElementNS(svgNS, "defs");
    
    // ZMIANA: Usunito clipPath, poniewa偶 przechodzimy na stabilniejsz metod <pattern>
    defs.innerHTML = `
        <radialGradient id="radar-glow" cx="50%" cy="50%" r="50%" fx="50%" fy="50%">
            <stop offset="0%" stop-color="var(--accent-primary)" stop-opacity="0.1" />
            <stop offset="100%" stop-color="var(--bg-primary)" stop-opacity="0" />
        </radialGradient>
    `;
    svg.appendChild(defs);

    const bgCircle = document.createElementNS(svgNS, "circle");
    bgCircle.setAttribute("cx", center);
    bgCircle.setAttribute("cy", center);
    bgCircle.setAttribute("r", radius);
    bgCircle.setAttribute("fill", "url(#radar-glow)");
    svg.appendChild(bgCircle);

    // 3. Filtrowanie Projekt贸w
    const activeProjects = allProjects.filter(p => state.ui.radarSelectedProjectIds.includes(p.id));
    const count = activeProjects.length;

    if (count === 0) {
        container.innerHTML += '<p class="no-tasks-message" style="margin-top: 60px;">Wybierz projekty z paska powy偶ej.</p>';
        return;
    }

    // 4. Siatka (Piercienie)
    const rings = [
        { r: 0.2, label: 'Dzi / Zalege' },
        { r: 0.5, label: '7 dni' },
        { r: 0.8, label: '30 dni' },
        { r: 1.0, label: '' } 
    ];

    rings.forEach(ring => {
        const rPx = radius * ring.r;
        const circle = document.createElementNS(svgNS, "circle");
        circle.setAttribute("cx", center);
        circle.setAttribute("cy", center);
        circle.setAttribute("r", rPx);
        circle.classList.add("radar-ring");
        svg.appendChild(circle);

        if (ring.label) {
            const text = document.createElementNS(svgNS, "text");
            text.setAttribute("x", center);
            text.setAttribute("y", center - rPx - 8);
            text.textContent = ring.label;
            text.classList.add("radar-label");
            text.style.fontSize = "10px";
            svg.appendChild(text);
        }
    });
    
    const archiveCircle = document.createElementNS(svgNS, "circle");
    archiveCircle.setAttribute("cx", center);
    archiveCircle.setAttribute("cy", center);
    archiveCircle.setAttribute("r", radius * 1.15);
    archiveCircle.setAttribute("fill", "none");
    archiveCircle.setAttribute("stroke", "var(--text-secondary)");
    archiveCircle.setAttribute("stroke-width", "1");
    archiveCircle.setAttribute("stroke-opacity", "0.1");
    archiveCircle.setAttribute("stroke-dasharray", "2 2");
    svg.appendChild(archiveCircle);

    // 5. Skaner
    const scanLine = document.createElementNS(svgNS, "line");
    scanLine.setAttribute("x1", center);
    scanLine.setAttribute("y1", center);
    scanLine.setAttribute("x2", center);
    scanLine.setAttribute("y2", center - radius);
    scanLine.setAttribute("stroke", "var(--success-primary)");
    scanLine.setAttribute("stroke-width", "2");
    scanLine.setAttribute("stroke-linecap", "round");
    scanLine.style.filter = "drop-shadow(0 0 8px var(--success-primary))";
    scanLine.classList.add("radar-sweep");
    svg.appendChild(scanLine);

    // 6. Generowanie Danych (Zadania i Podzadania)
    const anglePerProject = (2 * Math.PI) / count;
    const projectLabels = [];
    const userPositions = {};
    const placedNodes = [];

    activeProjects.forEach((project, index) => {
        const startAngle = (index * anglePerProject) - (Math.PI / 2);
        
        const line = document.createElementNS(svgNS, "line");
        line.setAttribute("x1", center);
        line.setAttribute("y1", center);
        line.setAttribute("x2", center + (radius * 1.2) * Math.cos(startAngle));
        line.setAttribute("y2", center + (radius * 1.2) * Math.sin(startAngle));
        line.classList.add("radar-axis");
        svg.appendChild(line);

        const labelAngle = startAngle + (anglePerProject / 2);
        const labelDist = radius * 1.25;
        projectLabels.push({
            x: center + labelDist * Math.cos(labelAngle),
            y: center + labelDist * Math.sin(labelAngle),
            text: project.name
        });

        const tasks = project.tasks || [];
        const now = new Date().getTime();
        const currentUserId = state.currentUser.uid;
        const isOwner = project.ownerId === currentUserId;
        const isAdmin = (project.admins || []).includes(currentUserId);
        const canSeeAll = isOwner || isAdmin;

        let allItems = [];
        
        tasks.forEach(task => {
            const isTaskCreator = task.createdBy === currentUserId;
            const isTaskAssignee = (task.assignees || []).includes(currentUserId);
            
            if (canSeeAll || isTaskCreator || isTaskAssignee) {
                allItems.push({ type: 'task', data: task, parentTitle: null });
            }
            
            if (task.subtasks && task.subtasks.length > 0) {
                task.subtasks.forEach(sub => {
                    const isSubCreator = sub.createdBy === currentUserId;
                    const isSubAssignee = (sub.assignees || []).includes(currentUserId);
                    if (canSeeAll || isSubCreator || isSubAssignee) {
                        allItems.push({ type: 'subtask', data: sub, parentTitle: task.title, parentId: task.id });
                    }
                });
            }
        });

        allItems.forEach(item => {
            const obj = item.data;
            const isSubtask = item.type === 'subtask';
            const isCompleted = isSubtask ? (obj.isCompleted || obj.status === 'done') : (obj.status === 'done');
            
            // A. POZYCJA (Dystans)
            let distRatio = 0.95;
            let isCritical = false;
            
            if (isCompleted) {
                distRatio = 1.05 + (Math.random() * 0.10); 
            } else {
                if (obj.dueDate) {
                    const due = new Date(obj.dueDate).getTime();
                    const diffDays = (due - now) / (1000 * 60 * 60 * 24);
                    
                    if (diffDays < 0) {
                        distRatio = 0.1 + (Math.random() * 0.05);
                        isCritical = true;
                    } else if (diffDays <= 60) {
                        distRatio = 0.2 + (diffDays / 60) * 0.75;
                    } else {
                        distRatio = 0.95;
                    }
                } else {
                    distRatio = 0.85 + (Math.random() * 0.1);
                }
                if (distRatio > 0.98) distRatio = 0.98;
            }

            // B. KT (Losowo w sektorze)
            let seed = 0;
            const idStr = obj.id || "temp";
            for (let i = 0; i < idStr.length; i++) seed += idStr.charCodeAt(i);
            if (isSubtask) seed += 500; 

            const pseudoRandom = (Math.abs(Math.sin(seed)) % 1);
            const sectorPadding = anglePerProject * 0.15; 
            const availableArc = anglePerProject - (2 * sectorPadding);
            const idealAngle = startAngle + sectorPadding + (pseudoRandom * availableArc);

            const idealR = distRatio * radius;
            let tx = center + idealR * Math.cos(idealAngle);
            let ty = center + idealR * Math.sin(idealAngle);

            // === 2. LOGIKA: WIELKO KROPKI (ZALE呕NA OD TRYBU) ===
            let nodeSize = 6; // Baza
            const mode = state.ui.radarMode || 'effort';

            if (isCompleted) {
                nodeSize = isSubtask ? 3 : 4;
            } else {
                switch (mode) {
                    // --- TRYB BUD呕ETU ---
                    case 'budget':
                        let budgetTotal = 0;
                        // Sumuj podzadania
                        if (!isSubtask && obj.subtasks && obj.subtasks.length > 0) {
                            budgetTotal = obj.subtasks.reduce((acc, sub) => {
                                const subItemsTotal = (sub.budgetItems || []).reduce((sum, i) => sum + (parseFloat(i.amount) || 0), 0);
                                return acc + subItemsTotal;
                            }, 0);
                        }
                        // Jeli 0, we藕 g贸wne
                        if (budgetTotal === 0) {
                            budgetTotal = (obj.budgetItems || []).reduce((acc, i) => acc + (parseFloat(i.amount) || 0), 0);
                        }

                        if (budgetTotal > 0) {
                            // Skala logarytmiczna dla pienidzy
                            nodeSize = 6 + (Math.log10(budgetTotal) * 2.5);
                            nodeSize = Math.min(nodeSize, 24); // Max limit
                        } else {
                            nodeSize = 5;
                        }
                        break;

                    // --- TRYB PRIORYTETU ---
                    case 'priority':
                        if (obj.priority === 'high') nodeSize = 16;
                        else if (obj.priority === 'medium') nodeSize = 10;
                        else nodeSize = 6;
                        break;

                    // --- TRYB WYSIKU ---
                    case 'effort':
                    default:
                        let totalEffort = 0;
                        // Sumuj podzadania
                        if (!isSubtask && obj.subtasks && obj.subtasks.length > 0) {
                            totalEffort = obj.subtasks.reduce((sum, sub) => sum + (parseFloat(sub.effort || sub.estimation || 0)), 0);
                        }
                        // Jeli 0, we藕 g贸wne
                        if (totalEffort === 0) {
                            totalEffort = parseFloat(obj.estimation || obj.effort || 0);
                        }

                        if (totalEffort > 0) {
                            nodeSize = 7 + Math.min(totalEffort / 1.5, 16);
                        }
                        if (obj.priority === 'high') nodeSize += 2;
                        break;
                }

                // Podzadania zawsze troch mniejsze
                if (isSubtask) nodeSize = Math.max(3, nodeSize * 0.8); 
            }
            // =====================================================
            
            // D. Antykolizja
            let angleOffset = 0;
            let radiusOffset = 0;
            let collision = true;
            const maxIter = 100;
            let iter = 0;

            while (collision && iter < maxIter) {
                collision = false;
                for (const other of placedNodes) {
                    const dx = tx - other.x;
                    const dy = ty - other.y;
                    const dist = Math.sqrt(dx*dx + dy*dy);
                    const minSpace = nodeSize + other.r + 4; 
                    if (dist < minSpace) {
                        collision = true;
                        break;
                    }
                }
                if (collision) {
                    iter++;
                    angleOffset += 0.5;
                    radiusOffset += isCompleted ? 0.5 : 2;
                    const spiralX = Math.cos(angleOffset) * radiusOffset;
                    const spiralY = Math.sin(angleOffset) * radiusOffset;
                    tx = (center + idealR * Math.cos(idealAngle)) + spiralX;
                    ty = (center + idealR * Math.sin(idealAngle)) + spiralY;
                }
            }

            placedNodes.push({ x: tx, y: ty, r: nodeSize });

            // E. Renderowanie Wza
            let node;
            if (isSubtask) {
                node = document.createElementNS(svgNS, "polygon");
                const r = nodeSize; 
                const p1 = `${tx},${ty - r}`;
                const p2 = `${tx + 0.866 * r},${ty + 0.5 * r}`;
                const p3 = `${tx - 0.866 * r},${ty + 0.5 * r}`;
                node.setAttribute("points", `${p1} ${p2} ${p3}`);
                node.dataset.taskId = item.parentId; 
                node.dataset.subtaskId = obj.id;     
            } else {
                node = document.createElementNS(svgNS, "circle");
                node.setAttribute("cx", tx);
                node.setAttribute("cy", ty);
                node.setAttribute("r", nodeSize);
                node.dataset.taskId = obj.id;
            }
            
            node.classList.add("radar-node");

            if (isCompleted) {
                node.classList.add("completed");
            } else if (isCritical) {
                node.classList.add("critical");
                const sweepDuration = 4;
                let angle = Math.atan2(ty - center, tx - center);
                let normalizedAngle = angle + (Math.PI / 2);
                if (normalizedAngle < 0) normalizedAngle += 2 * Math.PI;
                const delay = (normalizedAngle / (2 * Math.PI)) * sweepDuration;
                node.style.animationDelay = `${delay}s`;
            } else {
                const statusToCheck = obj.status || 'todo';
                if (statusToCheck === 'inprogress') node.setAttribute("fill", "var(--accent-primary)");
                else node.setAttribute("fill", "var(--success-primary)");
            }

            if (!isCompleted && !isSubtask) {
                let daysSinceActivity = 0;
                if (obj.activityLog && obj.activityLog.length > 0) {
                    const lastLog = obj.activityLog.sort((a, b) => b.timestamp - a.timestamp)[0];
                    daysSinceActivity = (now - lastLog.timestamp) / (1000 * 60 * 60 * 24);
                }
                if (daysSinceActivity > 7) node.classList.add("stale");
            }

            // === 3. UI: DYNAMICZNY TOOLTIP ===
            const statusLabel = isCompleted ? "UKOCZONE" : getTaskStatusLabel(obj, project);
            const typeLabel = isSubtask ? `PODZADANIE (w: ${item.parentTitle})` : "ZADANIE";

            // === NOWE: Logika Drag & Drop (Inicjalizacja na w藕le) ===
            // Sprawd藕 uprawnienia (u偶ywamy zmiennych zdefiniowanych wy偶ej w ptli)
            const isAssignee = (obj.assignees || []).includes(state.currentUser.uid);
            const isCreator = obj.createdBy === state.currentUser.uid;
            // Zezw贸l na edycj (przeciganie), jeli u偶ytkownik ma prawa, zadanie nie jest Inboxem i nie jest ukoczone
            const canEdit = (isOwner || isAdmin || isCreator || isAssignee) && !isCompleted && !project.isInbox;

            if (canEdit) {
                node.style.cursor = 'grab';
                // Dodajemy atrybut typu, aby funkcja upuszczania wiedziaa, czy to podzadanie
                node.dataset.type = item.type; 
                
                // Listener rozpoczcia przecigania
                node.addEventListener('mousedown', (e) => {
                    handleRadarNodeDragStart(e, node, obj, project, center, radius, svg);
                });
                node.addEventListener('touchstart', (e) => {
                    handleRadarNodeDragStart(e, node, obj, project, center, radius, svg);
                }, {passive: false});
            }
            // === KONIEC NOWEGO KODU ===
            
            let extraInfo = '';
            if (mode === 'budget') {
                // Przelicz ponownie dla tooltipa
                let val = (obj.budgetItems || []).reduce((acc, i) => acc + (parseFloat(i.amount)||0), 0);
                if (!isSubtask && obj.subtasks) {
                     val += obj.subtasks.reduce((acc, s) => acc + (s.budgetItems||[]).reduce((sa, si)=>sa+(parseFloat(si.amount)||0),0), 0);
                }
                const currency = project.budget?.currency || 'PLN';
                const color = val > 0 ? 'var(--text-primary)' : 'var(--text-secondary)';
                extraInfo = `<div style="margin-top:4px; padding-top:4px; border-top:1px dashed #555;">Bud偶et: <strong style="color:${color}">${val.toLocaleString('pl-PL')} ${currency}</strong></div>`;
            
            } else if (mode === 'effort') {
                let val = parseFloat(obj.estimation || obj.effort || 0);
                if (!isSubtask && obj.subtasks) {
                    val += obj.subtasks.reduce((acc, s) => acc + (parseFloat(s.effort||s.estimation||0)), 0);
                }
                const unit = project.estimationType === 'points' ? 'pkt' : 'h';
                if (val > 0) {
                     extraInfo = `<div style="margin-top:4px; padding-top:4px; border-top:1px dashed #555;">Wysiek: <strong>${val} ${unit}</strong></div>`;
                }
            } else if (mode === 'priority') {
                const pMap = { high: 'Wysoki', medium: 'redni', low: 'Niski' };
                const pColor = obj.priority === 'high' ? 'var(--danger-primary)' : 'inherit';
                extraInfo = `<div style="margin-top:4px; padding-top:4px; border-top:1px dashed #555;">Priorytet: <strong style="color:${pColor}">${pMap[obj.priority] || '-'}</strong></div>`;
            }

            node.setAttribute("data-tippy-content", `
                <div style="text-align:left">
                    <div style="font-size:10px; color: #aaa; text-transform: uppercase; letter-spacing: 0.5px;">${typeLabel}</div>
                    <strong style="font-size:13px;">${obj.title}</strong><br>
                    <span style="font-size:11px;">Status: ${statusLabel}</span><br>
                    <span style="font-size:11px; color:var(--text-secondary);">${obj.dueDate ? 'Termin: ' + obj.dueDate.split('T')[0] : 'Bez terminu'}</span>
                    ${extraInfo}
                </div>
            `);

            svg.appendChild(node);

            // F. Awatary (Agregacja)
            if (!isCompleted) {
                (obj.assignees || []).forEach(userId => {
                    if (!userPositions[userId]) {
                        const user = findUser(userId);
                        userPositions[userId] = { xSum: 0, ySum: 0, count: 0, userObj: user };
                    }
                    const weight = isSubtask ? 0.5 : 1.0;
                    userPositions[userId].xSum += tx * weight;
                    userPositions[userId].ySum += ty * weight;
                    userPositions[userId].count += weight; 
                });
            }
        });
    });

   // 7. Rysowanie Awatar贸w (Metoda ForeignObject - Niezawodna)
    Object.values(userPositions).forEach(pos => {
        if (!pos.userObj) return;
        
        const idealX = pos.xSum / pos.count;
        const idealY = pos.ySum / pos.count;

        let ax = idealX;
        let ay = idealY;
        const avatarRadius = 14;
        
        // Antykolizja Awatara
        let collision = true;
        let iter = 0;
        const maxIter = 150; 
        let angleOffset = 0;
        let radiusOffset = 0;

        while (collision && iter < maxIter) {
            collision = false;
            for (const other of placedNodes) {
                const dx = ax - other.x;
                const dy = ay - other.y;
                const dist = Math.sqrt(dx*dx + dy*dy);
                const minSpace = avatarRadius + other.r + 5;

                if (dist < minSpace) {
                    collision = true;
                    break;
                }
            }

            if (collision) {
                iter++;
                angleOffset += 0.6;
                radiusOffset += 4;
                const spiralX = Math.cos(angleOffset) * radiusOffset;
                const spiralY = Math.sin(angleOffset) * radiusOffset;
                ax = idealX + spiralX;
                ay = idealY + spiralY;
            }
        }
        placedNodes.push({ x: ax, y: ay, r: avatarRadius });

        const g = document.createElementNS(svgNS, "g");
        g.classList.add("radar-avatar-group");
        g.setAttribute("transform", `translate(${ax}, ${ay})`);
        g.setAttribute("data-tippy-content", `<strong>${pos.userObj.name}</strong><br>Aktywne zadania: ${pos.count}`);

        if (pos.userObj.photoURL) {
            // === NAPRAWA DEFINITYWNA V2: Lokalny ClipPath ===
            // Tworzymy definicj przycicia BEZPOREDNIO w grupie elementu.
            // To eliminuje problemy z gubieniem referencji ID w globalnym <defs>.
            
            // 1. Generujemy unikalne ID dla przycicia tego konkretnego awatara
            const uniqueClipId = `clip-${pos.userObj.id}-${Date.now()}-${Math.random().toString(36).substr(2, 5)}`;

            // 2. Tworzymy element <clipPath>
            const clipPath = document.createElementNS(svgNS, "clipPath");
            clipPath.setAttribute("id", uniqueClipId);
            
            // Definiujemy ksztat przycicia (koo)
            const clipShape = document.createElementNS(svgNS, "circle");
            clipShape.setAttribute("cx", 0);
            clipShape.setAttribute("cy", 0);
            clipShape.setAttribute("r", 14); // Promie awatara
            clipPath.appendChild(clipShape);
            
            // Dodajemy clipPath do grupy 'g' (lokalnie)
            g.appendChild(clipPath);

            // 3. Rysujemy to (szare k贸ko) - zapobiega "dziurom" podczas adowania
            const bgCircle = document.createElementNS(svgNS, "circle");
            bgCircle.setAttribute("cx", 0);
            bgCircle.setAttribute("cy", 0);
            bgCircle.setAttribute("r", 14);
            bgCircle.setAttribute("fill", "var(--bg-tertiary)"); // Kolor ta aplikacji
            g.appendChild(bgCircle);

            // 4. Rysujemy Obrazek
            const img = document.createElementNS(svgNS, "image");
            img.setAttribute("x", -14); // Pozycjonowanie (center - radius)
            img.setAttribute("y", -14);
            img.setAttribute("width", 28); // rednica
            img.setAttribute("height", 28);
            img.setAttribute("href", pos.userObj.photoURL);
            
            // Kluczowe ustawienia
            img.setAttribute("preserveAspectRatio", "xMidYMid slice"); // Crop (object-fit: cover)
            img.setAttribute("clip-path", `url(#${uniqueClipId})`); // Przypisanie przycicia
            img.style.pointerEvents = "none"; // Kliknicia przechodz do grupy
            
            g.appendChild(img);
            
            // 5. Opcjonalna ramka na wierzchu (dla estetyki)
            const borderCircle = document.createElementNS(svgNS, "circle");
            borderCircle.setAttribute("cx", 0);
            borderCircle.setAttribute("cy", 0);
            borderCircle.setAttribute("r", 14);
            borderCircle.setAttribute("fill", "none");
            borderCircle.setAttribute("stroke", "rgba(0,0,0,0.1)");
            borderCircle.setAttribute("stroke-width", "1");
            g.appendChild(borderCircle);

        } else {
            // Fallback na inicjay (gdy brak zdjcia)
            const circle = document.createElementNS(svgNS, "circle");
            circle.setAttribute("cx", 0);
            circle.setAttribute("cy", 0);
            circle.setAttribute("r", 14);
            circle.style.fill = pos.userObj.avatarColor || "var(--bg-secondary)";
            
            const initials = (pos.userObj.name || pos.userObj.email).substring(0, 2).toUpperCase();
            const text = document.createElementNS(svgNS, "text");
            text.setAttribute("x", 0);
            text.setAttribute("y", 4);
            text.textContent = initials;
            text.classList.add("radar-avatar-text");
            text.style.fontSize = "10px";
            text.style.fontWeight = "700";
            text.style.fill = "var(--text-primary)";
            text.style.textAnchor = "middle";
            text.style.pointerEvents = "none";

            g.appendChild(circle);
            g.appendChild(text);
        }

        // Opcjonalna obw贸dka (Stroke) dla estetyki
        const strokeCircle = document.createElementNS(svgNS, "circle");
        strokeCircle.setAttribute("cx", 0);
        strokeCircle.setAttribute("cy", 0);
        strokeCircle.setAttribute("r", 14);
        strokeCircle.setAttribute("fill", "none");
        strokeCircle.classList.add("radar-avatar-circle");
        strokeCircle.style.stroke = "var(--accent-primary)";
        strokeCircle.style.strokeWidth = "2px";
        
        g.appendChild(strokeCircle);
        svg.appendChild(g);
    });

    // 8. Etykiety Projekt贸w
    projectLabels.forEach(lbl => {
        const text = document.createElementNS(svgNS, "text");
        text.setAttribute("x", lbl.x);
        text.setAttribute("y", lbl.y);
        const displayName = lbl.text.length > 18 ? lbl.text.substring(0, 16) + '...' : lbl.text;
        text.textContent = displayName;
        text.classList.add("radar-label", "radar-project-label");
        svg.appendChild(text);
    });

   

    container.appendChild(svg);
    tippy('.radar-node', { allowHTML: true, theme: 'light', animation: 'scale' });
    tippy('.radar-avatar-group', { allowHTML: true, theme: 'light' });

    // 9. Zoom & Pan
    let radarScale = 1;
    let radarTranslateX = 0;
    let radarTranslateY = -60;
    let isRadarPanning = false;
    let isRadarPanningMoved = false;
    let startPanX = 0;
    let startPanY = 0;

    const updateRadarTransform = () => {
        svg.style.transform = `translate(${radarTranslateX}px, ${radarTranslateY}px) scale(${radarScale})`;
        svg.style.transformOrigin = 'center center';
        svg.style.transition = isRadarPanning ? 'none' : 'transform 0.1s ease-out';
    };

    container.onwheel = null;
    container.oncontextmenu = null;
    container.onmousedown = null;
    window.onmousemove = null;
    window.onmouseup = null;

    container.addEventListener('wheel', (e) => {
        e.preventDefault();
        const zoomIntensity = 0.001;
        const delta = -e.deltaY;
        const newScale = radarScale + (delta * zoomIntensity * radarScale);
        radarScale = Math.min(Math.max(0.5, newScale), 5);
        updateRadarTransform();
    }, { passive: false });

    container.addEventListener('contextmenu', (e) => { e.preventDefault(); return false; });

    container.addEventListener('mousedown', (e) => {
        if (e.button === 2) {
            isRadarPanning = true;
            isRadarPanningMoved = false;
            startPanX = e.clientX - radarTranslateX;
            startPanY = e.clientY - radarTranslateY;
            svg.style.cursor = 'grabbing'; 
        }
    });

   // U偶ywamy lokalnych handler贸w, 偶eby nie zamieca globalnego window przy przerysowywaniu
    // (Dla uproszczenia w tym kroku zostawiamy window, ale w idealnym wiecie nale偶aoby je czyci)
    const mouseMoveHandler = (e) => {
        // === NOWE: Blokada Pan jeli cigniemy wze ===
        if (isDraggingNode) return; 
        // === KONIEC ===
        
        if (!isRadarPanning) return;
        e.preventDefault();
        const newX = e.clientX - startPanX;
        const newY = e.clientY - startPanY;
        if (Math.abs(newX - radarTranslateX) > 3 || Math.abs(newY - radarTranslateY) > 3) {
            isRadarPanningMoved = true;
        }
        radarTranslateX = newX;
        radarTranslateY = newY;
        updateRadarTransform();
    };
    
    const mouseUpHandler = () => {
        if (isRadarPanning) {
            isRadarPanning = false;
            svg.style.cursor = 'default'; 
            setTimeout(() => { isRadarPanningMoved = false; }, 50);
        }
    };

    window.addEventListener('mousemove', mouseMoveHandler);
    window.addEventListener('mouseup', mouseUpHandler);

    // === NOWE: Dymek "Live" dla przecigania (Wstawiony na kocu, aby by na wierzchu) ===
    const dragLabelGroup = document.createElementNS(svgNS, "g");
    dragLabelGroup.setAttribute("id", "radar-drag-label");
    dragLabelGroup.style.display = "none"; // Domylnie ukryty
    dragLabelGroup.style.pointerEvents = "none"; // Nie blokuje myszki
    
    // To dymka
    const dragLabelRect = document.createElementNS(svgNS, "rect");
    dragLabelRect.setAttribute("x", "-60");
    dragLabelRect.setAttribute("y", "-30");
    dragLabelRect.setAttribute("width", "120");
    dragLabelRect.setAttribute("height", "24");
    dragLabelRect.setAttribute("rx", "4");
    dragLabelRect.setAttribute("fill", "var(--bg-secondary)");
    dragLabelRect.setAttribute("stroke", "var(--accent-primary)");
    dragLabelRect.setAttribute("stroke-width", "1");
    
    // Tekst dymka
    const dragLabelText = document.createElementNS(svgNS, "text");
    dragLabelText.setAttribute("x", "0");
    dragLabelText.setAttribute("y", "-14");
    dragLabelText.setAttribute("text-anchor", "middle");
    dragLabelText.setAttribute("fill", "var(--text-primary)");
    dragLabelText.style.fontSize = "12px";
    dragLabelText.style.fontWeight = "600";
    dragLabelText.textContent = ""; // Pusty na start

    dragLabelGroup.appendChild(dragLabelRect);
    dragLabelGroup.appendChild(dragLabelText);
    svg.appendChild(dragLabelGroup); 
    // === KONIEC NOWEGO KODU ===

    svg.style.cursor = 'default'; 
    updateRadarTransform();
}
      // === ZMODYFIKOWANE ZMIENNE I FUNKCJE DRAG & DROP ===

let isDraggingNode = false;
let isMouseDownOnNode = false; // Nowa flaga: Czy przycisk jest wcinity na w藕le?
let dragStartX = 0;            // Nowa zmienna: Pozycja startowa X
let dragStartY = 0;            // Nowa zmienna: Pozycja startowa Y
let activeNode = null;
let activeTaskData = null;
let activeProjectData = null;
let radarCenter = 0;
let radarRadius = 0;
let activeSvg = null;
let tempNewDate = null;
let isRadarDragValid = true; // <<< NOWA ZMIENNA: Flaga walidacji

function handleRadarNodeDragStart(e, node, task, project, center, radius, svgElement) {
    // Nie u偶ywamy e.preventDefault() tutaj, aby pozwoli na kliknicie
    // Ale zatrzymujemy propagacj, by nie odpala Pan/Zoom radaru
    e.stopPropagation(); 

    isMouseDownOnNode = true;
    isDraggingNode = false; // Jeszcze nie cigniemy!
    isRadarDragValid = true; // <<< NOWE: Reset flagi przy rozpoczciu
    
    // Zapisz pozycj startow (dla myszy i dotyku)
    if (e.touches) {
        dragStartX = e.touches[0].clientX;
        dragStartY = e.touches[0].clientY;
    } else {
        dragStartX = e.clientX;
        dragStartY = e.clientY;
    }

    activeNode = node;
    activeTaskData = task;
    activeProjectData = project;
    radarCenter = center;
    radarRadius = radius;
    activeSvg = svgElement;

    // Nasuchuj ruchu
    window.addEventListener('mousemove', handleRadarNodeDragMove);
    window.addEventListener('touchmove', handleRadarNodeDragMove, { passive: false });
    window.addEventListener('mouseup', handleRadarNodeDragEnd);
    window.addEventListener('touchend', handleRadarNodeDragEnd);
}

function handleRadarNodeDragMove(e) {
    if (!isMouseDownOnNode) return;

    // 1. Pobierz obecne koordynaty
    const clientX = e.touches ? e.touches[0].clientX : e.clientX;
    const clientY = e.touches ? e.touches[0].clientY : e.clientY;

    // === NOWE: Sprawd藕 pr贸g przesunicia (Threshold 5px) ===
    if (!isDraggingNode) {
        const dist = Math.sqrt(Math.pow(clientX - dragStartX, 2) + Math.pow(clientY - dragStartY, 2));
        if (dist < 5) {
            return; // Ruch jest zbyt may, traktujemy jako dr偶enie rki przy klikaniu
        }
        // Przekroczono pr贸g -> Aktywuj tryb przecigania
        isDraggingNode = true;
        
        // Teraz mo偶emy zablokowa domylne zachowanie i pokaza dymek
        if (activeNode) {
            activeNode.style.cursor = 'grabbing';
            activeNode.style.transition = 'none';
            if (activeNode._tippy) activeNode._tippy.hide();
        }
        const label = document.getElementById('radar-drag-label');
        if (label) {
            label.style.display = 'block';
            activeSvg.appendChild(label);
        }
    }
    // === KONIEC SPRAWDZANIA PROGU ===

    if (!isDraggingNode) return;

    e.preventDefault(); // Blokuj scrollowanie tylko gdy faktycznie cigniemy

    // ... (RESZTA KODU OBLICZANIA POZYCJI I DATY BEZ ZMIAN) ...
    // ... Skopiuj reszt funkcji handleRadarNodeDragMove z poprzedniej odpowiedzi, zaczynajc od:
    // const pt = activeSvg.createSVGPoint();
    
    const pt = activeSvg.createSVGPoint();
    pt.x = clientX;
    pt.y = clientY;
    const svgP = pt.matrixTransform(activeSvg.getScreenCTM().inverse());

    // Przesu wze wizualnie
    if (activeNode.tagName === 'circle') {
        activeNode.setAttribute('cx', svgP.x);
        activeNode.setAttribute('cy', svgP.y);
    } else if (activeNode.tagName === 'polygon') {
        const r = 6 * 0.8; 
        const p1 = `${svgP.x},${svgP.y - r}`;
        const p2 = `${svgP.x + 0.866 * r},${svgP.y + 0.5 * r}`;
        const p3 = `${svgP.x - 0.866 * r},${svgP.y + 0.5 * r}`;
        activeNode.setAttribute("points", `${p1} ${p2} ${p3}`);
    }

    const dx = svgP.x - radarCenter;
    const dy = svgP.y - radarCenter;
    const distanceFromCenter = Math.sqrt(dx*dx + dy*dy);

    const ratio = distanceFromCenter / radarRadius;
    let diffDays = ((ratio - 0.2) / 0.75) * 60;
    diffDays = Math.round(diffDays);

    const newDate = new Date();
    newDate.setDate(newDate.getDate() + diffDays);
    tempNewDate = newDate.toISOString().split('T')[0];

    const labelGroup = document.getElementById('radar-drag-label');
    const labelText = labelGroup.querySelector('text');
    const labelRect = labelGroup.querySelector('rect');
    
    labelGroup.setAttribute("transform", `translate(${svgP.x}, ${svgP.y - 30})`);
    
    const dateStr = newDate.toLocaleDateString('pl-PL', { day: 'numeric', month: 'short' });
    
    // === POCZTEK NOWEJ LOGIKI WALIDACJI ===
    isRadarDragValid = true; // Zakadamy, 偶e jest ok
    let validationMsg = "";

    // Sprawd藕 czy to podzadanie (polygon) i czy ma rodzica z terminem
    if (activeNode.tagName === 'polygon' && activeProjectData) {
        const parentId = activeNode.dataset.taskId; // W radarze taskId na w藕le podzadania to ID rodzica
        const parentTask = activeProjectData.tasks.find(t => t.id === parentId);
        
        if (parentTask && parentTask.dueDate) {
            const parentDueISO = parentTask.dueDate.split('T')[0];
            
            if (tempNewDate > parentDueISO) {
                isRadarDragValid = false;
                const parentDatePretty = new Date(parentTask.dueDate).toLocaleDateString('pl-PL', { day: 'numeric', month: 'short' });
                validationMsg = `Blokada! Max: ${parentDatePretty}`;
            }
        }
    }
    // === KONIEC WALIDACJI ===

    if (!isRadarDragValid) {
        // Styl dla BDU (Przekroczony termin rodzica)
        labelText.textContent = validationMsg;
        labelRect.setAttribute("stroke", "var(--danger-primary)"); // Czerwona ramka
        labelRect.setAttribute("fill", "var(--danger-primary)");   // Czerwone to (dla mocnego efektu)
        labelText.setAttribute("fill", "white");                   // Biay tekst
    } else {
        // Standardowy styl (licznik dni)
        const diffText = diffDays === 0 ? '(Dzi)' : (diffDays > 0 ? `(za ${diffDays} dni)` : `(${Math.abs(diffDays)} dni temu)`);
        labelText.textContent = `${dateStr} ${diffText}`;
        
        // Reset koloru tekstu na domylny (bo m贸g zosta biay po bdzie)
        labelText.setAttribute("fill", "var(--text-primary)");

        if (diffDays < 0) {
            labelRect.setAttribute("stroke", "var(--danger-primary)");
            labelRect.setAttribute("fill", "#fee2e2");
        } else if (diffDays <= 3) {
            labelRect.setAttribute("stroke", "var(--accent-primary)");
            labelRect.setAttribute("fill", "var(--bg-secondary)");
        } else {
            labelRect.setAttribute("stroke", "var(--success-primary)");
            labelRect.setAttribute("fill", "var(--bg-secondary)");
        }
    }
}

async function handleRadarNodeDragEnd(e) {
    isMouseDownOnNode = false;
    
    // Usu listenery
    window.removeEventListener('mousemove', handleRadarNodeDragMove);
    window.removeEventListener('touchmove', handleRadarNodeDragMove);
    window.removeEventListener('mouseup', handleRadarNodeDragEnd);
    window.removeEventListener('touchend', handleRadarNodeDragEnd);

    // Jeli nie byo przecigania (tylko kliknicie)
    if (!isDraggingNode) {
        // === NOWE: Obsuga kliknicia (Otwarcie modala) ===
        if (activeNode && activeNode.dataset.taskId) {
            // Sprawd藕 czy to podzadanie (ma atrybut data-subtask-id)
            if (activeNode.dataset.subtaskId) {
                // Otw贸rz modal podzadania
                openSubtaskModal(activeNode.dataset.taskId, activeNode.dataset.subtaskId);
            } else {
                // Otw贸rz modal zadania g贸wnego
                openTaskModal(activeNode.dataset.taskId);
            }
        }
        // === KONIEC ===

        // Reset i wyjcie
        activeNode = null;
        activeTaskData = null;
        activeProjectData = null;
        return; 
    }

    isDraggingNode = false;

    // Ukryj dymek
    const label = document.getElementById('radar-drag-label');
    if (label) label.style.display = 'none';
    
    if (activeNode) {
        activeNode.style.cursor = 'grab';
        activeNode.style.transition = ''; 
    }

    // === NOWE: BLOKADA ZAPISU JELI DATA JEST NIEPOPRAWNA ===
    if (!isRadarDragValid) {
        showNotification("Nie mo偶na ustawi daty podzadania p贸藕niej ni偶 zadania g贸wnego.", "Bd");
        renderRadarView(); // Przerysuj radar, aby cofn wizualnie wze
        
        // Reset zmiennych
        activeNode = null;
        activeTaskData = null;
        activeProjectData = null;
        tempNewDate = null;
        return; // Przerwij funkcj
    }
    // === KONIEC BLOKADY ===

    // === ZAPISZ NOW DAT DO BAZY ===
    if (activeTaskData && activeProjectData && tempNewDate) {
        const taskId = activeTaskData.id;
        const projectId = activeProjectData.id;
        
        const oldDate = activeTaskData.dueDate ? activeTaskData.dueDate.split('T')[0] : null;
        
        if (tempNewDate !== oldDate) {
            // Zachowaj godzin
            let newTime = '12:00';
            if (activeTaskData.dueDate && activeTaskData.dueDate.includes('T')) {
                newTime = activeTaskData.dueDate.split('T')[1];
            }
            const finalIsoDate = `${tempNewDate}T${newTime}`;

            const projectDocRef = findProject(projectId) ? doc(projectsRef, projectId) : doc(completedProjectsRef, projectId);
            
            let updatedTasks = [...activeProjectData.tasks];
            
            // --- U呕YWAMY POPRAWIONEJ LOGIKI IDENTYFIKACJI ---
            updatedTasks = updatedTasks.map(t => {
                const isDraggingSubtask = activeNode.tagName === 'polygon';
                
                if (isDraggingSubtask) {
                    const parentId = activeNode.dataset.taskId; 
                    const subId = activeNode.dataset.subtaskId;

                    if (t.id === parentId) {
                        const updatedSubtasks = t.subtasks.map(s => {
                            if (s.id === subId) {
                                return { ...s, dueDate: finalIsoDate };
                            }
                            return s;
                        });
                        return { ...t, subtasks: updatedSubtasks };
                    }
                } else {
                    if (t.id === taskId) {
                        return { ...t, dueDate: finalIsoDate };
                    }
                }
                return t;
            });
            // ------------------------------------------------

            try {
                await updateDoc(projectDocRef, { tasks: updatedTasks });
                showNotification(`Zmieniono termin na ${tempNewDate}`, "Sukces");
            } catch (error) {
                console.error("Bd zapisu daty z radaru:", error);
                showNotification("Bd zmiany terminu.", "Bd");
                renderRadarView();
            }
        } else {
             renderRadarView();
        }
    }

    // Reset zmiennych
    activeNode = null;
    activeTaskData = null;
    activeProjectData = null;
    tempNewDate = null;
}
// === KONIEC NOWYCH FUNKCJI ===
        // NOWA FUNKCJA DO RENDEROWANIA WIDOKU WSZYSTKICH PROJEKTW
        function renderAllProjectsView() {
            kanbanBoardEl.className = 'all-projects-view';
            kanbanBoardEl.removeAttribute('style');
            projectNameHeaderEl.textContent = 'Wszystkie Projekty';
            mobileHeaderTitle.textContent = 'Wszystkie Projekty';
            projectMembersHeaderEl.innerHTML = '';

            // === CZYSZCZENIE NAGWKA (CLEAN UI) ===
            if (projectMenuToggle) projectMenuToggle.style.display = 'none';
            if (projectProgressContainer) projectProgressContainer.style.display = 'none';
            // === KONIEC ===

            sortBtn.style.display = 'none';

            kanbanBoardEl.innerHTML = `<div class="all-projects-grid"></div>`;
            const grid = kanbanBoardEl.querySelector('.all-projects-grid');
            grid.classList.toggle('layout-edit-mode', state.ui.allProjectsEditMode);

            const createProjectTileHTML = (project) => {
                const isOwner = project.ownerId === state.currentUser.uid;
                const tileClass = isOwner ? 'owner' : 'member';
                const isFavorite = state.currentUser.favorites.includes(project.id);
                const owner = findUser(project.ownerId);
                const priorityClass = project.priority === 'high' ? 'priority-high' : (project.priority === 'low' ? 'priority-low' : '');
                const projectTasks = (project.tasks || []);
                const totalTasks = projectTasks.length;
                const completedTasks = projectTasks.filter(t => t.status === 'done').length;
                const progressPercent = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
                const membersHTML = project.members.map(memberId => findUser(memberId)).filter(Boolean).map(user => renderAvatarHTML(user)).join('');

                // --- NOWE: Logika Dat (Start i Koniec) ---
                let dateHTML = '';
                let dateStartRow = '';
                let dateEndRow = '';

                // Data rozpoczcia (Ikona strzaki w d贸/flagi startowej)
                if (project.startDate) {
                    // ZMIANA: U偶ywamy formatu 2-digit dla dnia/miesica i numeric dla roku (DD.MM.RRRR)
                    const startFull = new Date(project.startDate).toLocaleDateString('pl-PL', { day: '2-digit', month: '2-digit', year: 'numeric' });
                    dateStartRow = `
                        <div class="task-detail" style="margin-right: 12px; display: flex; align-items: center; gap: 4px;">
                            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:14px;height:14px; color: var(--text-secondary);">
                                <path d="M5 3v18" /><path d="M5 4l10 5-10 5" />
                            </svg>
                            <span>${startFull}</span>
                        </div>`;
                }

                // Data zakoczenia (Ikona flagi)
                if (project.endDate) {
                    const endObj = new Date(project.endDate);
                    // ZMIANA: U偶ywamy formatu 2-digit dla dnia/miesica i numeric dla roku (DD.MM.RRRR)
                    const endFull = endObj.toLocaleDateString('pl-PL', { day: '2-digit', month: '2-digit', year: 'numeric' });
                    
                    // Sprawd藕 op贸藕nienie: Data mina ORAZ projekt nie jest w 100% ukoczony
                    const isOverdue = endObj.getTime() < Date.now() && progressPercent < 100;
                    const dueStyle = isOverdue ? 'color: var(--danger-primary); font-weight: 600;' : '';
                    const iconColor = isOverdue ? 'var(--danger-primary)' : 'var(--text-secondary)';

                    dateEndRow = `
                        <div class="task-detail ${isOverdue ? 'overdue' : ''}" style="display: flex; align-items: center; gap: 4px;">
                            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="${iconColor}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:14px;height:14px;">
                                <path d="M5 3v18" /><path d="M5 4h9l-2 3 2 3H5" />
                            </svg>
                            <span style="${dueStyle}">${endFull}</span>
                        </div>`;
                }

                // Z贸偶 sekcj dat, jeli kt贸rakolwiek data istnieje
                if (dateStartRow || dateEndRow) {
                    dateHTML = `<div style="display: flex; align-items: center; margin-bottom: 8px; font-size: 13px; color: var(--text-secondary);">${dateStartRow}${dateEndRow}</div>`;
                }
                // --- KONIEC NOWEJ LOGIKI ---

                return `<div class="project-tile ${tileClass} ${priorityClass}" data-id="${project.id}">
                    <div class="project-tile-header">
                        <h3 class="js-project-title" title="${project.name}">${project.name}</h3>
                        <button class="favorite-btn ${isFavorite ? 'is-favorite' : ''}" data-project-id="${project.id}">
                            <svg viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
                        </button>
                    </div>
                    
                    ${dateHTML} <div class="project-tile-details">
                        <div class="project-tile-owner"><strong>Waciciel:</strong> ${owner ? owner.name : 'Nieznany'}</div>
                        <div class="project-tile-members-list"><strong>Czonkowie:</strong> <div class="project-tile-members">${membersHTML}</div></div>
                    </div>
                    <div>
                         <div class="progress-bar-container"><div class="progress-bar-fill" style="width: ${progressPercent}%;"></div></div>
                        <div class="progress-text">${completedTasks} z ${totalTasks} zada ukoczonych</div>
                    </div>
                </div>`;
            };

            // KROK 1: Stw贸rz jedn list wszystkich projekt贸w do wywietlenia
            const displayProjects = state.projects.filter(p => !p.isInbox);

            // KROK 2: Przygotuj map z zapisan kolejnoci
            const customOrder = state.currentUser.layouts.allProjects || [];
            const orderMap = new Map(customOrder.map((id, index) => [id, index]));

            // KROK 3: Posortuj jedn list wedug nowej, zaawansowanej logiki
            displayProjects.sort((a, b) => {
                const indexA = orderMap.get(a.id);
                const indexB = orderMap.get(b.id);
                const isAOwner = a.ownerId === state.currentUser.uid;
                const isBOwner = b.ownerId === state.currentUser.uid;

                // Case 1: Oba projekty s w zapisanym ukadzie -> sortuj wg niego
                if (indexA !== undefined && indexB !== undefined) {
                    return indexA - indexB;
                }
                // Case 2: Tylko A jest w ukadzie -> A jest pierwsze
                if (indexA !== undefined) {
                    return -1;
                }
                // Case 3: Tylko B jest w ukadzie -> B jest pierwsze
                if (indexB !== undefined) {
                    return 1;
                }
                // Case 4: Oba projekty s nowe (nie ma ich w ukadzie)
                // -> sortuj najpierw po typie (owner > member), a potem alfabetycznie
                if (isAOwner && !isBOwner) {
                    return -1; // Waciciel przed czonkiem
                }
                if (!isAOwner && isBOwner) {
                    return 1; // Czonek za wacicielem
                }
                return a.name.localeCompare(b.name); // Alfabetycznie w ramach tego samego typu
            });

            // KROK 4: Wygeneruj HTML na podstawie jednej, poprawnie posortowanej listy
            grid.innerHTML = displayProjects.map(p => createProjectTileHTML(p)).join('');
            // NOWY DEDYKOWANY LISTENER DLA IKON ULUBIONYCH W WIDOKU 'ALL-PROJECTS'
            grid.addEventListener('click', (e) => {
                const favoriteBtn = e.target.closest('.favorite-btn');
                if (favoriteBtn) {
                    e.preventDefault(); // Zawsze zapobiegaj domylnej akcji linku/przycisku
                    const projectId = favoriteBtn.dataset.projectId;
                    toggleFavoriteProject(projectId);
                    return; // Zatrzymaj propagacj i wykonanie dalszej logiki
                }
            });
            // KONIEC DEDYKOWANEGO LISTENERA
            // Logika Sortable.js pozostaje bez zmian
            if (sortableProjects) {
                sortableProjects.destroy();
                sortableProjects = null;
            }
            if (state.ui.allProjectsEditMode && grid) {
                sortableProjects = new Sortable(grid, {
                    animation: 150,
                    ghostClass: 'sortable-ghost',
                    filter: '.other',
                });
            }
        }
        async function toggleFavoriteProject(projectId) {
            if (!state.currentUser) return;
            
            const userRef = doc(usersRef, state.currentUser.uid);
            const currentFavorites = state.currentUser.favorites || [];
            let updatedFavorites;

            if (currentFavorites.includes(projectId)) {
                updatedFavorites = currentFavorites.filter(id => id !== projectId);
            } else {
                updatedFavorites = [...currentFavorites, projectId];
            }

            try {
                await updateDoc(userRef, { favorites: updatedFavorites });
                state.currentUser.favorites = updatedFavorites;
                render(); 
            } catch (error) {
                console.error("Bd podczas aktualizacji ulubionych:", error);
                showNotification("Nie udao si zaktualizowa ulubionych projekt贸w.", "Bd");
                render(); // DODANO: Odwie偶enie widoku nawet w przypadku bdu
            }
        }
       
// NOWA, UNIWERSALNA FUNKCJA DO BUDOWANIA AKORDEONU Z CZONKAMI ZESPOU (WERSJA NAPRAWIONA)
// ZMIANA: Dodano parametr 'superUserIds'
function buildTeamMembersAccordion(containerElement, selectedMemberIds = [], projectOwnerId = null, adminIds = [], shouldLockOwner = true, superUserIds = []) {
    containerElement.innerHTML = ''; // Zawsze czycimy kontener na starcie

    const activeGroupId = state.ui.activeGroupId;
    
    // [DEBUG] Sprawd藕my, jaka jest aktywna grupa i ilu mamy u偶ytkownik贸w w pamici
    console.log(`[buildTeamMembersAccordion] Active Group ID: ${activeGroupId}`);
    console.log(`[buildTeamMembersAccordion] Total users in state: ${state.users.length}`);

    // 1. Filtrujemy u偶ytkownik贸w: sprawdzamy, czy nale偶 do AKTYWNEJ grupy
    const teamMembers = state.users.filter(u => {
        // Sprawd藕 czy user ma tablic groupIds I czy zawiera ona ID grupy
        const hasGroupId = u.groupIds && Array.isArray(u.groupIds) && u.groupIds.includes(activeGroupId);
        // LUB czy ma klucz w groupInfo
        const hasGroupInfoKey = u.groupInfo && u.groupInfo[activeGroupId];
        
        return hasGroupId || hasGroupInfoKey;
    });

    // 2. Grupujemy odfiltrowanych czonk贸w po ich podgrupie w RAMACH TEJ GRUPY
    const usersBySubgroup = teamMembers.reduce((acc, user) => {
        let subgroup = 'Bez przypisanej podgrupy';
        let source = 'default';

        // === ULEPSZONA LOGIKA ODCZYTU PODGRUPY ===
        // Sprawdzamy bezpiecznie istnienie zagnie偶d偶onych waciwoci
        if (user.groupInfo && user.groupInfo[activeGroupId] && user.groupInfo[activeGroupId].subgroup) {
            subgroup = user.groupInfo[activeGroupId].subgroup;
            source = 'groupInfo';
        } 
        // Fallback do starego pola, ale TYLKO jeli nie znaleziono w groupInfo
        else if (user.subgroupName) {
            subgroup = user.subgroupName;
            source = 'legacy';
        }
        
        if (!acc[subgroup]) {
            acc[subgroup] = [];
        }
        acc[subgroup].push(user);
        return acc;
    }, {});

    // 3. Tworzymy akordeon, iterujc po znalezionych podgrupach
    // Sortujemy klucze, aby 'Bez przypisanej podgrupy' byo na kocu (opcjonalne, tu sortujemy alfabetycznie)
    const sortedSubgroups = Object.keys(usersBySubgroup).sort();
    
    sortedSubgroups.forEach(subgroup => {
        const groupDiv = document.createElement('div');
        groupDiv.className = 'department-group';

        const headerDiv = document.createElement('div');
        headerDiv.className = 'department-header';
        // Dodajemy licznik os贸b w dziale
        headerDiv.innerHTML = `
            <span>${subgroup} <small style="font-weight:normal; color:var(--text-secondary);">(${usersBySubgroup[subgroup].length})</small></span>
            <svg class="chevron" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5" />
            </svg>
        `;

        const usersDiv = document.createElement('div');
        // Domylnie zwinite, CHYBA 呕E to jedyna grupa lub zawiera wybranego u偶ytkownika
        const shouldExpand = usersBySubgroup[subgroup].some(u => selectedMemberIds.includes(u.id));
        
        usersDiv.className = `department-users ${shouldExpand ? '' : 'collapsed'}`;
        
        if (shouldExpand) headerDiv.classList.add('active');

        // === ZMIANA: Dodajemy index do ptli forEach ===
        usersBySubgroup[subgroup].forEach((user, index) => {
            const isSelected = selectedMemberIds.includes(user.id);
            const isOwner = user.id === projectOwnerId || (!projectOwnerId && user.id === state.currentUser.uid);
            
            // === NOWA LOGIKA: Sprawd藕 czy blokowa waciciela ===
            const isDisabled = isOwner && shouldLockOwner; 

            const avatarHTML = renderAvatarHTML(user, 'member-pill-avatar');
            
            // === ZMIANA: Usunito generowanie przycisk贸w w lewej kolumnie ===
            // Zarzdzanie rolami odbywa si teraz wycznie w prawej kolumnie (Selected Members)
            let actionsHTML = ''; 
            // === KONIEC ZMIANY ===
            
            const pill = document.createElement('div');
            // === ZMIANA: U偶ywamy zmiennej isDisabled zamiast isOwner ===
            pill.className = `member-pill ${isSelected ? 'selected' : ''} ${isDisabled ? 'disabled' : ''}`;
            pill.style.width = '100%'; 
            pill.style.justifyContent = 'flex-start'; 
            pill.style.borderRadius = '4px'; 

            pill.dataset.userId = user.id;
            pill.title = user.name || user.email;
            
            // === ZMIANA: Dodanie numeracji do HTML ===
            // Dodajemy span z numerem (index + 1)
            pill.innerHTML = `
                <span style="color: var(--text-secondary); font-size: 12px; font-weight: 600; width: 25px; text-align: right; margin-right: 8px;">${index + 1}.</span>
                ${avatarHTML} 
                <span style="margin-left: 8px;">${user.name || user.email}</span> 
                
                <div style="margin-left: auto; display: flex; gap: 2px;">
                    ${actionsHTML}
                </div>
            `;
            // === KONIEC ZMIANY ===
            
            usersDiv.appendChild(pill);
        });

        groupDiv.appendChild(headerDiv);
        groupDiv.appendChild(usersDiv);
        containerElement.appendChild(groupDiv);
    });
}
      /**
         * NOWA FUNKCJA: Renderuje praw kolumn z list wybranych i interaktywnymi rolami.
         */
        function renderSelectedMembersColumn(leftContainer, rightContainer, ownerId = null, adminIds = [], superUserIds = []) {
            // 1. Pobierz zaznaczone w lewej kolumnie
            const selectedPills = Array.from(leftContainer.querySelectorAll('.member-pill.selected'));
            
            rightContainer.innerHTML = ''; 

            if (selectedPills.length === 0) {
                rightContainer.innerHTML = '<p style="color: var(--text-secondary); font-size: 13px; text-align: center; margin-top: 20px;">Brak wybranych os贸b.</p>';
                return;
            }

            selectedPills.forEach(pill => {
                const userId = pill.dataset.userId;
                const user = findUser(userId);
                if (!user) return;

                const isOwner = userId === ownerId;
                const isAdmin = adminIds.includes(userId);
                const isSuperUser = superUserIds.includes(userId);

                // Etykieta roli
                let roleLabel = 'Uczestnik';
                let roleColor = 'var(--bg-tertiary)';
                
                if (isOwner) {
                    roleLabel = 'Waciciel';
                    roleColor = '#fef3c7';
                } else if (isSuperUser) {
                    roleLabel = 'Super User';
                    roleColor = '#f3e8ff';
                } else if (isAdmin) {
                    roleLabel = 'Admin';
                    roleColor = '#e0f2fe';
                }

                // Przyciski r贸l (nie dla waciciela ORAZ tylko gdy ownerId jest zdefiniowany - czyli w kontekcie Projektu)
                let roleActionsHTML = '';
                // ZMIANA: Dodano warunek (ownerId !== null), aby ukry ikony w zadaniach/podzadaniach
                if (!isOwner && ownerId !== null) {
                    roleActionsHTML = `
                        <div class="role-actions">
                            <button type="button" class="role-btn is-superuser-btn ${isSuperUser ? 'active' : ''}" title="Przecz Super Usera" data-role="superuser">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none">
                                    <rect x="3" y="4" width="18" height="16" rx="4" />
                                    <path d="M15 9c0-1.4-1.2-2.5-3-2.5S9 7.6 9 9c0 1.3 1.1 1.9 3 2.6s3 1.2 3 2.4c0 1.4-1.2 2.5-3 2.5s-3-1.1-3-2.5" />
                                </svg>
                            </button>
                            <button type="button" class="role-btn is-admin-btn ${isAdmin ? 'active' : ''}" title="Przecz Administratora" data-role="admin">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M11.48 3.499a.562.562 0 011.04 0l2.125 5.111a.563.563 0 00.475.31h5.418a.563.563 0 01.31.988l-4.12 3.288a.563.563 0 00-.217.544l1.37 4.848a.562.562 0 01-.84.622l-4.48-3.096a.563.563 0 00-.65 0l-4.48 3.096a.562.562 0 01-.84-.622l1.37-4.848a.563.563 0 00-.217-.544l-4.12-3.288a.563.563 0 01.31-.988h5.418a.563.563 0 00.475-.31L11.48 3.5z" />
                                </svg>
                            </button>
                        </div>
                    `;
                } else {
                    roleActionsHTML = `<div style="margin-left: auto; margin-right: 8px;"></div>`;
                }

                // Przycisk usuwania (tylko jeli nie zablokowany - np. waciciel)
                const isLocked = pill.classList.contains('disabled');
                const removeBtnHTML = isLocked ? '' : `<button type="button" class="selected-member-remove" title="Usu z listy">&times;</button>`;

                const row = document.createElement('div');
                row.className = 'selected-member-row';
                row.dataset.userId = userId;
                
                row.innerHTML = `
                    <div class="selected-member-info" style="flex-grow: 1;">
                        ${renderAvatarHTML(user, 'member-pill-avatar')}
                        <div style="display:flex; flex-direction:column;">
                            <span style="font-weight: 500;">${user.name || user.email}</span>
                            <span style="font-size: 10px; color: var(--text-secondary);">
                                <span class="selected-member-role" style="background-color: ${roleColor}; margin-left: 0;">${roleLabel}</span>
                            </span>
                        </div>
                    </div>
                    ${roleActionsHTML}
                    ${removeBtnHTML}
                `;
                rightContainer.appendChild(row);
            });
        }
       /**
         * Konfiguruje wyszukiwark u偶ytkownik贸w dla danego modala.
         * @param {HTMLInputElement} inputElement - Pole wpisywania.
         * @param {HTMLUListElement} resultsElement - Lista wynik贸w.
         * @param {HTMLElement} pillsContainer - Kontener z pigukami (do sprawdzania zaznaczenia).
         */
        function setupUserSearch(inputElement, resultsElement, pillsContainer) {
            if (!inputElement || !resultsElement || !pillsContainer) return;

            // Funkcja czyszczca
            const clearSearch = () => {
                inputElement.value = '';
                resultsElement.innerHTML = '';
                resultsElement.classList.remove('visible');
            };

            // Listener na wpisywanie
            inputElement.addEventListener('input', (e) => {
                const term = e.target.value.toLowerCase().trim();
                
                if (term.length < 2) {
                    resultsElement.innerHTML = '';
                    resultsElement.classList.remove('visible');
                    return;
                }

                // Filtruj u偶ytkownik贸w z globalnego stanu
                const matches = state.users.filter(user => {
                    const name = (user.name || '').toLowerCase();
                    const email = (user.email || '').toLowerCase();
                    return name.includes(term) || email.includes(term);
                });

                if (matches.length === 0) {
                    resultsElement.innerHTML = '<li style="padding: 8px 12px; color: var(--text-secondary);">Brak wynik贸w</li>';
                    resultsElement.classList.add('visible');
                    return;
                }

                // Generuj HTML wynik贸w
                resultsElement.innerHTML = matches.map(user => {
                    // Sprawd藕, czy u偶ytkownik jest ju偶 zaznaczony w kontenerze piguek
                    // Szukamy piguki z tym ID i sprawdzamy czy ma klas .selected
                    const pill = pillsContainer.querySelector(`.member-pill[data-user-id="${user.id}"]`);
                    const isSelected = pill && pill.classList.contains('selected');
                    const isDisabled = pill && pill.classList.contains('disabled'); // Np. waciciel

                    let btnHTML;
                    if (isDisabled) {
                        btnHTML = `<span style="font-size: 12px; color: var(--text-secondary);">Waciciel</span>`;
                    } else if (isSelected) {
                        btnHTML = `<button type="button" class="member-search-add-btn added">Dodano</button>`;
                    } else {
                        btnHTML = `<button type="button" class="member-search-add-btn" data-user-id="${user.id}">Dodaj</button>`;
                    }

                    return `
                        <li class="member-search-item">
                            <div class="member-search-info">
                                ${renderAvatarHTML(user, 'member-pill-avatar')}
                                <span>${user.name || user.email}</span>
                            </div>
                            ${btnHTML}
                        </li>
                    `;
                }).join('');
                
                resultsElement.classList.add('visible');
            });

            // Listener na kliknicie w "Dodaj"
            resultsElement.addEventListener('click', (e) => {
                const btn = e.target.closest('.member-search-add-btn');
                if (!btn || btn.classList.contains('added')) return;

                const userId = btn.dataset.userId;
                
                // Znajd藕 odpowiedni piguk w akordeonie i kliknij j (lub dodaj klas)
                const pill = pillsContainer.querySelector(`.member-pill[data-user-id="${userId}"]`);
                
                if (pill) {
                    // === ZMIANA: Symulujemy kliknicie zamiast rcznie dodawa klas ===
                    // Dziki temu uruchomi si logika aktualizacji prawej kolumny (w oknach projektu)
                    if (!pill.classList.contains('selected')) {
                        pill.click();
                    }
                    // === KONIEC ZMIANY ===
                    
                    // Jeli piguka jest w zwinitej sekcji, rozwi sekcj (opcjonalne, ale mie dla UX)
                    const parentSection = pill.closest('.department-users');
                    const header = parentSection ? parentSection.previousElementSibling : null;
                    if (parentSection && parentSection.classList.contains('collapsed') && header) {
                        parentSection.classList.remove('collapsed');
                        header.classList.add('active');
                    }
                    
                    // Zaktualizuj przycisk w wynikach wyszukiwania
                    btn.textContent = "Dodano";
                    btn.classList.add('added');
                }
            });

            // Zamykanie wynik贸w po klikniciu poza
            document.addEventListener('click', (e) => {
                if (!inputElement.contains(e.target) && !resultsElement.contains(e.target)) {
                    resultsElement.classList.remove('visible');
                }
            });
        }
       // NOWA FUNKCJA DO RENDEROWANIA WIDOKU ARCHIWUM (POPRAWIONA)
        function renderArchiveView() {
            kanbanBoardEl.className = 'all-projects-view'; 
            kanbanBoardEl.removeAttribute('style');
            projectNameHeaderEl.textContent = 'Archiwum Projekt贸w';
            mobileHeaderTitle.textContent = 'Archiwum';
            projectMembersHeaderEl.innerHTML = '';
            
            // Ukrywanie element贸w niepotrzebnych w archiwum
            if (projectMenuToggle) projectMenuToggle.style.display = 'none';
            if (projectProgressContainer) projectProgressContainer.style.display = 'none';
            if (sortBtn) sortBtn.style.display = 'none'; 
            if (editProjectsLayoutBtn) editProjectsLayoutBtn.style.display = 'none';

            kanbanBoardEl.innerHTML = `<div class="all-projects-grid"></div>`;
            const grid = kanbanBoardEl.querySelector('.all-projects-grid');
            
            // --- FUNKCJA WEWNTRZNA: TWORZENIE KAFELKA ---
            const createArchiveTileHTML = (project) => {
                const owner = findUser(project.ownerId);
                const projectTasks = (project.tasks || []);
                
                // ZMIANA: Rozdzielenie licznik贸w
                const mainTaskCount = projectTasks.length;
                const subTaskCount = projectTasks.reduce((acc, task) => acc + (task.subtasks ? task.subtasks.length : 0), 0);
                
                const membersHTML = project.members.map(memberId => findUser(memberId)).filter(Boolean).map(user => renderAvatarHTML(user)).join('');

                // 1. NAJPIERW DEFINIUJEMY ZMIENN (Naprawa bdu ReferenceError)
                const canRestore = project.ownerId === state.currentUser.uid || (project.admins || []).includes(state.currentUser.uid);

                // 2. Przycisk Szczeg贸y (Raport)
                const detailsBtnHTML = `
                    <button class="btn btn-secondary btn-sm js-report-project-btn" data-project-id="${project.id}" style="padding: 6px 12px; font-size: 12px; display: inline-flex; align-items: center; gap: 6px; margin-right: 8px;">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 14px; height: 14px;">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 0 0-3.375-3.375h-1.5A1.125 1.125 0 0 1 13.5 7.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 0 0-9-9Z" />
                        </svg>
                        Szczeg贸y
                    </button>
                `;

                // 3. Przycisk Przywr贸 (Warunkowy)
                const restoreBtnHTML = canRestore ? `
                    <button class="btn btn-primary btn-sm js-restore-project-btn" data-project-id="${project.id}" style="padding: 6px 12px; font-size: 12px; display: inline-flex; align-items: center; gap: 6px;">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 14px; height: 14px;">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M9 15 3 9m0 0 6-6M3 9h12a6 6 0 0 1 0 12h-3" />
                        </svg>
                        Przywr贸
                    </button>` : '';

                return `<div class="project-tile" data-id="${project.id}" style="opacity: 0.9;">
                    <div class="project-tile-header">
                        <h3 class="js-project-title" title="${project.name}">${project.name}</h3>
                        </div>
                     <div class="project-tile-details">
                        <div class="project-tile-owner"><strong>Waciciel:</strong> ${owner ? owner.name : 'Nieznany'}</div>
                        <div class="project-tile-members-list"><strong>Czonkowie:</strong> <div class="project-tile-members">${membersHTML}</div></div>
                    </div>
                    <div>
                        <div class="progress-text">
                            <span style="font-weight: 600; color: var(--text-primary);">${mainTaskCount}</span> zada, 
                            <span style="font-weight: 600; color: var(--text-secondary);">${subTaskCount}</span> podzada
                        </div>
                    </div>
                    <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border-color); text-align: right;">
                         ${detailsBtnHTML}
                         ${restoreBtnHTML}
                    </div>
                </div>`;
            };
            // --- KONIEC FUNKCJI WEWNTRZNEJ ---

            const archivedProjects = [...state.completedProjects].sort((a, b) => a.name.localeCompare(b.name));

            if (archivedProjects.length === 0) {
                grid.innerHTML = '<p class="no-tasks-message">Archiwum jest puste. Zakocz projekt, aby zobaczy go tutaj.</p>';
            } else {
                grid.innerHTML = archivedProjects.map(p => createArchiveTileHTML(p)).join('');
            }
            
            // Listener do klikania na kafelki w archiwum
            grid.addEventListener('click', (e) => {
                // A. Kliknicie w "Przywr贸"
                const restoreBtn = e.target.closest('.js-restore-project-btn');
                if (restoreBtn) {
                    e.preventDefault(); e.stopPropagation();
                    const projectId = restoreBtn.dataset.projectId;
                    handleRestoreProject(projectId);
                    return;
                }
                
                // B. Kliknicie w "Szczeg贸y" (Raport)
                const reportBtn = e.target.closest('.js-report-project-btn');
                if (reportBtn) {
                    e.preventDefault(); e.stopPropagation();
                    const projectId = reportBtn.dataset.projectId;
                    openProjectReportModal(projectId);
                    return;
                }

                // C. Kliknicie w kafelek (otwiera projekt w trybie read-only)
                const projectTile = e.target.closest('.project-tile');
                if (projectTile) {
                    const projectId = projectTile.dataset.id;
                    state.currentProjectId = projectId;
                    state.ui.previousView = state.ui.currentView;
                    state.ui.currentView = 'projects';
                    saveUiState();
                    render();
                }
            });
        }

        /**
         * NOWA FUNKCJA: Przywraca projekt z archiwum do aktywnych.
         */
        async function handleRestoreProject(projectId) {
            const project = state.completedProjects.find(p => p.id === projectId);
            if (!project) return;

            showConfirmation(
                "Przywr贸 projekt",
                `Czy na pewno chcesz reaktywowa projekt "${project.name}"? Zostanie on przeniesiony do listy aktywnych projekt贸w, a wszyscy czonkowie otrzymaj powiadomienie.`,
                async (confirmed) => {
                    if (confirmed) {
                        try {
                            // 1. Przenie dokument z completedProjects -> projects
                            const completedRef = doc(completedProjectsRef, projectId);
                            const activeRef = doc(projectsRef, projectId);
                            
                            // Pobierz dane (dla pewnoci, 偶e mamy najnowsz wersj z serwera)
                            const snapshot = await getDoc(completedRef);
                            if (!snapshot.exists()) throw new Error("Projekt nie istnieje w archiwum.");
                            
                            const projectData = snapshot.data();
                            
                            // U偶yj batcha dla atomowoci
                            const batch = writeBatch(db);
                            batch.set(activeRef, projectData); // Utw贸rz w aktywnych
                            batch.delete(completedRef);        // Usu z archiwum
                            
                            await batch.commit();

                            // 2. Wylij profesjonalne powiadomienia biznesowe
                            if (project.members && project.members.length > 0) {
                                const msg = `
                                    <div style="margin-bottom: 4px;"><strong>Projekt Reaktywowany</strong></div>
                                    Informujemy, 偶e projekt "<strong>${project.name}</strong>" zosta przywr贸cony do aktywnych dziaa. Tw贸j dostp operacyjny zosta w peni przywr贸cony.
                                `;
                                
                                sendInternalNotification(
                                    project.members, // Wylij do wszystkich czonk贸w
                                    'alert',         // Typ alert (u偶yje dzwonka/ikony)
                                    msg,
                                    { type: 'project', projectId: projectId },
                                    'project_invite' // U偶yjemy tej samej preferencji co dla zaprosze (wa偶ne info)
                                );
                            }

                            showNotification("Projekt zosta pomylnie przywr贸cony.", "Sukces");
                            
                            // Przeaduj widok (onSnapshot powinien to zrobi, ale wymuszamy dla pewnoci UI)
                            // Jeli jestemy w archiwum, projekt zniknie z listy.
                            
                        } catch (error) {
                            console.error("Bd przywracania projektu:", error);
                            showNotification("Wystpi bd podczas przywracania projektu.", "Bd");
                        }
                    }
                }
            );
        }
      
        function render() {
            if (!state.currentUser) return;
            applyTheme();
            // === POCZTEK ZMIANY: Renderowanie Przecznika Grup ===
            if (state.ui.activeGroupInfo) {
                // 1. Ustaw nazw aktywnej grupy
                groupSwitcher.activeName.textContent = state.ui.activeGroupInfo.name;
                
               // 2. Sprawd藕, czy u偶ytkownik jest wacicielem AKTYWNEJ grupy
                const amIOwner = state.ui.activeGroupInfo.role === 'owner';
                groupSwitcher.manageBtn.style.display = amIOwner ? 'block' : 'none';
                groupSwitcher.inviteBtn.style.display = amIOwner ? 'block' : 'none'; // <-- DODANA TA LINIA
                groupSwitcher.leaveBtn.style.display = amIOwner ? 'none' : 'block';

                // 3. Zbuduj list grup do przeczenia
                const groupIds = state.currentUser.groupIds || [];
                groupSwitcher.list.innerHTML = ''; // Wyczy list
                
                groupIds.forEach(gid => {
                    const groupInfo = state.currentUser.groupInfo[gid];
                    if (groupInfo) {
                        const isActive = (gid === state.ui.activeGroupId);
                        groupSwitcher.list.innerHTML += `
                            <button class="group-menu-item ${isActive ? 'active' : ''}" data-group-id="${gid}">
                                ${isActive ? ' ' : ''}${groupInfo.name}
                            </button>
                        `;
                    }
                });
            } else {
                // Stan awaryjny, jeli u偶ytkownik nie ma aktywnej grupy (nie powinien wystpi po zalogowaniu)
                groupSwitcher.activeName.textContent = "Brak Grupy";
                groupSwitcher.list.innerHTML = '';
                groupSwitcher.manageBtn.style.display = 'none';
            }
            // === KONIEC ZMIANY ===
            renderSidebar();

            // === NOWA LOGIKA DLA DZWONKA I LICZNIKA POWIADOMIE ===
            // (filtrujemy powiadomienia tylko z aktywnej grupy, cho listener ju偶 to robi)
            const unreadCount = state.notifications.filter(n => !n.isRead && n.groupId === state.ui.activeGroupId).length;
            document.querySelectorAll('#notification-toggle-btn, #notification-toggle-btn-mobile').forEach(btn => {
                const badge = btn.querySelector('.notification-badge');
                btn.classList.toggle('has-notifications', unreadCount > 0);
                if (badge) {
                    if (unreadCount > 0) {
                        badge.textContent = unreadCount > 9 ? '9+' : unreadCount;
                        badge.style.display = 'flex';
                    } else {
                        badge.style.display = 'none';
                    }
                }
            });
            // === KONIEC NOWEJ LOGIKI ===

            const shouldShowBackButton = state.ui.currentView === 'projects' && state.ui.previousView === 'all-projects';
            if (backToProjectsBtn) {
                backToProjectsBtn.style.display = shouldShowBackButton ? 'flex' : 'none';
            }
            if (backToProjectsBtnMobile) {
                backToProjectsBtnMobile.style.display = shouldShowBackButton ? 'flex' : 'none';
                if(menuToggle) menuToggle.style.display = shouldShowBackButton ? 'none' : 'flex';
            }

            // NOWA LOGIKA: Zarzdzanie widocznoci nag贸wk贸w
            const isMyDayView = state.ui.currentView === 'my-day';
        // Usunito: const myDayTitleContainer = document.getElementById('my-day-title-container'); 

        // Wersja desktopowa
        if (myDayNav.container) {
             myDayNav.container.style.display = isMyDayView ? 'flex' : 'none';
        }
        // Usunito logik sterowania myDayTitleContainer
        
        const projectTitleWrapper = document.querySelector('.project-title-wrapper');
        if (projectTitleWrapper) {
            projectTitleWrapper.style.display = isMyDayView ? 'none' : 'flex';
        }
        // Wersja mobilna
        if (myDayNavMobile.container) {
             myDayNavMobile.container.style.display = isMyDayView ? 'flex' : 'none';
             if (mobileHeaderTitle) {
                 mobileHeaderTitle.style.display = isMyDayView ? 'none' : 'block';
             }
        }
            const isMobile = window.innerWidth <= 768;
            const mobileCalendarWrapper = document.getElementById('mobile-calendar-wrapper');

            calendarViewEl.style.display = 'none';
            kanbanBoardEl.style.display = 'none';
            if (mobileCalendarWrapper) mobileCalendarWrapper.style.display = 'none';
            mobileProjectActionsToggle.style.display = 'none';
            mobileProjectActionsMenu.style.display = 'none';
            document.querySelectorAll('#calendar-toggle-btn, #calendar-toggle-btn-mobile').forEach(btn => {
                btn.classList.toggle('active', state.ui.isCalendarView);
            });

            const isProjectView = state.ui.currentView === 'projects' && state.currentProjectId;
            const emptyStateEl = document.getElementById('my-day-empty-state');
            if (emptyStateEl) {
                // ZMIANA: Ukrycie Pustego Stanu domylnie przy ka偶dym renderowaniu
                emptyStateEl.style.display = 'none';
            }

            const isModalOpen = !!document.querySelector('.modal-overlay.visible');
            // MODYFIKACJA: Usunito warunek 'isMobile &&'
            const shouldShowFabs = !state.ui.isCalendarView && (isProjectView || isMyDayView) && !isModalOpen;

            if (fabMenuToggle) fabMenuToggle.style.display = shouldShowFabs ? 'block' : 'none'; // <-- POPRAWKA TUTAJ
            if (fabAddSpecialTask) fabAddSpecialTask.style.display = shouldShowFabs ? 'block' : 'none'; // <-- TA LINIA POZOSTAJE BEZ ZMIAN

            // === NOWA LOGIKA WIDOCZNOCI IKON CZATU ===
            // Sprawd藕, czy bie偶cy projekt to "Skrzynka zada" (Inbox)
            let currentProject = null;
            if (isProjectView) {
                currentProject = findProject(state.currentProjectId) || findCompletedProject(state.currentProjectId);
            }
            const isInbox = currentProject && currentProject.isInbox === true;

            // Poka偶 ikony czatu tylko wtedy, gdy jestemy w widoku projektu,
            // nie ma otwartego modala ORAZ projekt NIE JEST Skrzynk zada.
            const shouldShowChatIcons = isProjectView && !isModalOpen && !isInbox;
            if (toggleChatBtn) {
                toggleChatBtn.style.display = shouldShowChatIcons ? 'flex' : 'none';
            }
            // === NOWE: Widoczno przycisku Kosza ===
            // Poka偶 kosz tylko w widoku projektu (nie Dashboard, nie M贸j Dzie)
            if (trashModal.openBtn) {
                trashModal.openBtn.style.display = (isProjectView && !isModalOpen) ? 'inline-flex' : 'none';
            }
            // === KONIEC ===
            if (toggleChatBtnMobile) {
                toggleChatBtnMobile.style.display = shouldShowChatIcons ? 'flex' : 'none';
            }
            
            // === NOWA LOGIKA: Widoczno przycisku "Nowe Okno" ===
            // Pokazujemy go tylko w widoku projektu (i nie w kalendarzu, nie w modalu)
            if (openNewWindowBtn) {
                // Ukrywamy na mobilnych (zazwyczaj tam nowe okna s mniej wygodne, ale mo偶na to zmieni usuwajc !isMobile)
                openNewWindowBtn.style.display = (isProjectView && !isModalOpen && !state.ui.isCalendarView && !isMobile) ? 'flex' : 'none';
            }
            // === KONIEC ===

            // === KONIEC NOWEJ LOGIKI ===

            if (state.ui.isCalendarView) {
                projectNameHeaderEl.textContent = 'Kalendarz Zada';
                mobileHeaderTitle.textContent = 'Kalendarz Zada';
                
                // === UKRYWANIE ELEMENTW NIEPOTRZEBNYCH W KALENDARZU ===
                // ZMIANA: Ukrywamy nowe menu zamiast starego projectActionsEl
                if (projectMenuToggle) projectMenuToggle.style.display = 'none';
                
                sortBtn.style.display = 'none';
                
                // ZMIANA: U偶ywamy nowej zmiennej projectProgressContainer
                if (projectProgressContainer) projectProgressContainer.style.display = 'none';
                
                projectMembersHeaderEl.style.display = 'none';

                // Ukryj przyciski nawigacyjne i narzdziowe
                if (manageColumnsBtn) manageColumnsBtn.style.display = 'none'; // Kolumny
                if (selectModeToggleBtn) selectModeToggleBtn.style.display = 'none'; // Zaznacz
                if (filterBtn) filterBtn.style.display = 'none'; // Filtr
                
                // Ukryj akcje globalne/projektowe
                if (toggleChatBtn) toggleChatBtn.style.display = 'none'; // Czat
                if (trashModal.openBtn) trashModal.openBtn.style.display = 'none'; // Kosz
                if (notificationToggleBtn) notificationToggleBtn.style.display = 'none'; // Powiadomienia
                
                // Ukryj te偶 przycisk "Nowe okno" dla porzdku
                if (openNewWindowBtn) openNewWindowBtn.style.display = 'none';
                // === KONIEC ===

                if (isMobile) {
                    kanbanBoardEl.style.display = 'none';
                    renderMobileCalendar();
                } else {
                    calendarViewEl.style.display = 'block';
                    const myTasks = getAllMyTasks();
                    const calendarEvents = myTasks
                        .filter(task => task.dueDate && task.status !== 'done')
                        .map(task => {
                            const project = findProject(task.projectId) || findCompletedProject(task.projectId);
                            const owner = project ? findUser(project.ownerId) : null;

                            return {
                                id: task.id,
                                title: task.title,
                                start: task.dueDate,
                                backgroundColor: task.priority === 'high' ? 'var(--danger-primary)' : 'var(--accent-primary)',
                                borderColor: task.priority === 'high' ? 'var(--danger-primary)' : 'var(--accent-primary)',
                                extendedProps: {
                                    projectName: task.projectName || 'Brak projektu',
                                    description: task.description || 'Brak opisu.',
                                    ownerName: owner ? owner.name : 'Nieznany'
                                }
                            };
                        });

                    if (calendarInstance) {
                        calendarInstance.updateSize();
                        calendarInstance.removeAllEvents();
                        calendarInstance.addEventSource(calendarEvents);
                    }
                }

            } else {
                
                kanbanBoardEl.style.display = '';
                
                // === ZMIANA: Reset widocznoci ikony kalendarza (przywracamy j po wyjciu z Radaru) ===
                if (calendarToggleBtn) calendarToggleBtn.style.display = ''; 
                
                // === NOWE: Reset widocznoci separator贸w (pionowych kresek) ===
                document.querySelectorAll('.header-divider').forEach(el => el.style.display = '');
                // === KONIEC ZMIANY ===

                const isDashboardView = state.ui.currentView === 'my-dashboard';
                const isAllProjectsView = state.ui.currentView === 'all-projects';
                const isMobileView = window.innerWidth <= 768; // Sprawdzenie, czy jestemy w widoku mobilnym
            
            // NOWA LOGIKA: Zarzdzanie widocznoci przycisk贸w Sort i Filter
            // W widoku mobilnym ukrywamy przyciski desktopowe, aby u偶y menu akcji.
            const shouldShowSortAndFilterDesktop = (isProjectView && !isMobileView) || (isDashboardView && !isMobileView);
            
            if (sortBtn) {
                sortBtn.style.display = shouldShowSortAndFilterDesktop ? 'flex' : 'none';
            }

            // === NOWA POPRAWKA: Ukrywanie przycisku kolumn poza widokiem projektu ===
            // Jeli nie jestemy w widoku pojedynczego projektu, przycisk musi znikn.
            if (manageColumnsBtn && !isProjectView) {
                manageColumnsBtn.style.display = 'none';
            }
            // === KONIEC POPRAWKI ===

            // --- WIDOCZNO PRZYCISKU FILTRA ---
            if (filterBtn) {
                // Filtr jest dostpny tylko w widoku projektu, i tylko na desktopie.
                filterBtn.style.display = isProjectView && !isMobileView ? 'flex' : 'none'; 
            }

            // === NOWA LINIA: STEROWANIE WIDOCZNOCI PRZYCISKU "ZAZNACZ" ===
            if (selectModeToggleBtn) {
                // Przycisk "Zaznacz" pokazuj tylko w widoku projektu (Kanban) na desktopie
                selectModeToggleBtn.style.display = isProjectView && !isMobileView ? 'flex' : 'none';
            }
            // === KONIEC NOWEJ LINII ===
            
            if (editDashboardLayoutBtn) {
                    editDashboardLayoutBtn.style.display = isDashboardView ? 'flex' : 'none';
                }
                if (editProjectsLayoutBtn) {
                    editProjectsLayoutBtn.style.display = isAllProjectsView ? 'flex' : 'none';
                }

                if (isProjectView || isDashboardView) {
                sortBtn.style.display = 'flex'; // Poka偶 przycisk

                // === LOGIKA DODAWANIA KLAS (jeli potrzebna do kliknicia) ===
                let currentSortOrder = 'asc';
                if (isDashboardView) {
                    currentSortOrder = state.ui.sortMyTasksByDate || 'asc';
                } else if (isProjectView && state.currentProjectId) {
                    currentSortOrder = state.ui.projectSortOrders[state.currentProjectId] || 'asc';
                }
                // Nadal ustawiamy klasy, aby logika kliknicia moga dziaa,
                // ale nie s one ju偶 potrzebne do wywietlania ikony.
                sortBtn.classList.remove('sort-asc', 'sort-desc');
                sortBtn.classList.add(currentSortOrder === 'asc' ? 'sort-asc' : 'sort-desc');
                // === KONIEC LOGIKI KLAS ===

            } else {
                sortBtn.style.display = 'none'; // Ukryj przycisk
                sortBtn.classList.remove('sort-asc', 'sort-desc'); // Nadal usuwamy klasy przy ukrywaniu
            }

                 if (isProjectView) {
                    renderCurrentProjectView();
                    // === POCZTEK NOWEJ LOGIKI DLA MENU MOBILNEGO ===
                    if (isMobile) {
                        const project = findProject(state.currentProjectId) || findCompletedProject(state.currentProjectId);
                        
                        // U偶ywamy tej samej logiki co dla desktopu (zdefiniowanej wy偶ej)
                        // canManageProject = isOwner || isAdmin
                        if (project && canManageProject) { // <-- ZMIANA WARUNKU
                            mobileProjectActionsToggle.style.display = 'flex'; // Poka偶 przycisk menu akcji

                            // Dynamiczne wypenianie i pokazywanie/ukrywanie opcji w menu
                            const menuUl = mobileProjectActionsMenu.querySelector('ul');
                        if (menuUl) {
                            const isCompleted = !!findCompletedProject(state.currentProjectId);
                            // === POCZTEK ZMIANY: Rozbudowana logika uprawnie (mobilna) ===
                            const isOwner = project.ownerId === state.currentUser.uid;
                            const isAdmin = (project.admins || []).includes(state.currentUser.uid);
            
                            const canEditProject = (isOwner || isAdmin) && !project.isInbox;
                            const canDeleteOrComplete = isOwner && !project.isInbox;

                            // ZMIANA: Szczeg贸y widoczne tylko, jeli mo偶na edytowa
                            menuUl.querySelector('a[data-action="details"]').parentElement.style.display = canEditProject ? 'block' : 'none'; 
                            menuUl.querySelector('a[data-action="edit"]').parentElement.style.display = canEditProject ? 'block' : 'none'; // Edycja dla Waciciela LUB Admina
                            menuUl.querySelector('a[data-action="complete"]').parentElement.style.display = (canDeleteOrComplete && !isCompleted) ? 'block' : 'none'; // Zakocz tylko dla Waciciela
                            menuUl.querySelector('a[data-action="delete"]').parentElement.style.display = canDeleteOrComplete ? 'block' : 'none'; // Usu tylko dla Waciciela
                            // === KONIEC ZMIANY ===
                        }
                    }
                    }
                    // === KONIEC NOWEJ LOGIKI DLA MENU MOBILNEGO ===
                } else if (isDashboardView) {
                    setupChatListener(null); // <--- NOWA LINIA
                    renderMyDashboardView();
                } else if (isMyDayView) {
                    setupChatListener(null); // <--- NOWA LINIA
                    renderMyDayView();
                } else if (state.ui.currentView === 'all-projects') {
                    renderAllProjectsView();
                } else if (state.ui.currentView === 'archive') { // <-- DODANY BLOK
                    renderArchiveView();
                } 
                // === NOWE: Obsuga widoku Radaru ===
                else if (state.ui.currentView === 'radar') {
                    renderRadarView();
                }
                // ==================================
                
                projectMembersHeaderEl.style.display = isMyDayView ? 'none' : 'flex';
            }
            
            // Dodatkowe czyszczenie: Jeli nie jestemy w radarze, ukryj jego kontener
            const radarEl = document.getElementById('radar-view');
            if (state.ui.currentView !== 'radar' && radarEl) {
                radarEl.style.display = 'none';
            }
            
            // Dodatkowe czyszczenie dla kalendarza (upewnienie si)
            if (state.ui.currentView === 'radar') {
                 if(calendarViewEl) calendarViewEl.style.display = 'none';
                 if(kanbanBoardEl) kanbanBoardEl.style.display = 'none';
            }
            
            // Dodatkowe czyszczenie: Jeli nie jestemy w radarze, ukryj jego kontener
            
            if (state.ui.currentView !== 'radar' && radarEl) {
                radarEl.style.display = 'none';
            }
            // === NOWA LOGIKA: Automatyczne odwie偶anie otwartego modala szczeg贸贸w ===
            // Sprawdzamy, czy modal szczeg贸贸w jest aktualnie otwarty
            if (projectDetailsModal.overlay.classList.contains('visible') && state.currentProjectId) {
                const project = findProject(state.currentProjectId);
                
                // Jeli projekt nadal istnieje (nie zosta usunity)
                if (project) {
                    // ... (istniejcy kod odwie偶ania szczeg贸贸w projektu) ...
                    renderProjectBudgetChartCSS(project, projectDetailsModal.budgetChartContainer);
                    renderProjectBudgetTasksTable(project, 'details-budget-tasks-table-container');
                    renderProjectWorkloadChart(
                        project, 
                        projectDetailsModal.workloadChartContainer, 
                        projectDetailsModal.workloadChartPlaceholder
                    );
                }
            }
            // === KONIEC NOWEJ LOGIKI ===

            // === NOWA LOGIKA LIVE UPDATE: Odwie偶anie otwartego Zadania i Podzadania ===
            
            // 1. Odwie偶anie G贸wnego Zadania (Komentarze, Historia, Zaczniki + DATY)
            if (taskModal.overlay.classList.contains('visible')) {
                const openedTaskId = taskModal.overlay.dataset.taskId;
                if (openedTaskId) {
                    const { task } = findTask(openedTaskId);
                    if (task) {
                        // Odwie偶 sekcje dynamiczne
                        renderComments(task);
                        renderActivityLog(task);
                        renderAttachments(task);
                        renderSubtaskListInMainModal(task);

                        // === NOWE: Live Update DAT w inputach ===
                        if (document.activeElement !== taskModal.dueDateDate && 
                            document.activeElement !== taskModal.dueDateHour &&
                            document.activeElement !== taskModal.dueDateMinute) {
                            
                            if (task.dueDate) {
                                const parts = task.dueDate.split('T');
                                taskModal.dueDateDate.value = parts[0];
                                if (parts[1]) {
                                    const time = parts[1].split(':');
                                    taskModal.dueDateHour.value = time[0];
                                    taskModal.dueDateMinute.value = time[1];
                                }
                            } else {
                                taskModal.dueDateDate.value = '';
                            }
                        }
                        // === KONIEC ===
                    }
                }
            }

            // 2. Odwie偶anie Podzadania (Komentarze)
            if (subtaskModal.overlay.classList.contains('visible')) {
                const mainTaskId = subtaskModal.overlay.dataset.mainTaskId;
                const subtaskId = subtaskModal.subtaskIdInput.value; // ID aktualnie otwartego podzadania
                
                if (mainTaskId && subtaskId) {
                    const { task: mainTask } = findTask(mainTaskId);
                    if (mainTask && mainTask.subtasks) {
                        const subtask = mainTask.subtasks.find(s => s.id === subtaskId);
                        if (subtask) {
                            // Odwie偶 komentarze w podzadaniu "na 偶ywo"
                            renderSubtaskComments(subtask.comments || []);
                            
                            // Opcjonalnie: Odwie偶 te偶 list zacznik贸w w podzadaniu (jeli kto doda)
                            // Tutaj musielibymy mie funkcj renderSubtaskAttachments, 
                            // ale na razie lista 'staged' jest lokalna, a lista zapisanych jest statyczna w HTMLu.
                            // W poprzednim kroku dodalimy wywietlanie "staged-attachment-item" dla zapisanych.
                            // Mo偶na by tu doda logik odwie偶ania tej listy, jeli to krytyczne.
                        }
                    }
                }
            }
            // === KONIEC LOGIKI LIVE UPDATE ===
        }
       // === POCZTEK NOWEGO KODU: Logika Modala Zarzdzania Kolumnami ===

        /**
         * Funkcja pomocnicza: Tworzy HTML dla edytowalnego elementu listy kolumn.
         */
        function renderCustomColumnItemHTML(column) {
            return `
                <li class="attachment-item" data-id="${column.id}" style="padding-top: 10px; padding-bottom: 10px; cursor: move;">
                    <div class="attachment-info" style="gap: 12px;">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" style="width: 16px; height: 16px; color: var(--text-secondary);"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" /></svg>
                        <input type="text" class="custom-column-name-input" value="${column.title}" style="flex-grow: 1; border: none; background: transparent; padding: 4px; font-size: 14px; font-weight: 500; border-radius: 4px; border: 1px solid transparent;" onfocus="this.style.border='1px solid var(--border-color)'" onblur="this.style.border='1px solid transparent'">
                    </div>
                    <button type="button" class="delete-attachment-btn js-delete-custom-column" title="Usu kolumn">&times;</button>
                </li>
            `;
        }

        /**
         * Funkcja pomocnicza: Sprawdza, czy mo偶na bezpiecznie usun kolumn.
         */
        function handleDeleteCustomColumn(e) {
            const button = e.target.closest('.js-delete-custom-column');
            if (!button) return;

            const itemLi = button.closest('li[data-id]');
            const columnId = itemLi.dataset.id;
            const project = findProject(state.currentProjectId);
            
            if (!project || !columnId) return;

            // Sprawd藕, czy jakiekolwiek zadanie (nawet ukoczone) jest w tej kolumnie
            const tasksInColumn = (project.tasks || []).filter(task => task.customColumnId === columnId);

            if (tasksInColumn.length > 0) {
                // BLOKUJEMY - zgodne z ustaleniami
                showNotification(`Nie mo偶na usun tej kolumny, poniewa偶 zawiera ${tasksInColumn.length} zada. Przenie je najpierw do innej kolumny.`, "Bd");
            } else {
                // BEZPIECZNE - usuwamy element z listy w modalu
                itemLi.remove();
            }
        }

        /**
         * G贸wna funkcja: Otwiera modal, aduje kolumny i inicjalizuje Sortable.js
         */
        function openManageColumnsModal(projectId) {
            const project = findProject(projectId);
            if (!project) return;

            // 1. Zniszcz star instancj Sortable.js, jeli istnieje
            if (customColumnsSortable) {
                customColumnsSortable.destroy();
                customColumnsSortable = null;
            }

            // 2. Wyczy star list (zostaw tylko statyczny element)
            manageColumnsModal.list.querySelectorAll('li[data-id^="col_"]').forEach(el => el.remove());

            // 3. Wypenij list zapisanymi kolumnami
            const customColumns = project.customColumns || [];
            if (customColumns.length > 0) {
                // Sortuj wg zapisanego 'order'
                customColumns.sort((a, b) => (a.order || 0) - (b.order || 0));
                // Renderuj HTML
                const columnsHTML = customColumns.map(renderCustomColumnItemHTML).join('');
                manageColumnsModal.list.insertAdjacentHTML('beforeend', columnsHTML);
            }

            // 4. Inicjalizuj Sortable.js na licie
            customColumnsSortable = new Sortable(manageColumnsModal.list, {
                animation: 150,
                ghostClass: 'sortable-ghost',
                filter: '[data-id="inprogress"]', // Blokuj przeciganie statycznej kolumny
                onMove: function (evt) {
                    // Nie pozw贸l upuci niczego PRZED statyczn kolumn
                    return evt.related.dataset.id !== 'inprogress';
                }
            });
            
            // 5. Otw贸rz modal
            openModal(manageColumnsModal.overlay);
        }
        // === KONIEC NOWEGO KODU ===
       // === NOWY LISTENER: Obsuga klikni w modalu Dashboard Details ===
        dashboardDetailsModal.content.addEventListener('click', (e) => {
            // Szukamy najbli偶szego rodzica, kt贸ry jest kafelkiem zadania
            const taskCard = e.target.closest('.task-card');
            // Szukamy najbli偶szego rodzica (lub samego elementu), kt贸ry jest checkboxem
            const checkbox = e.target.closest('.task-card-checkbox');

            // +++ POCZTEK DODANEGO KODU (Krok 7) +++
            // Szukamy kliknicia na tytu projektu w widoku "M贸j Bud偶et"
            const projectTitle = e.target.closest('.budget-detail-project-title[data-project-id]');
            // +++ KONIEC DODANEGO KODU (Krok 7) +++


            if (checkbox && taskCard) {
                // Przypadek 1: Kliknito checkbox wewntrz kafelka
                console.log(`[Dashboard Details Modal] Kliknito checkbox dla zadania: ${taskCard.dataset.taskId}`); // Log
                handleTaskCheckboxClick(checkbox, e); // Wywoaj istniejc funkcj obsugi checkboxa
            } else if (taskCard) {
                // Przypadek 2: Kliknito kafelek (ale nie checkbox)
                const taskId = taskCard.dataset.taskId;
                console.log(`[Dashboard Details Modal] Kliknito kafelek zadania: ${taskId}`); // Log
                if (taskId) {
                    // Zamknij obecny modal (szczeg贸贸w pulpitu)
                    closeModal(dashboardDetailsModal.overlay);
                    // Otw贸rz modal zadania z op贸藕nieniem dla pynnoci przejcia
                    setTimeout(() => {
                        openTaskModal(taskId);
                    }, 150); // Mae op贸藕nienie
                }
            // +++ POCZTEK DODANEGO KODU (Krok 7) +++
            } else if (projectTitle) {
                // Przypadek 3: Kliknito tytu projektu w modalu "M贸j Bud偶et"
                const projectId = projectTitle.dataset.projectId;
                console.log(`[Dashboard Details Modal] Kliknito tytu projektu: ${projectId}`);
                if (projectId) {
                    closeModal(dashboardDetailsModal.overlay);
                    setTimeout(() => {
                        // Przecz widok na kliknity projekt
                        state.currentProjectId = projectId;
                        state.ui.currentView = 'projects';
                        saveUiState();
                        render();
                    }, 150);
                }
            // +++ KONIEC DODANEGO KODU (Krok 7) +++
            }
        });
        // === KONIEC NOWEGO LISTNERA ===
        // === NOWA, KOMPLETNA LOGIKA OBSUGI MODALA POWIADOMIE ===

        const notificationsModal = {
            overlay: document.getElementById('notifications-modal'),
            list: document.getElementById('notifications-list'),
            markAllReadBtn: document.getElementById('mark-all-notifications-read-btn')
        };

        function getNotificationIcon(type) {
            switch (type) {
                case 'task_assigned':
                    return `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`;
                // === NOWA IKONA ===
                case 'task_completed':
                    return `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="var(--success-primary)"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" /></svg>`;
                // === KONIEC NOWEJ IKONY ===
                case 'mention':
                    return `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L6.832 19.82a4.5 4.5 0 01-1.897 1.13l-2.685.8.8-2.685a4.5 4.5 0 011.13-1.897L16.863 4.487zm0 0L19.5 7.125" /></svg>`;
               // === NOWE: Ikona przypisania do listy ===
                case 'checklist_assign':
                    return `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75M21 12c0 1.268-.63 2.39-1.593 3.068a3.745 3.745 0 0 1-1.043 3.296 3.745 3.745 0 0 1-3.296 1.043A3.745 3.745 0 0 1 12 21c-1.268 0-2.39-.63-3.068-1.593a3.746 3.746 0 0 1-3.296-1.043 3.745 3.745 0 0 1-1.043-3.296A3.745 3.745 0 0 1 3 12c0-1.268.63-2.39 1.593-3.068a3.745 3.745 0 0 1 1.043-3.296 3.746 3.746 0 0 1 3.296-1.043A3.746 3.746 0 0 1 12 3c1.268 0 2.39.63 3.068 1.593a3.746 3.746 0 0 1 1.043 3.296 3.746 3.746 0 0 1 3.296-1.043A3.745 3.745 0 0 1 21 12Z" /></svg>`;
                // === KONIEC NOWEGO ===
                case 'project_invite':
                    // 尖尖 ZASTPIONA IKONA 尖尖
                    return `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                              <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 9.75h16.5v8.25a2.25 2.25 0 01-2.25 2.25H6a2.25 2.25 0 01-2.25-2.25v-8.25z" />
                              <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 9.75a2.25 2.25 0 012.25-2.25h4.5a2.25 2.25 0 012.25 2.25M3.75 9.75h16.5" />
                            </svg>`;
                    // 测测 KONIEC ZMIANY 测测
                default:
                    return '';
            }
        }

        function openNotificationsModal() {
            notificationsModal.list.innerHTML = ''; // Wyczy list
            if (state.notifications.length === 0) {
                notificationsModal.list.innerHTML = '<li style="padding: 20px; text-align: center; color: var(--text-secondary);">Brak powiadomie.</li>';
                notificationsModal.markAllReadBtn.style.display = 'none';
            } else {
                notificationsModal.markAllReadBtn.style.display = 'block';
                state.notifications.forEach(n => {
                    const li = document.createElement('li');
                    li.className = `notification-item ${n.isRead ? 'is-read' : ''}`;
                    li.dataset.id = n.id;

                    const date = new Date(n.timestamp);
                    const formattedDate = date.toLocaleString('pl-PL', { day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' });

                    li.innerHTML = `
                        <div class="notification-icon">${getNotificationIcon(n.type)}</div>
                        <div class="notification-content">
                            <p>${n.message}</p>
                            <div class="notification-time">${formattedDate}</div>
                        </div>
                    `;
                    notificationsModal.list.appendChild(li);
                });
            }
            openModal(notificationsModal.overlay);
        }

        document.querySelectorAll('#notification-toggle-btn, #notification-toggle-btn-mobile').forEach(btn => {
            btn.addEventListener('click', openNotificationsModal);
        });

        notificationsModal.list.addEventListener('click', async (e) => {
            const item = e.target.closest('.notification-item');
            if (!item) return;

            const notificationId = item.dataset.id;
            const notification = state.notifications.find(n => n.id === notificationId);
            
            if (notification) {
                const notifRef = doc(collection(db, `artifacts/${appId}/public/data/notifications`), notificationId);
                await updateDoc(notifRef, { isRead: true });

                if (notification.link) {
                    if (notification.link.type === 'task') {
                        state.currentProjectId = notification.link.projectId;
                        state.ui.currentView = 'projects';
                        saveUiState();
                        render();
                        openTaskModal(notification.link.taskId);
                    }
                    // Mo偶na doda obsug link贸w do projekt贸w w przyszoci
                }
                closeModal(notificationsModal.overlay);
            }
        });

        notificationsModal.markAllReadBtn.addEventListener('click', async () => {
            const batch = writeBatch(db);
            const notificationsRef = collection(db, `artifacts/${appId}/public/data/notifications`);
            const unread = state.notifications.filter(n => !n.isRead);

            if (unread.length > 0) {
                unread.forEach(n => {
                    const docRef = doc(notificationsRef, n.id);
                    batch.update(docRef, { isRead: true });
                });
                await batch.commit();
            }
            closeModal(notificationsModal.overlay);
        });
        taskModal.commentsList.addEventListener('click', async (e) => {
            const deleteBtn = e.target.closest('.delete-comment-btn');
            if (!deleteBtn) return;

            const commentId = deleteBtn.dataset.commentId;
            const taskId = taskModal.overlay.dataset.taskId;
            const {
                task,
                project
            } = findTask(taskId);

            if (!task || !project || !commentId) return;

            const commentToDelete = (task.comments || []).find(c => (c.id || `comment_${c.timestamp}`) === commentId);
            if (!commentToDelete || commentToDelete.userId !== state.currentUser.uid) {
                showNotification("Nie masz uprawnie do usunicia tego komentarza.", "Bd");
                return;
            }

            showConfirmation(
                "Potwierd藕 usunicie",
                "Czy na pewno chcesz usun ten komentarz?",
                async (confirmed) => {
                    if (confirmed) {
                        try {
                            const updatedComments = task.comments.filter(c => (c.id || `comment_${c.timestamp}`) !== commentId);
                            const updatedTask = { ...task,
                                comments: updatedComments
                            };
                            const updatedTasks = project.tasks.map(t => (t.id === taskId ? updatedTask : t));

                            const projectDocRef = findProject(project.id) ?
                                doc(projectsRef, project.id) :
                                doc(completedProjectsRef, project.id);

                            await updateDoc(projectDocRef, {
                                tasks: updatedTasks
                            });
                            openTaskModal(taskId);
                            showNotification("Komentarz zosta usunity.", "Sukces");
                        } catch (error) {
                            console.error("Bd podczas usuwania komentarza:", error);
                            showNotification("Wystpi bd podczas usuwania komentarza.", "Bd");
                        }
                    }
                },
                true
            );
        });

         function renderSidebar() {
            // NOWA LINIA - obsuga podwietlenia dla "M贸j dzie"
            mainNav.querySelector('a[data-view="my-day"]').classList.toggle('active', state.ui.currentView === 'my-day');
            mainNav.querySelector('a[data-view="my-dashboard"]').classList.toggle('active', state.ui.currentView === 'my-dashboard');
            mainNav.querySelector('a[data-view="all-projects"]').classList.toggle('active', state.ui.currentView === 'all-projects');

            const inboxNavItem = document.getElementById('inbox-nav-item');
            // <<<--- POPRAWKA: Szukamy inboxa po isInbox ORAZ ownerId ---<<<
            const inboxProject = state.projects.find(p => p.isInbox === true && p.ownerId === state.currentUser.uid);
            // <<<--- KONIEC POPRAWKI ---<<<

            if (inboxProject && inboxNavItem) {
                const link = inboxNavItem.querySelector('a');
                link.dataset.projectId = inboxProject.id;
                link.classList.toggle('active', inboxProject.id === state.currentProjectId && state.ui.currentView === 'projects');
                inboxNavItem.style.display = 'block';
                 // Dodatkowa linia do ustawienia nazwy, jeli jest pusta (na wszelki wypadek)
                 const inboxNameSpan = inboxNavItem.querySelector('#inbox-nav-item-name');
                 if (inboxNameSpan && !inboxNameSpan.textContent.trim()) {
                     inboxNameSpan.textContent = inboxProject.name || "Skrzynka zada";
                 }
            } else if (inboxNavItem) {
                inboxNavItem.style.display = 'none';
            }
            
            // --- NOWA LOGIKA: RENDEROWANIE ULUBIONYCH PROJEKTW ---
            projectsListEl.innerHTML = '';
            const favoriteProjects = state.projects
                .filter(p => state.currentUser.favorites.includes(p.id)) // Filtruj tylko ulubione
                .sort((a, b) => a.name.localeCompare(b.name)); // Sortuj alfabetycznie

            if (favoriteProjects.length === 0) {
                 projectsListEl.innerHTML = '<li class="nav-item"><a href="#" style="opacity: 0.7; pointer-events: none;">Brak ulubionych</a></li>';
            } else {
                 favoriteProjects.forEach(project => {
                    const li = document.createElement('li');
                    li.className = 'nav-item';
                    const link = document.createElement('a');
                    link.href = '#';
                    link.dataset.projectId = project.id;
                    // Sprawdzanie, czy dany projekt jest aktualnie wywietlany
                    link.classList.toggle('active', project.id === state.currentProjectId && state.ui.currentView === 'projects');
                    
                    // === NOWE: Obsuga rodkowego przycisku myszy (scroll) ===
                    link.addEventListener('mousedown', (e) => {
                        if (e.button === 1) { // 1 = rodkowy przycisk (Scroll)
                            e.preventDefault(); // Zapobiegnij domylnemu autoscrollowaniu przegldarki
                            
                            // Otw贸rz w nowym oknie/karcie
                            const newUrl = `${window.location.origin}${window.location.pathname}?projectId=${project.id}`;
                            window.open(newUrl, '_blank');
                        }
                    });
                    // === KONIEC ===

                    link.innerHTML = `
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" d="M21 8.25c0-2.485-2.099-4.5-4.688-4.5-1.935 0-3.597 1.052-4.312 2.625-.664-1.573-2.37-2.625-4.313-2.625-2.589 0-4.687 2.015-4.687 4.5 0 3.844 1.166 6.128 5.419 9.388l3.125 2.25a.75.75 0 00.938 0l3.125-2.25c4.253-3.26 5.419-5.544 5.419-9.388z" />
    </svg>
    <span>${project.name}</span>
`;
                    li.appendChild(link);
                    projectsListEl.appendChild(li);
                 });
            }
            // --- KONIEC NOWEJ LOGIKI ---
        }

        function renderCurrentProjectView() {
            // ZMIANA: Upewniamy si, 偶e kanbanBoardEl jest widoczny w tym widoku
            kanbanBoardEl.style.display = 'flex';
            // === NOWA LINIA: Uruchomienie listenera czatu ===
            setupChatListener(state.currentProjectId);
            // === KONIEC NOWEJ LINII ===

            // NOWA LINIA: Resetowanie klasy kontenera do domylnej klasy Kanban
            kanbanBoardEl.className = 'kanban-board';
            kanbanBoardEl.removeAttribute('style');
            
            const project = findProject(state.currentProjectId) || findCompletedProject(state.currentProjectId);
            const isCompleted = !!findCompletedProject(state.currentProjectId);

            // === POCZTEK ZMIANY: Rozbudowana logika uprawnie ===
            const isOwner = project && (project.ownerId === state.currentUser.uid);
            // Sprawdzamy, czy u偶ytkownik jest na licie admin贸w
            const isAdmin = project && (project.admins || []).includes(state.currentUser.uid);
            
            // === NOWE: Kto widzi menu projektu? (Tylko Owner i Admin) ===
            // SuperUser i Zwyky User tutaj NIE wchodz.
            const canManageProject = project && (isOwner || isAdmin);

            // Definiujemy, kto mo偶e edytowa (Waciciel LUB Admin)
            const canEditProject = canManageProject && !project.isInbox;
            // Definiujemy, kto mo偶e wykonywa niebezpieczne akcje (Tylko Waciciel)
            const canDeleteOrComplete = project && isOwner && !project.isInbox;

           // === NOWA LOGIKA MENU PROJEKTU (Zastpuje stare przyciski) ===
            if (project && canManageProject) { // <-- ZMIANA WARUNKU
                projectMenuToggle.style.display = 'flex'; // Poka偶 trzy kropki TYLKO uprawnionym

                // Sterowanie widocznoci opcji wewntrz Dropdown
                // Pobieramy referencje dynamicznie, bo dropdown jest teraz w DOM
                const editItem = projectMenuDropdown.querySelector('[data-action="edit"]');
                const completeItem = projectMenuDropdown.querySelector('[data-action="complete"]');
                const deleteItem = projectMenuDropdown.querySelector('[data-action="delete"]');
                const columnsItem = document.getElementById('manage-columns-menu-item');

                // 1. Edycja
                if(editItem) editItem.style.display = canEditProject ? 'flex' : 'none';
                
                // 2. Zarzdzaj kolumnami (przeniesione do menu)
                if(columnsItem) {
                     columnsItem.style.display = canEditProject ? 'flex' : 'none';
                     // Podpinamy listener bezporednio tutaj (usuwajc stary, aby unikn duplikat贸w)
                     columnsItem.onclick = null;
                     if (canEditProject) {
                         columnsItem.onclick = () => {
                             openManageColumnsModal(project.id);
                             projectMenuDropdown.classList.remove('visible'); // Zamknij menu po klikniciu
                             projectMenuToggle.classList.remove('active');
                         };
                     }
                }

                // 3. Zakocz
                if(completeItem) completeItem.style.display = (canDeleteOrComplete && !isCompleted) ? 'flex' : 'none';
                
                // 4. Usu
                if(deleteItem) deleteItem.style.display = canDeleteOrComplete ? 'flex' : 'none';

            } else {
                projectMenuToggle.style.display = 'none';
            }
            // === KONIEC LOGIKI MENU ===

            if (!project) {
                projectNameHeaderEl.textContent = 'Wybierz projekt';
                mobileHeaderTitle.textContent = 'Projekty';
                projectMembersHeaderEl.innerHTML = '';
                // projectProgressEl.innerHTML = ''; // USUNITE (Stary element)
                if(projectProgressContainer) projectProgressContainer.style.display = 'none'; // Ukryj nowy pasek
                kanbanBoardEl.innerHTML = '<p>Wybierz projekt lub stw贸rz nowy, aby zacz.</p>';
                return;
            }
            projectNameHeaderEl.textContent = project.name;
            mobileHeaderTitle.textContent = project.name;
            projectMembersHeaderEl.innerHTML = (project.members || [])
    .map(memberId => findUser(memberId))
    .filter(Boolean)
    .map(user => renderAvatarHTML(user))
    .join('');

            const projectTasks = (project.tasks || []).map(migrateTask);
            const totalTasks = projectTasks.length;
            const completedTasks = projectTasks.filter(t => t.status === 'done').length;
            const progressPercent = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;

            // === NOWA LOGIKA PASKA POSTPU (U偶ywamy nowych element贸w w nag贸wku) ===
            if (totalTasks > 0) {
                projectProgressContainer.style.display = 'flex';
                projectProgressFill.style.width = `${progressPercent}%`;
                projectProgressText.textContent = `${completedTasks}/${totalTasks} (${progressPercent}%)`;
                // Dodaj tooltip do kontenera
                projectProgressContainer.title = `${completedTasks} z ${totalTasks} zada ukoczonych`;
            } else {
                projectProgressContainer.style.display = 'none';
            }
            // --- KROK 1: Zastosuj filtry ---
            let filteredTasks = applyProjectFilters(projectTasks);

            // USUNITO: Automatyczne sortowanie po dacie.
            // Teraz kolejno zale偶y wycznie od 'customOrder' zapisanego w bazie (Drag & Drop)
            // lub od rcznego kliknicia przycisku "Sortuj" w nag贸wku.

            // --- KROK 3: Wyrenderuj przefiltrowane zadania ---
            const viewProject = { ...project, tasks: filteredTasks };
            renderKanbanBoard(viewProject, !isCompleted);
            
            // Upewnij si, 偶e wiadomo o statusie filtra jest aktualna (dla wizualnego feedbacku na przycisku)
            updateFilterStatusMessage();
        }
        
        /**
         * NOWA FUNKCJA: Filtruje zadania na podstawie bie偶cego stanu filtr贸w.
         * @param {Array<object>} tasks Lista zada projektu.
         * @returns {Array<object>} Przefiltrowana lista zada.
         */
        function applyProjectFilters(tasks) {
            const filters = state.ui.currentProjectFilters;
            
            // KLUCZOWA ZMIANA: Sprawdzamy, czy wszystkie filtry s puste.
            const isFilterActive = 
                (filters.assigneeIds && filters.assigneeIds.length > 0) || // Czy wybrano jakich czonk贸w
                (filters.priority) || 
                (filters.dueDate) || 
                (filters.budgetStatus);
            
            if (!isFilterActive) {
                return tasks; // Brak aktywnych filtr贸w
            }

            const now = new Date();
            const nowTime = now.getTime();
            
            // Obliczamy koniec nadchodzcego terminu (7 dni od teraz)
            const upcomingThreshold = new Date();
            upcomingThreshold.setDate(upcomingThreshold.getDate() + 7);
            const upcomingTime = upcomingThreshold.getTime();


            return tasks.filter(task => {
                // 1. Filtr Osoba Przypisana
                if (filters.assigneeIds && filters.assigneeIds.length > 0) {
                    // Jeli filtry assignee s aktywne (tablica nie jest pusta):
                    // Sprawdzamy, czy tablica assignees zadania zawiera przynajmniej jedno ID z tablicy filters.assigneeIds
                    const hasSelectedAssignee = task.assignees.some(assigneeId => filters.assigneeIds.includes(assigneeId));
                    if (!hasSelectedAssignee) {
                        return false; // Usu zadanie, jeli 偶aden z wybranych czonk贸w nie jest przypisany
                    }
                }

                // 2. Filtr Priorytet
                if (filters.priority && task.priority !== filters.priority) {
                    return false;
                }

                // 3. Filtr Termin Wykonania
                if (filters.dueDate) {
                    const taskDueDate = task.dueDate ? new Date(task.dueDate).getTime() : null;
                    const isCompleted = task.status === 'done';

                    if (filters.dueDate === 'overdue') {
                        // Op贸藕nione: Ma termin, nieukoczone I termin min
                        if (!taskDueDate || isCompleted || taskDueDate > nowTime) {
                            return false;
                        }
                    } else if (filters.dueDate === 'upcoming') {
                         // Nadchodzce: Ma termin, nieukoczone, nieop贸藕nione I jest w cigu 7 dni
                        if (!taskDueDate || isCompleted || taskDueDate < nowTime || taskDueDate > upcomingTime) {
                            return false;
                        }
                    } else if (filters.dueDate === 'no-date') {
                        // Bez terminu: Nie ma terminu
                        if (taskDueDate) {
                            return false;
                        }
                    }
                }
                
                // 4. Filtr Status Bud偶etowy
                if (filters.budgetStatus) {
                    const hasBudget = task.budgetItems && task.budgetItems.length > 0;
                    if (filters.budgetStatus === 'has-budget' && !hasBudget) {
                        return false;
                    } else if (filters.budgetStatus === 'no-budget' && hasBudget) {
                        return false;
                    }
                }
                
                return true;
            });
        }
        // --- ZMODYFIKOWANA FUNKCJA (Wersja 3 - Live Calculation): Renderowanie wykresu bud偶etu (CSS) ---
    function renderProjectBudgetChartCSS(project, container) {
        container.innerHTML = ''; // Wyczy kontener

        const budgetData = project.budget; // Dane z definicji bud偶etu (np. 15 000)
        
        // === NAPRAWA: Zamiast czyta z bazy, liczymy na 偶ywo z zada ===
        // Dziki temu uwzgldniamy zmiany zrobione przez AI, nawet jeli AI nie zaktualizowao sumy w bazie.
        // U偶ywamy tej samej logiki co tabela na dole.
        const summaryData = calculateProjectBudgetSummary(project.tasks); 
        // === KONIEC NAPRAWY ===

        if (!budgetData || typeof budgetData !== 'object' || budgetData.amount === undefined) {
            container.innerHTML = '<p style="color: var(--text-secondary); font-size: 14px;">Brak zdefiniowanego bud偶etu dla tego projektu.</p>';
            return;
        }

        // --- NOWA LOGIKA OBLICZE ---
        const totalBudget = parseFloat(budgetData.amount) || 0; // 1. Cakowity Bud偶et
        const currency = budgetData.currency || 'PLN';
        const definedItems = budgetData.items || [];

        const totalSpent = summaryData?.totalSpent || 0;       // 2. Wydane
        const totalReserved = summaryData?.totalReserved || 0; // 3. Zarezerwowane

        // 4. Dostpne = Cakowity - (Wydane + Zarezerwowane)
        const availableAmount = totalBudget - totalSpent - totalReserved; 

        // Suma kwot z DEFINICJI pozycji (dla weryfikacji)
        const definedItemsSum = definedItems.reduce((sum, item) => sum + (parseFloat(item.amount) || 0), 0);

        const formatCurrency = (value) => {
             return value.toLocaleString('pl-PL', { style: 'currency', currency: currency, minimumFractionDigits: 2 });
        }

        // Procent cakowitego zaanga偶owania (Wydane + Zarezerwowane)
        const totalCommitted = totalSpent + totalReserved;
        let committedPercent = 0;
        if (totalBudget > 0) {
             committedPercent = (totalCommitted / totalBudget) * 100;
        } else if (totalCommitted > 0) {
             committedPercent = Infinity;
        }

        const isOverBudgetOverall = totalCommitted > totalBudget;
        // --- KONIEC NOWEJ LOGIKI OBLICZE ---

        
        // --- NOWY HTML (4 KOLUMNY) ---
        let chartHTML = `
            <div class="project-details-budget-grid">
                <div>
                    <div style="color: var(--text-secondary); font-size: 11px; text-transform: uppercase;">Cakowity Bud偶et</div>
                    <strong style="font-size: 15px;">${formatCurrency(totalBudget)}</strong>
                </div>
                <div>
                <div style="color: var(--text-secondary); font-size: 11px; text-transform: uppercase;">Zarezerwowane</div>
                    <strong style="font-size: 15px; color: ${isOverBudgetOverall ? 'var(--danger-primary)' : 'inherit'};">${formatCurrency(totalReserved)}</strong>
                </div>
                <div>
                    <div style="color: var(--text-secondary); font-size: 11px; text-transform: uppercase;">Wydane</div>
                    <strong style="font-size: 15px;">${formatCurrency(totalSpent)}</strong>
                </div>
                <div>
                    
                    <div style="color: var(--text-secondary); font-size: 11px; text-transform: uppercase;">Dostpne</div>
                    <strong style="font-size: 15px; color: ${availableAmount < 0 ? 'var(--danger-primary)' : 'var(--success-primary)'};">${formatCurrency(availableAmount)}</strong>
                </div>
            </div>

            <div class="budget-label" style="margin-top: 16px;">
                <span>Zaanga偶owane (Wydane + Rezerw.) / Cakowity bud偶et</span>
                <span>${committedPercent === Infinity ? '>100' : committedPercent.toFixed(1)}%</span>
            </div>
            <div class="budget-summary-bar" title="Zaanga偶owano ${committedPercent === Infinity ? 'ponad 100' : committedPercent.toFixed(1)}% bud偶etu">
                <div class="budget-summary-fill ${isOverBudgetOverall ? 'budget-fill-over' : 'budget-fill-items'}" style="width: ${Math.min(committedPercent, 100)}%;">
                    ${committedPercent > 10 && committedPercent !== Infinity ? `${committedPercent.toFixed(0)}%` : ''}
                </div>
            </div>
        `;

        if (isOverBudgetOverall) {
            const overAmount = totalCommitted - totalBudget;
            chartHTML += `<p style="color: var(--danger-primary); font-size: 13px; font-weight: 600; text-align: right; margin-top: 4px;">Przekroczenie o: ${formatCurrency(overAmount)}</p>`;
        }

        // --- NOWA LISTA POZYCJI (Z 4 WIERSZAMI) ---
        if (definedItems.length > 0) {
             chartHTML += `<h4 style="font-size: 13px; color: var(--text-secondary); margin-top: 20px; margin-bottom: 8px;">Szczeg贸y pozycji bud偶etowych:</h4>`;
             chartHTML += '<ul style="font-size: 13px; list-style: none; padding-left: 0; max-height: 180px; overflow-y: auto;">';
             definedItems.forEach(item => {
                  const definedAmount = parseFloat(item.amount) || 0;

                  // Pobierz dane z nowego obiektu summaryData
                  const spentForItem = summaryData?.itemsSpent?.[item.name] || 0;
                  const reservedForItem = summaryData?.itemsReserved?.[item.name] || 0;

                  const availableForItem = definedAmount - spentForItem - reservedForItem;
                  const isOverBudgetItem = (spentForItem + reservedForItem) > definedAmount;

                  chartHTML += `
                      <li style="border-bottom: 1px dashed var(--border-color); padding: 6px 0; margin-bottom: 4px;">
                          <div style="display: flex; justify-content: space-between; font-weight: 600;">
                              <span>${item.name || '<i>Brak nazwy</i>'}</span>
                              <span>${formatCurrency(definedAmount)}</span>
                          </div>
                           <div style="display: flex; justify-content: space-between; font-size: 12px; color: var(--text-secondary); padding-left: 10px;">
                              <span>- Zarezerwowane:</span>
                              <span style="color: ${isOverBudgetItem ? 'var(--danger-primary)' : 'var(--text-secondary)'};">${formatCurrency(reservedForItem)}</span>
                          </div>
                          <div style="display: flex; justify-content: space-between; font-size: 12px; color: var(--text-secondary); padding-left: 10px;">
                              <span>- Wydane:</span>
                              <span>${formatCurrency(spentForItem)}</span>
                          </div>
                          <div style="display: flex; justify-content: space-between; font-size: 12px; color: var(--text-secondary); padding-left: 10px;">
                              <span>= Dostpne:</span>
                              <span style="font-weight: 500; color: ${availableForItem < 0 ? 'var(--danger-primary)' : 'var(--success-primary)'};">${formatCurrency(availableForItem)}</span>
                          </div>
                      </li>`;
             });
             chartHTML += '</ul>';

             const diffTolerance = 0.01;
             if (Math.abs(totalBudget - definedItemsSum) > diffTolerance) {
                chartHTML += `<p style="font-size: 12px; color: var(--text-secondary); margin-top: 8px; text-align: right;">Suma zdefiniowanych pozycji: ${formatCurrency(definedItemsSum)}</p>`;
             }
        }


        container.innerHTML = chartHTML;
    }

        // --- ZMODYFIKOWANA FUNKCJA: Renderowanie wykresu obci偶enia (Chart.js) ---
        function renderProjectWorkloadChart(project, container, placeholder) {
            placeholder.style.display = 'none'; // Ukryj placeholder
            container.innerHTML = ''; // Wyczy poprzedni zawarto (np. stary canvas)

            const members = (project.members || [])
                .map(findUser) // Pobierz pene obiekty u偶ytkownik贸w
                .filter(Boolean); // Odfiltruj, jeli kogo nie znaleziono

            if (members.length === 0) {
                placeholder.textContent = 'Brak czonk贸w w projekcie do wywietlenia obci偶enia.';
                placeholder.style.display = 'block';
                return;
            }

            const projectTasks = (project.tasks || []).map(migrateTask); // Pobierz zadania projektu

            // Przygotuj dane dla wykresu
            const labels = members.map(member => member.name || member.email); // Etykiety osi X (nazwy czonk贸w)
            const todoData = members.map(member =>
                projectTasks.filter(task => task.status === 'todo' && task.assignees.includes(member.id)).length
            );
            const inProgressData = members.map(member =>
                projectTasks.filter(task => task.status === 'inprogress' && task.assignees.includes(member.id)).length
            );

            // Stw贸rz element canvas dla wykresu
            const canvas = document.createElement('canvas');
            container.appendChild(canvas);
            const ctx = canvas.getContext('2d');

            // Zniszcz poprzedni instancj wykresu, jeli istnieje
            if (workloadChartInstance) {
                workloadChartInstance.destroy();
            }

            // Utw贸rz now instancj wykresu Chart.js
            workloadChartInstance = new Chart(ctx, {
                type: 'bar', // Typ wykresu: supkowy
                data: {
                    labels: labels, // Etykiety (czonkowie)
                    datasets: [{
                        label: 'Do realizacji', // Legenda dla zada 'todo'
                        data: todoData,        // Dane (liczba zada 'todo')
                        backgroundColor: 'rgba(239, 68, 68, 0.7)', // Kolor supk贸w 'todo' (czerwony z przezroczystoci)
                        borderColor: 'rgba(239, 68, 68, 1)',
                        borderWidth: 1
                    }, {
                        label: 'W trakcie', // Legenda dla zada 'inprogress'
                        data: inProgressData, // Dane (liczba zada 'inprogress')
                        backgroundColor: 'rgba(79, 70, 229, 0.7)', // Kolor supk贸w 'inprogress' (fioletowy z przezroczystoci)
                        borderColor: 'rgba(79, 70, 229, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    maintainAspectRatio: false, // Wycz zachowanie proporcji, aby dopasowa do kontenera
                    responsive: true,          // Wcz responsywno
                    plugins: {
                        title: {
                            display: false, // Wycz domylny tytu Chart.js
                        },
                        legend: {
                            position: 'bottom', // Umie legend na dole
                        },
                        tooltip: { // Konfiguracja podpowiedzi po najechaniu
                             callbacks: {
                                 label: function(context) {
                                     let label = context.dataset.label || '';
                                     if (label) {
                                         label += ': ';
                                     }
                                     if (context.parsed.y !== null) {
                                         label += context.parsed.y;
                                     }
                                     return label;
                                 }
                             }
                        }
                    },
                    scales: {
                        x: {
                            stacked: true, // Wcz skumulowanie supk贸w na osi X
                            grid: {
                                display: false // Ukryj siatk pionow
                            }
                        },
                        y: {
                            stacked: true, // Wcz skumulowanie supk贸w na osi Y
                            beginAtZero: true, // Zacznij o Y od zera
                            ticks: {
                                stepSize: 1 // Krok osi Y co 1 (liczba zada)
                            }
                        }
                    }
                }
            });
        }
       // === ZMODYFIKOWANA FUNKCJA: Renderowanie wykresu Obci偶enia Zespou (Chart.js) ===
        function renderTeamWorkloadChart(workloadData, containerId) {
            const container = document.getElementById(containerId);
            if (!container) return;

            // Zniszcz poprzedni instancj, jeli istnieje (wa偶ne przy przeczaniu)
            if (teamWorkloadChartInstance) {
                teamWorkloadChartInstance.destroy();
            }

            // 1. Przygotuj canvas (Wyczy kontener i wstaw canvas)
            container.innerHTML = `<canvas id="team-workload-chart-canvas"></canvas>`;
            const canvas = document.getElementById('team-workload-chart-canvas');
            const ctx = canvas.getContext('2d');

            // 2. Zniszcz stary wykres (jeli istnieje)
            // USUNITO ZBDNY BLOK: Poni偶sze linie zostay usunite, aby zapobiec podw贸jnemu wywoaniu .destroy()
            // if (teamWorkloadChartInstance) {
            //     teamWorkloadChartInstance.destroy();
            // }

            // 3. Przygotuj dane dla Chart.js
            const labels = workloadData.map(user => user.name);
            const todoData = workloadData.map(user => user.todo);
            const inProgressData = workloadData.map(user => user.inprogress);
            const doneData = workloadData.map(user => user.done);

            // 4. Utw贸rz nowy wykres
            teamWorkloadChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Do realizacji',
                            data: todoData,
                            backgroundColor: 'rgba(239, 68, 68, 0.7)', // Czerwony
                            borderColor: 'rgba(239, 68, 68, 1)',
                            borderWidth: 1
                        }, 
                        {
                            label: 'W trakcie',
                            data: inProgressData,
                            backgroundColor: 'rgba(79, 70, 229, 0.7)', // Fioletowy
                            borderColor: 'rgba(79, 70, 229, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'Wykonane',
                            data: doneData,
                            backgroundColor: 'rgba(22, 163, 74, 0.7)', // Zielony
                            borderColor: 'rgba(22, 163, 74, 1)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    maintainAspectRatio: false,
                    responsive: true,
                    plugins: {
                        legend: { position: 'bottom' }
                    },
                    scales: {
                        x: {
                            stacked: true, // Kluczowe: supki bd na sobie
                        },
                        y: {
                            stacked: true,
                            beginAtZero: true,
                            ticks: { stepSize: 1 }
                        }
                    }
                }
            });
        }
        // === KONIEC NOWEJ FUNKCJI ===
       // === NOWA FUNKCJA: Obliczanie obci偶enia godzinowego zespou ===
        function calculateTeamWorkloadHours(monthFilter = 'all') {
            const teamWorkload = {}; // { userId: { hours: 0, name: '' } }
            const myId = state.currentUser.uid;
            
            // 1. Filtruj projekty, kt贸re w og贸le u偶ywaj ledzenia godzin
            const projectsWithHours = state.projects.filter(p => p.estimationType === 'hours');

            projectsWithHours.forEach(project => {
                (project.tasks || []).forEach(task => {
                    const taskHours = parseFloat(task.estimation) || 0;
                    
                    // === POCZTEK ZMIANY ===
                    const assignees = task.assignees || [];
                    const numberOfAssignees = assignees.length;

                    // Pomi zadania bez estymacji, ukoczone LUB bez przypisanych os贸b
                    if (taskHours === 0 || task.status === 'done' || numberOfAssignees === 0) return; 

                    // 2. Filtrowanie daty (jeli 'monthFilter' nie jest 'all')
                    if (monthFilter !== 'all') {
                        if (!task.dueDate || !task.dueDate.startsWith(monthFilter)) {
                            return; // Pomi zadanie, jeli nie pasuje do wybranego miesica (YYYY-MM)
                        }
                    }

                    // Oblicz godziny proporcjonalnie
                    const hoursPerUser = taskHours / numberOfAssignees;
                    // === KONIEC ZMIANY ===


                    // 3. Agregacja godzin per u偶ytkownik (z wyczeniem mnie)
                    assignees.forEach(assigneeId => {
                        if (assigneeId !== myId) {
                            if (!teamWorkload[assigneeId]) {
                                const user = findUser(assigneeId);
                                teamWorkload[assigneeId] = { 
                                    hours: 0, 
                                    name: user ? (user.name || user.email) : 'Nieznany' 
                                };
                            }
                            // === ZMIANA: Dodaj tylko 'hoursPerUser' ===
                            teamWorkload[assigneeId].hours += hoursPerUser;
                        }
                    });
                });
            });

            // 4. Konwertuj na tablic i sortuj
            const workloadArray = Object.values(teamWorkload).sort((a, b) => b.hours - a.hours);
            
            return workloadArray; // Zwraca np. [{ name: 'Anna', hours: 40 }, { name: 'Piotr', hours: 25 }]
        }
        
        // === NOWA FUNKCJA: Renderowanie wykresu obci偶enia GODZINOWEGO ===
        function renderTeamWorkloadHoursChart(workloadData, containerId) {
            const container = document.getElementById(containerId);
            if (!container) return;

            // Zniszcz poprzedni instancj, jeli istnieje (wa偶ne przy przeczaniu)
            if (teamWorkloadChartInstance) {
                teamWorkloadChartInstance.destroy();
            }

            // 1. Przygotuj canvas
            container.innerHTML = `<canvas id="team-workload-hours-chart-canvas"></canvas>`;
            const canvas = document.getElementById('team-workload-hours-chart-canvas');
            const ctx = canvas.getContext('2d');

            // 2. Przygotuj dane
            const labels = workloadData.map(user => user.name);
            const hoursData = workloadData.map(user => user.hours);

            // 3. Utw贸rz nowy wykres
            teamWorkloadChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Obci偶enie (godziny)',
                            data: hoursData,
                            backgroundColor: 'rgba(245, 158, 11, 0.7)', // Kolor pomaraczowy/bursztynowy
                            borderColor: 'rgba(245, 158, 11, 1)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    maintainAspectRatio: false,
                    responsive: true,
                    plugins: {
                        legend: { position: 'bottom' },
                        tooltip: {
                             callbacks: {
                                 label: function(context) {
                                     let label = context.dataset.label || '';
                                     if (label) label += ': ';
                                     if (context.parsed.y !== null) {
                                         label += context.parsed.y + ' godzin'; // Dodaj jednostk
                                     }
                                     return label;
                                 }
                             }
                        }
                    },
                    scales: {
                        x: {
                            stacked: false, // Nie stackujemy, jest tylko jedna seria danych
                        },
                        y: {
                            stacked: false,
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Liczba godzin'
                            }
                        }
                    }
                }
            });
        }

        
        // === NOWA FUNKCJA: Listenery dla modala obci偶enia ===
        function setupWorkloadModalListeners() {
            const tabTasks = document.getElementById('workload-tab-tasks');
            const tabHours = document.getElementById('workload-tab-hours');
            const filtersContainer = document.getElementById('workload-hours-filters');
            const monthFilterSelect = document.getElementById('workload-month-filter');
            // === POPRAWKA: U偶ywamy nowego, unikalnego ID ===
            const chartContainerId = 'team-workload-modal-chart-container'; // ID kontenera wykresu

            // --- Wypenij filtr miesicy ---
            // === POCZTEK PRZYWRCONEGO KODU ===
            const now = new Date(); // np. 9 Listopada 2025
            const targetYear = 2026; // Cel: do koca 2026
            const targetMonth = 11; // 11 = Grudzie (bo jest 0-indeksowany)

            // Data, od kt贸rej zaczynamy ptl (pierwszy dzie bie偶cego miesica)
            const loopDate = new Date(now.getFullYear(), now.getMonth(), 1); // 1 Listopada 2025
            
            let optionsHTML = '<option value="all">Caociowo (wszystkie aktywne)</option>';
            
            // Ptla bdzie si wykonywa dop贸ki data jest mniejsza lub r贸wna celowi (Grudzie 2026)
            while (loopDate.getFullYear() < targetYear || (loopDate.getFullYear() === targetYear && loopDate.getMonth() <= targetMonth)) {
                
                const year = loopDate.getFullYear();
                const month = loopDate.getMonth() + 1; // getMonth() jest 0-indeksowane, wic +1
                
                const value = `${year}-${String(month).padStart(2, '0')}`; // Format YYYY-MM
                const label = loopDate.toLocaleString('pl-PL', { month: 'long', year: 'numeric' });
                
                optionsHTML += `<option value="${value}">${label}</option>`;
                
                // Przejd藕 do nastpnego miesica
                loopDate.setMonth(loopDate.getMonth() + 1);
            }
            // === KONIEC PRZYWRCONEGO KODU ===
            
            monthFilterSelect.innerHTML = optionsHTML;

            // --- Listener dla zakadki ZADANIA ---
            tabTasks.addEventListener('click', () => {
                tabTasks.classList.add('active');
                tabHours.classList.remove('active');
                // filtersContainer.style.display = 'none'; // USUNITE - filtr jest teraz zawsze widoczny

                // Przeaduj dane i renderuj wykres zada
                // === POPRAWKA: Oblicz dane WEWNTRZ listenera i przeka偶 filtr ===
                const monthFilter = monthFilterSelect.value;
                const teamWorkloadData = calculateTeamWorkload(monthFilter);
                renderTeamWorkloadChart(teamWorkloadData.list, chartContainerId);
            });

            // --- Listener dla zakadki GODZINY ---
            tabHours.addEventListener('click', () => {
                tabHours.classList.add('active');
                tabTasks.classList.remove('active');
                // filtersContainer.style.display = 'block'; // USUNITE - filtr jest teraz zawsze widoczny

                // Przeaduj dane i renderuj wykres godzinowy (z domylnym filtrem 'all')
                const monthFilter = monthFilterSelect.value;
                // === POPRAWKA: Oblicz dane WEWNTRZ listenera ===
                const workloadHoursData = calculateTeamWorkloadHours(monthFilter);
                renderTeamWorkloadHoursChart(workloadHoursData, chartContainerId);
            });

            // --- Listener dla FILTRA MIESICY ---
            monthFilterSelect.addEventListener('change', () => {
                const monthFilter = monthFilterSelect.value;
                
                // === POPRAWKA: Sprawd藕, kt贸ra zakadka jest aktywna i odwie偶 j ===
                if (tabTasks.classList.contains('active')) {
                    // Zakadka ZADANIA jest aktywna
                    const teamWorkloadData = calculateTeamWorkload(monthFilter);
                    renderTeamWorkloadChart(teamWorkloadData.list, chartContainerId);
                } else if (tabHours.classList.contains('active')) {
                    // Zakadka GODZINY jest aktywna
                    const workloadHoursData = calculateTeamWorkloadHours(monthFilter);
                    renderTeamWorkloadHoursChart(workloadHoursData, chartContainerId);
                }
            });
        }

            

        // === KONIEC NOWYCH FUNKCJI ===
     /**
     * ZMODYFIKOWANA FUNKCJA (Wersja 3 - Obsuga Podzada): 
     * Renderuje tabel zada I PODZADA obci偶ajcych bud偶et.
     */
    function renderProjectBudgetTasksTable(project, containerId) {
        const container = document.getElementById(containerId);
        if (!container) return;

        const currency = project.budget?.currency || 'PLN';
        const formatCurrency = (value) => {
             return value.toLocaleString('pl-PL', { style: 'currency', currency: currency, minimumFractionDigits: 2 });
        }

        // 1. ZBIERANIE WSZYSTKICH ENCJI KOSZTOWYCH (Zadania g贸wne + Podzadania)
        let budgetEntities = [];

        (project.tasks || []).forEach(task => {
            const hasSubtasks = task.subtasks && task.subtasks.length > 0;

            // A. Sprawd藕 zadanie g贸wne
            // ZMIANA: Dodajemy warunek !hasSubtasks. 
            // Jeli zadanie ma podzadania, to jego pole 'budgetItems' jest tylko technicznym agregatem sumy.
            // Pomijamy je tutaj, aby w tabeli wywietli rozbicie na konkretne podzadania w bloku B.
            if (!hasSubtasks && task.budgetItems && task.budgetItems.length > 0) {
                budgetEntities.push({
                    type: 'task',
                    id: task.id,
                    title: task.title,
                    isCompleted: task.status === 'done',
                    budgetItems: task.budgetItems,
                    parentId: null // To jest root
                });
            }

            // B. Sprawd藕 podzadania
            if (hasSubtasks) { // U偶ywamy zmiennej pomocniczej
                task.subtasks.forEach(sub => {
                    if (sub.budgetItems && sub.budgetItems.length > 0) {
                        budgetEntities.push({
                            type: 'subtask',
                            id: sub.id,
                            title: sub.title,
                            isCompleted: sub.isCompleted === true, // Status podzadania
                            budgetItems: sub.budgetItems,
                            parentId: task.id, // Potrzebne do otwarcia modala
                            parentTitle: task.title // Do wywietlenia kontekstu
                        });
                    }
                });
            }
        });

        // Sortowanie alfabetyczne po tytule
        budgetEntities.sort((a, b) => a.title.localeCompare(b.title));

        if (budgetEntities.length === 0) {
            container.innerHTML = '<p style="color: var(--text-secondary); padding: 12px; font-style: italic;">Brak zada obci偶ajcych bud偶et w tym projekcie.</p>';
            return;
        }

        let tableHTML = `
            <table>
                <thead>
                    <tr>
                        <th>Zadanie / Podzadanie</th>
                        <th>Pozycja Bud偶etowa</th>
                        <th>Status Kosztu</th>
                        <th style="text-align: right;">Kwota</th>
                    </tr>
                </thead>
                <tbody>
        `;

        let totalReserved = 0;
        let totalSpent = 0;

        budgetEntities.forEach(entity => {
            const isDone = entity.isCompleted;
            const statusText = isDone 
                ? '<span style="color: var(--success-primary); font-weight: 500;">Wydatkowane</span>' 
                : '<span style="color: var(--text-secondary);">Zarezerwowane</span>';

            // Przygotowanie atrybut贸w data- do klikania
            // Jeli to podzadanie, dodajemy data-subtask-id
            const dataAttrs = entity.type === 'subtask' 
                ? `data-task-id="${entity.parentId}" data-subtask-id="${entity.id}"`
                : `data-task-id="${entity.id}"`;

            // Wizualne rozr贸偶nienie podzadania
            let displayName = entity.title;
            if (entity.type === 'subtask') {
                displayName = `<span style="color:var(--text-primary);">${entity.title}</span> <br><small style="color:var(--text-secondary); font-weight:normal;">(w: ${entity.parentTitle})</small>`;
            }

            entity.budgetItems.forEach((item, index) => {
                const amount = parseFloat(item.amount) || 0;

                if (isDone) {
                    totalSpent += amount;
                } else {
                    totalReserved += amount;
                }

                const entityNameHTML = index === 0 
                    ? `<td style="vertical-align: top;" data-label="Zadanie:"><strong class="clickable-task-name" ${dataAttrs} style="cursor: pointer; color: var(--accent-primary);">${displayName}</strong></td>`
                    : `<td style="border-top: 1px dashed var(--border-color);"></td>`;

                tableHTML += `
                    <tr class="task-cost-row">
                        ${entityNameHTML}
                        <td data-label="Pozycja Bud偶etowa:">${item.name}</td>
                        <td data-label="Status Kosztu:">${statusText}</td>
                        <td data-label="Kwota:" style="text-align: right;">${formatCurrency(amount)}</td>
                    </tr>
                `;
            });
        });

        // STOPKA (TFOOT)
        tableHTML += `
                </tbody>
                <tfoot>
                    <tr>
                        <td colspan="3" style="text-align: right; color: var(--text-secondary);">Suma (Zarezerwowane):</td>
                        <td style="text-align: right;">${formatCurrency(totalReserved)}</td>
                    </tr>
                    <tr>
                        <td colspan="3" style="text-align: right; color: var(--text-secondary);">Suma (Wydane):</td>
                        <td style="text-align: right;">${formatCurrency(totalSpent)}</td>
                    </tr>
                    <tr>
                        <td colspan="3" style="text-align: right; border-top: 2px solid var(--border-color);">Suma Cakowita:</td>
                        <td style="text-align: right; border-top: 2px solid var(--border-color);">${formatCurrency(totalReserved + totalSpent)}</td>
                    </tr>
                </tfoot>
            </table>
        `;

        container.innerHTML = tableHTML;
    }
       /**
         * NOWA FUNKCJA: Generuje i otwiera Raport Zamknicia Projektu (Post-Mortem).
         * Analizuje zakoczony projekt i wylicza statystyki.
         */
        function openProjectReportModal(projectId) {
            // Szukamy projektu w zakoczonych (g贸wnie), ale te偶 w aktywnych (dla test贸w)
            const project = state.completedProjects.find(p => p.id === projectId) || state.projects.find(p => p.id === projectId);
            
            if (!project) {
                showNotification("Bd: Nie znaleziono danych projektu.", "Bd");
                return;
            }

            const modal = document.getElementById('project-report-modal');
            document.getElementById('report-project-name').textContent = `Raport: ${project.name}`;
            // Zapisz ID projektu w modalu dla przycisk贸w interaktywnych
            modal.dataset.projectId = projectId;

            // --- NOWE: WSTAWIENIE OPISU PROJEKTU ---
            const reportDescEl = document.getElementById('report-project-description');
            if (reportDescEl) {
                reportDescEl.textContent = project.description || "Brak opisu projektu.";
            }
            // --- KONIEC ---

            // --- NOWE: RENDEROWANIE LISTY PODSUMOWANIA ---
            const summaryListEl = document.getElementById('report-summary-items-list');
            if (summaryListEl) {
                summaryListEl.innerHTML = '';
                const items = project.summaryItems || [];
                
                if (items.length === 0) {
                    // Opcjonalnie: Pusty stan, ale tutaj formularz jest od razu pod spodem, wic mo偶e by puste
                }

                items.forEach((item, index) => {
                    const li = document.createElement('li');
                    li.style.cssText = "display: flex; gap: 12px; padding: 8px; border-bottom: 1px dashed var(--border-color); align-items: flex-start;";
                    
                    li.innerHTML = `
                        <div style="flex: 1; font-weight: 600; color: var(--text-primary); font-size: 13px;">${item.label}:</div>
                        <div style="flex: 2; color: var(--text-secondary); font-size: 13px; white-space: pre-wrap;">${item.value}</div>
                        <button class="delete-attachment-btn js-delete-summary-item" data-index="${index}" title="Usu">&times;</button>
                    `;
                    summaryListEl.appendChild(li);
                });
            }
            // --- KONIEC ---

           // --- ZMIENNE STATYSTYCZNE (ROZDZIELONE) ---
            // Obiekt dla Zada G贸wnych
            const statsMain = {
                onTimeCount: 0,
                lateCount: 0,
                totalDelayHours: 0,
                maxDelayHours: 0,
                worstTaskTitle: "Brak op贸藕nie"
            };

            // Obiekt dla Podzada
            const statsSub = {
                onTimeCount: 0,
                lateCount: 0,
                totalDelayHours: 0,
                maxDelayHours: 0,
                worstTaskTitle: "Brak op贸藕nie"
            };

            const currency = project.budget?.currency || 'PLN';
            const plannedBudget = parseFloat(project.budget?.amount) || 0;
            let actualSpent = 0;
            const taskCosts = []; // { title, cost }

            // ZMIANA: Rozszerzona struktura statystyk zespou
            const teamStats = {}; // { userId: { mainDone: 0, subDone: 0, late: 0 } }

            let abandonedCount = 0; // Status != done
            let totalComments = 0;

            const tasks = project.tasks || [];

            // --- ANALIZA ZADA (REKURENCYJNA) ---
            
            function analyzeTaskRecursively(item, isMainTask = true) {
                // Wybierz odpowiedni obiekt statystyk do aktualizacji
                const currentStats = isMainTask ? statsMain : statsSub;

                // A. FINANSE (Bez zmian - bud偶et jest wsp贸lny)
                const isItemDone = isMainTask ? (item.status === 'done') : (item.isCompleted === true);
                
                if (isItemDone && item.budgetItems && item.budgetItems.length > 0) {
                    const itemCost = item.budgetItems.reduce((sum, i) => sum + (parseFloat(i.amount) || 0), 0);
                    actualSpent += itemCost;
                    if (itemCost > 0) {
                        // Oznaczamy w kosztach czy to podzadanie
                        taskCosts.push({ title: (isMainTask ? item.title : `[Podzadanie] ${item.title}`), cost: itemCost });
                    }
                }

                // B. JAKO (Bez zmian)
                if (isMainTask && item.status !== 'done') {
                    abandonedCount++;
                }

                // C. CZAS I ZESP
                if (isItemDone) {
                    let isItemLate = false;
                    let completionTime = null;
                    if (item.completedAt) {
                         completionTime = (typeof item.completedAt.toDate === 'function') ? item.completedAt.toDate() : new Date(item.completedAt);
                    }
                    
                    if (item.dueDate && completionTime) {
                        const due = new Date(item.dueDate);
                        const diffMs = completionTime - due;

                        if (diffMs > 0) {
                            isItemLate = true;
                            
                            // Aktualizacja statystyk w odpowiednim obiekcie (Main lub Sub)
                            currentStats.lateCount++;
                            const diffHours = diffMs / (1000 * 60 * 60);
                            currentStats.totalDelayHours += diffHours;

                            if (diffHours > currentStats.maxDelayHours) {
                                currentStats.maxDelayHours = diffHours;
                                currentStats.worstTaskTitle = `${item.title} (${Math.round(diffHours)}h po terminie)`;
                            }
                        } else {
                            currentStats.onTimeCount++;
                        }
                    } else if (isItemDone) {
                        currentStats.onTimeCount++;
                    }

                    // D. PRZYPISANIE DO U呕YTKOWNIKA (Rozdzielone)
                    let finishers = item.completedBy || [];
                    if (finishers.length === 0 && item.assignees && item.assignees.length > 0) {
                        finishers = item.assignees;
                    }
                    
                    finishers.forEach(uid => {
                        if (!teamStats[uid]) teamStats[uid] = { mainDone: 0, subDone: 0, late: 0 };
                        
                        // ZMIANA: Inkrementacja odpowiedniego licznika
                        if (isMainTask) {
                            teamStats[uid].mainDone++;
                        } else {
                            teamStats[uid].subDone++;
                        }
                        
                        if (isItemLate) {
                            teamStats[uid].late++;
                        }
                    });
                }

                // E. KOMUNIKACJA (Bez zmian)
                totalComments += (item.comments || []).length;

                // F. REKURENCJA (Bez zmian)
                if (item.subtasks && item.subtasks.length > 0) {
                    item.subtasks.forEach(sub => {
                        if (sub.isCompleted && !sub.completedAt && isMainTask && item.completedAt) {
                            sub.completedAt = item.completedAt;
                        }
                        analyzeTaskRecursively(sub, false); // isMainTask = false
                    });
                }
            }

            // Uruchom analiz dla wszystkich zada g贸wnych
            tasks.forEach(task => analyzeTaskRecursively(task, true));

            // --- RENDEROWANIE WYNIKW W DOM ---

            // 1. Definicja funkcji pomocniczej (wewntrz openProjectReportModal)
            const generateTimeKPI = (label, stats) => {
                const total = stats.onTimeCount + stats.lateCount;
                const percent = total > 0 ? Math.round((stats.onTimeCount / total) * 100) : 0;
                const avgDelay = stats.lateCount > 0 ? (stats.totalDelayHours / stats.lateCount) : 0;
                let avgDelayText = "Brak";
                if (avgDelay > 0) {
                    avgDelayText = avgDelay > 24 ? `${(avgDelay / 24).toFixed(1)} dni` : `${Math.round(avgDelay)} h`;
                }
                const color = percent < 80 ? 'var(--danger-primary)' : 'var(--success-primary)';

                return `
                <div class="report-kpi-card">
                    <span class="kpi-label">${label} - Terminowo</span>
                    <strong class="kpi-value" style="color: ${color};">${percent}%</strong>
                    <span class="kpi-sub">${stats.onTimeCount} z ${total} na czas</span>
                </div>
                <div class="report-kpi-card">
                    <span class="kpi-label">${label} - r. op贸藕nienie</span>
                    <strong class="kpi-value" style="color: var(--text-secondary); font-size: 20px;">${avgDelayText}</strong>
                    <span class="kpi-sub">dla ${stats.lateCount} sp贸藕nionych</span>
                </div>
                <div class="report-kpi-card wide">
                    <span class="kpi-label">${label} - Najwikszy polizg</span>
                    <div style="font-size: 13px; margin-top: 6px; font-weight: 500; color: var(--danger-primary);">${stats.worstTaskTitle}</div>
                </div>
                `;
            };

            // SEKCJA 1: CZAS (Nowe renderowanie)
            const timeSectionContainer = document.querySelector('.report-section .report-kpi-grid');
            if (timeSectionContainer) {
                timeSectionContainer.innerHTML = `
                    ${generateTimeKPI('Zadania G贸wne', statsMain)}
                    <div style="grid-column: 1 / -1; height: 1px; background: var(--border-color); margin: 8px 0;"></div>
                    ${generateTimeKPI('Podzadania', statsSub)}
                `;
            }


            // SEKCJA 2: BUD呕ET
            const budgetContainer = document.getElementById('report-budget-container');
            const budgetPercent = plannedBudget > 0 ? (actualSpent / plannedBudget) * 100 : 0;
            const isOver = actualSpent > plannedBudget && plannedBudget > 0;
            const colorClass = isOver ? 'over' : '';
            const diffVal = plannedBudget - actualSpent;
            
            const formatMoney = (val) => val.toLocaleString('pl-PL', { style: 'currency', currency: currency });

            // Generowanie paska postpu bud偶etu
            if (budgetContainer) {
                budgetContainer.innerHTML = `
                    <div style="display: flex; justify-content: space-between; font-size: 13px; margin-bottom: 4px;">
                        <span>Wydano: <strong>${formatMoney(actualSpent)}</strong></span>
                        <span style="color: var(--text-secondary);">Bud偶et: ${formatMoney(plannedBudget)}</span>
                    </div>
                    <div class="report-budget-bar-bg">
                        <div class="report-budget-bar-fill ${colorClass}" style="width: ${Math.min(budgetPercent, 100)}%">
                            ${budgetPercent.toFixed(1)}%
                        </div>
                    </div>
                    <div style="text-align: right; font-size: 12px; margin-top: 4px; font-weight: 600; color: ${diffVal < 0 ? 'var(--danger-primary)' : 'var(--success-primary)'};">
                        ${diffVal < 0 ? `Przekroczenie: ${formatMoney(Math.abs(diffVal))}` : `Oszczdno: ${formatMoney(diffVal)}`}
                    </div>
                `;
            }

            // === NAPRAWA BDU 'totalDoneTasks' ===
            // Obliczamy cakowit liczb ukoczonych element贸w (Zadania + Podzadania) na potrzeby redniego kosztu
            const allDoneCount = (statsMain.onTimeCount + statsMain.lateCount) + (statsSub.onTimeCount + statsSub.lateCount);
            
            document.getElementById('report-avg-cost').textContent = allDoneCount > 0 ? formatMoney(actualSpent / allDoneCount) : '-';
            
            // Ranking kosztownych zada (Top 3)
            taskCosts.sort((a, b) => b.cost - a.cost);
            const costlyList = document.getElementById('report-costly-tasks');
            
            if (costlyList) {
                if (taskCosts.length === 0) {
                    costlyList.innerHTML = '<li style="color: var(--text-secondary); font-style: italic;">Brak danych finansowych.</li>';
                } else {
                    costlyList.innerHTML = taskCosts.slice(0, 3).map(t => `
                        <li style="display:flex; justify-content:space-between; border-bottom:1px dashed var(--border-color); padding:4px 0;">
                            <span style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 70%;" title="${t.title}">${t.title}</span>
                            <strong>${formatMoney(t.cost)}</strong>
                        </li>
                    `).join('');
                }
            }


           // SEKCJA 3: ZESP (Tabela)
            
            // Najpierw zaktualizuj nag贸wki tabeli
            const teamTableHead = document.querySelector('.report-table thead tr');
            if (teamTableHead) {
                teamTableHead.innerHTML = `
                    <th>Pracownik</th>
                    <th style="text-align: center;">Zadania</th>
                    <th style="text-align: center;">Podzadania</th>
                    <th style="text-align: center;">Terminowo</th>
                    <th style="text-align: center;">Lider w...</th>
                `;
            }

            const teamTbody = document.getElementById('report-team-tbody');
            teamTbody.innerHTML = '';
            
            // Konwersja obiektu statystyk na tablic i sortowanie wg liczby zada (malejco)
            const teamRanking = Object.keys(teamStats).map(uid => {
                const stats = teamStats[uid];
                const user = findUser(uid);
                
                // POPRAWKA: Sumujemy zadania g贸wne i podzadania, aby uzyska czn liczb wykonanych
                const total = (stats.mainDone || 0) + (stats.subDone || 0);
                
                // Obliczamy terminowo na podstawie poprawnej sumy
                const timelyRate = total > 0 ? ((total - stats.late) / total) * 100 : 0;
                
                // Zwracamy obiekt z dodanym polem 'done' (u偶ywanym do sortowania)
                return { 
                    uid, 
                    name: user ? (user.name || user.email) : 'Nieznany', 
                    ...stats, 
                    done: total, // <-- Dodajemy brakujce pole 'done'
                    timelyRate 
                };
            }).sort((a, b) => b.done - a.done);

            if (teamRanking.length === 0) {
                // Zmieniono colspan na 5, bo mamy now kolumn
                teamTbody.innerHTML = '<tr><td colspan="5" style="text-align:center; color:var(--text-secondary); padding: 15px;">Brak danych o wykonawcach.</td></tr>';
            } else {
                // Obliczamy maxy dla obu kategorii
                const maxMain = Math.max(...teamRanking.map(r => r.mainDone), 0);
                const maxSub = Math.max(...teamRanking.map(r => r.subDone), 0);

                teamRanking.forEach((r, index) => {
                    const avatar = renderAvatarHTML(findUser(r.uid), 'avatar-comment');
                    
                    let badges = '';
                    // Badge za zadania g贸wne
                    if (r.mainDone === maxMain && maxMain > 0) badges += `<span class="report-badge badge-gold" title="Najwicej zada g贸wnych">Mistrz Zada</span> `;
                    // Badge za podzadania
                    if (r.subDone === maxSub && maxSub > 0) badges += `<span class="report-badge badge-green" title="Najwicej podzada">Pomocna Do</span> `;

                    teamTbody.innerHTML += `
                        <tr>
                            <td>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    ${avatar.replace('class="avatar avatar-comment"', 'class="avatar" style="width:24px;height:24px;font-size:10px;"')}
                                    <span style="font-weight: 500;">${r.name}</span>
                                </div>
                            </td>
                            <td style="text-align: center; font-weight: 600; font-size: 14px;">${r.mainDone}</td>
                            <td style="text-align: center; color: var(--text-secondary);">${r.subDone}</td>
                            <td style="text-align: center;">
                                <span style="color: ${r.timelyRate < 80 ? 'var(--danger-primary)' : 'var(--success-primary)'}; font-weight: 600;">${r.timelyRate.toFixed(0)}%</span>
                            </td>
                            <td style="text-align: center;">${badges}</td>
                        </tr>
                    `;
                });
            }

            // SEKCJA 4: JAKO
            document.getElementById('report-abandoned-count').textContent = abandonedCount;
            document.getElementById('report-comments-count').textContent = totalComments;

            openModal(modal);
        }
        // --- NOWA FUNKCJA: Otwieranie modala szczeg贸贸w ---
        function openProjectDetailsModal() {
            const project = findProject(state.currentProjectId);
            if (!project) {
                showNotification("Nie mo偶na zaadowa szczeg贸贸w projektu.", "Bd");
                return;
            }

            projectDetailsModal.title.textContent = `Szczeg贸y: ${project.name}`;
            projectDetailsModal.projectName.textContent = project.name;

            const owner = findUser(project.ownerId);
            projectDetailsModal.projectOwner.textContent = owner ? (owner.name || owner.email) : 'Nieznany';

            projectDetailsModal.projectMembers.innerHTML = (project.members || [])
                .map(findUser)
                .filter(Boolean)
                .map(user => renderAvatarHTML(user)) // U偶ywamy istniejcej funkcji
                .join('') || 'Brak czonk贸w';

            projectDetailsModal.projectDescription.textContent = project.description || 'Brak opisu.';
            projectDetailsModal.projectStart.textContent = project.startDate ? new Date(project.startDate).toLocaleDateString('pl-PL') : '-';
            projectDetailsModal.projectEnd.textContent = project.endDate ? new Date(project.endDate).toLocaleDateString('pl-PL') : '-';

            const priorities = { low: 'Niski', medium: 'redni', high: 'Wysoki' };
            projectDetailsModal.projectPriority.textContent = priorities[project.priority] || project.priority;

            // Renderowanie wykres贸w
            renderProjectBudgetChartCSS(project, projectDetailsModal.budgetChartContainer);
            renderProjectWorkloadChart(project, projectDetailsModal.workloadChartContainer, projectDetailsModal.workloadChartPlaceholder); // Przekazujemy te偶 placeholder

            // ETAP 4: Renderowanie nowej tabeli
            renderProjectBudgetTasksTable(project, 'details-budget-tasks-table-container');

            openModal(projectDetailsModal.overlay);
        }
       /**
         * Renderuje list wysiku podzada w modalu zadania g贸wnego.
         */
        function renderSubtaskEffortSummary(subtasks, unit) {
            const container = document.getElementById('subtask-effort-list-container');
            const totalEstEl = document.getElementById('effort-summary-total-est');
            const totalActEl = document.getElementById('effort-summary-total-act');
            
            container.innerHTML = '';
            
            let totalEst = 0;
            let totalAct = 0;

            if (!subtasks || subtasks.length === 0) {
                container.innerHTML = '<div style="padding:10px; text-align:center; color:var(--text-secondary);">Brak podzada.</div>';
            } else {
                subtasks.forEach(sub => {
                    const est = parseFloat(sub.effort) || 0;
                    const act = parseFloat(sub.actualEffort) || 0;
                    
                    totalEst += est;
                    totalAct += act;

                    // Kolorowanie rzeczywistego
                    let actColor = 'inherit';
                    if (act > est) actColor = 'var(--danger-primary)';
                    else if (act > 0 && act < est) actColor = 'var(--success-primary)';

                    container.innerHTML += `
                        <div class="summary-list-item">
                            <span style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="${sub.title}">${sub.title}</span>
                            <span class="val">${est} ${unit}</span>
                            <span class="val" style="color: ${actColor};">${act} ${unit}</span>
                        </div>
                    `;
                });
            }

            totalEstEl.textContent = `${totalEst} ${unit}`;
            totalActEl.textContent = `${totalAct} ${unit}`;
        }

        /**
         * Renderuje list bud偶etu podzada w modalu zadania g贸wnego.
         */
        function renderSubtaskBudgetSummary(subtasks, currency) {
            const container = document.getElementById('subtask-budget-list-container');
            const totalEl = document.getElementById('modal-task-budget-summary-total');
            const currencyEl = document.getElementById('modal-task-budget-summary-currency');
            
            container.innerHTML = '';
            let grandTotal = 0;

            if (!subtasks || subtasks.length === 0) {
                container.innerHTML = '<div style="padding:10px; text-align:center; color:var(--text-secondary);">Brak podzada.</div>';
            } else {
                subtasks.forEach(sub => {
                    // Oblicz sum dla tego podzadania
                    let subTotal = 0;
                    let detailsHTML = '';
                    
                    if (sub.budgetItems && sub.budgetItems.length > 0) {
                        sub.budgetItems.forEach(item => {
                            const amount = parseFloat(item.amount) || 0;
                            subTotal += amount;
                            detailsHTML += `
                                <div class="budget-summary-row">
                                    <span>${item.name}</span>
                                    <span>${amount.toLocaleString('pl-PL', { minimumFractionDigits: 2 })}</span>
                                </div>
                            `;
                        });
                    } else {
                        detailsHTML = '<div class="budget-summary-row"><span>Brak koszt贸w</span><span>-</span></div>';
                    }

                    grandTotal += subTotal;

                    container.innerHTML += `
                        <div class="budget-summary-item">
                            <div class="budget-summary-header">
                                <span>${sub.title}</span>
                                <strong>${subTotal.toLocaleString('pl-PL', { minimumFractionDigits: 2 })} ${currency}</strong>
                            </div>
                            <div class="budget-summary-details">
                                ${detailsHTML}
                            </div>
                        </div>
                    `;
                });
            }

            totalEl.textContent = grandTotal.toLocaleString('pl-PL', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            currencyEl.textContent = currency;
        }
         function renderMyDashboardView() {
            // ZMIANA: Upewniamy si, 偶e kanbanBoardEl jest widoczny w tym widoku
            kanbanBoardEl.style.display = 'block';

            // NOWA LINIA: Resetowanie klasy kontenera do domylnej klasy Kanban
            kanbanBoardEl.className = 'dashboard-view'; 
            projectNameHeaderEl.textContent = 'M贸j Dashboard';
            mobileHeaderTitle.textContent = 'M贸j Dashboard';
            projectMembersHeaderEl.innerHTML = '';
            
            // === CZYSZCZENIE NAGWKA (CLEAN UI) ===
            if (projectMenuToggle) projectMenuToggle.style.display = 'none';
            if (projectProgressContainer) projectProgressContainer.style.display = 'none';
            // === KONIEC ===

            kanbanBoardEl.style.display = 'block';

            const myTasks = getAllMyTasks();
             // === NOWA LINIA: Obliczanie globalnego bud偶etu ===
            const globalBudgetSummary = calculateGlobalBudgetSummary();
             // === NOWA LINIA: Obliczanie bud偶etu per osoba ===
            const userBudgetSummary = calculateGlobalUserBudgetSummary();

            // ... (logika sortowania myTasks) ...
            myTasks.sort((a, b) => {
                const dateA = a.dueDate ? new Date(a.dueDate).getTime() : Infinity;
                const dateB = b.dueDate ? new Date(b.dueDate).getTime() : Infinity;
                if (dateA === Infinity && dateB === Infinity) return 0;
                if (dateA === Infinity) return 1;
                if (dateB === Infinity) return -1;
                return state.ui.sortMyTasksByDate === 'asc' ? dateA - dateB : dateB - a.dueDate;
            });

            const overdueTasks = getOverdueTasks(myTasks);
            const todayPlusTomorrow = myTasks.filter(t => {
                if (!t.dueDate || t.status === 'done') return false;
                const dueDate = new Date(t.dueDate);
                const now = new Date();
                const endOfTomorrow = new Date();
                endOfTomorrow.setDate(endOfTomorrow.getDate() + 2);
                endOfTomorrow.setHours(0, 0, 0, 0);
                return dueDate >= now && dueDate < endOfTomorrow;
            });
            const teamOverdueCount = getTeamOverdueCount();
            
            const todoCount = myTasks.filter(t => t.status === 'todo').length;
            const inProgressCount = myTasks.filter(t => t.status === 'inprogress').length;
            const totalActiveTasks = todoCount + inProgressCount;
            const todoPercent = totalActiveTasks > 0 ? (todoCount / totalActiveTasks) * 100 : 0;
            const inProgressPercent = totalActiveTasks > 0 ? (inProgressCount / totalActiveTasks) * 100 : 0;

            const otherUsersActivities = getAllActivitiesFromMyProjects().filter(activity => activity.userId !== state.currentUser.uid);
            otherUsersActivities.sort((a, b) => b.timestamp - a.timestamp);
            const recentActivityCount = otherUsersActivities.slice(0, 15).length;

            // Definicje HTML kart KPI (skr贸cone dla czytelnoci, logika bez zmian)
            const cardHTMLs = {
                'my-overdue': `
                    <div class="dashboard-card kpi-mini-card" data-id="my-overdue" data-action="show-my-overdue-details">
                        <h3>Moje Op贸藕nione Zadania</h3>
                        <div style="font-size: 36px; font-weight: 700; color: var(--danger-primary);">${overdueTasks.length}</div>
                        <p style="font-size: 14px; color: var(--text-secondary);">Kliknij, aby zobaczy szczeg贸y</p>
                        <div id="my-overdue-chart" style="height: 30px; margin-top: 10px; background-color: var(--bg-tertiary); border-radius: 4px; overflow: hidden;">
                            <div style="height: 100%; width: ${Math.min(overdueTasks.length * 10, 100)}%; background-color: var(--danger-primary); transition: width 0.5s;"></div>
                        </div>
                    </div>`,
                'team-delays': `
                    <div class="dashboard-card kpi-mini-card" data-id="team-delays" data-action="show-team-delays-details">
                        <h3>Op贸藕nienia w Zespole</h3>
                        <div style="font-size: 36px; font-weight: 700; color: ${teamOverdueCount > 0 ? 'var(--danger-primary)' : 'var(--success-primary)'};">${teamOverdueCount}</div>
                        <p style="font-size: 14px; color: var(--text-secondary);">Kliknij, aby zobaczy szczeg贸y</p>
                        <div id="team-delays-chart-container" style="height: 30px; margin-top: 10px; background-color: var(--bg-tertiary); border-radius: 4px; overflow: hidden;">
                            <div style="height: 100%; width: ${Math.min(teamOverdueCount * 5, 100)}%; background-color: ${teamOverdueCount > 0 ? 'var(--danger-hover)' : 'var(--success-primary)'}; transition: width 0.5s;"></div>
                        </div>
                    </div>`,
                'workload': `
                    <div class="dashboard-card kpi-mini-card" data-id="workload" data-action="show-workload-details">
                        <h3>Moje Obci偶enie</h3>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <span style="font-size: 24px; font-weight: 700;">${totalActiveTasks}</span>
                            <span style="font-size: 12px; color: var(--text-secondary);">Aktywne zadania</span>
                        </div>
                        <div id="workload-chart-container" style="height: 16px; width: 100%; background-color: var(--bg-tertiary); border-radius: 8px; overflow: hidden;">
                            <div style="display: flex; height: 100%;">
                                <div title="Do realizacji: ${todoCount}" style="width: ${todoPercent}%; background-color: var(--danger-primary);"></div>
                                <div title="W trakcie: ${inProgressCount}%;" style="width: ${inProgressPercent}%; background-color: var(--accent-primary);"></div>
                            </div>
                        </div>
                        <p style="font-size: 14px; color: var(--text-secondary); margin-top: 16px;">Kliknij, aby zobaczy szczeg贸y</p>
                    </div>`,
                'upcoming': `
                    <div class="dashboard-card kpi-mini-card" data-id="upcoming" data-action="show-upcoming-details">
                        <h3>Nadchodzce Terminy</h3>
                        <div style="font-size: 36px; font-weight: 700; color: ${todayPlusTomorrow.length > 0 ? 'var(--accent-primary)' : 'var(--success-primary)'};">${todayPlusTomorrow.length}</div>
                        <p style="font-size: 14px; color: var(--text-secondary);">Zadania na dzi i jutro.</p>
                        <div id="upcoming-tasks-chart" style="height: 30px; margin-top: 10px; background-color: var(--bg-tertiary); border-radius: 4px; overflow: hidden;">
                            <div style="height: 100%; width: ${Math.min(todayPlusTomorrow.length * 5, 100)}%; background-color: var(--accent-primary); transition: width 0.5s;"></div>
                        </div>
                    </div>`,
                'activity': `
                    <div class="dashboard-card kpi-mini-card" data-id="activity" data-action="show-activity-details">
                        <h3>Ostatnia Aktywno Zespou</h3>
                        <div style="font-size: 36px; font-weight: 700; color: var(--success-primary);">${recentActivityCount}</div>
                        <p style="font-size: 14px; color: var(--text-secondary);">Akcje innych czonk贸w w Twoich projektach (max 15).</p>
                        <div id="recent-activity-chart" style="height: 30px; margin-top: 10px; background-color: var(--bg-tertiary); border-radius: 4px; overflow: hidden;">
                            <div style="height: 100%; width: ${Math.min(recentActivityCount / 15 * 100, 100)}%; background-color: var(--success-primary); transition: width 0.5s;"></div>
                        </div>
                    </div>`
            };
            
            // Obci偶enie Zespou
            const teamWorkloadData = calculateTeamWorkload(); 
            const teamTotals = teamWorkloadData.totals;
            const teamTotalTasks = teamTotals.todo + teamTotals.inprogress + teamTotals.done;
            const teamTodoPercent = teamTotalTasks > 0 ? (teamTotals.todo / teamTotalTasks) * 100 : 0;
            const teamInProgressPercent = teamTotalTasks > 0 ? (teamTotals.inprogress / teamTotalTasks) * 100 : 0;

            cardHTMLs['team-workload'] = `
                <div class="dashboard-card kpi-mini-card" data-id="team-workload" data-action="show-team-workload-details">
                    <h3>Obci偶enie zespou <span style="color: var(--text-secondary); font-weight: 500; font-size: 13px;">(Wsp贸lne projekty)</span></h3>
                    <div style="font-size: 36px; font-weight: 700; color: var(--text-primary); margin-top: 8px;">
                        ${teamTotals.totalActive}
                        <span style="font-size: 16px; font-weight: 500; color: var(--text-secondary); margin-left: 8px;">Aktywne</span>
                    </div>
                    <p style="font-size: 14px; color: var(--text-secondary); margin-bottom: 12px;">Cakowita liczba zada: ${teamTotalTasks}</p>
                    <div class="modern-chart">
                        <div class="chart-row">
                            <div class="chart-label"><span>Do realizacji</span><strong>${teamTotals.todo}</strong></div>
                            <div class="chart-bar-wrapper"><div class="chart-bar-fill todo" style="width: ${teamTodoPercent}%;"></div></div>
                        </div>
                        <div class="chart-row">
                            <div class="chart-label"><span>W trakcie</span><strong>${teamTotals.inprogress}</strong></div>
                            <div class="chart-bar-wrapper"><div class="chart-bar-fill inprogress" style="width: ${teamInProgressPercent}%;"></div></div>
                        </div>
                    </div>
                </div>
            `;

            // M贸j Bud偶et
            cardHTMLs['my-budget'] = `
                <div class="dashboard-card kpi-mini-card" data-id="my-budget" data-action="show-my-budget-details">
                    <h3>Bud偶et projekty</h3>
                    <div class="budget-kpi-circle ${globalBudgetSummary.percentage > 100 ? 'over-budget' : ''}" 
                         style="--progress-percent: ${Math.min(globalBudgetSummary.percentage, 100)}"
                         title="Wykorzystano ${globalBudgetSummary.percentage.toFixed(1)}%">
                        <div class="budget-kpi-percentage">${globalBudgetSummary.percentage.toFixed(0)}%</div>
                    </div>
                    <div class="budget-kpi-details">
                        <div class="budget-kpi-summary-numbers">
                            <span>Zaanga偶owano</span>
                            <strong>${globalBudgetSummary.totalCommitted.toLocaleString('pl-PL')}</strong>
                            <span>z: <strong>${globalBudgetSummary.totalBudget.toLocaleString('pl-PL')}</strong></span>
                        </div>
                    </div>
                    <div class="budget-kpi-footer">
                        <button type="button" class="js-toggle-budget-details">
                            <span>Szczeg贸y</span>
                            <svg class="chevron" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" /></svg>
                        </button>
                    </div>
                </div>
            `;

            // Bud偶et Osoby
            const userTotals = userBudgetSummary.totals;
            const totalCommitted = userTotals.total;
            const spentPercent = totalCommitted > 0 ? (userTotals.spent / totalCommitted) * 100 : 0;
            const reservedPercent = totalCommitted > 0 ? (userTotals.reserved / totalCommitted) * 100 : 0;

            cardHTMLs['user-budget'] = `
                <div class="dashboard-card kpi-mini-card" data-id="user-budget" data-action="show-user-budget-details">
                    <h3>Bud偶et - osoby</h3>
                    <div class="budget-kpi-ratio-bar" title="Stosunek koszt贸w Wydanych do Zarezerwowanych przez zesp贸">
                        <div class="budget-kpi-ratio-segment bar-spent" style="width: ${spentPercent}%"></div>
                        <div class="budget-kpi-ratio-segment bar-reserved" style="width: ${reservedPercent}%"></div>
                    </div>
                    <div style="display: flex; justify-content: space-between; font-size: 12px; padding: 0 5px;">
                        <span style="color: var(--success-primary);"> Wydane</span>
                        <span style="color: var(--accent-primary);"> Zarezerwowane</span>
                    </div>
                    <div class="budget-kpi-summary-numbers" style="margin-top: 10px;">
                        <span>cznie zaanga偶owane przez zesp贸</span>
                        <strong>${totalCommitted.toLocaleString('pl-PL', { style: 'currency', currency: 'PLN' })}</strong>
                    </div>
                </div>
            `;

            // Renderowanie GRID
            kanbanBoardEl.innerHTML = `
                <div class="dashboard-container">
                    <div class="dashboard-grid" id="dashboard-grid-main"></div>
                    <h2 style="font-size: 20px; font-weight: 600; margin-bottom: 16px; margin-top: 24px;">Wszystkie Moje Zadania</h2>
                    <section id="my-tasks-kanban" class="kanban-board-mini"></section>
                </div>
            `;
            
            const dashboardGrid = document.getElementById('dashboard-grid-main');
            const allKpis = ['my-overdue', 'team-delays', 'upcoming', 'workload', 'activity', 'team-workload', 'my-budget', 'user-budget']; 
            const order = state.currentUser.layouts.dashboard || allKpis;
            
            order.forEach(id => {
                if (cardHTMLs[id]) {
                    dashboardGrid.insertAdjacentHTML('beforeend', cardHTMLs[id]);
                }
            });

            const fillerCount = 3 - (dashboardGrid.children.length % 3);
            if (fillerCount < 3) {
                for (let i = 0; i < fillerCount; i++) {
                     const emptyTile = document.createElement('div');
                     emptyTile.className = 'dashboard-card kpi-mini-card';
                     emptyTile.style.visibility = 'hidden'; 
                     emptyTile.style.border = 'none';
                     emptyTile.style.boxShadow = 'none';
                     emptyTile.style.cursor = 'default';
                     emptyTile.innerHTML = '&nbsp;';
                     dashboardGrid.appendChild(emptyTile);
                }
            }

            dashboardGrid.classList.toggle('layout-edit-mode', state.ui.dashboardEditMode);
            
            if (sortableDashboard) {
                sortableDashboard.destroy();
                sortableDashboard = null;
            }
            if (state.ui.dashboardEditMode && dashboardGrid) {
                sortableDashboard = new Sortable(dashboardGrid, {
                    animation: 150,
                    ghostClass: 'sortable-ghost',
                    group: 'dashboard-kpi', 
                    multiDrag: true, 
                    selectedClass: 'selected' 
                });
            }

            const myTasksKanbanEl = document.getElementById('my-tasks-kanban');

            // 1. Pobierz dane now metod (Zadania + Podzadania)
            // U偶ywamy getAllMyTasksAndSubtasks() zamiast myTasks (kt贸re byo z getAllMyTasks())
            const allMyWorkItems = getAllMyTasksAndSubtasks();
            
            // 2. Sortowanie (opcjonalne, bo renderMyTasksKanban te偶 sortuje, ale dla porzdku)
            allMyWorkItems.sort((a, b) => {
                 const dateA = a.dueDate ? new Date(a.dueDate).getTime() : Infinity;
                 const dateB = b.dueDate ? new Date(b.dueDate).getTime() : Infinity;
                 if (dateA === Infinity && dateB === Infinity) return 0;
                 if (dateA === Infinity) return 1;
                 if (dateB === Infinity) return -1;
                 return state.ui.sortMyTasksByDate === 'asc' ? dateA - dateB : dateB - dateA;
            });

            // 3. Wywoaj now funkcj renderujc (zdefiniowan globalnie)
            // Przekazujemy "allMyWorkItems"
            renderMyTasksKanban(allMyWorkItems, myTasksKanbanEl);

            // === NOWA LOGIKA: Wczenie Drag & Drop na Dashboardzie ===
            if (window.dashboardSortableInstances) {
                window.dashboardSortableInstances.forEach(s => s.destroy());
            }
            window.dashboardSortableInstances = [];

            // ZMIANA 1: Wybieramy zar贸wno g贸wne kolumny, jak i kontenery podzada wewntrz kart
            const dashboardDropZones = myTasksKanbanEl.querySelectorAll('.kanban-tasks, .subtask-family-container');
            
            dashboardDropZones.forEach(list => {
                const sortable = new Sortable(list, {
                    group: 'dashboard-tasks', // Wsp贸lna grupa pozwala przenosi midzy rodzicem a kolumn
                    animation: 150,
                    ghostClass: 'task-card-ghost',
                    chosenClass: 'task-card-chosen',
                    dragClass: 'task-card-drag',
                    delay: 200, 
                    delayOnTouchOnly: true,
                    fallbackOnBody: true, // Wa偶ne dla zagnie偶d偶onych element贸w, aby nie "choway si" pod rodzicem
                    
                    onStart: (evt) => {
                        // ZMIANA 2: Pobieramy ID niezale偶nie czy to zadanie g贸wne (taskId) czy podzadanie (subtaskId)
                        draggedTaskId = evt.item.dataset.taskId || evt.item.dataset.subtaskId;
                        evt.item.classList.add('dragging');
                    },
                    
                    onEnd: (evt) => {
                        evt.item.classList.remove('dragging');
                        
                        // Sprawdzamy, czy upuszczono w kolumnie (a nie z powrotem w tym samym rodzicu)
                        const column = evt.to.closest('.kanban-column');
                        
                        // Blokada: Nie pozw贸l wrzuci zadania g贸wnego do kontenera podzada
                        if (evt.to.classList.contains('subtask-family-container') && evt.item.classList.contains('task-card')) {
                            // Cofnij zmian wizualnie (Sortable to obsu偶y, ale musimy przerwa logik)
                            return;
                        }

                        if (column && draggedTaskId) {
                            // ZMIANA 3: Logika aktualizacji
                            // Jeli wycignlimy podzadanie do kolumny, 'handleDroppedTask' zaktualizuje jego status
                            // i usunie wizualnie z rodzica przy przerysowaniu (renderMyDashboardView).
                            
                            // Pobieramy identyfikator kolumny z datasetu (ustawionego w renderMyTasksKanban)
                            const columnIdRaw = column.dataset.columnId; 
                            let newStatus = column.dataset.status;
                            let newCustomColumnId = null;

                            // Logika mapowania kolumn Dashboardu na statusy
                            if (columnIdRaw && columnIdRaw.startsWith('custom_')) {
                                newStatus = 'inprogress';
                                // Musimy znale藕 prawdziwe ID kolumny niestandardowej.
                                // W renderMyTasksKanban zapisujemy customColumnId, jeli jest dostpny w itemie.
                                // Tutaj jednak mamy tylko status bazowy.
                                // Na Dashboardzie upraszczamy: jeli wrzucamy do "custom", to status='inprogress'.
                                // Aby w peni obsu偶y custom columns na dashboardzie przy dropie, 
                                // musielibymy zna ID custom column z samej kolumny DOM.
                                // Poprawka: W renderMyTasksKanban dodaem ju偶 data-column-id.
                                // Ale to jest klucz mapy ('custom_nazwa').
                                // W tym widoku (Dashboard) przenoszenie do customowych kolumn mo偶e by ryzykowne bez ID.
                                // BEZPIECZNIEJ: Ustawiamy tylko status bazowy, chyba 偶e mamy pewno.
                            } 
                            
                            // Poniewa偶 Dashboard agreguje projekty, wrzucenie do kolumny "Do realizacji"
                            // powinno po prostu ustawi status na 'todo'.
                            // Jeli wrzucimy do "W trakcie", ustawiamy 'inprogress'.
                            
                            handleDroppedTask(draggedTaskId, newStatus, null);
                        }
                        draggedTaskId = null; 
                    }
                });
                window.dashboardSortableInstances.push(sortable);
            });
        }
       /**
             * Renderuje tablic Kanban na Dashboardzie, czc kolumny o tych samych nazwach z r贸偶nych projekt贸w.
             * Obsuguje zadania g贸wne i podzadania jako niezale偶ne kafelki.
             */
           const renderMyTasksKanban = (items, targetElement) => {
                targetElement.innerHTML = '';
                
                // 1. Konfiguracja kontenera (Poziomy przewijany pasek)
                targetElement.style.display = 'flex';
                targetElement.style.flexWrap = 'nowrap'; // Wa偶ne: Nie zawijaj kolumn
                targetElement.style.gap = '16px';
                targetElement.style.paddingBottom = '2px'; 
                targetElement.style.overflowX = 'auto';
                
                // === ZMIANA: Rozcigamy kolumny do penej wysokoci kontenera ===
                targetElement.style.alignItems = 'stretch'; // Byo: flex-start
                // ==============================================================
                
                targetElement.className = 'kanban-board-mini kanban-board'; 

                if (items.length === 0) {
                    targetElement.innerHTML = '<p class="no-tasks-message" style="margin: auto;">Brak aktywnych zada do wywietlenia.</p>';
                    return;
                }

                // 2. Mapa Kolumn (Buckets)
                // Klucz: Znormalizowana nazwa kolumny (np. 'custom_do_testow')
                const columnsMap = new Map();
                
                const getOrCreateColumn = (key, title, baseStatus) => {
                    if (!columnsMap.has(key)) {
                        columnsMap.set(key, { 
                            title: title, 
                            status: baseStatus, 
                            items: [],
                            isCustom: key.startsWith('custom_')
                        });
                    }
                    return columnsMap.get(key);
                };

                // Zawsze inicjujemy podstawowe kolumny
                getOrCreateColumn('todo', STATUSES.todo, 'todo');
                getOrCreateColumn('inprogress_default', STATUSES.inprogress, 'inprogress');
                getOrCreateColumn('done', STATUSES.done, 'done');
                
                // 3. Sortowanie element贸w do odpowiednich kolumn
                items.forEach(item => {
                    const status = item.status;
                    const customColId = item.customColumnId;
                    
                    if (status === 'todo') {
                        getOrCreateColumn('todo', STATUSES.todo, 'todo').items.push(item);
                    } else if (status === 'done') {
                         // Tutaj mo偶na doda filtr daty dla 'done', jeli chcesz ukrywa stare
                         getOrCreateColumn('done', STATUSES.done, 'done').items.push(item);
                    } else if (status === 'inprogress') {
                        // Zadanie jest "W trakcie" - sprawdzamy czy ma dedykowan kolumn w swoim projekcie
                        if (customColId) {
                            // Pobieramy definicj kolumny z projektu, do kt贸rego nale偶y zadanie
                            const colDef = (item.project.customColumns || []).find(c => c.id === customColId);
                            
                            if (colDef) {
                                // SCALANIE PO NAZWIE:
                                // Normalizujemy nazw (mae litery, usuwamy spacje), aby "Testy" i "testy" byy tym samym
                                const rawTitle = colDef.title;
                                const normalizedKey = `custom_${rawTitle.trim().toLowerCase().replace(/\s+/g, '_')}`;
                                
                                getOrCreateColumn(normalizedKey, rawTitle, 'inprogress').items.push(item);
                            } else {
                                // Jeli ID jest w zadaniu, ale kolumny nie ma w projekcie (np. usunita) -> Domylna "W trakcie"
                                getOrCreateColumn('inprogress_default', STATUSES.inprogress, 'inprogress').items.push(item);
                            }
                        } else {
                            // Standardowe "W trakcie" (bez ID)
                            getOrCreateColumn('inprogress_default', STATUSES.inprogress, 'inprogress').items.push(item);
                        }
                    }
                });

                // 4. Ustalanie kolejnoci kolumn
                // Kolejno: Do realizacji -> [Kolumny Niestandardowe A-Z] -> W trakcie (Domylna) -> Wykonane
                const sortedKeys = Array.from(columnsMap.keys()).sort((a, b) => {
                    if (a === 'todo') return -1;
                    if (b === 'todo') return 1;
                    if (a === 'done') return 1;
                    if (b === 'done') return -1;
                    
                    // Domylna "W trakcie" na kocu przed "Done"
                    if (a === 'inprogress_default') return 1;
                    if (b === 'inprogress_default') return -1;

                    return a.localeCompare(b); // Reszta alfabetycznie
                });

                // 5. Generowanie HTML
                sortedKeys.forEach(key => {
                    const colData = columnsMap.get(key);
                    
                    // Definiujemy kolumny standardowe
                    const isStandard = ['todo', 'inprogress_default', 'done'].includes(key);
                    
                    // ZASADA 1: Ukryj kolumny NIESTANDARDOWE, jeli s puste
                    if (!isStandard && colData.items.length === 0) return;

                    // === NOWE: SORTOWANIE WG DATY (MAIN + STANDALONE SUBTASKS) ===
                    const sortOrder = state.ui.sortMyTasksByDate || 'asc';

                    colData.items.sort((a, b) => {
                        // Funkcja pomocnicza do wycigania daty z obu typ贸w obiekt贸w
                        const getDate = (item) => {
                            let dateVal = null;
                            if (item.type === 'main') {
                                dateVal = item.data.dueDate;
                            } else { // item.type === 'subtask'
                                dateVal = item.data.sub.dueDate;
                            }
                            return dateVal ? new Date(dateVal).getTime() : null;
                        };

                        const timeA = getDate(a);
                        const timeB = getDate(b);

                        // Ustal warto dla braku daty (Infinity wrzuca na koniec)
                        const valA = timeA !== null ? timeA : (sortOrder === 'asc' ? Infinity : -Infinity);
                        const valB = timeB !== null ? timeB : (sortOrder === 'asc' ? Infinity : -Infinity);

                        if (valA !== valB) {
                            return sortOrder === 'asc' ? valA - valB : valB - valA;
                        }

                        // Jeli daty s r贸wne, zachowaj stabilno (lub sortuj po ID/Tytule)
                        return 0;
                    });
                    // === KONIEC SORTOWANIA ===

                    // Generowanie kafelk贸w
                    const cardsHTML = colData.items.map(item => {
                        if (item.type === 'main') {
                            // ZADANIE GWNE
                            return createTaskCardHTML(item.data, true, item.project, colData.status, item.customColumnId);
                        } else {
                            // PODZADANIE (Niezale偶ny kafelek)
                            const { sub, parent } = item.data;
                            return createVisualSubtaskCardHTML(sub, parent, item.project, 'standalone');
                        }
                    }).join('');

                    // === NOWA LOGIKA: Obsuga zwijania dla Dashboardu ===
                    // U偶ywamy klucza 'dashboard' w obiekcie collapsedColumns
                    const dashboardCollapsed = state.ui.collapsedColumns['dashboard'] || [];
                    // Identyfikatorem kolumny jest 'key' (np. 'todo', 'custom_analiza')
                    const isCollapsed = dashboardCollapsed.includes(key);
                    const collapsedClass = isCollapsed ? 'collapsed' : '';

                    // === NOWA LOGIKA: Licznik zada i Suma Wysiku ===
                    // Musimy to wygenerowa, poniewa偶 w stanie zwinitym CSS ukrywa standardowe liczniki
                    // a pokazuje te wewntrz .kanban-header-counts (zgodnie z logik z widoku projektu)
                    
                    // Obliczanie sumy estymacji dla tej kolumny (opcjonalne, dla sp贸jnoci)
                    let estimationSum = 0;
                    let actualSum = 0;
                    colData.items.forEach(item => {
                         const taskData = item.type === 'main' ? item.data : item.data.sub;
                         // Proste sumowanie, pomijamy gbsz logik jednostek dla dashboardu, aby nie komplikowa
                         // Zakadamy, 偶e jeli s dane, to je sumujemy
                         estimationSum += parseFloat(taskData.estimation || taskData.effort || 0);
                         actualSum += parseFloat(taskData.actualEffort || 0);
                    });
                    
                    let estimationSumHTML = '';
                    if (estimationSum > 0 || actualSum > 0) {
                        let color = "var(--text-secondary)";
                        if (actualSum > estimationSum) color = "var(--danger-primary)";
                        else if (actualSum > 0 && actualSum < estimationSum) color = "var(--success-primary)";
                        
                        // Jednostka domylna 'h/pkt' bo na dashboardzie mieszaj si projekty
                        estimationSumHTML = `<span class="task-estimation-sum" title="Suma Szacowana / Rzeczywista" style="color: ${color}; background-color: color-mix(in srgb, ${color} 10%, var(--bg-primary));">
                            ${estimationSum}/${actualSum}
                        </span>`;
                    }

                    // HTML Kolumny
                    // ZMIANA: Usunito style inline (min-width, max-width, flex).
                    // Teraz kolumna u偶ywa styl贸w z CSS (.kanban-column ma flex: 1 0 450px), co zapewnia rozciganie.
                    // Dodano przycisk zwijania (.collapse-column-btn).
                    // Dodano kontenery .kanban-header-counts.
                    // Ustawiono dataset.columnId na 'key', aby listener wiedzia co zwin.

                    const columnHTML = `
                        <div class="kanban-column ${collapsedClass}" data-status="${colData.status}" data-column-id="${key}">
                            <div class="kanban-column-header">
                                <h3>${colData.title}</h3>
                                
                                <button class="collapse-column-btn" title="Zwi/Rozwi kolumn">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5L8.25 12l7.5-7.5" />
                                    </svg>
                                </button>

                                <div class="kanban-header-counts" style="display: flex; gap: 6px; margin-left: auto;">
                                    <span class="task-count" title="Liczba zada w kolumnie">${colData.items.length}</span>
                                    ${estimationSumHTML}
                                </div>
                            </div>
                            <ul class="kanban-tasks">
                                ${cardsHTML}
                            </ul>
                        </div>
                    `;
                    targetElement.insertAdjacentHTML('beforeend', columnHTML);
                });
            };
        function renderKanbanBoard(project, isInteractive) {
            kanbanBoardEl.innerHTML = '';
            
            const tasks = project.tasks || [];
            
            // === ZMIANA: Generowanie Mapy Numeracji WBS (Chronologicznie) ===
            // 1. Tworzymy kopi tablicy, aby nie psu widoku (kt贸ry mo偶e by posortowany wg daty wykonania)
            const tasksForNumbering = [...tasks];

            // 2. Sortujemy kopi od najstarszego do najnowszego (createdAt)
            tasksForNumbering.sort((a, b) => {
                const getTime = (dateObj) => {
                    if (!dateObj) return 0;
                    // Obsuga Firestore Timestamp (ma metod toDate) oraz zwykych string贸w/Date
                    if (typeof dateObj.toDate === 'function') {
                        return dateObj.toDate().getTime();
                    }
                    return new Date(dateObj).getTime();
                };
                return getTime(a.createdAt) - getTime(b.createdAt);
            });

            // 3. Przypisujemy stae numery (1, 2, 3...) na podstawie chronologii
            const taskIndexMap = {};
            tasksForNumbering.forEach((t, i) => {
                taskIndexMap[t.id] = i + 1;
            });
            // === KONIEC ZMIANY ===

            const allPolls = state.polls.filter(poll => poll.projectId === project.id);
            const estimationType = project.estimationType || 'none';
            const unit = (estimationType === 'points') ? 'pkt' : 'g';

            // === POCZTEK NOWEJ LOGIKI: Definiowanie listy kolumn ===
            
            // 1. Zacznij od staej kolumny "Do realizacji"
            const columnsToRender = [
                { id: 'todo', title: STATUSES.todo, status: 'todo', isCustom: false }
            ];

            // 2. Dodaj domyln kolumn "W trakcie"
            columnsToRender.push({ 
                id: 'inprogress_null', // U偶yjemy specjalnego ID dla tej kolumny
                title: STATUSES.inprogress, 
                status: 'inprogress', 
                customColumnId: null, // To jest jej identyfikator
                isCustom: false 
            });

            // 3. Dodaj kolumny u偶ytkownika (jeli istniej)
            if (project.customColumns && project.customColumns.length > 0) {
                // Sortuj na podstawie zapisanego pola 'order'
                const sortedCustomColumns = [...project.customColumns].sort((a, b) => (a.order || 0) - (b.order || 0));
                
                sortedCustomColumns.forEach(col => {
                    columnsToRender.push({
                        id: col.id, // np. "col_wstrzymane_123"
                        title: col.title, // np. "Wstrzymane"
                        status: 'inprogress', // Status bazowy to 'inprogress'
                        customColumnId: col.id, // ID czenia z zadaniem
                        isCustom: true
                    });
                });
            }

            // 4. Zakocz sta kolumn "Wykonane"
            columnsToRender.push({ 
                id: 'done', title: STATUSES.done, status: 'done', isCustom: false 
            });
            
            // KROK 2: NOWA LOGIKA - Warunkowe ustawienie stylu siatki.
            const projectCollapsed = state.ui.collapsedColumns[project.id] || [];

            // <<< USUNITO CAY BLOK 'if (columnsToRender.length <= 3)' >>>
            // <<< PONI呕SZA LINIA 'gridAutoFlow' JEST TERAZ WYKONYWANA ZAWSZE >>>

            // U偶ywamy domylnych styl贸w z CSS.
            // Ustawiamy 'auto-flow', aby aktywowa 'grid-auto-columns: 360px' zdefiniowane w CSS.
            // To zapewnia sta szeroko kolumn i poziome przewijanie.
            kanbanBoardEl.style.gridAutoFlow = 'column';
            // === KONIEC NOWEJ LOGIKI ===
            
            // === KONIEC NOWEJ LOGIKI: Definiowanie listy kolumn ===

            // Iteruj po nowej, dynamicznej licie kolumn
            columnsToRender.forEach(colData => {
                const column = document.createElement('div');
                column.className = 'kanban-column';
                
                // === POCZTEK NOWEGO KODU: Sprawdzenie stanu zwinicia ===
                const projectCollapsed = state.ui.collapsedColumns[project.id] || [];
                // U偶ywamy colData.id (np. "todo", "inprogress_null", "col_123") jako identyfikatora
                if (projectCollapsed.includes(colData.id)) {
                    column.classList.add('collapsed');
                }
                // === KONIEC NOWEGO KODU ===
                
                // === NOWE ATRYBUTY DATA ===
                // `data-status` przechowuje status bazowy (todo, inprogress, done)
                column.dataset.status = colData.status; 
                // `data-column-id` przechowuje ID kolumny niestandardowej (lub "null" dla domylnej "W trakcie")
                column.dataset.columnId = colData.customColumnId !== undefined ? String(colData.customColumnId) : 'null';
                // === KONIEC NOWYCH ATRYBUTW ===

                let tasksInColumn = [];
                let pollsInColumn = [];
                let completedFilterHTML = '';

                if (colData.status === 'todo') {
                    tasksInColumn = tasks.filter(t => t.status === 'todo');
                    if (state.ui.currentProjectFilters.showPolls) {
                        pollsInColumn = allPolls.filter(p => p.status === 'open');
                    }
                } else if (colData.status === 'done') {
                    tasksInColumn = tasks.filter(t => t.status === 'done');
                    if (state.ui.currentProjectFilters.showPolls) {
                        pollsInColumn = allPolls.filter(p => p.status === 'closed');
                    }
                    
                    // Logika filtra "Wykonane" (bez zmian)
                    const filterValue = state.ui.projectCompletedFilters[project.id] || '7days';
                    completedFilterHTML = `
                        <select class="completed-tasks-filter" data-context="project" data-project-id="${project.id}" style="font-size: 11px; padding: 2px; margin-left: 8px; border-radius: 4px; background-color: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border-color);">
                            <option value="7days" ${filterValue === '7days' ? 'selected' : ''}>Ostatnie 7 dni</option>
                            <option value="14days" ${filterValue === '14days' ? 'selected' : ''}>Ostatnie 14 dni</option>
                            <option value="30days" ${filterValue === '30days' ? 'selected' : ''}>Ostatnie 30 dni</option>
                            <option value="all" ${filterValue === 'all' ? 'selected' : ''}>Wszystkie</option>
                        </select>`;
                    if (filterValue !== 'all') {
                        const now = Date.now();
                        const daysToFilter = parseInt(filterValue.replace('days', ''), 10);
                        const cutoffDate = now - (daysToFilter * 24 * 60 * 60 * 1000);
                        tasksInColumn = tasksInColumn.filter(t => 
                            t.completedAt && t.completedAt.toDate().getTime() >= cutoffDate
                        );
                    }

                } else if (colData.status === 'inprogress') {
                    // To jest kolumna "W trakcie" LUB kolumna niestandardowa
                    // Filtrujemy tylko zadania g贸wne, kt贸re pasuj do tej kolumny
                    tasksInColumn = tasks.filter(t => 
                        t.status === 'inprogress' && 
                        t.customColumnId === colData.customColumnId
                    );
                }
                
                // === NOWA LOGIKA RENDEROWANIA: FLATTENING Z SORTOWANIEM ===
                let columnContentHTML = '';
                let totalRenderedTasks = 0;

                // 1. Sonda偶e (zawsze na samej g贸rze)
                if (state.ui.currentProjectFilters.showPolls) {
                    columnContentHTML += pollsInColumn.map(poll => createPollCardHTML(poll)).join('');
                    totalRenderedTasks += pollsInColumn.length;
                }

                // 2. Przygotuj list Podzada Niezale偶nych (Standalone)
                // (To tylko zbieranie danych, jeszcze nie renderujemy)
                const standaloneSubtasks = [];
                tasks.forEach(parentTask => {
                    // Sprawd藕 czy rodzic jest w tej kolumnie
                    const isParentInThisColumn = tasksInColumn.some(t => t.id === parentTask.id);
                    
                    if (parentTask.status === 'done') return; 

                    if (!isParentInThisColumn && parentTask.subtasks && parentTask.subtasks.length > 0) {
                        parentTask.subtasks.forEach(sub => {
                            const subStatus = sub.status || (sub.isCompleted ? 'done' : 'todo');
                            let matches = false;
                            
                            if (colData.isCustom) {
                                matches = (subStatus === 'inprogress' && sub.customColumnId === colData.id);
                            } else if (colData.status === 'inprogress') {
                                matches = (subStatus === 'inprogress' && !sub.customColumnId);
                            } else {
                                matches = (subStatus === colData.status);
                            }

                            if (matches) {
                                standaloneSubtasks.push({ sub: sub, parent: parentTask });
                            }
                        });
                    }
                });

                // 3. SCALANIE: Utw贸rz wsp贸ln tablic wszystkich element贸w
                let combinedItems = [];

                // Dodaj Zadania G贸wne
                tasksInColumn.forEach(task => {
                    combinedItems.push({
                        type: 'main',
                        data: task,
                        // U偶ywamy customOrder. Jeli brak, dajemy bardzo du偶 liczb (na koniec)
                        order: (task.customOrder !== undefined) ? task.customOrder : 999999
                    });
                });

                // Dodaj Podzadania Niezale偶ne
                standaloneSubtasks.forEach(item => {
                    combinedItems.push({
                        type: 'subtask',
                        data: item, 
                        // U偶ywamy customOrder z PODZADANIA
                        order: (item.sub.customOrder !== undefined) ? item.sub.customOrder : 999999
                    });
                });

                // 4. SORTOWANIE: Wedug daty LUB kolejnoci wasnej
                // Pobieramy aktualny tryb sortowania dla tego projektu (domylnie 'asc' lub 'original' w zale偶noci od logiki inicjalizacji)
                // W kodzie przycisku sortowania u偶ywasz 'asc' jako domylnego stanu UI, wic tu te偶 tak przyjmiemy,
                // chyba 偶e wolisz 'original' dla drag&drop. Tu zakadam sp贸jno z przyciskiem.
                const currentSortOrder = state.ui.projectSortOrders[project.id] || 'original';

                combinedItems.sort((a, b) => {
                    // Helper do wycigania daty
                    const getDate = (item) => {
                        let dateVal = null;
                        if (item.type === 'main') {
                            dateVal = item.data.dueDate;
                        } else { // item.type === 'subtask'
                            // W strukturze 'standalone' podzadanie jest w item.data.sub
                            dateVal = item.data.sub.dueDate;
                        }
                        return dateVal ? new Date(dateVal).getTime() : null;
                    };

                    // A. Logika sortowania po dacie (jeli wczona)
                    if (currentSortOrder === 'asc' || currentSortOrder === 'desc') {
                        const timeA = getDate(a);
                        const timeB = getDate(b);

                        // Elementy bez daty wrzucamy na koniec (Infinity dla ASC, -Infinity dla DESC)
                        const valA = timeA !== null ? timeA : (currentSortOrder === 'asc' ? Infinity : -Infinity);
                        const valB = timeB !== null ? timeB : (currentSortOrder === 'asc' ? Infinity : -Infinity);

                        if (valA !== valB) {
                            return currentSortOrder === 'asc' ? valA - valB : valB - valA;
                        }
                    }

                    // B. Fallback: Sortowanie po customOrder (Drag & Drop)
                    // Dziaa gdy tryb to 'original' LUB gdy daty s identyczne
                    return (a.order || 0) - (b.order || 0);
                });

                // 5. GENEROWANIE HTML: Iteruj po posortowanej licie
                columnContentHTML += combinedItems.map(item => {
                    totalRenderedTasks++;

                    if (item.type === 'main') {
                        const task = item.data;
                        const taskNumber = taskIndexMap[task.id];
                        return createTaskCardHTML(task, isInteractive, project, colData.status, colData.customColumnId, taskNumber);
                    } else {
                        // item.type === 'subtask'
                        const { sub, parent } = item.data;
                        const parentNumber = taskIndexMap[parent.id];
                        // Bezpieczne znajdowanie indeksu (mo偶e by -1 w skrajnych przypadkach)
                        const subIndex = (parent.subtasks || []).findIndex(s => s.id === sub.id) + 1;
                        const wbsNumber = parentNumber ? `${parentNumber}.${subIndex}` : '';
                        
                        return createVisualSubtaskCardHTML(sub, parent, project, 'standalone', wbsNumber);
                    }
                }).join('');

                const totalCount = totalRenderedTasks;

                // Logika sumowania wysiku
                let estimationSumHTML = '';
                if (estimationType !== 'none') {
                    let estimationSum = 0;
                    let actualSum = 0;
                    
                    tasksInColumn.forEach(task => {
                        let taskEst = 0;
                        let taskAct = 0;

                        // Sprawd藕, czy zadanie ma podzadania
                        if (task.subtasks && task.subtasks.length > 0) {
                            // WARIANT A: Sumuj z podzada
                            task.subtasks.forEach(sub => {
                                taskEst += parseFloat(sub.effort) || 0;
                                taskAct += parseFloat(sub.actualEffort) || 0;
                            });
                        } else {
                            // WARIANT B: Pobierz z g贸wnego zadania
                            // Obsuga 'estimation' (standard) oraz 'effort' (AI)
                            taskEst = parseFloat(task.estimation ?? task.effort ?? 0);
                            
                            // Rzeczywisty wysiek (jeli brak, przyjmij estymacj jak w reszcie apki)
                            // U偶ywamy task.actualEffort, a jak null/undefined to bierzemy taskEst
                            const rawActual = task.actualEffort !== undefined && task.actualEffort !== null ? task.actualEffort : taskEst;
                            taskAct = parseFloat(rawActual);
                        }

                        estimationSum += taskEst;
                        actualSum += taskAct;
                    });

                    if (estimationSum > 0 || actualSum > 0) {
                        let color = "var(--text-secondary)";
                        if (actualSum > estimationSum) color = "var(--danger-primary)";
                        else if (actualSum > 0 && actualSum < estimationSum) color = "var(--success-primary)";
                        estimationSumHTML = `<span class="task-estimation-sum" title="Suma Szacowana / Rzeczywista" style="color: ${color}; background-color: color-mix(in srgb, ${color} 10%, var(--bg-primary));">
                            ${estimationSum}/${actualSum} ${unit}
                        </span>`;
                    }
                }
                
                // Przycisk dodawania zadania (tylko dla 'todo')
                const addTaskBtnHTML = (isInteractive && colData.status === 'todo') ? `<button class="add-task-icon-btn" title="Dodaj nowe zadanie">+</button>` : '';

                // Z贸偶 kolumn
                column.innerHTML = `
                    <div class="kanban-column-header">
                        <h3>${colData.title}</h3>
                        
                        <button class="collapse-column-btn" title="Zwi/Rozwi kolumn">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5L8.25 12l7.5-7.5" />
                            </svg>
                        </button>
                        ${completedFilterHTML}
                        <div class="kanban-header-counts" style="display: flex; gap: 6px; margin-left: auto;">
                            <span class="task-count" title="Liczba zada w kolumnie">${totalCount}</span>
                            ${estimationSumHTML}
                        </div>
                        ${addTaskBtnHTML}
                    </div>
                    <ul class="kanban-tasks">
                        ${columnContentHTML} 
                    </ul>
                `;
                kanbanBoardEl.appendChild(column);
            });
            // === POCZTEK NOWEGO KODU: Ponowna inicjalizacja Sortable.js ===
            if (window.sortableInstances) {
                window.sortableInstances.forEach(s => s.destroy());
            }
            window.sortableInstances = [];

           if (isInteractive) {
                // POPRAWKA: Zamiana 'targetElement' na 'kanbanBoardEl'
                // Dodajemy te偶 '.subtask-family-container' aby obsu偶y zagnie偶d偶anie w widoku projektu
                const allDropZones = kanbanBoardEl.querySelectorAll('.kanban-tasks, .subtask-family-container');
                
                allDropZones.forEach(list => {
                    const sortable = new Sortable(list, {
                        group: 'kanban-tasks',
                        animation: 150,
                        ghostClass: 'task-card-ghost',
                        chosenClass: 'task-card-chosen',
                        dragClass: 'task-card-drag',
                        
                        // USUNITO FILTR: Pozwala to na sortowanie g贸ra-d贸 samodzielnych podzada
                        // (Zagnie偶d偶one podzadania s bezpieczne, bo s gbiej w strukturze DOM)

                        delay: 200, 
                        delayOnTouchOnly: true, 
                        fallbackOnBody: true,
                        
                        onEnd: async (evt) => {
                            const itemEl = evt.item;
                            const newColumn = evt.to.closest('.kanban-column');
                            const oldColumn = evt.from.closest('.kanban-column');
                            
                            // --- LOGIKA 1: Upuszczenie do RODZICA (Re-nesting) w widoku projektu ---
                            // (Ta sama logika co na Dashboardzie, aby zachowa sp贸jno zachowania)
                            if (evt.to.classList.contains('subtask-family-container')) {
                                const targetParentCard = evt.to.closest('.task-card');
                                const targetParentId = targetParentCard ? targetParentCard.dataset.taskId : null;
                                const movedSubtaskId = itemEl.dataset.subtaskId;

                                if (targetParentId && movedSubtaskId) {
                                     const originalParentId = itemEl.dataset.parentId;
                                     // W widoku projektu nie mo偶na przenosi midzy zadaniami w ten spos贸b
                                     // (chyba 偶e chcesz na to pozwoli, ale tu blokujemy dla bezpieczestwa)
                                     if (targetParentId !== originalParentId) {
                                        // showNotification("Przenoszenie midzy zadaniami jest zablokowane.", "Info");
                                        // render(); 
                                        // return;
                                     }
                                     // Tutaj zazwyczaj nic nie trzeba robi, bo w widoku projektu 
                                     // hierarchia jest sztywna, ale Sortable wymaga obsugi zdarzenia.
                                }
                                return;
                            }
                            
                            // --- LOGIKA 2: Upuszczenie do KOLUMNY ---
                            if (!newColumn) return;

                            // SCENARIUSZ A: Przeniesienie do INNEJ kolumny (Zmiana statusu)
                            if (newColumn !== oldColumn) {
                                const dropEvent = new Event('drop', { bubbles: true, cancelable: true });
                                Object.defineProperty(dropEvent, 'target', { value: newColumn, writable: false });
                                kanbanBoardEl.dispatchEvent(dropEvent);
                            } 
                            // SCENARIUSZ B: Reorganizacja w TEJ SAMEJ kolumnie
                            else {
                                await persistColumnOrder(newColumn);
                            }
                            
                            draggedTaskId = null;
                        }
                    });
                    window.sortableInstances.push(sortable);
                });
            }
            // === KONIEC POPRAWKI ===
        }
       
        /**
         * NOWA FUNKCJA POMOCNICZA
         * Tworzy HTML dla pojedynczego podzadania na licie w karcie Kanban.
         * @param {object} subtask - Obiekt podzadania.
         * @returns {string} - Kod HTML dla elementu <li>.
         */
        function createKanbanSubtaskHTML(subtask) {
            if (!state.currentUser) return ''; // Zabezpieczenie

            const isCompletedByMe = (subtask.completedBy || []).includes(state.currentUser.uid);
            const canIComplete = (subtask.assignees || []).includes(state.currentUser.uid);
            const isCompletedByAll = subtask.isCompleted;

            // === NOWA LOGIKA: Generowanie awatar贸w dla kafelka ===
            const assigneesHTML = (subtask.assignees || [])
                .map(userId => findUser(userId)) // Znajd藕 obiekt u偶ytkownika
                .filter(Boolean) // Usu null/undefined
                .map(user => renderAvatarHTML(user)) // Wygeneruj HTML (u偶yje domylnej klasy .avatar)
                .join('');
            // === KONIEC ===

            return `
                <li class="kanban-subtask-item ${isCompletedByAll ? 'completed' : ''}" data-subtask-id="${subtask.id}">
                    <input type="checkbox" 
                           class="kanban-subtask-checkbox" 
                           data-subtask-id="${subtask.id}"
                           ${isCompletedByMe ? 'checked' : ''}
                           ${!canIComplete ? 'disabled' : ''}
                           title="${canIComplete ? 'Oznacz swoj cz' : 'Nie jeste przypisany/a'}">
                    <span style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${subtask.title}</span>
                    
                    <div class="kanban-subtask-assignees">
                        ${assigneesHTML}
                    </div>
                </li>
            `;
        }
            /**
         * NOWA FUNKCJA POMOCNICZA
         * Tworzy HTML dla ikony dzwonka subskrypcji zadania.
         * @param {object} task - Obiekt zadania.
         * @returns {string} - Kod HTML dla przycisku dzwonka.
         */
        function createSubscriptionBellHTML(task) {
            // Nie pokazuj dzwonka dla zada ju偶 ukoczonych
            if (task.status === 'done') {
                return '';
            }
            
            // Sprawd藕, czy bie偶cy u偶ytkownik subskrybuje
            const isSubscribed = (task.subscribers || []).includes(state.currentUser.uid);
            
            return `
                <button 
                    class="task-subscription-bell ${isSubscribed ? 'subscribed' : ''}" 
                    data-action="toggle-subscription" 
                    data-task-id="${task.id}" 
                    title="${isSubscribed ? 'Anuluj powiadomienie o ukoczeniu' : 'Powiadom mnie o ukoczeniu'}">
                    
                    <svg><use href="#icon-bell"></use></svg>
                </button>
            `;
        }
          /**
         * NOWA FUNKCJA POMOCNICZA
         * Tworzy HTML dla ikony powizania zadania (acucha).
         * @param {object} task - Obiekt zadania.
         * @returns {string} - Kod HTML dla przycisku acucha.
         */
        function createTaskLinkHTML(task) {
            // Nie pokazuj ikony dla zada ju偶 ukoczonych
            if (task.status === 'done') {
                return '';
            }

            // === NOWA LOGIKA: Czytamy obiekt dependency ===
            const dependency = task.dependency; // np. { blockingTaskId: '...', setByUserId: '...' } lub null
            
            if (dependency) {
                // Zadanie JEST powizane
                const { task: blockingTask } = findTask(dependency.blockingTaskId);
                
                // Sprawd藕, czy bie偶cy u偶ytkownik mo偶e usun ten link
                const canUnlink = state.currentUser.uid === dependency.setByUserId;
                
                // Ustaw odpowiedni styl i akcj w zale偶noci od uprawnie
                const actionAttribute = canUnlink ? `data-action="unlink-task"` : '';
                const styleAttribute = canUnlink ? '' : 'style="cursor: not-allowed; opacity: 0.7;"';
                
                if (blockingTask) {
                    // Znaleziono zadanie blokujce
                    if (blockingTask.status === 'done') {
                        // Blokujce zadanie jest ukoczone
                        const title = canUnlink 
                            ? `Zadanie odblokowane (wykonano: '${blockingTask.title}'). Kliknij, aby usun powizanie.`
                            : `Zadanie odblokowane (wykonano: '${blockingTask.title}').`;
                        
                        return `
                            <button 
                                class="task-link-btn linked" 
                                ${actionAttribute} 
                                ${styleAttribute}
                                data-task-id="${task.id}" 
                                title="${title}">
                                <svg><use href="#icon-link"></use></svg>
                            </button>
                        `;
                    } else {
                        // Zadanie blokujce jest AKTYWNE
                        const title = canUnlink 
                            ? `Zablokowane przez: '${blockingTask.title}'. Kliknij, aby usun powizanie.`
                            : `Zablokowane przez: '${blockingTask.title}'.`;
                            
                        return `
                            <button 
                                class="task-link-btn linked" 
                                ${actionAttribute} 
                                ${styleAttribute}
                                data-task-id="${task.id}" 
                                title="${title}">
                                <svg><use href="#icon-link"></use></svg>
                            </button>
                        `;
                    }
                } else {
                    // Powizanie "osierocone" (nie znaleziono zadania blokujcego)
                     const title = canUnlink
                        ? `Bd: Powizane zadanie nie zostao znalezione. Kliknij, aby usun powizanie.`
                        : `Bd: Powizane zadanie nie zostao znalezione.`;

                    return `
                        <button 
                            class="task-link-btn broken" 
                            ${actionAttribute} 
                            ${styleAttribute}
                            data-task-id="${task.id}" 
                            title="${title}">
                            <svg><use href="#icon-link"></use></svg>
                        </button>
                    `;
                }
            } else {
                // Zadanie NIE JEST powizane (ten blok si nie zmienia)
                return `
                    <button 
                        class="task-link-btn" 
                        data-action="link-task" 
                        data-task-id="${task.id}" 
                        title="Utw贸rz powizanie (zale偶no)">
                        <svg><use href="#icon-link"></use></svg>
                    </button>
                `;
            }
        }
      // ZMIANA: Dodano argument 'wbsNumber' na kocu (domylnie pusty string)
        function createVisualSubtaskCardHTML(subtask, parentTask, project, renderMode = 'nested', wbsNumber = '') {
            const currentUserId = state.currentUser.uid;
            
            // --- UPRAWNIENIA ---
            const isProjectOwner = project && project.ownerId === currentUserId;
            const isProjectAdmin = project && (project.admins || []).includes(currentUserId);
            // Definicja SuperUsera
            const isProjectSuperUser = project && (project.superUsers || []).includes(currentUserId);

            const isMainTaskCreator = parentTask.createdBy === currentUserId;
            const isSubtaskCreator = subtask.createdBy === currentUserId;
            const isSubtaskAssignee = (subtask.assignees || []).includes(currentUserId);

            // Dodano isProjectSuperUser do hasAccess
            const hasAccess = isProjectOwner || isProjectAdmin || isProjectSuperUser || isMainTaskCreator || isSubtaskCreator || isSubtaskAssignee;
            const accessTooltip = !hasAccess ? 'title="Brak dostpu do szczeg贸贸w"' : '';

            // U偶ywamy statusu do okrelenia czy zakoczone
            // === POPRAWKA: Rozszerzona definicja ukoczenia (Styl wizualny) ===
            const isCompleted = subtask.status === 'done' || subtask.isCompleted === true;
            
            // === NAPRAWA BDU: Definicja brakujcej zmiennej ===
            const isCompletedByMe = (subtask.completedBy || []).includes(currentUserId);
            // ===================================================

           // Dziedziczenie koloru ta od rodzica
           let customStyle = '';
            if (parentTask.backgroundColor) {
                customStyle = `style="background-color: ${parentTask.backgroundColor};"`;
            }

            // Dodajemy isProjectSuperUser do warunku ukoczenia
            const canIComplete = isSubtaskAssignee || isProjectOwner || isProjectAdmin || isProjectSuperUser;

            // === POPRAWKA: Logika Checkboxa ===
            // Checkbox jest zaznaczony jeli:
            // 1. Cae zadanie jest wykonane (isCompleted) - wtedy wszyscy widz ptaszka
            // 2. LUB Ja wykonaem swoj cz (isCompletedByMe) - wtedy ja widz ptaszka
            const isCheckedAttribute = (isCompleted || isCompletedByMe) ? 'checked' : '';
            
            // === NOWO: Formatowanie tytuu z numerem ===
            const titleDisplay = wbsNumber ? `${wbsNumber}. ${subtask.title}` : subtask.title;
            
            // === NOWE: Klasa Priorytetu ===
            const priorityClass = subtask.priority === 'high' ? 'priority-high' : (subtask.priority === 'low' ? 'priority-low' : '');
            // === KONIEC ===

            // --- GENEROWANIE NAGWKA (ZALE呕NIE OD TRYBU) ---
            let headerHTML = '';
            
            // === ZAKTUALIZOWANA LOGIKA: Ikona Ostrze偶enia w Podzadaniu (Z override) ===
            let warningIconHTML = '';
            if (subtask.dueDate && !isCompleted) {
                // 1. Sprawd藕 czy jest override, jeli nie, we藕 z preferencji, jeli brak, domylnie 3
                let warningDays = 3;
                if (subtask.warningOverride && subtask.warningDays) {
                    warningDays = subtask.warningDays;
                } else if (state.currentUser.preferences.warningDays !== undefined) {
                    warningDays = state.currentUser.preferences.warningDays;
                }
                
                const now = new Date();
                const dueDateObj = new Date(subtask.dueDate);
                const diffTime = dueDateObj.getTime() - now.getTime();
                const diffDays = diffTime / (1000 * 3600 * 24);

                if (diffDays <= warningDays) {
                    warningIconHTML = `<div class="task-warning-icon" style="margin-left: 4px; width: 18px; height: 18px;" title="Termin upywa za mniej ni偶 ${warningDays} dni!">${SVG_WARNING_ICON.replace('width="24"', 'width="18"').replace('height="24"', 'height="18"')}</div>`;
                }
            }
            // === KONIEC ===

            if (renderMode === 'standalone') {
                // TRYB NIEZALE呕NY: Pasek kontekstu + Tytu
                const parentTitleSafe = parentTask.title.length > 30 ? parentTask.title.substring(0, 27) + '...' : parentTask.title;
                
                headerHTML = `
                    <div class="subtask-parent-context" title="Zadanie nadrzdne: ${parentTask.title}">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" style="width:12px;height:12px;">
                           <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <span>${parentTitleSafe}</span>
                    </div>
                    <h5 style="display: flex; align-items: center; flex-wrap: wrap;">
                        <input type="checkbox" 
                           class="subtask-card-checkbox kanban-subtask-checkbox" 
                           data-subtask-id="${subtask.id}"
                           data-parent-id="${parentTask.id}" 
                           ${isCheckedAttribute}
                           ${!canIComplete ? 'disabled' : ''}
                           title="${canIComplete ? 'Zmie status' : 'Brak uprawnie'}">
                        <span style="margin-right: 4px;">${titleDisplay}</span>
                        ${warningIconHTML}
                    </h5>
                `;
            } else {
                // TRYB ZAGNIE呕D呕ONY: Klasyczny ukad
                headerHTML = `
                    <input type="checkbox" 
                           class="subtask-card-checkbox kanban-subtask-checkbox" 
                           data-subtask-id="${subtask.id}"
                           data-parent-id="${parentTask.id}"
                           ${isCheckedAttribute}
                           ${!canIComplete ? 'disabled' : ''}
                           title="${canIComplete ? 'Zmie status' : 'Brak uprawnie'}">
                    <h5 style="display: flex; align-items: center; flex-wrap: wrap;">
                        <span style="margin-right: 4px;">${titleDisplay}</span>
                        ${warningIconHTML}
                    </h5>
                `;
            }

            // --- GENEROWANIE IKON (Bez zmian logicznych, tylko wklejenie) ---
            let budgetIcon = '';
            if (subtask.budgetItems && subtask.budgetItems.length > 0) {
                 const total = subtask.budgetItems.reduce((sum, item) => sum + (parseFloat(item.amount) || 0), 0);
                 const currency = project?.budget?.currency || '';
                 const formatted = total.toLocaleString('pl-PL', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
                 const tooltip = hasAccess ? `title="Bud偶et podzadania: ${formatted} ${currency}"` : `title="Bud偶et (Brak uprawnie)"`;
                 const tabClass = hasAccess ? 'js-open-tab' : '';
                 budgetIcon = `<div class="task-detail task-detail-budget ${tabClass}" data-tab="budget" ${tooltip} style="transform: scale(0.9);">${SVG_BUDGET_ICON}</div>`;
            }

            let attIcon = '';
            if (subtask.attachments && subtask.attachments.length > 0) {
                const tabClass = hasAccess ? 'js-open-tab' : '';
                attIcon = `<div class="task-detail ${tabClass}" data-tab="attachments" title="Zaczniki: ${subtask.attachments.length}"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width:14px;height:14px;"><path stroke-linecap="round" stroke-linejoin="round" d="M18.375 12.739l-7.693 7.693a4.5 4.5 0 01-6.364-6.364l10.94-10.94A3 3 0 1119.5 7.372L8.552 18.32m.009-.01l-.01.01m5.699-9.94l-7.693 7.693a2.25 2.25 0 003.182 3.182l7.693-7.693a.75.75 0 011.06 1.06l-7.693 7.693a4.5 4.5 0 01-6.364-6.364l10.94-10.94A3 3 0 1119.5 7.372L8.552 18.32" /></svg></div>`;
            }

            let commIcon = '';
            if (subtask.comments && subtask.comments.length > 0) {
                const tabClass = hasAccess ? 'js-open-tab' : '';
                commIcon = `<div class="task-detail ${tabClass}" data-tab="comments" title="Komentarze: ${subtask.comments.length}"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width:14px;height:14px;"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12.76c0 1.6 1.123 2.994 2.707 3.227 1.087.16 2.185.283 3.293.369V21l4.076-4.076a1.526 1.526 0 011.037-.443 48.282 48.282 0 005.68-.494c1.584-.233 2.707-1.626 2.707-3.228V6.741c0-1.602-1.123-2.995-2.707-3.228A48.394 48.394 0 0012 3c-2.392 0-4.744.175-7.043.513C3.373 3.746 2.25 5.14 2.25 6.741v6.018z" /></svg></div>`;
            }

            let effortIcon = '';
            if (project && project.estimationType !== 'none' && (subtask.effort > 0 || subtask.actualEffort > 0)) {
                const est = subtask.effort || 0;
                const act = subtask.actualEffort || est; 
                let color = "currentColor";
                if (act > est) color = "var(--danger-primary)"; else if (act < est) color = "var(--success-primary)";
                const tooltip = hasAccess ? `title="Wysiek: ${est}/${act}"` : `title="Wysiek (Brak uprawnie)"`;
                if (!hasAccess) color = "currentColor";
                const tabClass = hasAccess ? 'js-open-tab' : '';
                effortIcon = `<div class="task-detail ${tabClass}" data-tab="effort" ${tooltip}><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="${color}" style="width:14px;height:14px;"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" /></svg></div>`;
            }

            let checklistIcon = '';
            let checklistListHTML = ''; 
            if (subtask.checklist && subtask.checklist.length > 0) {
                const total = subtask.checklist.length;
                const done = subtask.checklist.filter(i => i.isCompleted).length;
                const toggleClass = hasAccess ? 'js-toggle-checklist' : '';
                const tooltip = hasAccess ? `title="Lista kontrolna: ${done}/${total} (Kliknij, aby rozwin)"` : accessTooltip;
                const cursorStyle = hasAccess ? 'cursor: pointer;' : 'cursor: default; opacity: 0.7;';
                checklistIcon = `<div class="task-detail ${toggleClass}" ${tooltip} style="color: var(--accent-primary); ${cursorStyle}"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" style="width:14px;height:14px;"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12c0 1.268-.63 2.39-1.593 3.068a3.745 3.745 0 0 1-1.043 3.296 3.745 3.745 0 0 1-3.296 1.043A3.745 3.745 0 0 1 12 21c-1.268 0-2.39-.63-3.068-1.593a3.746 3.746 0 0 1-3.296-1.043 3.745 3.745 0 0 1-1.043-3.296A3.745 3.745 0 0 1 3 12c0-1.268.63-2.39 1.593-3.068a3.745 3.745 0 0 1 1.043-3.296 3.746 3.746 0 0 1 3.296-1.043A3.746 3.746 0 0 1 12 3c1.268 0 2.39.63 3.068 1.593a3.746 3.746 0 0 1 1.043 3.296 3.746 3.746 0 0 1 3.296-1.043A3.745 3.745 0 0 1 21 12Z" /></svg><span style="font-weight: 600; font-size: 11px; margin-left: 2px;">${done}/${total}</span></div>`;
                if (hasAccess) {
                    const checklistItemsHTML = subtask.checklist.map((item, index) => {
                        let avatarHTML = '';
                        if (item.assigneeId) {
                            const assignee = findUser(item.assigneeId);
                            if (assignee) {
                                avatarHTML = renderAvatarHTML(assignee, 'member-pill-avatar').replace('class="avatar member-pill-avatar"', 'class="avatar" style="width:16px;height:16px;font-size:9px;"');
                            }
                        }

                        // === ZMIANA: Sprawdzanie uprawnie dla elementu listy w PODZADANIU ===
                        // U偶ywamy 'subtask' jako kontekstu zadania
                        const canToggle = hasChecklistPermission(state.currentUser, project, subtask, item);
                        
                        const disabledAttr = canToggle ? '' : 'disabled';
                        const cursorStyle = canToggle ? 'cursor: pointer;' : 'cursor: not-allowed; opacity: 0.6;';
                        const titleAttr = canToggle ? '' : 'title="Brak uprawnie (tylko przypisany, tw贸rca lub admin)"';

                        // Generowanie interaktywnego checkboxa
                        // WA呕NE: U偶ywamy data-parent-id oraz data-subtask-id
                        const checkboxHTML = `<input type="checkbox" 
                            class="kanban-checklist-item-checkbox" 
                            data-parent-id="${parentTask.id}" 
                            data-subtask-id="${subtask.id}" 
                            data-index="${index}"
                            ${item.isCompleted ? 'checked' : ''}
                            ${disabledAttr}
                            ${titleAttr}
                            style="
                                width: 14px; 
                                height: 14px; 
                                ${cursorStyle}
                                flex-shrink: 0; 
                                accent-color: var(--success-primary); 
                                opacity: 1; 
                                pointer-events: auto; 
                                position: relative; 
                                z-index: 10; 
                                margin: 0;
                            ">`;

                        const textStyle = item.isCompleted ? 'text-decoration: line-through; color: var(--text-secondary);' : 'color: var(--text-primary);';
                        
                        return `<li style="display: flex; align-items: center; justify-content: space-between; gap: 8px; padding: 4px 0; border-bottom: 1px solid var(--border-color); font-size: 11px;">
                            <div style="display: flex; align-items: center; gap: 6px; overflow: hidden;">
                                ${checkboxHTML}
                                <span style="${textStyle} white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${item.name}</span>
                            </div>
                            ${avatarHTML}
                        </li>`;
                    }).join('');
                    
                    checklistListHTML = `<div class="kanban-checklist-container collapsed"><ul style="list-style: none; padding: 0; margin: 0;">${checklistItemsHTML}</ul></div>`;
                }
            }

            let multiUserIcon = '';
            let multiStatusListHTML = ''; 
            if ((subtask.assignees && subtask.assignees.length > 1)) {
                const completedCount = (subtask.completedBy || []).length;
                const totalCount = subtask.assignees.length;
                const isAllDone = completedCount === totalCount;
                const toggleClass = hasAccess ? 'js-toggle-multi-status' : '';
                const tooltip = hasAccess ? `title="Postp zespou: ${completedCount}/${totalCount} (Kliknij, aby rozwin)"` : accessTooltip;
                const cursorStyle = hasAccess ? 'cursor: pointer;' : 'cursor: default; opacity: 0.7;';
                multiUserIcon = `<div class="task-detail ${toggleClass}" ${tooltip} style="${cursorStyle}"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="${isAllDone ? 'var(--success-primary)' : 'currentColor'}" style="width:14px;height:14px;"><path stroke-linecap="round" stroke-linejoin="round" d="M17.982 18.725A7.488 7.488 0 0012 15.75a7.488 7.488 0 00-5.982 2.975m11.963 0a9 9 0 10-11.963 0m11.963 0A8.966 8.966 0 0112 21a8.966 8.966 0 01-5.982-2.275M15 9.75a3 3 0 11-6 0 3 3 0 016 0z" /></svg><span style="font-size: 10px; margin-left:2px;">${completedCount}/${totalCount}</span></div>`;
                if (hasAccess) {
                    const listItems = subtask.assignees.map(userId => {
                        const user = findUser(userId);
                        if (!user) return '';
                        const isUserDone = (subtask.completedBy || []).includes(userId);
                        const iconPending = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="14" height="14" style="color: var(--text-secondary); opacity: 0.7;"><circle cx="12" cy="12" r="10" fill="none" stroke="currentColor" stroke-width="2"/><path d="M7 12l3 3 7-7" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>`;
                        const iconDone = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="14" height="14" style="color: var(--success-primary);"><circle cx="12" cy="12" r="10" fill="none" stroke="currentColor" stroke-width="2"/><path d="M7 12l3 3 7-7" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>`;
                        return `<li style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; font-size: 11px;"><div style="display:flex; align-items:center; gap:6px;">${renderAvatarHTML(user, 'member-pill-avatar').replace('style=""', 'style="width:16px;height:16px;font-size:9px;"')} ${user.name}</div>${isUserDone ? iconDone : iconPending}</li>`;
                    }).join('');
                    multiStatusListHTML = `<div class="kanban-multi-status-container collapsed"><ul style="list-style: none; padding: 0; margin: 0;">${listItems}</ul></div>`;
                }
            }
            // === NOWA LOGIKA DZWONKA DLA PODZADANIA ===
            let bellIcon = '';
            // Nie pokazuj dzwonka, jeli podzadanie jest ju偶 wykonane
            if (!isCompleted) {
                const isSubscribed = (subtask.subscribers || []).includes(currentUserId);
                const tooltip = isSubscribed ? 'Anuluj powiadomienie o ukoczeniu podzadania' : 'Powiadom mnie o ukoczeniu podzadania';
                
                // U偶ywamy klasy subtask-subscription-bell
                // ZMIANA: Usunito klas 'task-detail' aby nie dziedziczya niechcianych styli flex
                bellIcon = `
                    <div class="subtask-subscription-bell ${isSubscribed ? 'subscribed' : ''}" 
                         data-action="toggle-subtask-subscription"
                         data-parent-id="${parentTask.id}"
                         data-subtask-id="${subtask.id}"
                         title="${tooltip}">
                        <svg><use href="#icon-bell"></use></svg>
                    </div>
                `;
            }
            // === KONIEC ===
            
            // ZMIANA: Usunito ${bellIcon} z tej listy
            const iconsHTML = `<div class="subtask-visual-icons">${multiUserIcon}${checklistIcon}${effortIcon}${attIcon}${commIcon}${budgetIcon}</div>`;

            // --- STOPKA ---
            let dateHTML = '';
            let dateStartRow = '';
            let dateEndRow = '';
            if (subtask.startDate) {
                const startFull = new Date(subtask.startDate).toLocaleString('pl-PL', {day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit'});
                dateStartRow = `<div class="task-detail" style="margin-bottom: 2px;"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:12px;height:12px;"><path d="M5 3v18" /><path d="M5 4l10 5-10 5" /></svg><span>${startFull}</span></div>`;
            }
            if (subtask.dueDate) {
                 const dueFull = new Date(subtask.dueDate).toLocaleString('pl-PL', {day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit'});
                 const isOverdue = new Date(subtask.dueDate).getTime() < Date.now() && !isCompleted;
                 const dueStyle = isOverdue ? 'color: var(--danger-primary); font-weight: 600;' : 'font-weight: 600;';
                 // ZMIANA: Dodano ${bellIcon} tutaj, obok daty zakoczenia (Deadline)
                 dateEndRow = `<div class="task-detail ${isOverdue ? 'overdue' : ''}" style="align-items: center;"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:12px;height:12px;"><path d="M5 3v18" /><path d="M5 4h9l-2 3 2 3H5" /></svg><span style="${dueStyle}">${dueFull}</span>${bellIcon}</div>`;
            } 
            // ZMIANA: Jeli nie ma DueDate, ale jest dzwonek (rzadkie w podzadaniach, ale mo偶liwe), wywietl go samego
            else if (bellIcon) {
                dateEndRow = `<div class="task-detail" style="align-items: center;">${bellIcon}</div>`;
            }

            if (dateStartRow || dateEndRow) {
                dateHTML = `<div class="subtask-visual-date" style="display: block;">${dateStartRow}${dateEndRow}</div>`;
            }

            const assigneesHTML = (subtask.assignees || []).map(uid => findUser(uid)).filter(Boolean).slice(0, 3).map(user => {
                    return renderAvatarHTML(user, 'avatar').replace('class="avatar"', 'class="avatar" style="width:20px; height:20px; font-size:10px; margin-left:-6px; border:1px solid var(--bg-secondary);"');
                }).join('');
            const avatarsContainer = `<div class="task-assignees" style="margin-left: auto; align-self: flex-end;">${assigneesHTML}</div>`;

            // --- ZO呕ENIE WIDOKU ---
            const cssClass = renderMode === 'standalone' ? 'is-standalone' : 'is-nested';
            
            return `
                <div class="subtask-visual-card ${cssClass} ${priorityClass} ${isCompleted ? 'completed' : ''}" 
                     ${customStyle}
                     draggable="true" 
                     data-subtask-id="${subtask.id}"
                     data-parent-id="${parentTask.id}"
                     data-type="subtask"> 
                    
                    ${headerHTML}
                    ${iconsHTML}
                    
                    <div class="subtask-visual-meta" style="align-items: flex-end; ${renderMode === 'standalone' ? 'padding-left: 0;' : ''}"> 
                        ${dateHTML}
                        ${avatarsContainer}
                    </div>
                    
                    ${multiStatusListHTML}
                    ${checklistListHTML}
                </div>
            `;
        }
            // ZMIANA: Dodano sz贸sty argument: taskNumber (domylnie pusty string)
        function createTaskCardHTML(task, isInteractive, project, targetStatus = null, targetCustomColumnId = undefined, taskNumber = '') {
            // === NOWA LOGIKA: Privacy Guard (Ograniczenie widocznoci) ===
            const currentUserId = state.currentUser.uid;
            // U偶ywamy findProject jeli project nie jest przekazany bezporednio
            const taskProject = project || findProject(task.projectId) || findCompletedProject(task.projectId);
            
            const isOwner = taskProject && taskProject.ownerId === currentUserId;
            const isAdmin = taskProject && (taskProject.admins || []).includes(currentUserId);
            // === ZMIANA: Dodano definicj SuperUsera ===
            const isSuperUser = taskProject && (taskProject.superUsers || []).includes(currentUserId);
            // === KONIEC ZMIANY ===
            const isCreator = task.createdBy === currentUserId;
            const isAssignee = (task.assignees || []).includes(currentUserId);
            
            // === ZMIANA: Dodano isSuperUser do warunku dostpu ===
            const hasAccess = isOwner || isAdmin || isSuperUser || isCreator || isAssignee;
            const accessTooltip = !hasAccess ? 'title="Brak dostpu do szczeg贸贸w"' : '';
            // === KONIEC ===

            const isCompleted = task.status === 'done';
            const priorityClass = task.priority === 'high' ? 'priority-high' : (task.priority === 'low' ? 'priority-low' : '');
            const projectNameHTML = task.projectName ? `<span class="task-project-name">${task.projectName}</span>` : '';
            const parentStatusForFamily = targetStatus || task.status;
            let customStyle = '';
            if (task.backgroundColor) {
                customStyle = `style="background-color: ${task.backgroundColor};"`;
            }
            
            const assignmentClass = ''; 

            let coverImageHTML = '';
            let coverImageClass = '';
            if (task.coverImage && task.coverImage.url) {
                coverImageHTML = `<div class="task-cover-image" style="background-image: url('${task.coverImage.url}')"></div>`;
                coverImageClass = 'has-cover-image'; 
            }

            const canComplete = canUserCompleteTask(state.currentUser.uid, task, taskProject);
            const isOverride = (taskProject && (taskProject.ownerId === state.currentUser.uid || (taskProject.admins || []).includes(state.currentUser.uid)));
            
            const multiTaskDisabled = task.type === 'multi' && (task.status === 'todo' || task.status === 'inprogress') && !isOverride;

            let isDisabled = !isInteractive || multiTaskDisabled;
            let tooltipText = '';

            if (multiTaskDisabled) {
                tooltipText = `title="Jako czonek, musisz poczeka, a偶 wszyscy ukocz swoj cz."`;
            } else if (isInteractive && !canComplete) {
                isDisabled = true;
                tooltipText = `title="Tylko przypisany, admin lub waciciel mo偶e ukoczy to zadanie."`;
            } else if (isInteractive && isOverride && task.type === 'multi') {
                tooltipText = `title="Jako admin/waciciel, ukoczysz to zadanie za wszystkich przypisanych."`;
            }

            const taskAssignees = (task.assignees || [])
                .map(assigneeId => findUser(assigneeId))
                .filter(Boolean);
            
            const displayedAssignees = taskAssignees.slice(0, 4);
            const remainingCount = taskAssignees.length - displayedAssignees.length;

            let assigneesHTML = displayedAssignees
                .map(user => renderAvatarHTML(user))
                .join('');
            
            if (remainingCount > 0) {
                 assigneesHTML += `<div class="avatar" style="width: 24px; height: 24px; font-size: 12px; margin-left: -10px; background-color: var(--bg-tertiary); color: var(--text-secondary); border-color: var(--bg-secondary);" title="+${remainingCount} wicej">+${remainingCount}</div>`;
            }

            let startDateHTML = '';
            let startDateToRender = task.startDate; 

            if (!startDateToRender && task.createdAt && typeof task.createdAt.toDate === 'function') {
                startDateToRender = task.createdAt.toDate().toISOString();
            }

            if (startDateToRender) {
                startDateHTML = `
                    <div class="task-detail">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                          <path d="M5 3v18" />
                          <path d="M5 4l10 5-10 5" />
                        </svg>
                        <span>${new Date(startDateToRender).toLocaleString('pl-PL', {day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit'})}</span>
                    </div>`;
            }

            const isOverdue = task.dueDate && new Date(task.dueDate).getTime() < Date.now() && task.status !== 'done';
            const overdueClass = isOverdue ? 'overdue' : '';
            const bellIconHTML = createSubscriptionBellHTML(task);
            const linkIconHTML = createTaskLinkHTML(task);
            const dueDateHTML = task.dueDate ? `
                    <div class="task-detail ${overdueClass}">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                          <path d="M5 3v18" />
                          <path d="M5 4h9l-2 3 2 3H5" />
                        </svg>
                       <span style="${isOverdue ? 'color: var(--danger-primary); font-weight: 600;' : 'font-weight: 600;'}">${new Date(task.dueDate).toLocaleString('pl-PL', {day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit'})}</span>
                        ${bellIconHTML}
                        ${linkIconHTML}
                    </div>` : '';

            let multiUserIcon = '';
            // === ZMIANA: Pusty string dla multiStatusListHTML jeli brak dostpu ===
            let multiStatusListHTML = '';

            if (task.type === 'multi' && task.assignees && task.assignees.length > 0) {
                const completedCount = (task.completedBy || []).length;
                const totalCount = task.assignees.length;
                const isAllDone = completedCount === totalCount;

                // === PRIVACY GUARD ===
                const toggleClass = hasAccess ? 'js-toggle-multi-status' : '';
                const cursorStyle = hasAccess ? 'cursor: pointer;' : 'cursor: default; opacity: 0.7;';
                const tooltip = hasAccess ? `title="Postp zespou: ${completedCount}/${totalCount} (Kliknij, aby rozwin)"` : accessTooltip;

                multiUserIcon = `
                <div class="task-detail ${toggleClass}" ${tooltip} style="${cursorStyle}">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="${isAllDone ? 'var(--success-primary)' : 'currentColor'}">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15 19.128a9.38 9.38 0 002.625.372 9.337 9.337 0 004.121-.952 4.125 4.125 0 00-7.533-2.493M15 19.128v-.003c0-1.113-.285-2.16-.786-3.07M15 19.128v.106A12.318 12.318 0 018.624 21c-2.331 0-4.512-.645-6.374-1.766l-.001-.109a6.375 6.375 0 0111.964-3.07M12 6.375a3.375 3.375 0 11-6.75 0 3.375 3.375 0 0 16.75 0zm8.25 2.25a2.625 2.625 0 11-5.25 0 2.625 2.625 0 015.25 0z" />
                    </svg>
                    <span style="font-weight: 600; font-size: 11px;">${completedCount}/${totalCount}</span>
                </div>`;

                // Generuj list tylko jeli jest dostp
                if (hasAccess) {
                    const listItems = task.assignees.map(userId => {
                        const user = findUser(userId);
                        if (!user) return '';
                        const isUserDone = (task.completedBy || []).includes(userId);
                        
                        // NOWA IKONA (Statyczne szare k贸ko z ptaszkiem)
                        // U偶ywamy tego samego SVG co iconDone, ale zmieniamy kolor na var(--text-secondary)
                        const iconPending = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" aria-hidden="true" style="margin-left: auto; color: var(--text-secondary); opacity: 0.7;"><circle cx="12" cy="12" r="10" fill="none" stroke="currentColor" stroke-width="2"/><path d="M7 12l3 3 7-7" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>`;
                        
                        const iconDone = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" aria-hidden="true" style="margin-left: auto; color: var(--success-primary);"><circle cx="12" cy="12" r="10" fill="none" stroke="currentColor" stroke-width="2"/><path d="M7 12l3 3 7-7" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>`;

                        return `
                        <li style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; font-size: 11px;">
                            <div style="display:flex; align-items:center; gap:6px;">${renderAvatarHTML(user, 'member-pill-avatar')} ${user.name}</div>
                            ${isUserDone ? iconDone : iconPending}
                        </li>`;
                    }).join('');

                    let actionButton = '';
                    const currentUserId = state.currentUser.uid;
                    if (task.assignees.includes(currentUserId)) {
                        const amIDone = (task.completedBy || []).includes(currentUserId);
                        if (!amIDone) {
                            actionButton = `
                            <button class="btn btn-primary btn-sm js-card-complete-my-part" data-task-id="${task.id}" style="width: 100%; margin-top: 8px; padding: 4px; font-size: 11px;">
                                 Ukocz moj cz
                            </button>`;
                        } else {
                             actionButton = `
                             <div style="margin-top: 8px; font-size: 11px; color: var(--success-primary); text-align: center; font-weight: 600;">
                                Twoja cz ukoczona
                             </div>`;
                        }
                    }

                    multiStatusListHTML = `
                    <div class="kanban-multi-status-container collapsed">
                        <ul style="list-style: none; padding: 0; margin: 0;">${listItems}</ul>
                        ${actionButton}
                    </div>`;
                }
            }

            const recurringIcon = task.recurrence ? `
    <div class="task-detail recurring js-open-tab" data-tab="recurrence" title="Zadanie cykliczne">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M23 4v6h-6M1 20v-6h6 M3.51 9a9 9 0 0 1 14.85-3.14L23 10M1 14l4.64 4.14A9 9 0 0 0 20.49 15" />
        </svg>
    </div>` : '';

            let subtaskIcon = '';
            // === ZMIANA: Pusty string dla subtasksListHTML jeli brak dostpu ===
            let subtasksListHTML = ''; 
            if (task.subtasks && task.subtasks.length > 0) {
                const completedCount = task.subtasks.filter(s => s.isCompleted).length;
                const totalCount = task.subtasks.length;
                const allDone = completedCount === totalCount;
                
                // === PRIVACY GUARD ===
                const toggleClass = hasAccess ? 'js-toggle-subtasks' : '';
                const cursorStyle = hasAccess ? '' : 'cursor: default; opacity: 0.7;';
                const tooltip = hasAccess ? `title="Poka偶/Ukryj podzadania: ${completedCount}/${totalCount}"` : accessTooltip;

                subtaskIcon = `
                <div class="task-detail subtasks ${toggleClass}" ${tooltip} style="${cursorStyle}">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="${allDone ? 'var(--success-primary)' : 'currentColor'}">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
                    </svg>
                    <span>${completedCount}/${totalCount}</span>
                </div>`;
                
                if (hasAccess) {
                    subtasksListHTML = (task.subtasks || [])
                        .map(subtask => createKanbanSubtaskHTML(subtask)) 
                        .join('');
                }
            }
            
            const hasSubtasks = task.subtasks && task.subtasks.length > 0;
            
            let totalBudgetValue = 0;
            if (hasSubtasks) {
                totalBudgetValue = task.subtasks.reduce((acc, sub) => {
                    const subTotal = (sub.budgetItems || []).reduce((sum, item) => sum + (parseFloat(item.amount) || 0), 0);
                    return acc + subTotal;
                }, 0);
            } else {
                totalBudgetValue = (task.budgetItems || []).reduce((sum, item) => sum + (parseFloat(item.amount) || 0), 0);
            }

            let totalEstimated = 0;
            let totalActual = 0;
            
            if (hasSubtasks) {
                task.subtasks.forEach(sub => {
                    totalEstimated += parseFloat(sub.effort) || 0;
                    totalActual += parseFloat(sub.actualEffort) || 0;
                });
            } else {
                totalEstimated = parseFloat(task.estimation) || 0;
                totalActual = task.actualEffort !== undefined ? parseFloat(task.actualEffort) : totalEstimated;
            }

            let budgetIcon = '';
            if (totalBudgetValue > 0) {
                 const { project } = findTask(task.id);
                 const currency = project?.budget?.currency || '';
                 const formattedTotal = totalBudgetValue.toLocaleString('pl-PL', { minimumFractionDigits: 0, maximumFractionDigits: 0 });

                 const tooltip = hasAccess ? `title="Cakowity bud偶et: ${formattedTotal} ${currency}"` : `title="Bud偶et (Brak uprawnie do podgldu kwoty)"`;
                 const style = hasAccess ? 'transform: scale(0.9);' : 'transform: scale(0.9); opacity: 0.7;';
                 
                 // === ZMIANA: Klasa dla klikalnoci ===
                 const tabClass = hasAccess ? 'js-open-tab' : '';

                 budgetIcon = `
                    <div class="task-detail task-detail-budget ${tabClass}" data-tab="taskBudget" ${tooltip} style="${style}">
                         ${SVG_BUDGET_ICON}
                    </div>
                 `;
            }

            let effortIcon = '';
            const effortProject = project || findProject(task.projectId);
            const estimationType = effortProject ? effortProject.estimationType : 'none';

            if (estimationType !== 'none') {
                if (totalEstimated > 0 || totalActual > 0) {
                    const unit = (estimationType === 'points') ? 'pkt' : 'g';
                    let color = "currentColor"; 
                    if (totalActual > totalEstimated) {
                        color = "var(--danger-primary)"; 
                    } else if (totalActual > 0 && totalActual < totalEstimated) {
                        color = "var(--success-primary)"; 
                    }

                    const displayValue = hasAccess ? `${totalEstimated}/${totalActual}${unit}` : `-/-`;
                    const tooltip = hasAccess ? `title="Szacowany / Rzeczywisty Wysiek"` : accessTooltip;

                    // === ZMIANA: Klasa dla klikalnoci ===
                    const tabClass = hasAccess ? 'js-open-tab' : '';

                    effortIcon = `
                    <div class="task-detail ${tabClass}" data-tab="effort" ${tooltip}>
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="${color}">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
                        </svg>
                        <span style="color: ${color}; font-weight: 500;">${displayValue}</span>
                    </div>`;
                }
            }

            let checklistIcon = '';
            // === ZMIANA: Pusty string dla checklistListHTML jeli brak dostpu ===
            let checklistListHTML = '';
            
            if (task.checklist && task.checklist.length > 0) {
                const total = task.checklist.length;
                const done = task.checklist.filter(i => i.isCompleted).length;
                
                // === PRIVACY GUARD ===
                const toggleClass = hasAccess ? 'js-toggle-checklist' : '';
                const style = hasAccess ? 'color: var(--accent-primary);' : 'color: var(--text-secondary); opacity: 0.7;';
                const tooltip = hasAccess ? `title="Lista kontrolna: ${done}/${total} (Kliknij, aby rozwin)"` : accessTooltip;

                checklistIcon = `
                <div class="task-detail ${toggleClass}" ${tooltip} style="${style}">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" style="width:14px;height:14px;">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12c0 1.268-.63 2.39-1.593 3.068a3.745 3.745 0 0 1-1.043 3.296 3.745 3.745 0 0 1-3.296 1.043A3.745 3.745 0 0 1 12 21c-1.268 0-2.39-.63-3.068-1.593a3.746 3.746 0 0 1-3.296-1.043 3.746 3.746 0 0 1-1.043-3.296A3.745 3.745 0 0 1 3 12c0-1.268.63-2.39 1.593-3.068a3.745 3.745 0 0 1 1.043-3.296 3.746 3.746 0 0 1 3.296-1.043A3.746 3.746 0 0 1 12 3c1.268 0 2.39.63 3.068 1.593a3.746 3.746 0 0 1 1.043 3.296 3.746 3.746 0 0 1 1.043 3.296A3.745 3.745 0 0 1 21 12Z" />
                    </svg>
                    <span style="font-weight: 600; font-size: 11px;">${done}/${total}</span>
                </div>`;

                if (hasAccess) {
                    // === ZMIANA: Dodano index do mapowania ===
                    const checklistItemsHTML = subtask.checklist.map((item, index) => {
    let avatarHTML = '';
    if (item.assigneeId) {
        const assignee = findUser(item.assigneeId);
        if (assignee) {
            avatarHTML = renderAvatarHTML(assignee, 'member-pill-avatar').replace('class="avatar member-pill-avatar"', 'class="avatar" style="width:16px;height:16px;font-size:9px;"');
        }
    }

    // === ZMIANA: Sprawdzamy uprawnienia (przekazujemy subtask jako zadanie) ===
    const canToggle = hasChecklistPermission(state.currentUser, project, subtask, item);
    const disabledAttr = canToggle ? '' : 'disabled';
    const cursorStyle = canToggle ? 'cursor: pointer;' : 'cursor: not-allowed; opacity: 0.6;';

    const checkboxHTML = `<input type="checkbox" 
        class="kanban-checklist-item-checkbox" 
        data-parent-id="${parentTask.id}" 
        data-subtask-id="${subtask.id}"
        data-index="${index}"
        ${item.isCompleted ? 'checked' : ''}
        ${disabledAttr}
        title="${canToggle ? '' : 'Brak uprawnie'}"
        style="
            width: 14px; 
            height: 14px; 
            ${cursorStyle}
            flex-shrink: 0; 
            accent-color: var(--success-primary);
            opacity: 1;
            pointer-events: auto;
            position: relative;
            z-index: 10;
            margin: 0;
        ">`;

    const textStyle = item.isCompleted ? 'text-decoration: line-through; color: var(--text-secondary);' : 'color: var(--text-primary);';
    
    return `<li style="display: flex; align-items: center; justify-content: space-between; gap: 8px; padding: 4px 0; border-bottom: 1px solid var(--border-color); font-size: 11px;">
        <div style="display: flex; align-items: center; gap: 6px; overflow: hidden;">
            ${checkboxHTML}
            <span style="${textStyle} white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${item.name}</span>
        </div>
        ${avatarHTML}
    </li>`;
}).join('');
                    // === KONIEC ZMIANY ===

                    checklistListHTML = `
                    <div class="kanban-checklist-container collapsed">
                        <ul style="list-style: none; padding: 0; margin: 0;">${checklistItemsHTML}</ul>
                    </div>`;
                }
            }

            let commentIcon = '';
            if (task.comments && task.comments.length > 0) {
                const count = task.comments.length;
                const displayCount = count > 99 ? '99+' : count;
                
                // === ZMIANA: Klasa dla klikalnoci ===
                commentIcon = `
                <div class="task-detail js-open-tab" data-tab="comments" title="Komentarze: ${count}">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12.76c0 1.6 1.123 2.994 2.707 3.227 1.087.16 2.185.283 3.293.369V21l4.076-4.076a1.526 1.526 0 011.037-.443 48.282 48.282 0 005.68-.494c1.584-.233 2.707-1.626 2.707-3.228V6.741c0-1.602-1.123-2.995-2.707-3.228A48.394 48.394 0 0012 3c-2.392 0-4.744.175-7.043.513C3.373 3.746 2.25 5.14 2.25 6.741v6.018z" />
                    </svg>
                    <span>${displayCount}</span>
                </div>`;
            }

            
            let attachmentIcon = '';
            if (task.attachments && task.attachments.length > 0) {
                const attCount = task.attachments.length;
                const displayAttCount = attCount > 99 ? '99+' : attCount;

                // === ZMIANA: Klasa dla klikalnoci ===
                attachmentIcon = `
                <div class="task-detail js-open-tab" data-tab="attachments" title="Zaczniki: ${attCount}">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M18.375 12.739l-7.693 7.693a4.5 4.5 0 01-6.364-6.364l10.94-10.94A3 3 0 1119.5 7.372L8.552 18.32m.009-.01l-.01.01m5.699-9.94l-7.693 7.693a2.25 2.25 0 003.182 3.182l7.693-7.693a.75.75 0 011.06 1.06l-7.693 7.693a4.5 4.5 0 01-6.364-6.364l10.94-10.94A3 3 0 1119.5 7.372L8.552 18.32" />
                    </svg>
                    <span>${displayAttCount}</span>
                </div>`;
            }

            // POPRAWKA: Usunito 'multiStatusIcon', u偶ywamy 'multiUserIcon'
            const finalMultiIcon = multiUserIcon; 
            const allIcons = `${finalMultiIcon}${subtaskIcon}${checklistIcon}${recurringIcon}${effortIcon}${attachmentIcon}${commentIcon}${budgetIcon}`;
            const iconsHTML = allIcons ? `<div class="task-card-icons">${allIcons}</div>` : '';

            // === NOWO: Formatowanie tytuu z numerem WBS ===
            const titleDisplay = taskNumber ? `${taskNumber}. ${task.title}` : task.title;
            // === ZAKTUALIZOWANA LOGIKA: Ikona Ostrze偶enia o Terminie (Z override) ===
            let warningIconHTML = '';
            if (task.dueDate && !isCompleted) {
                // 1. Sprawd藕 czy jest override, jeli nie, we藕 z preferencji, jeli brak, domylnie 3
                let warningDays = 3;
                if (task.warningOverride && task.warningDays) {
                    warningDays = task.warningDays;
                } else if (state.currentUser.preferences.warningDays !== undefined) {
                    warningDays = state.currentUser.preferences.warningDays;
                }

                const now = new Date();
                const dueDateObj = new Date(task.dueDate);
                
                const diffTime = dueDateObj.getTime() - now.getTime();
                const diffDays = diffTime / (1000 * 3600 * 24); 

                if (diffDays <= warningDays) {
                    warningIconHTML = `<div class="task-warning-icon" title="Termin upywa za mniej ni偶 ${warningDays} dni!">${SVG_WARNING_ICON}</div>`;
                }
            }
            // === KONIEC ZAKTUALIZOWANEJ LOGIKI ===
            return `<li class="task-card ${isCompleted ? 'completed' : ''}" ${isInteractive ? 'draggable="true"' : ''} data-task-id="${task.id}" data-creator-id="${task.createdBy || ''}">
                
                <div class="task-card-main-content ${priorityClass} ${assignmentClass} ${coverImageClass}" ${customStyle}>
                    ${coverImageHTML}
                    <input type="checkbox" class="task-card-checkbox" data-task-id="${task.id}" ${isCompleted ? 'checked' : ''} ${isDisabled ? 'disabled' : ''} ${tooltipText}>
                    ${projectNameHTML}
                    <div style="display: flex; align-items: center; margin-bottom: 4px;">
                        <h4 title="${task.title}" style="margin-bottom: 0;">${titleDisplay}</h4>
                        ${warningIconHTML}
                    </div>
                    ${iconsHTML}
                    
                    <div class="task-meta">
                        <div class="task-details">${startDateHTML}${dueDateHTML}</div>
                        <div class="task-assignees">${assigneesHTML}</div>
                    </div>

                     ${multiStatusListHTML} 
                </div>
                
                <div class="kanban-subtask-list-container collapsed" style="display: none;">
                    <ul class="kanban-subtask-list">${subtasksListHTML}</ul>
                </div>
                
                ${checklistListHTML}
                
                ${
                    (task.subtasks && task.subtasks.length > 0 && hasAccess) 
                    ? `<div class="subtask-family-container ${state.ui.expandSubtasksByDefault ? '' : 'collapsed'}">
                        ${task.subtasks
                            // KROK A: Najpierw przypisz oryginalny indeks ka偶demu podzadaniu
                            .map((sub, index) => ({ sub, index: index + 1 })) 
                            
                            // KROK B: Filtruj widoczno
                            .filter(({ sub }) => {
                                // Ustal status podzadania
                                const subStatus = sub.status || (sub.isCompleted ? 'done' : 'todo');
                                const subColId = sub.customColumnId || null;
                                
                                // === ZASADA ROZBIE呕NOCI (WIDOK W RODZICU) ===
                                if (state.ui.currentView === 'my-dashboard') {
                                    // Na Dashboardzie: Poka偶 wewntrz rodzica TYLKO jeli pasuj do siebie.
                                    // Jeli s r贸偶ne (rozbie偶ne), to podzadanie jest wywietlane jako osobna karta w innej kolumnie.
                                    const parentStatus = task.status;
                                    const parentColId = task.customColumnId || null;
                                    
                                    if (subStatus !== parentStatus || subColId !== parentColId) {
                                        return false; // Ukryj (jest gdzie indziej na tablicy)
                                    }
                                    return true; // Poka偶 (siedzi grzecznie w rodzicu)
                                }

                                // Logika dla Widoku Projektu (bez zmian)
                                if (task.status === 'done') return true;
                                if (subStatus !== parentStatusForFamily) return false;

                                if (subStatus === 'inprogress' && targetCustomColumnId !== undefined) {
                                     const targetColId = targetCustomColumnId || null; 
                                     if (subColId !== targetColId) return false;
                                }
                                return true;
                            })
                            
                            // KROK C: Renderuj, przekazujc obliczony numer WBS
                            .map(({ sub, index }) => {
                                // Jeli zadanie g贸wne ma numer, stw贸rz "1.1", "1.2". Jeli nie, pusty string.
                                const wbsNumber = taskNumber ? `${taskNumber}.${index}` : '';
                                return createVisualSubtaskCardHTML(sub, task, taskProject, 'nested', wbsNumber);
                            }).join('')}
                       </div>`
                    : ''
                }
                </li>`;
        }
       // === NOWE FUNKCJE CZATU PROJEKTU ===

        /**
         * Renderuje list wiadomoci w panelu czatu.
         * @param {Array<object>} messages - Tablica obiekt贸w wiadomoci z Firestore.
         */
        function renderChatMessages(messages) {
            if (!chatMessagesList) return;
            
            // CSS dba o odwr贸cenie kolejnoci, wic po prostu renderujemy
            chatMessagesList.innerHTML = messages.map(msg => {
                const isMe = msg.senderId === state.currentUser.uid;
                const sender = isMe ? 'Ja' : msg.senderName;
                const time = new Date(msg.timestamp).toLocaleTimeString('pl-PL', { hour: '2-digit', minute: '2-digit' });

                // U偶ywamy funkcji renderAvatarHTML do wywietlenia awatara lub inicja贸w
                const avatarHTML = isMe ? '' : renderAvatarHTML({ 
                    name: msg.senderName, 
                    photoURL: msg.senderAvatar 
                }, 'avatar-comment'); // U偶ywamy maej klasy awatara

                return `
                    <div class="chat-message-item ${isMe ? 'is-me' : 'is-other'}">
                        <div class="message-header">
                            <span class="message-sender">${sender}</span>
                            <span class="message-time">${time}</span>
                        </div>
                        <div class="message-content-wrapper">
                            ${avatarHTML}
                            <div class="message-bubble">
                                <p>${msg.text.replace(/\n/g, '<br>')}</p>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Auto-scroll (dziaa dziki flex-direction: column-reverse w CSS)
             chatMessagesList.scrollTop = 0;
        }

        /**
         * Uruchamia listener Firestore dla wiadomoci czatu dla danego projektu.
         * @param {string} projectId - ID projektu, dla kt贸rego nasuchujemy.
         */
        function setupChatListener(projectId) {
            // Zatrzymaj poprzedni listener, jeli istnieje
            if (state.ui.unsubscribeChatMessages) {
                state.ui.unsubscribeChatMessages();
                state.ui.unsubscribeChatMessages = null;
            }

            if (!projectId) {
                console.log("Chat Listener: Brak ID projektu, czyszczenie.");
                renderChatMessages([]); // Wyczy okno czatu
                updateChatBadge(0); // Upewnij si, 偶e badge jest wyczyszczony
                return;
            }

            console.log(`Uruchamianie listenera czatu dla projektu: ${projectId}`);
            
            // Definicja kolekcji: /projectChats/{projectId}/messages
            const chatCollectionRef = collection(db, `artifacts/${appId}/public/data/projectChats/${projectId}/messages`);
            
            // Zapytanie o ostatnie 50 wiadomoci, posortowane rosnco wg czasu
            // (flex-direction: column-reverse w CSS zajmie si reszt)
            // ZMIANA: Sortujemy 'desc' i pobieramy 50, a nastpnie odwracamy w JS dla 'column-reverse'
            const q = query(chatCollectionRef, orderBy("timestamp", "desc"), limit(50));

            state.ui.unsubscribeChatMessages = onSnapshot(q, (snapshot) => {
                // Odwracamy tablic, aby najnowsze byy na dole (dla column-reverse)
                const messages = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).reverse();
                
                // 1. Zawsze renderuj wiadomoci w (potencjalnie ukrytym) panelu
                renderChatMessages(messages);

                // 2. Pobierz czas ostatniego odczytu dla tego czatu
                // U偶ywamy state.currentUser, kt贸ry jest aktualizowany przez wasny listener
                const lastViewed = (state.currentUser.chatLastViewed && state.currentUser.chatLastViewed[projectId]) 
                                   ? state.currentUser.chatLastViewed[projectId] 
                                   : 0;

                // 3. Policz nieprzeczytane wiadomoci (nowsze ni偶 'lastViewed' i nie moje)
                const unreadCount = messages.filter(m => 
                    m.timestamp > lastViewed && 
                    m.senderId !== state.currentUser.uid // Nie licz moich wasnych wiadomoci
                ).length;

                // 4. Zaktualizuj UI (badge i kolor ikony)
                updateChatBadge(unreadCount);

            }, (error) => {
                console.error(`Bd listenera czatu dla projektu ${projectId}:`, error);
                renderChatMessages([]); // Wyczy w razie bdu
                updateChatBadge(0); // Wyczy badge w razie bdu
            });
        }
        // === KONIEC NOWYCH FUNKCJI CZATU ===
       /**
         * Tworzy HTML dla kafelka sonda偶u.
         * @param {object} poll - Obiekt sonda偶u z Firestore.
         * @returns {string} - Kod HTML dla kafelka.
         */
        function createPollCardHTML(poll) {
            
            // --- 1. Obliczenia Gos贸w i Frekwencji ---
            let totalVotes = 0; // czna liczba oddanych gos贸w
            let votedUserIds = new Set(); // Przechowuje unikalne ID os贸b, kt贸re zagosoway
            
            // ZMIANA: Ustawiamy votes na 0. Dziki temu opcja z 0 gos贸w nie nadpisze tekstu "Brak gos贸w".
            let leadingOption = { text: 'Brak gos贸w', votes: 0 };

            (poll.options || []).forEach(opt => {
                const voteCount = (opt.votes || []).length;
                totalVotes += voteCount;
                
                // Dodaj ID gosujcych do Setu (automatycznie obsuguje duplikaty)
                (opt.votes || []).forEach(userId => votedUserIds.add(userId));

                // Sprawd藕, czy ta opcja prowadzi
                // Warunek (voteCount > 0) jest teraz domniemany, bo votes startuje od 0
                if (voteCount > leadingOption.votes) {
                    leadingOption = { text: opt.text, votes: voteCount };
                } else if (voteCount === leadingOption.votes && voteCount > 0) {
                    // Obsuga remisu - dziaa tylko jeli jest wicej ni偶 0 gos贸w
                    leadingOption.text += ', ... (Remis)';
                }
            });

            // Oblicz frekwencj
            const totalAssignees = (poll.assignees || []).length;
            const votedCount = votedUserIds.size; // Liczba unikalnych os贸b, kt贸re zagosoway
            const attendancePercentage = totalAssignees > 0 ? (votedCount / totalAssignees) * 100 : 0;

            // --- 2. Renderowanie HTML (avatary i termin - bez zmian) ---
            const assigneesHTML = (poll.assignees || [])
                .map(assigneeId => findUser(assigneeId))
                .filter(Boolean)
                .map(user => renderAvatarHTML(user, 'avatar')) 
                .join('');

            const isOverdue = poll.deadline && new Date(poll.deadline).getTime() < Date.now() && poll.status === 'open';
            const deadlineHTML = poll.deadline ? `
                <div class="poll-detail ${isOverdue ? 'overdue' : ''}">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75m-18 0h18" /></svg>
                    <span style="${isOverdue ? 'color: var(--danger-primary); font-weight: 600;' : ''}">${new Date(poll.deadline).toLocaleString('pl-PL', {day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit'})}</span>
                </div>` : '';

            // --- 3. Nowy HTML dla paska postpu frekwencji i lidera ---
            const progressHTML = `
                <div class="poll-option-result" style="margin-bottom: 8px;">
                    <div class="poll-result-text" style="margin-bottom: 2px;">
                        <span>Frekwencja</span>
                        <span class="poll-vote-count">${votedCount} / ${totalAssignees}</span>
                    </div>
                    <div class="progress-bar-container" title="Zagosowao ${votedCount} z ${totalAssignees} uczestnik贸w">
                        <div class="poll-result-bar-fill" style="width: ${attendancePercentage.toFixed(1)}%;"></div>
                    </div>
                </div>
            `;
            
            // Tutaj wywietli si "Brak gos贸w" lub nazwa lidera
            const leadingOptionHTML = `
                <div class="poll-detail" style="font-size: 13px; margin-bottom: 12px; justify-content: center; padding: 4px; background-color: var(--bg-primary); border-radius: var(--border-radius);">
                    <strong>Prowadzi:</strong>
                    <span style="color: var(--accent-primary); font-weight: 600; margin-left: 4px;">${leadingOption.text}</span>
                </div>
            `;

            // --- 3b. NOWA LOGIKA: Pobieranie waciciela ---
            const owner = findUser(poll.createdBy);
            // U偶ywamy teraz klasy zdefiniowanej w CSS (.poll-card-header .avatar), a nie 'poll-owner-avatar'
            const ownerAvatarHTML = owner 
                ? renderAvatarHTML(owner, 'avatar') 
                : '<div class="avatar" style="background-color: var(--bg-tertiary);">?</div>';
            
            // Tworzymy nowy blok HTML dla nag贸wka
            const ownerInfoHTML = `
                <div class="poll-card-header">
                    <span class="poll-label">Sonda偶</span>
                    <span class="poll-owner-text">waciciel:</span>
                    ${ownerAvatarHTML}
                </div>
            `;

            // --- 4. Skadanie finalnego HTML (bez .poll-options) ---
            return `
            <li class="poll-card" data-poll-id="${poll.id}">
                ${ownerInfoHTML} <div class="poll-card-icon" title="Sonda偶">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                </div>
                <h4 title="${poll.title}">${poll.title}</h4>
                
                ${progressHTML}
                ${leadingOptionHTML}

                <div class="poll-meta">
                    <div class="poll-details">${deadlineHTML}</div>
                    <div class="poll-assignees">${assigneesHTML}</div>
                </div>
            </li>
            `;
        }
        
        function openModal(modal) {
            modal.classList.add('visible');
            render();
        }

        function closeModal(modal) {
            modal.classList.remove('visible');
            render();
        }

        function showNotification(message, title = 'Powiadomienie') {
            notificationModal.title.textContent = title;
            notificationModal.message.textContent = message;
            openModal(notificationModal.overlay);
        }
        /**
             * Ustawia widoczno i zawarto zakadki "Wysiek" na podstawie ustawie projektu.
             * @param {object} project - Obiekt projektu (nadrzdny dla zadania)
             * @param {object} task - Obiekt zadania (do wczytania wartoci)
             * @param {object} modalRefs - Referencje do element贸w DOM modala (taskModal lub newTaskModal)
             */
            const setupEffortTab = (project, task, modalRefs) => {
                const estimationType = project.estimationType || 'none';
                const taskEstimation = (task && task.estimation !== undefined) ? task.estimation : '';

                if (estimationType === 'none') {
                    // Projekt nie u偶ywa szacowania - ukryj zakadk
                    if (modalRefs.effortTabButton) modalRefs.effortTabButton.style.display = 'none';
                    // Wyczy warto na wszelki wypadek (cho pole bdzie ukryte)
                    if (modalRefs.effortInput) modalRefs.effortInput.value = '';
                } else {
                    // Projekt u偶ywa szacowania - poka偶 zakadk
                    if (modalRefs.effortTabButton) modalRefs.effortTabButton.style.display = 'flex';
                    
                    // Ustaw etykiety i warto na podstawie typu
                    if (estimationType === 'points') {
                        if (modalRefs.effortLabel) modalRefs.effortLabel.textContent = 'Story Points';
                        if (modalRefs.effortUnit) modalRefs.effortUnit.textContent = 'Szacowana liczba punkt贸w (np. 5, 8, 13).';
                        if (modalRefs.effortInput) modalRefs.effortInput.placeholder = '0';
                        
                        // === POCZTEK NOWEGO KODU ===
                        if (modalRefs.actualEffortLabel) modalRefs.actualEffortLabel.textContent = 'Rzeczywiste Story Points';
                        if (modalRefs.actualEffortUnit) modalRefs.actualEffortUnit.textContent = 'Rzeczywista (zarejestrowana) liczba punkt贸w.';
                        if (modalRefs.actualEffortInput) modalRefs.actualEffortInput.placeholder = '0';
                        // === KONIEC NOWEGO KODU ===
                        
                    } else if (estimationType === 'hours') {
                        if (modalRefs.effortLabel) modalRefs.effortLabel.textContent = 'Szacowane godziny';
                        if (modalRefs.effortUnit) modalRefs.effortUnit.textContent = 'Szacowana liczba godzin pracy (np. 8).';
                        if (modalRefs.effortInput) modalRefs.effortInput.placeholder = '0';
                        
                        // === POCZTEK NOWEGO KODU ===
                        if (modalRefs.actualEffortLabel) modalRefs.actualEffortLabel.textContent = 'Rzeczywiste godziny';
                        if (modalRefs.actualEffortUnit) modalRefs.actualEffortUnit.textContent = 'Rzeczywista (zarejestrowana) liczba godzin.';
                        if (modalRefs.actualEffortInput) modalRefs.actualEffortInput.placeholder = '0';
                        // === KONIEC NOWEGO KODU ===
                    }
                    
                    // Wypenij input zapisan wartoci
                    if (modalRefs.effortInput) modalRefs.effortInput.value = taskEstimation;
                }
            };
       // === NOWE FUNKCJE: OBSUGA KOLORW KAFELKW ===
        /**
         * Otwiera modal wyboru koloru ta.
         */
        function openBackgroundColorModal(contextTaskId) {
            let currentColor = 'default';

            // Sprawd藕 kontekst (Nowe Zadanie czy Edycja)
            if (contextTaskId === 'new-task') {
                currentColor = newTaskTempColor || 'default';
            } else {
                const { task } = findTask(contextTaskId);
                if (task && task.backgroundColor) {
                    // Znajd藕 ID koloru na podstawie wartoci hex/var
                    const colorObj = TASK_COLORS.find(c => c.value === task.backgroundColor);
                    currentColor = colorObj ? colorObj.id : 'default';
                }
            }

            backgroundColorModal.overlay.dataset.contextTaskId = contextTaskId;
            backgroundColorModal.grid.innerHTML = '';

            TASK_COLORS.forEach(color => {
                const isSelected = color.id === currentColor;
                const div = document.createElement('div');
                div.className = `color-swatch-item ${isSelected ? 'selected' : ''}`;
                div.onclick = () => handleColorSelect(color);
                
                div.innerHTML = `
                    <div class="color-preview-circle" style="background-color: ${color.value};"></div>
                    <span style="font-size: 13px;">${color.name}</span>
                `;
                backgroundColorModal.grid.appendChild(div);
            });

            openModal(backgroundColorModal.overlay);
        }

        /**
         * Obsuguje wyb贸r koloru z siatki.
         */
        async function handleColorSelect(colorObj) {
            const contextTaskId = backgroundColorModal.overlay.dataset.contextTaskId;
            const isNewTask = contextTaskId === 'new-task';
            const colorValue = colorObj.id === 'default' ? null : colorObj.value; // Null dla domylnego

            if (isNewTask) {
                // Zapisz do zmiennej tymczasowej
                newTaskTempColor = colorValue === null ? null : colorObj.id; // Przechowujemy ID dla uatwienia
                
                // Zaktualizuj tekst przycisku
                updateColorButtonState(newTaskModal.openBackgroundColorBtn, colorValue);
                
                closeModal(backgroundColorModal.overlay);
            } else {
                // Edycja istniejcego zadania - zapisz bezporednio do bazy
                const { task, project } = findTask(contextTaskId);
                if (task && project) {
                    try {
                        const updatedTasks = project.tasks.map(t => 
                            t.id === contextTaskId ? { ...t, backgroundColor: colorValue } : t
                        );
                        
                        const projectDocRef = findProject(project.id) 
                            ? doc(projectsRef, project.id) 
                            : doc(completedProjectsRef, project.id);
                            
                        await updateDoc(projectDocRef, { tasks: updatedTasks });
                        
                        // Zaktualizuj przycisk w otwartym modalu
                        updateColorButtonState(taskModalBackgroundColorBtn, colorValue);
                        
                        closeModal(backgroundColorModal.overlay);
                        // Render odwie偶y to kafelka na kanbanie (dziki onSnapshot)
                    } catch (error) {
                        console.error("Bd zapisu koloru:", error);
                        showNotification("Nie udao si zapisa koloru.", "Bd");
                    }
                }
            }
        }

        /**
         * Pomocnicza funkcja do aktualizacji wygldu przycisku (To / Usu to).
         */
        function updateColorButtonState(button, hasColor) {
            if (!button) return;
            
            if (hasColor) {
                button.textContent = "Usu to";
                button.classList.add('is-danger-btn'); 
                button.onclick = (e) => {
                    e.stopPropagation();
                    // Logika usuwania ta (wywoanie handleColorSelect z domylnym)
                    handleColorSelect(TASK_COLORS[0]); 
                };
            } else {
                button.textContent = "To kafelka";
                button.classList.remove('is-danger-btn');
                button.onclick = () => {
                    const context = button.id.includes('new-task') ? 'new-task' : taskModal.overlay.dataset.taskId;
                    openBackgroundColorModal(context);
                };
            }
        }
                // Zmienna flagujca czy dokonano zmian w formularzu zadania
let isTaskFormDirty = false;

/**
 * Funkcja resetujca stan przycisk贸w w stopce modala zadania.
 * Przywraca przycisk "OK" i ukrywa "Zapisz zmiany".
 */
function resetTaskModalButtons() {
    isTaskFormDirty = false;
    if (taskModal.okBtn) taskModal.okBtn.style.display = 'block';
    
    if (taskModal.saveBtn) {
        taskModal.saveBtn.style.display = 'none';
        // === NAPRAWA: Resetowanie stanu przycisku zapisu ===
        taskModal.saveBtn.disabled = false;          // Zdejmij blokad
        taskModal.saveBtn.textContent = 'Zapisz zmiany'; // Przywr贸 oryginalny tekst
        // === KONIEC NAPRAWY ===
    }
}

/**
 * Funkcja uruchamiana przy wykryciu zmiany w formularzu.
 * Ukrywa "OK" i pokazuje "Zapisz zmiany".
 */
function handleTaskFormChange(e) {
    // Ignoruj zmiany w:
    // 1. Komentarzach (maj wasny przycisk Dodaj)
    // 2. G贸wnym checkboxie ukoczenia (ma wasn logik natychmiastow)
    if (e.target.id === 'new-comment-text' || e.target.id === 'modal-task-completed') {
        return;
    }

    if (!isTaskFormDirty) {
        isTaskFormDirty = true;
        if (taskModal.okBtn) taskModal.okBtn.style.display = 'none';
        if (taskModal.saveBtn) taskModal.saveBtn.style.display = 'block';
    }
}

// Podpicie nasuchiwania na cay modal (delegacja zdarze)
        // === KONIEC NOWYCH FUNKCJI ===
       // === ZMIANA: Dodano parametr initialTab ===
        async function openTaskModal(taskId, initialTab = null) {
            console.log("Wywoano openTaskModal z ID:", taskId, "Tab:", initialTab);
            const { task, project } = findTask(taskId);

            if (!task || !project) {
                 console.error("Nie znaleziono zadania lub projektu dla ID:", taskId);
                 return;
            }

            // 1. Reset stanu przycisk贸w i wska藕nika
            resetTaskModalButtons();
            const indicator = document.getElementById('modal-task-edit-indicator');
            
            // 2. Okrelenie uprawnie
            const currentUserId = state.currentUser.uid;
            const isOwner = project.ownerId === currentUserId;
            const isAdmin = (project.admins || []).includes(currentUserId);
            const isSuperUser = (project.superUsers || []).includes(currentUserId); // <-- NOWE
            const isCreator = task.createdBy === currentUserId;
            const isAssignee = (task.assignees || []).includes(currentUserId);

            // === NOWA LOGIKA: BLOKADA DOSTPU (Privacy Guard) ===
            // Dostp maj: Waciciel, Admin, SuperUser, Tw贸rca LUB Przypisany
            const hasAccess = isOwner || isAdmin || isSuperUser || isCreator || isAssignee;

            if (!hasAccess) {
                showNotification("Nie mo偶esz zobaczy szczeg贸贸w zadania. To zadanie jest przypisane do innej osoby.", "Brak dostpu");
                return; // PRZERYWAMY funkcj - modal si nie otworzy
            }
            // === KONIEC BLOKADY ===

            // Uprawnienie do EDYCJI
            // Zwyky przypisany czonek (assignee) ma TYLKO odczyt, chyba 偶e jest te偶 tw贸rc/adminem/superUserem.
            // SuperUser ma pene prawo edycji zada.
            const canEdit = isOwner || isAdmin || isSuperUser || isCreator;

            // 3. Konfiguracja UI w zale偶noci od uprawnie
            if (canEdit) {
                // --- TRYB EDYCJI (Dostpny od razu) ---
                if(indicator) indicator.style.display = 'inline-block'; // Poka偶 wska藕nik w stopce
                
                // Tytu jako input
                taskModal.title.style.display = 'none';
                taskModal.titleInput.style.display = 'block';
                taskModal.titleInput.value = task.title;
                taskModal.titleInput.disabled = false;

                // Odblokuj pola
                taskModal.description.disabled = false;
                if (taskModal.effortInput) taskModal.effortInput.disabled = false;
                if (taskModal.actualEffortInput) taskModal.actualEffortInput.disabled = false;

                // Odblokuj inputy w zakadkach
                 Array.from(taskModal.overlay.querySelectorAll(
                     '#tab-content-dueDate input, #tab-content-dueDate select, #tab-content-status select, #tab-content-priority select, #tab-content-recurrence input, #tab-content-recurrence select, #tab-content-actions button'
                )).forEach(el => el.disabled = false);

                // Bud偶et - odblokuj
                taskModal.budgetToggle.disabled = false;
                if (taskModal.addBudgetItemBtn) taskModal.addBudgetItemBtn.disabled = false;
                
                // Poka偶 przycisk usuwania (jeli jest tw贸rc lub wacicielem projektu)
                // Dla porzdku: Waciciel/Admin widz Delete. Tw贸rca te偶.
                taskModal.deleteBtn.style.display = 'block';

                // Jeli wska藕nik jest widoczny, przesu przycisk usuwania troch w prawo (margin-left) 
                // lub zostaw go obok (w zale偶noci od CSS w HTML).
                // W HTML ustawiem wska藕nikowi margin-right: auto, wic on wypchnie reszt przycisk贸w.

            } else {
                // --- TRYB TYLKO DO ODCZYTU ---
                if(indicator) indicator.style.display = 'none';

                // Tytu jako tekst
                taskModal.title.textContent = task.title;
                taskModal.title.style.display = 'block';
                taskModal.titleInput.style.display = 'none';

                // Zablokuj pola
                taskModal.description.disabled = true;
                if (taskModal.effortInput) taskModal.effortInput.disabled = true;
                if (taskModal.actualEffortInput) taskModal.actualEffortInput.disabled = true; // Zablokuj w trybie podgldu

                // Zablokuj inputy w zakadkach
                Array.from(taskModal.overlay.querySelectorAll(
                     '#tab-content-dueDate input, #tab-content-dueDate select, #tab-content-status select, #tab-content-priority select, #tab-content-recurrence input, #tab-content-recurrence select, #tab-content-actions button'
                )).forEach(el => el.disabled = true);

                // Bud偶et - zablokuj
                taskModal.budgetToggle.disabled = true;
                if (taskModal.addBudgetItemBtn) taskModal.addBudgetItemBtn.disabled = true;
                
                // Ukryj przycisk usuwania
                taskModal.deleteBtn.style.display = 'none';
            }

            // Przycisk "Edytuj" zawsze ukryty
            if (taskModal.editBtn) taskModal.editBtn.style.display = 'none';

            // --- Konfiguracja Banner贸w ---
            const openCoverGalleryBtn = document.getElementById('open-cover-gallery-btn');
            if (openCoverGalleryBtn) {
                // Zezw贸l na zmian bannera tylko edytujcym
                openCoverGalleryBtn.disabled = !canEdit; 
                
                const isTemplateCover = task.coverImage && task.coverImage.originalPath && task.coverImage.originalPath.startsWith('template_');
                if (isTemplateCover) {
                    openCoverGalleryBtn.textContent = 'Usu szablon';
                    openCoverGalleryBtn.classList.add('is-danger-btn');
                    openCoverGalleryBtn.dataset.action = 'remove-template-cover';
                } else {
                    openCoverGalleryBtn.textContent = 'Wybierz banner';
                    openCoverGalleryBtn.classList.remove('is-danger-btn');
                    openCoverGalleryBtn.dataset.action = 'open-gallery';
                }
            }
             // Zezw贸l na zmian koloru ta tylko edytujcym
            if (taskModalBackgroundColorBtn) {
                taskModalBackgroundColorBtn.disabled = !canEdit;
                updateColorButtonState(taskModalBackgroundColorBtn, task.backgroundColor);
            }

            // --- Wypenianie p贸l danymi (Wsp贸lne dla obu tryb贸w) ---
            taskModal.overlay.dataset.taskId = taskId;
            
            // Wypenianie dat
            const defaultStartTime = '10:00';
            let startDateToParse = task.startDate || (task.createdAt && typeof task.createdAt.toDate === 'function' ? task.createdAt.toDate().toISOString() : null);
            
            if (startDateToParse) {
                const parts = startDateToParse.split('T');
                const datePart = parts[0];
                const timePart = (task.startDate && parts[1]) ? parts[1].split(':') : defaultStartTime.split(':');
                taskModal.startDateDate.value = datePart;
                taskModal.startDateHour.value = timePart[0] ? timePart[0].padStart(2, '0') : '';
                taskModal.startDateMinute.value = timePart[1] ? timePart[1].padStart(2, '0') : '';
            } else {
                taskModal.startDateDate.value = '';
                taskModal.startDateHour.value = '';
                taskModal.startDateMinute.value = '';
            }

            if (task.dueDate) {
                const parts = task.dueDate.split('T');
                taskModal.dueDateDate.value = parts[0];
                if (parts[1]) {
                    const timePart = parts[1].split(':');
                    taskModal.dueDateHour.value = timePart[0] ? timePart[0].padStart(2, '0') : '00';
                    taskModal.dueDateMinute.value = timePart[1] ? timePart[1].padStart(2, '0') : '00';
                } else {
                    taskModal.dueDateHour.value = '00'; 
                    taskModal.dueDateMinute.value = '00';
                }
            } else {
                taskModal.dueDateDate.value = '';
                taskModal.dueDateHour.value = '00'; 
                taskModal.dueDateMinute.value = '00';
            }

            // === ZMIANA: Generowanie listy status贸w z uwzgldnieniem Custom Columns ===
            let statusOptionsHTML = '';
            
            // 1. Opcja "Do realizacji"
            statusOptionsHTML += `<option value="todo" ${task.status === 'todo' ? 'selected' : ''}>${STATUSES.todo}</option>`;

            // 2. Opcja "W trakcie realizacji" (Domylna kolumna)
            const isDefaultInprogress = task.status === 'inprogress' && !task.customColumnId;
            statusOptionsHTML += `<option value="inprogress" ${isDefaultInprogress ? 'selected' : ''}>${STATUSES.inprogress}</option>`;

            // 3. Opcje dla Custom Columns (jeli s w projekcie)
            if (project.customColumns && project.customColumns.length > 0) {
                // Sortujemy zgodnie z kolejnoci w projekcie
                const sortedCols = [...project.customColumns].sort((a, b) => (a.order || 0) - (b.order || 0));
                
                sortedCols.forEach(col => {
                    // Sprawdzamy, czy zadanie jest w tej konkretnej kolumnie
                    const isSelected = task.status === 'inprogress' && task.customColumnId === col.id;
                    // Jako value u偶ywamy specjalnego prefiksu "col_ID", aby rozr贸偶ni przy zapisie
                    statusOptionsHTML += `<option value="CUSTOM_COL:${col.id}" ${isSelected ? 'selected' : ''}>${col.title}</option>`;
                });
            }

            // 4. Opcja "Wykonane"
            statusOptionsHTML += `<option value="done" ${task.status === 'done' ? 'selected' : ''}>${STATUSES.done}</option>`;

            taskModal.status.innerHTML = statusOptionsHTML;
            // === KONIEC ZMIANY ===

            taskModal.priority.value = task.priority;
            
            // === NOWE: Wczytywanie ostrze偶e ===
            if (taskModal.warningOverride) {
                if (task.warningOverride) {
                    taskModal.warningOverride.checked = true;
                    taskModal.warningWrapper.style.display = 'block';
                    taskModal.warningDaysInput.value = task.warningDays || 3;
                } else {
                    taskModal.warningOverride.checked = false;
                    taskModal.warningWrapper.style.display = 'none';
                    taskModal.warningDaysInput.value = 3;
                }
            }
            // === KONIEC ===

           // Aktualizuj te偶 edytor wizualny
if (editorTaskDescription) {
    editorTaskDescription.setContent(task.description || '');
    // Zarzdzanie stanem zablokowania (read-only)
    editorTaskDescription.editor.contentEditable = canEdit;
    editorTaskDescription.container.style.opacity = canEdit ? '1' : '0.7';
    // Ukryj pasek narzdzi w trybie tylko do odczytu dla estetyki
    editorTaskDescription.toolbar.style.display = canEdit ? 'flex' : 'none';
} else {
    // Fallback
    taskModal.description.value = task.description || '';
}
            
            // === ZABEZPIECZONA LOGIKA: Sterowanie widocznoci przycisku "Zakocz zadanie" ===
            // Sprawdzamy czy taskModal.finishBtn w og贸le istnieje (nie jest undefined ani null)
            if (taskModal.finishBtn) {
                let showFinishBtn = false;
                
                // Sprawd藕, czy u偶ytkownik ma uprawnienia do ukoczenia
                // (Zakadamy, 偶e canUserCompleteTask i currentUserId s zdefiniowane wy偶ej w funkcji)
                const canCompleteTask = canUserCompleteTask(currentUserId, task, project);
                
                if (canCompleteTask) {
                    // Sprawd藕, czy zadanie jest ju偶 ukoczone (lub moja cz)
                    if (task.type === 'multi') {
                        const amIDone = (task.completedBy || []).includes(currentUserId);
                        // Poka偶 tylko, jeli moja cz NIE jest jeszcze zrobiona
                        if (!amIDone) showFinishBtn = true;
                    } else {
                        // Poka偶 tylko, jeli status NIE jest 'done'
                        if (task.status !== 'done') showFinishBtn = true;
                    }
                }
                taskModal.finishBtn.style.display = showFinishBtn ? 'block' : 'none';
            } else {
                console.warn("Ostrze偶enie: Nie znaleziono przycisku 'finish-task-btn' w obiekcie taskModal.");
            }
            // === KONIEC ===

            // Checkbox ukoczenia - logika specjalna
            if (taskModal.completed) {
                taskModal.completed.checked = task.status === 'done';
                const shouldBeDisabled = task.type === 'multi' && (task.status === 'todo' || task.status === 'inprogress');
                // Checkbox dziaa niezale偶nie od trybu edycji (ka偶dy przypisany mo偶e oznaczy), 
                // ale blokujemy go, jeli user nie ma w og贸le dostpu (cho Privacy Guard wy偶ej i tak to zablokuje).
                const canComplete = canUserCompleteTask(currentUserId, task, project);
                taskModal.completed.disabled = shouldBeDisabled || !canComplete;
            }
            
           // === LOGIKA PODSUMOWANIA DLA ZADA Z PODZADANIAMI ===
            const hasSubtasks = task.subtasks && task.subtasks.length > 0;
            const projectCurrency = project.budget?.currency || 'PLN';
            const estimationUnit = (project.estimationType === 'points') ? 'pkt' : 'h';

            // 1. KONFIGURACJA ZAKADKI WYSIKU (EFFORT)
            setupEffortTab(project, task, taskModal); // To ustawia widoczno samej zakadki
            
            if (project.estimationType !== 'none') {
                if (hasSubtasks) {
                    // Poka偶 widok podsumowania
                    document.getElementById('effort-single-mode').style.display = 'none';
                    document.getElementById('effort-summary-mode').style.display = 'block';
                    
                    renderSubtaskEffortSummary(task.subtasks, estimationUnit);
                } else {
                    // Poka偶 widok pojedynczy (inputy)
                    document.getElementById('effort-single-mode').style.display = 'block';
                    document.getElementById('effort-summary-mode').style.display = 'none';
                    
                    const estimationValue = (task.estimation > 0) ? task.estimation : '';
                    const actualEffortValue = task.actualEffort ?? estimationValue;
                    if (taskModal.actualEffortInput) taskModal.actualEffortInput.value = actualEffortValue;
                }
            }

            // 2. KONFIGURACJA ZAKADKI BUD呕ETU
            const hasProjectBudget = project.budget && parseFloat(project.budget.amount) > 0;
            
            if (hasProjectBudget) {
                if (taskModal.budgetTabButton) taskModal.budgetTabButton.style.display = 'flex';
                taskModal.budgetCurrencySpan.textContent = projectCurrency;

                if (hasSubtasks) {
                    // Poka偶 widok podsumowania
                    document.getElementById('budget-single-mode').style.display = 'none';
                    document.getElementById('budget-summary-mode').style.display = 'block';
                    
                    renderSubtaskBudgetSummary(task.subtasks, projectCurrency);
                } else {
                    // Poka偶 widok pojedynczy (edycja)
                    document.getElementById('budget-single-mode').style.display = 'block';
                    document.getElementById('budget-summary-mode').style.display = 'none';
                    
                    // --- STARA LOGIKA RENDEROWANIA BUD呕ETU (PRZENIESIONA TUTAJ) ---
                    const projectItemNames = project.budget.items ? project.budget.items.map(item => item.name) : [];
                    taskModal.budgetToggle.checked = false;
                    taskModal.budgetDetails.style.display = 'none';
                    taskModal.budgetItemsList.innerHTML = '<li class="budget-item-empty" style="font-style: italic; color: var(--text-secondary); font-size: 13px;">Brak pozycji kosztowych.</li>';
                    taskModal.budgetErrorP.textContent = '';

                    if (task.budgetItems && task.budgetItems.length > 0) {
                        taskModal.budgetToggle.checked = true;
                        taskModal.budgetDetails.style.display = 'block';
                        taskModal.budgetItemsList.innerHTML = '';

                        task.budgetItems.forEach((item, index) => {
                            // Renderuj tylko jeli pozycja nadal istnieje w projekcie
                            if (projectItemNames.includes(item.name)) {
                                const itemHTML = renderTaskBudgetItemHTML(item, index, projectItemNames);
                                taskModal.budgetItemsList.insertAdjacentHTML('beforeend', itemHTML);
                            }
                        });
                        if (taskModal.budgetItemsList.children.length === 0) {
                            taskModal.budgetItemsList.innerHTML = '<li class="budget-item-empty" style="font-style: italic; color: var(--text-secondary); font-size: 13px;">Przypisane pozycje nie istniej ju偶 w bud偶ecie projektu.</li>';
                        }
                        updateTaskBudgetTotal(taskModal, projectCurrency);
                    } else {
                        updateTaskBudgetTotal(taskModal, projectCurrency);
                    }
                    
                    // Blokada edycji jeli read-only (zachowana z oryginau)
                    if (!canEdit) {
                         Array.from(taskModal.budgetItemsList.querySelectorAll('li.budget-item select, li.budget-item input[type="number"]'))
                             .forEach(el => {
                                 if (el.tagName === 'SELECT') el.disabled = true;
                                 else if (el.tagName === 'INPUT') el.setAttribute('disabled', 'disabled');
                             });
                        Array.from(taskModal.budgetItemsList.querySelectorAll('.delete-task-budget-item-btn'))
                          .forEach(btn => btn.style.display = 'none');
                    }
                    // --- KONIEC STAREJ LOGIKI ---
                }
            } else {
                 if (taskModal.budgetTabButton) taskModal.budgetTabButton.style.display = 'none';
            }
            // === KONIEC NOWEJ LOGIKI ===
            // Link zale偶noci
            const dependencyLinkEl = document.getElementById('modal-task-dependency-link');
            if (dependencyLinkEl) {
                if (task.dependency && task.dependency.blockingTaskId) {
                    const { task: blockingTask } = findTask(task.dependency.blockingTaskId);
                    if (blockingTask) {
                        dependencyLinkEl.innerHTML = `Zale偶ne od: <strong style="color: var(--text-primary); cursor: pointer;" data-linked-task-id="${blockingTask.id}" title="Kliknij, aby otworzy">${blockingTask.title}</strong>`;
                        dependencyLinkEl.style.display = 'block';
                    } else {
                        dependencyLinkEl.textContent = 'Zale偶ne od: (Nie znaleziono zadania)';
                        dependencyLinkEl.style.display = 'block';
                    }
                } else {
                    dependencyLinkEl.style.display = 'none';
                }
            }

            // Info o tw贸rcy
             const creatorInfoEl = document.getElementById('modal-task-creator-info');
                if (creatorInfoEl) {
                    let creatorInfoText = '';
                    if (task.createdBy) {
                        const creator = findUser(task.createdBy);
                        const creatorName = creator ? (creator.name || creator.email) : 'Nieznany';
                        creatorInfoText = `Utworzy: ${creatorName}`;
                    } else {
                        creatorInfoText = `Utworzy: Nieznany`;
                    }
                    if (task.createdAt && typeof task.createdAt.toDate === 'function') { 
                        const creationDate = task.createdAt.toDate().toLocaleDateString('pl-PL', { 
                            day: '2-digit',
                            month: '2-digit',
                            year: 'numeric'
                        });
                        creatorInfoText += `, Data utworzenia: ${creationDate}`;
                    }
                    creatorInfoEl.textContent = creatorInfoText;
                }

            // Reset akordeonu
            const subtasksToggleBtn = document.getElementById('subtasks-toggle-btn');
            const subtasksCollapsibleArea = document.getElementById('subtasks-collapsible-area');
            if (subtasksToggleBtn && subtasksCollapsibleArea) {
                subtasksToggleBtn.classList.add('collapsed');
                subtasksCollapsibleArea.classList.add('collapsed');
                const toggleText = subtasksToggleBtn.querySelector('.toggle-text');
                if (toggleText) toggleText.textContent = 'Rozwi';
            }

            // Cykliczno
            if (task.recurrence) {
                taskModal.isRecurring.checked = true;
                taskModal.recurrenceOptions.style.display = 'block';
                const type = task.recurrence.type;
                taskModal.recurrenceType.value = type;
                document.getElementById('modal-task-recurrence-day-wrapper').style.display = type === 'dayOfMonth' ? 'block' : 'none';
                document.getElementById('modal-task-nth-day-options').style.display = type === 'nthDayOfMonth' ? 'flex' : 'none';
                if (type === 'dayOfMonth') {
                    taskModal.recurrenceDay.value = task.recurrence.day;
                } else if (type === 'nthDayOfMonth') {
                    document.getElementById('modal-task-recurrence-nth').value = task.recurrence.nth;
                    document.getElementById('modal-task-recurrence-weekday').value = task.recurrence.weekday;
                }
            } else {
                taskModal.isRecurring.checked = false;
                taskModal.recurrenceOptions.style.display = 'none';
                document.getElementById('modal-task-recurrence-day-wrapper').style.display = 'none';
                document.getElementById('modal-task-nth-day-options').style.display = 'none';
            }

            // === NOWA LOGIKA: Budowanie listy (Akordeon + Prawa Kolumna) ===
            
            // 1. Lewa kolumna (Akordeon)
            buildTeamMembersAccordion(
                taskModal.assigneesContainer,      // Kontener
                task.assignees || [],              // Zaznaczeni
                project.ownerId,                   // Waciciel
                project.admins || [],              // Admini
                false                              // false = nie blokuj waciciela
            );
            
            // 2. Prawa kolumna (Wybrani)
            renderSelectedMembersColumn(
                taskModal.assigneesContainer,
                taskModal.selectedList,
                null, [], [] // Brak r贸l w zadaniu
            );

            // Wczamy wyszukiwark (tylko jeli mo偶na edytowa, dla estetyki mo偶na ukry input w read-only)
            if (canEdit) {
                taskModal.memberSearchInput.style.display = 'block';
                setupUserSearch(taskModal.memberSearchInput, taskModal.memberSearchResults, taskModal.assigneesContainer);
            } else {
                taskModal.memberSearchInput.style.display = 'none';
            }
            
            // Oznaczamy kontener, czy jest edytowalny (dla listenera)
            taskModal.assigneesContainer.dataset.editable = canEdit ? "true" : "false";
            // === KONIEC ===
           

            // === NOWA LOGIKA: Status ukoczenia dla zada wieloosobowych (w zakadce Status) ===
            const multiTaskContainer = document.getElementById('modal-multi-task-status-container');
            const multiTaskActionArea = document.getElementById('modal-multi-task-action-area');

            if (task.type === 'multi') {
                // Sprawd藕, czy aktualny u偶ytkownik jest przypisany do zadania
                const isCurrentUserAssigned = task.assignees.includes(state.currentUser.uid);

                if (isCurrentUserAssigned) {
                    multiTaskContainer.style.display = 'block';
                    
                    // --- 1. Generowanie Listy Uczestnik贸w i ich Status贸w ---
                    const usersListHTML = task.assignees.map(userId => {
                        const user = findUser(userId);
                        if (!user) return '';
                        
                        const isDone = (task.completedBy || []).includes(userId);
                        
                        // Ikona dla Oczekujcych (Szare k贸ko z ptaszkiem - sp贸jne z reszt UI)
                        const iconPending = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" style="margin-left: auto; color: var(--text-secondary); opacity: 0.7;"><circle cx="12" cy="12" r="10" fill="none" stroke="currentColor" stroke-width="2"/><path d="M7 12l3 3 7-7" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>`;
                        
                        // Ikona dla Ukoczonych (Check)
                        const iconDone = `
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" style="margin-left: auto; color: var(--success-primary);">
                          <title>Ukoczone</title>
                          <circle cx="12" cy="12" r="10" fill="none" stroke="currentColor" stroke-width="2"/>
                          <path d="M7 12l3 3 7-7" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>`;

                        return `
                        <div class="member-pill" style="width: 100%; justify-content: flex-start; border-radius: 4px; margin-bottom: 4px; cursor: default; background-color: var(--bg-secondary);">
                            ${renderAvatarHTML(user, 'member-pill-avatar')}
                            <span style="margin-left: 8px; font-size: 13px;">${user.name || user.email}</span>
                            ${isDone ? iconDone : iconPending}
                        </div>`;
                    }).join('');

                    // ZMIANA STYLI: Margines i linia s teraz NA GRZE (top), aby oddzieli od przycisku powy偶ej
                    const statusListContainer = `
                        <div style="display: flex; flex-direction: column; gap: 2px; margin-top: 16px; border-top: 1px dashed var(--border-color); padding-top: 12px;">
                            <span style="font-size: 11px; font-weight: 600; color: var(--text-secondary); margin-bottom: 4px; text-transform: uppercase;">Postp zespou:</span>
                            ${usersListHTML}
                        </div>
                    `;
                    // --- Koniec Generowania Listy ---

                    const isMyPartDone = task.completedBy.includes(state.currentUser.uid);
                    let actionHTML = '';

                    if (isMyPartDone) {
                        // Stan: U偶ytkownik ju偶 ukoczy
                        actionHTML = `
                            <div style="display: flex; align-items: center; gap: 8px; color: var(--success-primary); font-weight: 600;">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" style="width: 24px; height: 24px;">
                                  <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
                                </svg>
                                <span>Ukoczye/a swoj cz</span>
                            </div>
                            <button class="btn btn-secondary btn-sm js-complete-my-part-btn" data-user-id="${state.currentUser.uid}" style="margin-top: 8px; font-size: 12px;">Cofnij ukoczenie</button>
                        `;
                    } else {
                        // Stan: Do zrobienia
                        actionHTML = `
                            <button class="btn btn-primary js-complete-my-part-btn" data-user-id="${state.currentUser.uid}" style="width: 100%; justify-content: center;">
                                 Oznacz moj cz jako wykonan
                            </button>
                        `;
                    }

                    // ZMIANA KOLEJNOCI: Najpierw przycisk (actionHTML), potem lista pod spodem (statusListContainer)
                    multiTaskActionArea.innerHTML = actionHTML + statusListContainer;

                } else {
                    // Zadanie multi, ale user nie jest przypisany (np. admin podglda)
                    multiTaskContainer.style.display = 'none';
                }
            } else {
                // Zadanie pojedyncze
                if (multiTaskContainer) multiTaskContainer.style.display = 'none';
            }
            // === KONIEC NOWEJ LOGIKI ===

            // Bud偶et
             const projectBudget = project.budget;
            const projectHasBudgetItems = projectBudget && projectBudget.items && projectBudget.items.length > 0;
            
            const projectItemNames = projectHasBudgetItems ? projectBudget.items.map(item => item.name) : [];

            taskModal.budgetToggle.checked = false;
            taskModal.budgetDetails.style.display = 'none';
            taskModal.budgetItemsList.innerHTML = '<li class="budget-item-empty" style="font-style: italic; color: var(--text-secondary); font-size: 13px;">Brak pozycji kosztowych.</li>';
            taskModal.budgetErrorP.textContent = '';

            if (projectHasBudgetItems && task.budgetItems && task.budgetItems.length > 0) {
                taskModal.budgetToggle.checked = true;
                taskModal.budgetDetails.style.display = 'block';
                taskModal.budgetItemsList.innerHTML = '';

                task.budgetItems.forEach((item, index) => {
                    if (projectItemNames.includes(item.name)) {
                        const itemHTML = renderTaskBudgetItemHTML(item, index, projectItemNames);
                        taskModal.budgetItemsList.insertAdjacentHTML('beforeend', itemHTML);
                    }
                });
                if (taskModal.budgetItemsList.children.length === 0) {
                    taskModal.budgetItemsList.innerHTML = '<li class="budget-item-empty" style="font-style: italic; color: var(--text-secondary); font-size: 13px;">Przypisane pozycje nie istniej ju偶 w bud偶ecie projektu.</li>';
                }
                updateTaskBudgetTotal(taskModal, projectCurrency);
            } else if (projectHasBudgetItems) {
                updateTaskBudgetTotal(taskModal, projectCurrency);
            }

            // Blokada bud偶etu jeli !canEdit
            if (!canEdit) {
                Array.from(taskModal.budgetItemsList.querySelectorAll('li.budget-item select, li.budget-item input[type="number"]'))
                     .forEach(el => {
                         if (el.tagName === 'SELECT') el.disabled = true;
                         else if (el.tagName === 'INPUT') el.setAttribute('disabled', 'disabled');
                     });
                Array.from(taskModal.budgetItemsList.querySelectorAll('.delete-task-budget-item-btn'))
                  .forEach(btn => btn.style.display = 'none');
            }

            // Renderowanie list (komentarze, historia, zaczniki, podzadania)
            renderComments(task);
            renderActivityLog(task);
            renderAttachments(task); 
            renderSubtaskListInMainModal(task);
            
            openModal(taskModal.overlay);
            
            
            // === NOWA LOGIKA PRZECZANIA ZAKADKI ===
            // Jeli podano initialTab, u偶yj go. W przeciwnym razie domylnie 'description'.
            const tabToOpen = initialTab || 'description';
            const tabBtn = taskModal.overlay.querySelector(`.task-modal-tab[data-tab="${tabToOpen}"]`);
            
            if (tabBtn) {
                tabBtn.click();
            } else {
                // Fallback, jeli np. zakadka 'effort' jest ukryta w tym projekcie
                const defaultTab = taskModal.overlay.querySelector('.task-modal-tab[data-tab="description"]');
                if (defaultTab) defaultTab.click();
            }
        }
        // === DODATEK: Listener globalny dla modala zadania (Wykrywanie zmian) ===
        // Dodaj to poza funkcj openTaskModal, np. w bloku init
        const taskModalContent = taskModal.overlay.querySelector('.task-modal-content');
        if (taskModalContent) {
            taskModalContent.addEventListener('input', handleTaskFormChange);
            taskModalContent.addEventListener('change', handleTaskFormChange);
            // Obsuga piguek (click zamiast change)
            taskModalContent.addEventListener('click', (e) => {
                 if (e.target.closest('.member-pill') || e.target.closest('.subtask-checkbox')) {
                     handleTaskFormChange(e);
                 }
            });
        }
       // Zmienna tymczasowa dla plik贸w podzadania (podobnie jak w new task)
        let subtaskStagedFiles = [];
        let subtaskStagedComments = []; // <--- NOWA ZMIENNA

        // === NOWA FUNKCJA POMOCNICZA: Renderowanie komentarzy w podzadaniu ===
        function renderSubtaskComments(comments = []) {
            subtaskModal.commentsList.innerHTML = '';
            // Sortujemy od najstarszych do najnowszych
            const sortedComments = [...comments].sort((a, b) => b.timestamp - a.timestamp); 
            
            sortedComments.forEach(c => {
                const user = findUser(c.userId);
                const li = document.createElement('li');
                li.className = 'comment-item';
                
                const textContent = typeof parseMentions === 'function' ? parseMentions(c.text) : c.text;
                const dateStr = new Date(c.timestamp).toLocaleString('pl-PL', { day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' });

                li.innerHTML = `
                    <div class="comment-author">
                        ${renderAvatarHTML(user, 'avatar-comment')}
                        <span>${user ? (user.name || user.email) : 'Kto'}</span>
                        <small style="color: var(--text-secondary); margin-left: auto;">${dateStr}</small>
                    </div>
                    <p>${textContent}</p>
                `;
                subtaskModal.commentsList.appendChild(li);
            });
        }

        // === ZMIANA: Dodano parametr initialTab ===
        function openSubtaskModal(mainTaskId, subtaskId = null, initialTab = null) {
            const { task: mainTask, project } = findTask(mainTaskId);
            if (!mainTask || !project) {
                showNotification("Nie mo偶na znale藕 zadania nadrzdnego.", "Bd");
                return;
            }

            subtaskModal.overlay.dataset.mainTaskId = mainTaskId;
            subtaskStagedFiles = []; // Reset plik贸w tymczasowych
            subtaskStagedComments = []; // <--- RESETUJEMY KOMENTARZE TYMCZASOWE

            // Reset formularza i interfejsu
            subtaskModal.form.reset();
            
            // === NOWE: Reset edytora wizualnego ===
            if (typeof editorSubtaskDescription !== 'undefined' && editorSubtaskDescription) {
                editorSubtaskDescription.clear();
            }
            // === KONIEC ===

            subtaskModal.budgetDetails.style.display = 'none';
            // === POPRAWKA: Czyszczenie listy bud偶etowej ===
            subtaskModal.budgetItemsList.innerHTML = ''; // <--- DODANA LINIA
            // =============================================
            subtaskModal.attachmentsList.innerHTML = '';
            subtaskModal.commentsList.innerHTML = '';
            // Reset Listy Kontrolnej
            subtaskModal.checklistItemsList.innerHTML = '';
            subtaskModal.checklistWrapper.style.display = 'none';
            subtaskModal.checklistToggle.checked = false;
            
            // Wyczy i ukryj komunikaty bd贸w dat
            if(subtaskModal.startError) subtaskModal.startError.style.display = 'none';
            if(subtaskModal.dueError) subtaskModal.dueError.style.display = 'none';
            
            // Ustaw domylne godziny (dla wygody u偶ytkownika)
            subtaskModal.startDateHour.value = '10'; subtaskModal.startDateMinute.value = '00';
            subtaskModal.dueDateHour.value = '12'; subtaskModal.dueDateMinute.value = '00';

            

            // --- 1. Konfiguracja Wysiku (Effort) i Bud偶etu ---
            const estimationType = project.estimationType || 'none';
            if (estimationType === 'none') {
                subtaskModal.tabEffort.style.display = 'none';
            } else {
                subtaskModal.tabEffort.style.display = 'flex';
                subtaskModal.effortLabel.textContent = estimationType === 'points' ? 'Szacowane Story Points' : 'Szacowane godziny';
                subtaskModal.effortUnit.textContent = estimationType === 'points' ? 'pkt' : 'h';
                // Resetuj pola
                subtaskModal.effortInput.value = '';
                subtaskModal.actualEffortInput.value = '';
            }

            const hasProjectBudget = project.budget && parseFloat(project.budget.amount) > 0;
            subtaskModal.tabBudget.style.display = hasProjectBudget ? 'flex' : 'none';

            // --- 2. Logika Dat i Walidacja ---
            // Reset ogranicze input贸w
            subtaskModal.startDateDate.min = '';
            subtaskModal.startDateDate.max = '';
            subtaskModal.dueDateDate.min = '';
            subtaskModal.dueDateDate.max = '';

            // Ustaw ograniczenia na podstawie zadania GWNEGO
            if (mainTask.startDate) {
                const mainStartISO = mainTask.startDate.split('T')[0];
                // Podzadanie nie mo偶e zacz si wczeniej ni偶 zadanie g贸wne
                subtaskModal.startDateDate.min = mainStartISO; 
                subtaskModal.dueDateDate.min = mainStartISO;
            }
            if (mainTask.dueDate) {
                const mainDueISO = mainTask.dueDate.split('T')[0];
                // Podzadanie nie mo偶e skoczy si p贸藕niej ni偶 zadanie g贸wne
                subtaskModal.startDateDate.max = mainDueISO;
                subtaskModal.dueDateDate.max = mainDueISO;
            }

            // Funkcja walidujca daty "na 偶ywo"
            const validateDates = () => {
                subtaskModal.startError.style.display = 'none';
                subtaskModal.dueError.style.display = 'none';
                
                const sDate = subtaskModal.startDateDate.value;
                const dDate = subtaskModal.dueDateDate.value;

                // Sprawd藕 czy data startu mieci si w zakresie g贸wnego zadania
                if (sDate && mainTask.startDate && sDate < mainTask.startDate.split('T')[0]) {
                    subtaskModal.startError.textContent = "Data startu jest wczeniejsza ni偶 start zadania g贸wnego!";
                    subtaskModal.startError.style.display = 'block';
                    subtaskModal.startDateDate.value = ''; // Resetuj bdn dat
                }
                // Sprawd藕 czy termin wykonania mieci si w zakresie g贸wnego zadania
                if (dDate && mainTask.dueDate && dDate > mainTask.dueDate.split('T')[0]) {
                    subtaskModal.dueError.textContent = "Termin wykracza poza termin zadania g贸wnego!";
                    subtaskModal.dueError.style.display = 'block';
                    subtaskModal.dueDateDate.value = ''; // Resetuj bdn dat
                }
                // Sprawd藕 relacj Start < Koniec w samym podzadaniu
                if (sDate && dDate && sDate > dDate) {
                    subtaskModal.dueError.textContent = "Termin wykonania musi by p贸藕niejszy ni偶 start.";
                    subtaskModal.dueError.style.display = 'block';
                    // Nie resetujemy tutaj, dajemy u偶ytkownikowi poprawi
                }
            };
            
            // Podepnij listenery walidacji (unikamy wielokrotnego podpinania przez przypisanie onchange)
            subtaskModal.startDateDate.onchange = validateDates;
            subtaskModal.dueDateDate.onchange = validateDates;


            // --- 3. Wypenianie danymi (Edycja vs Tworzenie) ---
            let selectedAssignees = [];
            
            if (subtaskId) {
                // --- TRYB EDYCJI ---
                const subtask = (mainTask.subtasks || []).find(s => s.id === subtaskId);
                if (!subtask) return;

                // === NOWA LOGIKA: Weryfikacja Uprawnie (Privacy Guard) ===
                const currentUserId = state.currentUser.uid;
                const isProjectOwner = project.ownerId === currentUserId;
                const isProjectAdmin = (project.admins || []).includes(currentUserId);
                // Dodajemy sprawdzanie SuperUsera
                const isProjectSuperUser = (project.superUsers || []).includes(currentUserId); 
                const isCreator = subtask.createdBy === currentUserId;
                const isAssignee = (subtask.assignees || []).includes(currentUserId);

                // Dostp maj: Waciciel, Admin, SuperUser, Tw贸rca LUB Przypisany
                const hasAccess = isProjectOwner || isProjectAdmin || isProjectSuperUser || isCreator || isAssignee;

                if (!hasAccess) {
                    showNotification("Nie mo偶esz zobaczy szczeg贸贸w podzadania. To podzadanie jest przypisane do innej osoby.", "Brak dostpu");
                    return; // PRZERYWAMY - modal si nie otworzy
                }
                // === KONIEC LOGIKI ===

                subtaskModal.modalTitle.textContent = 'Edytuj podzadanie';
                subtaskModal.subtaskIdInput.value = subtaskId;
                
                // Dane podstawowe
                subtaskModal.titleInput.value = subtask.title;
                // === NOWE: Wczytanie priorytetu i ostrze偶e ===
                if (subtaskModal.prioritySelect) {
                    subtaskModal.prioritySelect.value = subtask.priority || 'medium';
                }
                
                if (subtaskModal.warningOverride) {
                    if (subtask.warningOverride) {
                        subtaskModal.warningOverride.checked = true;
                        subtaskModal.warningWrapper.style.display = 'block';
                        subtaskModal.warningDaysInput.value = subtask.warningDays || 3;
                    } else {
                        subtaskModal.warningOverride.checked = false;
                        subtaskModal.warningWrapper.style.display = 'none';
                        subtaskModal.warningDaysInput.value = 3; // Domylna
                    }
                }
                // === KONIEC NOWEGO KODU ===
                // === NOWE: Wczytanie opisu do edytora wizualnego ===
                if (typeof editorSubtaskDescription !== 'undefined' && editorSubtaskDescription) {
                    editorSubtaskDescription.setContent(subtask.description || '');
                } else {
                    // Fallback do zwykego textarea, jeli edytor nie istnieje
                    subtaskModal.descriptionInput.value = subtask.description || '';
                }
                // === KONIEC ===
                
                // Rozbijanie daty startu (jeli istnieje)
                if (subtask.startDate) {
                    const parts = subtask.startDate.split('T');
                    subtaskModal.startDateDate.value = parts[0];
                    if (parts[1]) {
                        const time = parts[1].split(':');
                        subtaskModal.startDateHour.value = time[0];
                        subtaskModal.startDateMinute.value = time[1];
                    }
                }
                
                // Rozbijanie terminu wykonania (jeli istnieje)
                if (subtask.dueDate) {
                    const parts = subtask.dueDate.split('T');
                    subtaskModal.dueDateDate.value = parts[0];
                    if (parts[1]) {
                        const time = parts[1].split(':');
                        subtaskModal.dueDateHour.value = time[0];
                        subtaskModal.dueDateMinute.value = time[1];
                    }
                }
                
                // Wysiek
                if (subtask.effort) subtaskModal.effortInput.value = subtask.effort;
                if (subtask.actualEffort) subtaskModal.actualEffortInput.value = subtask.actualEffort;

                selectedAssignees = subtask.assignees || [];

                // Bud偶et: Wczytaj pozycje i wyrenderuj
                if (hasProjectBudget && subtask.budgetItems && subtask.budgetItems.length > 0) {
                    subtaskModal.budgetToggle.checked = true;
                    subtaskModal.budgetDetails.style.display = 'block';
                    
                    // ZMIANA: Zabezpieczenie przed brakiem tablicy items
                    const safeItems = project.budget.items || [];
                    const projectItemNames = safeItems.map(i => i.name);
                    
                    // U偶ywamy existing helper function renderTaskBudgetItemHTML
                    subtaskModal.budgetItemsList.innerHTML = subtask.budgetItems.map((item, idx) =>
                        renderTaskBudgetItemHTML(item, idx, projectItemNames)
                    ).join('');
                }

                // Zaczniki: Wywietl linki do istniejcych
                if (subtask.attachments) {
                    subtask.attachments.forEach(att => {
                        const li = document.createElement('li');
                        li.className = 'staged-attachment-item';
                        li.innerHTML = `
                            <div class="staged-attachment-info">
                                <a href="${att.url}" target="_blank" style="text-decoration:none; color:inherit;">${att.name}</a>
                            </div>
                            `;
                        subtaskModal.attachmentsList.appendChild(li);
                    });
                }
                
                // Komentarze: Wywietl histori
                renderSubtaskComments(subtask.comments || []); 

                // === LOGIKA PRZYCISKU ZAKOCZ (PODZADANIE) ===
                if (subtaskModal.finishBtn) {
                    let showFinishBtn = false;
                    
                    // Sprawd藕, czy u偶ytkownik ma dostp (zdefiniowane wczeniej w funkcji jako hasAccess)
                    if (hasAccess) {
                        const currentUserId = state.currentUser.uid;
                        
                        // Czy JA ukoczyem swoj cz?
                        const amIDone = (subtask.completedBy || []).includes(currentUserId);
                        
                        // Czy cae podzadanie jest ukoczone?
                        // Sprawdzamy zar贸wno flag isCompleted, jak i status tekstowy 'done'
                        const isFullyDone = subtask.isCompleted || subtask.status === 'done';

                        if (subtask.type === 'multi' || (subtask.assignees && subtask.assignees.length > 1)) {
                            // W trybie Multi: Poka偶 przycisk, jeli JA jeszcze nie skoczyem
                            // (Nawet jeli inni skoczyli, ja mog chcie odznaczy swoj cz)
                            if (!amIDone) showFinishBtn = true;
                        } else {
                            // W trybie Single: Poka偶 przycisk, jeli podzadanie nie jest w peni gotowe
                            if (!isFullyDone) showFinishBtn = true;
                        }
                    }
                    subtaskModal.finishBtn.style.display = showFinishBtn ? 'block' : 'none';
                }
                // === KONIEC ===

                // === NOWE: Generowanie listy status贸w (z Custom Columns) ===
                let statusOptionsHTML = '';
                
                // 1. Opcja "Do realizacji"
                statusOptionsHTML += `<option value="todo">Do realizacji</option>`;

                // 2. Opcja "W trakcie realizacji" (Domylna)
                statusOptionsHTML += `<option value="inprogress">W trakcie realizacji</option>`;

                // 3. Opcje dla Custom Columns (z projektu)
                if (project.customColumns && project.customColumns.length > 0) {
                    // Sortujemy zgodnie z kolejnoci w projekcie
                    const sortedCols = [...project.customColumns].sort((a, b) => (a.order || 0) - (b.order || 0));
                    
                    sortedCols.forEach(col => {
                        // Jako value u偶ywamy prefiksu "CUSTOM_COL:", aby rozr贸偶ni przy zapisie
                        statusOptionsHTML += `<option value="CUSTOM_COL:${col.id}">${col.title}</option>`;
                    });
                }

                // 4. Opcja "Wykonane"
                statusOptionsHTML += `<option value="done">Wykonane</option>`;
                
                // Wstrzyknij opcje do selecta
                subtaskModal.statusSelect.innerHTML = statusOptionsHTML;

                // Ustalanie aktualnie wybranej wartoci
                let selectedValue = 'todo';
                
                // Jeli to edycja istniejcego
                if (subtask.status) {
                    if (subtask.status === 'inprogress' && subtask.customColumnId) {
                        selectedValue = `CUSTOM_COL:${subtask.customColumnId}`;
                    } else {
                        selectedValue = subtask.status;
                    }
                } else {
                    // Fallback dla starych danych
                    selectedValue = subtask.isCompleted ? 'done' : 'todo';
                }
                
                subtaskModal.statusSelect.value = selectedValue;
                // === KONIEC ===
                
                // Lista Kontrolna: Wczytaj dane
                // POPRAWKA: U偶ywamy 'subtask' (obiekt podzadania) oraz 'subtaskModal' (elementy DOM podzadania)
                if (subtask.checklist && subtask.checklist.length > 0) {
                    subtaskModal.checklistToggle.checked = true;
                    subtaskModal.checklistWrapper.style.display = 'block';
                    subtask.checklist.forEach(item => {
                        // ZMIANA: Sprawd藕 uprawnienia (przekazujemy 'subtask' jako kontekst)
                        const canToggle = hasChecklistPermission(state.currentUser, project, subtask, item);
                        // Przeka偶 !canToggle jako isDisabled (jeli nie mo偶e przeczy, to zablokuj)
                        addChecklistItemUI(item, !canToggle);
                    });
                }
            
            // === NOWA LOGIKA: Renderowanie zakadki STATUS w podzadaniu ===
                const statusContainer = document.getElementById('subtask-multi-status-container');
                // USUNITO: const singleInfo = ... (element ju偶 nie istnieje)
                
                // Ustal typ (dla istniejcego bierzemy z obiektu, dla nowego liczymy dynamicznie lub domylnie single)
                // W trybie edycji selectedAssignees jest ju偶 ustawione
                const isMulti = selectedAssignees.length > 1;

                if (isMulti) {
                    statusContainer.style.display = 'block';
                    // USUNITO: singleInfo.style.display = 'none';
                    
                    // 1. Generuj list uczestnik贸w
                    const usersListHTML = selectedAssignees.map(userId => {
                        const user = findUser(userId);
                        if (!user) return '';
                        
                        // Sprawd藕 czy user ukoczy
                        const isDone = (subtask && subtask.completedBy || []).includes(userId);
                        
                        // Ikona dla Oczekujcych (Loading)
                        const iconPending = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="14" height="14" style="color: var(--text-secondary); opacity: 0.7;"><circle cx="12" cy="12" r="10" fill="none" stroke="currentColor" stroke-width="2"/><path d="M7 12l3 3 7-7" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>`;

                        // Ikona dla Ukoczonych (Check)
                        const iconDone = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="14" height="14" style="color: var(--success-primary);"><circle cx="12" cy="12" r="10" fill="none" stroke="currentColor" stroke-width="2"/><path d="M7 12l3 3 7-7" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>`;

                        return `
                        <div class="member-pill" style="width: 100%; justify-content: flex-start; border-radius: 4px; margin-bottom: 4px; cursor: default; background-color: var(--bg-secondary);">
                            ${renderAvatarHTML(user, 'member-pill-avatar')}
                            <span style="margin-left: 8px; font-size: 13px;">${user.name || user.email}</span>
                            ${isDone ? iconDone : iconPending}
                        </div>`;
                    }).join('');

                    // 2. Przycisk akcji dla obecnego u偶ytkownika
                    const currentUserId = state.currentUser.uid;
                    let actionButton = '';
                    
                    if (selectedAssignees.includes(currentUserId)) {
                        const isMyPartDone = (subtask && subtask.completedBy || []).includes(currentUserId);
                        
                        if (isMyPartDone) {
                            actionButton = `
                                <div style="margin-top: 12px; font-size: 12px; color: var(--success-primary); font-weight: 600; text-align: center;">
                                     Ukoczye/a swoj cz
                                </div>
                                <button class="btn btn-secondary btn-sm js-subtask-toggle-my-part" data-main-task-id="${mainTaskId}" data-subtask-id="${subtaskId}" style="width: 100%; margin-top: 8px; font-size: 12px;">Cofnij ukoczenie</button>
                            `;
                        } else {
                            actionButton = `
                                <button class="btn btn-primary js-subtask-toggle-my-part" data-main-task-id="${mainTaskId}" data-subtask-id="${subtaskId}" style="width: 100%; margin-top: 12px; justify-content: center;">
                                     Oznacz moj cz jako wykonan
                                </button>
                            `;
                        }
                    } else {
                        actionButton = `<p style="font-size: 12px; color: var(--text-secondary); text-align: center; margin-top: 12px;">Nie jeste przypisany do tego podzadania.</p>`;
                    }

                    statusContainer.innerHTML = `
                        <span style="font-size: 11px; font-weight: 600; color: var(--text-secondary); margin-bottom: 4px; text-transform: uppercase;">Postp zespou:</span>
                        ${usersListHTML}
                        ${actionButton}
                    `;

                } else {
                    // Tryb Single
                    statusContainer.style.display = 'none';
                    // USUNITO: singleInfo.style.display = 'block';
                }
                // === KONIEC NOWEJ LOGIKI ===

            } else {
                // --- TRYB TWORZENIA ---
                subtaskModal.modalTitle.textContent = 'Dodaj podzadanie';
                subtaskModal.subtaskIdInput.value = '';
                
                // === NOWE: Domylny status i priorytet ===
                subtaskModal.statusSelect.value = 'todo';
                if (subtaskModal.prioritySelect) subtaskModal.prioritySelect.value = 'medium';
                
                // Reset ostrze偶e
                if (subtaskModal.warningOverride) {
                    subtaskModal.warningOverride.checked = false;
                    subtaskModal.warningWrapper.style.display = 'none';
                    subtaskModal.warningDaysInput.value = 3;
                }
                // === KONIEC ===

                // Domylnie przypisz tych samych co w zadaniu g贸wnym
                selectedAssignees = mainTask.assignees || [];
                
                // Domylne daty: Dzi
            const today = new Date().toISOString().split('T')[0];
            subtaskModal.startDateDate.value = today;
            // Jeli zadanie g贸wne ma daty, walidator przypilnuje zakres贸w

            // === NOWE: Ukryj przycisk "Zakocz" przy tworzeniu nowego podzadania ===
            if (subtaskModal.finishBtn) {
                subtaskModal.finishBtn.style.display = 'none';
            }
            // === KONIEC ===
        }
        
        // Inicjalizacja wzmianek (Tribute) w polu komentarza
            // U偶ywamy tej samej logiki co w g贸wnym zadaniu
            if (typeof Tribute !== 'undefined' && !window.subtaskTributeInstance) {
                 try {
                    window.subtaskTributeInstance = new Tribute({
                        trigger: '@',
                        values: (text, cb) => {
                            const users = project.members.map(findUser).filter(Boolean).map(u => ({
                                name: u.name || u.email,
                                value: (u.name || u.email).replace(/[^a-zA-Z0-9]/g, ''),
                                avatarHTML: renderAvatarHTML(u, 'avatar-mention')
                            }));
                            cb(users);
                        },
                        lookup: 'name',
                        itemTemplate: item => `${item.original.avatarHTML} <span>${item.original.name}</span>`,
                        selectTemplate: item => `@${item.original.value}`,
                        allowSpaces: false,
                        menuItemLimit: 5
                    });
                    window.subtaskTributeInstance.attach(subtaskModal.commentInput);
                } catch (e) { console.error("Tribute subtask init error", e); }
            }

            // 1. Zbuduj list os贸b (Lewa kolumna)
            buildTeamMembersAccordion(
                subtaskModal.assigneesList, 
                selectedAssignees, 
                project.ownerId, 
                project.admins || [],
                false // Nie blokuj
            );

            // 2. Zbuduj list wybranych (Prawa kolumna)
            renderSelectedMembersColumn(
                subtaskModal.assigneesList,
                subtaskModal.selectedList,
                null, [], []
            );
            
            // Wcz wyszukiwark dla tej listy
            setupUserSearch(subtaskModal.memberSearchInput, subtaskModal.memberSearchResults, subtaskModal.assigneesList);

           openModal(subtaskModal.overlay);

            // === NOWA LOGIKA PRZECZANIA ZAKADKI ===
            const tabToOpen = initialTab || 'description';
            const tabBtn = subtaskModal.tabsContainer.querySelector(`.task-modal-tab[data-tab="${tabToOpen}"]`);
            
            if (tabBtn) {
                tabBtn.click();
            } else {
                const defaultTab = subtaskModal.tabsContainer.querySelector('[data-tab="description"]');
                if (defaultTab) defaultTab.click();
            }

            // === NOWE: Automatyczny fokus na tytu podzadania ===
            setTimeout(() => {
                if (subtaskModal.titleInput) {
                    subtaskModal.titleInput.focus();
                }
            }, 100); // Kr贸tkie op贸藕nienie dla pewnoci renderowania
            // === KONIEC ===
        }

           

        // Helper: Obsuga dodawania plik贸w w modalu podzadania
        subtaskModal.addAttachmentBtn.addEventListener('click', () => subtaskModal.attachmentInput.click());
        
        subtaskModal.attachmentInput.addEventListener('change', (e) => {
            const files = Array.from(e.target.files);
            files.forEach(file => {
                if (file.size > 15 * 1024 * 1024) {
                    showNotification(`Plik ${file.name} jest za du偶y (max 15MB).`, "Bd");
                    return;
                }
                subtaskStagedFiles.push(file);
            });
            renderSubtaskStagedFiles();
            e.target.value = '';
        });

        function renderSubtaskStagedFiles() {
            // Renderuje TYLKO nowe pliki (te z subtaskStagedFiles) na kocu listy
            // Czycimy list, ale musimy zachowa istniejce (w trybie edycji). 
            // Uproszczenie: w openSubtaskModal czycimy list i dodajemy istniejce. 
            // Tutaj dodajemy "oczekujce".
            
            // Usu stare elementy "oczekujce" z DOM
            const oldStaged = subtaskModal.attachmentsList.querySelectorAll('.is-staged');
            oldStaged.forEach(el => el.remove());

            subtaskStagedFiles.forEach((file, index) => {
                const li = document.createElement('li');
                li.className = 'staged-attachment-item is-staged';
                li.innerHTML = `
                    <div class="staged-attachment-info">
                        <span>(Nowy) ${file.name}</span>
                    </div>
                    <button type="button" class="delete-staged-subtask-att-btn" data-index="${index}">&times;</button>
                `;
                subtaskModal.attachmentsList.appendChild(li);
            });
        }

        // Delegacja usuwania plik贸w oczekujcych
        subtaskModal.attachmentsList.addEventListener('click', (e) => {
            if (e.target.classList.contains('delete-staged-subtask-att-btn')) {
                const idx = e.target.dataset.index;
                subtaskStagedFiles.splice(idx, 1);
                renderSubtaskStagedFiles();
            }
            // Tutaj mo偶na doda logik usuwania istniejcych zacznik贸w (delete-subtask-existing-att-btn)
            // ale wymagaoby to skomplikowanej logiki "oznaczania do usunicia" przed zapisem.
            // Na ten moment pomimy usuwanie istniejcych plik贸w w podzadaniach dla uproszczenia.
        });

        // Obsuga bud偶etu w podzadaniu (UI)
        subtaskModal.budgetToggle.addEventListener('change', () => {
            subtaskModal.budgetDetails.style.display = subtaskModal.budgetToggle.checked ? 'block' : 'none';
        });
        subtaskModal.addBudgetItemBtn.addEventListener('click', () => {
            const mainTaskId = subtaskModal.overlay.dataset.mainTaskId;
            const { project } = findTask(mainTaskId);
            
            // ZMIANA: Zabezpieczenie (optional chaining ?. oraz fallback do pustej tablicy)
            const safeItems = project?.budget?.items || [];
            const projectItemNames = safeItems.map(i => i.name);
            
            const newItemHTML = renderTaskBudgetItemHTML(undefined, undefined, projectItemNames);
            subtaskModal.budgetItemsList.insertAdjacentHTML('beforeend', newItemHTML);
        });
        // Delegacja usuwania wiersza bud偶etu
        subtaskModal.budgetItemsList.addEventListener('click', (e) => {
            if (e.target.classList.contains('delete-task-budget-item-btn')) {
                e.target.closest('li.budget-item').remove();
            }
        });

        // === NOWY LISTENER: Obsuga statusu wieloosobowego w MODALU PODZADANIA ===
        document.getElementById('subtask-modal').addEventListener('click', async (e) => {
            const btn = e.target.closest('.js-subtask-toggle-my-part');
            if (!btn) return;
            e.preventDefault();

            const mainTaskId = btn.dataset.mainTaskId;
            const subtaskId = btn.dataset.subtaskId;
            const currentUserId = state.currentUser.uid;

            const { task: mainTask, project } = findTask(mainTaskId);
            if (!mainTask || !project) return;

            // Klonujemy zadanie g贸wne
            let updatedMainTask = { ...mainTask };
            
            // Znajdujemy i modyfikujemy podzadanie
            let subtaskChanged = false;
            updatedMainTask.subtasks = updatedMainTask.subtasks.map(sub => {
                if (sub.id === subtaskId) {
                    // === BLOKADA: Lista kontrolna ===
                    const isChecking = !(sub.completedBy || []).includes(currentUserId);
                    if (isChecking && sub.checklist && sub.checklist.length > 0) {
                        const allChecklistDone = sub.checklist.every(i => i.isCompleted);
                        if (!allChecklistDone) {
                            showNotification("Nie mo偶na ukoczy Twojej czci. Ukocz najpierw list kontroln.", "Bd");
                            return sub; 
                        }
                    }

                    subtaskChanged = true;
                    let newCompletedBy = [...(sub.completedBy || [])];
                    
                    // Toggle obecnoci usera
                    if (newCompletedBy.includes(currentUserId)) {
                        newCompletedBy = newCompletedBy.filter(id => id !== currentUserId);
                    } else {
                        newCompletedBy.push(currentUserId);
                    }

                    // Sprawd藕 czy Wszyscy ukoczyli
                    const allAssigneesDone = (sub.assignees.length > 0) && 
                                             (sub.assignees.every(id => newCompletedBy.includes(id)));

                    // === POPRAWKA: Jawna aktualizacja statusu podzadania ===
                    let newSubStatus = sub.status || 'todo';
                    if (allAssigneesDone) {
                        newSubStatus = 'done';
                    } else if (newCompletedBy.length > 0) {
                        newSubStatus = 'inprogress';
                    }

                    return { 
                        ...sub, 
                        completedBy: newCompletedBy, 
                        isCompleted: allAssigneesDone,
                        status: newSubStatus // <-- DODANO: Zapisujemy status tekstowy
                    };
                }
                return sub;
            });

            if (!subtaskChanged) return;

            const projectDocRef = findProject(project.id) ? doc(projectsRef, project.id) : doc(completedProjectsRef, project.id);
            
            try {
                btn.disabled = true; 
                
                // Zapisz aktualizacj
                await updateDoc(projectDocRef, { tasks: updatedMainTask.tasks || project.tasks.map(t => t.id === mainTaskId ? updatedMainTask : t) });
                
                // Sprawd藕 autouzupenianie
                await checkAndCompleteMainTask(updatedMainTask, project);
                
                // === NAPRAWA: U偶ywamy poprawnej nazwy nowej funkcji ===
                await checkSubtasksAndCompleteParticipants(updatedMainTask, project);

                // Odwie偶 modal
                openSubtaskModal(mainTaskId, subtaskId);
                
                // === NOWE: WYSANIE POWIADOMIE (MULTI-USER SUBTASK) ===
                // Sprawdzamy zaktualizowan wersj z pamici
                const justUpdatedSubtask = updatedMainTask.subtasks.find(s => s.id === subtaskId);
                // Jeli po mojej akcji isCompleted == true, wylij powiadomienie
                if (justUpdatedSubtask && justUpdatedSubtask.isCompleted) {
                     sendSubtaskCompletionNotifications(justUpdatedSubtask, updatedMainTask, project);
                }
                // === KONIEC ===

                showNotification("Status podzadania zaktualizowany.", "Sukces");

            } catch (error) {
                console.error("Bd aktualizacji statusu podzadania:", error);
                showNotification("Wystpi bd.", "Bd");
                btn.disabled = false;
            }
        });
        // === KONIEC NOWEGO LISTENERA ===
        
        // === KONIEC NOWEJ, BRAKUJCEJ FUNKCJI ===
       // === PRZENIESIONE FUNKCJE (NAPRAWA BDU ReferenceError) ===

       // Dodano parametr isOverride = false
        function createSubtaskItemHTML(subtask, canDelete, isOverride = false) {
            const assigneesHTML = (subtask.assignees || [])
                .map(userId => findUser(userId))
                .filter(Boolean)
                .map(user => renderAvatarHTML(user)) 
                .join('');
            
            // Uprawnienie ma Przypisany LUB Admin/Waciciel (Override)
            const canIComplete = (subtask.assignees || []).includes(state.currentUser.uid) || isOverride;
            const isCompletedByMe = (subtask.completedBy || []).includes(state.currentUser.uid);

            const deleteBtnHTML = canDelete ? `
                <button type="button" class="subtask-action-btn delete" title="Usu podzadanie">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0" /></svg>
                </button>` : '';

            // === NOWE: Formatowanie daty i status op贸藕nienia (FLAGA) ===
            let dateHTML = '';
            if (subtask.dueDate) {
                const dateObj = new Date(subtask.dueDate);
                const dateStr = dateObj.toLocaleDateString('pl-PL', { day: 'numeric', month: 'short' }); // Np. 22 lis
                const isOverdue = !subtask.isCompleted && dateObj.getTime() < new Date().setHours(0,0,0,0);
                
                // Ikona Flagi
                const flagIconSVG = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" style="width:12px;height:12px;"><path stroke-linecap="round" stroke-linejoin="round" d="M3 3v1.5M3 21v-6m0 0l2.77-.693a9 9 0 0 1 6.208.682l.108.054a9 9 0 0 0 6.086.71l3.114-.732a48.524 48.524 0 0 1-.005-10.499l-3.11.732a9 9 0 0 1-6.085-.711l-.108-.054a9 9 0 0 0-6.208-.682L3 4.5M3 15V4.5" /></svg>`;

                dateHTML = `
                    <span class="subtask-item-date ${isOverdue ? 'overdue' : ''}" title="Termin wykonania">
                        ${flagIconSVG}
                        ${dateStr}
                    </span>
                `;
            }

            // === NOWE: Uchwyt do przecigania (6 kropek) ===
            const dragHandleHTML = `
                <div class="subtask-drag-handle" title="Przesu, aby zmieni kolejno">
                   <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" style="width:16px;height:16px;">
                      <path fill-rule="evenodd" d="M3 6a3 3 0 013-3h2.25a3 3 0 013 3v2.25a3 3 0 01-3 3H6a3 3 0 01-3-3V6zm9.75 0a3 3 0 013-3H18a3 3 0 013 3v2.25a3 3 0 01-3 3h-2.25a3 3 0 01-3-3V6zM3 15.75a3 3 0 013-3h2.25a3 3 0 013 3V18a3 3 0 01-3 3H6a3 3 0 01-3-3v-2.25zm9.75 0a3 3 0 013-3H18a3 3 0 013 3V18a3 3 0 01-3 3h-2.25a3 3 0 01-3-3v-2.25z" clip-rule="evenodd" />
                    </svg>
                </div>
            `;

            return `
                <li class="subtask-item ${subtask.isCompleted ? 'completed' : ''}" data-subtask-id="${subtask.id}">
                    ${dragHandleHTML} <input type="checkbox" 
                           class="subtask-checkbox" 
                           data-subtask-id="${subtask.id}" 
                           ${isCompletedByMe ? 'checked' : ''} 
                           ${!canIComplete ? 'disabled' : ''}
                           title="${canIComplete ? 'Oznacz swoj cz' : 'Nie jeste przypisany/a'}">
                    <span class="subtask-item-title">${subtask.title}</span>
                    
                    ${dateHTML} <div class="subtask-assignees">${assigneesHTML}</div>
                    
                    <div class="subtask-actions">
                        ${deleteBtnHTML}
                    </div>
                </li>
            `;
        }
        // Zmienna globalna na instancj Sortable dla subzada
        let subtaskSortableInstance = null;
        // Zmienna globalna na kierunek sortowania podzada ('asc', 'desc' lub null/original)
        let currentSubtaskSortOrder = 'original';

        function renderSubtaskListInMainModal(task) {
            const subtasksCounter = document.getElementById('subtasks-counter');
            if (subtasksCounter) {
                subtasksCounter.textContent = `(${(task.subtasks || []).length})`;
            }
            subtasksListMain.innerHTML = '';
            
            if (!task.subtasks || task.subtasks.length === 0) {
                 subtasksListMain.innerHTML = '<li style="color: var(--text-secondary); font-style: italic; padding: 8px 0;">Brak podzada.</li>';
                 return;
            }

            const { project } = findTask(task.id);
            // Rozszerzona weryfikacja uprawnie (Waciciel LUB Admin LUB Tw贸rca zadania)
            const isOwnerOrAdmin = project && (project.ownerId === state.currentUser.uid || (project.admins || []).includes(state.currentUser.uid));
            const canDelete = isOwnerOrAdmin || (task.createdBy === state.currentUser.uid);
            
            // Nowa flaga Override (dla checkboxa)
            const isOverride = isOwnerOrAdmin;

            // === LOGIKA SORTOWANIA ===
            let displaySubtasks = [...(task.subtasks || [])];
            
            if (currentSubtaskSortOrder === 'asc') {
                displaySubtasks.sort((a, b) => {
                    const dateA = a.dueDate ? new Date(a.dueDate).getTime() : Infinity;
                    const dateB = b.dueDate ? new Date(b.dueDate).getTime() : Infinity;
                    return dateA - dateB;
                });
            } else if (currentSubtaskSortOrder === 'desc') {
                 displaySubtasks.sort((a, b) => {
                    const dateA = a.dueDate ? new Date(a.dueDate).getTime() : Infinity;
                    const dateB = b.dueDate ? new Date(b.dueDate).getTime() : Infinity;
                    return dateB - dateA;
                });
            }
            // Jeli 'original', nie sortujemy (u偶ywamy kolejnoci z bazy)

            const subtasksHTML = displaySubtasks
                .map(subtask => createSubtaskItemHTML(subtask, canDelete))
                .join('');
            subtasksListMain.innerHTML = subtasksHTML;

            // === Inicjalizacja SortableJS (Drag & Drop) ===
            if (subtaskSortableInstance) {
                subtaskSortableInstance.destroy();
            }
            
            subtaskSortableInstance = new Sortable(subtasksListMain, {
                animation: 150,
                handle: '.subtask-drag-handle', // Przesuwanie tylko za uchwyt
                ghostClass: 'sortable-ghost',
                onEnd: async (evt) => {
                    // Jeli u偶ytkownik przesunie element, traktujemy to jako now "oryginaln" kolejno
                    currentSubtaskSortOrder = 'original'; 
                    
                    // Zaktualizuj wygld przycisku sortowania
                    updateSubtaskSortBtnStyle();

                    const newOrderIds = Array.from(subtasksListMain.children).map(li => li.dataset.subtaskId);
                    
                    // Przebuduj tablic subtasks w oparciu o now kolejno z DOM
                    const newSubtasksArray = newOrderIds.map(id => task.subtasks.find(s => s.id === id)).filter(Boolean);
                    
                    // Zaktualizuj obiekt task lokalnie
                    task.subtasks = newSubtasksArray;
                    
                    // Zapisz do Firestore
                    const projectDocRef = findProject(project.id) ? doc(projectsRef, project.id) : doc(completedProjectsRef, project.id);
                    const allTasks = project.tasks.map(t => t.id === task.id ? task : t);
                    
                    try {
                        await updateDoc(projectDocRef, { tasks: allTasks });
                        console.log('Kolejno podzada zaktualizowana.');
                    } catch (error) {
                        console.error('Bd zapisu kolejnoci podzada:', error);
                        showNotification('Nie udao si zapisa kolejnoci.', 'Bd');
                    }
                }
            });
            
            updateSubtaskSortBtnStyle();
        }

        // Funkcja pomocnicza do stylizacji przycisku
        function updateSubtaskSortBtnStyle() {
            const btn = document.getElementById('subtasks-sort-btn');
            if (!btn) return;
            
            btn.classList.remove('sort-asc', 'sort-desc');
            // Dodajemy klasy pomocnicze, jeli zdefiniowane w CSS (np. obr贸t ikony), lub zostawiamy domylny wygld
            if (currentSubtaskSortOrder === 'asc') btn.classList.add('sort-asc');
            if (currentSubtaskSortOrder === 'desc') btn.classList.add('sort-desc');
            
            // Opcjonalnie zmiana koloru ta dla aktywnego sortowania
            btn.style.backgroundColor = currentSubtaskSortOrder !== 'original' ? 'var(--bg-tertiary)' : 'var(--bg-primary)';
        }

        // LISTENER DLA PRZYCISKU SORTOWANIA
        // (Umieszczony tutaj, aby mie dostp do funkcji renderujcej)
        document.getElementById('subtasks-sort-btn')?.addEventListener('click', (e) => {
            e.stopPropagation(); // Zapobiegnij zwijaniu akordeonu
            const taskId = taskModal.overlay.dataset.taskId;
            const { task } = findTask(taskId);
            if (!task) return;

            // Cykl: original -> asc -> desc -> original
            if (currentSubtaskSortOrder === 'original') currentSubtaskSortOrder = 'asc';
            else if (currentSubtaskSortOrder === 'asc') currentSubtaskSortOrder = 'desc';
            else currentSubtaskSortOrder = 'original';
            
            renderSubtaskListInMainModal(task);
        });

            

        // === KONIEC PRZENIESIONYCH FUNKCJI ===

        // === NOWA FUNKCJA (NAPRAWA BDU 2) ===
        /**
         * Buduje list piguek WYCZNIE dla czonk贸w danego projektu.
         * Zastpuje 'buildTeamMembersAccordion' w modalu podzadania.
         */
        function buildSubtaskAssigneePills(containerElement, projectMemberIds = [], selectedMemberIds = []) {
            containerElement.innerHTML = ''; // Wyczy kontener

            if (projectMemberIds.length === 0) {
                containerElement.innerHTML = '<li style="color: var(--text-secondary); font-style: italic;">Brak czonk贸w w projekcie.</li>';
                return;
            }

            // Iteruj tylko po ID czonk贸w projektu
            projectMemberIds.forEach(userId => {
                const user = findUser(userId);
                if (!user) return; // Pomi, jeli nie znaleziono u偶ytkownika (powinno si zdarzy rzadko)

                const isSelected = selectedMemberIds.includes(user.id);
                const avatarHTML = renderAvatarHTML(user, 'member-pill-avatar');
                
                const pill = document.createElement('div');
                pill.className = `member-pill ${isSelected ? 'selected' : ''}`;
                pill.dataset.userId = user.id;
                pill.title = user.name || user.email;
                pill.innerHTML = `${avatarHTML} <span>${user.name || user.email}</span>`;
                containerElement.appendChild(pill);
            });
        }
        // === KONIEC NOWEJ FUNKCJI ===
        // NOWA FUNKCJA POMOCNICZA DO TUMACZENIA WZMIANEK
        function parseMentions(text) {
            if (!text) return ''; // Zabezpieczenie przed pustym tekstem
            
            // Regex pasujcy do "czystej" nazwy (np. MateuszCzerwinski lub wlascicieltestcom)
            const mentionRegex = /@([a-zA-Z0-9]+)/g;
            
            // Przechodzimy przez tekst i zamieniamy wszystkie dopasowania
            return text.replace(mentionRegex, (match, cleanNameValue) => {
                // Szukamy u偶ytkownika, por贸wnujc jego "czyst" nazw z wartoci ze wzmianki
                const user = state.users.find(u => 
                    (u.name || u.email).replace(/[^a-zA-Z0-9]/g, '') === cleanNameValue
                );
                
                if (user) {
                    // Jeli znaleziono, zwracamy pen nazw lub e-mail
                    return `<strong class="comment-mention" title="${user.name || user.email}">@${user.name || user.email}</strong>`;
                }
                
                // Jeli nie znaleziono, zwr贸 oryginalny tekst (np. @MateuszCzerwinski)
                return match;
            });
        }
        function renderComments(task) {
    taskModal.commentsList.innerHTML = '';
    const comments = task.comments || [];
    comments.sort((a, b) => b.timestamp - a.timestamp).forEach(comment => {
        const user = findUser(comment.userId);
        const userName = user ? (user.name || user.email) : 'Nieznany U偶ytkownik';

        let deleteButtonHTML = '';
        if (comment.userId === state.currentUser.uid) {
            const commentId = comment.id || `comment_${comment.timestamp}`;
            deleteButtonHTML = `<button class="delete-comment-btn" data-comment-id="${commentId}" title="Usu komentarz">&times;</button>`;
        }

        const li = document.createElement('li');
        li.className = 'comment-item';
        li.innerHTML = `
                ${deleteButtonHTML}
                <div class="comment-author">
                    ${renderAvatarHTML(user, 'avatar-comment')}
                    <span>${userName}</span>
                    <small style="color: var(--text-secondary); font-weight: 400;">${new Date(comment.timestamp).toLocaleString('pl-PL', { day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' })}</small>
                </div>
                <p>${parseMentions(comment.text)}</p>
            `;
        taskModal.commentsList.appendChild(li);
    });
}

        function renderActivityLog(task) {
            taskModal.activityList.innerHTML = '';
            task.activityLog.sort((a, b) => b.timestamp - a.timestamp).forEach(log => {
                const user = findUser(log.userId);
                const userName = user ? (user.name || user.email) : 'Nieznany U偶ytkownik';
                const dateStr = new Date(log.timestamp).toLocaleString('pl-PL', {
                    day: '2-digit',
                    month: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                let message = '';
                if (log.type === 'status') {
                    // Zabezpieczamy nazwy klas (usuwamy spacje, polskie znaki)
                    // lub po prostu u偶ywamy jednej klasy dla status贸w, bo kolory s i tak w CSS dla 'status-change'
                    // Tutaj dla uproszczenia i bezpieczestwa nadaj po prostu styl badge'a
                    
                    // Jeli chcesz zachowa kolory:
                    // status-done = zielony, status-todo = czerwony, reszta = niebieski
                    
                    const getBadgeClass = (label) => {
                        if (label === 'Wykonane') return 'status-done';
                        if (label === 'Do realizacji') return 'status-todo';
                        return 'status-inprogress'; // Wszystkie inne (W trakcie, Do akceptacji...) s niebieskie
                    };

                    const oldStatusClass = getBadgeClass(log.oldValue);
                    const newStatusClass = getBadgeClass(log.newValue);
                    
                    message = `zmieni status z <span class="status-change ${oldStatusClass}">${log.oldValue}</span> na <span class="status-change ${newStatusClass}">${log.newValue}</span>.`;
                } else if (log.type === 'priority') {
                    message = `zmieni priorytet z <strong>${log.oldValue}</strong> na <strong>${log.newValue}</strong>.`;
                } else if (log.type === 'comment') {
                    message = `doda nowy komentarz.`;
                } else if (log.type === 'completion') {
                    message = `oznaczy swoj cz zadania jako <span class="status-change status-done">Wykonan</span>.`;
                }

                const li = document.createElement('li');
                li.className = 'activity-item';
                li.innerHTML = `[${dateStr}] <strong>${userName}</strong> ${message}`;
                taskModal.activityList.appendChild(li);
            });
        }
        
        /**
         * Zwraca list WSZYSTKICH aktywnoci dla WSZYSTKICH zada w projektach,
         * w kt贸rych zalogowany u偶ytkownik jest czonkiem.
         * U偶ywane do agregowania danych na Dashboardzie.
         */
        function getAllActivitiesFromMyProjects() {
            // 1. Zbierz wszystkie projekty, w kt贸rych bierze udzia zalogowany u偶ytkownik.
            const userProjects = [...state.projects, ...state.completedProjects].filter(p => p.members.includes(state.currentUser.uid));
        
            // 2. Zbierz wszystkie aktywnoci ze wszystkich zada w tych projektach.
            return userProjects.flatMap(project =>
                (project.tasks || []).flatMap(task =>
                    (task.activityLog || []).map(log => ({
                        ...log,
                        taskId: task.id,
                        taskTitle: task.title,
                        projectId: project.id,
                        projectName: project.name
                    }))
                )
            );
        }


        function addActivity(task, type, oldValue = null, newValue = null) {
            const activity = {
                type: type,
                userId: state.currentUser.uid,
                timestamp: Date.now(),
                oldValue: oldValue,
                newValue: newValue,
            };
            task.activityLog = [...(task.activityLog || []), activity];
            return task;
        }

        async function saveTaskFromModal() {
            // === UX FIX: Natychmiastowy feedback ===
            const saveBtn = taskModal.saveBtn;
            const originalText = saveBtn.textContent; // Zapamitaj "Zapisz zmiany"
            saveBtn.disabled = true;
            saveBtn.textContent = 'Zapisywanie...';

            // Funkcja pomocnicza do resetowania przycisku w razie bdu walidacji
            const resetBtnState = () => {
                saveBtn.disabled = false;
                saveBtn.textContent = originalText;
            };
            // === KONIEC UX FIX ===

            const taskId = taskModal.overlay.dataset.taskId;
            const {
                task,
                project
            } = findTask(taskId);
            
            if (!task || !project) {
                resetBtnState(); // <-- Reset
                return;
            }

            // Zapisujemy star list przypisanych os贸b PRZED wprowadzeniem zmian
            const oldAssignees = task.assignees || [];

            const newTitle = taskModal.titleInput.value.trim();
            if (!newTitle) {
                showNotification("Tytu zadania nie mo偶e by pusty.", "Bd");
                resetBtnState(); // <-- Reset przy bdzie
                return;
            }

            const newAssignees = Array.from(taskModal.assigneesContainer.querySelectorAll('.member-pill.selected')).map(pill => pill.dataset.userId);
          

            const newType = newAssignees.length > 1 ? 'multi' : 'single';
            const oldStatus = task.status;
            // === ZMIANA: Parsowanie wybranego statusu ===
            const selectedStatusValue = taskModal.status.value;
            let newStatus = 'todo'; // Domylnie
            let newCustomColumnId = null;

            if (selectedStatusValue === 'done') {
                newStatus = 'done';
            } else if (selectedStatusValue === 'todo') {
                newStatus = 'todo';
            } else if (selectedStatusValue === 'inprogress') {
                newStatus = 'inprogress';
                newCustomColumnId = null; // Czyste "W trakcie"
            } else if (selectedStatusValue.startsWith('CUSTOM_COL:')) {
                // To jest nasza niestandardowa kolumna!
                newStatus = 'inprogress'; // Technicznie nadal "W trakcie"
                newCustomColumnId = selectedStatusValue.replace('CUSTOM_COL:', ''); // Wycigamy ID
            }
           // === KONIEC ZMIANY ===
            const oldPriority = task.priority;
            const newPriority = taskModal.priority.value;
            
            // === NOWE: Zbieranie danych ostrze偶e ===
            const warningOverride = taskModal.warningOverride ? taskModal.warningOverride.checked : false;
            let warningDays = null;
            if (warningOverride && taskModal.warningDaysInput) {
                warningDays = parseInt(taskModal.warningDaysInput.value, 10) || 3;
            }
            // === KONIEC ===

            // === LOGIKA ZAPISU WYSIKU ===
            let newEstimation = null;
            let newActualEffort = null;
            
            const hasSubtasks = task.subtasks && task.subtasks.length > 0;
            
            if (hasSubtasks) {
                // Jeli s podzadania, rodzic jest sum. Nie pobieramy z input贸w.
                // Zachowujemy obecne wartoci (kt贸re s sum obliczon przy zmianie podzada)
                // LUB przeliczamy je na wie偶o (bezpieczniej)
                newEstimation = task.subtasks.reduce((acc, sub) => acc + (parseFloat(sub.effort) || 0), 0);
                newActualEffort = task.subtasks.reduce((acc, sub) => acc + (parseFloat(sub.actualEffort) || 0), 0);
                
                if (newEstimation === 0) newEstimation = null;
                if (newActualEffort === 0) newActualEffort = null;
                
            } else {
                // Tryb pojedynczy - pobierz z input贸w
                const newEstimationValue = parseFloat(taskModal.effortInput.value);
                newEstimation = (newEstimationValue > 0) ? newEstimationValue : null;
                const newActualEffortValue = parseFloat(taskModal.actualEffortInput.value);
                newActualEffort = (newActualEffortValue > 0) ? newActualEffortValue : null;
            }
            // === NOWA BLOKADA POWIZANIA ===
            if (newStatus === 'done' && oldStatus !== 'done') { 
                const block = isTaskBlocked(task);
                if (block.blocked) {
                    showNotification(`Najpierw musisz ukoczy zadanie "${block.taskName}".`, "Bd");
                    taskModal.status.value = oldStatus; 
                    resetBtnState(); // <-- Reset
                    return; 
                }
            }
            // === KONIEC NOWEJ BLOKADY ===

            if (task.type === 'multi' && newStatus === 'done' && task.completedBy.length < newAssignees.length) {
                showNotification("Nie mo偶na oznaczy zadania jako 'Wykonane', dop贸ki wszyscy przypisani czonkowie nie ukocz swojej czci.", "Bd");
                taskModal.status.value = oldStatus;
                resetBtnState(); // <-- Reset
                return;
            }

            let updatedTask = {
                ...task,
                title: newTitle,
                assignees: newAssignees,
                type: newType,
                description: taskModal.description.value,
                status: newStatus,
                customColumnId: newCustomColumnId, // <--- DODANO: Zapisujemy ID kolumny
                priority: newPriority,
                // dueDate: taskModal.dueDate.value, // USUNITE
                // === NOWE POLA ===
                warningOverride: warningOverride,
                warningDays: warningDays,
                // === KONIEC ===
                // === NOWA LOGIKA: czenie daty i czasu z 3 p贸l ===
                // === NOWA LOGIKA: czenie daty i czasu z 3 p贸l ===
                startDate: (taskModal.startDateDate.value && taskModal.startDateHour.value && taskModal.startDateMinute.value)
                         ? `${taskModal.startDateDate.value}T${taskModal.startDateHour.value}:${taskModal.startDateMinute.value}`
                         : null,
                dueDate: (taskModal.dueDateDate.value && taskModal.dueDateHour.value && taskModal.dueDateMinute.value)
                         ? `${taskModal.dueDateDate.value}T${taskModal.dueDateHour.value}:${taskModal.dueDateMinute.value}`
                         : null,
                // === KONIEC ZMIANY ===
                estimation: newEstimation,
                
                // === POCZTEK NOWEGO KODU ===
                actualEffort: newActualEffort,
                // === KONIEC NOWEGO KODU ===
                
                completedAt: (newStatus === 'done') ? Timestamp.now() : null // <<< MODYFIKACJA
            };
            // === NOWA WALIDACJA DAT ===
            if (updatedTask.startDate && updatedTask.dueDate) {
                if (new Date(updatedTask.dueDate) <= new Date(updatedTask.startDate)) {
                    showNotification("Termin wykonania musi by p贸藕niejszy ni偶 data rozpoczcia.", "Bd");
                    resetBtnState(); // <-- Reset
                    return; 
                }
            }
           // === KONIEC WALIDACJI ===
            if (taskModal.completed && taskModal.completed.checked && updatedTask.status !== 'done') {
                updatedTask.status = 'done';
            }

            if (taskModal.isRecurring.checked) {
                const type = taskModal.recurrenceType.value;
                updatedTask.recurrence = {
                    type: type
                };
                if (type === 'dayOfMonth') {
                    updatedTask.recurrence.day = parseInt(taskModal.recurrenceDay.value) || 1;
                } else if (type === 'nthDayOfMonth') {
                    updatedTask.recurrence.nth = document.getElementById('modal-task-recurrence-nth').value;
                    updatedTask.recurrence.weekday = document.getElementById('modal-task-recurrence-weekday').value;
                }
            } else {
                updatedTask.recurrence = null;
            }
            // <<<===== POCZTEK NOWEGO KODU =====>>>
    // --- NOWA LOGIKA ZAPISU BUD呕ETU ZADANIA ---
    let taskBudgetItems = null;
    let budgetValidationError = null;

    if (hasSubtasks) {
        // Tryb rodzica: Bud偶et jest sum podzada.
        // Pobieramy go bezporednio z podzada, a nie z UI rodzica.
        const aggregatedItems = [];
        task.subtasks.forEach(sub => {
            if (sub.budgetItems) {
                sub.budgetItems.forEach(item => {
                     aggregatedItems.push(item);
                });
            }
        });
        taskBudgetItems = aggregatedItems.length > 0 ? aggregatedItems : null;
        
    } else {
        // Tryb pojedynczy: Pobierz z input贸w (tak jak byo)
        if (taskModal.budgetToggle.checked) {
            taskBudgetItems = [];
            const itemsLi = taskModal.budgetItemsList.querySelectorAll('li.budget-item');
            
            itemsLi.forEach(itemLi => {
                const nameSelect = itemLi.querySelector('.task-budget-item-name');
                const amountInput = itemLi.querySelector('.task-budget-item-amount');
                const name = nameSelect.value;
                const amount = parseFloat(amountInput.value) || 0;

                if (!name && amount > 0) {
                    budgetValidationError = "Ka偶da pozycja kosztowa z kwot musi mie wybran nazw.";
                    nameSelect.focus();
                } else if (name && amount <= 0) {
                    budgetValidationError = `Kwota dla pozycji "${name}" musi by wiksza od zera.`;
                    amountInput.focus();
                } else if (name && amount > 0) {
                    taskBudgetItems.push({ name, amount });
                }
            });

            if (budgetValidationError) {
                taskModal.budgetErrorP.textContent = budgetValidationError;
                if (!taskModal.budgetTabButton.classList.contains('active')) {
                    taskModal.budgetTabButton.click();
                }
                resetBtnState(); // <-- Reset (DODANO)
                return; 
            }

            if (taskBudgetItems.length === 0) {
                taskBudgetItems = null;
            }
        }
    }
    // Zapisz wynik (tablic obiekt贸w lub null) do aktualizowanego zadania
    updatedTask.budgetItems = taskBudgetItems;
     // --- KONIEC NOWEJ LOGIKI ZAPISU BUD呕ETU ZADANIA ---
     // <<<===== KONIEC NOWEGO KODU =====>>>
            // === ZMIANA: Dokadniejsze logowanie zmiany statusu ===
            // Sprawdzamy czy zmieni si status g贸wny LUB kolumna niestandardowa
            const oldCustomId = task.customColumnId || null;
            if (oldStatus !== newStatus || oldCustomId !== newCustomColumnId) {
                // U偶ywamy naszej nowej funkcji pomocniczej do pobrania adnych nazw
                const oldLabel = getTaskStatusLabel(task, project);
                
                // Tworzymy tymczasowy obiekt "nowego zadania" tylko po to, by pobra etykiet
                const tempNewTask = { ...updatedTask, status: newStatus, customColumnId: newCustomColumnId };
                const newLabel = getTaskStatusLabel(tempNewTask, project);

                updatedTask = addActivity(updatedTask, 'status', oldLabel, newLabel);
            }
            // === KONIEC ZMIANY ===
            if (oldPriority !== newPriority) {
                updatedTask = addActivity(updatedTask, 'priority', oldPriority, newPriority);
            }

            let tasks = project.tasks.map(t => (t.id === taskId ? updatedTask : t));

            if (oldStatus !== 'done' && newStatus === 'done' && updatedTask.recurrence) {
                const nextDueDate = calculateNextDueDate(updatedTask.dueDate, updatedTask.recurrence);
                const nextTask = {
                    ...updatedTask,
                    id: `task${Date.now()}`,
                    status: 'todo',
                    dueDate: nextDueDate,
                    completedBy: [],
                    activityLog: [],
                };
                tasks.push(nextTask);
            }

            const projectDocRef = findProject(project.id) ? doc(projectsRef, project.id) : doc(completedProjectsRef, project.id);

            try {
                // --- AKTUALIZACJA LOGIKI (Wersja 2): Obliczanie i zapis budgetSummary ---
                const newBudgetSummary = calculateProjectBudgetSummary(tasks);

                // === NOWA LOGIKA: Automatyczne dodanie nowych os贸b do czonk贸w PROJEKTU (EDYCJA) ===
                let updatedProjectMembers = [...(project.members || [])];
                let membersChanged = false;

                // newAssignees jest zdefiniowane na pocztku funkcji saveTaskFromModal
                newAssignees.forEach(userId => {
                    if (!updatedProjectMembers.includes(userId)) {
                        updatedProjectMembers.push(userId);
                        membersChanged = true;
                    }
                });
                // === NOWA LOGIKA: Alert Bud偶etowy ===
            // Sprawdzamy, czy cakowity koszt przekracza bud偶et projektu
            if (project.budget && parseFloat(project.budget.amount) > 0) {
                const totalBudget = parseFloat(project.budget.amount);
                
                // === NAPRAWA BDU: U偶ycie Optional Chaining (?.) ===
                // Zabezpiecza przed sytuacj, gdy newBudgetSummary jest null/undefined
                const totalCommitted = (newBudgetSummary?.totalReserved || 0) + (newBudgetSummary?.totalSpent || 0);
                // === KONIEC NAPRAWY ===
                
                // Jeli przekroczono i wczeniej nie byo przekroczone (opcjonalne, tu sprawdzamy po prostu stan)
                if (totalCommitted > totalBudget) {
                    const overAmount = totalCommitted - totalBudget;
                    // Powiadom Waciciela Projektu (jeli to nie ja edytuj)
                    if (project.ownerId !== state.currentUser.uid) {
                        const msg = `锔 <strong>Uwaga Bud偶etowa:</strong> Zadanie "<strong>${updatedTask.title}</strong>" spowodowao przekroczenie bud偶etu projektu o ${overAmount.toLocaleString('pl-PL')} ${project.budget.currency}.`;
                        sendInternalNotification(
                            [project.ownerId],
                            'alert',
                            msg,
                            { type: 'task', projectId: project.id, taskId: updatedTask.id },
                            'budget_alert' // <--- KLUCZ USTAWIENIA
                        );
                    }
                }
            }
            // === KONIEC LOGIKI ===
                // Przygotuj obiekt aktualizacji
                const updatePayload = {
                    tasks: tasks,
                    budgetSummary: newBudgetSummary
                };

                // Jeli doszli nowi czonkowie, dodaj ich do aktualizacji
                if (membersChanged) {
                    updatePayload.members = updatedProjectMembers;
                }
                // === KONIEC NOWEJ LOGIKI ===

                // Zaktualizuj dokument projektu (atomowo)
                await updateDoc(projectDocRef, updatePayload);
                
                // Zaktualizuj stan lokalny, aby UI od razu widziao nowych czonk贸w
                if (membersChanged) {
                    project.members = updatedProjectMembers;
                }
                
                console.log(`[Budget v2 & Members] Zaktualizowano projekt ${project.id} po edycji zadania ${taskId}.`);
                // --- KONIEC AKTUALIZACJI ---
                
                // === NOWA LOGIKA - POWIADOMIENIA PRZY EDYCJI ZADANIA ===
                const newlyAssigned = newAssignees.filter(id => !oldAssignees.includes(id));
                
                if (newlyAssigned.length > 0) {
                    // Zastpujemy batch funkcj sendInternalNotification z kluczem 'task_assign'
                    sendInternalNotification(
                        newlyAssigned,
                        'task_assigned',
                        `<strong>${state.currentUser.name}</strong> przypisa/a Ci do zadania "<strong>${updatedTask.title}</strong>" w projekcie <em>${project.name}</em>.`,
                        { type: 'task', projectId: project.id, taskId: updatedTask.id },
                        'task_assign' // <--- KLUCZ USTAWIENIA
                    );
                }
                // === KONIEC NOWEJ LOGIKI ===

                if (oldStatus !== 'done' && updatedTask.status === 'done') showConfetti();
                showNotification("Zmiany w zadaniu zostay zapisane.", "Sukces");
                closeModal(taskModal.overlay);
            } catch (error) {
                console.error("Bd zapisu zmian w zadaniu:", error);
                showNotification("Wystpi bd podczas zapisu zmian.", "Bd");
                resetBtnState();
            }
        }
        
        function populateAssigneesForProject(projectId) {
            const project = findProject(projectId);
            if (!project) {
                newTaskModal.assigneeSingleSelect.innerHTML = '<option value="">Brak projektu</option>';
                newTaskModal.assigneeMultiList.innerHTML = 'Wybierz projekt, aby zobaczy czonk贸w.';
                return;
            }

            // 1. Pobierz i posortuj u偶ytkownik贸w alfabetycznie
            const membersOptions = (project.members || [])
                .map(memberId => findUser(memberId))
                .filter(Boolean)
                .sort((a, b) => (a.name || a.email).localeCompare(b.name || b.email));

            newTaskModal.assigneeSingleSelect.innerHTML = '<option value="">Nikt</option>' + membersOptions.map(u => `<option value="${u.id}">${u.name || u.email}</option>`).join('');
            
            if (membersOptions.some(u => u.id === state.currentUser.uid)) {
                newTaskModal.assigneeSingleSelect.value = state.currentUser.uid;
            }

           // 2. Wygeneruj list w nowym stylu (pionowa, numerowana)
            newTaskModal.assigneeMultiList.innerHTML = membersOptions.map((u, index) => {
                const isCurrentUser = u.id === state.currentUser.uid;
                const avatarHTML = renderAvatarHTML(u, 'member-pill-avatar'); // U偶ywamy helpera
                
                // Style dla wiersza (takie same jak w modalu projektu)
                const rowStyle = 'width: 100%; justify-content: flex-start; border-radius: 4px; margin-bottom: 4px;';
                
                // ZMIANA: Usunito klas 'disabled', aby mo偶na byo odznaczy samego siebie
                return `
                <div class="member-pill ${isCurrentUser ? 'selected' : ''}" data-user-id="${u.id}" title="${u.name || u.email}" style="${rowStyle}">
                    <span style="color: var(--text-secondary); font-size: 12px; font-weight: 600; width: 25px; text-align: right; margin-right: 8px;">${index + 1}.</span>
                    ${avatarHTML}
                    <span style="margin-left: 8px;">${u.name || u.email}</span>
                </div>`;
            }).join('');
        }

        function openNewTaskModal(options = {}) {
            const {
                isFab = false, isSpecial = false
            } = options;
            
            // --- RESET STANU TYMCZASOWEGO BANNRA ---
            newTaskTempBannerData = null;
            if (newTaskModal.openCoverGalleryBtn) {
                newTaskModal.openCoverGalleryBtn.textContent = 'Wybierz banner';
                newTaskModal.openCoverGalleryBtn.classList.remove('is-danger-btn');
                newTaskModal.openCoverGalleryBtn.dataset.action = 'open-gallery';
            }
            
            // --- RESET STANU TYMCZASOWEGO KOLORU ---
            newTaskTempColor = null;
            if (newTaskModal.openBackgroundColorBtn) {
                updateColorButtonState(newTaskModal.openBackgroundColorBtn, null);
            }
            // --- KONIEC RESETU ---

            newTaskModal.form.reset();
if (editorNewTaskDescription) {
    editorNewTaskDescription.clear(); // Wyczy edytor przy nowym zadaniu
}
            // === NOWA LOGIKA: Ustawienie domylnej daty i godziny (dla 3 p贸l) ===
            const defaultDateStr = getLocalDateString(); // Pobiera dzisiejsz dat YYYY-MM-DD
            
            // 1. Obliczanie daty JUTRZEJSZEJ
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1); // Dodaj 1 dzie
            const t_year = tomorrow.getFullYear();
            const t_month = String(tomorrow.getMonth() + 1).padStart(2, '0');
            const t_day = String(tomorrow.getDate()).padStart(2, '0');
            const tomorrowDateStr = `${t_year}-${t_month}-${t_day}`;

            // 2. Domylna data rozpoczcia (Dzi, 10:00)
            newTaskModal.startDateDate.value = defaultDateStr;
            newTaskModal.startDateHour.value = "10";
            newTaskModal.startDateMinute.value = "00";

            // 3. Domylna data zakoczenia (JUTRO, 10:00)
            newTaskModal.dueDateDate.value = tomorrowDateStr; // <-- ZMIANA: U偶ywamy jutrzejszej daty
            newTaskModal.dueDateHour.value = "10";
            newTaskModal.dueDateMinute.value = "00";
            // === KONIEC ZMIANY ===
            // Domylnie wszystko jest widoczne, logika poni偶ej mo偶e ukry.
            // Domylnie wszystko jest widoczne, logika poni偶ej mo偶e ukry.
            newTaskModal.projectGroup.style.display = 'block';
            // USUNITO: Logik pokazywania/ukrywania wrapper贸w single/multi i resetowania radio

            // NOWA LOGIKA: Inicjalizacja Tippy.js i ustawienie domylnej zakadki
            
            // ZMIANA: Ustawiamy domyln zakadk na "dueDate" (Termin)
            const defaultTab = document.getElementById('new-task-modal').querySelector('.task-modal-tab[data-tab="dueDate"]');
            if (defaultTab) {
                // 2. Klikamy po drobnym op贸藕nieniu, aby upewni si, 偶e modal jest w DOM i CSS jest zastosowany
                setTimeout(() => {
                    defaultTab.click();
                }, 50);
            }
            
            let targetProject;
            const inboxProject = state.projects.find(p => p.isInbox && p.ownerId === state.currentUser.uid);
            const isTargetingInbox = isSpecial || (isFab && state.ui.currentView === 'my-day');
            
            // ZMIENNA POMOCNICZA: Kogo zaznaczy domylnie?
            let initialAssignees = [];

            if (isSpecial) {
                // CZERWONY FAB: Zawsze kieruje do Inboxa
                if (inboxProject) {
                    newTaskModal.projectSelect.innerHTML = `<option value="${inboxProject.id}">${inboxProject.name}</option>`;
                    newTaskModal.projectGroup.style.display = 'none';
                    targetProject = inboxProject;
                }

                // Wymu przypisanie do siebie (tylko ja zaznaczony)
                initialAssignees = [state.currentUser.uid];

                const tomorrow = new Date();
                tomorrow.setDate(tomorrow.getDate() + 1);
                tomorrow.setHours(10, 0, 0, 0);

                const pad = (num) => num.toString().padStart(2, '0');
                const formattedDate = `${tomorrow.getFullYear()}-${pad(tomorrow.getMonth() + 1)}-${pad(tomorrow.getDate())}`;
                newTaskModal.dueDateDate.value = formattedDate; // Jutro
                newTaskModal.dueDateHour.value = "10"; // Godzina 10
                newTaskModal.dueDateMinute.value = "00"; // Minuta 00

            } else {
                // ZWYKY FAB lub przycisk "Dodaj nowe zadanie"
                // Domylnie zaznaczamy tylko aktualnego u偶ytkownika
                initialAssignees = [state.currentUser.uid];

                const inProjectView = state.ui.currentView === 'projects' && state.currentProjectId;
                if (inProjectView) {
                    // 1. Jestemy w widoku PROJEKTU - domylnie wybierz ten projekt.
                    targetProject = findProject(state.currentProjectId);
                    if (targetProject) {
                        newTaskModal.projectSelect.innerHTML = `<option value="${targetProject.id}" selected>${targetProject.name}</option>`;
                        newTaskModal.projectGroup.style.display = 'none';
                    }
                
                } else if (isTargetingInbox && inboxProject) {
                    // 2. Jestemy na PULPICIE/MJ DZIE (FAB), mamy Inboxa - domylnie wybierz Inboxa.
                    targetProject = inboxProject;
                    newTaskModal.projectSelect.innerHTML = `<option value="${inboxProject.id}" selected>${inboxProject.name}</option>`;
                    newTaskModal.projectGroup.style.display = 'none';
                } else {
                    // 3. Jestemy na PULPICIE/MJ DZIE (przycisk na g贸rze) lub w widoku 'all-projects'
                    const nonInbox = state.projects.filter(p => !p.isInbox);
                    const preselect = (inboxProject && inboxProject.id) || (nonInbox[0] && nonInbox[0].id) || '';
                    newTaskModal.projectSelect.innerHTML = state.projects
                        .map(p => `<option value="${p.id}" ${p.id === preselect ? 'selected' : ''}>${p.name}</option>`)
                        .join('');
                    newTaskModal.projectGroup.style.display = 'block';
                    targetProject = findProject(preselect);
                }
            }

            if (!targetProject) {
                showNotification("Nie mo偶na zidentyfikowa projektu docelowego.", "Bd");
                return;
            }
            setupEffortTab(targetProject, null, newTaskModal);

            // === NOWA LOGIKA BUDOWANIA LISTY OSB (DUAL VIEW) ===
            // Zastpuje populateAssigneesForProject
            if (targetProject) {
                // 1. Buduj lew kolumn (Akordeon)
                buildTeamMembersAccordion(
                    newTaskModal.assigneesList,          // Kontener (Lewy)
                    initialAssignees,                    // Zaznaczeni (Domylnie Ja)
                    targetProject.ownerId,               // Waciciel (dla ikony korony)
                    targetProject.admins || [],          // Admini
                    false                                // false = nie blokuj waciciela (mo偶na odznaczy)
                );
                
                // 2. Buduj praw kolumn (Wybrani) - Przekazujemy null/puste tablice dla r贸l, bo zadania ich nie maj
                renderSelectedMembersColumn(
                    newTaskModal.assigneesList, 
                    newTaskModal.selectedList, 
                    null, // Brak "waciciela zadania" w sensie blokady UI
                    [],   // Brak admin贸w w kontekcie listy zadania
                    []    // Brak superuser贸w
                );
                
                // Aktywacja wyszukiwarki dla tego modala
                setupUserSearch(
                    newTaskModal.memberSearchInput, 
                    newTaskModal.memberSearchResults, 
                    newTaskModal.assigneesList
                );
            }
            // === KONIEC NOWEJ LOGIKI ===

            // <<<===== POCZTEK POPRAWKI BDU =====>>>
            // Definiujemy zmienne TUTAJ, aby byy dostpne dla obu poni偶szych sekcji
            const projectBudget = targetProject.budget; 
            const projectHasBudgetItems = projectBudget && projectBudget.items && projectBudget.items.length > 0;
            // <<<===== KONIEC POPRAWKI BDU =====>>>

            // <<< ZMIANA: Warunkowe wywietlenie zakadki Bud偶et w modalu nowego zadania >>>
            const newBudgetTabButton = document.getElementById('new-task-tab-taskBudget');

            if (newBudgetTabButton) {
                 // U偶ywamy teraz sp贸jnej nazwy zmiennej
                 newBudgetTabButton.style.display = projectHasBudgetItems ? 'flex' : 'none'; 
            }
            // <<< KONIEC ZMIANY >>>
            // <<<===== POCZTEK NOWEGO KODU =====>>>
    // --- Uzupenienie logiki BUD呕ETU ZADANIA (Etap 1 - Inicjalizacja) dla nowego zadania ---
    const projectCurrency = (projectBudget && projectBudget.currency) || '';
    // Przechowamy nazwy pozycji w data atrybucie modala, aby byy dostpne dla listenera przycisku "+"
    newTaskModal.overlay.dataset.projectBudgetItems = projectHasBudgetItems ? JSON.stringify(projectBudget.items.map(item => item.name)) : '[]';
    newTaskModal.overlay.dataset.projectCurrency = projectCurrency; // Zapisz te偶 walut

    // Resetuj sekcj bud偶etu przy ka偶dym otwieraniu
    newTaskModal.budgetToggle.checked = false;
    newTaskModal.budgetDetails.style.display = 'none';
    newTaskModal.budgetItemsList.innerHTML = '<li class="budget-item-empty" style="font-style: italic; color: var(--text-secondary); font-size: 13px;">Brak pozycji kosztowych.</li>';
    newTaskModal.budgetErrorP.textContent = '';
    updateTaskBudgetTotal(newTaskModal, projectCurrency); // Ustaw walut i sum 0
    // --- KONIEC NOWEJ LOGIKI ---
    // <<<===== KONIEC NOWEGO KODU =====>>>
            openModal(newTaskModal.overlay);
            // === NOWE: Automatyczny fokus na tytu ===
            setTimeout(() => {
                if (newTaskModal.title) {
                    newTaskModal.title.focus();
                }
            }, 100); // Kr贸tkie op贸藕nienie dla pewnoci renderowania
            // === KONIEC ===
}
       // === NOWE FUNKCJE DLA MODALA SONDAR呕U ===

        /**
         * Renderuje HTML dla pojedynczej, edytowalnej opcji sonda偶u.
         * @param {string} [value=''] - Warto do wstawienia w pole input.
         * @returns {string} HTML (element <li>)
         */
        function renderPollOptionHTML(value = '') {
            // Generujemy unikalne ID dla inputa pliku, aby label dziaa poprawnie
            const fileInputId = `poll-file-${Date.now()}-${Math.random().toString(16).slice(2)}`;
            
            return `
                <li class="poll-option-item" style="display: flex; flex-direction: column; gap: 6px; margin-bottom: 12px; padding: 10px; background-color: var(--bg-primary); border-radius: var(--border-radius);">
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <input type="text" class="new-poll-option-input" placeholder="Wpisz opcj..." value="${value}" style="flex: 1;">
                        <button type="button" class="delete-poll-option-btn btn btn-secondary" style="padding: 2px 6px; font-size: 14px; line-height: 1;">&times;</button>
                    </div>
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <input type="file" class="new-poll-option-file" id="${fileInputId}" accept="image/png, image/jpeg" style="display: none;">
                        <label for="${fileInputId}" class="btn btn-secondary" style="font-size: 12px; padding: 2px 8px; margin: 0; cursor: pointer;">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" style="width: 14px; height: 14px; margin-right: 4px; vertical-align: text-bottom;">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M18.375 12.739l-7.693 7.693a4.5 4.5 0 01-6.364-6.364l10.94-10.94A3 3 0 1119.5 7.372L8.552 18.32m.009-.01l-.01.01m5.699-9.94l-7.693 7.693a2.25 2.25 0 003.182 3.182l7.693-7.693a.75.75 0 011.06 1.06l-7.693 7.693a4.5 4.5 0 01-6.364-6.364l10.94-10.94A3 3 0 1119.5 7.372L8.552 18.32" />
                            </svg>
                            Dodaj .png/.jpg
                        </label>
                        <span class="poll-option-file-name" style="font-size: 12px; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">Brak pliku</span>
                    </div>
                </li>
            `;
        }

        /**
         * Otwiera i inicjalizuje modal tworzenia nowego sonda偶u.
         */
        function openNewPollModal() {
            // Sonda偶e s zawsze powizane z projektem.
            const projectId = state.currentProjectId;
            // Sprawdzamy, czy jestemy w widoku projektu (a nie np. M贸j Dzie)
            const project = findProject(projectId);

            if (!project || state.ui.currentView !== 'projects') {
                showNotification("Sonda偶e mo偶na tworzy tylko z poziomu aktywnego projektu.", "Bd");
                return;
            }

            // Resetowanie formularza
            newPollModal.form.reset();
            
            // Czyszczenie listy opcji i dodawanie dw贸ch domylnych, pustych p贸l
            // (Usuwamy prototypy z HTML)
            newPollModal.optionsList.innerHTML = '';
            newPollModal.optionsList.insertAdjacentHTML('beforeend', renderPollOptionHTML());
            newPollModal.optionsList.insertAdjacentHTML('beforeend', renderPollOptionHTML());

            // Wypenianie listy uczestnik贸w
            // U偶ywamy tej samej funkcji co przy tworzeniu projektu.
            // Domylnie zaznaczamy wszystkich czonk贸w projektu.
           const allMemberIds = project.members || [];
            // Przekazujemy false (nie blokuj)
            buildTeamMembersAccordion(newPollModal.assigneesContainer, allMemberIds, project.ownerId, [], false);

            // Zapisujemy ID projektu w modalu do p贸藕niejszego wykorzystania
            newPollModal.overlay.dataset.projectId = projectId;

            openModal(newPollModal.overlay);
        }
       /**
         * NOWA FUNKCJA POMOCNICZA
         * Renderuje interfejs do gosowania (przyciski) dla danego sonda偶u.
         * @param {object} poll - Obiekt sonda偶u.
         * @returns {string} - Kod HTML dla sekcji gosowania.
         */
        function renderPollVotingUI(poll) {
            let votingHTML = `<div class="task-modal-section">
                                <h4 style="color: var(--text-secondary); font-weight: 500;">Wybierz jedn z opcji poni偶ej klikajc na ni</h4>
                                <div class="poll-options" style="margin-top: 8px;">`;
                                
            votingHTML += (poll.options || []).map(opt => {
                let imageHTML = '';
                const attachment = opt.attachment;
                if (attachment && attachment.url) {
                     imageHTML = `<img src="${attachment.url}" alt="Zacznik do opcji" style="width: 100%; max-height: 250px; object-fit: contain; border-radius: var(--border-radius); margin-top: 8px; border: 1px solid var(--border-color); pointer-events: none;">`;
                }
                
                return `
                    <div class="poll-option-item">
                        <button class="poll-vote-btn" data-poll-id="${poll.id}" data-option-id="${opt.id}" style="flex-direction: column; height: auto; padding: 12px;">
                            <span style="font-weight: 600;">${opt.text}</span>
                            ${imageHTML}
                        </button>
                    </div>
                `;
            }).join('');
            
            votingHTML += `</div></div>`; // Zamknij .poll-options i .task-modal-section
            return votingHTML;
        }

        /**
         * Otwiera modal szczeg贸贸w sonda偶u i renderuje jego zawarto.
         */
        // === KONIEC NOWYCH FUNKCJI ===
        /**
         * Otwiera modal szczeg贸贸w sonda偶u i renderuje jego zawarto.
         */
        function openPollDetailsModal(pollId) {
            const poll = state.polls.find(p => p.id === pollId);
            if (!poll) {
                showNotification("Nie mo偶na znale藕 tego sonda偶u.", "Bd");
                return;
            }

            // Ustaw tytu modala
            pollDetailsModal.title.textContent = poll.title;

            // --- Logika obliczania gos贸w (skopiowana i dostosowana) ---
            const currentUserId = state.currentUser.uid;
            let currentUserVoteOptionId = null;
            let totalVotes = 0; // czna liczba oddanych gos贸w
            let votedUserIds = new Set(); // Unikalni gosujcy
            
            (poll.options || []).forEach(opt => {
                const voteCount = (opt.votes || []).length;
                totalVotes += voteCount;
                (opt.votes || []).forEach(userId => votedUserIds.add(userId));
                if ((opt.votes || []).includes(currentUserId)) {
                    currentUserVoteOptionId = opt.id;
                }
            });

            const hasVoted = !!currentUserVoteOptionId;
            // [POPRAWKA 1: Logika bdu waciciela]
            // Sprawd藕, czy u偶ytkownik jest na licie LUB jest tw贸rc
            const isAssignee = (poll.assignees || []).includes(currentUserId);
            const isCreator = poll.createdBy === currentUserId;
            
            // Definiujemy, kto mo偶e gosowa:
            const canVote = isAssignee || isCreator;
            
            let contentHTML = '';

            // === NOWA SEKCJA: Informacje o sonda偶u (Bez tytuu) ===
            contentHTML += `<div class="task-modal-section" style="border-bottom: 1px solid var(--border-color); padding-bottom: 16px; margin-bottom: 16px;">`;
            
            // 1. Termin
            if (poll.deadline) {
                const formattedDeadline = new Date(poll.deadline).toLocaleString('pl-PL', { day: 'numeric', month: 'long', year: 'numeric', hour: '2-digit', minute: '2-digit' });
                contentHTML += `<h4 style="color: var(--text-secondary); margin-bottom: 4px;">Termin gosowania</h4><p>${formattedDeadline}</p>`;
            } else {
                contentHTML += `<h4 style="color: var(--text-secondary); margin-bottom: 4px;">Termin gosowania</h4><p>Brak</p>`;
            }

            // 2. Cel i Opis
            if (poll.description) {
                contentHTML += `<h4 style="color: var(--text-secondary); margin-top: 12px; margin-bottom: 4px;">Cel i opis</h4><p style="white-space: pre-wrap; background-color: var(--bg-primary); padding: 8px; border-radius: var(--border-radius);">${poll.description}</p>`;
            }
            
            contentHTML += `</div>`;
            // === KONIEC NOWEJ SEKCJI ===
            // --- Renderowanie sekcji "Kto jeszcze nie gosowa" ---
            const pendingUsers = (poll.assignees || [])
                .filter(userId => !votedUserIds.has(userId)) // Filtruj tych, kt贸rych ID nie ma w Set
                .map(findUser)
                .filter(Boolean);

            if (pendingUsers.length > 0) {
                contentHTML += `<div class="task-modal-section">
                    <h4>Oczekujce na gos (${pendingUsers.length})</h4>
                    <div class="task-assignees" style="justify-content: flex-start; flex-wrap: wrap; gap: 4px;">
                        ${pendingUsers.map(user => renderAvatarHTML(user, 'avatar')).join('')}
                    </div>
                </div>`;
            }

            // --- Renderowanie sekcji gosowania / wynik贸w ---
            
            // [POPRAWKA 1: Logika bdu waciciela]
            // Zmieniamy warunek `if (hasVoted || !canVote)` na `if (hasVoted)`
            // To zapewni, 偶e tw贸rca (dla kt贸rego `canVote` jest true) trafi do bloku 'else' (gosowanie),
            // a nie do bloku 'wyniki' (jak to si dziao, gdy `!canVote` byo faszywe).
            
            let headerText = '';

            if (hasVoted) {
                // --- Widok WYNIKW (u偶ytkownik ju偶 zagosowa) ---
                headerText = 'Wyniki gosowania';
                
                contentHTML += `<div class="task-modal-section">
                                <h4 style="color: var(--text-secondary); font-weight: 500;">${headerText}</h4>
                                <div class="poll-options" style="margin-top: 8px;">`;
                                
                contentHTML += (poll.options || []).map(opt => {
                    const voteCount = (opt.votes || []).length;
                    const percentage = totalVotes > 0 ? (voteCount / totalVotes) * 100 : 0;
                    const isVotedClass = opt.id === currentUserVoteOptionId ? 'voted' : '';

                    // [POPRAWKA 2: Bd obrazk贸w]
                    let imageHTML = '';
                    const attachment = opt.attachment;
                    // Upraszczamy warunek. Jeli jest URL, ufamy, 偶e jest to obraz (poniewa偶 sami go tam wstawilimy).
                    if (attachment && attachment.url) {
                         imageHTML = `<img src="${attachment.url}" alt="Zacznik do opcji" style="width: 100%; max-height: 250px; object-fit: contain; border-radius: var(--border-radius); margin-top: 8px; border: 1px solid var(--border-color);">`;
                    }
                    // === KONIEC POPRAWKI 2 ===

                    return `
                        <div class="poll-option-result ${isVotedClass}" style="padding: 10px; background-color: var(--bg-primary); border-radius: var(--border-radius);">
                            <div class="poll-result-text">
                                <span>${opt.text} ${isVotedClass ? '' : ''}</span>
                                <span class="poll-vote-count">${voteCount} ${voteCount === 1 ? 'gos' : (voteCount > 1 && voteCount < 5 ? 'gosy' : 'gos贸w')}</span>
                            </div>
                            <div class="poll-result-bar-container">
                                <div class="poll-result-bar-fill" style="width: ${percentage.toFixed(1)}%;"></div>
                            </div>
                            ${imageHTML}
                        </div>
                    `;
                }).join('');
                
                contentHTML += `</div></div>`; // Zamknij .poll-options i .task-modal-section
                
            } else if (canVote) {
                // --- Widok GOSOWANIA (przyciski) (u偶ytkownik jeszcze nie gosowa, ALE MO呕E) ---
                
                // === POCZTEK ZMIANY (KROK 3) ===
                // Zamiast generowa HTML, wywoujemy now funkcj pomocnicz
                contentHTML += renderPollVotingUI(poll);
                // === KONIEC ZMIANY ===
                
            } else {
                // --- Widok ZABLOKOWANY (u偶ytkownik nie gosowa I NIE MO呕E gosowa) ---
                headerText = 'Wyniki gosowania (nie bierzesz udziau)';
                // Pokazujemy wyniki tak samo jak w bloku `if (hasVoted)`
                
                contentHTML += `<div class="task-modal-section">
                                <h4 style="color: var(--text-secondary); font-weight: 500;">${headerText}</h4>
                                <div class="poll-options" style="margin-top: 8px;">`;
                
                contentHTML += (poll.options || []).map(opt => {
                    const voteCount = (opt.votes || []).length;
                    const percentage = totalVotes > 0 ? (voteCount / totalVotes) * 100 : 0;
                    
                    // [POPRAWKA 2: Bd obrazk贸w]
                    let imageHTML = '';
                    const attachment = opt.attachment;
                    if (attachment && attachment.url) {
                         imageHTML = `<img src="${attachment.url}" alt="Zacznik do opcji" style="width: 100%; max-height: 250px; object-fit: contain; border-radius: var(--border-radius); margin-top: 8px; border: 1px solid var(--border-color);">`;
                    }
                    // === KONIEC POPRAWKI 2 ===

                    return `
                        <div class="poll-option-result" style="padding: 10px; background-color: var(--bg-primary); border-radius: var(--border-radius); opacity: 0.8;">
                            <div class="poll-result-text">
                                <span>${opt.text}</span>
                                <span class="poll-vote-count">${voteCount} ${voteCount === 1 ? 'gos' : (voteCount > 1 && voteCount < 5 ? 'gosy' : 'gos贸w')}</span>
                            </div>
                            <div class="poll-result-bar-container">
                                <div class="poll-result-bar-fill" style="width: ${percentage.toFixed(1)}%;"></div>
                            </div>
                            ${imageHTML}
                        </div>
                    `;
                }).join('');
                
                contentHTML += `</div></div>`;
            }

            // Wstrzyknij gotowy HTML do modala
            pollDetailsModal.content.innerHTML = contentHTML;

            // --- NOWA LOGIKA: Poka偶/Ukryj przyciski zarzdzania ---
            const isCreatorOnLoad = poll.createdBy === state.currentUser.uid;
            
            // === POCZTEK ZMIANY (KROK 4) ===
            // Logika dla przycisk贸w "Zakocz" i "Usu" (bez zmian)
            if (isCreatorOnLoad && poll.status === 'open') {
                pollDetailsModal.closePollBtn.style.display = 'block';
                pollDetailsModal.closePollBtn.dataset.pollId = pollId; 
                pollDetailsModal.closePollBtn.disabled = false;
                pollDetailsModal.closePollBtn.textContent = 'Zakocz sonda偶';
            } else {
                pollDetailsModal.closePollBtn.style.display = 'none';
            }
            
            if (isCreatorOnLoad) {
                pollDetailsModal.deletePollBtn.style.display = 'block';
                pollDetailsModal.deletePollBtn.dataset.pollId = pollId;
            } else {
                pollDetailsModal.deletePollBtn.style.display = 'none';
            }

            // NOWA LOGIKA: Poka偶 przycisk "Zmie gos"
            // Poka偶 go, jeli: u偶ytkownik zagosowa ORAZ mo偶e gosowa (canVote) ORAZ sonda偶 jest otwarty
            if (hasVoted && canVote && poll.status === 'open') {
                pollDetailsModal.changeVoteBtn.style.display = 'block';
                pollDetailsModal.changeVoteBtn.dataset.pollId = pollId; // Zapisz ID sonda偶u
            } else {
                pollDetailsModal.changeVoteBtn.style.display = 'none';
            }
            // === KONIEC ZMIANY (KROK 4) ===
            
            // --- KONIEC NOWEJ LOGIKI ---

            // Otw贸rz modal
            openModal(pollDetailsModal.overlay);
        }
        // === KONIEC NOWYCH FUNKCJI ===
        function openEditProjectModal(projectId) {
            const project = findProject(projectId);
            if (!project) return;

            editProjectModal.overlay.dataset.projectId = projectId;
            editProjectModal.nameInput.value = project.name;
            
            // Wypenienie p贸l
            editProjectModal.startDateInput.value = project.startDate || '';
            editProjectModal.endDateInput.value = project.endDate || '';
            editProjectModal.prioritySelect.value = project.priority || 'medium';
            editProjectModal.descriptionTextarea.value = project.description || '';
            editProjectModal.estimationTypeSelect.value = project.estimationType || 'none';
            
            // === ZMIANA: Inicjalizacja tymczasowych tablic r贸l dla trybu edycji ===
            // Tworzymy kopie tablic, aby edycja nie wpywaa na obiekt projektu przed zapisem
            editProjectModal.currentAdminIds = [...(project.admins || [])];
            editProjectModal.currentSuperUserIds = [...(project.superUsers || [])];
            // === KONIEC ZMIANY ===
            
            // 1. Budujemy lew kolumn
            // Przekazujemy nasze tymczasowe tablice
            buildTeamMembersAccordion(editProjectModal.membersContainer, project.members, project.ownerId, editProjectModal.currentAdminIds, true, editProjectModal.currentSuperUserIds);
            
            // 2. Inicjujemy praw kolumn
            const rightCol = document.getElementById('edit-project-selected-list');
            renderSelectedMembersColumn(
                editProjectModal.membersContainer,
                rightCol,
                project.ownerId,
                editProjectModal.currentAdminIds,     // U偶ywamy tymczasowych
                editProjectModal.currentSuperUserIds  // U偶ywamy tymczasowych
            );

            const budgetData = project.budget;
            // Resetuj stan bud偶etu przed wczytaniem
            editProjectModal.budgetToggle.checked = false;
            editProjectModal.budgetDetails.style.display = 'none';
            editProjectModal.budgetAmountInput.value = '';
            editProjectModal.budgetCurrencyInput.value = 'PLN'; // Domylna waluta
            editProjectModal.budgetItemsList.innerHTML = '<li class="budget-item-empty" style="font-style: italic; color: var(--text-secondary); font-size: 13px;">Brak pozycji bud偶etowych.</li>';
            
            // CZYSZCZENIE BDW (Tylko jeli element istnieje - dla bezpieczestwa)
            if (editProjectModal.budgetSaveErrorP) {
                editProjectModal.budgetSaveErrorP.textContent = '';
            }

            if (budgetData && typeof budgetData === 'object') {
                // Jeli istniej dane bud偶etu
                editProjectModal.budgetToggle.checked = true;
                editProjectModal.budgetDetails.style.display = 'block';
                editProjectModal.budgetAmountInput.value = budgetData.amount || '';
                editProjectModal.budgetCurrencyInput.value = budgetData.currency || 'PLN';

                // Wyczy list przed dodaniem wczytanych pozycji
                editProjectModal.budgetItemsList.innerHTML = '';
                if (budgetData.items && budgetData.items.length > 0) {
                    budgetData.items.forEach((item, index) => {
                        const itemHTML = renderBudgetItemHTML(item, index);
                        editProjectModal.budgetItemsList.insertAdjacentHTML('beforeend', itemHTML);
                    });
                } else {
                    // Jeli nie ma pozycji, poka偶 komunikat
                    editProjectModal.budgetItemsList.innerHTML = '<li class="budget-item-empty" style="font-style: italic; color: var(--text-secondary); font-size: 13px;">Brak pozycji bud偶etowych.</li>';
                }

                // Przelicz i wywietl podsumowanie dla wczytanych danych
                updateBudgetSummary(editProjectModal);

            } else {
                 // Jeli nie ma danych bud偶etu, upewnij si, 偶e stan jest czysty
                 updateBudgetSummary(editProjectModal); // Wywoaj, aby ustawi sumy na 0
            }
            
            // Reset wyszukiwarki
            editProjectModal.memberSearchInput.value = '';
            editProjectModal.memberSearchResults.innerHTML = '';
            editProjectModal.memberSearchResults.classList.remove('visible');

            openModal(editProjectModal.overlay);
        }
            
         async function handleDeleteProject(projectId) {
            const project = findProject(projectId) || findCompletedProject(projectId);
            if (!project || project.ownerId !== state.currentUser.uid) {
                showNotification("Brak uprawnie lub projekt nie istnieje.", "Bd");
                return;
            }
            const collectionRef = findProject(projectId) ? projectsRef : completedProjectsRef;

            showConfirmation(
                "Potwierd藕 usunicie",
                `Czy na pewno chcesz usun projekt "${project.name}"? Tej operacji nie mo偶na cofn.`,
                async (confirmed) => {
                    if (confirmed) {
                        try {
                            await deleteDoc(doc(collectionRef, projectId));
                            const nextProject = state.projects.find(p => p.id !== projectId) || state.completedProjects.find(p => p.id !== projectId);
                            state.currentProjectId = nextProject ? nextProject.id : null;
                            state.ui.currentView = state.currentProjectId ? 'projects' : 'my-dashboard';
                            saveUiState();
                            showNotification("Projekt zosta pomylnie usunity.", "Sukces");
                            render();
                        } catch (error) {
                            console.error("Bd podczas usuwania projektu:", error);
                            showNotification("Wystpi bd podczas usuwania projektu. Spr贸buj ponownie.", "Bd");
                        }
                    }
                }, true
            );
        }
const addAttachmentBtnNewTask = document.getElementById('add-new-task-attachment-btn');
const attachmentInputNewTask = document.getElementById('new-task-attachment-input');
const attachmentsListNewTask = document.getElementById('new-task-attachments-list');

        function renderDashboardActivityFeed() {
            const activityListEl = document.getElementById('dashboard-activity-list');
            if (!activityListEl) return;
        
            // 1. Zbierz wszystkie projekty, w kt贸rych bierze udzia zalogowany u偶ytkownik.
            const userProjects = [...state.projects, ...state.completedProjects].filter(p => p.members.includes(state.currentUser.uid));
        
            // 2. Zbierz wszystkie aktywnoci ze wszystkich zada w tych projektach.
            const allActivities = userProjects.flatMap(project =>
                (project.tasks || []).flatMap(task =>
                    (task.activityLog || []).map(log => ({
                        ...log,
                        taskId: task.id,
                        taskTitle: task.title,
                        projectId: project.id,
                        projectName: project.name
                    }))
                )
            );
        
            // 3. Odfiltruj aktywnoci wykonane przez samego zalogowanego u偶ytkownika.
            const otherUsersActivities = allActivities.filter(activity => activity.userId !== state.currentUser.uid);
        
            // 4. Posortuj wszystkie aktywnoci malejco po dacie i we藕 15 najnowszych.
            otherUsersActivities.sort((a, b) => b.timestamp - a.timestamp);
            const recentActivities = otherUsersActivities.slice(0, 15);
        
            if (recentActivities.length === 0) {
                activityListEl.innerHTML = '<li class="activity-item" style="font-style: italic;">Brak aktywnoci ze strony innych czonk贸w zespou.</li>';
                return;
            }
        
            // 5. Wygeneruj HTML i wstaw do listy.
            activityListEl.innerHTML = recentActivities.map(activity => {
                const user = findUser(activity.userId);
                const userName = user ? user.name : 'Kto';
                const dateStr = new Date(activity.timestamp).toLocaleString('pl-PL', { day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' });
        
                let message = '';
                switch (activity.type) {
                    case 'status':
                        message = `zmieni status zadania "<strong>${activity.taskTitle}</strong>" na ${activity.newValue}.`;
                        break;
                    case 'comment':
                        message = `doda komentarz w zadaniu "<strong>${activity.taskTitle}</strong>".`;
                        break;
                    case 'completion':
                         message = `ukoczy swoj cz zadania "<strong>${activity.taskTitle}</strong>".`;
                        break;
                    default:
                        message = `wykona akcj w zadaniu "<strong>${activity.taskTitle}</strong>" w projekcie <em>${activity.projectName}</em>.`;
                }
        
                return `<li class="activity-item" data-task-id="${activity.taskId}" style="cursor: pointer;" title="Kliknij, aby zobaczy zadanie">
                            [${dateStr}] <strong>${userName}</strong> ${message}
                        </li>`;
            }).join('');
        }

        function renderDashboardTeamDelays() {
            const delaysListEl = document.getElementById('dashboard-team-delays-list');
            if (!delaysListEl) return;

            // 1. Znajd藕 projekty, kt贸rych wacicielem jest zalogowany u偶ytkownik
            const myOwnedProjects = state.projects.filter(p => p.ownerId === state.currentUser.uid);
            
            // 2. Zbierz wszystkie op贸藕nione zadania z tych projekt贸w, kt贸re NIE s przypisane do Ciebie
            const teamOverdueTasks = myOwnedProjects.flatMap(project =>
                (project.tasks || [])
                    .filter(task =>
                        task.status !== 'done' &&                                  // Zadanie nie jest ukoczone
                        task.dueDate && new Date(task.dueDate).getTime() < Date.now() && // Ma termin i jest po terminie
                        !task.assignees.includes(state.currentUser.uid)           // NIE jest przypisane do mnie
                    )
                    .map(task => ({ ...task, projectName: project.name })) // Dodaj nazw projektu do zadania
            );
            
            // 3. Posortuj znalezione zadania od najstarszego
            teamOverdueTasks.sort((a, b) => new Date(a.dueDate).getTime() - new Date(b.dueDate).getTime());

            // 4. Wygeneruj HTML i wstaw go do kontenera
            if (teamOverdueTasks.length === 0) {
                delaysListEl.innerHTML = '<p class="no-overdue-tasks">呕aden czonek zespou nie ma op贸藕nie. wietna robota!</p>';
            } else {
                // U偶ywamy tej samej funkcji co do renderowania kart zada
                delaysListEl.innerHTML = teamOverdueTasks.map(task => createTaskCardHTML(task, true)).join('');
            }
        }
       // === POCZTEK NOWYCH FUNKCJI POMOCNICZYCH (ZMIANA GRUPY) ===

        /**
         * Usuwa list projekt贸w u偶ytkownika za pomoc operacji wsadowej (batch).
         * U偶ywane, gdy zwyky u偶ytkownik opuszcza grup.
         */
        async function deleteUserProjects(projectsToDeleteIds) {
            if (!projectsToDeleteIds || projectsToDeleteIds.length === 0) {
                console.log('[deleteUserProjects] Brak projekt贸w do usunicia.');
                return;
            }

            console.log(`[deleteUserProjects] Rozpoczynam usuwanie ${projectsToDeleteIds.length} AKTYWNYCH projekt贸w.`); // Zmieniono opis w logu

            const batch = writeBatch(db);

            projectsToDeleteIds.forEach(projectId => {
                // Usuwamy TYLKO z kolekcji aktywnych projekt贸w,
                // poniewa偶 lista ID pochodzi wanie stamtd i wiemy, 偶e u偶ytkownik jest ich wacicielem.
                const activeProjectRef = doc(projectsRef, projectId);
                // Usunito: const completedProjectRef = doc(completedProjectsRef, projectId);

                batch.delete(activeProjectRef); // Usu tylko z aktywnych
                // Usunito: batch.delete(completedProjectRef);

                console.log(`[deleteUserProjects] Dodano do batcha usunicie AKTYWNEGO projektu: ${projectId}`); // Zmieniono opis w logu
                // TODO: W przyszoci warto doda usuwanie zacznik贸w z Storage dla ka偶dego zadania w projekcie.
            });

            try {
                await batch.commit();
                console.log('[deleteUserProjects] Batch usunity pomylnie.');
            } catch (error) {
                console.error('[deleteUserProjects] Bd podczas batch.commit():', error);
                // Rzucamy bdem dalej, aby nadrzdna funkcja moga go zapa
                throw new Error("Nie udao si usun starych projekt贸w. Operacja zmiany grupy przerwana.");
            }
        }
        /**
         * Aktualizuje dokument u偶ytkownika o now grup.
         */
       /**
         * Usuwa u偶ytkownika z listy czonk贸w projekt贸w w podanej grupie,
         * w kt贸rych nie jest on wacicielem.
         * U偶ywane podczas zmiany grupy.
         */
        async function removeUserFromProjectsMembership(userId, oldGroupId) {
            // Sprawd藕, czy oldGroupId istnieje i nie jest to ID samego u偶ytkownika (przypadek solo)
            if (!oldGroupId || oldGroupId === userId) {
                console.log(`[removeMembership] Pomijam usuwanie czonkostwa - u偶ytkownik solo lub brak starej grupy (oldGroupId: ${oldGroupId})`);
                return; // Nie ma czego usuwa
            }

            console.log(`[removeMembership] Szukam projekt贸w w grupie ${oldGroupId}, gdzie ${userId} jest czonkiem (ale nie wacicielem)...`);

            // Zapytanie: projekty w starej grupie, gdzie u偶ytkownik jest w 'members' i NIE jest 'ownerId'
            const q = query(projectsRef,
                where("groupId", "==", oldGroupId),
                where("members", "array-contains", userId),
                where("ownerId", "!=", userId) // Wa偶ne: nie usuwamy z projekt贸w, kt贸rych JEST wacicielem
            );

            let projectsSnapshot;
            try {
                projectsSnapshot = await getDocs(q);
                console.log(`[removeMembership] Znaleziono ${projectsSnapshot.size} projekt贸w do opuszczenia.`);
            } catch (queryError) {
                console.error("[removeMembership] Bd podczas zapytania o projekty (prawdopodobnie brak indeksu):", queryError);
                if (queryError.code === 'failed-precondition') {
                    // Ten bd jest krytyczny i wskazuje na brak indeksu w Firestore
                    throw new Error("Bd konfiguracji bazy danych (brak indeksu). Operacja przerwana.");
                }
                throw new Error("Nie udao si pobra listy projekt贸w do opuszczenia. Operacja zmiany grupy przerwana.");
            }

            if (projectsSnapshot.empty) {
                return; // Brak projekt贸w do opuszczenia, koczymy pomylnie.
            }

            // Mamy projekty, musimy je zaktualizowa
            const batch = writeBatch(db);
            const userIdToRemove = userId; // Dla czytelnoci

            projectsSnapshot.forEach(doc => {
                const project = doc.data();
                const projectId = doc.id;
                const newDefaultAssignee = project.ownerId; // Zadania zostan przypisane wacicielowi projektu

                console.log(`[removeMembership] Przetwarzam projekt: ${projectId}. Zadania zostan przeniesione na ${newDefaultAssignee}`);

                // 1. Aktualizacja listy czonk贸w: usu u偶ytkownika, dodaj waciciela (jeli go nie ma)
                let updatedMembers = (project.members || []).filter(memberId => memberId !== userIdToRemove);
                if (!updatedMembers.includes(newDefaultAssignee)) {
                    updatedMembers.push(newDefaultAssignee);
                }

                // 2. Aktualizacja zada (Reasignacja):
                const modifiedTasks = (project.tasks || []).map(task => {
                    if (!(task.assignees || []).includes(userIdToRemove)) {
                        return task; // Bez zmian, jeli u偶ytkownik nie by przypisany
                    }
                    
                    const updatedTask = { ...task };
                    let newAssignees = (updatedTask.assignees || []).filter(id => id !== userIdToRemove);
                    if (!newAssignees.includes(newDefaultAssignee)) {
                        newAssignees.push(newDefaultAssignee);
                    }
                    const newCompletedBy = (updatedTask.completedBy || []).filter(id => id !== userIdToRemove);
                    const newType = newAssignees.length > 1 ? 'multi' : 'single';
                    const newStatus = (updatedTask.status === 'done') ? 'inprogress' : updatedTask.status; // Resetuj status, jeli byo 'done'

                    const modifiedSubtasks = (updatedTask.subtasks || []).map(subtask => {
                        if (!(subtask.assignees || []).includes(userIdToRemove)) {
                            return subtask; // Bez zmian
                        }
                        const updatedSubtask = { ...subtask };
                        let newSubAssignees = (updatedSubtask.assignees || []).filter(id => id !== userIdToRemove);
                        if (!newSubAssignees.includes(newDefaultAssignee)) {
                            newSubAssignees.push(newDefaultAssignee);
                        }
                        const newSubCompletedBy = (updatedSubtask.completedBy || []).filter(id => id !== userIdToRemove);
                        const isNowCompleted = (newSubAssignees.length > 0) && newSubAssignees.every(id => newSubCompletedBy.includes(id));
                        return { ...updatedSubtask, assignees: newSubAssignees, completedBy: newSubCompletedBy, isCompleted: isNowCompleted };
                    });

                    return { ...updatedTask, assignees: newAssignees, completedBy: newCompletedBy, type: newType, status: newStatus, subtasks: modifiedSubtasks };
                });

                // 3. Dodaj zaktualizowane dane projektu do batcha
                batch.update(doc.ref, {
                    members: updatedMembers,
                    tasks: modifiedTasks
                });

                console.log(`[removeMembership] Dodano do batcha aktualizacj projektu ${projectId}.`);
            });

            // 4. Wykonaj batch
            try {
                console.log("[removeMembership] Wykonuj batch.commit() do usunicia czonkostwa i re-asynacji zada...");
                await batch.commit(); // Wykonanie operacji wsadowej
                console.log("[removeMembership] Batch zakoczony pomylnie.");
            } catch (commitError) {
                console.error("[removeMembership] Bd podczas batch.commit():", commitError);
                throw new Error("Nie udao si zaktualizowa projekt贸w podczas opuszczania grupy. Operacja przerwana.");
            }
        }
        async function updateUserGroup(userId, newGroupId, newGroupName, newSubgroupName) {
            const userDocRef = doc(usersRef, userId);
            await updateDoc(userDocRef, {
                groupId: newGroupId,
                groupName: newGroupName,
                subgroupName: newSubgroupName
            });
        }
        
        /**
         * Otwiera modal transferu wasnoci i wypenia go czonkami grupy.
         */
        function openTransferOwnershipModal(targetGroupName, targetSubgroupName) {
            const user = state.currentUser;
            const otherGroupMembers = state.users.filter(u => u.groupId === user.groupId && u.uid !== user.uid);
            
            transferOwnershipModal.select.innerHTML = '<option value="">-- Wybierz czonka... --</option>'; // Reset
            transferOwnershipModal.error.textContent = '';

            if (otherGroupMembers.length === 0) {
                transferOwnershipModal.select.disabled = true;
                transferOwnershipModal.submitBtn.disabled = true;
                transferOwnershipModal.error.textContent = 'Nie mo偶esz opuci grupy, poniewa偶 jeste jedynym czonkiem. Usu grup w inny spos贸b lub zapro kogo.';
            } else {
                otherGroupMembers.forEach(member => {
                    const option = document.createElement('option');
                    option.value = member.uid;
                    option.textContent = member.name || member.email;
                    transferOwnershipModal.select.appendChild(option);
                });
                transferOwnershipModal.select.disabled = false;
                transferOwnershipModal.submitBtn.disabled = false;
            }

            // Zapisujemy grup docelow w atrybutach formularza, aby m贸c j odczyta przy wysyaniu
            transferOwnershipModal.form.dataset.targetGroupName = targetGroupName;
            transferOwnershipModal.form.dataset.targetSubgroupName = targetSubgroupName || '';
            
            closeModal(changeGroupModal.overlay); // Zamykamy stary modal
            openModal(transferOwnershipModal.overlay); // Otwieramy nowy
        }

        // === KONIEC NOWYCH FUNKCJI POMOCNICZYCH ===
         function renderDashboardUpcomingTasks() {
            const upcomingListEl = document.getElementById('dashboard-upcoming-list');
            if (!upcomingListEl) return;

            // 1. Zbierz wszystkie zadania przypisane do Ciebie
            const myTasks = getAllMyTasks();

            // 2. Ustaw granice czasowe: od teraz do koca jutra
            const now = new Date();
            const endOfTomorrow = new Date();
            endOfTomorrow.setDate(endOfTomorrow.getDate() + 2);
            endOfTomorrow.setHours(0, 0, 0, 0); // Ustawia na pocztek pojutrza

            // 3. Filtruj zadania, aby znale藕 te z terminem na dzi lub jutro
            const upcomingTasks = myTasks.filter(task => {
                if (!task.dueDate || task.status === 'done') {
                    return false;
                }
                const dueDate = new Date(task.dueDate);
                return dueDate >= now && dueDate < endOfTomorrow;
            });

            // 4. Posortuj zadania od najbli偶szego terminu
            upcomingTasks.sort((a, b) => new Date(a.dueDate).getTime() - new Date(b.dueDate).getTime());
            
            // 5. Wygeneruj HTML i wstaw go do kontenera
            if (upcomingTasks.length === 0) {
                upcomingListEl.innerHTML = '<p class="no-overdue-tasks">Brak zada z terminem na dzi lub jutro. Czas na planowanie!</p>';
            } else {
                upcomingListEl.innerHTML = upcomingTasks.map(task => createTaskCardHTML(task, true)).join('');
            }
        }
// Funkcja do renderowania listy plik贸w oczekujcych na wysanie
function renderStagedFiles() {
    attachmentsListNewTask.innerHTML = '';
    if (stagedFiles.length === 0) return;

    stagedFiles.forEach((file, index) => {
        const li = document.createElement('li');
        li.className = 'staged-attachment-item';
        li.innerHTML = `
            <div class="staged-attachment-info">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M18.375 12.739l-7.693 7.693a4.5 4.5 0 01-6.364-6.364l10.94-10.94A3 3 0 1119.5 7.372L8.552 18.32m.009-.01l-.01.01m5.699-9.94l-7.693 7.693a2.25 2.25 0 003.182 3.182l7.693-7.693a.75.75 0 011.06 1.06l-7.693 7.693a4.5 4.5 0 01-6.364-6.364l10.94-10.94A3 3 0 1119.5 7.372L8.552 18.32" /></svg>
                <span>${file.name}</span>
            </div>
            <button type="button" class="delete-staged-attachment-btn" data-index="${index}" title="Usu plik">&times;</button>
        `;
        attachmentsListNewTask.appendChild(li);
    });
}

// Otwiera okno wyboru pliku
addAttachmentBtnNewTask.addEventListener('click', () => {
    attachmentInputNewTask.click();
});

// Po wybraniu pliku dodaje go do tablicy 'stagedFiles'
attachmentInputNewTask.addEventListener('change', (e) => {
    const files = e.target.files;
    if (files.length > 0) {
        // === POCZTEK ZMIANY: WALIDACJA KA呕DEGO PLIKU ===
        let validFiles = [];
        let invalidFiles = [];

        for (const file of files) {
            if (file.size > MAX_FILE_SIZE) {
                invalidFiles.push(file.name);
            } else {
                validFiles.push(file);
            }
        }

        // Poka偶 bd, jeli kt贸rykolwiek plik by za du偶y
        if (invalidFiles.length > 0) {
            const errorMsg = `Plik(i) "${invalidFiles.join('", "')}" s za du偶e (max 15 MB) i nie zostay dodane.`;
            showNotification(errorMsg, "Bd Pliku");
        }

        // Dodaj do listy tylko poprawne pliki
        if (validFiles.length > 0) {
            stagedFiles.push(...validFiles);
            renderStagedFiles();
        }
        // === KONIEC ZMIANY ===
    }
    // Czyci input, aby mo偶na byo ponownie wybra ten sam plik po jego usuniciu
    e.target.value = ''; 
});

// Obsuguje usuwanie pliku z listy oczekujcych
attachmentsListNewTask.addEventListener('click', (e) => {
    if (e.target.classList.contains('delete-staged-attachment-btn')) {
        const indexToRemove = parseInt(e.target.dataset.index, 10);
        stagedFiles.splice(indexToRemove, 1);
        renderStagedFiles();
    }
});
        function showConfetti() {
            // === NOWY WARUNEK: Sprawd藕 ustawienia ===
            if (state.ui.showConfetti === false) return;
            // === KONIEC ===

            const container = document.createElement('div');
            container.className = 'confetti-container';
            document.body.appendChild(container);
            const colors = ['#ef4444', '#3b82f6', '#22c55e', '#f97316', '#8b5cf6', '#ec4899'];
            for (let i = 0; i < 100; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = `${Math.random() * 100}vw`;
                confetti.style.animationDelay = `${Math.random() * 2}s`;
                confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                container.appendChild(confetti);
            }
            setTimeout(() => container.remove(), 5000);
        }
        // NOWA FUNKCJA POMOCNICZA do tworzenia HTML dla pojedynczej pozycji bud偶etowej
        function renderBudgetItemHTML(item = { name: '', amount: '' }, index) {
            // Generuje unikalne ID dla input贸w na podstawie indeksu (lub timestamp, jeli index nie podany)
            const uniqueIdPart = index !== undefined ? index : Date.now();
            return `
                <li class="budget-item" data-index="${uniqueIdPart}" style="display: flex; gap: 8px; align-items: center; margin-bottom: 6px;">
                    <input type="text" class="budget-item-name" placeholder="Nazwa pozycji" value="${item.name || ''}" style="flex: 3;">
                    <input type="number" class="budget-item-amount" placeholder="Kwota" value="${item.amount || ''}" step="0.01" style="flex: 2;">
                    <button type="button" class="delete-budget-item-btn btn btn-secondary" style="padding: 2px 6px; font-size: 14px; line-height: 1;">&times;</button>
                </li>
            `;
        }
       // ZMODYFIKOWANA FUNKCJA do obliczania i aktualizacji podsumowania bud偶etu (Tylko wizualne)
        function updateBudgetSummary(modalRefs) {
            // Odczytaj cakowity bud偶et
            const totalBudget = parseFloat(modalRefs.budgetAmountInput.value) || 0;
            const currency = modalRefs.budgetCurrencyInput.value.trim();

            // Zbierz sum z input贸w
            const itemAmountInputs = modalRefs.budgetItemsList.querySelectorAll('.budget-item-amount');
            let itemsSum = 0;
            itemAmountInputs.forEach(input => {
                itemsSum += parseFloat(input.value) || 0;
            });

            // Oblicz r贸偶nic
            const difference = totalBudget - itemsSum;

            // Sformatuj
            const formatNumber = (num) => num.toLocaleString('pl-PL', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

            // Zaktualizuj tekst w HTML
            modalRefs.budgetItemsSumStrong.textContent = `${formatNumber(itemsSum)} ${currency}`;
            modalRefs.budgetDifferenceStrong.textContent = `${formatNumber(difference)} ${currency}`;
            // Zmie kolor r贸偶nicy na czerwony, jeli jest ujemna
            modalRefs.budgetDifferenceStrong.style.color = difference < 0 ? 'var(--danger-primary)' : 'inherit';
            
            // Czycimy tylko komunikat bdu, 偶eby znikn, gdy u偶ytkownik poprawia dane
            if (modalRefs.budgetSaveErrorP) modalRefs.budgetSaveErrorP.textContent = '';
        }
           /**
 * Generuje HTML dla pojedynczej pozycji kosztowej zadania w modalu.
 * @param {object} item - Obiekt pozycji ({ name, amount }) lub null/undefined dla nowej.
 * @param {number} index - Indeks pozycji (dla unikalnych ID i data-index).
 * @param {Array<string>} projectBudgetItemsNames - Lista nazw pozycji bud偶etowych projektu.
 * @returns {string} - Wygenerowany HTML dla elementu <li>.
 */
function renderTaskBudgetItemHTML(item = { name: '', amount: '' }, index, projectBudgetItemsNames = []) {
    const uniqueIdPart = index !== undefined ? index : Date.now(); // U偶ywamy indeksu, jeli jest dostpny

    // Generowanie opcji dla selecta na podstawie nazw z projektu
    const optionsHTML = projectBudgetItemsNames.map(itemName =>
        // Zaznacz opcj, jeli nazwa pasuje do item.name
        `<option value="${itemName}" ${item.name === itemName ? 'selected' : ''}>${itemName}</option>`
    ).join('');

    return `
        <li class="budget-item" data-index="${uniqueIdPart}" style="display: flex; gap: 8px; align-items: center; margin-bottom: 6px;">
            <select class="task-budget-item-name" style="flex: 3;" required>
                <option value="">-- Wybierz pozycj --</option>
                ${optionsHTML}
            </select>
            <input type="number" class="task-budget-item-amount" placeholder="Kwota" value="${item.amount || ''}" step="0.01" style="flex: 2;" required min="0.01">
            <button type="button" class="delete-task-budget-item-btn btn btn-secondary" style="padding: 2px 6px; font-size: 14px; line-height: 1;">&times;</button>
        </li>
    `;
}
       /**
 * Oblicza i aktualizuje sum koszt贸w zadania w modalu na podstawie input贸w.
 * @param {object} modalRefs - Referencje do element贸w HTML modala (taskModal lub newTaskModal).
 * @param {string} currency - Symbol waluty projektu.
 */
function updateTaskBudgetTotal(modalRefs, currency = '') {
    const itemAmountInputs = modalRefs.budgetItemsList.querySelectorAll('.task-budget-item-amount');
    let itemsSum = 0;
    itemAmountInputs.forEach(input => {
        // Dodajemy tylko poprawne, dodatnie wartoci
        const value = parseFloat(input.value);
        if (!isNaN(value) && value > 0) {
            itemsSum += value;
        }
    });

    modalRefs.budgetTotalSpan.textContent = itemsSum.toLocaleString('pl-PL', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    modalRefs.budgetCurrencySpan.textContent = currency;
    // Wyczy bdy walidacji przy ka偶dej aktualizacji sumy (bo u偶ytkownik co zmienia)
    modalRefs.budgetErrorP.textContent = '';
}
    /**
     * NOWA FUNKCJA (Wersja 4 - Ultimate Fix):
     * Oblicza bud偶et metod penego sumowania (Addytywn).
     * Sumuje niezale偶nie pozycje przypisane do Zadania G贸wnego ORAZ pozycje Podzada.
     */
    function calculateProjectBudgetSummary(tasks = []) {
        let totalReserved = 0;
        let totalSpent = 0;
        const itemsReserved = {}; 
        const itemsSpent = {};    

        // Funkcja pomocnicza do dodawania kwot
        const addToSummary = (name, amount, isSpent) => {
            const val = parseFloat(amount) || 0;
            if (val <= 0 || !name) return;

            if (isSpent) {
                totalSpent += val;
                itemsSpent[name] = (itemsSpent[name] || 0) + val;
            } else {
                totalReserved += val;
                itemsReserved[name] = (itemsReserved[name] || 0) + val;
            }
        };

        tasks.forEach(task => {
            // Sprawdzamy, czy zadanie posiada podzadania
            const hasSubtasks = task.subtasks && Array.isArray(task.subtasks) && task.subtasks.length > 0;

            // 1. KOSZTY ZADANIA GWNEGO
            // ZMIANA: Liczymy je TYLKO wtedy, gdy zadanie NIE MA podzada.
            // Jeli ma podzadania, to 'task.budgetItems' jest tylko agregatem, wic go pomijamy, by nie dublowa.
            if (!hasSubtasks && task.budgetItems && Array.isArray(task.budgetItems) && task.budgetItems.length > 0) {
                const isMainSpent = task.status === 'done';
                task.budgetItems.forEach(item => {
                    addToSummary(item.name, item.amount, isMainSpent);
                });
            }

            // 2. KOSZTY PODZADA
            if (hasSubtasks) {
                task.subtasks.forEach(sub => {
                    if (sub.budgetItems && Array.isArray(sub.budgetItems) && sub.budgetItems.length > 0) {
                        // Status kosztu zale偶y WYCZNIE od ukoczenia podzadania
                        const isSubSpent = sub.isCompleted === true;
                        
                        sub.budgetItems.forEach(item => {
                            addToSummary(item.name, item.amount, isSubSpent);
                        });
                    }
                });
            }
        });

        // Jeli brak jakichkolwiek koszt贸w, zwr贸 pusty obiekt (zamiast null, 偶eby render nie wybuch)
        // Chocia偶 w renderProjectBudgetChartCSS u偶ywamy ?. wic null jest OK, 
        // ale dla bezpieczestwa zwracamy zera jeli funkcja tego oczekuje.
        // Tutaj jednak oryginalnie zwracalimy null lub obiekt.
        
        // === NAPRAWA BDU: Zwracamy obiekt z zerami zamiast null ===
        if (totalReserved === 0 && totalSpent === 0) {
            return { 
                totalReserved: 0, 
                totalSpent: 0, 
                itemsReserved: {}, 
                itemsSpent: {} 
            };
        }
        // === KONIEC NAPRAWY ===

        const round = (val) => parseFloat(val.toFixed(2));
        for (const itemName in itemsReserved) itemsReserved[itemName] = round(itemsReserved[itemName]);
        for (const itemName in itemsSpent) itemsSpent[itemName] = round(itemsSpent[itemName]);

        return { 
            totalReserved: round(totalReserved), 
            totalSpent: round(totalSpent), 
            itemsReserved: itemsReserved, 
            itemsSpent: itemsSpent 
        };
    }
        // === POCZTEK ZMIANY: Nowe funkcje pomocnicze ===
        
        /**
         * Zatrzymuje wszystkie aktywne subskrypcje Firestore.
         * Niezbdne przy wylogowywaniu lub przeczaniu grup.
         */
        function unsubscribeAllListeners() {
            // KROK 1.1: Dodanie brakujcego listenera dokumentu u偶ytkownika
            if (state.ui.unsubscribeUserDoc) state.ui.unsubscribeUserDoc(); // <-- TA LINIA ZOSTAA DODANA
            
            if (state.ui.unsubscribeProjects) state.ui.unsubscribeProjects();
            if (state.ui.unsubscribeCompleted) state.ui.unsubscribeCompleted();
            if (state.ui.unsubscribeUsers) state.ui.unsubscribeUsers();
            if (state.ui.unsubscribeNotifications) state.ui.unsubscribeNotifications();
            if (state.ui.unsubscribePolls) state.ui.unsubscribePolls();
            if (state.ui.unsubscribeChatMessages) state.ui.unsubscribeChatMessages(); 
            if (state.ui.unsubscribeGlobalProjects) state.ui.unsubscribeGlobalProjects();
            if (state.ui.unsubscribeGlobalCompletedProjects) state.ui.unsubscribeGlobalCompletedProjects();
            
            // KROK 1.2: Ustawienie go na null
            state.ui.unsubscribeUserDoc = null; // <-- TA LINIA ZOSTAA DODANA
            
            state.ui.unsubscribeProjects = null;
            state.ui.unsubscribeCompleted = null;
            state.ui.unsubscribeUsers = null;
            state.ui.unsubscribeNotifications = null;
            state.ui.unsubscribePolls = null;
            state.ui.unsubscribeGlobalProjects = null;
            state.ui.unsubscribeGlobalCompletedProjects = null;
            
            console.log("Zatrzymano wszystkie suchacze Firestore.");
        }

        /**
         * Asynchronicznie zapisuje ostatnio wybran grup w profilu u偶ytkownika.
         */
        async function saveActiveGroup(groupId) {
            if (!state.currentUser) return;
            try {
                const userRef = doc(usersRef, state.currentUser.uid);
                await updateDoc(userRef, { lastActiveGroupId: groupId });
                state.currentUser.lastActiveGroupId = groupId;
            } catch (error) {
                console.error("Bd zapisu ostatniej aktywnej grupy:", error);
            }
        }
        
        /**
         * Logika przeczania grup roboczych.
         */
        async function handleGroupSwitch(newGroupId) {
            if (newGroupId === state.ui.activeGroupId) {
                console.log("Ta grupa jest ju偶 aktywna.");
                return;
            }

            console.log(`Przeczanie na grup: ${newGroupId}`);
            loadingOverlay.style.display = 'flex'; // Poka偶 ekran adowania

            // 1. Zapisz now grup w tle
            saveActiveGroup(newGroupId);

            // 2. Zaktualizuj stan lokalny
            state.ui.activeGroupId = newGroupId;
            state.ui.activeGroupInfo = state.currentUser.groupInfo[newGroupId];
            
            // Ustawiamy widok domylny dla nowej grupy
            state.ui.currentView = 'my-dashboard';
            state.currentProjectId = null;

            // 3. Wyczy stare dane i suchaczy
            unsubscribeAllListeners();
            state.projects = [];
            state.completedProjects = [];
            state.users = [];
            state.polls = [];
            state.notifications = [];

            // 4. Uruchom nowe suchacze dla nowej grupy
            // (loadingOverlay zostanie ukryty wewntrz setupFirestoreListeners)
            setupFirestoreListeners(state.currentUser.uid, newGroupId);
            
            // 5. Natychmiastowe odwie偶enie UI (poka偶e pusty stan przed nadejciem danych)
            render();
        }

        // === KONIEC NOWYCH FUNKCJI POMOCNICZYCH ===
        // === NOWE FUNKCJE: OBSUGA KOSZA (TRASH BIN) ===
        
        const trashModal = {
            overlay: document.getElementById('trash-modal'),
            list: document.getElementById('trash-list'),
            openBtn: document.getElementById('open-trash-btn')
        };

        /**
         * Otwiera modal kosza dla bie偶cego projektu.
         */
        function openTrashModal() {
            const projectId = state.currentProjectId;
            const project = findProject(projectId);

            if (!project) {
                showNotification("Kosz dostpny jest tylko w widoku projektu.", "Informacja");
                return;
            }

            renderTrashList(project);
            openModal(trashModal.overlay);
        }

        /**
         * Renderuje list usunitych zada w modalu.
         */
        function renderTrashList(project) {
            const deletedTasks = project.deletedTasks || [];
            
            trashModal.list.innerHTML = '';

            if (deletedTasks.length === 0) {
                trashModal.list.innerHTML = '<li style="text-align: center; color: var(--text-secondary); padding: 20px;">Kosz jest pusty.</li>';
                return;
            }

            // Sortuj od najnowszych usunitych
            deletedTasks.sort((a, b) => (b.deletedAt || 0) - (a.deletedAt || 0));

            deletedTasks.forEach(task => {
                const li = document.createElement('li');
                li.className = 'trash-item';
                
                const deletedDate = task.deletedAt ? new Date(task.deletedAt).toLocaleString('pl-PL') : 'Nieznana data';
                // Sprawd藕 uprawnienia (Waciciel, Administrator LUB Super User)
                // === ZMIANA: Dodano uprawnienia dla Super Usera ===
                const canRestore = project.ownerId === state.currentUser.uid || 
                                   (project.admins || []).includes(state.currentUser.uid) ||
                                   (project.superUsers || []).includes(state.currentUser.uid);
                // === KONIEC ZMIANY ===

                // Przyciski akcji
                let actionsHTML = '';
                if (canRestore) {
                    actionsHTML = `
                        <button class="btn-restore js-trash-restore" data-task-id="${task.id}">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width:14px;height:14px;">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M9 15L3 9m0 0l6-6M3 9h12a6 6 0 010 12h-3" />
                            </svg>
                            Przywr贸
                        </button>
                        <button class="btn-delete-forever js-trash-delete-forever" data-task-id="${task.id}" title="Usu bezpowrotnie">&times;</button>
                    `;
                } else {
                    actionsHTML = `<span style="font-size:11px; color:var(--text-secondary);">Brak uprawnie</span>`;
                }

                li.innerHTML = `
                    <div class="trash-item-info">
                        <span class="trash-item-title">${task.title}</span>
                        <span class="trash-item-meta">Usunito: ${deletedDate}</span>
                    </div>
                    <div class="trash-item-actions">
                        ${actionsHTML}
                    </div>
                `;
                trashModal.list.appendChild(li);
            });
        }

        /**
         * Przywraca zadanie z kosza do aktywnych zada.
         */
        async function restoreTask(taskId) {
            const projectId = state.currentProjectId;
            const project = findProject(projectId);
            if (!project) return;

            // 1. Znajd藕 element w koszu
            const itemToRestore = (project.deletedTasks || []).find(t => t.id === taskId);
            if (!itemToRestore) return;

            // 2. Wyczy metadane usunicia (wsp贸lne dla obu typ贸w)
            const restoredItem = { ...itemToRestore };
            delete restoredItem.deletedAt;
            delete restoredItem.deletedBy;

            // 3. Przygotuj now list aktywnych zada (na razie kopi obecnych)
            let newActiveTasks = [...(project.tasks || [])];
            let restoreMessage = "Zadanie zostao przywr贸cone.";

            // 4. Logika rozgaziona: Podzadanie vs Zadanie G贸wne
            if (restoredItem.isSubtask && restoredItem.originalParentId) {
                // --- TO JEST PODZADANIE ---
                
                // Szukamy rodzica w aktywnych zadaniach
                const parentIndex = newActiveTasks.findIndex(t => t.id === restoredItem.originalParentId);

                if (parentIndex !== -1) {
                    // SCENARIUSZ A: Rodzic istnieje
                    const parentTask = { ...newActiveTasks[parentIndex] };
                    
                    // Czycimy metadane specyficzne dla kosza podzada
                    delete restoredItem.isSubtask;
                    delete restoredItem.originalParentId;
                    delete restoredItem.originalParentTitle;

                    // Dodajemy do tablicy subtasks rodzica
                    if (!parentTask.subtasks) parentTask.subtasks = [];
                    parentTask.subtasks.push(restoredItem);

                    // Aktualizujemy rodzica w g贸wnej licie
                    newActiveTasks[parentIndex] = parentTask;
                    
                    restoreMessage = `Podzadanie przywr贸cone do zadania "${parentTask.title}".`;

                } else {
                    // SCENARIUSZ B: Rodzic NIE istnieje (np. zosta te偶 usunity trwale)
                    // Przywracamy jako Zadanie G贸wne (konwersja)
                    
                    delete restoredItem.isSubtask;
                    delete restoredItem.originalParentId;
                    delete restoredItem.originalParentTitle;
                    
                    // Dodajemy jako nowe zadanie g贸wne
                    newActiveTasks.push(restoredItem);
                    
                    restoreMessage = "Zadanie nadrzdne nie istnieje. Przywr贸cono jako g贸wne zadanie.";
                }

            } else {
                // --- TO JEST ZADANIE GWNE ---
                newActiveTasks.push(restoredItem);
            }

            // 5. Usu z listy deletedTasks
            const newDeletedTasks = project.deletedTasks.filter(t => t.id !== taskId);

            const projectDocRef = doc(projectsRef, projectId);
            
            try {
                // Przelicz bud偶et (teraz uwzgldnia przywr贸cone elementy)
                const newBudgetSummary = calculateProjectBudgetSummary(newActiveTasks);

                const batch = writeBatch(db);
                batch.update(projectDocRef, { 
                    tasks: newActiveTasks,
                    deletedTasks: newDeletedTasks,
                    budgetSummary: newBudgetSummary
                });
                
                await batch.commit();
                
                showNotification(restoreMessage, "Sukces");
                
                // Odwie偶 widok kosza lokalnie dla pynnoci
                const tempProject = { ...project, deletedTasks: newDeletedTasks };
                renderTrashList(tempProject);

            } catch (error) {
                console.error("Bd przywracania:", error);
                showNotification("Nie udao si przywr贸ci elementu.", "Bd");
            }
        }

        /**
         * Usuwa zadanie trwale z kosza.
         */
        async function deleteForever(taskId) {
            const projectId = state.currentProjectId;
            const project = findProject(projectId);
            if (!project) return;

            showConfirmation(
                "Usu bezpowrotnie", 
                "Czy na pewno chcesz trwale usun to zadanie? Tej operacji nie mo偶na cofn.", 
                async (confirmed) => {
                    if (confirmed) {
                        try {
                            const newDeletedTasks = (project.deletedTasks || []).filter(t => t.id !== taskId);
                            const projectDocRef = doc(projectsRef, projectId);
                            
                            await updateDoc(projectDocRef, {
                                deletedTasks: newDeletedTasks
                            });
                            
                            // Odwie偶 list w modalu
                            const tempProject = { ...project, deletedTasks: newDeletedTasks };
                            renderTrashList(tempProject);
                            
                        } catch (error) {
                             console.error("Bd trwaego usuwania:", error);
                             showNotification("Wystpi bd.", "Bd");
                        }
                    }
                }, 
                true
            );
        }

        // Listenery dla kosza
        if (trashModal.openBtn) {
            trashModal.openBtn.addEventListener('click', openTrashModal);
        }

        trashModal.list.addEventListener('click', (e) => {
            const restoreBtn = e.target.closest('.js-trash-restore');
            const deleteForeverBtn = e.target.closest('.js-trash-delete-forever');

            if (restoreBtn) {
                restoreTask(restoreBtn.dataset.taskId);
            } else if (deleteForeverBtn) {
                deleteForever(deleteForeverBtn.dataset.taskId);
            }
        });
        // === ZMODYFIKOWANA FUNKCJA: `setupFirestoreListeners` ===
        
        /**
         * Uruchamia wszystkie niezbdne suchacze Firestore dla DANEJ GRUPY.
         * @param {string} userId - ID zalogowanego u偶ytkownika.
         * @param {string} groupId - ID aktywnej grupy do monitorowania.
         */
        function setupFirestoreListeners(userId, groupId) {
            if (!userId || !groupId) {
                console.error("Bd krytyczny: setupFirestoreListeners wywoane bez userId lub groupId.");
                return;
            }
            
            // Wyczy ewentualne stare suchacze (zabezpieczenie)
            unsubscribeAllListeners();
            console.log(`[Nowe Listenery] Uruchamianie dla U偶ytkownika: ${userId} w Grupie: ${groupId}`);

            // --- 1. Suchacz U偶ytkownik贸w ---
            // Pobierz WSZYSTKICH u偶ytkownik贸w, kt贸rzy s w tej samej grupie co ja
            const usersQuery = query(usersRef, where("groupIds", "array-contains", groupId));
            state.ui.unsubscribeUsers = onSnapshot(usersQuery, (snapshot) => {
                state.users = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                console.log(`[Listener Users] Zaadowano ${state.users.length} u偶ytkownik贸w dla grupy ${groupId}.`);
                // Nie renderujemy tutaj, czekamy na projekty
            }, (error) => console.error(`Bd odczytu u偶ytkownik贸w dla grupy ${groupId}:`, error));

            // --- 2. Suchacz Aktywnych Projekt贸w ---
            // Pobierz projekty, kt贸re nale偶 do tej grupy I w kt贸rych jestem czonkiem
            const projectsQuery = query(projectsRef,
                where("groupId", "==", groupId),
                where("members", "array-contains", userId)
            );
            state.ui.unsubscribeProjects = onSnapshot(projectsQuery, (snapshot) => {
                state.projects = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                console.log(`[Listener Projects] Zaadowano ${state.projects.length} projekt贸w dla grupy ${groupId}.`);
                
                // Sprawdzanie sp贸jnoci (czy stary projectId nadal istnieje)
                const isProjectView = state.ui.currentView === 'projects';
                 if (isProjectView && state.currentProjectId) {
                     const stillExists = state.projects.some(p => p.id === state.currentProjectId) ||
                                       state.completedProjects.some(p => p.id === state.currentProjectId);
                     if (!stillExists) {
                         const nextProject = state.projects.find(p => !p.isInbox) || state.projects.find(p => p.isInbox);
                         state.currentProjectId = nextProject ? nextProject.id : null;
                         if (!state.currentProjectId) {
                            state.ui.currentView = 'my-dashboard';
                         }
                         saveUiState();
                     }
                 }
                 loadingOverlay.style.display = 'none'; // Ukryj adowanie po pobraniu projekt贸w
                 render(); // Renderuj
            }, (error) => {
                console.error(`Bd odczytu projekt贸w dla grupy ${groupId}:`, error);
                loadingOverlay.innerHTML = `<p>Bd dostpu do bazy danych.<br><small>Komunikat: ${error.message}</small></p>`;
            });

            // --- 3. Suchacz Zakoczonych Projekt贸w ---
             const completedQuery = query(completedProjectsRef,
                where("groupId", "==", groupId),
                where("members", "array-contains", userId)
            );
            state.ui.unsubscribeCompleted = onSnapshot(completedQuery, (snapshot) => {
                state.completedProjects = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                console.log(`[Listener Completed] Zaadowano ${state.completedProjects.length} zakoczonych projekt贸w dla grupy ${groupId}.`);
                render(); 
            }, (error) => {
                 console.error(`Bd odczytu zakoczonych projekt贸w dla grupy ${groupId}:`, error)
            });
            
            // --- 4. Suchacz Sonda偶y ---
            const pollsQuery = query(pollsRef, where("groupId", "==", groupId));
            state.ui.unsubscribePolls = onSnapshot(pollsQuery, (snapshot) => {
                state.polls = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                console.log(`[Listener Polls] Zaadowano ${state.polls.length} sonda偶y dla grupy ${groupId}.`);
                render(); 
            }, (error) => {
                console.error(`Bd odczytu sonda偶y dla grupy ${groupId}:`, error)
            });

            // --- 5. Suchacz Powiadomie ---
             const notificationsRef = collection(db, `artifacts/${appId}/public/data/notifications`);
             // Pobierz powiadomienia dla mnie ORAZ dla tej aktywnej grupy
             const notificationsQuery = query(notificationsRef, 
                where("userId", "==", userId),
                where("groupId", "==", groupId), // NOWY FILTR
                orderBy("timestamp", "desc")
             );
             state.ui.unsubscribeNotifications = onSnapshot(notificationsQuery, (snapshot) => {
                 state.notifications = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                 console.log(`[Listener Notifications] Zaadowano ${state.notifications.length} powiadomie dla grupy ${groupId}.`);
                 render(); 
             }, (error) => {
                  console.error(`Bd odczytu powiadomie dla grupy ${groupId}:`, error);
             });
        }
        loadUiState();
        initializeCalendar();
       // === POCZTEK: INICJALIZACJA TRIBUTE.JS DLA WZMIANEK ===
        try {
            const tribute = new Tribute({
                // U偶yj triggera '@'
                trigger: '@',
                
                // Pobierz list u偶ytkownik贸w dynamicznie ze stanu aplikacji
                values: function(text, cb) {
                    const project = findProject(state.currentProjectId);
                    if (!project) {
                        cb([]); // Jeli nie ma projektu, nie pokazuj nikogo
                        return;
                    }
                    
                    // Mapuj u偶ytkownik贸w projektu na format wymagany przez Tribute
                    const projectUsers = project.members
                        .map(findUser)
                        .filter(Boolean); // Odfiltruj jeli kogo nie znajdzie
                        
                   const tributeUsers = projectUsers.map(user => ({
                        // 'name' bdzie u偶ywane do wyszukiwania (np. "Jan Kowalski")
                        name: user.name || user.email, 
                        // 'value' to co zostanie wstawione (np. "MateuszCzerwinski" lub "wlascicieltestcom")
                        value: (user.name || user.email).replace(/[^a-zA-Z0-9]/g, ''), // <-- NOWA ZMIANA
                        // 'avatarHTML' to niestandardowe pole dla naszego szablonu
                        avatarHTML: renderAvatarHTML(user, 'avatar-mention')
                    }));
                    
                    cb(tributeUsers);
                },
                
                // Klucz, po kt贸rym Tribute ma wyszukiwa wpisywany tekst
                lookup: 'name',

                // Szablon, kt贸ry definiuje wygld ka偶dego elementu na licie wyboru
                itemTemplate: function(item) {
                    return `${item.original.avatarHTML} <span>${item.original.name}</span>`;
                },

                // Co ma zosta wstawione do textarea po wyborze
                selectTemplate: function(item) {
                    return `@${item.original.value}`;
                },

                // Nie dodawaj spacji po wzmiance
                noMatchTemplate: null,
                allowSpaces: false,
                menuItemLimit: 5,
            });
            
            // Podcz Tribute do pola tekstowego w modalu zadania
            tribute.attach(taskModal.newCommentText);
        } catch(e) {
            console.error("Nie udao si zainicjowa biblioteki Tribute.js dla wzmianek.", e);
        }
        // === KONIEC: INICJALIZACJA TRIBUTE.JS ===

        
        async function handleFirstLoginSubgroupSelection(userId, groupId) {
            const modal = {
                overlay: document.getElementById('select-subgroup-modal'),
                form: document.getElementById('select-subgroup-form'),
                select: document.getElementById('subgroup-selection-select'),
            };

            try {
                // Krok 1: Pobierz dane grupy, aby znale藕 dostpne podgrupy
                const groupDoc = await getDoc(doc(groupsRef, groupId));
                if (!groupDoc.exists()) {
                    throw new Error("Nie znaleziono Twojej grupy. Skontaktuj si z administratorem.");
                }

                const subgroups = groupDoc.data().subgroups || [];
                if (subgroups.length === 0) {
                     // Jeli grupa nie ma dzia贸w, oznaczamy, 偶e u偶ytkownik "wybra" (bo nie mia z czego) i kontynuujemy.
                    await updateDoc(doc(usersRef, userId), { hasSelectedSubgroup: true });
                    return; // Zakocz funkcj
                }

                // Krok 2: Wypenij list wyboru w modalu
                modal.select.innerHTML = '<option value="">-- Prosz wybra --</option>';
                subgroups.forEach(name => {
                    modal.select.innerHTML += `<option value="${name}">${name}</option>`;
                });

                // Krok 3: Poka偶 modal i poczekaj na akcj u偶ytkownika
                authOverlay.style.display = 'none'; // Ukryj ekran logowania
                openModal(modal.overlay);

                // Krok 4: Zwr贸 Promise, kt贸ry rozwi偶e si po wysaniu formularza
                return new Promise(resolve => {
                    modal.form.addEventListener('submit', async (e) => {
                        e.preventDefault();
                        const selectedSubgroup = modal.select.value;
                        if (!selectedSubgroup) {
                            alert("Prosz wybra dzia z listy.");
                            return;
                        }

                        // Zaktualizuj profil u偶ytkownika w Firestore
                        await updateDoc(doc(usersRef, userId), {
                            subgroupName: selectedSubgroup,
                            hasSelectedSubgroup: true
                        });

                        closeModal(modal.overlay);
                        resolve(); // Rozwi偶 Promise, aby onAuthStateChanged m贸g kontynuowa
                    }, { once: true }); // 'once: true' sprawia, 偶e listener uruchomi si tylko raz
                });

            } catch (error) {
                console.error("Bd podczas wyboru podgrupy:", error);
                // W przypadku bdu, wylogowujemy u偶ytkownika, aby m贸g spr贸bowa ponownie
                await signOut(auth);
                alert("Wystpi krytyczny bd podczas konfiguracji konta: " + error.message);
            }
        }
         onAuthStateChanged(auth, async (user) => {
    // === POCZTEK ZMIANY: Nowa logika `onAuthStateChanged` ===
    if (user) {
        
        // === USUNITO: Logika linku zaproszeniowego (przeniesiona do Fazy 5) ===

        let userDocRef = doc(usersRef, user.uid);
        let userDoc = await getDoc(userDocRef);

        // --- INTELIGENTNA WERYFIKACJA (BEZ ZMIAN) ---
        const creationTime = new Date(user.metadata.creationTime).getTime();
        const lastSignInTime = new Date(user.metadata.lastSignInTime).getTime();
        const isNewUser = (lastSignInTime - creationTime) < 5000;

        if (!userDoc.exists() && !isNewUser) {
            console.error("Weryfikacja nieudana: U偶ytkownik nie istnieje w bazie danych. Wymuszanie wylogowania.");
            await signOut(auth);
            return;
        }
        
        let userData = userDoc.data();
        if (!userData) {
            await new Promise(resolve => setTimeout(resolve, 500));
            const freshUserDoc = await getDoc(userDocRef);
            userData = freshUserDoc.data();
        }

        if (!userData) {
             console.error("Krytyczny bd: Nie udao si wczyta danych profilu po rejestracji.");
             await signOut(auth);
             return;
        }
        // --- KONIEC INTELIGENTNEJ WERYFIKACJI ---
        
        // === POCZTEK ZMIANY: NOWA LOGIKA POCZEKALNI ===
        
        // SCENARIUSZ 0: U偶ytkownik czeka na akceptacj
        if (userData.status === 'pending_approval' && userData.pendingGroupId) {
            console.log("U偶ytkownik w poczekalni. Pokazuj #waiting-room-overlay.");
            authOverlay.style.display = 'none'; // Ukryj ekran logowania
            appContainer.classList.add('hidden'); // Ukryj g贸wn apk
            
            // Znajd藕 nazw grupy, do kt贸rej chce doczy
            const groupDoc = await getDoc(doc(groupsRef, userData.pendingGroupId));
            const groupName = groupDoc.exists() ? groupDoc.data().name : "[usunita grupa]";

            document.getElementById('waiting-room-group-name').textContent = groupName;
            
            // Poka偶 overlay poczekalni
            const waitingRoom = document.getElementById('waiting-room-overlay');
            openModal(waitingRoom);
            
            // Rozpocznij nasuchiwanie na zmian statusu
            // U偶yjemy `unsubUser` z `unsubscribeAllListeners`, aby go ledzi
            if (state.ui.unsubscribeUsers) state.ui.unsubscribeUsers();
            state.ui.unsubscribeUsers = onSnapshot(userDocRef, (doc) => {
                const updatedUserData = doc.data();
                if (updatedUserData.status === 'active') {
                    // AKCEPTOWANY! Przeaduj aplikacj
                    console.log("U偶ytkownik zaakceptowany! Przeadowuj...");
                    window.location.reload();
                } else if (updatedUserData.status === 'rejected') {
                    // ODRZUCONY
                    document.getElementById('waiting-room-status').textContent = "Status: Odrzucono";
                    document.getElementById('waiting-room-status').style.color = "var(--danger-primary)";
                    document.getElementById('waiting-room-overlay').querySelector('p:nth-of-type(2)').textContent = "Twoja proba o doczenie zostaa odrzucona przez waciciela. Mo偶esz si wylogowa lub skontaktowa z administratorem.";
                    unsubscribeAllListeners(); // Zatrzymaj suchanie
                }
            });
            
            // Zatrzymaj dalsze adowanie aplikacji
            return;
        }
        
        // === KONIEC ZMIANY ===
        
        // --- NOWA LOGIKA: Sprawdzanie przynale偶noci do grup ---
        
        const userGroupsIds = userData.groupIds || [];
        const userGroupInfo = userData.groupInfo || {};
        
        // === ZMIANA: Dodano warunek && userData.status !== 'pending_approval' ===
        if (userGroupsIds.length === 0 && userData.status !== 'pending_approval') {
            // SCENARIUSZ 1: U偶ytkownik jest 'active', ale nie ma 偶adnej grupy.
            // (np. nowy u偶ytkownik po rejestracji solo)
            // Wymuszamy stworzenie pierwszej grupy.
            console.log("U偶ytkownik nie ma grup. Otwieram modal #create-first-group-modal.");
            authOverlay.style.display = 'none'; // Ukryj ekran logowania
            appContainer.classList.add('hidden'); // Ukryj g贸wn apk
            openModal(document.getElementById('create-first-group-modal'));
            // Przerywamy dalsze adowanie, czekamy na akcj w modalu
            return;
        }
        
        // SCENARIUSZ 2: U偶ytkownik ma grupy. adujemy aplikacj.
        authOverlay.style.display = 'none';
        appContainer.classList.remove('hidden');
        loadingOverlay.style.display = 'flex';
        // === NOWA LOGIKA: WYKRYWANIE MEDIAN I INICJALIZACJA MOWY ===
        if (isMedianWebView()) {
            console.log("Wykryto Median WebView. Funkcje gosowe AI (Speech API) zostan wyczone.");
            // Domylnie elementy s ukryte, wic nie trzeba nic robi.
        } else {
            console.log("Wykryto przegldark Web. Inicjalizuj funkcje gosowe AI.");
            // Poka偶 przycisk mikrofonu i status (bo w HTML s ukryte)
            if (aiHelpModal.micBtn) aiHelpModal.micBtn.style.display = 'inline-flex';
            if (aiHelpModal.statusBar) aiHelpModal.statusBar.style.display = 'block';
            
            // Uruchom g贸wn funkcj inicjalizujc logik mowy
            initVoiceConversation();
        }
        // === KONIEC NOWEJ LOGIKI ===
        // --- USUNITO: Logika `handleFirstLoginSubgroupSelection` ---

        // --- NOWA LOGIKA: Scalanie ukadu dashboardu (BEZ ZMIAN) ---
        const defaultDashboardLayout = ['my-overdue', 'team-delays', 'upcoming', 'workload', 'activity', 'team-workload', 'my-budget', 'user-budget'];
        let userDashboardLayout = userData.layouts?.dashboard || [...defaultDashboardLayout];
        defaultDashboardLayout.forEach(kpiId => {
            if (!userDashboardLayout.includes(kpiId)) {
                userDashboardLayout.push(kpiId);
            }
        });
        
        
        // --- NOWA LOGIKA: Ustawienie `state.currentUser` ---
        // --- NOWA LOGIKA: Ustawienie state.currentUser ---
        state.currentUser = {
            id: user.uid,
            uid: user.uid,
            email: user.email,
            name: userData.name,
            avatarColor: userData.avatarColor,
            photoURL: userData.photoURL,
            // Grupy
            groupIds: userGroupsIds,
            groupInfo: userGroupInfo,
            lastActiveGroupId: userData.lastActiveGroupId,
            // Reszta
            favorites: userData.favorites || [],
            layouts: { 
                dashboard: userDashboardLayout,
                allProjects: userData.layouts?.allProjects || []
            },
            chatLastViewed: userData.chatLastViewed || {},
            showWelcomeModal: userData.showWelcomeModal,
            // === WA呕NE: Zapisz preferencje w obiekcie usera do por贸wnywania przy zapisie ===
            preferences: userData.preferences || {} 
        };

        // === SYNCHRONIZACJA (PULL): Aplikuj ustawienia z Firestore do aplikacji ===
        const prefs = userData.preferences || {};
        
        // 1. Motyw
        if (prefs.theme) {
            state.ui.theme = prefs.theme;
            applyTheme(); // Aplikuj natychmiast
        }
        // 2. Widok Startowy
        if (prefs.startView) state.ui.startView = prefs.startView;
        
        // 3. Konfetti (uwaga: sprawdzamy undefined, bo false to te偶 warto)
        if (prefs.showConfetti !== undefined) state.ui.showConfetti = prefs.showConfetti;
        
        // 4. Potwierdzenia
        if (prefs.confirmDelete !== undefined) state.ui.confirmDelete = prefs.confirmDelete;
        // 4b. Rozwijanie podzada (NOWE)
            if (prefs.expandSubtasksByDefault !== undefined) state.ui.expandSubtasksByDefault = prefs.expandSubtasksByDefault;
        // === NOWE: 5. Tryb Kompaktowy ===
        if (prefs.compactMode !== undefined) {
            state.ui.compactMode = prefs.compactMode;
            applyInterfaceSettings(); // Aplikuj natychmiast po zaadowaniu usera
        }

        // === NOWE: 6. Start ze zwinitym paskiem ===
        if (prefs.startCollapsed !== undefined) {
            state.ui.startCollapsed = prefs.startCollapsed;
            
            // Jeli u偶ytkownik chce startowa ze zwinitym paskiem, wymu to teraz
            // (Chyba 偶e jestemy na mobile, tam pasek i tak jest domylnie ukryty)
            if (state.ui.startCollapsed && window.innerWidth > 768) {
                state.ui.sidebarCollapsed = true;
                applySidebarState(); // Funkcja pomocnicza istniejca w kodzie
            }
        }

        // Zaktualizuj localStorage, aby byy zgodne z chmur
        saveUiState();
        // === KONIEC SYNCHRONIZACJI ===
        
        // --- NOWA LOGIKA: Ustalenie aktywnej grupy ---
        let groupIdToLoad = state.currentUser.lastActiveGroupId;
        if (!groupIdToLoad || !state.currentUser.groupIds.includes(groupIdToLoad)) {
            groupIdToLoad = state.currentUser.groupIds[0]; 
        }

        state.ui.activeGroupId = groupIdToLoad;
        state.ui.activeGroupInfo = state.currentUser.groupInfo[groupIdToLoad];
             // === POCZTEK ZMIANY: Wywoanie modala powitalnego ===
        // Sprawdzamy, czy flaga showWelcomeModal jest inna ni偶 false
        // (obejmuje to 'true' oraz 'undefined', czyli nowych u偶ytkownik贸w)
        if (userData.showWelcomeModal !== false) {
            openWelcomeModal();
        }
        // === KONIEC ZMIANY ===
        
        // === NOWA LOGIKA: Deep Linking (Obsuga parametru projectId) ===
        const urlParams = new URLSearchParams(window.location.search);
        const deepLinkProjectId = urlParams.get('projectId');
        
        if (deepLinkProjectId) {
            // ... (Deep linking bez zmian) ...
            state.currentProjectId = deepLinkProjectId;
            state.ui.currentView = 'projects';
        } else {
            // === ZMODYFIKOWANA LOGIKA STARTOWA (Zgodna z ustawieniami) ===
            const prefView = state.ui.startView || 'auto';
            
            if (prefView === 'auto') {
                // Stara logika: Mobile -> M贸j Dzie, Desktop -> Dashboard
                if (window.innerWidth <= 768) {
                    state.ui.currentView = 'my-day';
                } else {
                    state.ui.currentView = 'my-dashboard';
                }
            } else {
                // U偶yj preferencji u偶ytkownika ('my-day', 'my-dashboard', 'all-projects')
                state.ui.currentView = prefView;
            }
            state.currentProjectId = null;
            // === KONIEC MODYFIKACJI ===
        }
        // === KONIEC NOWEJ LOGIKI ===
        
        userEmailDisplay.textContent = state.currentUser.email;
        // === NOWY LISTENER: Stae nasuchiwanie na DOKUMENT U呕YTKOWNIKA ===
        // To jest kluczowe, aby zmiany w 'chatLastViewed' odwie偶ay stan.
        if (state.ui.unsubscribeUserDoc) state.ui.unsubscribeUserDoc(); // Wyczy stary, jeli istnieje
        state.ui.unsubscribeUserDoc = onSnapshot(userDocRef, (doc) => {
            const updatedData = doc.data();
            if (updatedData) {
                console.log("[Listener U偶ytkownika] Wykryto zmiany w dokumencie u偶ytkownika.");
                // Aktualizuj tylko te pola w stanie, kt贸re mogy si zmieni dynamicznie
                state.currentUser.chatLastViewed = updatedData.chatLastViewed || {};
                state.currentUser.favorites = updatedData.favorites || [];
                state.currentUser.layouts = updatedData.layouts || state.currentUser.layouts;
                state.currentUser.name = updatedData.name;
                state.currentUser.photoURL = updatedData.photoURL;
                
                // Przerenderuj aplikacj, aby odwie偶y UI (np. badge czatu)
                render(); 
            }
        });
        // === KONIEC NOWEGO LISTENERA ===
      // === POCZTEK POPRAWKI: Nowa, poprawna inicjalizacja listener贸w ===
        
        // === NOWA, POPRAWIONA INICJALIZACJA FLYOUTW I KLIKNI ===
        if (state.currentUser) {
            
            // --- Sekcja 1: Logika HOVER (Tylko Desktop) ---
            // Ta logika uruchamia flyouty (menu wysuwane) tylko na desktopie, gdy sidebar jest zwinity.
            if (window.innerWidth > 768) {
                const resourcesBtn = document.getElementById('resources-btn');
                const resourcesMenu = document.getElementById('resources-menu');
                
                // USUNITO: Definicje groupToggleBtn i groupMenu
                // USUNITO: Blok // 2. Przecznik Grupy (Desktop Hover)
            } // Koniec bloku if (window.innerWidth > 768)

            // --- Sekcja 2: Logika KLIKNICIA (Uniwersalna - Desktop i Mobile) ---
            // Ta sekcja jest teraz *poza* blokiem (window.innerWidth > 768),
            // dziki czemu listener kliknicia zostanie dodany r贸wnie偶 na mobilnych.
            
            const groupToggleBtn = document.getElementById('group-switcher-toggle');
            const groupMenu = document.getElementById('group-switcher-menu');

            if (groupToggleBtn && groupMenu) {
                groupToggleBtn.onclick = null; // Wyczy stary listener, jeli istnia
                groupToggleBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    
                    const isDesktop = window.innerWidth > 768;
                    const isCollapsed = appContainer.classList.contains('sidebar-collapsed');

                    // Zawsze przeczaj klas .open
                    groupToggleBtn.classList.toggle('open');
                    groupMenu.classList.toggle('open');

                    if (isDesktop && isCollapsed) {
                        // --- SCENARIUSZ 1: Desktop, Sidebar ZWINITY ---
                        // Ustaw pozycj flyoutu
                        const rect = groupToggleBtn.getBoundingClientRect();
                        groupMenu.style.position = 'absolute';
                        groupMenu.style.bottom = 'initial';
                        
                        const menuHeight = 250; 
                        if (rect.top + menuHeight > window.innerHeight) {
                             groupMenu.style.top = 'auto';
                             groupMenu.style.bottom = '5px';
                        } else {
                             groupMenu.style.top = `${rect.top}px`;
                             groupMenu.style.bottom = 'auto';
                        }
                        
                        groupMenu.style.left = '72px';
                        groupMenu.style.width = '220px';
                        groupMenu.style.zIndex = 3000;
                        
                    } else if (!isDesktop) {
                        // --- SCENARIUSZ 3: Mobile ---
                        // Poprawka dla mobilnego otwierania w g贸r
                        groupMenu.style.position = 'absolute';
                        groupMenu.style.top = 'auto';
                        groupMenu.style.bottom = '105%';
                        groupMenu.style.left = '0';
                        groupMenu.style.width = '100%';
                        groupMenu.style.zIndex = 2001;
                    } else {
                        // --- SCENARIUSZ 2: Desktop, Sidebar ROZWINITY ---
                        // Wyczy style inline
                        groupMenu.style.cssText = ''; 
                    }
                });
            }
        }
        // === KONIEC NOWEJ INICJALIZACJI ===
        
        // === KONIEC POPRAWKI ===
        // Listener ZALE呕NY OD GRUPY (bez zmian)
        setupFirestoreListeners(user.uid, state.ui.activeGroupId); 
        // === POCZTEK NOWEGO KODU: Ustawienie stanu sidebara przy adowaniu ===
        applySidebarState();
        // === KONIEC NOWEGO KODU ===
        
        // === NOWE LISTENERY GLOBALNE (dla M贸j Dzie) ===
        // 1. Globalny listener dla AKTYWNYCH projekt贸w u偶ytkownika
        const globalProjectsQuery = query(projectsRef, 
            where("members", "array-contains", user.uid)
        );
        state.ui.unsubscribeGlobalProjects = onSnapshot(globalProjectsQuery, (snapshot) => {
            state.globalUserProjects = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            console.log(`[Listener Global] Zaadowano ${state.globalUserProjects.length} wszystkich AKTYWNYCH projekt贸w u偶ytkownika.`);
            if (state.ui.currentView === 'my-day') {
                render(); // Odwie偶 widok M贸j Dzie, jeli jest aktywny
            }
        }, (error) => console.error(`Bd odczytu globalnych projekt贸w:`, error));

        // 2. Globalny listener dla ZAKOCZONYCH projekt贸w u偶ytkownika
        const globalCompletedQuery = query(completedProjectsRef, 
            where("members", "array-contains", user.uid)
        );
        state.ui.unsubscribeGlobalCompletedProjects = onSnapshot(globalCompletedQuery, (snapshot) => {
            state.globalUserCompletedProjects = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            console.log(`[Listener Global] Zaadowano ${state.globalUserCompletedProjects.length} wszystkich ZAKOCZONYCH projekt贸w u偶ytkownika.`);
            if (state.ui.currentView === 'my-day') {
                render(); // Odwie偶 widok M贸j Dzie, jeli jest aktywny
            }
        }, (error) => console.error(`Bd odczytu globalnych zakoczonych projekt贸w:`, error));
        // === KONIEC NOWYCH LISTENERW ===
        

        const newProjectBtn = document.getElementById('new-project-btn');
        if (newProjectBtn) {
            newProjectBtn.disabled = false;
        }

    } else { // U偶ytkownik jest wylogowany (logika w wikszoci bez zmian)
        const newProjectBtn = document.getElementById('new-project-btn');
         if (newProjectBtn) {
            newProjectBtn.disabled = true;
         }
        state.currentUser = null;
        state.notifications = []; 
        appContainer.classList.add('hidden');
        
        // Logika zaprosze (teraz odblokowana)
        try {
            const urlParams = new URLSearchParams(window.location.search);
            const action = urlParams.get('action');
            const inviteGroupId = urlParams.get('groupId');
            const inviteGroupName = urlParams.get('groupName');

            const teamToggle = document.getElementById('register-team-toggle');
            const joinRadio = document.querySelector('input[name="group-action"][value="join"]');
            const createRadio = document.querySelector('input[name="group-action"][value="create"]');
            const groupNameInput = document.getElementById('register-group-name');

            if (teamToggle) teamToggle.disabled = false;
            if (joinRadio) joinRadio.disabled = false;
            if (createRadio) createRadio.disabled = false;
            if (groupNameInput) groupNameInput.disabled = false;

            if (action === 'invite' && inviteGroupId && inviteGroupName) {
                
                document.getElementById('login-form').style.display = 'none';
                document.getElementById('register-form').style.display = 'block';

                if (teamToggle) {
                    teamToggle.checked = true;
                    document.getElementById('register-team-options').style.display = 'block';
                }

                if (joinRadio) {
                    joinRadio.checked = true;
                }
                
                if (groupNameInput) {
                    groupNameInput.value = decodeURIComponent(inviteGroupName);
                }

                window.history.replaceState({}, document.title, window.location.pathname);
            }
        } catch (e) {
            console.warn("Nie udao si sparsowa parametr贸w URL zaproszenia:", e);
        }
        
        authOverlay.style.display = 'flex';
        loadingOverlay.style.display = 'none';
        
        unsubscribeAllListeners();
    }
    // === KONIEC ZMIANY ===
});
       // === POCZTEK ZMIANY: Bezpieczny listener zamykajcy menu ===
// Ten listener jest teraz globalny i nie polega na zmiennych z DOMContentLoaded
document.addEventListener('click', (e) => {
    // Dynamicznie wyszukaj elementy przy ka偶dym klikniciu
    const toggle = document.getElementById('group-switcher-toggle');
    const menu = document.getElementById('group-switcher-menu');
    
    // Sprawd藕, czy elementy istniej (na wypadek bycia na ekranie logowania)
    if (toggle && menu) {
        // Sprawd藕, czy menu jest otwarte i czy kliknito poza nim
        if (menu.classList.contains('open') && !toggle.contains(e.target) && !menu.contains(e.target)) {
            toggle.classList.remove('open');
            menu.classList.remove('open');
        }
    }
});
// === KONIEC ZMIANY ===
        
        // --- LISTENERY ---
        const passwordResetForm = document.getElementById('password-reset-form');
const showPasswordResetBtn = document.getElementById('show-password-reset');
const showLoginFromResetBtn = document.getElementById('show-login-from-reset');
const authMessageReset = document.getElementById('auth-message-reset');

showPasswordResetBtn.addEventListener('click', () => {
    loginForm.style.display = 'none';
    registerForm.style.display = 'none';
    passwordResetForm.style.display = 'block';
});

const goBackToLogin = () => {
    passwordResetForm.style.display = 'none';
    registerForm.style.display = 'none';
    loginForm.style.display = 'block';
};

showLoginFromResetBtn.addEventListener('click', goBackToLogin);
// Nadpisujemy stary listener, aby uwzgldnia nowy formularz
showLoginBtn.addEventListener('click', goBackToLogin);
        // Listener do pokazywania/ukrywania opcji zespoowych
registerTeamToggle.addEventListener('change', () => {
    registerTeamOptions.style.display = registerTeamToggle.checked ? 'block' : 'none';
});

// Listener do dynamicznego sprawdzania grupy i wczytywania podgrup
/*
registerGroupNameInput.addEventListener('blur', async () => {
    // ... (stara logika rejestracji - skr贸cona dla czytelnoci, pozostaje zakomentowana) ...
        console.error("Bd wczytywania podgrup:", error);
        registerSubgroupSection.style.display = 'none';
    }
});
*/

// === NOWY LISTENER: Dodawanie komentarza w podzadaniu (LIVE) ===
// (ODKOMENTOWANO i PRZYWRCONO DO DZIAANIA)
if (subtaskModal.addCommentBtn) {
    subtaskModal.addCommentBtn.addEventListener('click', async (e) => {
        e.preventDefault(); // Zapobiega submitowaniu formularza
        const text = subtaskModal.commentInput.value.trim();
        if (!text) return;

        const mainTaskId = subtaskModal.overlay.dataset.mainTaskId;
        const subtaskId = subtaskModal.subtaskIdInput.value; // Mo偶e by pusty, jeli to nowe podzadanie
        const user = state.currentUser;

        const newComment = {
            id: `comm_${Date.now()}`,
            userId: user.uid,
            text: text,
            timestamp: Date.now()
        };

        // SCENARIUSZ 1: Edycja istniejcego podzadania (Zapisz do bazy od razu)
        if (subtaskId) {
            const {
                task: mainTask,
                project
            } = findTask(mainTaskId);
            if (!mainTask || !project) return;

            // Zaktualizuj lokalnie
            const updatedSubtasks = mainTask.subtasks.map(s => {
                if (s.id === subtaskId) {
                    return { ...s,
                        comments: [...(s.comments || []), newComment]
                    };
                }
                return s;
            });
            const updatedMainTask = { ...mainTask,
                subtasks: updatedSubtasks
            };

            try {
                subtaskModal.addCommentBtn.disabled = true;
                subtaskModal.addCommentBtn.textContent = '...';

                const projectDocRef = findProject(project.id) ? doc(projectsRef, project.id) : doc(completedProjectsRef, project.id);

                // Zapisz do Firestore
                await updateDoc(projectDocRef, {
                    tasks: project.tasks.map(t => t.id === mainTaskId ? updatedMainTask : t)
                });

                // Odwie偶 widok listy komentarzy
                const currentSubtask = updatedSubtasks.find(s => s.id === subtaskId);
                renderSubtaskComments(currentSubtask.comments);

                subtaskModal.commentInput.value = ''; // Wyczy input
            // === NOWA LOGIKA POWIADOMIE O WZMIANKACH (PODZADANIE) ===
                const mentionRegex = /@([a-zA-Z0-9]+)/g;
                const matches = text.match(mentionRegex);
                
                if (matches) {
                    const mentionedNames = [...new Set(matches.map(m => m.substring(1)))];
                    const usersToNotify = [];
                    
                    mentionedNames.forEach(nameVal => {
                        const foundUser = state.users.find(u => 
                            (u.name || u.email).replace(/[^a-zA-Z0-9]/g, '') === nameVal
                        );
                        if (foundUser) usersToNotify.push(foundUser.id);
                    });

                    if (usersToNotify.length > 0) {
                        const subtaskTitle = updatedSubtasks.find(s => s.id === subtaskId)?.title || 'podzadaniu';
                        const msg = `<strong>${state.currentUser.name}</strong> wspomnia/a o Tobie w komentarzu do podzadania "<strong>${subtaskTitle}</strong>".`;
                        
                        sendInternalNotification(
                            usersToNotify,
                            'mention',
                            msg,
                            { type: 'task', projectId: project.id, taskId: mainTaskId },
                            'subtask_mention' // <--- NOWY KLUCZ
                        );
                    }
                }
                // === KONIEC NOWEJ LOGIKI ===
            } catch (error) {
                console.error("Bd zapisu komentarza podzadania:", error);
                showNotification("Nie udao si doda komentarza.", "Bd");
            } finally {
                subtaskModal.addCommentBtn.disabled = false;
                subtaskModal.addCommentBtn.textContent = 'Dodaj';
            }

        } else {
            // SCENARIUSZ 2: Tworzenie nowego podzadania (Dodaj do tymczasowej listy)
            subtaskStagedComments.push(newComment);
            renderSubtaskComments(subtaskStagedComments); // Poka偶 na licie
            subtaskModal.commentInput.value = '';
        }
    });
}

// Pozostay stary kod rejestracji (nadal zakomentowany, jeli nie jest u偶ywany)
/*
// Listener do pokazywania pola na now podgrup
registerSubgroupSelect.addEventListener('change', () => {
    if (registerSubgroupSelect.value === '__CREATE_NEW__') {
        registerNewSubgroupSection.style.display = 'block';
    } else {
        registerNewSubgroupSection.style.display = 'none';
    }
});
*/
passwordResetForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const email = document.getElementById('reset-email').value;
    const submitBtn = e.target.querySelector('button[type="submit"]');

    authMessageReset.textContent = '';
    submitBtn.disabled = true;
    submitBtn.textContent = 'Wysyanie...';

    try {
        await sendPasswordResetEmail(auth, email);
        authMessageReset.style.color = 'var(--success-primary)';
        authMessageReset.textContent = 'Gotowe! Sprawd藕 swoj skrzynk e-mail (r贸wnie偶 folder SPAM) i postpuj zgodnie z instrukcjami.';
    } catch (error) {
        console.error("Bd resetowania hasa:", error);
        authMessageReset.style.color = 'var(--danger-primary)';
        authMessageReset.textContent = 'Wystpi bd lub konto o takim adresie e-mail nie istnieje.';
    } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Wylij link';
    }
});
       mobileProjectActionsToggle.addEventListener('click', (e) => {
            e.stopPropagation(); // Zapobiegaj zamkniciu menu przez listener na 'document'
            // Przecz widoczno menu
            const isVisible = mobileProjectActionsMenu.style.display === 'block';
            mobileProjectActionsMenu.style.display = isVisible ? 'none' : 'block';
        });
       mobileProjectActionsMenu.addEventListener('click', (e) => {
            e.preventDefault(); // Zapobiegaj domylnej akcji linku
            const link = e.target.closest('a[data-action]');
            if (!link) return;

            const action = link.dataset.action;
            const projectId = state.currentProjectId; // Pobierz ID bie偶cego projektu

            // Zamknij menu
            mobileProjectActionsMenu.style.display = 'none';

            // Wywoaj odpowiedni funkcj w zale偶noci od kliknitej akcji
            switch (action) {
                case 'filter': // NOWA AKCJA: Otw贸rz modal filtrowania
                    if (projectId) openProjectFilterModal(projectId);
                    break;
                case 'sort': // NOWA AKCJA: Sortuj
                    if (projectId) {
                        // Symuluj kliknicie przycisku sortowania
                        if (sortBtn) sortBtn.click();
                    }
                    break;
                case 'details':
                    if (projectId) openProjectDetailsModal(); // U偶ywamy istniejcej funkcji
                    break;
                case 'edit':
                    if (projectId) openEditProjectModal(projectId);
                    break;
                case 'complete':
                    // ZMIANA: Bezporednie wywoanie funkcji zamiast klikania w nieistniejcy przycisk
                    if (projectId) handleCompleteProject(projectId);
                    break;
                case 'delete':
                    // ZMIANA: Bezporednie wywoanie funkcji zamiast klikania w nieistniejcy przycisk
                    if (projectId) handleDeleteProject(projectId);
                    break;
            }
        });
       // Listener do zamykania menu po klikniciu poza nim (z zadania "Zmiana 6")
        document.addEventListener('click', (e) => {
            // Jeli kliknito poza menu I poza przyciskiem otwierajcym menu
            if (!mobileProjectActionsMenu.contains(e.target) && !mobileProjectActionsToggle.contains(e.target)) {
                mobileProjectActionsMenu.style.display = 'none'; // Ukryj menu
            }
        });
        // === POCZTEK BRAKUJCEGO FRAGMENTU DO WKLEJENIA ===

        loginForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const email = document.getElementById('login-email').value;
    const password = document.getElementById('login-password').value;
    authErrorLogin.textContent = '';
    const submitBtn = e.target.querySelector('button[type="submit"]');
    submitBtn.disabled = true;
    submitBtn.textContent = 'Logowanie...';

    try {
        const userCredential = await signInWithEmailAndPassword(auth, email, password);

        // --- KLUCZOWY WARUNEK SPRAWDZAJCY ---
        if (!userCredential.user.emailVerified) {
            authErrorLogin.textContent = 'Twoje konto nie zostao jeszcze zweryfikowane. Sprawd藕 e-mail.';
            await signOut(auth); // Wyloguj u偶ytkownika, aby nie pozosta w stanie "p贸-zalogowania"
            // Zakocz dziaanie funkcji, nie pozwalajc na przejcie dalej
            return; 
        }
        // Jeli weryfikacja jest OK, listener onAuthStateChanged zajmie si reszt.

    } catch (error) {
        console.error("Bd logowania:", error);
        if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
            authErrorLogin.textContent = "Nieprawidowy email lub haso.";
        } else {
            authErrorLogin.textContent = "Wystpi nieoczekiwany bd logowania.";
        }
    } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Zaloguj si';
    }
});
        // --- NOWE LISTENERY DLA SEKCJI BUD呕ETU ZADANIA (Etap 1) ---

// Listener dla checkboxa w modalu EDYCJI zadania
taskModal.budgetToggle.addEventListener('change', () => {
    taskModal.budgetDetails.style.display = taskModal.budgetToggle.checked ? 'block' : 'none';
    if (!taskModal.budgetToggle.checked) {
        taskModal.budgetItemsList.innerHTML = '<li class="budget-item-empty" style="font-style: italic; color: var(--text-secondary); font-size: 13px;">Brak pozycji kosztowych.</li>';
        const projectCurrency = taskModal.budgetCurrencySpan.textContent || '';
        updateTaskBudgetTotal(taskModal, projectCurrency);
        taskModal.budgetErrorP.textContent = '';
    }
});

// Listener dla checkboxa w modalu DODAWANIA zadania
newTaskModal.budgetToggle.addEventListener('change', () => {
    newTaskModal.budgetDetails.style.display = newTaskModal.budgetToggle.checked ? 'block' : 'none';
    if (!newTaskModal.budgetToggle.checked) {
        newTaskModal.budgetItemsList.innerHTML = '<li class="budget-item-empty" style="font-style: italic; color: var(--text-secondary); font-size: 13px;">Brak pozycji kosztowych.</li>';
        const projectCurrency = newTaskModal.overlay.dataset.projectCurrency || '';
        updateTaskBudgetTotal(newTaskModal, projectCurrency);
        newTaskModal.budgetErrorP.textContent = '';
    }
});

// Listener dla przycisku "+ Dodaj pozycj" w modalu EDYCJI
taskModal.addBudgetItemBtn.addEventListener('click', () => {
    const emptyMsg = taskModal.budgetItemsList.querySelector('.budget-item-empty');
    if (emptyMsg) emptyMsg.remove();
    const { project } = findTask(taskModal.overlay.dataset.taskId);
    const projectItemNames = (project?.budget?.items || []).map(item => item.name);
    const newItemHTML = renderTaskBudgetItemHTML(undefined, undefined, projectItemNames);
    taskModal.budgetItemsList.insertAdjacentHTML('beforeend', newItemHTML);
});

// Listener dla przycisku "+ Dodaj pozycj" w modalu DODAWANIA
newTaskModal.addBudgetItemBtn.addEventListener('click', () => {
    const emptyMsg = newTaskModal.budgetItemsList.querySelector('.budget-item-empty');
    if (emptyMsg) emptyMsg.remove();
    const projectItemNames = JSON.parse(newTaskModal.overlay.dataset.projectBudgetItems || '[]');
    const projectCurrency = newTaskModal.overlay.dataset.projectCurrency || '';
    const newItemHTML = renderTaskBudgetItemHTML(undefined, undefined, projectItemNames);
    newTaskModal.budgetItemsList.insertAdjacentHTML('beforeend', newItemHTML);
    updateTaskBudgetTotal(newTaskModal, projectCurrency);
});

// Funkcja pomocnicza do obsugi usuwania wiersza i aktualizacji
function handleBudgetItemDelete(buttonElement, modalRefs) {
    const listItem = buttonElement.closest('li.budget-item');
    if (listItem) {
        listItem.remove();
        
        // Sprawd藕, czy zostay jakie pozycje (pomijajc komunikat o braku)
        const remainingItems = modalRefs.budgetItemsList.querySelectorAll('li.budget-item');

        if (remainingItems.length === 0) {
            modalRefs.budgetItemsList.innerHTML = '<li class="budget-item-empty" style="font-style: italic; color: var(--text-secondary); font-size: 13px;">Brak pozycji kosztowych.</li>';
            
            // === NOWA LOGIKA: Automatyczne odhaczenie, jeli lista jest pusta ===
            if (modalRefs.budgetToggle) {
                modalRefs.budgetToggle.checked = false;
                if (modalRefs.budgetDetails) {
                    modalRefs.budgetDetails.style.display = 'none';
                }
            }
            // === KONIEC ===
        }
        const currency = modalRefs.budgetCurrencySpan.textContent || (modalRefs.overlay?.dataset.projectCurrency) || '';
        updateTaskBudgetTotal(modalRefs, currency);
    }
}

// Listener (delegowany) dla przycisk贸w usuwania (X) w modalu EDYCJI
taskModal.budgetItemsList.addEventListener('click', (e) => {
    if (e.target.classList.contains('delete-task-budget-item-btn')) {
        handleBudgetItemDelete(e.target, taskModal);
        
        // === NOWE: Wymuszenie stanu "Zapisz zmiany" ===
        // Poniewa偶 usunicie elementu z DOM nie wyzwala 'input' ani 'change',
        // musimy rcznie powiadomi formularz, 偶e nastpia edycja.
        // Przekazujemy sztuczne zdarzenie, aby funkcja zadziaaa (target nie ma znaczenia dla logiki dirty).
        handleTaskFormChange({ target: taskModal.budgetItemsList });
        // === KONIEC ===
    }
});

// Listener (delegowany) dla przycisk贸w usuwania (X) w modalu DODAWANIA
newTaskModal.budgetItemsList.addEventListener('click', (e) => {
    if (e.target.classList.contains('delete-task-budget-item-btn')) {
        handleBudgetItemDelete(e.target, newTaskModal);
    }
});

// Listener (delegowany) do aktualizacji sumy przy zmianie kwoty lub nazwy w modalu EDYCJI
taskModal.budgetItemsList.addEventListener('input', (e) => {
    if (e.target.classList.contains('task-budget-item-amount') || e.target.classList.contains('task-budget-item-name')) {
         const currency = taskModal.budgetCurrencySpan.textContent || '';
         updateTaskBudgetTotal(taskModal, currency);
    }
});
 // Listener (delegowany) do aktualizacji sumy przy zmianie kwoty lub nazwy w modalu DODAWANIA
newTaskModal.budgetItemsList.addEventListener('input', (e) => {
    if (e.target.classList.contains('task-budget-item-amount') || e.target.classList.contains('task-budget-item-name')) {
         const currency = newTaskModal.overlay.dataset.projectCurrency || '';
         updateTaskBudgetTotal(newTaskModal, currency);
    }
});

// --- KONIEC NOWYCH LISTENERW ---
        // === KONIEC BRAKUJCEGO FRAGMENTU DO WKLEJENIA ===
        /* USUNITO: mobileThemeSwitcher.appendChild(desktopThemeSwitcher.cloneNode(true)); */
        showRegisterBtn.addEventListener('click', () => {
            loginForm.style.display = 'none';
            registerForm.style.display = 'block';
        });
        showLoginBtn.addEventListener('click', () => {
            registerForm.style.display = 'none';
            loginForm.style.display = 'block';
        });

        registerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('register-name').value.trim();
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            const confirmPassword = document.getElementById('register-password-confirm').value;
            authErrorRegister.textContent = '';
            const submitBtn = e.target.querySelector('button[type="submit"]');

            if (password !== confirmPassword) {
                authErrorRegister.textContent = 'Hasa nie s takie same.';
                return;
            }
            if (!name) {
                authErrorRegister.textContent = 'Nazwa u偶ytkownika jest wymagana.';
                return;
            }

            submitBtn.disabled = true;
            submitBtn.textContent = 'Rejestrowanie...';

            // --- NOWA LOGIKA ---
            try {
                // 1. Zbierz dane o grupie (tak jak wczeniej)
                let targetGroupName = null;
                let action = 'create-solo';
                const isTeam = registerTeamToggle.checked;
                const enteredGroupName = registerGroupNameInput.value.trim();

                if (isTeam) {
                    action = document.querySelector('input[name="group-action"]:checked').value;
                    if (!enteredGroupName) {
                        throw new Error("Nazwa grupy jest wymagana, gdy pracujesz w zespole.");
                    }
                    targetGroupName = enteredGroupName;
                }
                
                // 2. Przygotuj dane do wysania
                const registrationData = {
                    email: email,
                    password: password,
                    name: name,
                    groupAction: action,
                    groupName: targetGroupName
                };

                // 3. Wywoaj now funkcj chmurow
                const processRegistration = httpsCallable(functions, 'processRegistration');
                const result = await processRegistration(registrationData);
                
                // 4. Obsu偶 sukces (logika z oryginalnego kodu, ale uproszczona)
                // U偶ytkownik NIE jest logowany, wysyamy go do ekranu weryfikacji
                
                // (Funkcja Auth `sendEmailVerification` NIE jest potrzebna,
                // bo Auth automatycznie wysya e-mail weryfikacyjny przy tworzeniu)
                
                loginForm.style.display = 'none';
                registerForm.style.display = 'none';
                document.getElementById('password-reset-form').style.display = 'none';
                
                const successMessageContainer = document.getElementById('register-success-message');
                const emailDisplay = document.getElementById('success-email-display');
                
                if (emailDisplay) emailDisplay.textContent = email;

                // Sprawd藕 odpowied藕 z serwera, aby dostosowa komunikat
                const serverAction = result.data.action;
                const serverGroupName = result.data.groupName;

                if (serverAction === 'join') {
                    const successP = successMessageContainer.querySelector('p');
                    if (successP) {
                        successP.innerHTML = `Wysalimy link aktywacyjny na Tw贸j adres e-mail: <strong id="success-email-display">${email}</strong>.<br>
                        Po weryfikacji e-maila, waciciel grupy <strong>${serverGroupName}</strong> bdzie musia zaakceptowa Twoj prob.`;
                    }
                } else {
                    // Domylny komunikat dla 'create' i 'create-solo'
                    const successP = successMessageContainer.querySelector('p');
                    if (successP) {
                         successP.innerHTML = `Wysalimy link aktywacyjny na Tw贸j adres e-mail: <strong id="success-email-display">${email}</strong>.
                        <br>
                        Prosz, kliknij w link, aby zweryfikowa swoje konto i m贸c si zalogowa.`;
                    }
                }
                
                if (successMessageContainer) successMessageContainer.style.display = 'block';
                
                const backToLoginBtn = document.getElementById('back-to-login-btn');
                if (backToLoginBtn) {
                    backToLoginBtn.addEventListener('click', () => {
                        if (successMessageContainer) successMessageContainer.style.display = 'none';
                        loginForm.style.display = 'block';
                    });
                }

            } catch (error) {
                // Obsu偶 bdy z Cloud Function (np. "already-exists", "not-found")
                console.error("Bd podczas procesu rejestracji:", error);
                authErrorRegister.textContent = error.message;
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Zarejestruj si';
            }
        });
        // Dodaj listener do przycisku "Wr贸 do logowania" na ekranie sukcesu
        document.getElementById('back-to-login-btn').addEventListener('click', () => {
            document.getElementById('register-success-message').style.display = 'none';
            loginForm.style.display = 'block';
        });

        // KROK 1.1: Modyfikacja listenera wylogowania
        logoutBtn.addEventListener('click', () => {
            // === NOWA INTEGRACJA: ZATRZYMAJ ROZMOW PRZED WYLOGOWANIEM ===
            if (speechSynthesisInstance) speechSynthesisInstance.cancel();
            stopListening();
            isConversationModeActive = false;
            // === KONIEC NOWEJ INTEGRACJI ===
            // NAJPIERW zatrzymujemy wszystkie aktywne suchacze,
            // p贸ki u偶ytkownik JEST JESZCZE zalogowany i ma uprawnienia.
            unsubscribeAllListeners();
            
            // DOPIERO TERAZ wylogowujemy u偶ytkownika.
            signOut(auth);
        });
        // Listener do pokazywania/ukrywania opcji bud偶etu w NOWYM projekcie
        newProjectModal.budgetToggle.addEventListener('change', () => {
            const isChecked = newProjectModal.budgetToggle.checked;
            newProjectModal.budgetDetails.style.display = isChecked ? 'block' : 'none';
            
            // Jeli odznaczono, czycimy tylko bdy wizualnie
            if (!isChecked) {
                if (newProjectModal.budgetSaveErrorP) newProjectModal.budgetSaveErrorP.textContent = '';
            }
             // Zawsze aktualizuj podsumowanie przy zmianie checkboxa
             updateBudgetSummary(newProjectModal);
        });

        // Listener do pokazywania/ukrywania opcji bud偶etu w EDYTOWANYM projekcie
        editProjectModal.budgetToggle.addEventListener('change', () => {
            const isChecked = editProjectModal.budgetToggle.checked;
            editProjectModal.budgetDetails.style.display = isChecked ? 'block' : 'none';
            
            // Jeli odznaczono, czycimy tylko bdy wizualnie
            if (!isChecked) {
                if (editProjectModal.budgetSaveErrorP) editProjectModal.budgetSaveErrorP.textContent = '';
            }
             // Zawsze aktualizuj podsumowanie przy zmianie checkboxa
             updateBudgetSummary(editProjectModal);
        });
        // Listener dodawania pozycji bud偶etowej w NOWYM projekcie
        newProjectModal.addBudgetItemBtn.addEventListener('click', () => {
            const emptyMsg = newProjectModal.budgetItemsList.querySelector('.budget-item-empty');
            if (emptyMsg) emptyMsg.remove();
            const newItemHTML = renderBudgetItemHTML();
            newProjectModal.budgetItemsList.insertAdjacentHTML('beforeend', newItemHTML);
            updateBudgetSummary(newProjectModal); // <-- WYWOANIE FUNKCJI
        });

        // Listener dodawania pozycji bud偶etowej w EDYTOWANYM projekcie
        editProjectModal.addBudgetItemBtn.addEventListener('click', () => {
            const emptyMsg = editProjectModal.budgetItemsList.querySelector('.budget-item-empty');
            if (emptyMsg) emptyMsg.remove();
            const newItemHTML = renderBudgetItemHTML();
            editProjectModal.budgetItemsList.insertAdjacentHTML('beforeend', newItemHTML);
            updateBudgetSummary(editProjectModal); // <-- WYWOANIE FUNKCJI
        });
       // Listener usuwania pozycji bud偶etowej w NOWYM projekcie (delegacja)
        newProjectModal.budgetItemsList.addEventListener('click', (e) => {
            if (e.target.classList.contains('delete-budget-item-btn')) {
                e.target.closest('li.budget-item').remove();
                if (newProjectModal.budgetItemsList.children.length === 0) {
                    newProjectModal.budgetItemsList.innerHTML = '<li class="budget-item-empty" style="font-style: italic; color: var(--text-secondary); font-size: 13px;">Brak pozycji bud偶etowych.</li>';
                }
                updateBudgetSummary(newProjectModal); // <-- WYWOANIE FUNKCJI
            }
        });

        // Listener usuwania pozycji bud偶etowej w EDYTOWANYM projekcie (delegacja)
        editProjectModal.budgetItemsList.addEventListener('click', (e) => {
            if (e.target.classList.contains('delete-budget-item-btn')) {
                e.target.closest('li.budget-item').remove();
                if (editProjectModal.budgetItemsList.children.length === 0) {
                    editProjectModal.budgetItemsList.innerHTML = '<li class="budget-item-empty" style="font-style: italic; color: var(--text-secondary); font-size: 13px;">Brak pozycji bud偶etowych.</li>';
                }
                updateBudgetSummary(editProjectModal); // <-- WYWOANIE FUNKCJI
            }
        });
       // NOWE LISTENERY: Aktualizacja podsumowania przy zmianie kwot

        // Zmiana kwoty CAKOWITEJ w NOWYM projekcie
        newProjectModal.budgetAmountInput.addEventListener('input', () => {
            updateBudgetSummary(newProjectModal);
        });
        // Zmiana kwoty CAKOWITEJ w EDYTOWANYM projekcie
        editProjectModal.budgetAmountInput.addEventListener('input', () => {
            updateBudgetSummary(editProjectModal);
        });
        // Zmiana waluty w NOWYM projekcie
         newProjectModal.budgetCurrencyInput.addEventListener('input', () => {
             updateBudgetSummary(newProjectModal);
         });
        // Zmiana waluty w EDYTOWANYM projekcie
        editProjectModal.budgetCurrencyInput.addEventListener('input', () => {
            updateBudgetSummary(editProjectModal);
        });

        // Zmiana kwoty POZYCJI w NOWYM projekcie (delegacja)
        newProjectModal.budgetItemsList.addEventListener('input', (e) => {
            // Reaguj tylko na zmiany w inputach kwot pozycji
            if (e.target.classList.contains('budget-item-amount')) {
                updateBudgetSummary(newProjectModal);
            }
            // Dodano r贸wnie偶 reset przy zmianie nazwy
            if (e.target.classList.contains('budget-item-name')) {
                 updateBudgetSummary(newProjectModal);
            }
        });
        // Zmiana kwoty POZYCJI w EDYTOWANYM projekcie (delegacja)
        editProjectModal.budgetItemsList.addEventListener('input', (e) => {
            // Reaguj tylko na zmiany w inputach kwot pozycji
            if (e.target.classList.contains('budget-item-amount')) {
                updateBudgetSummary(editProjectModal);
            }
             // Dodano r贸wnie偶 reset przy zmianie nazwy
            if (e.target.classList.contains('budget-item-name')) {
                 updateBudgetSummary(editProjectModal);
            }
        });
       
        taskModal.addAttachmentBtn.addEventListener('click', () => {
            taskModal.attachmentFileInput.click();
        });

        taskModal.attachmentFileInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            // === POCZTEK ZMIANY: WALIDACJA ROZMIARU PLIKU ===
            if (file.size > MAX_FILE_SIZE) {
                showNotification(`Plik "${file.name}" jest za du偶y. Maksymalny rozmiar to 15 MB.`, "Bd Pliku");
                e.target.value = ''; // Wyczy input pliku
                return; // Przerwij dalsze wykonywanie
            }
            // === KONIEC ZMIANY ===

            const taskId = taskModal.overlay.dataset.taskId;
            const {
                task,
                project
            } = findTask(taskId);
            if (!task || !project) return;

            taskModal.uploadStatus.textContent = 'Przesyanie...';
            taskModal.addAttachmentBtn.disabled = true;

            try {
                const storagePath = `attachments/${project.id}/${taskId}/${Date.now()}_${file.name}`;
                const storageRef = ref(storage, storagePath);

                const snapshot = await uploadBytes(storageRef, file);
                const downloadURL = await getDownloadURL(snapshot.ref);

                const newAttachment = {
                    id: `att_${Date.now()}`,
                    name: file.name,
                    url: downloadURL,
                    path: storagePath,
                    uploadedBy: state.currentUser.uid,
                    timestamp: Date.now()
                };

                const updatedAttachments = [...(task.attachments || []), newAttachment];
                const updatedTasks = project.tasks.map(t => t.id === taskId ? { ...t,
                    attachments: updatedAttachments
                } : t);

                const projectDocRef = findProject(project.id) ? doc(projectsRef, project.id) : doc(completedProjectsRef, project.id);
                await updateDoc(projectDocRef, {
                    tasks: updatedTasks
                });
                
                // Odwie偶 tylko list zacznik贸w
                // Musimy pobra zaktualizowane zadanie, poniewa偶 'updatedTasks' to caa lista
                const finalUpdatedTask = updatedTasks.find(t => t.id === taskId);
                if (finalUpdatedTask) {
                    renderAttachments(finalUpdatedTask);
                } else {
                    // W razie problemu, fallback do penego odwie偶enia
                    openTaskModal(taskId);
                }

            } catch (error) {
                console.error("Bd przesyania pliku:", error);
                showNotification("Wystpi bd podczas przesyania pliku.", "Bd");
            } finally {
                taskModal.uploadStatus.textContent = '';
                taskModal.addAttachmentBtn.disabled = false;
                taskModal.attachmentFileInput.value = '';
            }
        });

        taskModal.attachmentsList.addEventListener('click', async (e) => {
            // --- MODYFIKACJA ISTNIEJCEGO LISTENERA ---
            const deleteBtn = e.target.closest('.delete-attachment-btn');
            const setCoverBtn = e.target.closest('.set-cover-image-btn');
            const removeCoverBtn = e.target.closest('.remove-cover-image-btn');

            // 1. Logika usuwania zacznika (bez zmian, tylko przeniesiona do if)
            if (deleteBtn) {
                const attachmentItem = deleteBtn.closest('.attachment-item');
                const attachmentId = attachmentItem.dataset.attachmentId;
                const taskId = taskModal.overlay.dataset.taskId;
                const {
                    task,
                    project
                } = findTask(taskId);

                if (!task || !project || !attachmentId) return;

                const attachmentToDelete = (task.attachments || []).find(att => att.id === attachmentId);
                if (!attachmentToDelete) return;

                showConfirmation("Potwierd藕 usunicie", `Czy na pewno chcesz usun zacznik: "${attachmentToDelete.name}"?`, async (confirmed) => {
                    if (confirmed) {
                        try {
                            const fileRef = ref(storage, attachmentToDelete.path);
                            await deleteObject(fileRef);

                            // --- NOWA LOGIKA: Sprawd藕, czy usuwany zacznik by powizany z okadk ---
                            let updatedTaskFields = {};
                            const updatedAttachments = task.attachments.filter(att => att.id !== attachmentId);
                            updatedTaskFields.attachments = updatedAttachments;

                            // Jeli usunity zacznik by oryginaem okadki, usu r贸wnie偶 okadk
                            if (task.coverImage && task.coverImage.originalPath === attachmentToDelete.path) {
                                try {
                                    const coverRef = ref(storage, task.coverImage.path);
                                    await deleteObject(coverRef);
                                } catch (coverDeleteError) {
                                    console.warn("Nie udao si usun pliku bannera (m贸g ju偶 nie istnie):", coverDeleteError);
                                }
                                updatedTaskFields.coverImage = null; // Usu okadk z zadania
                            }
                            // --- KONIEC NOWEJ LOGIKI ---

                            const updatedTasks = project.tasks.map(t => t.id === taskId ? { ...t, ...updatedTaskFields } : t);
                            const projectDocRef = findProject(project.id) ? doc(projectsRef, project.id) : doc(completedProjectsRef, project.id);
                            await updateDoc(projectDocRef, {
                                tasks: updatedTasks
                            });

                            showNotification("Zacznik zosta usunity.", "Sukces");
                            openTaskModal(taskId); // Odwie偶 modal
                        } catch (error) {
                            console.error("Bd usuwania zacznika:", error);
                            showNotification("Wystpi bd podczas usuwania zacznika.", "Bd");
                        }
                    }
                }, true);
            
            // 2. NOWA LOGIKA: Ustawianie okadki
            } else if (setCoverBtn) {
                const taskId = setCoverBtn.dataset.taskId;
                const attachmentUrl = setCoverBtn.dataset.attachmentUrl;
                const attachmentPath = setCoverBtn.dataset.attachmentPath; // cie偶ka oryginau
                const attachmentName = setCoverBtn.dataset.attachmentName;
                openCoverImageCropper(taskId, attachmentUrl, attachmentPath, attachmentName);
            
            // 3. NOWA LOGIKA: Usuwanie okadki
            } else if (removeCoverBtn) {
                const taskId = removeCoverBtn.dataset.taskId;
                removeCoverImage(taskId);
            }
        });

        // --- NOWE ZMIENNE I FUNKCJE DLA KADROWANIA OKADKI ---

        // Referencje do nowego modala (dodane globalnie w skrypcie)
        const taskCoverCroppieModal = {
            overlay: document.getElementById('task-cover-croppie-modal'),
            container: document.getElementById('task-cover-croppie-container'),
            saveBtn: document.getElementById('save-cropped-cover-btn')
        };
        // U偶ywamy tej samej globalnej instancji co dla awatara
        // let croppieInstance = null; // (ju偶 zadeklarowane wy偶ej dla awatara)
        // === POCZTEK: NOWA LOGIKA GALERII OKADEK ===

        // Staa z szablonami okadek - U呕YTO TWOICH LINKW
        const COVER_TEMPLATES = [
            { name: "Chmura Danych", id: "template_chmura_danych", url: "https://firebasestorage.googleapis.com/v0/b/wlasciwa-aplikacja.firebasestorage.app/o/cover_templates%2FChmura%20Danych.png?alt=media&token=b48980a9-4394-4c63-bd67-6b72c165ce5e" },
            { name: "Ewolucja Koncepcji", id: "template_ewolucja_koncepcji", url: "https://firebasestorage.googleapis.com/v0/b/wlasciwa-aplikacja.firebasestorage.app/o/cover_templates%2FEwolucja%20Koncepcji.png?alt=media&token=b2a93dc2-65d3-4772-b3fd-da254a2337b4" },
            { name: "Fale Innowacji", id: "template_fale_innowacji", url: "https://firebasestorage.googleapis.com/v0/b/wlasciwa-aplikacja.firebasestorage.app/o/cover_templates%2FFale%20Innowacji.png?alt=media&token=9d0988a2-a709-44b8-9ee1-3fc3d1abb825" },
            { name: "Kreatywna Idea", id: "template_kreatywna_idea", url: "https://firebasestorage.googleapis.com/v0/b/wlasciwa-aplikacja.firebasestorage.app/o/cover_templates%2FKreatywna%20Idea.png?alt=media&token=c0973ef3-83e2-43f1-9429-471a523fd45e" },
            { name: "Miasto Postpu", id: "template_miasto_postepu", url: "https://firebasestorage.googleapis.com/v0/b/wlasciwa-aplikacja.firebasestorage.app/o/cover_templates%2FMiasto%20Post%C4%99pu.png?alt=media&token=fa755c4d-ee10-4c80-b0da-804a2ac7b4c1" },
            { name: "Sie Neuronowa", id: "template_siec_neuronowa", url: "https://firebasestorage.googleapis.com/v0/b/wlasciwa-aplikacja.firebasestorage.app/o/cover_templates%2FSie%C4%87%20Neuronowa.png?alt=media&token=909d2219-d027-4c53-9ea2-ad064d9316c7" }
        ];

        // Referencje do modala galerii
        const coverTemplatesModal = {
            overlay: document.getElementById('cover-templates-modal'),
            grid: document.getElementById('cover-templates-grid')
        };
        const openCoverGalleryBtn = document.getElementById('open-cover-gallery-btn');

        /**
         * Otwiera modal galerii z szablonami okadek.
         */
        function openCoverGalleryModal() {
            let currentTemplatePath = null;
            let contextTaskId = null; // Bdzie zawiera ID zadania lub 'new-task'

            // Sprawd藕, kt贸ry modal jest aktywny
            if (taskModal.overlay.classList.contains('visible')) {
                // Tryb EDYCJI - pobierz dane z istniejcego zadania
                contextTaskId = taskModal.overlay.dataset.taskId;
                const { task } = findTask(contextTaskId);
                if (!task) return;

                currentTemplatePath = (task.coverImage && task.coverImage.originalPath && task.coverImage.originalPath.startsWith('template_')) 
                    ? task.coverImage.originalPath 
                    : null;
                
                // Zapisz kontekst w modalu galerii
                coverTemplatesModal.overlay.dataset.contextTaskId = contextTaskId;

            } else if (newTaskModal.overlay.classList.contains('visible')) {
                // Tryb NOWEGO ZADANIA - pobierz dane z tymczasowej zmiennej
                contextTaskId = 'new-task'; // Specjalny identyfikator kontekstu
                
                currentTemplatePath = (newTaskTempBannerData && newTaskTempBannerData.originalPath && newTaskTempBannerData.originalPath.startsWith('template_'))
                    ? newTaskTempBannerData.originalPath
                    : null;
                
                // Zapisz kontekst w modalu galerii
                coverTemplatesModal.overlay.dataset.contextTaskId = contextTaskId;

            } else {
                console.error("openCoverGalleryModal: Nie mo偶na ustali kontekstu (ani Nowe Zadanie, ani Edycja Zadania nie s widoczne).");
                return;
            }

            coverTemplatesModal.grid.innerHTML = ''; // Wyczy galeri

            // Wygeneruj kafelki dla ka偶dego szablonu
            COVER_TEMPLATES.forEach(template => {
                const isSelected = currentTemplatePath === template.id;
                const uniqueRadioId = `radio_${template.id}`;

                const itemHTML = `
                    <label class="cover-template-item ${isSelected ? 'selected' : ''}" for="${uniqueRadioId}">
                        <input 
                            type="radio" 
                            name="cover-template" 
                            id="${uniqueRadioId}" 
                            value="${template.id}"
                            data-url="${template.url}"
                            data-name="${template.name}"
                            ${isSelected ? 'checked' : ''}
                        >
                        <img src="${template.url}" alt="${template.name}">
                        <span>${template.name}</span>
                    </label>
                `;
                coverTemplatesModal.grid.insertAdjacentHTML('beforeend', itemHTML);
            });

            openModal(coverTemplatesModal.overlay);
        }

        /**
         * Obsuguje wyb贸r szablonu z galerii.
         */
        function handleCoverTemplateSelect(e) {
            // Sprawd藕, czy kliknito na input radio (lub label, kt贸ry go aktywowa)
            const radioInput = e.target.closest('input[type="radio"]');
            if (!radioInput || radioInput.name !== 'cover-template') {
                return;
            }

            // Zdejmij klas .selected ze wszystkich
            coverTemplatesModal.grid.querySelectorAll('.cover-template-item').forEach(item => {
                item.classList.remove('selected');
            });
            // Dodaj klas .selected do kliknitego
            radioInput.closest('.cover-template-item').classList.add('selected');

            // Pobierz dane z wybranego szablonu
            const templateId = radioInput.value; // np. "template_miasto_postepu"
            const templateUrl = radioInput.dataset.url;
            const templateName = radioInput.dataset.name;
            
            // Pobierz ID zadania (lub kontekst 'new-task') z modala galerii
            const contextTaskId = coverTemplatesModal.overlay.dataset.contextTaskId;

            if (!contextTaskId || !templateUrl) {
                console.error("Bd: Brak contextTaskId lub template URL przy wyborze okadki.");
                return;
            }

            // 1. Zamknij modal galerii
            closeModal(coverTemplatesModal.overlay);

            // 2. Otw贸rz modal kadrowania, przekazujc dane szablonu ORAZ KONTEKST
            // U偶ywamy ID szablonu (np. "template_miasto_postepu") jako "originalPath"
            openCoverImageCropper(contextTaskId, templateUrl, templateId, templateName);
        }


        // --- DODANIE LISTENERW ---
        // openCoverGalleryBtn.addEventListener('click', openCoverGalleryModal); // <-- USUWAMY STARY LISTENER
        
        // === NOWY LISTENER DLA PRZYCISKU W MODALU NOWEGO ZADANIA ===
        if (newTaskModal.openCoverGalleryBtn) {
            newTaskModal.openCoverGalleryBtn.addEventListener('click', (e) => {
                const action = e.target.dataset.action || 'open-gallery';
                
                if (action === 'open-gallery') {
                    // Akcja domylna: otw贸rz galeri
                    // Funkcja openCoverGalleryModal sama wykryje, 偶e jest w kontekcie 'new-task'
                    openCoverGalleryModal();
                } else if (action === 'remove-template-cover') {
                    // Nowa akcja: usu okadk (z kontekstem 'new-task')
                    removeCoverImage('new-task');
                }
            });
        }
        // === KONIEC NOWEGO LISTENERA ===
        // === NOWY LISTENER: Naprawa niedziaajcego przycisku w MODALU EDYCJI ===
                // (Staa 'openCoverGalleryBtn' jest zdefiniowana globalnie w skrypcie ok. linii 3682)
                if (openCoverGalleryBtn) {
                    openCoverGalleryBtn.addEventListener('click', (e) => {
                        // Pobieramy 'data-action' LUB ustawiamy domyln akcj 'open-gallery'
                        // To jest kluczowa poprawka, kt贸rej brakowao
                        const action = e.target.dataset.action || 'open-gallery';
                        
                        if (action === 'open-gallery') {
                            // Akcja domylna: otw贸rz galeri
                            // Funkcja 'openCoverGalleryModal' sama wykryje, 偶e jest w kontekcie 'task-modal' (edycja)
                            openCoverGalleryModal();
                        } else if (action === 'remove-template-cover') {
                            // Akcja usunicia: pobierz ID zadania z modala edycji
                            const taskId = taskModal.overlay.dataset.taskId;
                            if (taskId) {
                                removeCoverImage(taskId);
                            } else {
                                console.error("Brak taskId przy pr贸bie usunicia okadki szablonu.");
                            }
                        }
                    });
                }
                // === KONIEC NOWEGO LISTENERA (NAPRAWA) ===
       // === NOWE LISTENERY DLA TA KAFELKA ===
        
        // 1. Dla EDYCJI zadania (fallback, bo funkcja updateColorButtonState nadpisuje onclick, ale ten jest na start)
        if (taskModalBackgroundColorBtn) {
            taskModalBackgroundColorBtn.addEventListener('click', () => {
                const taskId = taskModal.overlay.dataset.taskId;
                if (taskId) openBackgroundColorModal(taskId);
            });
        }

        // 2. Dla NOWEGO zadania
        if (newTaskModal.openBackgroundColorBtn) {
            newTaskModal.openBackgroundColorBtn.addEventListener('click', () => {
                openBackgroundColorModal('new-task');
            });
        }
        // === KONIEC ===
        coverTemplatesModal.grid.addEventListener('change', handleCoverTemplateSelect);

        // === KONIEC NOWEJ LOGIKI GALERII OKADEK ===
        /**
         * Otwiera modal kadrowania dla okadki zadania.
         * @param {string} contextTaskId - ID zadania lub specjalny string 'new-task'.
         */
        function openCoverImageCropper(contextTaskId, originalUrl, originalPath, originalName) {
            openModal(taskCoverCroppieModal.overlay);

            if (croppieInstance) {
                croppieInstance.destroy();
            }

            // Inicjalizujemy Croppie z proporcjami dla okadki (np. 16:9 lub 4:3)
            // U偶yjemy wymiar贸w 400x225 (proporcja ok. 16:9)
            croppieInstance = new Croppie(taskCoverCroppieModal.container, {
                viewport: { width: 360, height: 200 }, // Proporcja ok. 16:9
                boundary: { width: 400, height: 250 }, // Kontener z CSS
                enableExif: true
            });

            // adujemy oryginalny obrazek z zacznika
            croppieInstance.bind({
                url: originalUrl,
            });

            // Zapisujemy kluczowe dane w modalu, aby funkcja zapisu miaa do nich dostp
            taskCoverCroppieModal.overlay.dataset.contextTaskId = contextTaskId; // Zmieniona nazwa dataset
            taskCoverCroppieModal.overlay.dataset.originalPath = originalPath;
            taskCoverCroppieModal.overlay.dataset.originalName = originalName;
            // --- NOWA LINIA ---
            taskCoverCroppieModal.overlay.dataset.originalUrl = originalUrl; // Zapisujemy tak偶e URL
        }

        /**
         * Zapisuje przycit okadk do Storage i aktualizuje dokument zadania LUB stan tymczasowy.
         */
        async function saveCroppedCoverImage() {
            // Odczytaj kontekst (ID zadania lub 'new-task')
            const contextTaskId = taskCoverCroppieModal.overlay.dataset.contextTaskId;
            const originalPath = taskCoverCroppieModal.overlay.dataset.originalPath; // cie偶ka oryginau
            const originalName = taskCoverCroppieModal.overlay.dataset.originalName;
            const originalUrl = taskCoverCroppieModal.overlay.dataset.originalUrl; // Odczytujemy zapisany URL

            // Sprawd藕, czy edytor istnieje
            if (!croppieInstance) {
                 showNotification("Bd: Nie znaleziono edytora.", "Bd");
                 return;
            }
            
            // Ustal, czy to szablon (nie wymaga uploadu)
            const isTemplateCover = originalPath && originalPath.startsWith('template_');

            // --- Walidacja kontekstu ---
            let task, project;
            const isNewTask = contextTaskId === 'new-task';
            
            if (isNewTask) {
                // Kontekst dla nowego zadania, nie potrzebujemy 'task' i 'project'
            } else {
                // Kontekst dla edycji zadania, pobierz 'task' i 'project'
                const { task: foundTask, project: foundProject } = findTask(contextTaskId);
                if (!foundTask || !foundProject) {
                    showNotification("Bd: Nie znaleziono zadania lub projektu.", "Bd");
                    return;
                }
                task = foundTask;
                project = foundProject;
            }

            taskCoverCroppieModal.saveBtn.disabled = true;
            taskCoverCroppieModal.saveBtn.textContent = 'Zapisywanie...';

            try {
                // 1. Pobierz przycity obrazek jako Blob
                const blob = await croppieInstance.result({
                    type: 'blob',
                    size: { width: 600, height: 338 }, // Zapisujemy w rozsdnej rozdzielczoci (ok. 16:9)
                    format: 'jpeg',
                    quality: 0.85,
                    circle: false
                });

                let newCoverURL, newCoverPath;

                // --- NOWA LOGIKA ROZDZIELAJCA UPLOAD ---
                if (isTemplateCover) {
                    // Dla szablonu NIE wysyamy nic do Storage
                    // U偶ywamy oryginalnego URL-a szablonu i specjalnej cie偶ki
                    
                    // POPRAWKA BDU:
                    // newCoverURL = await croppieInstance.element.src; // BD: .src da 'undefined'
                    newCoverURL = originalUrl; // POPRAWKA: U偶yj URL-a przekazanego z dataset
                    
                    newCoverPath = originalPath; // np. "template_miasto_postepu"
                    console.log("Zapisywanie okadki z szablonu. URL:", newCoverURL, "Path:", newCoverPath);
                } else {
                    // Dla wasnego zacznika (logika dziaa tylko dla edycji)
                    if (isNewTask) {
                        // Ta cie偶ka nie powinna by nigdy osignita zgodnie z planem (Option 2)
                        // Ale jeli w przyszoci dodamy upload z 'new-task', logika p贸jdzie tutaj
                        throw new Error("Logika uploadu niestandardowego bannera dla nowego zadania nie jest jeszcze zaimplementowana.");
                    }

                    // --- Istniejca logika dla trybu EDYCJI ---
                    // 2. Jeli zadanie miao ju偶 okadk, usu stary plik okadki
                    if (task.coverImage && task.coverImage.path && !task.coverImage.path.startsWith('template_')) {
                        try {
                            const oldCoverRef = ref(storage, task.coverImage.path);
                            await deleteObject(oldCoverRef);
                        } catch (oldDeleteError) {
                            console.warn("Nie udao si usun starej okadki (by mo偶e ju偶 nie istniaa):", oldDeleteError);
                        }
                    }

                    // 3. Stw贸rz now cie偶k dla przycitej okadki
                    newCoverPath = `covers/${project.id}/${task.id}/cover_${Date.now()}.jpeg`;
                    const newCoverRef = ref(storage, newCoverPath);

                    // 4. Wylij nowy plik
                    await uploadBytes(newCoverRef, blob);

                    // 5. Pobierz URL do nowego pliku
                    newCoverURL = await getDownloadURL(newCoverRef);
                    // --- Koniec istniejcej logiki ---
                }
                // --- KONIEC NOWEJ LOGIKI ROZDZIELAJCEJ UPLOAD ---

                // 6. Przygotuj obiekt do zapisu
                const newCoverData = {
                    url: newCoverURL,          // URL (przycity lub z szablonu)
                    path: newCoverPath,        // cie偶ka (nowa w storage lub ID szablonu)
                    originalPath: originalPath, // cie偶ka do ORYGINALNEGO zacznika (lub ID szablonu)
                    originalName: originalName  // Nazwa oryginau (lub nazwa szablonu)
                };

                // --- NOWA LOGIKA ROZDZIELAJCA ZAPIS ---
                if (isNewTask) {
                    // Tryb NOWEGO ZADANIA: Zapisz do zmiennej tymczasowej
                    newTaskTempBannerData = newCoverData;
                    
                    // Zaktualizuj przycisk w modalu NOWEGO zadania
                    if (newTaskModal.openCoverGalleryBtn) {
                        newTaskModal.openCoverGalleryBtn.textContent = 'Usu szablon';
                        newTaskModal.openCoverGalleryBtn.classList.add('is-danger-btn');
                        newTaskModal.openCoverGalleryBtn.dataset.action = 'remove-template-cover';
                    }
                    showNotification("Banner zosta wybrany. Zostanie zapisany razem z zadaniem.", "Sukces");

                } else {
                    // Tryb EDYCJI ZADANIA: Zapisz do Firestore (istniejca logika)
                    const updatedTasks = project.tasks.map(t =>
                        t.id === task.id ? { ...t, coverImage: newCoverData } : t
                    );
                    
                    const projectDocRef = findProject(project.id) ? doc(projectsRef, project.id) : doc(completedProjectsRef, project.id);
                    await updateDoc(projectDocRef, { tasks: updatedTasks });

                    showNotification("Okadka zostaa ustawiona.", "Sukces");
                }
                // --- KONIEC NOWEJ LOGIKI ROZDZIELAJCEJ ZAPIS ---

            } catch (error) {
                console.error("Bd podczas zapisywania okadki:", error);
                showNotification("Wystpi bd podczas zapisywania okadki.", "Bd");
            } finally {
                taskCoverCroppieModal.saveBtn.disabled = false;
                taskCoverCroppieModal.saveBtn.textContent = 'Ustaw jako banner';
                closeModal(taskCoverCroppieModal.overlay);
                
                if (croppieInstance) {
                    croppieInstance.destroy(); // Zniszcz instancj Croppie
                    croppieInstance = null;
                }
                
                // Odwie偶 odpowiedni modal
                if (!isNewTask) {
                    openTaskModal(contextTaskId); // Odwie偶 modal EDYCJI
                }
                // Jeli jest to nowe zadanie, nie robimy nic - modal nowego zadania pozostaje otwarty
            }
        }
        
        // Listener dla przycisku zapisu w nowym modalu
        taskCoverCroppieModal.saveBtn.addEventListener('click', saveCroppedCoverImage);


        /**
         * Usuwa okadk z zadania (usuwa plik ze Storage i pole z Firestore)
         * LUB usuwa tymczasow okadk z modala nowego zadania.
         * @param {string} contextTaskId - ID zadania lub specjalny string 'new-task'.
         */
        async function removeCoverImage(contextTaskId) {
            const isNewTask = contextTaskId === 'new-task';

            if (isNewTask) {
                // --- LOGIKA DLA NOWEGO ZADANIA ---
                if (!newTaskTempBannerData) {
                    showNotification("Bd: Nowe zadanie nie ma wybranego bannera.", "Bd");
                    return;
                }
                
                // Pytamy o potwierdzenie
                showConfirmation(
                    "Potwierd藕 usunicie bannera",
                    "Czy na pewno chcesz usun wybrany banner z tego zadania?",
                    (confirmed) => {
                        if (confirmed) {
                            // Usuwamy dane z pamici tymczasowej
                            newTaskTempBannerData = null;
                            
                            // Resetujemy przycisk w modalu NOWEGO zadania
                            if (newTaskModal.openCoverGalleryBtn) {
                                newTaskModal.openCoverGalleryBtn.textContent = 'Wybierz banner';
                                newTaskModal.openCoverGalleryBtn.classList.remove('is-danger-btn');
                                newTaskModal.openCoverGalleryBtn.dataset.action = 'open-gallery';
                            }
                            showNotification("Banner zosta usunity.", "Sukces");
                            // Modal nowego zadania pozostaje otwarty
                        }
                    },
                    true // U偶yj czerwonego przycisku
                );

            } else {
                // --- ISTNIEJCA LOGIKA DLA EDYCJI ZADANIA ---
                const { task, project } = findTask(contextTaskId);
                if (!task || !project || !task.coverImage) {
                    showNotification("Bd: Zadanie nie ma okadki do usunicia.", "Bd");
                    return;
                }

            const coverPathToDelete = task.coverImage.path;
            // NOWA ZMIENNA: Sprawdzamy, czy okadka bya szablonem
            const isTemplateCover = task.coverImage.originalPath && task.coverImage.originalPath.startsWith('template_');

            showConfirmation(
                    "Potwierd藕 usunicie bannera",
                    "Czy na pewno chcesz usun banner z tego zadania?" + (isTemplateCover ? "" : " Oryginalny zacznik pozostanie nietknity."),
                    async (confirmed) => {
                        if (confirmed) {
                            try {
                                // 1. Usu plik okadki ze Storage TYLKO jeli nie by to szablon
                                if (!isTemplateCover) {
                                    console.log("Usuwanie pliku okadki ze Storage:", coverPathToDelete);
                                    const coverRef = ref(storage, coverPathToDelete);
                                    await deleteObject(coverRef);
                                } else {
                                    console.log("Pomijanie usuwania pliku ze Storage (okadka z szablonu).");
                                }

                                // 2. Zaktualizuj zadanie w Firestore (ustaw coverImage na null)
                                const updatedTasks = project.tasks.map(t =>
                                    t.id === contextTaskId ? { ...t, coverImage: null } : t
                                );
                                const projectDocRef = findProject(project.id) ? doc(projectsRef, project.id) : doc(completedProjectsRef, project.id);
                                await updateDoc(projectDocRef, { tasks: updatedTasks });

                                showNotification("Okadka zostaa usunita.", "Sukces");
                                openTaskModal(contextTaskId); // Odwie偶 modal

                            } catch (error) {
                                console.error("Bd podczas usuwania okadki:", error);
                                showNotification("Wystpi bd podczas usuwania okadki.", "Bd");
                            }
                        }
                    },
                    true // U偶yj czerwonego przycisku
                );
            }
        }

        // --- KONIEC NOWYCH FUNKCJI ---

        // === ZAKTUALIZOWANY LISTENER: Lewa kolumna w Edycji Zadania ===
        taskModal.assigneesContainer.addEventListener('click', (e) => {
            // Sprawd藕, czy tryb edycji jest aktywny (zapisany w dataset w openTaskModal)
            const isEditable = taskModal.assigneesContainer.dataset.editable === "true";

            const header = e.target.closest('.department-header');
            const pill = e.target.closest('.member-pill:not(.disabled)');

            if (header) {
                const usersContainer = header.nextElementSibling;
                if (usersContainer && usersContainer.classList.contains('department-users')) {
                    header.classList.toggle('active');
                    usersContainer.classList.toggle('collapsed');
                }
            } else if (pill && isEditable) {
                pill.classList.toggle('selected');
                // Odwie偶 praw kolumn
                renderSelectedMembersColumn(taskModal.assigneesContainer, taskModal.selectedList, null, [], []);
            }
        });

        // === NOWY LISTENER: Prawa kolumna w Edycji Zadania (Usuwanie) ===
        if (taskModal.selectedList) {
            taskModal.selectedList.addEventListener('click', (e) => {
                // Sprawd藕 edytowalno (zabezpieczenie UI)
                const isEditable = taskModal.assigneesContainer.dataset.editable === "true";
                if (!isEditable) return;

                if (e.target.closest('.selected-member-remove')) {
                    const userId = e.target.closest('.selected-member-row')?.dataset.userId;
                    if (userId) {
                        const pill = taskModal.assigneesContainer.querySelector(`.member-pill[data-user-id="${userId}"]`);
                        if (pill) {
                            pill.classList.remove('selected');
                            renderSelectedMembersColumn(taskModal.assigneesContainer, taskModal.selectedList, null, [], []);
                        }
                    }
                }
            });
        }



        changePasswordModal.form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const currentPassword = changePasswordModal.currentPassword.value;
            const newPassword = changePasswordModal.newPassword.value;
            const confirmPassword = changePasswordModal.confirmPassword.value;
            const submitBtn = e.target.querySelector('button[type="submit"]');

            if (newPassword !== confirmPassword) {
                changePasswordModal.error.textContent = 'Nowe hasa nie s takie same.';
                return;
            }
            if (newPassword.length < 6) {
                changePasswordModal.error.textContent = 'Nowe haso musi mie co najmniej 6 znak贸w.';
                return;
            }

            changePasswordModal.error.textContent = '';
            submitBtn.disabled = true;
            submitBtn.textContent = 'Zmienianie...';

            const user = auth.currentUser;
            if (!user) {
                changePasswordModal.error.textContent = 'Bd: U偶ytkownik nie jest zalogowany.';
                submitBtn.disabled = false;
                submitBtn.textContent = 'Zmie haso';
                return;
            }

            try {
                const credential = EmailAuthProvider.credential(user.email, currentPassword);
                await reauthenticateWithCredential(user, credential);
                await updatePassword(user, newPassword);
                showNotification("Haso zostao pomylnie zmienione.", "Sukces");
                closeModal(changePasswordModal.overlay);
            } catch (error) {
                console.error("Bd podczas zmiany hasa:", error);
                if (error.code === 'auth/wrong-password') {
                    changePasswordModal.error.textContent = 'Bie偶ce haso jest nieprawidowe.';
                } else if (error.code === 'auth/weak-password') {
                    changePasswordModal.error.textContent = 'Nowe haso jest zbyt sabe.';
                } else {
                    changePasswordModal.error.textContent = 'Wystpi nieoczekiwany bd. Spr贸buj ponownie.';
                }
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Zmie haso';
            }
        });
        // --- CZ 5: Logika zmiany dziau ---

         const changeMyDayDate = (days) => {
            // Dzielimy dat na komponenty, aby unikn problem贸w z parsowaniem w r贸偶nych przegldarkach
            const [year, month, day] = state.ui.myDayDate.split('-').map(Number);
            // Tworzymy dat w UTC - miesic w konstruktorze jest 0-indeksowany, wic odejmujemy 1
            const currentDate = new Date(Date.UTC(year, month - 1, day));
        
            // Bezpiecznie dodajemy lub odejmujemy dni w kontekcie UTC
            currentDate.setUTCDate(currentDate.getUTCDate() + days);
        
            // Formatujemy dat z powrotem do stringa YYYY-MM-DD
            const newYear = currentDate.getUTCFullYear();
            const newMonth = String(currentDate.getUTCMonth() + 1).padStart(2, '0');
            const newDay = String(currentDate.getUTCDate()).padStart(2, '0');
            
            state.ui.myDayDate = `${newYear}-${newMonth}-${newDay}`;
            render();
        };

         myDayNav.prevBtn.addEventListener('click', () => changeMyDayDate(-1));
        myDayNav.nextBtn.addEventListener('click', () => changeMyDayDate(1));
        myDayNav.todayBtn.addEventListener('click', () => {
            state.ui.myDayDate = getLocalDateString();
            render();
        });
        myDayNavMobile.prevBtn.addEventListener('click', () => changeMyDayDate(-1));
        myDayNavMobile.nextBtn.addEventListener('click', () => changeMyDayDate(1));
        myDayNavMobile.todayBtn.addEventListener('click', () => {
            state.ui.myDayDate = getLocalDateString();
            render();
        });

// ... (listener dla settingsModal.openPasswordBtn) ...

// === USUNITO BLOK: Listener dla settingsModal.openChangeGroupBtn ===

// === USUNITO BLOK: Listener dla changeGroupNameInput.addEventListener('blur', ...) ===

// === USUNITO BLOK: Listener dla changeGroupModal.form.addEventListener('submit', ...) ===


// === KOD, KTRY POZOSTAJE (BEZ ZMIAN) ===
// Ta logika jest nadal potrzebna dla Wacicieli Grup.
// Jej wyzwalacz zostanie przeniesiony do nowego menu "Zarzdzaj Grup".

if (transferOwnershipModal.form) {
            console.log('[DEBUG] Formularz transferOwnershipModal.form ZNALEZIONY. Podpinam listener...');
            transferOwnershipModal.form.addEventListener('submit', async (e) => {
                e.preventDefault();
                console.log('[TRANSFER] Listener formularza URUCHOMIONY.');
                
                transferOwnershipModal.submitBtn.disabled = true; // Wycz przycisk od razu
                transferOwnershipModal.submitBtn.textContent = 'Przetwarzanie...';
                transferOwnershipModal.error.textContent = ''; // Wyczy bdy
    
                const newOwnerId = transferOwnershipModal.select.value;
                const user = state.currentUser; // Obecny waciciel (odchodzcy)
            
                if (!newOwnerId) {
                    transferOwnershipModal.error.textContent = 'Musisz wybra nowego waciciela.';
                    console.warn('[TRANSFER] Przerwano: Nie wybrano nowego waciciela.');
                    transferOwnershipModal.submitBtn.disabled = false; // Wcz z powrotem
                    transferOwnershipModal.submitBtn.textContent = 'Przeka偶 wasno i opu grup';
                    return;
                }
                console.log(`[TRANSFER] Wybrano nowego waciciela: ${newOwnerId}`);
            
                const targetGroupName = transferOwnershipModal.form.dataset.targetGroupName;
                const targetSubgroupName = transferOwnershipModal.form.dataset.targetSubgroupName;
            
                if (!targetGroupName) {
                    transferOwnershipModal.error.textContent = 'Bd wewntrzny: Nie znaleziono grupy docelowej.';
                    console.error('[TRANSFER] Przerwano: Brak targetGroupName w dataset.');
                    transferOwnershipModal.submitBtn.disabled = false;
                    transferOwnershipModal.submitBtn.textContent = 'Przeka偶 wasno i opu grup';
                    return;
                }
                console.log(`[TRANSFER] Grupa docelowa: ${targetGroupName}, Podgrupa: ${targetSubgroupName || 'brak'}`);
            
                try {
                    // --- KROK 1: Znajd藕 grup docelow ---
                    console.log(`[TRANSFER] Szukam grupy docelowej: ${targetGroupName}`);
                    const qGroup = query(groupsRef, where("name", "==", targetGroupName));
                    const groupSnapshot = await getDocs(qGroup);
                    if (groupSnapshot.empty) {
                        throw new Error("Nie mo偶na znale藕 grupy docelowej. Przerwano.");
                    }
                    const groupDoc = groupSnapshot.docs[0];
                    const newGroupId = groupDoc.id;
                    const newGroupName = groupDoc.data().name;
                    console.log(`[TRANSFER] Znaleziono grup docelow: ${newGroupName} (${newGroupId})`);
                    
                    // --- KROK 2: Przygotuj batch ---
                    const batch = writeBatch(db);
                    console.log('[TRANSFER] Utworzono batch.');
            
                    // --- KROK 3: Zaktualizuj obecn grup ---
                    const currentGroupRef = doc(groupsRef, user.groupId);
                    batch.update(currentGroupRef, { ownerId: newOwnerId });
                    console.log(`[TRANSFER] Batch: Aktualizacja grupy ${user.groupId}, nowy waciciel: ${newOwnerId}`);
            
                    // --- KROK 4: Znajd藕 projekty do przekazania ---
                    console.log(`[TRANSFER] Szukam projekt贸w do przekazania (waciciel: ${user.uid}) z grupy ${user.groupId}...`);
                    const qProjects = query(projectsRef, 
                        where("ownerId", "==", user.uid),
                        where("groupId", "==", user.groupId) // <-- DODAJ T LINI
                    );
                    let projectsSnapshot;
                    try {
                        projectsSnapshot = await getDocs(qProjects);
                        console.log(`[TRANSFER] Zapytanie o projekty wykonane. Znaleziono dokument贸w: ${projectsSnapshot.size}`);
                    } catch (queryError) {
                        console.error("[TRANSFER] Bd podczas zapytania o projekty:", queryError);
                         if (queryError.code === 'failed-precondition') {
                             showNotification("Bd konfiguracji bazy danych: Brak wymaganego indeksu dla pola 'ownerId' w kolekcji 'projects'. Sprawd藕 konsol Firestore.", "Bd Krytyczny");
                         } else {
                             showNotification("Bd podczas wyszukiwania projekt贸w.", "Bd");
                         }
                        throw queryError; // Rzu bdem dalej, aby zatrzyma i zresetowa przycisk
                    }
                    
                    const projectsToTransfer = projectsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    console.log(`[TRANSFER] Znaleziono ${projectsToTransfer.length} projekt贸w do przekazania.`);
            
                    projectsToTransfer.forEach(project => {
                        if (project.isInbox) {
                            console.log(`[TRANSFER] Pomijam transfer projektu Inbox: ${project.id}`);
                            return;
                        }

                        const projectRef = doc(projectsRef, project.id);

                        // === POCZTEK NOWEJ, POPRAWIONEJ LOGIKI (REASIGNACJA ZADA) ===

                        // 1. Aktualizacja listy czonk贸w:
                        let updatedMembers = [...(project.members || [])];
                        if (!updatedMembers.includes(newOwnerId)) {
                            updatedMembers.push(newOwnerId);
                        }
                        updatedMembers = updatedMembers.filter(memberId => memberId !== user.uid);

                        // 2. Aktualizacja zada (Reasignacja):
                        const modifiedTasks = (project.tasks || []).map(task => {
                            if (!(task.assignees || []).includes(user.uid)) {
                                return task; // Bez zmian, jeli stary waciciel nie by przypisany
                            }
                            const updatedTask = { ...task };
                            let newAssignees = (updatedTask.assignees || []).filter(id => id !== user.uid);
                            if (!newAssignees.includes(newOwnerId)) {
                                newAssignees.push(newOwnerId);
                            }
                            const newCompletedBy = (updatedTask.completedBy || []).filter(id => id !== user.uid);
                            const newType = newAssignees.length > 1 ? 'multi' : 'single';
                            const newStatus = (updatedTask.status === 'done') ? 'inprogress' : updatedTask.status; // Resetuj status, jeli byo 'done'

                            const modifiedSubtasks = (updatedTask.subtasks || []).map(subtask => {
                                if (!(subtask.assignees || []).includes(user.uid)) {
                                    return subtask; // Bez zmian
                                }
                                const updatedSubtask = { ...subtask };
                                let newSubAssignees = (updatedSubtask.assignees || []).filter(id => id !== user.uid);
                                if (!newSubAssignees.includes(newOwnerId)) {
                                    newSubAssignees.push(newOwnerId);
                                }
                                const newSubCompletedBy = (updatedSubtask.completedBy || []).filter(id => id !== user.uid);
                                const isNowCompleted = (newSubAssignees.length > 0) && newSubAssignees.every(id => newSubCompletedBy.includes(id));
                                return { ...updatedSubtask, assignees: newSubAssignees, completedBy: newSubCompletedBy, isCompleted: isNowCompleted };
                            });

                            return { ...updatedTask, assignees: newAssignees, completedBy: newCompletedBy, type: newType, status: newStatus, subtasks: modifiedSubtasks };
                        });

                        // 3. Dodaj zaktualizowane dane do batcha
                        batch.update(projectRef, {
                            ownerId: newOwnerId,
                            members: updatedMembers,
                            tasks: modifiedTasks
                        });
                        // === KONIEC NOWEJ, POPRAWIONEJ LOGIKI ===
                        console.log(`[TRANSFER] Batch: Aktualizacja projektu ${project.id}, nowy waciciel: ${newOwnerId}, usunito starego waciciela z czonk贸w ORAZ PRZENIESIONO jego zadania.`);
                    });
       
                    // --- KROK 5: Zaktualizuj profil odchodzcego waciciela ---
                    // --- KROK 5: Zaktualizuj profil odchodzcego waciciela ---
                    const userDocRef = doc(usersRef, user.uid);
                    batch.update(userDocRef, {
                        groupId: newGroupId,
                        groupName: newGroupName,
                        subgroupName: targetSubgroupName
                    });
                    console.log(`[TRANSFER] Batch: Aktualizacja profilu u偶ytkownika ${user.uid} na now grup: ${newGroupId}`);
                    
                    // --- KROK 6: Wykonaj GWNY batch (Transfer) ---
                    console.log('[TRANSFER] Wykonuj GWNY batch.commit() (transfer wasnoci)...');
                    await batch.commit(); 
                    console.log('[TRANSFER] GWNY Batch wykonany pomylnie!');

                    // --- KROK 7: Sprztanie (Osobna operacja) ---
                    // Dopiero po pomylnym transferze, usuwamy stare czonkostwo.
                    // Ta funkcja ma teraz wasn logik i wasny batch.
                    console.log(`[TRANSFER] Wywouj removeUserFromProjectsMembership dla ${user.uid} ze starej grupy ${user.groupId}...`);
                    await removeUserFromProjectsMembership(user.uid, user.groupId);
                    console.log(`[TRANSFER] Zakoczono removeUserFromProjectsMembership.`);

                    closeModal(transferOwnershipModal.overlay);
                    showNotification("Wasno grupy i projekt贸w zostaa przekazana. Zostae przeniesiony do nowej grupy.", "Sukces");
            
                } catch (error) {
                    console.error("Bd podczas transferu wasnoci grupy:", error);
                    transferOwnershipModal.error.textContent = `Bd: ${error.message}`;
                    // Reset przycisku tylko w razie bdu
                    transferOwnershipModal.submitBtn.disabled = false;
                    transferOwnershipModal.submitBtn.textContent = 'Przeka偶 wasno i opu grup';
                }
            }); // Koniec listenera submit
             console.log('[DEBUG] Listener dla transferOwnershipModal.form PODPITY.');
        } else {
             console.error('[DEBUG] KRYTYCZNY BD: Nie znaleziono elementu transferOwnershipModal.form w DOM!');
        }
        // === KONIEC KODU, KTRY POZOSTAJE ===
        

         const handleProjectLinkClick = (e) => {
            e.preventDefault();
            
            closeChatPanel(); // <-- DODANA LINIA

            const link = e.target.closest('a');
            if (link && link.dataset.projectId) {
                state.currentProjectId = link.dataset.projectId;
                state.ui.currentView = 'projects';
                state.ui.isCalendarView = false;
                saveUiState();
                render();
                sidebar.classList.remove('open');
                sidebarOverlay.classList.remove('visible');
            }
        };
        projectsListEl.addEventListener('click', handleProjectLinkClick);
        completedProjectsListEl.addEventListener('click', handleProjectLinkClick);
        /**
         * Otwiera modal wyszukiwania i resetuje pole input.
         */
        function openSearchModal() {
            searchModal.input.value = '';
            searchModal.resultsList.innerHTML = '';
            openModal(searchModal.overlay);
        }
        mainNav.addEventListener('click', (e) => {
            e.preventDefault();
            const link = e.target.closest('a');
            if (!link) return;

            closeChatPanel(); // <-- DODANA LINIA

            state.ui.previousView = null;

            if (link.dataset.view) {
                // NOWY WARUNEK: Resetowanie daty przy wejciu w "M贸j dzie"
                if (link.dataset.view === 'my-day') {
                    state.ui.myDayDate = getLocalDateString();
                }
                state.currentProjectId = null;
                state.ui.currentView = link.dataset.view;
                state.ui.isCalendarView = false; 
                saveUiState();
                render();
                sidebar.classList.remove('open');
                sidebarOverlay.classList.remove('visible');
            } else if (link.dataset.projectId) {
                state.currentProjectId = link.dataset.projectId;
                state.ui.currentView = 'projects';
                state.ui.isCalendarView = false; 
                saveUiState();
                render();
                sidebar.classList.remove('open');
                sidebarOverlay.classList.remove('visible');
            }
        });

       // A. OTWIERANIE MODALA NOWEGO PROJEKTU
        newProjectBtn.addEventListener('click', () => {
            newProjectModal.form.reset();
            newProjectModal.memberSearchInput.value = '';
            newProjectModal.memberSearchResults.innerHTML = '';
            newProjectModal.memberSearchResults.classList.remove('visible');
            
            const today = new Date();
            const formattedDate = today.toISOString().split('T')[0];
            newProjectModal.startDateInput.value = formattedDate;

            // 1. Inicjalizacja tymczasowych r贸l
            newProjectModal.currentAdminIds = [];
            newProjectModal.currentSuperUserIds = [];

            // 2. Budowa Lewej Kolumny (Akordeon)
            buildTeamMembersAccordion(newProjectModal.membersContainer, [state.currentUser.uid]);
            
            // 3. Render Prawej Kolumny (Start)
            const rightCol = document.getElementById('new-project-selected-list');
            renderSelectedMembersColumn(
                newProjectModal.membersContainer, 
                rightCol, 
                state.currentUser.uid, 
                newProjectModal.currentAdminIds, 
                newProjectModal.currentSuperUserIds
            );
            
            openModal(newProjectModal.overlay);
        });

        // B. LEWA KOLUMNA (Kliknicie)
        // U偶ywamy onclick dla pewnoci nadpisania starych listener贸w
        newProjectModal.membersContainer.onclick = (e) => {
            const header = e.target.closest('.department-header');
            const pill = e.target.closest('.member-pill:not(.disabled)');

            if (header) {
                const usersContainer = header.nextElementSibling;
                if (usersContainer) {
                    header.classList.toggle('active');
                    usersContainer.classList.toggle('collapsed');
                }
            } else if (pill) {
                pill.classList.toggle('selected');
                
                const userId = pill.dataset.userId;
                const isSelected = pill.classList.contains('selected');

                // Jeli odznaczono, usu z r贸l
                if (!isSelected) {
                    newProjectModal.currentAdminIds = newProjectModal.currentAdminIds.filter(id => id !== userId);
                    newProjectModal.currentSuperUserIds = newProjectModal.currentSuperUserIds.filter(id => id !== userId);
                }
                
                // Odwie偶 praw
                const rightCol = document.getElementById('new-project-selected-list');
                renderSelectedMembersColumn(
                    newProjectModal.membersContainer, rightCol, state.currentUser.uid, 
                    newProjectModal.currentAdminIds, newProjectModal.currentSuperUserIds
                );
            }
        };

        

       // === ZAKTUALIZOWANY LISTENER: Kliknicie w prawej kolumnie (Nowy Projekt) ===
        // POPRAWKA: Definiujemy zmienn przed jej u偶yciem
        const newProjectRightCol = document.getElementById('new-project-selected-list');

        if (newProjectRightCol) {
            // Najpierw usuwamy stary listener (bezpiecznik, cho w czystym JS rzadko konieczny jeli kod jest dobrze uo偶ony)
            const newRightColClone = newProjectRightCol.cloneNode(true);
            newProjectRightCol.parentNode.replaceChild(newRightColClone, newProjectRightCol);
            
            // Teraz dodajemy poprawny listener do nowego (sklonowanego) elementu
            newRightColClone.addEventListener('click', (e) => {
                const userId = e.target.closest('.selected-member-row')?.dataset.userId;
                if (!userId) return;

                // A. Obsuga USUWANIA
                if (e.target.closest('.selected-member-remove')) {
                    const pill = newProjectModal.membersContainer.querySelector(`.member-pill[data-user-id="${userId}"]`);
                    if (pill) {
                        pill.classList.remove('selected');
                        
                        // Usu te偶 z r贸l
                        newProjectModal.currentAdminIds = newProjectModal.currentAdminIds.filter(id => id !== userId);
                        newProjectModal.currentSuperUserIds = newProjectModal.currentSuperUserIds.filter(id => id !== userId);

                        // Odwie偶
                        renderSelectedMembersColumn(
                            newProjectModal.membersContainer, 
                            newRightColClone, // U偶ywamy referencji do tego elementu
                            state.currentUser.uid, 
                            newProjectModal.currentAdminIds, 
                            newProjectModal.currentSuperUserIds
                        );
                    }
                    return;
                }

                // B. Obsuga RL (Admin / Super User)
                const roleBtn = e.target.closest('.role-btn');
                if (roleBtn) {
                    const roleType = roleBtn.dataset.role;
                    const pill = newProjectModal.membersContainer.querySelector(`.member-pill[data-user-id="${userId}"]`);
                    
                    if (roleType === 'admin') {
                        if (newProjectModal.currentAdminIds.includes(userId)) {
                            newProjectModal.currentAdminIds = newProjectModal.currentAdminIds.filter(id => id !== userId);
                        } else {
                            newProjectModal.currentAdminIds.push(userId);
                        }
                        // Synchronizacja ikony po lewej
                        if (pill) {
                            const leftBtn = pill.querySelector('.admin-toggle-btn');
                            if (leftBtn) leftBtn.classList.toggle('is-admin', newProjectModal.currentAdminIds.includes(userId));
                        }
                    } 
                    else if (roleType === 'superuser') {
                        if (newProjectModal.currentSuperUserIds.includes(userId)) {
                            newProjectModal.currentSuperUserIds = newProjectModal.currentSuperUserIds.filter(id => id !== userId);
                        } else {
                            newProjectModal.currentSuperUserIds.push(userId);
                        }
                        // Synchronizacja ikony po lewej
                        if (pill) {
                            const leftBtn = pill.querySelector('.superuser-toggle-btn');
                            if (leftBtn) leftBtn.classList.toggle('is-superuser', newProjectModal.currentSuperUserIds.includes(userId));
                        }
                    }

                    // Odwie偶 praw kolumn z nowymi danymi
                    renderSelectedMembersColumn(
                        newProjectModal.membersContainer, 
                        newRightColClone, // U偶ywamy referencji do tego elementu
                        state.currentUser.uid, 
                        newProjectModal.currentAdminIds, 
                        newProjectModal.currentSuperUserIds
                    );
                }
            });
        }
// Listener do obsugi akordeonu i piguek w oknie "Edytuj Projekt"
editProjectModal.membersContainer.addEventListener('click', (e) => {
    const header = e.target.closest('.department-header');
    const crownBtn = e.target.closest('.admin-toggle-btn'); 
    const superUserBtn = e.target.closest('.superuser-toggle-btn'); // <-- NOWE
    const pill = e.target.closest('.member-pill:not(.disabled)');

    if (header) {
        // Logika do rozwijania/zwijania akordeonu
        const usersContainer = header.nextElementSibling;
        if (usersContainer && usersContainer.classList.contains('department-users')) {
            header.classList.toggle('active');
            usersContainer.classList.toggle('collapsed');
        }
    } else if (crownBtn) {
        // === ZMIANA: Aktualizacja stanu tymczasowego Admina ===
        e.stopPropagation(); 
        const userId = crownBtn.dataset.userId;
        
        if (editProjectModal.currentAdminIds.includes(userId)) {
            editProjectModal.currentAdminIds = editProjectModal.currentAdminIds.filter(id => id !== userId);
            crownBtn.classList.remove('is-admin');
            crownBtn.title = 'Nadaj uprawnienia administratora projektu';
        } else {
            editProjectModal.currentAdminIds.push(userId);
            crownBtn.classList.add('is-admin');
            crownBtn.title = 'Odbierz uprawnienia administratora projektu';
        }
        // Odwie偶 praw kolumn, aby pokazaa zmian
        refreshEditRightColumn();

    } else if (superUserBtn) { 
        // === ZMIANA: Aktualizacja stanu tymczasowego SuperUsera ===
        e.stopPropagation();
        const userId = superUserBtn.dataset.userId;

        if (editProjectModal.currentSuperUserIds.includes(userId)) {
            editProjectModal.currentSuperUserIds = editProjectModal.currentSuperUserIds.filter(id => id !== userId);
            superUserBtn.classList.remove('is-superuser');
            superUserBtn.title = 'Nadaj uprawnienia SuperUsera (Zarzdzanie zadaniami)';
        } else {
            editProjectModal.currentSuperUserIds.push(userId);
            superUserBtn.classList.add('is-superuser');
            superUserBtn.title = 'Odbierz uprawnienia SuperUsera (Zarzdzanie zadaniami)';
        }
        // Odwie偶 praw kolumn, aby pokazaa zmian
        refreshEditRightColumn();

    } else if (pill) {
        // Logika do zaznaczania u偶ytkownik贸w
        pill.classList.toggle('selected');

        // === NOWO: Odwie偶 praw kolumn ===
        // Musimy pobra aktualne ID projektu, aby zna waciciela/admin贸w
        const projectId = editProjectModal.overlay.dataset.projectId;
        const project = findProject(projectId);
        const rightCol = document.getElementById('edit-project-selected-list');
        
        if (project) {
            renderSelectedMembersColumn(
                editProjectModal.membersContainer,
                rightCol,
                project.ownerId,
                project.admins || [],
                project.superUsers || []
            );
        }
    }
});
// Funkcja pomocnicza do odwie偶ania prawej kolumny w edycji
function refreshEditRightColumn() {
    const projectId = editProjectModal.overlay.dataset.projectId;
    const project = findProject(projectId);
    const rightCol = document.getElementById('edit-project-selected-list');
    
    if (project) {
        renderSelectedMembersColumn(
            editProjectModal.membersContainer,
            rightCol,
            project.ownerId,
            editProjectModal.currentAdminIds,     // Przekazujemy AKTUALNE tablice
            editProjectModal.currentSuperUserIds  // Przekazujemy AKTUALNE tablice
        );
    }
}
// === ZAKTUALIZOWANY LISTENER: Kliknicia w prawej kolumnie (Edytuj Projekt) ===
document.getElementById('edit-project-selected-list').addEventListener('click', (e) => {
    const userId = e.target.closest('.selected-member-row')?.dataset.userId;
    if (!userId) return;
    
    const projectId = editProjectModal.overlay.dataset.projectId;
    const project = findProject(projectId);
    if (!project) return;

    const leftContainer = editProjectModal.membersContainer;
    const rightContainer = document.getElementById('edit-project-selected-list');

    // 1. Obsuga USUWANIA
    if (e.target.closest('.selected-member-remove')) {
        const pill = leftContainer.querySelector(`.member-pill[data-user-id="${userId}"]`);
        if (pill) {
            pill.classList.remove('selected');
            // Odwie偶
            renderSelectedMembersColumn(leftContainer, rightContainer, project.ownerId, project.admins || [], project.superUsers || []);
        }
        return;
    }

   // 2. Obsuga RL
    const roleBtn = e.target.closest('.role-btn');
    if (roleBtn) {
        const roleType = roleBtn.dataset.role; // 'admin' lub 'superuser'
        const pill = leftContainer.querySelector(`.member-pill[data-user-id="${userId}"]`);
        
        if (pill) {
            if (roleType === 'admin') {
                // Aktualizacja tablicy
                if (editProjectModal.currentAdminIds.includes(userId)) {
                    editProjectModal.currentAdminIds = editProjectModal.currentAdminIds.filter(id => id !== userId);
                } else {
                    editProjectModal.currentAdminIds.push(userId);
                }
                
                // Synchronizacja wizualna lewej kolumny (ikona)
                const leftBtn = pill.querySelector('.admin-toggle-btn');
                if (leftBtn) leftBtn.classList.toggle('is-admin', editProjectModal.currentAdminIds.includes(userId));
            } 
            else if (roleType === 'superuser') {
                // Aktualizacja tablicy
                if (editProjectModal.currentSuperUserIds.includes(userId)) {
                    editProjectModal.currentSuperUserIds = editProjectModal.currentSuperUserIds.filter(id => id !== userId);
                } else {
                    editProjectModal.currentSuperUserIds.push(userId);
                }

                // Synchronizacja wizualna lewej kolumny (ikona)
                const leftBtn = pill.querySelector('.superuser-toggle-btn');
                if (leftBtn) leftBtn.classList.toggle('is-superuser', editProjectModal.currentSuperUserIds.includes(userId));
            }

            // 3. Odwie偶 praw kolumn u偶ywajc ZAKTUALIZOWANYCH tablic
            renderSelectedMembersColumn(
                leftContainer, 
                rightContainer, 
                project.ownerId, 
                editProjectModal.currentAdminIds, 
                editProjectModal.currentSuperUserIds
            );
        }
    }
});

        // === NOWY LISTENER: Obsuga akordeonu i piguek w modalu "NOWY SONDA呕" ===
        newPollModal.assigneesContainer.addEventListener('click', (e) => {
            const header = e.target.closest('.department-header');
            const pill = e.target.closest('.member-pill:not(.disabled)');

            if (header) {
                // Logika do rozwijania/zwijania akordeonu
                const usersContainer = header.nextElementSibling;
                if (usersContainer && usersContainer.classList.contains('department-users')) {
                    header.classList.toggle('active');
                    usersContainer.classList.toggle('collapsed');
                }
            } else if (pill) {
                // Logika do zaznaczania u偶ytkownik贸w
                pill.classList.toggle('selected');
            }
        });
        // === KONIEC NOWEGO LISTENERA ===
        /**
         * NOWA FUNKCJA POMOCNICZA: Waliduje i pobiera dane bud偶etu z formularza.
         * Zastpuje stary przycisk "Zapisz bud偶et".
         */
        function validateAndGetBudgetData(modalRefs) {
            // 1. Sprawd藕, czy bud偶et jest wczony
            if (!modalRefs.budgetToggle.checked) {
                return null;
            }

            // 2. Pobierz wartoci g贸wne
            const totalBudget = parseFloat(modalRefs.budgetAmountInput.value) || 0;
            const currency = modalRefs.budgetCurrencyInput.value.trim() || 'PLN';
            
            // 3. Pobierz pozycje z DOM
            const items = Array.from(modalRefs.budgetItemsList.querySelectorAll('li.budget-item'));
            const budgetItemsData = [];
            let itemsSum = 0;

            // 4. Walidacja pozycji
            for (const itemLi of items) {
                const nameInput = itemLi.querySelector('.budget-item-name');
                const amountInput = itemLi.querySelector('.budget-item-amount');
                const name = nameInput.value.trim();
                const amount = parseFloat(amountInput.value) || 0;

                // Walidacja: Nazwa wymagana przy kwocie > 0
                if (!name && amount > 0) {
                    nameInput.focus();
                    throw new Error("Ka偶da pozycja z kwot musi mie nazw.");
                }
                // Walidacja: Kwota nieujemna
                if (amount < 0) {
                    amountInput.focus();
                    throw new Error("Kwoty pozycji bud偶etowych nie mog by ujemne.");
                }

                // Dodaj do listy, jeli ma nazw lub kwot
                if (name || amount > 0) {
                    budgetItemsData.push({ name, amount });
                    itemsSum += amount;
                }
            }

            // 5. Walidacja sumy (Tolerancja bd贸w zmiennoprzecinkowych)
            const tolerance = 0.01;
            if (items.length > 0 && Math.abs(totalBudget - itemsSum) > tolerance) {
                throw new Error(`Suma pozycji (${itemsSum.toLocaleString('pl-PL', { minimumFractionDigits: 2 })} ${currency}) nie zgadza si z cakowitym bud偶etem (${totalBudget.toLocaleString('pl-PL', { minimumFractionDigits: 2 })} ${currency}).`);
            }

            // 6. Zwr贸 gotowy obiekt
            return {
                amount: totalBudget,
                currency: currency,
                items: budgetItemsData
            };
        }
        newProjectModal.form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const submitBtn = e.target.querySelector('button[type="submit"]');

            // --- KROK 1: Walidacja i pobranie bud偶etu "w locie" ---
            // Zastpuje stare sprawdzanie zmiennej newProjectTempBudgetSaved
            let budgetData = null;
            try {
                budgetData = validateAndGetBudgetData(newProjectModal);
            } catch (budgetError) {
                // Wywietl bd w modalu
                if (newProjectModal.budgetSaveErrorP) {
                    newProjectModal.budgetSaveErrorP.textContent = budgetError.message;
                }
                return; // Przerwij zapis
            }
            // --- KONIEC KROKU 1 ---

            try {
                submitBtn.disabled = true;
                submitBtn.textContent = 'Tworzenie...';

                const newName = newProjectModal.nameInput.value.trim();
                if (!newName) {
                    throw new Error("Nazwa projektu nie mo偶e by pusta.");
                }

                const selectedMembers = Array.from(newProjectModal.membersContainer.querySelectorAll('.member-pill.selected'))
                    .map(pill => pill.dataset.userId);

                if (!selectedMembers.includes(state.currentUser.uid)) {
                    selectedMembers.push(state.currentUser.uid);
                }
                const newDescription = newProjectModal.descriptionTextarea.value.trim();
                
                // Budowanie obiektu projektu
                const newProject = {
                    name: newName,
                    ownerId: state.currentUser.uid,
                    members: selectedMembers,
                    // === NOWO: Zapis r贸l ===
                    admins: newProjectModal.currentAdminIds || [],
                    superUsers: newProjectModal.currentSuperUserIds || [],
                    // === KONIEC ===
                    groupId: state.ui.activeGroupId,
                    description: newDescription,
                    startDate: newProjectModal.startDateInput.value,
                    endDate: newProjectModal.endDateInput.value,
                    priority: newProjectModal.prioritySelect.value,
                    tasks: [], 
                    // --- ZMIANA: Przypisanie zwalidowanego bud偶etu ---
                    budget: budgetData, 
                    // -------------------------------------------------
                    estimationType: newProjectModal.estimationTypeSelect.value
                };

                // Obsuga zada z szablonu (jeli istniej)
                const templateTasksJSON = newProjectModal.form.dataset.templateTasks;
                if (templateTasksJSON) {
                    try {
                        const templateTaskTitles = JSON.parse(templateTasksJSON);
                        if (templateTaskTitles.length > 0) {
                             newProject.tasks = templateTaskTitles.map((title, i) => ({
                                 id: `task${Date.now() + i}`,
                                 title,
                                 description: '',
                                 status: 'todo',
                                 createdBy: state.currentUser.uid,
                                 type: 'single',
                                 assignees: [state.currentUser.uid],
                                 completedBy: [],
                                 priority: 'medium',
                                 dueDate: null,
                                 comments: [],
                                 activityLog: [],
                                 recurrence: null,
                                 attachments: []
                             }));
                        }
                        delete newProjectModal.form.dataset.templateTasks;
                    } catch (parseError) {
                        console.error("Bd parsowania zada z szablonu:", parseError);
                    }
                }

                // Zapis do Firestore
                const docRef = await addDoc(projectsRef, newProject);

                // Powiadomienia o zaproszeniu
                sendInternalNotification(
                    newProject.members, 
                    'project_invite',
                    `<strong>${state.currentUser.name}</strong> zaprosi/a Ci do nowego projektu "<strong>${newProject.name}</strong>".`,
                    { type: 'project', projectId: docRef.id },
                    'project_invite'
                );

                state.currentProjectId = docRef.id;
                state.ui.currentView = 'projects';
                saveUiState();

                showNotification("Projekt zosta pomylnie utworzony.", "Sukces");
                closeModal(newProjectModal.overlay);

            } catch (error) {
                 console.error("Bd podczas tworzenia projektu:", error);
                 showNotification(error.message || "Wystpi bd podczas tworzenia projektu.", "Bd");
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Stw贸rz projekt';
                // Nie resetujemy ju偶 偶adnych zmiennych Temp, bo ich nie ma.
            }
        });

     

        editProjectModal.form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const projectId = editProjectModal.overlay.dataset.projectId;
            const newName = editProjectModal.nameInput.value.trim();
            // Pobieramy przycisk tutaj, aby mie do niego dostp w bloku finally
            const submitBtn = e.target.querySelector('button[type="submit"]'); 

            if (!projectId || !newName) {
                showNotification("ID projektu lub nazwa s nieprawidowe.", "Bd");
                return;
            }

            // --- ZMIANA: Walidacja i pobranie bud偶etu "w locie" ---
            // U偶ywamy nowej funkcji, kt贸ra nie potrzebuje zmiennych Temp
            let budgetData = null;
            try {
                budgetData = validateAndGetBudgetData(editProjectModal);
            } catch (budgetError) {
                // Wywietl bd w modalu, jeli walidacja nie przesza
                if(editProjectModal.budgetSaveErrorP) {
                    editProjectModal.budgetSaveErrorP.textContent = budgetError.message;
                }
                return; // Przerwij zapis
            }
            // --- KONIEC ZMIANY ---

            try {
                submitBtn.disabled = true; 
                submitBtn.textContent = 'Zapisywanie...';

                const selectedMembers = Array.from(editProjectModal.membersContainer.querySelectorAll('.member-pill.selected')).map(pill => pill.dataset.userId);
                
                // === ZMIANA: Pobieramy role z naszych tymczasowych tablic ===
                // Filtrujemy je, aby upewni si, 偶e ID nadal s w 'selectedMembers' (na wypadek gdyby kogo odznaczono)
                const finalAdminIds = editProjectModal.currentAdminIds.filter(id => selectedMembers.includes(id));
                const finalSuperUserIds = editProjectModal.currentSuperUserIds.filter(id => selectedMembers.includes(id));
                // === KONIEC ZMIANY ===

                const projectUpdates = {
                    name: newName,
                    members: selectedMembers,
                    admins: finalAdminIds,      // U偶ywamy zmiennej
                    superUsers: finalSuperUserIds, // U偶ywamy zmiennej
                    startDate: editProjectModal.startDateInput.value,
                    endDate: editProjectModal.endDateInput.value,
                    priority: editProjectModal.prioritySelect.value,
                    description: editProjectModal.descriptionTextarea.value,
                    // --- ZMIANA: U偶ycie lokalnej zmiennej budgetData (zamiast editProjectTempBudgetData) ---
                    budget: budgetData,
                    // --- KONIEC ZMIANY ---
                    estimationType: editProjectModal.estimationTypeSelect.value
                };

                await updateDoc(doc(projectsRef, projectId), projectUpdates);

                showNotification("Zmiany w projekcie zostay zapisane.", "Sukces"); 
                closeModal(editProjectModal.overlay);

            } catch (error) {
                 console.error("Bd podczas zapisywania zmian w projekcie:", error);
                 showNotification(error.message || "Wystpi bd podczas zapisywania zmian.", "Bd");
            } finally {
                 submitBtn.disabled = false; 
                 submitBtn.textContent = 'Zapisz zmiany';
                 // USUNITO: Resetowanie nieistniejcych ju偶 zmiennych tymczasowych
            }
        });
        
       // --- NOWY LISTENER DLA PRZYCISKU FILTRA ---
        filterBtn.addEventListener('click', () => {
            if (state.currentProjectId) {
                 openProjectFilterModal(state.currentProjectId);
            }
        });

        /**
         * Otwiera modal filtrowania i wypenia pola aktualnymi danymi projektu oraz filtrami.
         * @param {string} projectId ID bie偶cego projektu.
         */
        function openProjectFilterModal(projectId) {
            const project = findProject(projectId) || findCompletedProject(projectId);
            if (!project) return;
            
            // 1. Wyczy stary kontener checkbox贸w
            projectFilterModal.assigneeListContainer.innerHTML = '';
            
            // Dodaj opcj "Wszyscy czonkowie" (checkbox do odznaczania wszystkich)
            const everyoneCheckboxId = 'filter-assignee-all';
            projectFilterModal.assigneeListContainer.innerHTML += `
                 <div class="form-group-checkbox" style="margin-bottom: 4px; border-bottom: 1px dashed var(--border-color); padding-bottom: 4px;">
                     <input type="checkbox" id="${everyoneCheckboxId}" value="">
                     <label for="${everyoneCheckboxId}" style="font-weight: 600;">Wszyscy czonkowie</label>
                 </div>
            `;
            
            // 2. Wypenij list czonk贸w
            const filters = state.ui.currentProjectFilters;
            const currentAssigneeIds = filters.assigneeIds || [];
            
            (project.members || []).map(findUser).filter(Boolean).forEach(member => {
                 const memberId = member.id;
                 const isSelected = currentAssigneeIds.includes(memberId);
                 const memberCheckboxId = `filter-assignee-${memberId}`;
                 
                 projectFilterModal.assigneeListContainer.innerHTML += `
                     <div class="form-group-checkbox" style="margin-bottom: 4px;">
                         <input type="checkbox" id="${memberCheckboxId}" value="${memberId}" ${isSelected ? 'checked' : ''}>
                         <label for="${memberCheckboxId}" style="display: flex; align-items: center; gap: 8px;">
                            ${renderAvatarHTML(member, 'avatar-comment')}
                            <span>${member.name || member.email}</span>
                         </label>
                     </div>
                 `;
            });
            
            // Ustaw stan checkboxa "Wszyscy czonkowie"
            const everyoneCheckbox = document.getElementById(everyoneCheckboxId);
            if (everyoneCheckbox) {
                // Jeli lista filtr贸w jest pusta, zaznacz "Wszyscy czonkowie"
                everyoneCheckbox.checked = currentAssigneeIds.length === 0;
            }

            // 3. Ustaw aktualne wartoci filtr贸w dla pozostaych p贸l
            projectFilterModal.prioritySelect.value = filters.priority || '';
            projectFilterModal.dueDateSelect.value = filters.dueDate || '';
            projectFilterModal.budgetStatusSelect.value = filters.budgetStatus || '';
            projectFilterModal.pollToggle.checked = filters.showPolls;

            // 4. Zaktualizuj komunikat o statusie
            updateFilterStatusMessage();
            
            // 5. Otw贸rz modal
            openModal(projectFilterModal.overlay);
        }
        
        /**
         * Aktualizuje komunikat statusu w modalu filtrowania i w nag贸wku.
         */
        function updateFilterStatusMessage() {
            const filters = state.ui.currentProjectFilters;
            const activeFilters = [];

            if (filters.assigneeIds && filters.assigneeIds.length > 0) { // <-- ZMIANA: Obsuga tablicy
                const userNames = filters.assigneeIds.map(findUser).filter(Boolean).map(u => u.name || u.email);
                const displayNames = userNames.length > 2 ? `${userNames.slice(0, 2).join(', ')} +${userNames.length - 2}` : userNames.join(', ');
                activeFilters.push(`Osoby: ${displayNames}`);
            }
            if (filters.priority) {
                activeFilters.push(`Priorytet: ${filters.priority}`);
            }
            if (filters.dueDate) {
                activeFilters.push(`Termin: ${filters.dueDate}`);
            }
            if (filters.budgetStatus) {
                activeFilters.push(`Bud偶et: ${filters.budgetStatus === 'has-budget' ? 'Ma koszty' : 'Brak koszt贸w'}`);
            }
            // <-- DODANA SEKCJA -->
            if (!filters.showPolls) {
                activeFilters.push('Ukryte sonda偶e');
            }
            // <-- KONIEC DODANEJ SEKCJI -->
            
            const message = activeFilters.length > 0 
                ? `Filtrowanie aktywne: ${activeFilters.join(', ')}`
                : 'Filtrowanie aktywne: Brak';
            
            projectFilterModal.statusMessage.textContent = message;
            
            // Dodatkowe oznaczenie wizualne dla przycisku filtra w nag贸wku
            filterBtn.classList.toggle('active', activeFilters.length > 0);
        }
        
        // --- LISTENER DLA PRZYCISKW FILTRA ---
        projectFilterModal.applyBtn.addEventListener('click', () => {
             // 1. Zbieranie zaznaczonych ID czonk贸w
            const selectedAssigneeIds = Array.from(projectFilterModal.assigneeListContainer.querySelectorAll('input[type="checkbox"]:checked:not(#filter-assignee-all)'))
                                            .map(cb => cb.value);

            // Zapisz nowe filtry do stanu
            state.ui.currentProjectFilters = {
                assigneeIds: selectedAssigneeIds, // <-- ZMIANA: Zapisujemy tablic ID
                priority: projectFilterModal.prioritySelect.value,
                dueDate: projectFilterModal.dueDateSelect.value,
                budgetStatus: projectFilterModal.budgetStatusSelect.value,
                showPolls: projectFilterModal.pollToggle.checked // <-- DODANA LINIA
            };
            saveUiState();
            closeModal(projectFilterModal.overlay);
            render(); // Wymu pene ponowne renderowanie, aby zastosowa filtry
        });
        
        projectFilterModal.clearBtn.addEventListener('click', () => {
            // Zresetuj stan filtr贸w
            state.ui.currentProjectFilters = {
                assigneeIds: [], // <-- ZMIANA: Resetujemy tablic ID
                priority: '',
                dueDate: '',
                budgetStatus: '',
                showPolls: true // <-- DODANA LINIA (reset do domylnej wartoci)
            };
            // Wyczy pola w modalu
            // Zmieniono: projectFilterModal.assigneeSelect.value = '';
            projectFilterModal.prioritySelect.value = '';
            projectFilterModal.dueDateSelect.value = '';
            projectFilterModal.budgetStatusSelect.value = '';
            projectFilterModal.pollToggle.checked = true; // <-- DODANA LINIA (reset UI przecznika)
            
            saveUiState();
            closeModal(projectFilterModal.overlay);
            render(); // Wymu pene ponowne renderowanie
        });
       // ZMODYFIKOWANY LISTENER: Obsuga klikni w tabeli koszt贸w (Zadania i Podzadania)
    projectDetailsModal.overlay.addEventListener('click', (e) => {
        // Szukamy elementu z klas clickable-task-name
        const clickableTask = e.target.closest('.clickable-task-name');

        if (clickableTask) {
            const taskId = clickableTask.dataset.taskId;
            const subtaskId = clickableTask.dataset.subtaskId; // Mo偶e by undefined

            if (taskId) {
                // 1. Zamknij modal szczeg贸贸w projektu
                closeModal(projectDetailsModal.overlay);

                // 2. Otw贸rz odpowiedni modal z op贸藕nieniem
                setTimeout(() => {
                    if (subtaskId) {
                        // To jest podzadanie - otw贸rz modal podzadania
                        // Przekazujemy ID rodzica (taskId) i ID podzadania (subtaskId)
                        openSubtaskModal(taskId, subtaskId, 'budget'); // Otw贸rz od razu na zakadce bud偶etu
                    } else {
                        // To jest zadanie g贸wne
                        openTaskModal(taskId, 'taskBudget'); // Otw贸rz od razu na zakadce bud偶etu
                    }
                }, 150);
            }
        }
    });
       // NOWY LISTENER: Obsuga klikni w tabeli koszt贸w w modalu szczeg贸贸w projektu
    projectDetailsModal.overlay.addEventListener('click', (e) => {
        const clickableTask = e.target.closest('.clickable-task-name');

        // Sprawd藕, czy kliknito na nazw zadania
        if (clickableTask && clickableTask.dataset.taskId) {
            // ... (istniejcy kod) ...
        }
    });

    // === NOWY LISTENER DLA ZWIJANYCH SEKCJI W SZCZEGACH PROJEKTU ===
    projectDetailsModal.overlay.addEventListener('click', (e) => {
        const header = e.target.closest('.collapsible-header');
        if (!header) return; // Kliknito gdzie indziej
        
        const targetSelector = header.dataset.target;
        if (!targetSelector) return; // Brak data-target

        // U偶ywamy 'overlay', aby mie pewno, 偶e szukamy wewntrz waciwego modala
        const content = projectDetailsModal.overlay.querySelector(targetSelector);
        if (!content) {
             console.error("Nie znaleziono elementu do zwinicia:", targetSelector);
             return;
        }

        // Znajd藕 tekst
        const toggleText = header.querySelector('.toggle-text');

        // Przecz klas 'collapsed' na obu elementach
        header.classList.toggle('collapsed');
        content.classList.toggle('collapsed');

        // Zaktualizuj tekst na podstawie NOWEGO stanu
        if (header.classList.contains('collapsed')) {
            if (toggleText) toggleText.textContent = 'Rozwi';
        } else {
            if (toggleText) toggleText.textContent = 'Zwi';
        }

        // Jeli rozwijamy sekcj wykresu obci偶enia, przerysuj go
        if (targetSelector === '#details-workload-chart-container' && !content.classList.contains('collapsed')) {
            if (workloadChartInstance) {
                // Op贸藕nienie, aby wykres przerysowa si PO zakoczeniu animacji CSS
                setTimeout(() => {
                    workloadChartInstance.resize();
                }, 310); // (czas animacji + may bufor)
            }
        }
    });
    // === KONIEC NOWEGO LISTENERA ===
       
        
        // === ZAKTUALIZOWANY LISTENER: Lewa kolumna w Nowym Zadaniu ===
        newTaskModal.assigneesList.addEventListener('click', (e) => {
            const header = e.target.closest('.department-header');
            const pill = e.target.closest('.member-pill:not(.disabled)');

            if (header) {
                const usersContainer = header.nextElementSibling;
                if (usersContainer && usersContainer.classList.contains('department-users')) {
                    header.classList.toggle('active');
                    usersContainer.classList.toggle('collapsed');
                }
            } else if (pill) {
                pill.classList.toggle('selected');
                // Odwie偶 praw kolumn po zmianie wyboru
                renderSelectedMembersColumn(newTaskModal.assigneesList, newTaskModal.selectedList, null, [], []);
            }
        });
        
        // === NOWY LISTENER: Prawa kolumna w Nowym Zadaniu (Usuwanie) ===
        if (newTaskModal.selectedList) {
            newTaskModal.selectedList.addEventListener('click', (e) => {
                if (e.target.closest('.selected-member-remove')) {
                    const userId = e.target.closest('.selected-member-row')?.dataset.userId;
                    if (userId) {
                        const pill = newTaskModal.assigneesList.querySelector(`.member-pill[data-user-id="${userId}"]`);
                        if (pill) {
                            pill.classList.remove('selected');
                            renderSelectedMembersColumn(newTaskModal.assigneesList, newTaskModal.selectedList, null, [], []);
                        }
                    }
                }
            });
        }
       // --- NOWY LISTENER: Obsuga checkboxa "Wszyscy czonkowie" ---
        // (Ten listener zosta dodany w poprzednim kroku i znajduje si w odpowiednim miejscu)
        projectFilterModal.assigneeListContainer.addEventListener('change', (e) => {
            if (e.target.id === 'filter-assignee-all') {
                const isChecked = e.target.checked;
                // Odznacz/Zaznacz wszystkie inne checkboxe, ale NIE te w sekcji Bud偶etu/etc.
                projectFilterModal.assigneeListContainer.querySelectorAll('input[type="checkbox"]:not(#filter-assignee-all)').forEach(cb => {
                    // Odznaczamy pozostae tylko jeli "Wszyscy czonkowie" jest zaznaczony
                    if (isChecked) {
                        cb.checked = false; 
                    }
                });
            } else if (e.target.closest('#filter-assignee-list-container')) {
                 // Jeli zaznaczono pojedynczego czonka, odznacz "Wszyscy czonkowie"
                 const everyoneCheckbox = document.getElementById('filter-assignee-all');
                 if (everyoneCheckbox && e.target.checked) {
                     everyoneCheckbox.checked = false;
                 }
                 // Jeli odznaczono ostatniego czonka i nikt inny nie jest zaznaczony, zaznacz "Wszyscy czonkowie"
                 const allOtherCheckboxes = projectFilterModal.assigneeListContainer.querySelectorAll('input[type="checkbox"]:not(#filter-assignee-all)');
                 const anyOtherChecked = Array.from(allOtherCheckboxes).some(cb => cb.checked);
                 if (!anyOtherChecked) {
                     document.getElementById('filter-assignee-all').checked = true;
                 }
            }
        });
        // --- KONIEC NOWEGO LISTENERA ---

        newTaskModal.form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const submitBtn = e.target.querySelector('button[type="submit"]');

    try {
        submitBtn.disabled = true;
        submitBtn.textContent = 'Zapisywanie...';

        const title = newTaskModal.title.value.trim();
        if(!title) {
            showNotification("Tytu zadania jest wymagany.", "Bd");
            return;
        };

        let projectId;
        const projectSelect = newTaskModal.projectSelect;
        
        // Uproszczona i bardziej niezawodna logika pobierania ID projektu
        projectId = projectSelect.value;

        const project = findProject(projectId);
        if(!project) {
             showNotification("Nie udao si zidentyfikowa projektu docelowego. Wybierz projekt z listy.", "Bd");
             return;
        }

        // === NOWA LOGIKA POBIERANIA OSB ===
        // Pobierz wszystkich zaznaczonych z nowego kontenera
        const assignees = Array.from(newTaskModal.assigneesList.querySelectorAll('.member-pill.selected'))
                           .map(pill => pill.dataset.userId);

        // Dynamicznie ustal typ na podstawie liczby os贸b
        // 0 lub 1 osoba = 'single', wicej = 'multi'
        const taskType = assignees.length > 1 ? 'multi' : 'single';
        // === KONIEC ===
        
        // === NOWA LOGIKA: czenie daty i czasu z 3 p贸l ===
        // Data Rozpoczcia
        const s_date = newTaskModal.startDateDate.value;
        const s_hour = newTaskModal.startDateHour.value;
        const s_minute = newTaskModal.startDateMinute.value;
        let newStartDate = null;
        if (s_date && s_hour && s_minute) {
            newStartDate = `${s_date}T${s_hour}:${s_minute}`;
        }
        
        // Termin Wykonania
        const d_date = newTaskModal.dueDateDate.value;
        const d_hour = newTaskModal.dueDateHour.value;
        const d_minute = newTaskModal.dueDateMinute.value;
        let newDueDate = null;
        if (d_date && d_hour && d_minute) {
            newDueDate = `${d_date}T${d_hour}:${d_minute}`;
        }
        
        // === NOWA WALIDACJA DAT ===
        if (newStartDate && newDueDate) {
            if (new Date(newDueDate) <= new Date(newStartDate)) {
                showNotification("Termin wykonania musi by p贸藕niejszy ni偶 data rozpoczcia.", "Bd");
                // Zresetuj przycisk, bo przerywamy
                submitBtn.disabled = false;
                submitBtn.textContent = 'Zapisz zadanie';
                return; // Przerwij funkcj submit
            }
        }
        // === KONIEC ZMIANY ===
        let recurrence = null;
        
        // === POCZTEK ZMIANY: Przeniesienie definicji zmiennej ===
        // Definiujemy newEstimation TUTAJ, aby bya dostpna globalnie w funkcji
        const newEstimationValue = parseFloat(newTaskModal.effortInput.value);
        const newEstimation = (newEstimationValue > 0) ? newEstimationValue : null;
        // === KONIEC ZMIANY ===

        if (newTaskModal.isRecurring.checked) {
            // SPRAWDZENIE BDU: newDueDate jest obliczane kilka linii wy偶ej
            // Poprawiem warunek, aby sprawdza zmienn 'newDueDate' (kt贸ra ma warto null, jeli data nie jest ustawiona)
            // zamiast nieistniejcego 'newTaskModal.dueDate.value'.
            
            // USUNITO DEFINICJ STD:
            // const newEstimationValue = parseFloat(newTaskModal.effortInput.value);
            // const newEstimation = (newEstimationValue > 0) ? newEstimationValue : null;
            
            if (!newDueDate) {
                showNotification("Zadanie cykliczne musi mie ustawiony termin wykonania.", "Bd");
                
                // Zresetuj przycisk przed wyjciem
                submitBtn.disabled = false;
                submitBtn.textContent = 'Zapisz zadanie';
                return;
            }
            const type = newTaskModal.recurrenceType.value;
            recurrence = { type: type };
            if (type === 'dayOfMonth') {
                recurrence.day = parseInt(newTaskModal.recurrenceDay.value) || 1;
            } else if (type === 'nthDayOfMonth') {
                recurrence.nth = document.getElementById('new-task-recurrence-nth').value;
                recurrence.weekday = document.getElementById('new-task-recurrence-weekday').value;
            }
        }
        // <<<===== POCZTEK NOWEGO KODU =====>>>
        // --- NOWA LOGIKA ZAPISU BUD呕ETU NOWEGO ZADANIA (Etap 1 - Walidacja i Odczyt) ---
        let taskBudgetItems = null;
        let budgetValidationError = null;

        if (newTaskModal.budgetToggle.checked) {
            taskBudgetItems = [];
            const itemsLi = newTaskModal.budgetItemsList.querySelectorAll('li.budget-item');
            // USUNITO: const addedItemNames = new Set();

            itemsLi.forEach(itemLi => {
                const nameSelect = itemLi.querySelector('.task-budget-item-name');
                const amountInput = itemLi.querySelector('.task-budget-item-amount');
                const name = nameSelect.value;
                const amount = parseFloat(amountInput.value) || 0;

                if (!name && amount > 0) {
                    budgetValidationError = "Ka偶da pozycja kosztowa z kwot musi mie wybran nazw.";
                    nameSelect.focus();
                } else if (name && amount <= 0) {
                    budgetValidationError = `Kwota dla pozycji "${name}" musi by wiksza od zera.`;
                    amountInput.focus();
                } else if (name && amount > 0) {
                    // ZMIANA: Usunito sprawdzanie duplikat贸w (addedItemNames).
                    // Pozwalamy na wielokrotne dodanie tej samej kategorii (np. 2x Marketing).
                    taskBudgetItems.push({ name, amount });
                }
            });

            if (budgetValidationError) {
                newTaskModal.budgetErrorP.textContent = budgetValidationError;
                if (!newTaskModal.budgetTabButton.classList.contains('active')) {
                    newTaskModal.budgetTabButton.click();
                }
                // WA呕NE: Zresetuj przycisk, bo przerywamy
                submitBtn.disabled = false;
                submitBtn.textContent = 'Zapisz zadanie';
                return; // Przerwij funkcj submit
            }

            if (taskBudgetItems.length === 0) {
                taskBudgetItems = null;
            }
        }
        // --- KONIEC NOWEJ LOGIKI ZAPISU BUD呕ETU ---
        // <<<===== KONIEC NOWEGO KODU =====>>>
        
        // === NOWE: Pobranie wartoci koloru z ID ===
        let finalBackgroundColor = null;
        if (newTaskTempColor && newTaskTempColor !== 'default') {
            const colorObj = TASK_COLORS.find(c => c.id === newTaskTempColor);
            if (colorObj) finalBackgroundColor = colorObj.value;
        }
        // === KONIEC ===

        // === NOWE: Pobranie ostrze偶e ===
        const warningOverride = newTaskModal.warningOverride ? newTaskModal.warningOverride.checked : false;
        let warningDays = null;
        if (warningOverride && newTaskModal.warningDaysInput) {
            warningDays = parseInt(newTaskModal.warningDaysInput.value, 10) || 3;
        }
        // === KONIEC ===

        const newTask = {
                id: `task${Date.now()}`, title,
                createdBy: state.currentUser.uid,
                createdAt: Timestamp.now(), 
                description: newTaskModal.description.value,
                status: 'todo', 
                type: taskType,
                assignees: assignees,
                completedBy: [],
                priority: newTaskModal.priority.value,
                
                // === NOWE POLA ===
                warningOverride: warningOverride,
                warningDays: warningDays,
                // === KONIEC ===
                startDate: newStartDate, // <-- DODANA LINIA
                dueDate: newDueDate,
                comments: [],
                activityLog: [],
                recurrence: recurrence,
                budgetItems: taskBudgetItems, // (istniejca poprawna linia)
                
                // --- NOWA LINIA: Dodanie bannera ---
                coverImage: newTaskTempBannerData, // Dodaj dane z pamici tymczasowej
                // --- KONIEC NOWEJ LINII ---
                
                backgroundColor: finalBackgroundColor, // <<< DODANE: Zapisz kolor ta

                estimation: newEstimation,
                
                // === POCZTEK NOWEGO KODU: Ustawienie domylnego Actual Effort ===
                actualEffort: newEstimation, // Domylnie actual = estimated
                // === KONIEC NOWEGO KODU ===
                
                attachments: [] // <-- Wa偶ne: dodajemy pust tablic na zaczniki
            };

        // NOWA LOGIKA WYSYANIA PLIKW
        if (stagedFiles.length > 0) {
            submitBtn.textContent = `Przesyanie ${stagedFiles.length} plik(贸w)...`;

            const attachmentPromises = stagedFiles.map(file => {
                const storagePath = `attachments/${project.id}/${newTask.id}/${Date.now()}_${file.name}`;
                const storageRef = ref(storage, storagePath);
                return uploadBytes(storageRef, file).then(snapshot => getDownloadURL(snapshot.ref)).then(downloadURL => ({
                    id: `att_${Date.now()}_${Math.random()}`,
                    name: file.name,
                    url: downloadURL,
                    path: storagePath,
                    uploadedBy: state.currentUser.uid,
                    timestamp: Date.now()
                }));
            });

            const uploadedAttachments = await Promise.all(attachmentPromises);
            newTask.attachments = uploadedAttachments;
        }
        // Przygotuj list zada Z NOWYM zadaniem
            const updatedTasksList = [...(project.tasks || []), newTask];

            // --- AKTUALIZACJA LOGIKI (Wersja 2): Obliczanie i zapis budgetSummary ---
            const newBudgetSummary = calculateProjectBudgetSummary(updatedTasksList);

            // === NOWA LOGIKA: Automatyczne dodanie nowych os贸b do czonk贸w PROJEKTU ===
            let updatedProjectMembers = [...(project.members || [])];
            let membersChanged = false;

            assignees.forEach(userId => {
                if (!updatedProjectMembers.includes(userId)) {
                    updatedProjectMembers.push(userId);
                    membersChanged = true;
                }
            });

            // Przygotuj obiekt aktualizacji
            const updatePayload = {
                tasks: updatedTasksList,
                budgetSummary: newBudgetSummary
            };

            // Jeli doszli nowi czonkowie, dodaj ich do aktualizacji
            if (membersChanged) {
                updatePayload.members = updatedProjectMembers;
            }
            // === KONIEC NOWEJ LOGIKI ===

            // Zapisz w Firestore
            await updateDoc(doc(projectsRef, project.id), updatePayload);
            
            // Aktualizacja lokalnego stanu (aby UI od razu widziao nowych czonk贸w w nag贸wku)
            if (membersChanged) {
                project.members = updatedProjectMembers;
            }
            
            console.log(`[Budget v2] Zaktualizowano budgetSummary dla projektu ${project.id} po dodaniu nowego zadania ${newTask.id}.`);
            // --- KONIEC AKTUALIZACJI ---
        
        // --- POCZTEK DODANEGO KODU POWIADOMIE ---
        // Zastpujemy batch funkcj sendInternalNotification z kluczem 'task_assign'
        if (newTask.assignees.length > 0) {
             sendInternalNotification(
                newTask.assignees, // Funkcja sama odfiltruje tw贸rc
                'task_assigned',
                `<strong>${state.currentUser.name}</strong> przypisa/a Ci do nowego zadania "<strong>${newTask.title}</strong>" w projekcie <em>${project.name}</em>.`,
                { type: 'task', projectId: project.id, taskId: newTask.id },
                'task_assign' // <--- KLUCZ USTAWIENIA
            );
        }
        // --- KONIEC DODANEGO KODU POWIADOMIE ---
        
        closeModal(newTaskModal.overlay); // Zamknij modal po sukcesie
                // ==========================================================

            } catch (error) { // Blok catch do obsugi bd贸w
                 console.error("Bd podczas tworzenia zadania:", error);
                 showNotification("Wystpi bd podczas zapisywania zadania.", "Bd");
                 // Jeli wystpi bd, modal NIE zostanie zamknity
            } finally { // Blok finally (wykona si zawsze)
                 stagedFiles = [];
                 renderStagedFiles();
                 
                 // --- NOWA LINIA: Reset bannera po zapisie ---
                 newTaskTempBannerData = null; 
                 // --- KONIEC NOWEJ LINII ---

                 submitBtn.disabled = false;
                 submitBtn.textContent = 'Zapisz zadanie';
            }
        });


        async function handleTaskCompletion(task, project, completionSource = 'manual') {
        const projectDocRef = findProject(project.id) ? doc(projectsRef, project.id) : doc(completedProjectsRef, project.id);
        
        // === POCZTEK ZMIANY (z KROKU 2 - Filtrowanie): Dodanie logiki completedAt ===
        if (task.status === 'done') {
            // Jeli zadanie jest oznaczane jako 'done', ustawiamy lub aktualizujemy 'completedAt'
            if (!task.completedAt) { // Ustaw only jeli jeszcze nie ma (zapobiega nadpisaniu przy auto-complete)
                 task.completedAt = Timestamp.now(); // <<< MODYFIKACJA
            }
        } else {
            // Jeli zadanie jest przenoszone z 'done' do 'todo'/'inprogress', czycimy dat
            task.completedAt = null;
        }
        // === KONIEC ZMIANY (z KROKU 2 - Filtrowanie) ===
        
        let tasks = project.tasks.map(t => (t.id === task.id ? task : t));

        // Tw贸rz cykliczne zadanie, jeli status to 'done' i ma zdefiniowan cykliczno
        if (task.status === 'done' && task.recurrence) {
            
            // === POCZTEK PRZYWRCONEGO KODU ===
            const nextDueDate = calculateNextDueDate(task.dueDate, task.recurrence);

            // --- POCZTEK NOWEJ ZMIANY --- (To byo w oryginale)
            // Przygotuj zresetowane podzadania
            const resetSubtasks = (task.subtasks || []).map(subtask => ({
                ...subtask,
                isCompleted: false, // Resetuj status ukoczenia
                completedBy: []     // Wyczy list os贸b, kt贸re ukoczyy
            }));
            // --- KONIEC NOWEJ ZMIANY --- (To byo w oryginale)

            const nextTask = { // <--- PRZYWRCONA DEFINICJA ZMIENNEJ
                ...task,
                // --- POCZTEK NOWEJ ZMIANY --- (To byo w oryginale)
                subtasks: resetSubtasks, // U偶yj zresetowanych podzada
                // --- KONIEC NOWEJ ZMIANY --- (To byo w oryginale)
                id: `task${Date.now()}`,
                status: 'todo',
                dueDate: nextDueDate,
                completedBy: [],
                activityLog: [],
                completedAt: null, // <-- DODANA LINIA: Resetuj dat ukoczenia
                budgetItems: task.budgetItems
            };
            tasks.push(nextTask); // <--- Poprawne u偶ycie
            // === KONIEC PRZYWRCONEGO KODU ===
        }

        // === NOWA LOGIKA: Powiadomienia (Subskrypcje, Zale偶noci, Cofnicie) ===
        
        // 1. Subskrybenci (Task Completed)
        if (task.status === 'done' && task.subscribers && task.subscribers.length > 0) {
            sendCompletionNotifications(task, project);
        }

        // 2. Zale偶noci (Task Unlocked) - Jeli to zadanie blokowao inne, powiadom ich wacicieli
        if (task.status === 'done') {
            // Szukamy w projekcie zada, kt贸re s zablokowane przez TO zadanie (task.id)
            const dependentTasks = project.tasks.filter(t => 
                t.dependency && t.dependency.blockingTaskId === task.id && t.status !== 'done'
            );

            dependentTasks.forEach(depTask => {
                const recipients = depTask.assignees || [];
                if (recipients.length > 0) {
                    const msg = `Zadanie "<strong>${task.title}</strong>" zostao ukoczone. Mo偶esz rozpocz prac nad: "<strong>${depTask.title}</strong>".`;
                    sendInternalNotification(
                        recipients,
                        'task_assigned', 
                        msg,
                        { type: 'task', projectId: project.id, taskId: depTask.id },
                        'dependency' // <--- KLUCZ USTAWIENIA
                    );
                }
            });
        }

        // 3. Cofnicie do poprawki (Status Reversal)
        // Jeli zadanie byo 'done' lub 'inprogress', a wraca do 'todo' -> i robi to kto inny ni偶 przypisany
        // (Zakadamy completionSource='manual', bo auto-complete nie cofa)
        if (completionSource === 'manual' && task.status === 'todo' && task.assignees.length > 0) {
            // Sprawdzamy czy user nie jest przypisany (czyli np. manager cofa zadanie pracownika)
            const amIAssigned = task.assignees.includes(state.currentUser.uid);
            if (!amIAssigned) {
                const msg = `<strong>${state.currentUser.name}</strong> cofn status zadania "<strong>${task.title}</strong>" do 'Do realizacji'. Sprawd藕, co wymaga poprawy.`;
                sendInternalNotification(
                    task.assignees,
                    'alert', 
                    msg,
                    { type: 'task', projectId: project.id, taskId: task.id },
                    'correction' // <--- KLUCZ USTAWIENIA
                );
            }
        }
        // === KONIEC NOWEJ LOGIKI ===

        // Przelicz bud偶et na podstawie ZAKTUALIZOWANEJ listy zada (tasks)
        const newBudgetSummary = calculateProjectBudgetSummary(tasks);

        // Zapisz obie zmiany (zadania i bud偶et) atomowo
        await updateDoc(projectDocRef, {
            tasks: tasks,
            budgetSummary: newBudgetSummary
        });
        console.log(`[Budget v2] Zaktualizowano budgetSummary po zmianie statusu zadania ${task.id}.`);
    }

        async function handleTaskCheckboxClick(checkbox, event) {
          if (event) {
            event.stopPropagation();
            if (event.stopImmediatePropagation) event.stopImmediatePropagation();
          }

          const taskId = checkbox.dataset.taskId;
          const { task, project } = findTask(taskId);
          if (!task || !project) return;

          // --- Inicjalizacja ---
          let updatedTask = { ...task };
          const oldStatus = updatedTask.status;
          const currentUserId = state.currentUser.uid;
          // Definicja Override: Waciciel, Admin LUB SuperUser
          const isOverride = project.ownerId === currentUserId || (project.admins || []).includes(currentUserId) || (project.superUsers || []).includes(currentUserId);
          const isChecked = checkbox.checked; // Nowy docelowy stan checkboxa

          // --- BLOKADA 1: Podstawowe uprawnienia (Auth) ---
          if (!canUserCompleteTask(currentUserId, task, project)) {
              showNotification("Tylko przypisany, admin lub waciciel mo偶e modyfikowa to zadanie.", "Bd");
              checkbox.checked = !isChecked; // Cofnij zmian
              return;
          }

          // --- PRZENIESIONA LOGIKA: Co robimy? ---
          
          if (isChecked) {
              // --- U呕YTKOWNIK CHCE UKOCZY ZADANIE ---

              // BLOKADA 2: Zale偶noci
              const block = isTaskBlocked(task);
              if (block.blocked) {
                  showNotification(`Najpierw musisz ukoczy zadanie "${block.taskName}".`, "Bd");
                  checkbox.checked = false; // Cofnij zmian
                  return; // Przerwij
              }

              // BLOKADA 3: Podzadania (tylko dla zwykych u偶ytkownik贸w)
              const allSubtasksDone = !updatedTask.subtasks || updatedTask.subtasks.length === 0 || updatedTask.subtasks.every(s => s.isCompleted);
              if (!allSubtasksDone && !isOverride) {
                  showNotification("Nie mo偶na ukoczy zadania, dop贸ki nie zostan ukoczone wszystkie podzadania.", "Bd");
                  checkbox.checked = false; // Cofnij
                  return;
              }

              // AKCJA 1: Admin/Waciciel (Override)
              if (isOverride) {
                  updatedTask.status = 'done';
                  // Wymu ukoczenie wszystkich podzada
                  // === POPRAWKA: Usuwam warunek !allSubtasksDone ===
                  // Nawet jeli wydaj si skoczone, wymuszamy sp贸jno statusu 'done' dla wszystkich
                  updatedTask.subtasks = (updatedTask.subtasks || []).map(s => ({
                      ...s,
                      isCompleted: true,
                      status: 'done', // <-- DODANO: Jawne ustawienie statusu
                      completedBy: [...s.assignees]
                  }));

                  // Wymu ukoczenie wszystkich w zadaniu wieloosobowym
                  if (task.type === 'multi') {
                      updatedTask.completedBy = [...task.assignees];
                  }
                  
              } else {
                  // AKCJA 2: Zwyky u偶ytkownik
                  if (task.type === 'multi') {
                      // Oznacza swoj cz
                      if (!updatedTask.completedBy.includes(currentUserId)) updatedTask.completedBy.push(currentUserId);
                      
                      const allAssigneesDone = updatedTask.assignees.every(id => updatedTask.completedBy.includes(id));
                      
                      if (allAssigneesDone) {
                          updatedTask.status = 'done';
                      } else {
                          updatedTask.status = 'inprogress';
                          updatedTask = addActivity(updatedTask, 'completion'); // Loguj ukoczenie czci
                      }
                  } else {
                      // Zadanie jednoosobowe
                      updatedTask.status = 'done';
                  }
              }

          } else {
              // --- U呕YTKOWNIK CHCE COFN UKOCZENIE ZADANIA ---
              
              if (isOverride) {
                  // AKCJA 3: Admin/Waciciel cofa
                  updatedTask.status = 'todo';
                  updatedTask.completedBy = []; // Resetuj wszystkich
                  // Resetuj wszystkie podzadania
                  updatedTask.subtasks = (updatedTask.subtasks || []).map(s => ({
                      ...s,
                      isCompleted: false,
                      completedBy: []
                  }));
                  
              } else {
                  // AKCJA 4: Zwyky u偶ytkownik cofa
                  if (task.type === 'multi') {
                      updatedTask.completedBy = updatedTask.completedBy.filter(id => id !== currentUserId);
                      updatedTask.status = (oldStatus === 'done' ? 'inprogress' : oldStatus); // Wr贸 do 'inprogress'
                  } else {
                      updatedTask.status = 'todo';
                      // Resetuj podzadania
                      updatedTask.subtasks = (updatedTask.subtasks || []).map(s => ({
                          ...s,
                          isCompleted: false,
                          completedBy: []
                      }));
                  }
              }
          }

          // --- Finalizacja ---
          if (updatedTask.status !== oldStatus) {
              updatedTask = addActivity(updatedTask, 'status', STATUSES[oldStatus], STATUSES[updatedTask.status]);
          }

          if (oldStatus !== 'done' && updatedTask.status === 'done') showConfetti();
          await handleTaskCompletion(updatedTask, project);
        }
       /**
         * Obsuguje logik oddawania gosu w sonda偶u.
         * @param {string} pollId - ID dokumentu sonda偶u.
         * @param {string} optionId - ID wybranej opcji.
         * @param {string} userId - ID gosujcego u偶ytkownika.
         */
        async function handleVote(pollId, optionId, userId) {
            const poll = state.polls.find(p => p.id === pollId);
            if (!poll) {
                console.error("Nie znaleziono sonda偶u o ID:", pollId);
                showNotification("Wystpi bd, nie znaleziono sonda偶u.", "Bd");
                render(); // Odwie偶 UI, aby odblokowa przyciski
                return;
            }

            // === POCZTEK ZMIANY: NOWA LOGIKA USUWANIA I DODAWANIA GOSU ===

            // Sprawdzenie, czy u偶ytkownik gosuje na t sam opcj (teoretycznie niemo偶liwe z nowym UI, ale bezpieczne)
            // const currentVote = poll.options.find(opt => (opt.votes || []).includes(userId));
            // if (currentVote && currentVote.id === optionId) {
            //     console.warn("U偶ytkownik zagosowa na t sam opcj.");
            //     render(); // Po prostu odwie偶 widok
            //     return;
            // }

            // Tworzymy gbok kopi tablicy opcji, aby bezpiecznie j modyfikowa
            const updatedOptions = JSON.parse(JSON.stringify(poll.options));
            
            let foundOption = false;
            for (const opt of updatedOptions) {
                // KROK 1: Wyczy poprzedni gos u偶ytkownika (jeli istnieje)
                // U偶ywamy .filter(), aby stworzy now tablic bez ID tego u偶ytkownika
                opt.votes = (opt.votes || []).filter(id => id !== userId);
                
                // KROK 2: Dodaj nowy gos, jeli to jest ta kliknita opcja
                if (opt.id === optionId) {
                    opt.votes.push(userId); // Dodaj gos
                    foundOption = true;
                }
            }
            // === KONIEC ZMIANY ===

            if (!foundOption) {
                console.error("Nie znaleziono opcji o ID:", optionId);
                showNotification("Wystpi bd, wybrana opcja nie istnieje.", "Bd");
                render();
                return;
            }

            try {
                // Zapisz zaktualizowan tablic 'options' w Firestore
                const pollRef = doc(pollsRef, pollId);
                await updateDoc(pollRef, {
                    options: updatedOptions
                });
                
                // Nie musimy wywoywa render() rcznie, 
                // poniewa偶 onSnapshot (z Kroku 13) wykryje t zmian 
                // i automatycznie odwie偶y interfejs, pokazujc wyniki.
                console.log(`U偶ytkownik ${userId} zagosowa (lub zmieni gos) na opcj ${optionId} w sonda偶u ${pollId}`);

            } catch (error) {
                console.error("Bd podczas zapisywania gosu:", error);
                showNotification("Wystpi bd podczas zapisywania Twojego gosu.", "Bd");
                render(); // Rczne odwie偶enie w razie bdu zapisu
            }
        }


         kanbanBoardEl.addEventListener('click', (e) => {
            // === NOWA LOGIKA: PRZECHWYCENIE KLIKNI W TRYBIE ZAZNACZANIA ===
            if (state.ui.isSelectModeActive) {
                
                // A. Sprawd藕 czy kliknito w TRE zadania g贸wnego
                const mainContentClick = e.target.closest('.task-card-main-content');
                // B. Sprawd藕 czy kliknito w PODZADANIE
                const subtaskClick = e.target.closest('.subtask-visual-card.selectable');
                
                let targetElement = null;
                let id = null;

                if (subtaskClick) {
                    targetElement = subtaskClick;
                    id = subtaskClick.dataset.subtaskId;
                } else if (mainContentClick) {
                    // Jeli kliknito w main-content, znajd藕 rodzica .task-card, 偶eby pobra ID i przeczy klas
                    const parentCard = mainContentClick.closest('.task-card.selectable');
                    if (parentCard) {
                        targetElement = parentCard;
                        id = parentCard.dataset.taskId;
                    }
                }

                if (targetElement && id) {
                    e.preventDefault();
                    e.stopPropagation();

                    // Przecz zaznaczenie
                    targetElement.classList.toggle('selected');
                    
                    // Aktualizacja stanu
                    if (state.ui.selectedTaskIds.includes(id)) {
                        state.ui.selectedTaskIds = state.ui.selectedTaskIds.filter(eid => eid !== id);
                    } else {
                        state.ui.selectedTaskIds.push(id);
                    }
                    updateBulkActionBar();
                }
                return; 
            }
            // === KONIEC NOWEJ LOGIKI ===


            // NOWY WARUNEK: Jeli kliknicie pochodzi z listy "M贸j dzie", ignoruj je,
            // poniewa偶 ma ono sw贸j wasny, dedykowany listener.
            if (e.target.closest('.my-day-list')) {
                return;
            }

            // === NOWA LOGIKA: Sprawdzenie trigger贸w podzada ORAZ zada multi ===
            
           // ... (kod powy偶ej bez zmian, np. ignorowanie my-day-list) ...

            // 1a. IKONA PODZADA (Przeczanie widoku: Lista <-> Kafelki)
            const subtaskToggleBtn = e.target.closest('.js-toggle-subtasks');
            if (subtaskToggleBtn) {
                e.preventDefault(); 
                e.stopPropagation();
                const taskCard = subtaskToggleBtn.closest('.task-card');
                if (taskCard) {
                    // 1. Przecz wewntrzn list tekstow
                    const subtaskContainer = taskCard.querySelector('.kanban-subtask-list-container');
                    if (subtaskContainer) {
                        subtaskContainer.classList.toggle('collapsed');
                    }

                    // 2. Przecz wizualne kafelki podzada (NOWO)
                    const familyContainer = taskCard.querySelector('.subtask-family-container');
                    if (familyContainer) {
                        familyContainer.classList.toggle('collapsed');
                    }
                    
                    // 3. Zwi inne kontenery dla porzdku
                    const multiContainer = taskCard.querySelector('.kanban-multi-status-container');
                    if (multiContainer) multiContainer.classList.add('collapsed');
                    
                    const checklistContainer = taskCard.querySelector('.kanban-checklist-container');
                    if (checklistContainer) checklistContainer.classList.add('collapsed');
                }
                return; 
            }

            // 1b. IKONA STATUSU MULTI (Obsuga Zadania i Podzadania)
            const multiStatusToggleBtn = e.target.closest('.js-toggle-multi-status');
            if (multiStatusToggleBtn) {
                e.preventDefault();
                e.stopPropagation();
                
                // Sprawd藕 kontekst: Podzadanie czy Zadanie G贸wne
                const subtaskCard = multiStatusToggleBtn.closest('.subtask-visual-card');
                const taskCard = multiStatusToggleBtn.closest('.task-card');

                if (subtaskCard) {
                    // --- KLIKNITO W PODZADANIU ---
                    const multiContainer = subtaskCard.querySelector('.kanban-multi-status-container');
                    if (multiContainer) {
                        multiContainer.classList.toggle('collapsed');
                        // Zwi checklist w tym samym podzadaniu
                        const checklistContainer = subtaskCard.querySelector('.kanban-checklist-container');
                        if (checklistContainer) checklistContainer.classList.add('collapsed');
                    }
                } else if (taskCard) {
                    // --- KLIKNITO W ZADANIU GWNYM ---
                    const multiContainer = taskCard.querySelector('.kanban-multi-status-container');
                    if (multiContainer) {
                        multiContainer.classList.toggle('collapsed');
                        // Zwi inne w zadaniu g贸wnym
                        const subtaskContainer = taskCard.querySelector('.kanban-subtask-list-container');
                        if (subtaskContainer) subtaskContainer.classList.add('collapsed');
                        const checklistContainer = taskCard.querySelector('.kanban-checklist-container');
                        if (checklistContainer) checklistContainer.classList.add('collapsed');
                        
                        // Upewnij si, 偶e kafelki s widoczne (jeli lista jest zamknita) - opcjonalne, dla sp贸jnoci
                        // const familyContainer = taskCard.querySelector('.subtask-family-container');
                        // if (familyContainer) familyContainer.classList.remove('collapsed');
                    }
                }
                return;
            }
            
            // 1c. IKONA LISTY KONTROLNEJ (Obsuga Zadania i Podzadania)
            const checklistToggleBtn = e.target.closest('.js-toggle-checklist');
            if (checklistToggleBtn) {
                e.preventDefault();
                e.stopPropagation();

                // Sprawd藕 kontekst: Podzadanie czy Zadanie G贸wne
                const subtaskCard = checklistToggleBtn.closest('.subtask-visual-card');
                const taskCard = checklistToggleBtn.closest('.task-card');

                if (subtaskCard) {
                    // --- KLIKNITO W PODZADANIU ---
                    const checklistContainer = subtaskCard.querySelector('.kanban-checklist-container');
                    if (checklistContainer) {
                        checklistContainer.classList.toggle('collapsed');
                        // Zwi status multi w tym samym podzadaniu
                        const multiContainer = subtaskCard.querySelector('.kanban-multi-status-container');
                        if (multiContainer) multiContainer.classList.add('collapsed');
                    }
                } else if (taskCard) {
                    // --- KLIKNITO W ZADANIU GWNYM ---
                    const checklistContainer = taskCard.querySelector('.kanban-checklist-container');
                    if (checklistContainer) {
                        checklistContainer.classList.toggle('collapsed');
                        // Zwi inne w zadaniu g贸wnym
                        const subtaskContainer = taskCard.querySelector('.kanban-subtask-list-container');
                        if (subtaskContainer) subtaskContainer.classList.add('collapsed');
                        const multiContainer = taskCard.querySelector('.kanban-multi-status-container');
                        if (multiContainer) multiContainer.classList.add('collapsed');
                    }
                }
                return;
            }

            // 1d. PRZYCISK "Ukocz moj cz"
            const cardCompleteBtn = e.target.closest('.js-card-complete-my-part');
            if (cardCompleteBtn) {
                e.preventDefault();
                e.stopPropagation();
                const taskId = cardCompleteBtn.dataset.taskId;
                const { task, project } = findTask(taskId);
                
                if (task && project) {
                    // Blokada listy kontrolnej
                    if (task.checklist && task.checklist.length > 0) {
                        const allChecklistDone = task.checklist.every(i => i.isCompleted);
                        if (!allChecklistDone) {
                            showNotification("Nie mo偶na ukoczy Twojej czci. Ukocz najpierw wszystkie pozycje z listy kontrolnej.", "Bd");
                            return;
                        }
                    }

                    const currentUserId = state.currentUser.uid;
                    let updatedTask = { ...task };
                    const oldStatus = updatedTask.status;

                    if (!updatedTask.completedBy.includes(currentUserId)) {
                        updatedTask.completedBy.push(currentUserId);
                    }

                    if (updatedTask.subtasks && updatedTask.subtasks.length > 0) {
                        updatedTask.subtasks = updatedTask.subtasks.map(s => {
                            if (s.assignees.includes(currentUserId) && !s.completedBy.includes(currentUserId)) {
                                const newCompletedBy = [...(s.completedBy || []), currentUserId];
                                const isNowCompleted = (s.assignees.length > 0) && (s.assignees.every(id => newCompletedBy.includes(id)));
                                
                                // === POPRAWKA: Jawna aktualizacja statusu podzadania ===
                                let newSubStatus = s.status || 'todo';
                                if (isNowCompleted) {
                                    newSubStatus = 'done';
                                } else {
                                    newSubStatus = 'inprogress';
                                }
                                
                                return { 
                                    ...s, 
                                    completedBy: newCompletedBy, 
                                    isCompleted: isNowCompleted,
                                    status: newSubStatus // <-- DODANO: Zapisujemy status tekstowy
                                };
                            }
                            return s; 
                        });
                    }
                    
                    const allDone = updatedTask.assignees.every(id => updatedTask.completedBy.includes(id));
                    if (allDone) {
                        updatedTask.status = 'done';
                    } else {
                        updatedTask.status = 'inprogress';
                    }

                    if (updatedTask.status !== oldStatus) {
                         if (updatedTask.status === 'done') showConfetti();
                         updatedTask = addActivity(updatedTask, 'status', STATUSES[oldStatus], STATUSES[updatedTask.status]);
                    }
                    updatedTask = addActivity(updatedTask, 'completion');

                    handleTaskCompletion(updatedTask, project, 'manual').then(() => {
                        showNotification("Twoja cz zadania zostaa oznaczona jako wykonana.", "Sukces");
                    });
                }
                return;
            }
            // === NOWE: KLIKNICIE W IKONK (OTWIERANIE KONKRETNEJ ZAKADKI) ===
            const targetIcon = e.target.closest('.js-open-tab');
            if (targetIcon) {
                e.preventDefault();
                e.stopPropagation();
                
                const targetTab = targetIcon.dataset.tab; // np. 'comments', 'effort'
                
                // Sprawd藕 czy to Podzadanie czy Zadanie G贸wne
                const subtaskVisualCard = targetIcon.closest('.subtask-visual-card');
                const taskCard = targetIcon.closest('.task-card');

                if (subtaskVisualCard) {
                    const parentId = subtaskVisualCard.dataset.parentId;
                    const subId = subtaskVisualCard.dataset.subtaskId;
                    if (parentId && subId) {
                        openSubtaskModal(parentId, subId, targetTab); // Przekazujemy targetTab
                    }
                } else if (taskCard) {
                    const taskId = taskCard.dataset.taskId;
                    if (taskId) {
                        openTaskModal(taskId, targetTab); // Przekazujemy targetTab
                    }
                }
                return;
            }
            // === KONIEC NOWEJ LOGIKI ===
           // 2. Sprawd藕 kliknicie na CHECKBOX podzadania (wewntrz rozwinitej listy LUB kafelka wizualnego)
            const subtaskCheckbox = e.target.closest('.kanban-subtask-checkbox');
            if (subtaskCheckbox) {
                e.stopPropagation(); // Tylko zatrzymaj bbelkowanie
                
                // === NAPRAWA BDU: Bezpieczne pobieranie ID rodzica ===
                // 1. Najpierw sprawd藕, czy checkbox ma bezporednio atrybut data-parent-id
                // (Karty wizualne/standalone maj to ustawione w funkcji createVisualSubtaskCardHTML)
                let mainTaskId = subtaskCheckbox.dataset.parentId;

                // 2. Jeli nie ma (np. jest to lista tekstowa wewntrz zadania), poszukaj rodzica .task-card
                if (!mainTaskId) {
                    const parentCard = subtaskCheckbox.closest('.task-card');
                    if (parentCard) {
                        mainTaskId = parentCard.dataset.taskId;
                    }
                }
                // === KONIEC NAPRAWY ===

                if (mainTaskId) {
                    handleSubtaskToggle(subtaskCheckbox, mainTaskId);
                } else {
                    console.error("Bd: Nie znaleziono ID zadania g贸wnego dla kliknitego podzadania.");
                    showNotification("Wystpi bd struktury danych. Odwie偶 stron.", "Bd");
                }
                return; // Zakocz
            }
            
            // === NOWE: 2b. KLIKNICIE W IKONK (OTWIERANIE KONKRETNEJ ZAKADKI) ===
           
            if (targetIcon) {
                e.preventDefault();
                e.stopPropagation();
                
                const targetTab = targetIcon.dataset.tab; // np. 'comments', 'effort'
                
                // Sprawd藕 czy to Podzadanie czy Zadanie G贸wne
                const subtaskVisualCard = targetIcon.closest('.subtask-visual-card');
                const taskCard = targetIcon.closest('.task-card');

                if (subtaskVisualCard) {
                    const parentId = subtaskVisualCard.dataset.parentId;
                    const subId = subtaskVisualCard.dataset.subtaskId;
                    if (parentId && subId) {
                        openSubtaskModal(parentId, subId, targetTab); // Przekazujemy targetTab
                    }
                } else if (taskCard) {
                    const taskId = taskCard.dataset.taskId;
                    if (taskId) {
                        openTaskModal(taskId, targetTab); // Przekazujemy targetTab
                    }
                }
                return;
            }
            // === KONIEC ===
            
            // === KONIEC NOWEJ LOGIKI ===
            
            // === NOWA LOGIKA DLA DZWONKA ===
            // 3a. Sprawd藕 kliknicie na DZWONEK subskrypcji (GWNY)
            const bellBtn = e.target.closest('.task-subscription-bell');
            if (bellBtn) {
                e.preventDefault();
                e.stopPropagation();
                const taskId = bellBtn.dataset.taskId;
                const projectId = bellBtn.closest('.task-card').dataset.projectId || state.currentProjectId;
                handleTaskSubscription(taskId, projectId, bellBtn); 
                return; 
            }

            // 3b. NOWE: Sprawd藕 kliknicie na DZWONEK subskrypcji (PODZADANIE)
            const subBellBtn = e.target.closest('.subtask-subscription-bell');
            if (subBellBtn) {
                e.preventDefault();
                e.stopPropagation();
                const mainTaskId = subBellBtn.dataset.parentId;
                const subtaskId = subBellBtn.dataset.subtaskId;
                handleSubtaskSubscription(mainTaskId, subtaskId, subBellBtn);
                return;
            }
            // === KONIEC NOWEJ LOGIKI ===

            // === NOWA LOGIKA DLA POWIZANIA (ACUCH) ===
            // 4. Sprawd藕 kliknicie na ACUCH powizania
            const linkBtn = e.target.closest('.task-link-btn');
            if (linkBtn) {
                e.preventDefault();
                e.stopPropagation();
                const action = linkBtn.dataset.action;
                const taskId = linkBtn.closest('.task-card').dataset.taskId;

                if (action === 'link-task') {
                    openTaskDependencyModal(taskId);
                } else if (action === 'unlink-task') {
                    handleTaskUnlink(taskId);
                }
                return; // Zakocz
            }
            // === KONIEC NOWEJ LOGIKI ===

            // === POCZTEK NOWEGO KODU: Obsuga zwijania kolumn ===
            const collapseBtn = e.target.closest('.collapse-column-btn');
            const collapsedHeader = e.target.closest('.kanban-column.collapsed .kanban-column-header');
            
            if (collapseBtn || collapsedHeader) {
                e.preventDefault();
                e.stopPropagation();
                
                const column = (collapseBtn || collapsedHeader).closest('.kanban-column');
                
                // ZMIANA: Pobieramy identyfikator kolumny. 
                // W widoku projektu jest to logika statusu/customId.
                // W widoku Dashboardu (zmienionym w KROKU 1) wpisalimy klucz bezporednio do data-column-id.
                
                let columnIdentifier;
                
                if (state.ui.currentView === 'my-dashboard') {
                    // Dla dashboardu klucz jest wprost w data-column-id (np. 'todo', 'custom_testy')
                    columnIdentifier = column.dataset.columnId;
                } else {
                    // Dla projektu - stara logika
                    const columnStatus = column.dataset.status;
                    const columnCustomId = column.dataset.columnId === 'null' ? null : column.dataset.columnId;
                    columnIdentifier = columnStatus === 'inprogress' ? (columnCustomId || 'inprogress_null') : columnStatus;
                }
                
                // ZMIANA: Ustal kontekst (ID projektu lub 'dashboard')
                const contextId = state.currentProjectId || (state.ui.currentView === 'my-dashboard' ? 'dashboard' : null);
                
                if (!contextId || !columnIdentifier) return;

                // Zainicjuj tablic dla kontekstu, jeli nie istnieje
                if (!state.ui.collapsedColumns[contextId]) {
                    state.ui.collapsedColumns[contextId] = [];
                }
                
                const collapsedList = state.ui.collapsedColumns[contextId];
                
                if (collapsedList.includes(columnIdentifier)) {
                    // Rozwi
                    state.ui.collapsedColumns[contextId] = collapsedList.filter(id => id !== columnIdentifier);
                } else {
                    // Zwi
                    collapsedList.push(columnIdentifier);
                }
                
                saveUiState(); // Zapisz stan
                render(); // Przerenderuj tablic (dla dashboardu wywoa renderMyTasksKanban)
                return; // Zakocz
            }
            // === KONIEC NOWEGO KODU ===

            // === NOWA LOGIKA: Obsuga CHECKBOXA LISTY KONTROLNEJ (Zadania i Podzadania) ===
if (e.target.matches('.kanban-checklist-item-checkbox')) {
    // Teraz to my zatrzymujemy propagacj programowo, po wykryciu elementu
    e.stopPropagation(); 
    
    const checkbox = e.target;
    
    // Pobieramy ID. 
    // Jeli checkbox jest w zadaniu g贸wnym, ma data-task-id.
    // Jeli w podzadaniu, ma data-parent-id (rodzic) i data-subtask-id (on sam).
    const mainTaskId = checkbox.dataset.taskId || checkbox.dataset.parentId;
    const subtaskId = checkbox.dataset.subtaskId; // Undefined dla zadania g贸wnego
    const itemIndex = parseInt(checkbox.dataset.index, 10);
    const isChecked = checkbox.checked;

    const { task, project } = findTask(mainTaskId);
    
    if (task && project) {
        // Klonujemy zadanie, 偶eby edytowa kopi
        let updatedTask = { ...task };
        let modificationSuccess = false;

        if (subtaskId) {
            // --- SCENARIUSZ A: Lista w PODZADANIU ---
            if (updatedTask.subtasks) {
                updatedTask.subtasks = updatedTask.subtasks.map(sub => {
                    if (sub.id === subtaskId && sub.checklist && sub.checklist[itemIndex]) {
                        const updatedChecklist = [...sub.checklist];
                        updatedChecklist[itemIndex] = {
                            ...updatedChecklist[itemIndex],
                            isCompleted: isChecked
                        };
                        modificationSuccess = true;
                        return { ...sub, checklist: updatedChecklist };
                    }
                    return sub;
                });
            }
        } else {
            // --- SCENARIUSZ B: Lista w ZADANIU GWNYM ---
            if (updatedTask.checklist && updatedTask.checklist[itemIndex]) {
                const updatedChecklist = [...updatedTask.checklist];
                updatedChecklist[itemIndex] = { 
                    ...updatedChecklist[itemIndex], 
                    isCompleted: isChecked 
                };
                updatedTask.checklist = updatedChecklist;
                modificationSuccess = true;
            }
        }

        if (modificationSuccess) {
            // Optymistyczna wizualizacja (przekrelenie tekstu od razu)
            const textSpan = checkbox.nextElementSibling;
            if (textSpan) {
                textSpan.style.textDecoration = isChecked ? 'line-through' : 'none';
                textSpan.style.color = isChecked ? 'var(--text-secondary)' : 'var(--text-primary)';
                if (isChecked) showConfetti();
            }

            // Zapis do bazy
            const updatedTasks = project.tasks.map(t => t.id === mainTaskId ? updatedTask : t);
            const projectDocRef = findProject(project.id) ? doc(projectsRef, project.id) : doc(completedProjectsRef, project.id);
            
            updateDoc(projectDocRef, { tasks: updatedTasks }).catch(err => {
                console.error("Bd zapisu checklisty:", err);
                showNotification("Bd zapisu.", "Bd");
                checkbox.checked = !isChecked; // Cofnij w razie bdu
                // Cofnij styl
                if (textSpan) {
                     textSpan.style.textDecoration = isChecked ? 'none' : 'line-through';
                     textSpan.style.color = isChecked ? 'var(--text-primary)' : 'var(--text-secondary)';
                }
            });
        }
    }
    return; // Koniec obsugi tego kliknicia
}
// === KONIEC NOWEJ LOGIKI ===

           // 5. Sprawd藕 kliknicie na GWNY checkbox zadania
            if (e.target.matches('.task-card-checkbox')) {
                handleTaskCheckboxClick(e.target, e);
                return;
            }

            // === NOWY WARUNEK: Kliknicie na kafelek PODZADANIA (Wizualny) ===
            const subtaskVisualCard = e.target.closest('.subtask-visual-card');
            if (subtaskVisualCard) {
                // Jeli kliknito w checkbox wewntrz tego kafelka, to jest on ju偶 obsu偶ony
                // przez warunek nr 2 (.kanban-subtask-checkbox), wic tutaj ignorujemy.
                if (e.target.closest('.kanban-subtask-checkbox')) return;

                const parentId = subtaskVisualCard.dataset.parentId;
                const subId = subtaskVisualCard.dataset.subtaskId;
                
                if (parentId && subId) {
                    openSubtaskModal(parentId, subId);
                }
                return;
            }
            // === KONIEC NOWEGO WARUNKU ===
            
            // 6. Sprawd藕 kliknicie na kafelek Sonda偶u
            const pollCard = e.target.closest('.poll-card');
            if (pollCard) {
                const pollId = pollCard.dataset.pollId;
                if (pollId) {
                    openPollDetailsModal(pollId); 
                }
                return; 
            }

            // 7. Sprawd藕 kliknicie na kafelek Zadania (aby otworzy modal)
            const taskItem = e.target.closest('.task-card'); // .task-card (bez .poll-card)
            if (taskItem) {
                openTaskModal(taskItem.dataset.taskId);
                return;
            }
            
            // 8. Pozostae kliknicia (dodawanie zadania, nawigacja)
            if (e.target.closest('.add-task-icon-btn')) {
                // === POPRAWKA TUTAJ ===
                // Zmieniono wywoanie z 'openNewTaskModal(false)' na 'openNewTaskModal({})'
                openNewTaskModal({});
                // === KONIEC POPRAWKI ===
            } else if (e.target.closest('.js-project-title')) {
                const projectId = e.target.closest('.project-tile').dataset.id;
                state.currentProjectId = projectId;
                state.ui.previousView = state.ui.currentView;
                state.ui.currentView = 'projects';
                saveUiState();
                render();
            }
        });
        function renderDashboardDetailsModal(type) {
            const allMyTasks = getAllMyTasks();
            let title = '';
            let contentHTML = '';
            
            switch (type) {
                case 'show-my-overdue-details':
                    title = 'Moje Op贸藕nione Zadania';
                    const overdueTasks = getOverdueTasks(allMyTasks);
                    contentHTML = overdueTasks.length === 0 
                        ? '<p class="no-tasks-message">Brak op贸藕nionych zada. Dobra robota!</p>' 
                        : overdueTasks.map(task => createTaskCardHTML(task, true)).join('');
                    break;
                    
                case 'show-team-delays-details':
                    title = 'Op贸藕nienia w Zespole';
                    const myOwnedProjects = state.projects.filter(p => p.ownerId === state.currentUser.uid);
                    // Zadania op贸藕nione w MOICH projektach, ale przypisane do INNYCH
                    const teamOverdueTasks = myOwnedProjects.flatMap(project =>
                        (project.tasks || [])
                            .filter(t => t.status !== 'done' && t.dueDate && new Date(t.dueDate).getTime() < Date.now() && !t.assignees.includes(state.currentUser.uid))
                            .map(t => ({ ...t, projectName: project.name }))
                    ).sort((a, b) => new Date(a.dueDate).getTime() - new Date(b.dueDate).getTime()); // Sortuj od najstarszego
                    
                    contentHTML = teamOverdueTasks.length === 0 
                        ? '<p class="no-tasks-message">Brak op贸藕nie w projektach, kt贸rych jeste wacicielem.</p>' 
                        : teamOverdueTasks.map(task => createTaskCardHTML(task, true)).join('');
                    break;
                    
                case 'show-workload-details':
                    title = 'Aktywne Zadania (Do zrobienia i W trakcie)';
                    const activeTasks = allMyTasks.filter(t => t.status === 'todo' || t.status === 'inprogress');
                    
                    contentHTML = activeTasks.length === 0 
                        ? '<p class="no-tasks-message">Brak aktywnych zada.</p>' 
                        : activeTasks.map(task => createTaskCardHTML(task, true)).join('');
                    break;
                    
                case 'show-upcoming-details':
                    title = 'Nadchodzce Terminy (Dzi i Jutro)';
                    const now = new Date();
                    const endOfTomorrow = new Date();
                    endOfTomorrow.setDate(endOfTomorrow.getDate() + 2);
                    endOfTomorrow.setHours(0, 0, 0, 0); 

                    const upcomingTasks = allMyTasks
                        .filter(task => task.dueDate && task.status !== 'done' && new Date(task.dueDate) >= now && new Date(task.dueDate) < endOfTomorrow)
                        .sort((a, b) => new Date(a.dueDate).getTime() - new Date(b.dueDate).getTime());
                    
                    contentHTML = upcomingTasks.length === 0 
                        ? '<p class="no-tasks-message">Brak zada z terminem na dzi lub jutro.</p>' 
                        : upcomingTasks.map(task => createTaskCardHTML(task, true)).join('');
                    break;
                    
                case 'show-activity-details':
                    title = 'Ostatnia Aktywno Zespou';
                    const allActivities = getAllActivitiesFromMyProjects();
                    const recentActivities = allActivities
                        .filter(activity => activity.userId !== state.currentUser.uid)
                        .sort((a, b) => b.timestamp - a.timestamp)
                        .slice(0, 15);
                    
                    contentHTML = recentActivities.length === 0 
                        ? '<p class="no-tasks-message">Brak aktywnoci ze strony innych czonk贸w zespou.</p>'
                        : `<ul class="activity-list" id="dashboard-details-activity-list" style="padding-left: 0; border: none; padding-top: 0;">` +
                          recentActivities.map(activity => {
                              const user = findUser(activity.userId);
                              const userName = user ? user.name : 'Kto';
                              const dateStr = new Date(activity.timestamp).toLocaleString('pl-PL', { day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' });

                              let message = '';
                              switch (activity.type) {
                                  case 'status':
                                      message = `zmieni status zadania "<strong>${activity.taskTitle}</strong>" na ${activity.newValue}.`;
                                      break;
                                  case 'comment':
                                      message = `doda komentarz w zadaniu "<strong>${activity.taskTitle}</strong>".`;
                                      break;
                                  case 'completion':
                                      message = `ukoczy swoj cz zadania "<strong>${activity.taskTitle}</strong>".`;
                                      break;
                                  default:
                                      message = `wykona akcj w zadaniu "<strong>${activity.taskTitle}</strong>" w projekcie <em>${activity.projectName}</em>.`;
                              }
                               return `<li class="activity-item" data-task-id="${activity.taskId}" style="cursor: pointer;" title="Kliknij, aby zobaczy zadanie">
                                         [${dateStr}] <strong>${userName}</strong> ${message}
                                     </li>`;
                          }).join('') + `</ul>`;
                    
                    // U偶ywamy dashboard-detail-list tylko dla kafelk贸w zada
                    dashboardDetailsModal.content.classList.toggle(
                        'dashboard-detail-list', 
                        type !== 'show-activity-details' && 
                        type !== 'show-my-budget-details' &&
                        type !== 'show-user-budget-details' && // Upewnijmy si, 偶e ten case te偶 tu jest
                        type !== 'show-team-workload-details' // <- DODANY WARUNEK
                    );
                    break;
               // === MODYFIKACJA BLOKU CASE ===
                case 'show-team-workload-details':
                    title = 'Obci偶enie Zespou (Wsp贸lne Projekty)';
                    
                    // KROK 1: Wygeneruj HTML dla zakadek i filtr贸w
                    contentHTML = `
                        <div class="task-modal-tabs" style="padding: 0 0 16px 0; border-bottom: 1px solid var(--border-color); display: flex; justify-content: flex-start; gap: 8px;">
                            <button class="task-modal-tab active" id="workload-tab-tasks" data-view="tasks">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 18px; height: 18px;"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                                <span style="display: inline;">Obci偶enie Zadaniami</span>
                            </button>
                            <button class="task-modal-tab" id="workload-tab-hours" data-view="hours">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 18px; height: 18px;"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" /></svg>
                                <span style="display: inline;">Obci偶enie Wysikiem (Czas/Punkty)</span>
                            </button>
                        </div>

                        <div id="workload-hours-filters" style="display: block; padding: 16px 0 0 0;">
                        <label for="workload-month-filter" style="font-size: 12px; font-weight: 600; color: var(--text-secondary); margin-bottom: 4px; display: block;">Wybierz okres:</label>
                        <select id="workload-month-filter" style="width: 250px; padding: 8px; border-radius: var(--border-radius); border: 1px solid var(--border-color); background-color: var(--bg-secondary); color: var(--text-primary);">
                                <option value="all">Caociowo (wszystkie aktywne)</option>
                                </select>
                        </div>

                        <div id="team-workload-modal-chart-container" style="position: relative; width: 100%; height: 400px; margin-top: 16px;">
                            <p>adowanie wykresu...</p>
                        </div>
                    `;
                
                    // Te linie (kt贸re miae zakomentowane) usuwamy, 
                    // poniewa偶 ich waciwe miejsce jest na kocu funkcji.
                    // dashboardDetailsModal.content.innerHTML = contentHTML; // <-- USUNITE
                    // setupWorkloadModalListeners(); // <-- USUNITE
                    
                    // === DODANA LINIA ===
                    // Usuwamy klas siatki, tak jak robimy to w przypadku 'show-user-budget-details'
                    dashboardDetailsModal.content.classList.remove('dashboard-detail-list');
                    
                    break;
                // === KONIEC MODYFIKACJI BLOKU ===
                
                // +++ POCZTEK DODANEGO KODU (Krok 5.1) +++
                case 'show-my-budget-details':
                    title = 'M贸j Bud偶et (Projekty Waciciela)';
                    // Wywoujemy funkcj obliczeniow, aby pobra list projekt贸w
                    const budgetData = calculateGlobalBudgetSummary();
                    // Przekazujemy list projekt贸w do funkcji renderujcej HTML
                    contentHTML = renderDashboardBudgetDetails(budgetData.projects);
                    // Musimy specjalnie ustawi klas dla tego modala, aby usun siatk
                    dashboardDetailsModal.content.classList.remove('dashboard-detail-list');
                    break;
                // +++ KONIEC DODANEGO KODU (Krok 5.1) +++
                
                // +++ POCZTEK DODANEGO KODU (Krok 5) +++
                case 'show-user-budget-details':
                    title = 'Bud偶et - Osoby';
                    // Wywoujemy funkcj obliczeniow, kt贸ra zwraca teraz obiekt
                    const userBudgetSummary = calculateGlobalUserBudgetSummary();
                    // Przekazujemy list (userBudgetSummary.list) do funkcji renderujcej
                    contentHTML = renderDashboardUserBudgetDetails(userBudgetSummary.list);
                    // Upewniamy si, 偶e nie ma klasy 'dashboard-detail-list' (siatki)
                    dashboardDetailsModal.content.classList.remove('dashboard-detail-list');
                    break;
                // +++ KONIEC DODANEGO KODU (Krok 5) +++
            
                default:
                    return;
            }
            
            dashboardDetailsModal.title.textContent = title;
            dashboardDetailsModal.content.innerHTML = contentHTML;
            openModal(dashboardDetailsModal.overlay);

            // === NOWA LOGIKA: Rysowanie wykresu I PODPINANIE LISTENERW ===
            if (type === 'show-team-workload-details') {
                // 1. Domylnie renderuj wykres zada
                const teamWorkloadData = calculateTeamWorkload();
                // Przekazujemy kontener, do kt贸rego ma si renderowa
                // === POPRAWKA: U偶ywamy nowego, unikalnego ID ===
                renderTeamWorkloadChart(teamWorkloadData.list, 'team-workload-modal-chart-container'); 
                
                // 2. Uruchom listenery dla zakadek i filtra
                setupWorkloadModalListeners();
            }
            // === KONIEC NOWEJ LOGIKI ===
        }
        
        document.addEventListener('click', (e) => {
             const kpiCard = e.target.closest('.dashboard-card.kpi-mini-card'); 

             // KLUCZOWA ZMIANA: Sprawdzamy, czy jestemy w trybie edycji.
             const isInEditMode = document.getElementById('dashboard-grid-main')?.classList.contains('layout-edit-mode');

             // +++ POCZTEK MODYFIKACJI +++
             // Sprawd藕, czy kliknito przycisk "Szczeg贸y" WEWNTRZ kafelka
             const didClickDetailsToggle = e.target.closest('.js-toggle-budget-details');

             // Uruchom modal TYLKO jeli:
             // 1. Kliknito na kafelek (kpiCard)
             // 2. Ma on akcj (dataset.action)
             // 3. NIE jestemy w trybie edycji (!isInEditMode)
             // 4. Kliknicie NIE DOTYCZYO przycisku "Szczeg贸y" (!didClickDetailsToggle)
             if (kpiCard && kpiCard.dataset.action && !isInEditMode && !didClickDetailsToggle) { 
                 renderDashboardDetailsModal(kpiCard.dataset.action);
                 return;
             }
            
            // USUNITO: Przestarzaa obsuga kliknicia '.overdue-item-title'
            /*
            if (e.target.closest('.overdue-item-title')) {
                const item = e.target.closest('.overdue-item');
                if (item && item.dataset.taskId) {
                    openTaskModal(item.dataset.taskId);
                }
            } 
            */
            // 尖尖 DODANY NOWY WARUNEK 尖尖
            // ZMODYFIKOWANA OBSUGA KLIKNI W LIST AKTYWNOCI W MODALU
            if (e.target.closest('#dashboard-details-activity-list .activity-item')) {
                const item = e.target.closest('.activity-item');
                if (item && item.dataset.taskId) {
                     // Zamykamy modal i otwieramy zadanie
                     closeModal(dashboardDetailsModal.overlay);
                     setTimeout(() => {
                         openTaskModal(item.dataset.taskId);
                     }, 150);
                }
            }
            // 测测 KONIEC NOWEGO WARUNKU 测测
        });

        
        fabMenuToggle.addEventListener('click', () => {
            fabMenuToggle.classList.toggle('active');
            fabMenu.classList.toggle('hidden');
        });
        fabAddSpecialTask.addEventListener('click', () => openNewTaskModal({
            isSpecial: true
        }));
        
       const toggleChatPanel = () => {
            if (projectChatPanel) {
                
                // === NOWA LOGIKA: OZNACZANIA JAKO PRZECZYTANE ===
                const panelWillOpen = !projectChatPanel.classList.contains('open');
                const projectId = state.currentProjectId;
                const user = state.currentUser;

                // Jeli panel jest OTWIERANY i mamy ID projektu i u偶ytkownika
                if (panelWillOpen && projectId && user) {
                    const lastViewed = (user.chatLastViewed && user.chatLastViewed[projectId]) || 0;
                    const now = Date.now();

                    // Aktualizuj timestamp tylko jeli faktycznie s nowe wiadomoci
                    // lub jeli ostatni odczyt by dawno (np. > 10 sekund temu), 
                    // aby unikn wielu zapis贸w do bazy przy szybkim klikaniu.
                    if (now - lastViewed > 10000) { 
                        
                        // 1. Aktualizacja optymistyczna (natychmiastowe UI)
                        if (state.currentUser.chatLastViewed) {
                            state.currentUser.chatLastViewed[projectId] = now;
                        } else {
                            state.currentUser.chatLastViewed = { [projectId]: now };
                        }
                        updateChatBadge(0); // Natychmiast ukryj badge

                        // 2. Zapis w tle do Firestore
                        const userRef = doc(usersRef, user.uid);
                        // U偶ywamy notacji kropkowej do aktualizacji pola w mapie
                        updateDoc(userRef, {
                            [`chatLastViewed.${projectId}`]: now
                        }).catch(err => {
                            console.error("Bd zapisu 'chatLastViewed':", err);
                        });
                    }
                }
                // === KONIEC NOWEJ LOGIKI ===
                
                projectChatPanel.classList.toggle('open');
            }
        };
        
        if (toggleChatBtn) {
            toggleChatBtn.addEventListener('click', toggleChatPanel);
        }
        if (toggleChatBtnMobile) {
            toggleChatBtnMobile.addEventListener('click', toggleChatPanel);
        }
        if (closeChatPanelBtn) {
            closeChatPanelBtn.addEventListener('click', toggleChatPanel);
        }
        // === KONIEC NOWYCH LISTENERW ===
        
       // NOWY LISTENER: Przycisk "Nowe zadanie" (niebieski) wewntrz menu
        fabActionNewTask.addEventListener('click', () => {
            // Wykonuje oryginaln akcj niebieskiego przycisku
            openNewTaskModal({ isFab: true, isSpecial: false });
            
            // Zamyka menu po wybraniu akcji
            fabMenuToggle.classList.remove('active');
            fabMenu.classList.add('hidden');
        });
       // === NOWA FUNKCJA I LISTENERY DO WYSYANIA WIADOMOCI CZATU ===

        /**
         * Asynchroniczna funkcja do wysyania wiadomoci czatu.
         */
       /**
         * NOWA FUNKCJA POMOCNICZA
         * Bezpiecznie zamyka panel czatu, jeli jest otwarty.
         */
        function closeChatPanel() {
            if (projectChatPanel && projectChatPanel.classList.contains('open')) {
                // U偶ywamy toggleChatPanel(), poniewa偶 zawiera ona logik
                // aktualizacji 'chatLastViewed', kt贸ra powinna si wykona
                // nawet przy automatycznym zamkniciu.
                // toggleChatPanel();
                
                // POPRAWKA: U偶ycie toggleChatPanel() jest ryzykowne,
                // poniewa偶 mo偶e nieoczekiwanie otworzy panel.
                // Bezpieczniej jest rcznie usun klas.
                projectChatPanel.classList.remove('open');
                
                // Zaktualizuj r贸wnie偶 stan ikony (jeli istnieje)
                if (toggleChatBtn) toggleChatBtn.classList.remove('has-unread');
                if (toggleChatBtnMobile) toggleChatBtnMobile.classList.remove('has-unread');
            }
        }

        /**
         * Asynchroniczna funkcja do wysyania wiadomoci czatu.
         */
        async function handleSendChatMessage() {
            const text = chatMessageInput.value.trim();
            const projectId = state.currentProjectId;
            const user = state.currentUser;

            // Walidacja
            if (!text || !projectId || !user) {
                return;
            }

            // Zablokuj UI
            chatMessageInput.disabled = true;
            sendChatMessageBtn.disabled = true;

            // Przygotuj obiekt wiadomoci
            const messageData = {
                text: text,
                senderId: user.uid,
                senderName: user.name || user.email,
                senderAvatar: user.photoURL || null, // Przechowujemy URL zdjcia
                timestamp: Date.now()
            };

            try {
                // Zdefiniuj cie偶k i dodaj dokument
                const chatCollectionRef = collection(db, `artifacts/${appId}/public/data/projectChats/${projectId}/messages`);
                await addDoc(chatCollectionRef, messageData);
                
                // Wyczy input (onSnapshot zajmie si renderowaniem)
                chatMessageInput.value = '';
                chatMessageInput.style.height = 'auto'; // Reset wysokoci textarea

            } catch (error) {
                console.error("Bd podczas wysyania wiadomoci czatu:", error);
                showNotification("Nie udao si wysa wiadomoci.", "Bd");
            } finally {
                // Odblokuj UI
                chatMessageInput.disabled = false;
                sendChatMessageBtn.disabled = false;
                chatMessageInput.focus();
            }
        }

        // Listener dla przycisku "Wylij"
        if (sendChatMessageBtn) {
            sendChatMessageBtn.addEventListener('click', handleSendChatMessage);
        }

        // Listener dla klawisza "Enter" w textarea
        if (chatMessageInput) {
            chatMessageInput.addEventListener('keydown', (e) => {
                // Wylij na "Enter", zr贸b now lini na "Shift + Enter"
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault(); // Zapobiegnij dodaniu nowej linii
                    handleSendChatMessage();
                }
            });
            
            // Auto-rozszerzanie textarea
            chatMessageInput.addEventListener('input', () => {
                chatMessageInput.style.height = 'auto'; // Zresetuj wysoko
                chatMessageInput.style.height = (chatMessageInput.scrollHeight) + 'px'; // Ustaw now wysoko
            });
        }
       // === NOWE LISTENERY DLA ZAMYKANIA GESTEM (MOBILE) ===
        if (projectChatPanel) {
            // U偶ywamy { passive: false } aby m贸c wywoa e.preventDefault() w 'touchmove'
            projectChatPanel.addEventListener('touchstart', handleChatTouchStart, { passive: false });
            projectChatPanel.addEventListener('touchmove', handleChatTouchMove, { passive: false });
            projectChatPanel.addEventListener('touchend', handleChatTouchEnd);
            projectChatPanel.addEventListener('touchcancel', handleChatTouchEnd); // Na wypadek przerwania gestu
        }

        // === POCZTEK ZMIANY: Dodanie listener贸w gest贸w dla panelu AI ===
        if (aiHelpModal.sidebar) {
            aiHelpModal.sidebar.addEventListener('touchstart', handleAiChatTouchStart, { passive: false });
            aiHelpModal.sidebar.addEventListener('touchmove', handleAiChatTouchMove, { passive: false });
            aiHelpModal.sidebar.addEventListener('touchend', handleAiChatTouchEnd);
            aiHelpModal.sidebar.addEventListener('touchcancel', handleAiChatTouchEnd);
        }
        // === KONIEC ZMIANY ===

        // === KONIEC NOWYCH LISTENERW ===
        // === KONIEC NOWEJ LOGIKI WYSYANIA ===
        /**
         * NOWA FUNKCJA
         * Aktualizuje wygld ikon czatu (desktop i mobile) na podstawie liczby nieprzeczytanych wiadomoci.
         * @param {number} count - Liczba nieprzeczytanych wiadomoci.
         */
        function updateChatBadge(count) {
            // Znajd藕 oba przyciski czatu
            const buttons = [
                document.getElementById('toggle-chat-btn'),
                document.getElementById('toggle-chat-btn-mobile')
            ];

            buttons.forEach(btn => {
                if (!btn) return;
                
                const badge = btn.querySelector('.notification-badge');
                if (!badge) return;

                if (count > 0) {
                    badge.textContent = count > 9 ? '9+' : count;
                    badge.style.display = 'flex';
                    btn.classList.add('has-unread'); // Dodaje klas do pokolorowania ikony
                } else {
                    badge.style.display = 'none';
                    btn.classList.remove('has-unread'); // Usuwa kolor
                }
            });
        }
           // === NOWE FUNKCJE OBSUGI GESTU ZAMYKANIA CZATU ===
        
        /**
         * Rozpoczyna ledzenie gestu przesunicia na panelu czatu.
         */
        function handleChatTouchStart(e) {
            // Interesuje nas tylko pierwszy palec
            const touch = e.touches[0];
            chatTouchStartX = touch.clientX;
            chatTouchStartY = touch.clientY;
            chatTouchCurrentX = touch.clientX; // Resetuj pozycj bie偶c
            isChatSwiping = true; // Rozpocznij ledzenie
            
            // Usuwamy tymczasowo transition, aby panel pod偶a za palcem pynnie
            projectChatPanel.style.transition = 'none';
        }

        /**
         * Obsuguje przesuwanie palca po panelu czatu.
         */
        function handleChatTouchMove(e) {
            if (!isChatSwiping) return;

            const touch = e.touches[0];
            chatTouchCurrentX = touch.clientX;
            
            const deltaX = chatTouchCurrentX - chatTouchStartX;
            const deltaY = touch.clientY - chatTouchStartY;

            // WARUNEK 1: Sprawd藕, czy u偶ytkownik nie scrolluje w pionie
            // Jeli ruch pionowy jest wikszy ni偶 poziomy (z buforem 10px), anuluj gest swipe
            if (Math.abs(deltaY) > (Math.abs(deltaX) + 10)) {
                isChatSwiping = false;
                // Przywr贸 panel na miejsce, jeli ju偶 si ruszy
                projectChatPanel.style.transform = ''; 
                return;
            }
            
            // WARUNEK 2: Pozw贸l tylko na ruch W PRAWO (zamykanie)
            if (deltaX < 0) {
                isChatSwiping = false;
                projectChatPanel.style.transform = '';
                return;
            }

            // Zapobiegaj domylnej akcji przegldarki (np. scrollowaniu strony)
            // podczas gdy my aktywnie przesuwamy panel
            e.preventDefault();
            
            // Aktualizuj pozycj panelu, aby pod偶a za palcem
            projectChatPanel.style.transform = `translateX(${deltaX}px)`;
        }

        /**
         * Koczy gest przesunicia i decyduje, czy zamkn panel.
         */
        function handleChatTouchEnd(e) {
            if (!isChatSwiping) return;
            isChatSwiping = false;

            const deltaX = chatTouchCurrentX - chatTouchStartX;
            const panelWidth = projectChatPanel.offsetWidth;
            
            // Ustaw pr贸g: 30% szerokoci panelu lub minimum 100px
            const threshold = Math.max(panelWidth * 0.3, 100);

            // Przywr贸 animacj CSS
            projectChatPanel.style.transition = 'transform 0.3s ease-in-out';

            if (deltaX > threshold) {
                // Przesunito wystarczajco daleko -> ZAMKNIJ
                // Wywoujemy istniejc funkcj zamykajc, kt贸ra usunie klas .open
                toggleChatPanel(); 
                projectChatPanel.style.transform = ''; 
            } else {
                // Niewystarczajce przesunicie -> WR
                // Resetujemy transform, klasa .open (kt贸ra wci偶 tam jest) przywr贸ci go na miejsce
                projectChatPanel.style.transform = '';
            }

            // === POCZTEK NOWEJ POPRAWKI (FIX DLA :HOVER) ===
            // Niezale偶nie od tego, czy panel si zamkn, czy wr贸ci,
            // usuwamy fokus z panelu (kt贸ry by dotykany) ORAZ
            // z przycisk贸w, aby zresetowa "lepki" :hover na mobile.
            if (projectChatPanel) {
                projectChatPanel.blur();
            }
            const buttons = [
                document.getElementById('toggle-chat-btn'),
                document.getElementById('toggle-chat-btn-mobile')
            ];
            buttons.forEach(btn => {
                if (btn) {
                    btn.blur();
                }
            });
            // === KONIEC NOWEJ POPRAWKI ===
        }

        // === KONIEC NOWYCH FUNKCJI CZATU ===
       // === POCZTEK ZMIANY: Funkcje obsugi gestu przesuwania dla panelu AI ===
        
        /**
         * Rozpoczyna ledzenie gestu przesunicia na panelu AI.
         */
        function handleAiChatTouchStart(e) {
            const touch = e.touches[0];
            aiChatTouchStartX = touch.clientX;
            aiChatTouchStartY = touch.clientY;
            aiChatTouchCurrentX = touch.clientX;
            isAiChatSwiping = true;
            aiHelpModal.sidebar.style.transition = 'none';
        }

        /**
         * Obsuguje przesuwanie palca po panelu AI.
         */
        function handleAiChatTouchMove(e) {
            if (!isAiChatSwiping) return;

            const touch = e.touches[0];
            aiChatTouchCurrentX = touch.clientX;
            
            const deltaX = aiChatTouchCurrentX - aiChatTouchStartX;
            const deltaY = touch.clientY - aiChatTouchStartY;

            if (Math.abs(deltaY) > (Math.abs(deltaX) + 10)) {
                isAiChatSwiping = false;
                aiHelpModal.sidebar.style.transform = ''; 
                return;
            }
            
            if (deltaX < 0) {
                isAiChatSwiping = false;
                aiHelpModal.sidebar.style.transform = '';
                return;
            }

            e.preventDefault();
            aiHelpModal.sidebar.style.transform = `translateX(${deltaX}px)`;
        }

        /**
         * Koczy gest przesunicia i decyduje, czy zamkn panel AI.
         */
        function handleAiChatTouchEnd(e) {
            if (!isAiChatSwiping) return;
            isAiChatSwiping = false;

            const deltaX = aiChatTouchCurrentX - aiChatTouchStartX;
            const panelWidth = aiHelpModal.sidebar.offsetWidth;
            const threshold = Math.max(panelWidth * 0.3, 100);

            aiHelpModal.sidebar.style.transition = 'transform 0.3s ease-in-out, visibility 0.3s';

            if (deltaX > threshold) {
                // Przesunito wystarczajco daleko -> ZAMKNIJ
                toggleAiChatPanel(); // U偶ywamy nowej funkcji
                aiHelpModal.sidebar.style.transform = ''; 
            } else {
                // Niewystarczajce przesunicie -> WR
                aiHelpModal.sidebar.style.transform = '';
            }

            // Reset :hover
            if (aiHelpModal.sidebar) {
                aiHelpModal.sidebar.blur();
            }
            if (aiHelpModal.openBtn) {
                aiHelpModal.openBtn.blur();
            }
        }
        // === KONIEC ZMIANY ===
        // ZMODYFIKOWANY LISTENER: Przycisk "Nowy sonda偶" (zielony) wewntrz menu
        fabActionNewPoll.addEventListener('click', () => {
            // Wywouje now funkcj otwierajc modal sonda偶u
            openNewPollModal();

            // Zamyka menu po wybraniu akcji
            fabMenuToggle.classList.remove('active');
            fabMenu.classList.add('hidden');
        });
       // === NOWE LISTENERY DLA OPCJI SONDAR呕U ===
        
        // Listener dla przycisku "+ Dodaj opcj"
        newPollModal.addOptionBtn.addEventListener('click', () => {
            // Po prostu dodaje nowy, pusty wiersz opcji na koniec listy
            newPollModal.optionsList.insertAdjacentHTML('beforeend', renderPollOptionHTML());
            // Ustawia fokus na nowo dodanym polu tekstowym
            const newInputs = newPollModal.optionsList.querySelectorAll('.new-poll-option-input');
            if (newInputs.length > 0) {
                newInputs[newInputs.length - 1].focus();
            }
        });

        // Delegowany listener dla usuwania opcji (przycisk "x")
        newPollModal.optionsList.addEventListener('click', (e) => {
            const deleteBtn = e.target.closest('.delete-poll-option-btn');
            if (!deleteBtn) return; // Kliknito gdzie indziej

            const itemToRemove = deleteBtn.closest('li.poll-option-item');
            
            // Zabezpieczenie: Nie pozw贸l usun wszystkich opcji. Zawsze zostaw przynajmniej jedn.
            if (newPollModal.optionsList.querySelectorAll('li.poll-option-item').length > 1) {
                if (itemToRemove) {
                    itemToRemove.remove();
                }
            } else {
                showNotification("Sonda偶 musi mie przynajmniej jedn opcj.", "Bd");
            }
        });
        // === KONIEC NOWYCH LISTENERW ===
       // NOWY LISTENER (CHANGE): Obsuga wyboru pliku dla opcji sonda偶u
        newPollModal.optionsList.addEventListener('change', (e) => {
            const fileInput = e.target.closest('.new-poll-option-file');
            if (!fileInput) return; // Zdarzenie 'change' pochodzio skdind

            const optionItem = fileInput.closest('li.poll-option-item');
            if (!optionItem) return;

            const fileNameSpan = optionItem.querySelector('.poll-option-file-name');
            if (fileInput.files && fileInput.files.length > 0) {
                // Wybrano plik
                fileNameSpan.textContent = fileInput.files[0].name;
                fileNameSpan.style.color = 'var(--accent-primary)';
            } else {
                // Anulowano wyb贸r pliku
                fileNameSpan.textContent = 'Brak pliku';
                fileNameSpan.style.color = 'var(--text-secondary)';
            }
        });
        // === KONIEC NOWYCH LISTENERW ===
       // === NOWY LISTENER: ZAPIS SONDAR呕U DO FIRESTORE ===
        newPollModal.form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const submitBtn = e.target.querySelector('button[type="submit"]');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Tworzenie...';

            try {
                // 1. Walidacja i zbieranie danych
                const title = newPollModal.titleInput.value.trim();
                
                // === NOWA LINIA ===
                const description = document.getElementById('new-poll-description').value.trim() || null;
                
                const deadline = newPollModal.deadlineInput.value || null;
                const projectId = newPollModal.overlay.dataset.projectId;
                const project = findProject(projectId); // Pobieramy dane projektu

                if (!title) {
                    throw new Error("Tytu sonda偶u jest wymagany.");
                }
                if (!project) {
                    throw new Error("Nie mo偶na znale藕 projektu. Odwie偶 stron.");
                }

                // 2. Zbieranie opcji (NOWA LOGIKA z uploadem plik贸w)
                
                // Krok 2a: Zbierz wszystkie elementy <li> opcji
                const optionItems = Array.from(newPollModal.optionsList.querySelectorAll('li.poll-option-item'));
                
                // Krok 2b: Przygotuj tablic obietnic (Promises) do uploadu
                const uploadPromises = optionItems.map(async (item, index) => {
                    const textInput = item.querySelector('.new-poll-option-input');
                    const fileInput = item.querySelector('.new-poll-option-file');
                    
                    const text = textInput ? textInput.value.trim() : '';
                    const file = fileInput && fileInput.files.length > 0 ? fileInput.files[0] : null;

                    // Jeli nie ma ani tekstu, ani pliku, zwr贸 null
                    if (!text && !file) return null; 

                    let attachmentData = null;

                    // Krok 2c: Jeli jest plik, przelij go
                    if (file) {
                        const storagePath = `poll_attachments/${projectId}/${Date.now()}_${file.name}`;
                        const storageRef = ref(storage, storagePath);
                        
                        // Przesyanie
                        console.log(`Przesyanie pliku dla opcji ${index}: ${file.name}`);
                        const snapshot = await uploadBytes(storageRef, file);
                        // Pobieranie URL
                        const downloadURL = await getDownloadURL(snapshot.ref);
                        
                        attachmentData = {
                            url: downloadURL,
                            path: storagePath
                        };
                    }
                    
                    // Zwr贸 gotowy obiekt opcji
                    return {
                        id: `opt_${Date.now()}_${index}`,
                        text: text || file.name, // U偶yj nazwy pliku jako tekstu, jeli tekst jest pusty
                        attachment: attachmentData,
                        votes: []
                    };
                });

                // Krok 2d: Poczekaj, a偶 wszystkie pliki si przel
                submitBtn.textContent = 'Przetwarzanie plik贸w...';
                const uploadedOptions = await Promise.all(uploadPromises);

                // Krok 2e: Odfiltruj puste opcje (te, kt贸re zwr贸ciy null)
                const options = uploadedOptions.filter(Boolean); // 'Boolean' usunie wszystkie wartoci null/undefined

                if (options.length < 2) {
                     throw new Error("Sonda偶 musi mie przynajmniej dwie niepuste opcje.");
                }

                // 3. Zbieranie uczestnik贸w
                const assignees = Array.from(newPollModal.assigneesContainer.querySelectorAll('.member-pill.selected'))
                    .map(pill => pill.dataset.userId);
                
                if (assignees.length === 0) {
                    throw new Error("Sonda偶 musi mie przynajmniej jednego uczestnika.");
                }

                // 4. Budowanie obiektu sonda偶u
                const newPollData = {
                    projectId: projectId,
                    groupId: state.ui.activeGroupId, // Dodajemy groupId dla listener贸w
                    title: title,
                    description: description, // <-- DODANA TA LINIA
                    options: options, // Tablica obiekt贸w z ID, text, votes
                    assignees: assignees,
                    deadline: deadline,
                    createdBy: state.currentUser.uid,
                    createdAt: Date.now(),
                    status: 'open' // Domylny status
                };

                // 5. Zapis sonda偶u do Firestore
                const newPollRef = await addDoc(pollsRef, newPollData);
                console.log("Sonda偶 pomylnie zapisany z ID:", newPollRef.id);

                // 6. Przygotowanie i wysanie powiadomie
                // U偶ywamy sendInternalNotification z kluczem 'polls'
                sendInternalNotification(
                    assignees,
                    'poll_invite',
                    `<strong>${state.currentUser.name}</strong> zaprasza Ci do udziau w sonda偶u "<strong>${title}</strong>" w projekcie <em>${project.name}</em>.`,
                    { type: 'poll', projectId: projectId, pollId: newPollRef.id },
                    'polls' // <--- KLUCZ USTAWIENIA
                );
                console.log(`Wysano powiadomienia o sonda偶u do ${assignees.length - 1} u偶ytkownik贸w.`);
                // === KONIEC RZECZYWISTEGO ZAPISU ===

                closeModal(newPollModal.overlay);

            } catch (error) {
                console.error("Bd walidacji lub zapisu sonda偶u:", error);
                showNotification(error.message, "Bd");
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Utw贸rz sonda偶';
            }
        });
       // === NOWY LISTENER: Obsuga gosowania WEWNTRZ modala szczeg贸贸w sonda偶u ===
        pollDetailsModal.content.addEventListener('click', (e) => {
            const voteBtn = e.target.closest('.poll-vote-btn');
            if (voteBtn) {
                const pollId = voteBtn.dataset.pollId;
                const optionId = voteBtn.dataset.optionId;
                const currentUserId = state.currentUser.uid;

                // Natychmiastowy feedback: wycz przyciski w modalu
                pollDetailsModal.content.querySelectorAll('.poll-vote-btn').forEach(btn => {
                    btn.disabled = true;
                    btn.textContent = 'Gosowanie...';
                });

                // Wywoaj funkcj handleVote (stworzon w Kroku 15), aby zapisa gos
                // Funkcja handleVote (z pliku .790.html) automatycznie odwie偶y widok (dziki onSnapshot)
                handleVote(pollId, optionId, currentUserId);
                
                // onSnapshot odwie偶y tablic KANBAN, ale musimy te偶 odwie偶y otwarty MODAL
                // Robimy to z maym op贸藕nieniem, aby da czas na zapis w bazie.
                setTimeout(() => {
                    // Sprawd藕, czy modal jest nadal otwarty
                    if (pollDetailsModal.overlay.classList.contains('visible')) {
                        // Pobierz NAJNOWSZE dane sonda偶u ze stanu (kt贸ry zosta zaktualizowany przez onSnapshot)
                        const freshPoll = state.polls.find(p => p.id === pollId);
                        if (freshPoll) {
                            // Ponownie wyrenderuj zawarto modala, ale tym razem poka偶e wyniki
                            openPollDetailsModal(pollId);
                        } else {
                            // Sonda偶 m贸g zosta usunity w midzyczasie, zamknij modal
                            closeModal(pollDetailsModal.overlay);
                        }
                    }
                }, 1000); // 1 sekunda op贸藕nienia
            }
        });
        // === KONIEC NOWEGO LISTENERA ===
       // === NOWY LISTENER: Obsuga przycisku "Zmie gos" w modalu ===
        pollDetailsModal.changeVoteBtn.addEventListener('click', (e) => {
            const pollId = e.target.dataset.pollId;
            if (!pollId) {
                console.error("Brak pollId na przycisku zmiany gosu.");
                return;
            }
            
            const poll = state.polls.find(p => p.id === pollId);
            if (!poll) {
                console.error("Nie znaleziono sonda偶u do zmiany gosu, ID:", pollId);
                return;
            }

            // 1. Ponownie wyrenderuj UI gosowania (przyciski)
            // U偶yj nowej funkcji pomocniczej
            pollDetailsModal.content.innerHTML = renderPollVotingUI(poll);

            // 2. Ukryj sam przycisk "Zmie gos", poniewa偶 jestemy teraz w trybie gosowania
            pollDetailsModal.changeVoteBtn.style.display = 'none';
        });
        // === KONIEC NOWEGO LISTENERA ===
        // === KONIEC LISTENERA SONDAR呕U ===
       // === NOWY LISTENER: Obsuga przycisku "Zakocz sonda偶" w modalu ===
        pollDetailsModal.closePollBtn.addEventListener('click', (e) => {
            const pollId = e.target.dataset.pollId;
            if (!pollId) return;

            const poll = state.polls.find(p => p.id === pollId);
            if (!poll) return;

            showConfirmation(
                "Zakoczy sonda偶?",
                `Czy na pewno chcesz zamkn sonda偶 "${poll.title}"? Po tej akcji nikt ju偶 nie bdzie m贸g odda gosu.`,
                async (confirmed) => {
                    if (confirmed) {
                        e.target.disabled = true;
                        e.target.textContent = 'Zamykanie...';
                        
                        try {
                            const pollRef = doc(pollsRef, pollId);
                            // Zmieniamy status sonda偶u na "closed"
                            await updateDoc(pollRef, {
                                status: 'closed'
                            });
                            // === NOWA LOGIKA: Powiadomienie o wynikach ===
                            if (poll.assignees && poll.assignees.length > 0) {
                                const msg = `Sonda偶 "<strong>${poll.title}</strong>" zosta zakoczony. Sprawd藕 wyniki.`;
                                sendInternalNotification(
                                    poll.assignees,
                                    'poll_invite', 
                                    msg,
                                    { type: 'poll', projectId: poll.projectId, pollId: pollId },
                                    'polls' // <--- KLUCZ USTAWIENIA
                                );
                            }
                            // === KONIEC LOGIKI ===
                            showNotification("Sonda偶 zosta zamknity.", "Sukces");
                            closeModal(pollDetailsModal.overlay);
                            // Nie musimy wywoywa render(), 
                            // onSnapshot (z Kroku 13) wykryje zmian i automatycznie usunie kafelek z tablicy.
                            
                        } catch (error) {
                            console.error("Bd podczas zamykania sonda偶u:", error);
                            showNotification("Wystpi bd.", "Bd");
                        } finally {
                            // Reset przycisku (cho modal jest zamykany, dobra praktyka)
                            e.target.disabled = false;
                            e.target.textContent = 'Zakocz sonda偶';
                        }
                    }
                },
                true // U偶yj czerwonego przycisku
            );
        });
        // === KONIEC NOWEGO LISTENERA ===
       // === NOWY LISTENER: Obsuga przycisku "Usu sonda偶" w modalu ===
        pollDetailsModal.deletePollBtn.addEventListener('click', (e) => {
            const pollId = e.target.dataset.pollId;
            if (!pollId) return;

            const poll = state.polls.find(p => p.id === pollId);
            if (!poll) return;

            // U偶yj tej samej funkcji potwierdzajcej
            showConfirmation(
                "Trwale usun sonda偶?",
                `Czy na pewno chcesz usun sonda偶 "${poll.title}"? Tej operacji nie mo偶na cofn.`,
                async (confirmed) => {
                    if (confirmed) {
                        try {
                            const pollRef = doc(pollsRef, pollId);
                            // Usu dokument sonda偶u z Firestore
                            await deleteDoc(pollRef);
                            
                            showNotification("Sonda偶 zosta usunity.", "Sukces");
                            closeModal(pollDetailsModal.overlay);
                            // Nie musimy wywoywa render(), 
                            // onSnapshot (z Kroku 13) wykryje usunicie i automatycznie odwie偶y tablic Kanban.
                            
                        } catch (error) {
                            console.error("Bd podczas usuwania sonda偶u:", error);
                            showNotification("Wystpi bd podczas usuwania sonda偶u.", "Bd");
                        }
                    }
                },
                true // U偶yj czerwonego przycisku
            );
        });
        // === KONIEC NOWEGO LISTENERA ===
        document.querySelectorAll('.modal-overlay').forEach(overlay => {
            overlay.addEventListener('click', e => {
                if (e.target === overlay || e.target.closest('.modal-close-btn')) {
                    Array.from(overlay.querySelectorAll('select, textarea, input')).forEach(el => el.disabled = false);
                    closeModal(overlay);
                }
            });
        });
        document.getElementById('task-modal').addEventListener('click', (e) => {
            const tabButton = e.target.closest('.task-modal-tab');
            if (!tabButton) return;
        
            const tabName = tabButton.dataset.tab;
            const modal = tabButton.closest('.modal');
        
            // Ukryj wszystkie panele i deaktywuj wszystkie przyciski zakadek
            modal.querySelectorAll('.task-modal-tab-content').forEach(content => content.classList.remove('active'));
            modal.querySelectorAll('.task-modal-tab').forEach(tab => tab.classList.remove('active'));
        
            // Poka偶 wybrany panel i aktywuj jego przycisk
            const activeContent = modal.querySelector(`#tab-content-${tabName}`);
            if (activeContent) {
                activeContent.classList.add('active');
            }
            tabButton.classList.add('active');
        });
        // NOWY LISTENER: Logika przeczania zakadek dla modala dodawania nowego zadania
        document.getElementById('new-task-modal').addEventListener('click', (e) => {
            const tabButton = e.target.closest('.task-modal-tab');
            if (!tabButton) return;
        
            const tabName = tabButton.dataset.tab;
            const modal = tabButton.closest('.modal');
        
            // Ukryj wszystkie panele i deaktywuj wszystkie przyciski zakadek
            modal.querySelectorAll('.task-modal-tabs-content .task-modal-tab-content').forEach(content => content.classList.remove('active'));
            modal.querySelectorAll('.task-modal-tab').forEach(tab => tab.classList.remove('active'));
        
            // Poka偶 wybrany panel i aktywuj jego przycisk
            // UWAGA: U偶ywamy prefiksu "tab-new-task-" dla ID sekcji w nowym modalu
            const activeContent = modal.querySelector(`#tab-new-task-${tabName}`);
            if (activeContent) {
                activeContent.classList.add('active');
            }
            tabButton.classList.add('active');
        });
        taskModal.saveBtn.addEventListener('click', saveTaskFromModal);

        taskModal.addCommentBtn.addEventListener('click', async () => {
            const taskId = taskModal.overlay.dataset.taskId;
            const commentText = taskModal.newCommentText.value.trim();
            if (!commentText) return;

            const {
                task,
                project
            } = findTask(taskId);
            if (!task || !project) return;
            if (task.createdBy && task.createdBy === state.currentUser.uid) {
                taskModal.deleteBtn.style.display = 'block';
            } else {
                taskModal.deleteBtn.style.display = 'none';
            }

            const newComment = {
                id: `comment_${Date.now()}`,
                userId: state.currentUser.uid,
                text: commentText,
                timestamp: Date.now(),
            };

            let updatedTask = { ...task,
                comments: [...(task.comments || []), newComment]
            };
            updatedTask = addActivity(updatedTask, 'comment');
            const projectDocRef = findProject(project.id) ? doc(projectsRef, project.id) : doc(completedProjectsRef, project.id);
            const updatedTasks = project.tasks.map(t => (t.id === taskId ? updatedTask : t));

            await updateDoc(projectDocRef, {
                tasks: updatedTasks
            });

            // === NOWA LOGIKA POWIADOMIE O WZMIANKACH (TRIBUTE.JS) ===
            
            // 1. U偶yj wyra偶enia regularnego, aby znale藕 wszystkie wzmianki w formacie @NazwaBezSpacji
            const mentionRegex = /@([a-zA-Z0-9]+)/g;
            const matches = commentText.match(mentionRegex); // Np. ["@JanKowalski", "@AnnaNowak"]
            
            const usersToNotify = [];
            
            if (matches) {
                // 2. Pobierz unikalne nazwy (bez @)
                const mentionedValues = [...new Set(matches.map(mention => mention.substring(1)))]; // Np. ["JanKowalski", "AnnaNowak"]
                
                // 3. Znajd藕 u偶ytkownik贸w, kt贸rzy pasuj do tych nazw
                mentionedValues.forEach(value => {
                const foundUser = state.users.find(user => 
                    user.id !== state.currentUser.uid && 
                    (user.name || user.email).replace(/[^a-zA-Z0-9]/g, '') === value // <-- NOWA ZMIANA
                );
                
                if (foundUser) {
                        usersToNotify.push(foundUser);
                    }
                });
            }

            // 4. Logika tworzenia powiadomie (batch) pozostaje taka sama
            if (usersToNotify.length > 0) {
                const batch = writeBatch(db);
                    const notificationsRef = collection(db, `artifacts/${appId}/public/data/notifications`);

                    // Zastpujemy stary batch nasz now funkcj pomocnicz
                    // 1. Pobieramy same ID odbiorc贸w (wykluczajc siebie)
                    const recipientIds = usersToNotify
                        .filter(u => u.id !== state.currentUser.uid)
                        .map(u => u.id);
                    
                    if (recipientIds.length > 0) {
                         const msg = `<strong>${state.currentUser.name}</strong> wspomnia/a o Tobie w komentarzu w zadaniu "<strong>${task.title}</strong>".`;
                         
                         // 2. Wysyamy powiadomienie z kluczem 'task_mention'
                         sendInternalNotification(
                            recipientIds,
                            'mention',
                            msg,
                            { type: 'task', projectId: project.id, taskId: task.id },
                            'task_mention' // <--- NOWY KLUCZ USTAWIENIA
                         );
                    }
                } // Koniec bloku if (usersToNotify.length > 0)
            // POPRAWKA: Usunito zbdn klamr zamykajc, kt贸ra bya tutaj.
            // === KONIEC NOWEJ LOGIKI ===

            taskModal.newCommentText.value = '';
            // Odwie偶 tylko list komentarzy, zachowujc aktywn zakadk
            renderComments(updatedTask);
            // Mo偶emy te偶 opcjonalnie zaktualizowa log aktywnoci, jeli jest widoczny
            renderActivityLog(updatedTask);
        }); // Poprawne zamknicie listenera addCommentBtn


        taskModal.overlay.addEventListener('click', async (e) => {
            // === DODANY FRAGMENT KODU: Obsuga kliknicia linku zale偶noci ===
                const dependencyLink = e.target.closest('[data-linked-task-id]');
                if (dependencyLink) {
                    const taskIdToOpen = dependencyLink.dataset.linkedTaskId;
                    if (taskIdToOpen) {
                        // Mamy ID, otw贸rz to zadanie
                        closeModal(taskModal.overlay);
                        // U偶yj op贸藕nienia dla pynnego przejcia
                        setTimeout(() => {
                            openTaskModal(taskIdToOpen);
                        }, 150);
                    }
                    return; // Zakocz obsug kliknicia
                }
                // === KONIEC DODANEGO FRAGMENTU KODU ===
                // --- POCZTEK POPRAWKI LOGICZNEJ ---
                
                // 1. Sprawdzamy, czy celem kliknicia by przycisk do ukoczenia czci zadania
                const completePartBtn = e.target.closest('.js-complete-my-part-btn');
                
                // 2. Jeli nie kliknito tego przycisku, przerywamy dziaanie tego listenera
                if (!completePartBtn) {
                    return; 
                }
                
                // 3. Pobieramy dane z kliknitego przycisku
                const userId = completePartBtn.dataset.userId;
                const taskId = taskModal.overlay.dataset.taskId;
                // --- KONIEC POPRAWKI LOGICZNEJ ---

                const {
                    task,
                    project
                } = findTask(taskId);

                if (!task || !project || userId !== state.currentUser.uid) return;

                const oldStatus = task.status;
                let updatedTask = { ...task };

                // Sprawd藕, czy u偶ytkownik JU呕 ukoczy swoj cz
                const wasCompletedByMe = updatedTask.completedBy.includes(userId);

                if (wasCompletedByMe) {
                    // --- LOGIKA COFANIA (UNDO) ---
                    
                    // 1. Usu u偶ytkownika z g贸wnego zadania
                    updatedTask.completedBy = updatedTask.completedBy.filter(id => id !== userId);
                    
                    // 2. Cofnij ukoczenie we wszystkich podzadaniach, gdzie u偶ytkownik jest przypisany
                    if (updatedTask.subtasks && updatedTask.subtasks.length > 0) {
                        updatedTask.subtasks = updatedTask.subtasks.map(s => {
                            // Jeli u偶ytkownik jest w licie completedBy podzadania, usu go
                            if (s.completedBy.includes(userId)) {
                                const newCompletedBy = s.completedBy.filter(id => id !== userId);
                                // Skoro cofamy, to subzadanie na pewno nie jest ju偶 "w peni ukoczone"
                                return { ...s, completedBy: newCompletedBy, isCompleted: false };
                            }
                            return s;
                        });
                    }

                    // 3. Wymu status 'inprogress' (skoro cofamy, to nie mo偶e by 'done')
                    updatedTask.status = 'inprogress';

                } else {
                    // --- LOGIKA UKOCZENIA (COMPLETE) ---
                    
                    // 1. Oznacz g贸wn cz zadania jako wykonan przez u偶ytkownika
                    updatedTask.completedBy.push(userId);

                    // 2. Auto-kompletowanie subzada u偶ytkownika
                    if (updatedTask.subtasks && updatedTask.subtasks.length > 0) {
                        updatedTask.subtasks = updatedTask.subtasks.map(s => {
                            // Sprawd藕, czy u偶ytkownik jest przypisany do subzadania i jeszcze go nie ukoczy
                            if (s.assignees.includes(userId) && !s.completedBy.includes(userId)) {
                                const newCompletedBy = [...s.completedBy, userId];
                                const isNowCompleted = (s.assignees.length > 0) && (s.assignees.every(id => newCompletedBy.includes(id)));
                                return { ...s, completedBy: newCompletedBy, isCompleted: isNowCompleted };
                            }
                            return s;
                        });
                    }
                }
                // === KONIEC NOWEJ LOGIKI ===

                // Sprawd藕, czy cae zadanie g贸wne jest ukoczone (wszyscy kliknli)
                const isMainTaskNowCompleted = updatedTask.assignees.length > 0 && updatedTask.assignees.every(id => updatedTask.completedBy.includes(id));

                if (isMainTaskNowCompleted) {
                    updatedTask.status = 'done';
                } else if (updatedTask.completedBy.length > 0) {
                    // Jeli ktokolwiek ukoczy, ale nie wszyscy, status to 'inprogress'
                    updatedTask.status = 'inprogress';
                } else {
                    // Teoretycznie niemo偶liwe po klikniciu, ale dla pewnoci
                    updatedTask.status = 'todo';
                }


                if (updatedTask.status !== oldStatus) {
                    if (updatedTask.status === 'done') showConfetti();
                    updatedTask = addActivity(updatedTask, 'status', STATUSES[oldStatus], STATUSES[updatedTask.status]);
                }
                // Zawsze dodajemy aktywno typu 'completion' przy klikniciu tego przycisku
                updatedTask = addActivity(updatedTask, 'completion');

                // Zapisz zmiany, przeka偶 'manual' dla obsugi cyklicznoci
                await handleTaskCompletion(updatedTask, project, 'manual'); // DODANO 'manual'
                openTaskModal(taskId); // Odwie偶 modal

            }); 

        
        // NOWA LOGIKA ZESPOLONA: Listener dla CAEGO paska wyszukiwania
        // U偶ywamy precyzyjnego selektora, aby na pewno zapa pasek w sidebarze (a nie ten w modalu)
        const searchBarEl = document.querySelector('#sidebar .search-bar');

        if (searchBarEl) {
             // Dodajemy styl kursora, aby sugerowa klikalno caego paska
             searchBarEl.style.cursor = 'pointer'; 

             searchBarEl.addEventListener('click', (e) => {
                 // 1. Zapobiegamy domylnym akcjom przegldarki
                 // (np. focusowaniu ukrytego inputa, co mogo powodowa "dziwne efekty")
                 e.preventDefault();
                 
                 // 2. Zatrzymujemy propagacj, aby kliknicie nie poszo nigdzie indziej
                 e.stopPropagation();

                 // 3. Zdejmujemy focus z inputa w pasku (jeli przegldarka go nadaa)
                 const inlineInput = searchBarEl.querySelector('input');
                 if (inlineInput) inlineInput.blur();
                 
                 // 4. Otwieramy WACIWY modal (ten sam co dla rozwinitego paska)
                 openSearchModal();
            });
            
            // Dodatkowe zabezpieczenie: blokada focusa na inpucie w pasku bocznym
            const inlineInput = searchBarEl.querySelector('input');
            if (inlineInput) {
                inlineInput.addEventListener('focus', (e) => {
                    // Jeli u偶ytkownik "tabuje" do paska lub kliknie:
                    e.preventDefault();
                    inlineInput.blur();
                    openSearchModal();
                });
            }
        }
        // === KONIEC NOWEGO LISTENERA ===

        // 3. ISTNIEJCY LISTENER INPUT (logika wyszukiwania po wpisaniu tekstu)
        searchModal.input.addEventListener('input', (e) => {
            const term = e.target.value;
            renderSearchResults(performGlobalSearch(term));
        });
        
        // === NOWY LISTENER: Obsuga kliknicia w wynik wyszukiwania (NAWIGACJA) ===
        searchModal.resultsList.addEventListener('click', (e) => {
            // Znajd藕 najbli偶szy element li z klas search-result-item
            const item = e.target.closest('.search-result-item');
            if (!item) return;

            const taskId = item.dataset.taskId;
            const projectId = item.dataset.projectId;

            if (taskId && projectId) {
                // 1. Zamknij modal wyszukiwania
                closeModal(searchModal.overlay);

                // 2. Ustaw stan aplikacji na wybrany projekt
                state.currentProjectId = projectId;
                state.ui.currentView = 'projects';
                // Upewnij si, 偶e nie jestemy w trybie kalendarza
                state.ui.isCalendarView = false;

                // 3. Zapisz stan i przerysuj widok
                saveUiState();
                render();

                // 4. Zamknij sidebar (jeli jestemy na mobile)
                sidebar.classList.remove('open');
                sidebarOverlay.classList.remove('visible');

                // 5. Otw贸rz modal zadania (z maym op贸藕nieniem dla pynnoci renderowania ta)
                setTimeout(() => {
                    openTaskModal(taskId);
                }, 150);
            }
        });
        // === KONIEC NOWEGO LISTENERA ===
        // === KONIEC NOWEGO LISTENERA ===

        function performGlobalSearch(term) {
            if (!term || term.length < 2) return [];
            const lowerCaseTerm = term.toLowerCase();
            const allProjects = [...state.projects, ...state.completedProjects];
            return allProjects.flatMap(project =>
                (project.tasks || []).filter(task =>
                    task.title.toLowerCase().includes(lowerCaseTerm) ||
                    (task.description && task.description.toLowerCase().includes(lowerCaseTerm))
                ).map(task => ({ ...task,
                    projectName: project.name,
                    projectId: project.id
                }))
            );
        }

        function renderSearchResults(results) {
            searchModal.resultsList.innerHTML = results.length === 0 ?
                '<li>Brak wynik贸w</li>' :
                results.map(task => `
                        <li class="search-result-item" data-task-id="${task.id}" data-project-id="${task.projectId}">
                            <h4>${task.title}</h4>
                            <p>w projekcie: ${task.projectName}</p>
                        </li>`).join('');
        }
        

        sortBtn.addEventListener('click', async () => {
            if (state.ui.currentView === 'my-dashboard') {
                // Na dashboardzie (tylko do odczytu) zostawiamy stare sortowanie wizualne
                state.ui.sortMyTasksByDate = state.ui.sortMyTasksByDate === 'asc' ? 'desc' : 'asc';
                saveUiState();
                render();
            } 
            else if (state.ui.currentView === 'projects' && state.currentProjectId) {
                // W projekcie: Twarde sortowanie i zapis do bazy
                const project = findProject(state.currentProjectId);
                if (!project) return;

                // 1. Toggle kierunku (dla UX, 偶eby wiedzie jak sortowa)
                const currentOrder = state.ui.projectSortOrders[state.currentProjectId] || 'asc';
                const newOrder = currentOrder === 'asc' ? 'desc' : 'asc';
                state.ui.projectSortOrders[state.currentProjectId] = newOrder;

                showNotification("Porzdkowanie zada wedug daty...", "Info");

                // 2. Zbierzemy wszystkie zadania (i podzadania) i nadamy im nowy customOrder
                // Logika jest skomplikowana, bo customOrder jest per kolumna (nie globalny),
                // ale najprociej jest posortowa ca tablic `tasks` wg daty i nada im indeksy 0..N.
                // To zadziaa, bo `renderKanbanBoard` dzieli je potem na kolumny, zachowujc wzgldn kolejno indeks贸w.

                const sortedTasks = [...project.tasks];
                
                // Funkcja pomocnicza do wycigania czasu
                const getTime = (t) => t.dueDate ? new Date(t.dueDate).getTime() : (newOrder === 'asc' ? Infinity : -Infinity);

                // Sortujemy g贸wne zadania
                sortedTasks.sort((a, b) => {
                    return newOrder === 'asc' ? getTime(a) - getTime(b) : getTime(b) - getTime(a);
                });

                // Nadajemy nowe indeksy (globalnie dla listy, co przeo偶y si na kolejno w kolumnach)
                const updatedTasks = sortedTasks.map((t, index) => {
                    // Sortujemy te偶 podzadania wewntrz zadania
                    let sortedSubtasks = t.subtasks || [];
                    if (sortedSubtasks.length > 0) {
                        sortedSubtasks.sort((sa, sb) => {
                             const sTimeA = sa.dueDate ? new Date(sa.dueDate).getTime() : (newOrder === 'asc' ? Infinity : -Infinity);
                             const sTimeB = sb.dueDate ? new Date(sb.dueDate).getTime() : (newOrder === 'asc' ? Infinity : -Infinity);
                             return newOrder === 'asc' ? sTimeA - sTimeB : sTimeB - sTimeA;
                        });
                        // Nadaj im te偶 order
                        sortedSubtasks = sortedSubtasks.map((sub, subIndex) => ({ ...sub, customOrder: subIndex }));
                    }

                    return { 
                        ...t, 
                        customOrder: index, // Nadpisujemy customOrder wynikajcy z daty
                        subtasks: sortedSubtasks
                    };
                });

                // 3. Zapisz do bazy
                try {
                     const projectDocRef = findProject(project.id) ? doc(projectsRef, project.id) : doc(completedProjectsRef, project.id);
                     await updateDoc(projectDocRef, { tasks: updatedTasks });
                     saveUiState(); // Zapisz preferencj kierunku
                     // render() wywoa si sam przez onSnapshot
                } catch (e) {
                    console.error("Bd sortowania:", e);
                    showNotification("Bd zapisu sortowania.", "Bd");
                }
            }
        });

        menuToggle.addEventListener('click', () => {
            sidebar.classList.toggle('open');
            sidebarOverlay.classList.toggle('visible');
        });

        sidebarOverlay.addEventListener('click', () => {
            sidebar.classList.remove('open');
            sidebarOverlay.classList.remove('visible');
        });
        // === NOWY LISTENER: Obsuga filtr贸w kolumny "Wykonane" ===
        // U偶ywamy delegacji zdarze na g贸wnym kontenerze kanban
        kanbanBoardEl.addEventListener('change', (e) => {
            const select = e.target.closest('select.completed-tasks-filter');
            if (!select) return; // Zdarzenie 'change' nie pochodzi z naszego filtra

            const newFilterValue = select.value;
            const context = select.dataset.context;

            if (context === 'project') {
                const projectId = select.dataset.projectId;
                if (projectId) {
                    state.ui.projectCompletedFilters[projectId] = newFilterValue;
                    console.log(`Filtr projektu ${projectId} zmieniony na: ${newFilterValue}`);
                }
            } else if (context === 'dashboard') {
                state.ui.dashboardCompletedFilter = newFilterValue;
                console.log(`Filtr dashboardu zmieniony na: ${newFilterValue}`);
            }

            saveUiState(); // Zapisz nowy stan UI
            render(); // Przerenderuj widok, aby zastosowa filtr
        });
        // === KONIEC NOWEGO LISTENERA ===
       // === NOWY LISTENER DLA PUSTEGO STANU WIDOKU MJ DZIE ===
        const myDayEmptyStateEl = document.getElementById('my-day-empty-state');

        if (myDayEmptyStateEl) {
             myDayEmptyStateEl.addEventListener('click', (e) => {
                 // 1. Otw贸rz modal nowego zadania
                 if (e.target.closest('.js-fab-new-task-trigger')) {
                     // Wywoujemy standardowy FAB dla nowego zadania
                     openNewTaskModal({ isFab: true, isSpecial: false });
                     return;
                 }
                 // 2. Nawiguj do Dashboardu
                 const dashboardLink = e.target.closest('.js-navigate-to-dashboard');
                 if (dashboardLink) {
                     e.preventDefault();
                     state.currentProjectId = null;
                     state.ui.currentView = 'my-dashboard';
                     state.ui.isCalendarView = false; 
                     saveUiState();
                     render();
                     return;
                 }
            });
        }
        // === KONIEC NOWEGO LISTENERA ===
        let draggedTaskId = null;
        
        kanbanBoardEl.addEventListener('dragstart', (e) => {
            // 1. PRIORYTET: Sprawd藕, czy przecigane jest PODZADANIE
            const subtaskCard = e.target.closest('.subtask-visual-card');
            if (subtaskCard) {
                // Pobierz ID podzadania
                draggedTaskId = subtaskCard.dataset.subtaskId;
                
                // Zapobiegaj "bbelkowaniu", aby nie uruchomi listener贸w rodzica
                e.stopPropagation(); 
                
                // Dodaj klas wizualn
                setTimeout(() => subtaskCard.classList.add('dragging'), 0);
                return; // WA呕NE: Koczymy tutaj, nie sprawdzamy dalej!
            }

            // 2. Sprawd藕, czy to ZADANIE GWNE (tylko jeli nie znaleziono podzadania)
            const taskCard = e.target.closest('.task-card');
            if (taskCard) {
                draggedTaskId = taskCard.dataset.taskId;

                // === NOWE: Ustawienie obrazu przecigania tylko na g贸wn tre ===
                // Dziki temu "duch" przy kursorze bdzie zawiera tylko biay kafelek, bez podzada
                const mainContent = taskCard.querySelector('.task-card-main-content');
                if (mainContent && e.dataTransfer) {
                    // Obliczamy, gdzie u偶ytkownik klikn wzgldem karty, aby chwyt by naturalny
                    const rect = mainContent.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;
                    
                    // Ustawiamy niestandardowy obraz przecigania
                    e.dataTransfer.setDragImage(mainContent, x, y);
                }
                // === KONIEC ===

                setTimeout(() => taskCard.classList.add('dragging'), 0);
            }
        });

        kanbanBoardEl.addEventListener('dragend', (e) => {
            // Czy klas dragging z podzadania (jeli to ono byo cignite)
            const subtaskCard = e.target.closest('.subtask-visual-card');
            if (subtaskCard) {
                subtaskCard.classList.remove('dragging');
            }
            
            // Czy klas dragging z zadania g贸wnego
            const taskCard = e.target.closest('.task-card');
            if (taskCard) {
                taskCard.classList.remove('dragging');
            }
        });

        kanbanBoardEl.addEventListener('dragover', (e) => e.preventDefault());

        
        async function handleDroppedTask(droppedId, newStatus, newCustomColumnId) {
            // 1. Spr贸buj znale藕 jako Zadanie G贸wne
            let { task, project } = findTask(droppedId);
            let isSubtask = false;
            let parentTask = null;

            // 2. Jeli nie znaleziono, szukaj jako Podzadanie wewntrz wszystkich projekt贸w
            if (!task) {
                const allProjects = [...state.projects, ...state.completedProjects];
                for (const p of allProjects) {
                    for (const t of (p.tasks || [])) {
                        const sub = (t.subtasks || []).find(s => s.id === droppedId);
                        if (sub) {
                            task = sub;
                            parentTask = t;
                            project = p;
                            isSubtask = true;
                            break;
                        }
                    }
                    if (isSubtask) break;
                }
            }

            if (!task || !project) return;

            const isProjectCompleted = state.completedProjects.some(p => p.id === project.id) || 
                                     state.globalUserCompletedProjects.some(p => p.id === project.id);
            
            if (isProjectCompleted) {
                 showNotification("Nie mo偶na modyfikowa zada w zakoczonych projektach.", "Bd");
                 render(); 
                 return;
            }

            const currentUserId = state.currentUser.uid;
            // Definicja Override: Waciciel, Admin LUB SuperUser
            const isOverride = (project.ownerId === currentUserId || (project.admins || []).includes(currentUserId) || (project.superUsers || []).includes(currentUserId));

            // === OBSUGA PODZADANIA (PRZESUWANIE KAFELKA PODZADANIA) ===
            if (isSubtask) {
                const subtask = task;
                const canEdit = isOverride || (subtask.assignees || []).includes(currentUserId) || subtask.createdBy === currentUserId;

                if (!canEdit) {
                    showNotification("Brak uprawnie do zmiany statusu tego podzadania.", "Bd");
                    render(); return;
                }

                let updatedMainTask = { ...parentTask };
                
                // === NOWO: Automatyczne otwieranie rodzica (Auto-Reopen) ===
                // Jeli przenosimy podzadanie z 'done' do aktywnego, a rodzic jest 'done', musimy otworzy rodzica.
                if (newStatus !== 'done' && updatedMainTask.status === 'done') {
                    updatedMainTask.status = 'inprogress'; // Cofnij rodzica do 'W trakcie'
                    updatedMainTask.completedAt = null;    // Wyczy dat ukoczenia
                    updatedMainTask = addActivity(updatedMainTask, 'status', STATUSES['done'], STATUSES['inprogress']);
                }
                // === KONIEC NOWOCI ===

                updatedMainTask.subtasks = updatedMainTask.subtasks.map(s => {
                    if (s.id === subtask.id) {
                        
                        // Logika zachowania postpu:
                        let newCompletedBy = s.completedBy || [];
                        
                        if (newStatus === 'todo') {
                            // Reset do zera
                            newCompletedBy = [];
                        } else if (newStatus === 'done') {
                            // Wymu ukoczenie przez obecnego u偶ytkownika (jeli nie by)
                            if (!newCompletedBy.includes(currentUserId)) {
                                newCompletedBy = [...newCompletedBy, currentUserId];
                            }
                        }

                        return { 
                            ...s, 
                            status: newStatus,
                            customColumnId: (newStatus === 'todo' || newStatus === 'done') ? null : newCustomColumnId,
                            isCompleted: (newStatus === 'done'),
                            completedBy: newCompletedBy
                        };
                    }
                    return s;
                });

                const projectDocRef = findProject(project.id) ? doc(projectsRef, project.id) : doc(completedProjectsRef, project.id);
                const updatedTasks = project.tasks.map(t => (t.id === parentTask.id ? updatedMainTask : t));
                const newBudget = calculateProjectBudgetSummary(updatedTasks); 

                await updateDoc(projectDocRef, { tasks: updatedTasks, budgetSummary: newBudget });
                
                // Sprawd藕 automatyczne zamykanie rodzica (to dziaa tylko w jedn stron: Active -> Done)
                // Nasza nowa logika powy偶ej obsu偶ya drug stron (Done -> Active)
                await checkAndCompleteMainTask(updatedMainTask, project);
                
                return;
            }

            // === OBSUGA ZADANIA GWNEGO (PRZESUWANIE KAFELKA ZADANIA) ===
            
            // Walidacja uprawnie przy przenoszeniu do DONE
            if (newStatus === 'done') {
                if (!canUserCompleteTask(currentUserId, task, project)) {
                    showNotification("Tylko przypisany, admin lub waciciel mo偶e ukoczy to zadanie.", "Bd");
                    render(); return;
                }
                const block = isTaskBlocked(task);
                if (block.blocked) {
                    showNotification(`Najpierw musisz ukoczy zadanie "${block.taskName}".`, "Bd");
                    render(); return;
                }
                const allSubtasksDone = !task.subtasks || task.subtasks.length === 0 || task.subtasks.every(s => s.isCompleted);
                if (!allSubtasksDone && !isOverride) {
                    showNotification("Nie mo偶na ukoczy zadania, dop贸ki nie zostan ukoczone wszystkie podzadania.", "Bd");
                    render(); return;
                }
                const allAssigneesDone = task.type === 'single' || task.assignees.every(id => task.completedBy.includes(id));
                if (!allAssigneesDone && !isOverride) {
                    showNotification("Nie mo偶na przenie zadania do 'Wykonane', dop贸ki wszyscy nie ukocz swojej czci.", "Bd");
                    render(); return;
                }
            }

            const statusChanged = task.status !== newStatus;
            const columnChanged = task.customColumnId !== newCustomColumnId;

            if (statusChanged || columnChanged) {
                const oldStatus = task.status;
                let updatedTask = { 
                    ...task,
                    status: newStatus,
                    customColumnId: newCustomColumnId 
                };

                // --- LOGIKA PRZENOSZENIA ---
                
                if (newStatus === 'done' && isOverride) {
                    // ADMIN PRZENOSI DO DONE: Wymu ukoczenie wszystkiego
                    if (updatedTask.subtasks && updatedTask.subtasks.length > 0) {
                        updatedTask.subtasks = updatedTask.subtasks.map(s => ({
                            // === POPRAWKA: Ustawiamy te偶 status tekstowy na 'done' ===
                            ...s, 
                            isCompleted: true, 
                            status: 'done', // <-- DODANO
                            completedBy: [...s.assignees]
                        }));
                    }
                    if (updatedTask.type === 'multi') {
                        updatedTask.completedBy = [...updatedTask.assignees];
                    }
                }
                else if (newStatus !== 'done' && oldStatus === 'done') {
                    // COFANIE Z DONE (np. do In Progress)
                    
                    // === ZMIANA: Delikatny reset ===
                    // Nie czycimy completedBy ani subzada do zera!
                    // Jedynie zdejmujemy status g贸wnego zadania z 'done'.
                    // Dziki temu, jeli 1 z 2 os贸b zrobia swoj cz, a zadanie omykowo wpado do Done (np. przez admina),
                    // to po cofniciu postp tej 1 osoby zostanie zachowany.
                    
                    // Jedynie w przypadku 'todo' (cofnicie na sam pocztek) ma sens peny reset
                    if (newStatus === 'todo') {
                         updatedTask.completedBy = []; 
                         updatedTask.subtasks = (updatedTask.subtasks || []).map(s => ({
                            ...s, isCompleted: false, completedBy: []
                        }));
                    }
                    // W przypadku 'inprogress' - zachowujemy stan obecny (nic nie zmieniamy w completedBy/subtasks)
                }

                if (statusChanged || columnChanged) {
                     const oldLabel = getTaskStatusLabel(task, project);
                     const newLabel = getTaskStatusLabel(updatedTask, project);
                     updatedTask = addActivity(updatedTask, 'status', oldLabel, newLabel);
                }
                
                if (oldStatus !== 'done' && newStatus === 'done') showConfetti();
                
                await handleTaskCompletion(updatedTask, project);
            }
        }
        /**
         * Zapisuje kolejno element贸w w kolumnie po przecigniciu.
         * Obsuguje zar贸wno zadania g贸wne, jak i samodzielne podzadania.
         */
        async function persistColumnOrder(columnElement) {
            const projectId = state.currentProjectId;
            if (!projectId) return;

            const { project } = findTask(projectId) || { project: findProject(projectId) };
            if (!project) return;

            // 1. Pobierz wszystkie kafelki w tej kolumnie w aktualnej kolejnoci DOM
            // (Zar贸wno .task-card jak i .subtask-visual-card)
            const cards = Array.from(columnElement.querySelectorAll('.task-card, .subtask-visual-card'));
            
            if (cards.length === 0) return;

            // 2. Stw贸rz map nowej kolejnoci: { "ID_ELEMENTU": NOWY_INDEX }
            const orderMap = new Map();
            cards.forEach((card, index) => {
                // Dla podzadania bierzemy subtaskId, dla zadania taskId
                const id = card.dataset.subtaskId || card.dataset.taskId;
                if (id) orderMap.set(id, index);
            });

            // 3. Zaktualizuj struktur danych projektu w pamici (lokalnie)
            let tasksUpdated = false;
            const updatedTasks = project.tasks.map(t => {
                let taskModified = false;
                let newTask = { ...t };

                // A. Sprawd藕, czy to Zadanie G贸wne ma now pozycj
                if (orderMap.has(t.id)) {
                    newTask.customOrder = orderMap.get(t.id);
                    taskModified = true;
                }

                // B. Sprawd藕, czy jakiekolwiek jego Podzadanie ma now pozycj
                if (newTask.subtasks && newTask.subtasks.length > 0) {
                    const updatedSubtasks = newTask.subtasks.map(sub => {
                        if (orderMap.has(sub.id)) {
                            taskModified = true;
                            return { ...sub, customOrder: orderMap.get(sub.id) };
                        }
                        return sub;
                    });
                    newTask.subtasks = updatedSubtasks;
                }

                if (taskModified) tasksUpdated = true;
                return newTask;
            });

            if (!tasksUpdated) return; // Nic si nie zmienio w tej kolumnie

            // 4. Zapisz do Firestore
            try {
                const projectDocRef = findProject(project.id) ? doc(projectsRef, project.id) : doc(completedProjectsRef, project.id);
                
                // U偶ywamy updateDoc, aby nadpisa tablic tasks nowymi wartociami customOrder
                await updateDoc(projectDocRef, { tasks: updatedTasks });
                console.log('Kolejno kolumny zaktualizowana.');
            } catch (error) {
                console.error("Bd zapisu kolejnoci:", error);
                showNotification("Nie udao si zapisa kolejnoci.", "Bd");
            }
        }
        // Zaktualizowany g贸wny listener DROP (korzysta z nowej funkcji)
        kanbanBoardEl.addEventListener('drop', async (e) => {
            e.preventDefault();
            const column = e.target.closest('.kanban-column');
            if (!column || !draggedTaskId) return;

            const newStatus = column.dataset.status; // 'todo', 'inprogress', 'done'
            const columnIdRaw = column.dataset.columnId; // Dashboard: 'custom_...', Projekt: 'col_...'
            
            let finalCustomColumnId = null;

            // === LOGIKA DLA DASHBOARDU (NOWA) ===
            if (state.ui.currentView === 'my-dashboard') {
                
                // 1. Standardowe kolumny -> null
                if (columnIdRaw === 'todo' || columnIdRaw === 'done' || columnIdRaw === 'inprogress_default') {
                    finalCustomColumnId = null;
                } 
                // 2. Kolumny niestandardowe (zczone) -> Tumaczenie na ID projektu
                else if (columnIdRaw && columnIdRaw.startsWith('custom_')) {
                    
                    // --- NAPRAWA: Znajdowanie projektu (Zadanie G贸wne LUB Podzadanie) ---
                    let targetProject = null;
                    
                    // A. Spr贸buj znale藕 jako zadanie g贸wne
                    const { project: mainProject } = findTask(draggedTaskId);
                    if (mainProject) {
                        targetProject = mainProject;
                    } else {
                        // B. Spr贸buj znale藕 jako PODZADANIE (jeli findTask zawi贸d)
                        // Iterujemy po wszystkich projektach, 偶eby znale藕 rodzica tego podzadania
                        const allProjects = [...state.projects, ...state.completedProjects];
                        for (const p of allProjects) {
                            for (const t of (p.tasks || [])) {
                                if (t.subtasks && t.subtasks.some(s => s.id === draggedTaskId)) {
                                    targetProject = p;
                                    break;
                                }
                            }
                            if (targetProject) break;
                        }
                    }
                    // -------------------------------------------------------------------
                    
                    if (targetProject && targetProject.customColumns) {
                        // Szukamy w projekcie kolumny pasujcej nazw do klucza z Dashboardu
                        const targetCol = targetProject.customColumns.find(c => {
                             const normalizedKey = `custom_${c.title.trim().toLowerCase().replace(/\s+/g, '_')}`;
                             return normalizedKey === columnIdRaw;
                        });
                        
                        if (targetCol) {
                            finalCustomColumnId = targetCol.id; // Prawdziwe ID z bazy (np. col_123)
                        } else {
                            // Projekt nie ma takiej kolumny -> domylna "W trakcie"
                            finalCustomColumnId = null; 
                        }
                    } else {
                        finalCustomColumnId = null;
                    }
                }
            }
            // === LOGIKA DLA WIDOKU PROJEKTU (BEZPIECZNIK - STARA LOGIKA) ===
            else {
                // W widoku projektu 'columnIdRaw' to zawsze poprawne ID z bazy lub 'null'
                // Nie wykonujemy tu 偶adnego tumaczenia nazw!
                finalCustomColumnId = (columnIdRaw === 'null' || columnIdRaw === 'todo' || columnIdRaw === 'done') ? null : columnIdRaw;
            }
            
            await handleDroppedTask(draggedTaskId, newStatus, finalCustomColumnId);
            
            draggedTaskId = null;
        });
        // --- NOWY LISTENER: Obsuga rozwijania szczeg贸贸w bud偶etu na kafelku ---
        kanbanBoardEl.addEventListener('click', (e) => {
            const detailsButton = e.target.closest('.js-toggle-budget-details');
            if (!detailsButton) return; // Kliknito gdzie indziej

            // Znajd藕 kontener do rozwinicia wewntrz tego samego kafelka
            const detailsContainer = detailsButton.closest('.dashboard-card').querySelector('.budget-kpi-details');
            
            if (detailsContainer) {
                // Przecz klasy, aby pokaza/ukry zawarto i obr贸ci strzak
                detailsButton.classList.toggle('expanded');
                detailsContainer.classList.toggle('expanded');
            }
        });
       // === NOWE LISTENERY: ZIELONE PRZYCISKI "ZAKOCZ" ===

        // 1. Zakocz Zadanie G贸wne (z obsug podzada)
        if (taskModal.finishBtn) {
            taskModal.finishBtn.addEventListener('click', async () => {
                const taskId = taskModal.overlay.dataset.taskId;
                const { task, project } = findTask(taskId);
                if (!task || !project) return;

                const currentUserId = state.currentUser.uid;
                let updatedTask = { ...task };

                // === NOWE: AUTO-COMPLETE LISTY KONTROLNEJ (ZADANIE GWNE) ===
                // Odhaczamy pozycje na licie kontrolnej przypisane do zalogowanego u偶ytkownika
                if (updatedTask.checklist && updatedTask.checklist.length > 0) {
                    updatedTask.checklist = updatedTask.checklist.map(item => {
                        // Sprawd藕, czy element listy jest przypisany do mnie
                        if (item.assigneeId === currentUserId) {
                            return { ...item, isCompleted: true };
                        }
                        return item;
                    });
                }
                // === KONIEC ===

                const oldStatus = updatedTask.status;

                // A. Oznaczanie Zadania G贸wnego
                if (updatedTask.type === 'multi') {
                    // Tryb Multi: Dodaj mnie do completedBy
                    if (!updatedTask.completedBy.includes(currentUserId)) {
                        updatedTask.completedBy.push(currentUserId);
                    }
                    // Sprawd藕 czy wszyscy skoczyli
                    const allDone = updatedTask.assignees.every(id => updatedTask.completedBy.includes(id));
                    if (allDone) updatedTask.status = 'done';
                    else updatedTask.status = 'inprogress';
                
                } else {
                    // Tryb Single: Po prostu zakocz
                    updatedTask.status = 'done';
                    // Jeli Single, to completedBy powinno zawiera wykonawc (dla porzdku)
                    if (!updatedTask.completedBy.includes(currentUserId)) {
                        updatedTask.completedBy.push(currentUserId);
                    }
                }

                // B. Kaskadowe zamykanie PODZADA
                if (updatedTask.subtasks && updatedTask.subtasks.length > 0) {
                    updatedTask.subtasks = updatedTask.subtasks.map(sub => {
                        const isSubMulti = sub.type === 'multi' || (sub.assignees && sub.assignees.length > 1);
                        let newCompletedBy = [...(sub.completedBy || [])];

                        // Sprawd藕, czy u偶ytkownik ma prawo edytowa to podzadanie
                        const amIAssignedToSub = (sub.assignees || []).includes(currentUserId);
                        const isAdmin = project.ownerId === currentUserId || (project.admins || []).includes(currentUserId);

                        if (amIAssignedToSub || isAdmin) {
                            
                            // === NOWE: KASKADA DO LISTY KONTROLNEJ PODZADANIA ===
                            // Jeli podzadanie ma list kontroln, odhacz moje pozycje
                            if (sub.checklist && sub.checklist.length > 0) {
                                sub.checklist = sub.checklist.map(item => {
                                    // Jeli element listy w podzadaniu jest przypisany do mnie -> zakocz go
                                    if (item.assigneeId === currentUserId) {
                                        return { ...item, isCompleted: true };
                                    }
                                    return item;
                                });
                            }
                            // === KONIEC NOWEGO KODU ===

                            if (isSubMulti) {
                                // Multi: Zaznacz moj cz
                                if (!newCompletedBy.includes(currentUserId)) {
                                    newCompletedBy.push(currentUserId);
                                }
                                // Przelicz status podzadania
                                const subAllDone = (sub.assignees || []).every(id => newCompletedBy.includes(id));
                                return {
                                    ...sub,
                                    completedBy: newCompletedBy,
                                    isCompleted: subAllDone,
                                    status: subAllDone ? 'done' : 'inprogress'
                                };
                            } else {
                                // Single: Zamknij podzadanie cakowicie
                                // (Jeli jestem adminem lub przypisanym)
                                return {
                                    ...sub,
                                    completedBy: (sub.assignees || []), // Oznacz wszystkich (zazwyczaj 1)
                                    isCompleted: true,
                                    status: 'done'
                                };
                            }
                        }
                        return sub; // Brak zmian, jeli nie mam praw do tego podzadania
                    });
                }

                // C. Finalizacja
                if (updatedTask.status !== oldStatus) {
                    updatedTask = addActivity(updatedTask, 'status', STATUSES[oldStatus], STATUSES[updatedTask.status]);
                }
                // Dodaj log ukoczenia
                updatedTask = addActivity(updatedTask, 'completion');

                // Efekt Konfetti!
                showConfetti();

                // Zapisz i zamknij
                taskModal.finishBtn.disabled = true;
                taskModal.finishBtn.textContent = 'Zapisywanie...';
                
                await handleTaskCompletion(updatedTask, project, 'manual');
                
                showNotification("Zadanie zostao zaktualizowane.", "Sukces");
                closeModal(taskModal.overlay);
                taskModal.finishBtn.disabled = false;
                taskModal.finishBtn.textContent = ' Zakocz zadanie';
            });
        }

        // 2. Zakocz Podzadanie (Wewntrz modala podzadania)
        if (subtaskModal.finishBtn) {
            subtaskModal.finishBtn.addEventListener('click', async () => {
                const mainTaskId = subtaskModal.overlay.dataset.mainTaskId;
                const subtaskId = subtaskModal.subtaskIdInput.value;
                
                const { task: mainTask, project } = findTask(mainTaskId);
                if (!mainTask || !project) return;

                const currentUserId = state.currentUser.uid;
                let updatedMainTask = { ...mainTask };
                let subtaskChanged = false;

                updatedMainTask.subtasks = updatedMainTask.subtasks.map(sub => {
                    if (sub.id === subtaskId) {
                        subtaskChanged = true;

                        // === NOWE: Automatyczne ukoczenie MOICH POZYCJI na licie kontrolnej ===
                        if (sub.checklist && sub.checklist.length > 0) {
                            sub.checklist = sub.checklist.map(item => {
                                // Sprawd藕, czy element listy jest przypisany do mnie
                                if (item.assigneeId === currentUserId) {
                                    return { ...item, isCompleted: true };
                                }
                                // W przeciwnym razie (inny u偶ytkownik lub brak przypisania) zostaw bez zmian
                                return item;
                            });
                        }
                        // === KONIEC ===

                        let newCompletedBy = [...(sub.completedBy || [])];
                        let newStatus = sub.status || 'todo';
                        let newIsCompleted = sub.isCompleted;

                        const isMulti = sub.type === 'multi' || (sub.assignees && sub.assignees.length > 1);

                        if (isMulti) {
                            // Multi: Oznacz moj cz
                            if (!newCompletedBy.includes(currentUserId)) {
                                newCompletedBy.push(currentUserId);
                            }
                            // Sprawd藕 czy wszyscy gotowi
                            const allDone = (sub.assignees || []).every(id => newCompletedBy.includes(id));
                            if (allDone) {
                                newStatus = 'done';
                                newIsCompleted = true;
                            } else {
                                newStatus = 'inprogress';
                            }
                        } else {
                            // Single: Oznacz jako zrobione
                            newIsCompleted = true;
                            newStatus = 'done';
                            // Dodaj wykonawc do completedBy
                            if (!newCompletedBy.includes(currentUserId)) newCompletedBy.push(currentUserId);
                        }

                        return {
                            ...sub,
                            completedBy: newCompletedBy,
                            status: newStatus,
                            isCompleted: newIsCompleted
                        };
                    }
                    return sub;
                });

                if (subtaskChanged) {
                    subtaskModal.finishBtn.disabled = true;
                    subtaskModal.finishBtn.textContent = 'Zapisywanie...';

                    showConfetti(); // Konfetti dla podzadania te偶!

                    const projectDocRef = findProject(project.id) ? doc(projectsRef, project.id) : doc(completedProjectsRef, project.id);
                    
                    // Oblicz nowy bud偶et (standardowa procedura przy zmianie zada)
                    const newBudget = calculateProjectBudgetSummary(updatedMainTask.tasks || [updatedMainTask]); // Uproszczenie, normalnie caa lista
                    // Ale musimy mie ca list zada projektu
                    const allTasks = project.tasks.map(t => t.id === mainTaskId ? updatedMainTask : t);
                    const fullBudget = calculateProjectBudgetSummary(allTasks);

                    await updateDoc(projectDocRef, { tasks: allTasks, budgetSummary: fullBudget });
                    
                    // Sprawdzenia automatyczne
                    await checkAndCompleteMainTask(updatedMainTask, project);
                    await checkSubtasksAndCompleteParticipants(updatedMainTask, project);

                    showNotification("Podzadanie ukoczone.", "Sukces");
                    closeModal(subtaskModal.overlay);
                    
                    subtaskModal.finishBtn.disabled = false;
                    subtaskModal.finishBtn.textContent = ' Zakocz';
                }
            });
        }
        // === KONIEC NOWYCH LISTENERW ===
        // +++ KONIEC DODANEGO KODU +++
       taskModal.deleteBtn.addEventListener('click', async () => {
            const taskId = taskModal.overlay.dataset.taskId;
            const { task, project } = findTask(taskId);

            if (!task || !project) return;

            // Sprawdzamy czy u偶ytkownik jest adminem lub super userem
            const isAdminOrSuper = (project.admins || []).includes(state.currentUser.uid) || 
                                   (project.superUsers || []).includes(state.currentUser.uid);

            // Rozszerzamy warunek: Tw贸rca LUB Waciciel LUB (Admin/SuperUser)
            if (task.createdBy !== state.currentUser.uid && project.ownerId !== state.currentUser.uid && !isAdminOrSuper) {
                showNotification("Nie masz uprawnie do usunicia tego zadania.", "Bd");
                return;
            }

            // === NOWA FUNKCJA WEWNTRZNA: Logika usuwania (wyodrbniona) ===
            const performDelete = async () => {
                // 1. Znajd藕 zadanie, kt贸re ma by usunite
                const taskToDelete = project.tasks.find(t => t.id === taskId);
                
                if (!taskToDelete) return;

                // 2. Dodaj znacznik czasu usunicia i ID osoby usuwajcej
                const archivedTask = {
                    ...taskToDelete,
                    deletedAt: Date.now(),
                    deletedBy: state.currentUser.uid
                };

                // 3. Lista zada BEZ usuwanego zadania (aktywne)
                const updatedTasks = project.tasks.filter(t => t.id !== taskId);
                
                // 4. Nowa lista usunitych zada (dodajemy do istniejcej lub tworzymy now)
                // U偶ywamy arrayUnion w batchu, ale dla sp贸jnoci lokalnej logiki bud偶etu liczymy to tutaj
                const currentDeletedTasks = project.deletedTasks || [];
                const updatedDeletedTasks = [...currentDeletedTasks, archivedTask];

                // Referencja do dokumentu projektu
                const projectDocRef = findProject(project.id) ?
                    doc(projectsRef, project.id) :
                    doc(completedProjectsRef, project.id);

                try {
                    // --- AKTUALIZACJA LOGIKI (Wersja 2): Obliczanie budgetSummary przy usuwaniu ---
                    // Liczymy bud偶et TYLKO dla aktywnych zada (updatedTasks)
                    const newBudgetSummary = calculateProjectBudgetSummary(updatedTasks);
                    // --- KONIEC AKTUALIZACJI ---

                    // --- U偶ycie writeBatch do atomowego zapisu ---
                    const batch = writeBatch(db);
                    
                    // Aktualizujemy list aktywnych zada
                    batch.update(projectDocRef, { tasks: updatedTasks });
                    
                    // Aktualizujemy list usunitych zada (u偶ywamy arrayUnion dla bezpieczestwa)
                    batch.update(projectDocRef, { deletedTasks: arrayUnion(archivedTask) });
                    
                    // Aktualizujemy bud偶et (bez usunitego zadania)
                    batch.update(projectDocRef, { budgetSummary: newBudgetSummary });

                    await batch.commit();
                    console.log(`[Budget v2] Zaktualizowano budgetSummary dla projektu ${project.id} po przeniesieniu zadania ${taskId} do kosza.`);

                    closeModal(taskModal.overlay);
                    showNotification("Zadanie zostao przeniesione do kosza.", "Sukces");
                } catch (error) {
                    console.error("Bd podczas usuwania zadania:", error); 
                    showNotification("Wystpi bd podczas usuwania zadania.", "Bd");
                }
            };
            // === KONIEC FUNKCJI WEWNTRZNEJ ===

            // === NOWA LOGIKA: Sprawdzenie ustawie ===
            if (state.ui.confirmDelete === false) {
                // Jeli potwierdzenia s WYCZONE, usu od razu
                performDelete();
            } else {
                // Jeli wczone (domylnie), pytaj
                showConfirmation(
                    "Potwierd藕 usunicie zadania",
                    `Czy na pewno chcesz trwale usun zadanie: "${task.title}"?`,
                    (confirmed) => {
                        if (confirmed) performDelete();
                    },
                    true
                );
            }
        });

        function setupRecurrenceUIListeners(modalElements) {
            modalElements.recurrenceNthDayOptions = document.getElementById(modalElements.isRecurring.id.replace('is-recurring', 'nth-day-options'));

            modalElements.isRecurring.addEventListener('change', () => {
                modalElements.recurrenceOptions.style.display = modalElements.isRecurring.checked ? 'block' : 'none';
            });

            modalElements.recurrenceType.addEventListener('change', () => {
                const type = modalElements.recurrenceType.value;
                modalElements.recurrenceDayWrapper.style.display = type === 'dayOfMonth' ? 'block' : 'none';
                modalElements.recurrenceNthDayOptions.style.display = type === 'nthDayOfMonth' ? 'flex' : 'none';
            });
        }
        setupRecurrenceUIListeners(newTaskModal);
        setupRecurrenceUIListeners(taskModal);

        document.querySelectorAll('#calendar-toggle-btn, #calendar-toggle-btn-mobile').forEach(btn => {
            btn.addEventListener('click', () => {
                state.ui.isCalendarView = !state.ui.isCalendarView;
                saveUiState();
                render();
            });
        });
       
        // === KONIEC NOWEJ LOGIKI ===
        document.getElementById('mobile-calendar-prev-btn')?.addEventListener('click', () => {
            const currentDate = new Date(state.ui.mobileCalendarDate);
            currentDate.setMonth(currentDate.getMonth() - 1);
            state.ui.mobileCalendarDate = currentDate.toISOString();
            render();
        });

        document.getElementById('mobile-calendar-next-btn')?.addEventListener('click', () => {
            const currentDate = new Date(state.ui.mobileCalendarDate);
            currentDate.setMonth(currentDate.getMonth() + 1);
            state.ui.mobileCalendarDate = currentDate.toISOString();
            render();
        });

        document.getElementById('mobile-calendar-grid')?.addEventListener('click', (e) => {
            const dayEl = e.target.closest('.mobile-calendar-day');
            if (dayEl && dayEl.dataset.date) {
                state.ui.mobileCalendarSelectedDate = dayEl.dataset.date;
                render();
            }
        });

        document.getElementById('mobile-calendar-task-list')?.addEventListener('click', (e) => {
            const taskItem = e.target.closest('.mobile-calendar-task-item');
            if (taskItem && taskItem.dataset.taskId) {
                openTaskModal(taskItem.dataset.taskId);
            }
        });
       /**
         * Aktualizuje widoczno i zawarto Paska Akcji Masowych.
         */
        function updateBulkActionBar() {
            const count = state.ui.selectedTaskIds.length;
            
            if (count > 0) {
                bulkActionCount.textContent = `Zaznaczono: ${count}`;
                bulkActionBar.style.display = 'flex'; // Poka偶 pasek
                // U偶ywamy op贸藕nienia, aby animacja CSS zadziaaa po ustawieniu display
                setTimeout(() => bulkActionBar.classList.add('visible'), 10); 
            } else {
                bulkActionBar.classList.remove('visible');
                // Ukryj pasek po zakoczeniu animacji
                setTimeout(() => bulkActionBar.style.display = 'none', 200); 
            }
        }

        /**
         * Wcza lub wycza "Tryb Zaznaczania".
         */
        function toggleSelectMode() {
            state.ui.isSelectModeActive = !state.ui.isSelectModeActive;
            const isActive = state.ui.isSelectModeActive;

            if (isActive) {
                // --- Wchodzimy w tryb zaznaczania ---
                selectModeToggleBtn.classList.add('active');
                selectModeToggleBtn.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 16px; height: 16px;"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" /></svg>
                    <span>Anuluj</span>`;
                mainContentEl.classList.add('select-mode-active');

                // ZMIANA: Szukamy zar贸wno zada g贸wnych, jak i podzada
                document.querySelectorAll('.task-card, .subtask-visual-card').forEach(card => {
                    // Uproszczenie: Oznaczamy wszystko jako mo偶liwe do zaznaczenia.
                    // Jeli chcesz blokowa np. cudze zadania, mo偶na tu doda warunek (if creatorId...),
                    // ale dla podzada 'visual-card' musielibymy upewni si, 偶e maj ten atrybut.
                    card.classList.add('selectable');
                });

            } else {
                // --- Wychodzimy z trybu zaznaczania ---
                selectModeToggleBtn.classList.remove('active');
                selectModeToggleBtn.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 16px; height: 16px;"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" /></svg>
                    <span>Zaznacz</span>`;
                mainContentEl.classList.remove('select-mode-active');

                // Wyczy stan
                state.ui.selectedTaskIds = [];
                
                // Wyczy wszystkie klasy pomocnicze ze WSZYSTKICH kart (ZMIANA SELEKTORA)
                document.querySelectorAll('.task-card, .subtask-visual-card').forEach(card => {
                    card.classList.remove('selectable', 'non-selectable', 'selected');
                });
                
                updateBulkActionBar(); // Ukryje pasek
            }
        }

        // Listener dla g贸wnego przycisku "Zaznacz"
        if (selectModeToggleBtn) {
            selectModeToggleBtn.addEventListener('click', toggleSelectMode);
        }

        // Listener dla przycisku "Usu zaznaczone" na pasku akcji
        if (bulkDeleteBtn) {
            bulkDeleteBtn.addEventListener('click', () => {
                const count = state.ui.selectedTaskIds.length;
                if (count === 0) return;

                showConfirmation(
                    `Potwierd藕 usunicie`,
                    `Czy na pewno chcesz usun ${count} zaznaczone zadania? Tej operacji nie mo偶na cofn.`,
                    async (confirmed) => {
                        if (confirmed) {
                            // === NOWA LOGIKA USUWANIA WSADOWEGO ===
                            bulkDeleteBtn.disabled = true;
                            bulkDeleteBtn.textContent = 'Usuwanie...';

                            try {
                                const batch = writeBatch(db);
                                
                                // Mapa przechowujca zmiany per projekt
                                // Klucz: projectId, Warto: { projectObj, mainIds: [], subInfos: [] }
                                const updatesByProject = new Map();

                                // 1. IDENTYFIKACJA: Co jest czym?
                                for (const id of state.ui.selectedTaskIds) {
                                    // A. Sprawd藕 czy to Zadanie G贸wne
                                    let foundMain = findTask(id);
                                    
                                    if (foundMain.task && foundMain.project) {
                                        // To jest zadanie g贸wne
                                        const pid = foundMain.project.id;
                                        
                                        // Upewnij si, 偶e pracujemy na aktywnym projekcie
                                        const activeProject = state.projects.find(p => p.id === pid);
                                        if (activeProject) {
                                            if (!updatesByProject.has(pid)) {
                                                updatesByProject.set(pid, { project: activeProject, mainIds: [], subInfos: [] });
                                            }
                                            updatesByProject.get(pid).mainIds.push(id);
                                        }
                                        continue; // Znaleziono, id藕 do nastpnego ID
                                    }

                                    // B. Sprawd藕 czy to Podzadanie (musimy przeszuka rcznie)
                                    let foundSub = null;
                                    let parentOfSub = null;
                                    let projectOfSub = null;

                                    // Przeszukaj wszystkie aktywne projekty
                                    for (const p of state.projects) {
                                        for (const t of (p.tasks || [])) {
                                            if (t.subtasks) {
                                                const sub = t.subtasks.find(s => s.id === id);
                                                if (sub) {
                                                    foundSub = sub;
                                                    parentOfSub = t;
                                                    projectOfSub = p;
                                                    break;
                                                }
                                            }
                                        }
                                        if (foundSub) break;
                                    }

                                    if (foundSub && projectOfSub) {
                                        const pid = projectOfSub.id;
                                        if (!updatesByProject.has(pid)) {
                                            updatesByProject.set(pid, { project: projectOfSub, mainIds: [], subInfos: [] });
                                        }
                                        updatesByProject.get(pid).subInfos.push({
                                            subtask: foundSub,
                                            parentId: parentOfSub.id,
                                            parentTitle: parentOfSub.title
                                        });
                                    }
                                }

                                // 2. PRZYGOTOWANIE AKTUALIZACJI DLA KA呕DEGO PROJEKTU
                                updatesByProject.forEach(({ project, mainIds, subInfos }, projectId) => {
                                    const projectRef = doc(projectsRef, projectId);
                                    
                                    // Kopia obecnych zada do modyfikacji
                                    let currentTasks = [...(project.tasks || [])];
                                    const itemsToArchive = []; // Lista element贸w do przeniesienia do kosza

                                    // A. Usuwanie Zada G贸wnych
                                    if (mainIds.length > 0) {
                                        // Znajd藕 zadania do usunicia i dodaj metadane usunicia
                                        const mainTasksToArchive = currentTasks
                                            .filter(t => mainIds.includes(t.id))
                                            .map(t => ({
                                                ...t,
                                                deletedAt: Date.now(),
                                                deletedBy: state.currentUser.uid
                                            }));
                                        itemsToArchive.push(...mainTasksToArchive);

                                        // Usu zadania z g贸wnej listy
                                        currentTasks = currentTasks.filter(t => !mainIds.includes(t.id));
                                    }

                                    // B. Usuwanie Podzada
                                    if (subInfos.length > 0) {
                                        const subIdsToRemove = subInfos.map(info => info.subtask.id);

                                        // Przygotuj podzadania do archiwizacji (dodaj info o rodzicu)
                                        const subtasksToArchive = subInfos.map(info => ({
                                            ...info.subtask,
                                            deletedAt: Date.now(),
                                            deletedBy: state.currentUser.uid,
                                            originalParentId: info.parentId,     // Wa偶ne dla przywracania
                                            originalParentTitle: info.parentTitle,
                                            isSubtask: true
                                        }));
                                        itemsToArchive.push(...subtasksToArchive);

                                        // Usu podzadania z wntrza ich rodzic贸w
                                        currentTasks = currentTasks.map(t => {
                                            // Sprawd藕, czy zadanie ma podzadania, kt贸re trzeba usun
                                            if (t.subtasks && t.subtasks.some(s => subIdsToRemove.includes(s.id))) {
                                                return {
                                                    ...t,
                                                    subtasks: t.subtasks.filter(s => !subIdsToRemove.includes(s.id))
                                                };
                                            }
                                            return t;
                                        });
                                    }

                                    // C. Przelicz bud偶et projektu po usuniciach
                                    const newBudgetSummary = calculateProjectBudgetSummary(currentTasks);

                                    // D. Dodaj operacj update do batcha
                                    const updateData = {
                                        tasks: currentTasks,
                                        budgetSummary: newBudgetSummary
                                    };

                                    // Jeli mamy co do archiwizacji, u偶yj arrayUnion
                                    if (itemsToArchive.length > 0) {
                                        updateData.deletedTasks = arrayUnion(...itemsToArchive);
                                    }

                                    batch.update(projectRef, updateData);
                                });

                                // 3. WYKONAJ BATCH
                                await batch.commit();

                                showNotification(`Pomylnie usunito zaznaczone elementy.`, "Sukces");
                                toggleSelectMode(); // Wyjd藕 z trybu zaznaczania

                            } catch (error) {
                                console.error("Bd podczas wsadowego usuwania:", error);
                                showNotification("Wystpi bd podczas usuwania.", "Bd");
                            } finally {
                                bulkDeleteBtn.disabled = false;
                                bulkDeleteBtn.textContent = 'Usu zaznaczone';
                            }
                            // === KONIEC LOGIKI USUWANIA WSADOWEGO ===
                        }
                    },
                    true // U偶yj czerwonego przycisku
                );
            });
        }
        // === KONIEC NOWEJ LOGIKI ===
       /**
         * Otwiera modal do masowej zmiany przypisanych os贸b.
         */
        function openBulkAssignModal() {
            const projectId = state.currentProjectId;
            const project = findProject(projectId);
            
            if (!project) {
                showNotification("Bd: Nie mo偶na znale藕 bie偶cego projektu.", "Bd");
                return;
            }

            // Czycimy list
            bulkAssignModal.membersList.innerHTML = '';
            
            // U偶ywamy funkcji 'buildSubtaskAssigneePills' (stworzonej dla podzada),
            // poniewa偶 renderuje ona prost list piguek bez akordeonu,
            // co jest idealne w tym miejscu.
            // Przekazujemy czonk贸w projektu i pust list zaznaczonych.
            buildSubtaskAssigneePills(bulkAssignModal.membersList, project.members, []);
            
            // Obsuga klikania piguek w tym modalu
            // (Musimy doda ten listener, bo `buildSubtaskAssigneePills` go nie dodaje)
            bulkAssignModal.membersList.addEventListener('click', (e) => {
                const pill = e.target.closest('.member-pill:not(.disabled)');
                if (pill) {
                    pill.classList.toggle('selected');
                }
            });

            openModal(bulkAssignModal.overlay);
        }

        // Listener dla przycisku "Zmie przypisanego" na pasku akcji
        if (bulkAssignBtn) {
            bulkAssignBtn.addEventListener('click', openBulkAssignModal);
        }

        // Listener dla przycisku "Zapisz zmiany" w nowym modalu
        if (bulkAssignModal.saveBtn) {
            bulkAssignModal.saveBtn.addEventListener('click', async () => {
                const selectedIds = Array.from(bulkAssignModal.membersList.querySelectorAll('.member-pill.selected'))
                                       .map(pill => pill.dataset.userId);

                if (selectedIds.length === 0) {
                    showNotification("Musisz wybra co najmniej jedn osob.", "Bd");
                    return;
                }

                bulkAssignModal.saveBtn.disabled = true;
                bulkAssignModal.saveBtn.textContent = 'Zapisywanie...';

                try {
                    const batch = writeBatch(db);
                    const newAssigneeIds = selectedIds;
                    const newType = newAssigneeIds.length > 1 ? 'multi' : 'single';
                    const taskIdsToUpdate = state.ui.selectedTaskIds;

                    // 1. Pogrupuj zadania (tak jak przy usuwaniu)
                    const tasksByProject = new Map();
                    for (const taskId of taskIdsToUpdate) {
                        const { project } = findTask(taskId); // Potrzebujemy tylko projektu
                        if (project && state.projects.find(p => p.id === project.id)) { // Upewnij si, 偶e to aktywny projekt
                            if (!tasksByProject.has(project.id)) {
                                tasksByProject.set(project.id, { projectData: project, taskIds: [] });
                            }
                            tasksByProject.get(project.id).taskIds.push(taskId);
                        }
                    }
                    
                    // 2. Przygotuj batch
                    tasksByProject.forEach(({ projectData, taskIds }, projectId) => {
                        const projectRef = doc(projectsRef, projectId);
                        
                        // Mapuj zadania, aktualizujc te, kt贸re trzeba
                        const updatedTasks = projectData.tasks.map(task => {
                            // Jeli ID zadania nie ma na licie, zwr贸 je bez zmian
                            if (!taskIds.includes(task.id)) {
                                return task;
                            }
                            
                            // To jest zadanie do aktualizacji
                            const oldStatus = task.status;
                            // Jeli zadanie byo 'done', zresetuj je do 'todo'
                            const newStatus = (oldStatus === 'done') ? 'todo' : oldStatus;

                            return {
                                ...task,
                                assignees: newAssigneeIds,
                                type: newType,
                                status: newStatus,
                                completedBy: [] // Zawsze resetuj 'completedBy'
                            };
                        });

                        // 3. Przelicz bud偶et (wa偶ne, jeli zadania 'done' wr贸ciy do 'todo')
                        const newBudgetSummary = calculateProjectBudgetSummary(updatedTasks);

                        // 4. Dodaj do batcha
                        batch.update(projectRef, {
                            tasks: updatedTasks,
                            budgetSummary: newBudgetSummary
                        });
                    });

                    // 5. Wykonaj batch
                    await batch.commit();

                    showNotification(`Pomylnie zmieniono przypisanych dla ${taskIdsToUpdate.length} zada.`, "Sukces");
                    closeModal(bulkAssignModal.overlay);
                    toggleSelectMode(); // Wyjd藕 z trybu zaznaczania

                } catch (error) {
                    console.error("Bd podczas masowej zmiany przypisanych:", error);
                    showNotification("Wystpi bd podczas zapisu zmian.", "Bd");
                } finally {
                    bulkAssignModal.saveBtn.disabled = false;
                    bulkAssignModal.saveBtn.textContent = 'Zapisz zmiany';
                }
            });
        }
        // === KONIEC NOWEJ LOGIKI ===
        // --- CZ 1: Logika otwierania okienek ---

// Listener otwierania g贸wnego panelu ustawie
    settingsBtn.addEventListener('click', async () => {
        const user = state.currentUser;
        if (!user) return;
        
        // Reset zmiennych i p贸l formularza
        tempProfileBlob = null;
        // DODANO: Reset pola obecnego hasa
        if (settingsModal.currentPasswordInput) settingsModal.currentPasswordInput.value = ''; 
        settingsModal.newPasswordInput.value = '';
        settingsModal.confirmPasswordInput.value = '';
        settingsModal.confirmPasswordGroup.style.display = 'none';

        // A. Ustaw Awatar (korzystamy z helpera, ale wstawiamy do nowego kontenera)
        settingsModal.avatarPreview.innerHTML = renderAvatarHTML(user, 'avatar-xl-img'); 
        // Poprawka styli dla wygenerowanego awatara, aby pasowa do k贸ka
        if (settingsModal.avatarPreview.firstChild) {
            settingsModal.avatarPreview.firstChild.style.width = '100%';
            settingsModal.avatarPreview.firstChild.style.height = '100%';
            settingsModal.avatarPreview.firstChild.style.borderRadius = '0'; 
        }

       // B. Wypenij dane tekstowe
            settingsModal.nameInput.value = user.name || '';
            settingsModal.emailInput.value = user.email || '';
            
            // === NOWE: Wypenij formularz kontaktowy ===
            const contactName = document.getElementById('contact-name');
            const contactEmail = document.getElementById('contact-email');
            if (contactName) contactName.value = user.name || '';
            if (contactEmail) contactEmail.value = user.email || '';
            // === KONIEC ===

            // C. Wypenij list Podgrup (Dzia贸w)
        settingsModal.subgroupSelect.innerHTML = '<option value="">-- Brak (Domylny) --</option>';
        try {
            const groupRef = doc(groupsRef, state.ui.activeGroupId);
            const groupSnap = await getDoc(groupRef);
            
            if (groupSnap.exists()) {
                const subgroups = groupSnap.data().subgroups || [];
                // Pobierz aktualn podgrup z danych u偶ytkownika (groupInfo)
                const currentGroupInfo = state.currentUser.groupInfo[state.ui.activeGroupId] || {};
                const currentSubgroup = currentGroupInfo.subgroup;

                subgroups.forEach(sub => {
                    const option = document.createElement('option');
                    option.value = sub;
                    option.textContent = sub;
                    if (sub === currentSubgroup) option.selected = true;
                    settingsModal.subgroupSelect.appendChild(option);
                });
            }
        } catch (e) {
            console.error("Bd adowania podgrup:", e);
        }

        openModal(settingsModal.overlay);
    });
   // Obsuga nawigacji w modalu "Zarzdzaj Grup"
    const manageGroupNav = document.getElementById('manage-group-nav');
    if (manageGroupNav) {
        manageGroupNav.addEventListener('click', (e) => {
            // Znajd藕 kliknity przycisk
            const btn = e.target.closest('.settings-nav-item');
            if (!btn) return;

            // Pobierz nazw zakadki (subgroups, members, pending)
            const tabName = btn.dataset.tab;
            
            // 1. Zaktualizuj aktywny przycisk w menu
            manageGroupNav.querySelectorAll('.settings-nav-item').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            // 2. Zaktualizuj widoczn tre
            const container = document.querySelector('#manage-group-modal .settings-content');
            container.querySelectorAll('.manage-tab-content').forEach(content => content.classList.remove('active'));
            
            const activeContent = document.getElementById(`manage-tab-${tabName}`);
            if (activeContent) {
                activeContent.classList.add('active');
            }
        });
    }     
async function openManageGroupModal() {
            const user = state.currentUser;
            const activeGroupId = state.ui.activeGroupId; 
            
            if (!user || !activeGroupId) {
                showNotification("Bd: Brak aktywnej grupy do zarzdzania.", "Bd");
                return;
            }

            const membersListEl = document.getElementById('group-members-list');
            const pendingListEl = document.getElementById('pending-requests-list');
            const requestsRef = collection(db, `artifacts/${appId}/public/data/groupRequests`);
            const pendingBadge = document.getElementById('pending-requests-badge');

            // === ZMIANA: Resetowanie widoku do pierwszej zakadki (Dziay) ===
            const nav = document.getElementById('manage-group-nav');
            const contentContainer = document.querySelector('#manage-group-modal .settings-content');
            
            // Reset przycisk贸w menu
            nav.querySelectorAll('.settings-nav-item').forEach(btn => btn.classList.remove('active'));
            nav.querySelector('[data-tab="subgroups"]').classList.add('active');
            
            // Reset treci
            contentContainer.querySelectorAll('.manage-tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById('manage-tab-subgroups').classList.add('active');
            // === KONIEC ZMIANY ===

            try {
                // --- Logika wypeniania danych (Dziay i Czonkowie) ---
                const groupRef = doc(groupsRef, activeGroupId); 
                const groupSnap = await getDoc(groupRef);

                if (groupSnap.exists()) {
                    const groupData = groupSnap.data();
                    const subgroups = groupData.subgroups || [];
                    
                    // 1. Pobierz czonk贸w (z wyczeniem waciciela)
                    const groupMembers = state.users.filter(u => u.uid !== groupData.ownerId);

                    // Sortowanie alfabetyczne
                    groupMembers.sort((a, b) => {
                        const nameA = (a.name || a.email || '').toLowerCase();
                        const nameB = (b.name || b.email || '').toLowerCase();
                        return nameA.localeCompare(nameB);
                    });

                    membersListEl.innerHTML = '';
                    if (groupMembers.length > 0) {
                        groupMembers.forEach(member => {
                            // === NOWA LOGIKA: Pobieranie nazwy podgrupy ===
                            let memberSubgroup = 'Bez dziau';
                            
                            // Sprawdzamy w groupInfo dla aktywnej grupy
                            if (member.groupInfo && member.groupInfo[activeGroupId] && member.groupInfo[activeGroupId].subgroup) {
                                memberSubgroup = member.groupInfo[activeGroupId].subgroup;
                            } 
                            // Fallback dla starszych kont
                            else if (member.subgroupName) {
                                memberSubgroup = member.subgroupName;
                            }
                            // === KONIEC NOWEJ LOGIKI ===

                            const li = document.createElement('li');
                            li.className = 'attachment-item';
                            
                            // Zmieniony HTML: U偶ywamy Flexbox (column) dla tekstu
                            li.innerHTML = `
                                <div class="attachment-info">
                                    ${renderAvatarHTML(member, 'avatar-comment')}
                                    <div style="display: flex; flex-direction: column; justify-content: center; margin-left: 4px;">
                                        <span style="font-weight: 500; line-height: 1.2;">${member.name || member.email}</span>
                                        <span style="font-size: 11px; color: var(--text-secondary); margin-top: 2px;">
                                            Dzia: ${memberSubgroup}
                                        </span>
                                    </div>
                                </div>
                                <button class="delete-attachment-btn js-delete-member" data-user-id="${member.id}" title="Usu z grupy">&times;</button>
                            `;
                            membersListEl.appendChild(li);
                        });
                    } else {
                        membersListEl.innerHTML = '<li style="padding:20px; text-align:center; color:var(--text-secondary);">Brak innych czonk贸w w tej grupie.</li>';
                    }
                    
                    manageGroupModal.subgroupsList.innerHTML = ''; 
                    if (subgroups.length > 0) {
                        subgroups.forEach(name => {
                            const li = document.createElement('li');
                            li.className = 'attachment-item';
                            li.innerHTML = `
                                <div class="attachment-info" style="font-weight: 500;">${name}</div>
                                <button class="delete-attachment-btn js-delete-subgroup" data-name="${name}" title="Usu podgrup">&times;</button>
                            `;
                            manageGroupModal.subgroupsList.appendChild(li);
                        });
                    } else {
                        manageGroupModal.subgroupsList.innerHTML = '<li style="padding:20px; text-align:center; color:var(--text-secondary);">Brak zdefiniowanych podgrup.</li>';
                    }
                }
                
                // --- Logika wypeniania Oczekujcych ---
                pendingListEl.innerHTML = '<li style="padding:20px; text-align:center;">adowanie...</li>';
                const q = query(requestsRef, 
                    where("groupId", "==", activeGroupId), 
                    where("status", "==", "pending")
                );
                const requestsSnapshot = await getDocs(q);
                
                // Aktualizacja Badge'a (licznika)
                const pendingCount = requestsSnapshot.size;
                if (pendingBadge) {
                    if (pendingCount > 0) {
                        pendingBadge.textContent = pendingCount;
                        pendingBadge.style.display = 'flex';
                    } else {
                        pendingBadge.style.display = 'none';
                    }
                }
                
                if (requestsSnapshot.empty) {
                    pendingListEl.innerHTML = '<li style="padding:20px; text-align:center; color:var(--text-secondary);">Brak oczekujcych pr贸b o doczenie.</li>';
                } else {
                    pendingListEl.innerHTML = '';
                    requestsSnapshot.docs.forEach(doc => {
                        const request = doc.data();
                        const requestId = doc.id;
                        const li = document.createElement('li');
                        li.className = 'attachment-item';
                        li.innerHTML = `
                            <div class="attachment-info" title="${request.userEmail}">
                                ${renderAvatarHTML({ name: request.userName, email: request.userEmail }, 'avatar-comment')}
                                <div style="display:flex; flex-direction:column;">
                                    <span style="font-weight:600;">${request.userName}</span>
                                    <span style="font-size:11px; color:var(--text-secondary);">${request.userEmail}</span>
                                </div>
                            </div>
                            <div class="attachment-item-controls">
                                <button class="btn btn-secondary js-reject-request" data-id="${requestId}" style="padding: 6px 12px; font-size: 12px;">Odrzu</button>
                                <button class="btn btn-primary js-approve-request" data-id="${requestId}" style="padding: 6px 12px; font-size: 12px;">Akceptuj</button>
                            </div>
                        `;
                        pendingListEl.appendChild(li);
                    });
                }
                
                if (settingsModal.overlay.classList.contains('visible')) {
                    closeModal(settingsModal.overlay);
                }
                openModal(manageGroupModal.overlay);
            } catch (error) {
                console.error("Bd otwierania zarzdzania grup:", error);
                showNotification("Wystpi bd.", "Bd");
            }
        }



// === KONIEC ZMIANY ===


// Listener do dodawania nowej podgrupy
manageGroupModal.addSubgroupForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    // Zabezpieczenie przycisku przed wielokrotnym klikniciem
    const submitBtn = manageGroupModal.addSubgroupForm.querySelector('button[type="submit"]');
    submitBtn.disabled = true;
    submitBtn.textContent = 'Dodawanie...';

    const newName = manageGroupModal.newSubgroupNameInput.value.trim();
    
    if (!newName) {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Dodaj dzia';
        return;
    }

    // U偶ywamy aktywnej grupy
    const groupRef = doc(groupsRef, state.ui.activeGroupId); 

    try {
        const groupSnap = await getDoc(groupRef);
        if (groupSnap.exists()) {
            const subgroups = groupSnap.data().subgroups || [];
            
            // Sprawdzenie lokalne dla szybkiej informacji zwrotnej
            if (subgroups.includes(newName)) {
                showNotification("Podgrupa o tej nazwie ju偶 istnieje.", "Informacja");
                submitBtn.disabled = false;
                submitBtn.textContent = 'Dodaj dzia';
                return;
            }
            
            // 1. Zapisz w Firebase u偶ywajc arrayUnion (Gwarancja unikalnoci w bazie)
            await updateDoc(groupRef, { 
                subgroups: arrayUnion(newName) 
            });
            
            // 2. Wyczy pole input
            manageGroupModal.newSubgroupNameInput.value = ''; 

            // === NOWA LOGIKA: Rczna aktualizacja DOM ("na 偶ywo") ===
            const list = manageGroupModal.subgroupsList;

            // a) Jeli na licie jest tylko komunikat "Brak...", usu go
            if (list.children.length === 1 && list.children[0].textContent.includes('Brak')) {
                list.innerHTML = '';
            }

            // b) Stw贸rz nowy element HTML pasujcy stylem do reszty
            const li = document.createElement('li');
            li.className = 'attachment-item';
            li.innerHTML = `
                <div class="attachment-info">${newName}</div>
                <button class="delete-attachment-btn js-delete-subgroup" data-name="${newName}" title="Usu podgrup">&times;</button>
            `;

            // c) Dodaj go do listy natychmiastowo
            list.appendChild(li);
            // === KONIEC NOWEJ LOGIKI ===
            
            showNotification("Dzia zosta dodany.", "Sukces");
        }
    } catch (error) {
        console.error("Bd dodawania podgrupy:", error);
        showNotification("Wystpi bd podczas dodawania.", "Bd");
    } finally {
        // Odblokuj przycisk
        submitBtn.disabled = false;
        submitBtn.textContent = 'Dodaj dzia';
    }
});

// Listener do usuwania podgrupy, czonk贸w ORAZ akceptacji/odrzucenia pr贸b
        manageGroupModal.overlay.addEventListener('click', async (e) => {
            
            // === NOWA LOGIKA: Akceptacja/Odrzucenie ===
            const approveBtn = e.target.closest('.js-approve-request');
            if (approveBtn) {
                const requestId = approveBtn.dataset.id;
                handleProcessRequest(requestId, 'approve', approveBtn);
                return;
            }
            
            const rejectBtn = e.target.closest('.js-reject-request');
            if (rejectBtn) {
                const requestId = rejectBtn.dataset.id;
                handleProcessRequest(requestId, 'reject', rejectBtn);
                return;
            }
            // === KONIEC NOWEJ LOGIKI ===

            // Obsuga usuwania podgrupy
            if (e.target.classList.contains('js-delete-subgroup')) {
                const nameToDelete = e.target.dataset.name;
                // Pobieramy referencj do kliknitego przycisku, aby wiedzie, co usun z DOM
                const btnClicked = e.target; 
                
                const groupRef = doc(groupsRef, state.ui.activeGroupId); 
                
                showConfirmation("Potwierd藕 usunicie", `Czy na pewno chcesz usun podgrup "${nameToDelete}"?`, async (confirmed) => {
                    if (confirmed) {
                        try {
                            const groupSnap = await getDoc(groupRef);
                            if (groupSnap.exists()) {
                                const subgroups = groupSnap.data().subgroups || [];
                                const updatedSubgroups = subgroups.filter(name => name !== nameToDelete);
                                
                                // 1. Zapisz zmiany w Firebase
                                await updateDoc(groupRef, { subgroups: updatedSubgroups });
                                
                                // === NOWA LOGIKA: Usuwanie z DOM "na 偶ywo" ===
                                const liToRemove = btnClicked.closest('li');
                                if (liToRemove) {
                                    liToRemove.remove();
                                }

                                // Sprawd藕, czy lista jest pusta i wywietl stosowny komunikat
                                if (manageGroupModal.subgroupsList.children.length === 0) {
                                    manageGroupModal.subgroupsList.innerHTML = '<li>Brak zdefiniowanych podgrup.</li>';
                                }
                                // === KONIEC NOWEJ LOGIKI ===
                            }
                        } catch (error) {
                            console.error("Bd usuwania podgrupy:", error);
                            showNotification("Bd usuwania.", "Bd");
                        }
                    }
                }, true);
            }

            // NOWA LOGIKA: Obsuga usuwania czonka
            if (e.target.classList.contains('js-delete-member')) {
                const userIdToRemove = e.target.dataset.userId;
                const userToRemove = findUser(userIdToRemove);
                if (!userToRemove) return;

                showConfirmation(
                    "Potwierd藕 usunicie czonka", 
                    `Czy na pewno chcesz usun "${userToRemove.name || userToRemove.email}" z grupy? U偶ytkownik straci dostp do projekt贸w.`, 
                    async (confirmed) => {
                        if (confirmed) {
                            try {
                                const userToRemoveRef = doc(usersRef, userIdToRemove);
                                
                                // === POPRAWKA: Poprawna logika usuwania czonka ===
                                await updateDoc(userToRemoveRef, {
                                    [`groupInfo.${state.ui.activeGroupId}`]: deleteField(),
                                    groupIds: arrayRemove(state.ui.activeGroupId)
                                });

                                // Usuwamy ID u偶ytkownika z listy memberIds w grupie
                                const groupRef = doc(groupsRef, state.ui.activeGroupId);
                                await updateDoc(groupRef, {
                                    memberIds: arrayRemove(userIdToRemove)
                                });
                                // TODO: W przyszoci usu u偶ytkownika z `members` we wszystkich projektach w tej grupie
                                // === KONIEC POPRAWKI ===

                                showNotification("U偶ytkownik zosta usunity z grupy.", "Sukces");
                                openManageGroupBtn.click(); // Odwie偶 widok modala
                            } catch (error) {
                                console.error("Bd usuwania u偶ytkownika z grupy:", error);
                                showNotification("Wystpi bd. Spr贸buj ponownie.", "Bd");
                            }
                        }
                    }, 
                    true
                );
            }
        });

        /**
         * Funkcja pomocnicza wywoujca Cloud Function do przetworzenia proby.
         */
        async function handleProcessRequest(requestId, action, buttonElement) {
            // Zablokuj oba przyciski w tym wierszu
            const controls = buttonElement.closest('.attachment-item-controls');
            controls.querySelectorAll('button').forEach(btn => btn.disabled = true);
            buttonElement.textContent = 'Przetwarzanie...';

            try {
                // 1. Zdefiniuj wywoanie nowej funkcji chmurowej
                const processRequest = httpsCallable(functions, 'processGroupRequest');
                
                // 2. Wylij ID proby oraz akcj
                const result = await processRequest({ 
                    requestId: requestId, 
                    action: action 
                });

                // 3. Obsu偶 sukces
                showNotification(result.data.message, "Sukces");
                
                // 4. Usu wiersz z listy w UI (nie musimy przeadowywa)
                buttonElement.closest('li.attachment-item').remove();
                
                // 5. Sprawd藕, czy lista nie jest pusta
                const pendingListEl = document.getElementById('pending-requests-list');
                if (pendingListEl.children.length === 0) {
                    pendingListEl.innerHTML = '<li>Brak oczekujcych pr贸b o doczenie.</li>';
                }

            } catch (error) {
                console.error("Bd podczas przetwarzania proby:", error);
                showNotification(error.message, "Bd");
                // Odblokuj przyciski w razie bdu
                controls.querySelectorAll('button').forEach(btn => btn.disabled = false);
                buttonElement.textContent = (action === 'approve') ? 'Akceptuj' : 'Odrzu';
            }
        }

        // === USUNITO BDNE LISTENERY, KTRE POWODOWAY BDY ===
        // (Brak `document.getElementById('pending-requests-list').addEventListener(...)`)
        // (Brak `document.addEventListener('click', ... groupSwitcher ...)` w tym miejscu)

        // --- NOWA Logika: Obsuga zdjcia i hasa w panelu ---
        
        const cropPhotoModal = {
            overlay: document.getElementById('crop-photo-modal'),
            container: document.getElementById('croppie-container'),
            saveBtn: document.getElementById('save-cropped-photo-btn')
        };
        let croppieInstance = null;

        // 1. Kliknicie w awatar otwiera wyb贸r pliku
        settingsModal.avatarWrapper.addEventListener('click', () => {
            photoUploadInput.click();
        });

        // 2. Listener zmiany pliku (dostosowany: nie wysya od razu, tylko zapisuje do tempProfileBlob)
        photoUploadInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(event) {
                // Otwieramy okno kadrowania
                openModal(cropPhotoModal.overlay);
                
                if (croppieInstance) croppieInstance.destroy();
                croppieInstance = new Croppie(cropPhotoModal.container, {
                    viewport: { width: 250, height: 250, type: 'circle' },
                    boundary: { width: 300, height: 300 },
                    enableExif: true
                });
                croppieInstance.bind({ url: event.target.result });
                
                // Nadpisujemy przycisk "Zapisz" w Cropperze - TERAZ TYLKO AKTUALIZUJE PODGLD
                cropPhotoModal.saveBtn.onclick = async () => {
                    const blob = await croppieInstance.result({
                        type: 'blob', size: { width: 400, height: 400 }, format: 'jpeg'
                    });
                    
                    // Zapisz blob do zmiennej tymczasowej
                    tempProfileBlob = blob;
                    
                    // Zaktualizuj podgld w panelu ustawie
                    const previewUrl = URL.createObjectURL(blob);
                    settingsModal.avatarPreview.innerHTML = `<img src="${previewUrl}" style="width:100%; height:100%; object-fit:cover;">`;
                    
                    // Zamknij croppera
                    closeModal(cropPhotoModal.overlay);
                    photoUploadInput.value = '';
                };
            };
            reader.readAsDataURL(file);
        });
        // 4. GWNA FUNKCJA ZAPISU
    // 4. GWNA FUNKCJA ZAPISU (Wersja z DEBUGOWANIEM POWIADOMIE)
        settingsModal.saveBtn.addEventListener('click', async () => {
            const user = state.currentUser;
            // Pobierz obiekt usera bezporednio z Auth dla operacji zmiany hasa
            const firebaseUser = auth.currentUser; 

            const newName = settingsModal.nameInput.value.trim();
            const newSubgroup = settingsModal.subgroupSelect.value;
            
            // Hasa
            const currentPass = settingsModal.currentPasswordInput.value;
            const newPass = settingsModal.newPasswordInput.value;
            const confirmPass = settingsModal.confirmPasswordInput.value;

            if (!newName) {
                showNotification("Imi i nazwisko nie mo偶e by puste.", "Bd");
                return;
            }

            // Walidacja hasa
            if (newPass) {
                if (!currentPass) {
                    showNotification("Aby zmieni haso, musisz poda obecne haso.", "Bd");
                    settingsModal.currentPasswordInput.focus();
                    return;
                }
                if (newPass.length < 6) {
                    showNotification("Nowe haso musi mie min. 6 znak贸w.", "Bd");
                    return;
                }
                if (newPass !== confirmPass) {
                    showNotification("Nowe hasa nie s identyczne.", "Bd");
                    return;
                }
            }

            settingsModal.saveBtn.disabled = true;
            settingsModal.saveBtn.textContent = 'Zapisywanie...';

            try {
                const updates = {};
                let messages = [];

                // A. Obsuga Zdjcia
                if (tempProfileBlob) {
                    const filePath = `profile-pictures/${user.uid}/avatar.jpeg`;
                    const fileRef = ref(storage, filePath);
                    await uploadBytes(fileRef, tempProfileBlob);
                    const photoURL = await getDownloadURL(fileRef);
                    updates.photoURL = photoURL;
                    messages.push("Zdjcie");
                }

                // B. Obsuga Nazwy
                if (newName !== user.name) {
                    updates.name = newName;
                    messages.push("Nazwa");
                }
                
                // C. Obsuga Dziau
                // Inicjalizacja obiektu groupInfo jeli nie istnieje
                if (!state.currentUser.groupInfo) state.currentUser.groupInfo = {};
                if (!state.currentUser.groupInfo[state.ui.activeGroupId]) {
                    state.currentUser.groupInfo[state.ui.activeGroupId] = {};
                }

                const currentGroupInfo = state.currentUser.groupInfo[state.ui.activeGroupId] || {};
                if (newSubgroup !== currentGroupInfo.subgroup) {
                    updates[`groupInfo.${state.ui.activeGroupId}.subgroup`] = newSubgroup;
                    
                    // Aktualizacja lokalna
                    state.currentUser.groupInfo[state.ui.activeGroupId].subgroup = newSubgroup;
                    if (state.ui.activeGroupInfo) {
                         state.ui.activeGroupInfo.subgroup = newSubgroup;
                    }
                    messages.push("Dzia");
                }

                // === E. OBSUGA USTAWIE APLIKACJI (FIRESTORE) ===
                const currentPrefs = user.preferences || {};
                
                // 1. Motyw (Theme)
                const selectedTheme = document.querySelector('input[name="app-theme"]:checked')?.value || 'light';
                const dbTheme = currentPrefs.theme || 'light';
                if (selectedTheme !== dbTheme) {
                    updates['preferences.theme'] = selectedTheme;
                    state.ui.theme = selectedTheme; 
                    messages.push("Motyw");
                }

                // 2. Widok Startowy
                const dbStartView = currentPrefs.startView || 'auto';
                if (settingsStartView && settingsStartView.value !== dbStartView) {
                    updates['preferences.startView'] = settingsStartView.value;
                    state.ui.startView = settingsStartView.value;
                    messages.push("Widok startowy");
                }

                // 3. Konfetti
                const dbShowConfetti = currentPrefs.showConfetti !== undefined ? currentPrefs.showConfetti : true;
                if (settingsShowConfetti && settingsShowConfetti.checked !== dbShowConfetti) {
                    updates['preferences.showConfetti'] = settingsShowConfetti.checked;
                    state.ui.showConfetti = settingsShowConfetti.checked;
                    messages.push("Konfetti");
                }

                // 4. Potwierdzenia
                const dbConfirmDelete = currentPrefs.confirmDelete !== undefined ? currentPrefs.confirmDelete : true;
                if (settingsConfirmDelete && settingsConfirmDelete.checked !== dbConfirmDelete) {
                    updates['preferences.confirmDelete'] = settingsConfirmDelete.checked;
                    state.ui.confirmDelete = settingsConfirmDelete.checked;
                    messages.push("Potwierdzenia");
                }

                // 5. Tryb Kompaktowy
                const dbCompactMode = currentPrefs.compactMode || false;
                if (settingsCompactMode && settingsCompactMode.checked !== dbCompactMode) {
                    updates['preferences.compactMode'] = settingsCompactMode.checked;
                    state.ui.compactMode = settingsCompactMode.checked;
                    applyInterfaceSettings(); 
                    messages.push("Tryb kompaktowy");
                }

                // 6. Start ze zwinitym paskiem
                const dbStartCollapsed = currentPrefs.startCollapsed || false;
                if (settingsStartCollapsed && settingsStartCollapsed.checked !== dbStartCollapsed) {
                    updates['preferences.startCollapsed'] = settingsStartCollapsed.checked;
                    state.ui.startCollapsed = settingsStartCollapsed.checked;
                    messages.push("Ustawienie paska bocznego");
                }

                // 7. Rozwijanie podzada
                const dbExpandSubtasks = currentPrefs.expandSubtasksByDefault !== undefined ? currentPrefs.expandSubtasksByDefault : true;
                if (settingsExpandSubtasks && settingsExpandSubtasks.checked !== dbExpandSubtasks) {
                    updates['preferences.expandSubtasksByDefault'] = settingsExpandSubtasks.checked;
                    state.ui.expandSubtasksByDefault = settingsExpandSubtasks.checked;
                    messages.push("Domylne rozwijanie podzada");
                }
                
                saveUiState();

                // D. Obsuga Hasa (Firebase Auth)
                if (newPass) {
                    const credential = EmailAuthProvider.credential(firebaseUser.email, currentPass);
                    await reauthenticateWithCredential(firebaseUser, credential);
                    await updatePassword(firebaseUser, newPass);
                    messages.push("Haso");
                }

                // === NOWE: Zapis powiadomie (DEBUGOWANIE) ===
                
                // Pobierz stan checkbox贸w
                const newNotifPrefs = {
                    project_invite: document.getElementById('notif-project-invite').checked,
                    task_assign: document.getElementById('notif-task-assign').checked,
                    subtask_assign: document.getElementById('notif-subtask-assign').checked,
                    task_mention: document.getElementById('notif-task-mention').checked,
                    subtask_mention: document.getElementById('notif-subtask-mention').checked,
                    budget_alert: document.getElementById('notif-budget-alert').checked,
                    polls: document.getElementById('notif-polls').checked,
                    correction: document.getElementById('notif-correction').checked,
                    dependency: document.getElementById('notif-dependency').checked,
                    checklist_assign: document.getElementById('notif-checklist-assign').checked // <--- NOWE
                };

                // Pobierz stan z bazy (domylnie pusty obiekt)
                const currentNotifsSafe = (state.currentUser.preferences && state.currentUser.preferences.notifications) 
                    ? state.currentUser.preferences.notifications 
                    : {};
                
                let notifChanged = false;
                const notifKeys = Object.keys(newNotifPrefs);
                
                console.group("--- DEBUGOWANIE ZAPISU POWIADOMIE ---");
                for (let i = 0; i < notifKeys.length; i++) {
                    const key = notifKeys[i];
                    const newValue = Boolean(newNotifPrefs[key]); // Wymuszamy typ Boolean
                    
                    // Pobierz star warto. Jeli undefined -> true (domylny stan)
                    const rawStoredValue = currentNotifsSafe[key];
                    const oldValue = (rawStoredValue === undefined) ? true : Boolean(rawStoredValue);

                    // Logowanie ka偶dej wartoci
                    console.log(`Klucz: ${key} | Nowa (Input): ${newValue} | Stara (DB): ${oldValue} (Raw: ${rawStoredValue})`);

                    if (newValue !== oldValue) {
                        notifChanged = true;
                        console.log(`>>> ZMIANA WYKRYTA! ${key}: ${oldValue} -> ${newValue}`);
                        // Nie przerywamy ptli (break), 偶eby w logach zobaczy wszystko, 
                        // ale flaga notifChanged ju偶 jest true.
                    }
                }
                console.groupEnd();

                if (notifChanged) {
                    updates['preferences.notifications'] = newNotifPrefs;
                    
                    // Aktualizujemy lokalny stan, aby kolejne kliknicie nie wykryo zmiany
                    if (!state.currentUser.preferences) state.currentUser.preferences = {};
                    if (!state.currentUser.preferences.notifications) state.currentUser.preferences.notifications = {};
                    
                    // Nadpisujemy lokalne preferencje
                    state.currentUser.preferences.notifications = { 
                        ...state.currentUser.preferences.notifications, 
                        ...newNotifPrefs 
                    };
                    
                    messages.push("Ustawienia powiadomie");
                }
                
                // === NOWE: Zapis dni ostrze偶enia ===
                const warningDaysInput = document.getElementById('setting-warning-days');
                const newWarningDays = parseInt(warningDaysInput.value, 10) || 3; // Fallback do 3
                const oldWarningDays = state.currentUser.preferences.warningDays !== undefined 
                                       ? state.currentUser.preferences.warningDays 
                                       : 3;

                if (newWarningDays !== oldWarningDays) {
                    updates['preferences.warningDays'] = newWarningDays;
                    // Aktualizacja lokalna
                    state.currentUser.preferences.warningDays = newWarningDays;
                    messages.push("Dni ostrze偶enia");
                }
                // === KONIEC ===

                // === KONIEC DEBUGOWANIA ===

                // WYKONAJ ZAPIS DO FIRESTORE
                if (Object.keys(updates).length > 0) {
                    const userRef = doc(usersRef, user.uid);
                    await updateDoc(userRef, updates);
                    
                    // Scalanie nowych preferencji z istniejcymi w stanie lokalnym (dla bezpieczestwa)
                    state.currentUser.preferences = {
                        ...state.currentUser.preferences,
                        ...currentPrefs
                    };
                    // Rcznie aktualizujemy klucze, kt贸re wysalimy
                    if (updates['preferences.theme']) state.currentUser.preferences.theme = updates['preferences.theme'];
                    // ... (reszta kluczy aktualizowana przez listenery zmiany wy偶ej)
                }

                if (messages.length > 0) {
                    showNotification(`Pomylnie zaktualizowano: ${messages.join(", ")}.`, "Sukces");
                    closeModal(settingsModal.overlay);
                } else {
                    showNotification("Nie wprowadzono 偶adnych zmian.", "Informacja");
                }
                
                render(); 

            } catch (error) {
                console.error("Bd zapisu ustawie:", error);
                showNotification(error.message || "Wystpi bd podczas zapisu.", "Bd");
            } finally {
                settingsModal.saveBtn.disabled = false;
                settingsModal.saveBtn.textContent = 'Zapisz zmiany';
            }
        });

        // === NAPRAWA BDU: Definicje zmiennych ustawie (MUSZ BY TUTAJ) ===
        const settingsStartView = document.getElementById('settings-start-view');
        const settingsShowConfetti = document.getElementById('settings-show-confetti');
        const settingsConfirmDelete = document.getElementById('settings-confirm-delete');
        
        // === NOWE REFERENCJE DLA INTERFEJSU ===
        const settingsCompactMode = document.getElementById('settings-compact-mode');
        const settingsStartCollapsed = document.getElementById('settings-start-collapsed');
        const settingsExpandSubtasks = document.getElementById('settings-expand-subtasks'); // <--- NOWE
        // === KONIEC ===

        // === NOWA FUNKCJA: Aplikowanie ustawie interfejsu ===
        function applyInterfaceSettings() {
            // Aplikuj tryb kompaktowy
            if (state.ui.compactMode) {
                document.body.classList.add('compact-mode');
            } else {
                document.body.classList.remove('compact-mode');
            }
            // Uwaga: 'startCollapsed' jest sprawdzane tylko przy starcie (w onAuthStateChanged)
        }
        // === KONIEC ===

        // Listenery zapisujce zmiany od razu po zmianie wartoci
        if (settingsStartView) {
            settingsStartView.addEventListener('change', (e) => {
                state.ui.startView = e.target.value;
                saveUiState();
            });
        }
        // === NOWE LISTENERY (Lokalne aktualizacje UI) ===
        if (settingsCompactMode) {
            settingsCompactMode.addEventListener('change', (e) => {
                state.ui.compactMode = e.target.checked;
                applyInterfaceSettings(); // Natychmiastowy podgld
                saveUiState();
            });
        }
        if (settingsStartCollapsed) {
            settingsStartCollapsed.addEventListener('change', (e) => {
                state.ui.startCollapsed = e.target.checked;
                saveUiState();
            });
        }
        if (settingsShowConfetti) {
            settingsShowConfetti.addEventListener('change', (e) => {
                state.ui.showConfetti = e.target.checked;
                saveUiState();
            });
        }
        if (settingsConfirmDelete) {
            settingsConfirmDelete.addEventListener('change', (e) => {
                state.ui.confirmDelete = e.target.checked;
                saveUiState();
            });
        }
       // Listener dla nowej opcji: Domylne rozwijanie podzada
        if (settingsExpandSubtasks) {
            settingsExpandSubtasks.addEventListener('change', (e) => {
                state.ui.expandSubtasksByDefault = e.target.checked;
                saveUiState();
                render(); // Przerenderuj widok, aby natychmiast zwin/rozwin kafelki
            });
        }
        // === KONIEC NAPRAWY ===

        // === NOWA LOGIKA: Obsuga zakadek w g贸wnym modalu ustawie ===
        const settingsMainNav = document.getElementById('settings-main-nav');
        if (settingsMainNav) {
            settingsMainNav.addEventListener('click', (e) => {
                const btn = e.target.closest('.settings-nav-item');
                // Ignoruj, jeli to przycisk Akademii (on ma wasny listener)
                if (!btn || btn.id === 'open-tutorial-btn') return;

                const tabName = btn.dataset.tab;
                if (!tabName) return;

                // 1. UI przycisk贸w
                settingsMainNav.querySelectorAll('.settings-nav-item').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');

                // 2. UI treci
                const container = document.querySelector('#settings-modal .settings-content');
                container.querySelectorAll('.settings-tab-content').forEach(content => content.classList.remove('active'));
                
                const targetContent = document.getElementById(`settings-tab-${tabName}`);
                if (targetContent) targetContent.classList.add('active');
            });
        }

        // === NOWA LOGIKA: Obsuga zmiany motywu w ustawieniach ===
        const themeRadios = document.querySelectorAll('input[name="app-theme"]');
        themeRadios.forEach(radio => {
            radio.addEventListener('change', (e) => {
                if (e.target.checked) {
                    state.ui.theme = e.target.value; // 'light' lub 'dark'
                    saveUiState();
                    applyTheme();
                }
            });
        });

        // Aktualizacja przycisku otwierania ustawie, aby ustawia poprawny stan UI
        const originalSettingsBtnClick = settingsBtn.onclick; 
        
        // Dodajemy logik inicjalizacji UI do istniejcego listenera settingsBtn
        settingsBtn.addEventListener('click', () => {
            const user = state.currentUser;
            if (!user) return;
            
            // Reset zmiennych i p贸l formularza
            tempProfileBlob = null;
            if (settingsModal.currentPasswordInput) settingsModal.currentPasswordInput.value = ''; 
            settingsModal.newPasswordInput.value = '';
            settingsModal.confirmPasswordInput.value = '';
            settingsModal.confirmPasswordGroup.style.display = 'none';

            // A. Ustaw Awatar
            settingsModal.avatarPreview.innerHTML = renderAvatarHTML(user, 'avatar-xl-img'); 
            if (settingsModal.avatarPreview.firstChild) {
                settingsModal.avatarPreview.firstChild.style.width = '100%';
                settingsModal.avatarPreview.firstChild.style.height = '100%';
                settingsModal.avatarPreview.firstChild.style.borderRadius = '0'; 
            }

            // B. Wypenij dane tekstowe
            settingsModal.nameInput.value = user.name || '';
            settingsModal.emailInput.value = user.email || '';

            // C. Wypenij list Podgrup (Dzia贸w)
            settingsModal.subgroupSelect.innerHTML = '<option value="">-- Brak (Domylny) --</option>';
            getDoc(doc(groupsRef, state.ui.activeGroupId)).then(groupSnap => {
                if (groupSnap.exists()) {
                    const subgroups = groupSnap.data().subgroups || [];
                    const currentGroupInfo = state.currentUser.groupInfo[state.ui.activeGroupId] || {};
                    const currentSubgroup = currentGroupInfo.subgroup;

                    subgroups.forEach(sub => {
                        const option = document.createElement('option');
                        option.value = sub;
                        option.textContent = sub;
                        if (sub === currentSubgroup) option.selected = true;
                        settingsModal.subgroupSelect.appendChild(option);
                    });
                }
            }).catch(e => console.error("Bd adowania podgrup:", e));

            // === USTAWIENIA APLIKACJI (Wypenianie formularza) ===
            const currentTheme = state.ui.theme || 'light';
            const radioToSelect = document.querySelector(`input[name="app-theme"][value="${currentTheme}"]`);
            if (radioToSelect) radioToSelect.checked = true;

            // Wypenij formularz ustawie wartociami ze stanu
            // TERAZ TO ZADZIAA, bo zmienne s zdefiniowane wy偶ej
            if (settingsStartView) settingsStartView.value = state.ui.startView || 'auto';
            if (settingsShowConfetti) settingsShowConfetti.checked = (state.ui.showConfetti !== false);
            if (settingsConfirmDelete) settingsConfirmDelete.checked = (state.ui.confirmDelete !== false);
            // === NOWE ===
            if (settingsCompactMode) settingsCompactMode.checked = (state.ui.compactMode === true);
            if (settingsStartCollapsed) settingsStartCollapsed.checked = (state.ui.startCollapsed === true);
            if (settingsExpandSubtasks) settingsExpandSubtasks.checked = (state.ui.expandSubtasksByDefault !== false); 
            
            // === NOWE: adowanie ustawie powiadomie ===
            // Pobierz preferencje z obiektu u偶ytkownika (domylnie pusty obiekt jeli brak)
            const notifPrefs = state.currentUser.preferences.notifications || {};
            
            // Funkcja pomocnicza: true jeli undefined lub true (domylnie wczone)
            const isNotifEnabled = (key) => notifPrefs[key] !== false;

            // Mapowanie ID checkbox贸w na klucze w bazie
            document.getElementById('notif-project-invite').checked = isNotifEnabled('project_invite');
            document.getElementById('notif-task-assign').checked = isNotifEnabled('task_assign');
            document.getElementById('notif-subtask-assign').checked = isNotifEnabled('subtask_assign');
            document.getElementById('notif-task-mention').checked = isNotifEnabled('task_mention');
            document.getElementById('notif-subtask-mention').checked = isNotifEnabled('subtask_mention');
            document.getElementById('notif-budget-alert').checked = isNotifEnabled('budget_alert');
            document.getElementById('notif-polls').checked = isNotifEnabled('polls');
            document.getElementById('notif-correction').checked = isNotifEnabled('correction');
            document.getElementById('notif-dependency').checked = isNotifEnabled('dependency');
            document.getElementById('notif-checklist-assign').checked = isNotifEnabled('checklist_assign'); // <--- NOWE
            
            // === NOWE: adowanie dni ostrze偶enia ===
            const warningDaysInput = document.getElementById('setting-warning-days');
            // Pobierz warto z preferencji (domylnie 3)
            const savedWarningDays = state.currentUser.preferences.warningDays !== undefined 
                                     ? state.currentUser.preferences.warningDays 
                                     : 3;
            if (warningDaysInput) warningDaysInput.value = savedWarningDays;
            // === KONIEC ===

            // === KONIEC NOWEGO KODU ===

            // Reset do zakadki profilu przy ka偶dym otwarciu
            const profileBtn = settingsMainNav.querySelector('[data-tab="profile"]');
            if (profileBtn) profileBtn.click();

            openModal(settingsModal.overlay);
        });
        
        // --- CZ 3: Logika zmiany nazwy u偶ytkownika ---
        
        changeUsernameModal.form.addEventListener('submit', async (e) => { 
            e.preventDefault(); 
            const newName = changeUsernameModal.input.value.trim();
            const user = state.currentUser;
            if (!newName || !user) return;

            try {
                const userDocRef = doc(usersRef, user.uid);
                await updateDoc(userDocRef, { name: newName });
                
                closeModal(changeUsernameModal.overlay);
                showNotification("Nazwa u偶ytkownika zostaa zmieniona.", "Sukces");
            } catch (error) {
                console.error("Bd podczas zmiany nazwy:", error);
                showNotification("Wystpi bd. Spr贸buj ponownie.", "Bd");
            }
        });

        // --- CZ 4: Logika zmiany hasa (przeniesiona i dostosowana) ---

        changePasswordModal.form.addEventListener('submit', async (e) => { 
            e.preventDefault();
            const currentPassword = changePasswordModal.currentPassword.value;
            const newPassword = changePasswordModal.newPassword.value;
            const confirmPassword = document.getElementById('confirm-password').value;
            const submitBtn = e.target.querySelector('button[type="submit"]');

            if (newPassword !== confirmPassword) {
                changePasswordModal.error.textContent = 'Nowe hasa nie s takie same.';
                return;
            }
            if (newPassword.length < 6) {
                changePasswordModal.error.textContent = 'Nowe haso musi mie co najmniej 6 znak贸w.';
                return;
            }

            changePasswordModal.error.textContent = '';
            submitBtn.disabled = true;
            submitBtn.textContent = 'Zmienianie...';

            const user = auth.currentUser;
            if (!user) {
                changePasswordModal.error.textContent = 'Bd: U偶ytkownik nie jest zalogowany.';
                submitBtn.disabled = false;
                submitBtn.textContent = 'Zmie haso';
                return;
            }

            try {
                const credential = EmailAuthProvider.credential(user.email, currentPassword);
                await reauthenticateWithCredential(user, credential);
                await updatePassword(user, newPassword);
                showNotification("Haso zostao pomylnie zmienione.", "Sukces");
                closeModal(changePasswordModal.overlay);
            } catch (error) {
                console.error("Bd podczas zmiany hasa:", error);
                if (error.code === 'auth/wrong-password') {
                    changePasswordModal.error.textContent = 'Bie偶ce haso jest nieprawidowe.';
                } else if (error.code === 'auth/weak-password') {
                    changePasswordModal.error.textContent = 'Nowe haso jest zbyt sabe.';
                } else {
                    changePasswordModal.error.textContent = 'Wystpi nieoczekiwany bd. Spr贸buj ponownie.';
                }
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Zmie haso';
            }
        });

        const handleBackButtonClick = (e) => {
            e.preventDefault();
            if (state.ui.previousView) {
                state.ui.currentView = state.ui.previousView;
                state.ui.previousView = null;
                state.currentProjectId = null;
                saveUiState();
                render();
            }
        };

        backToProjectsBtn.addEventListener('click', handleBackButtonClick);
        backToProjectsBtnMobile.addEventListener('click', handleBackButtonClick);
        
        editDashboardLayoutBtn.addEventListener('click', async () => {
            if (state.ui.dashboardEditMode) {
                if (sortableDashboard) {
                    const newOrder = sortableDashboard.toArray();
                    state.currentUser.layouts.dashboard = newOrder;
                    try {
                        const userRef = doc(usersRef, state.currentUser.uid);
                        await updateDoc(userRef, { "layouts.dashboard": newOrder });
                        showNotification("Ukad pulpitu zosta zapisany.", "Sukces");
                    } catch (error) {
                        console.error("Bd zapisu ukadu pulpitu:", error);
                        showNotification("Nie udao si zapisa ukadu.", "Bd");
                    }
                }
                state.ui.dashboardEditMode = false;
                // ZMIANA: Dopisek "KPI" w HTML przycisku
                editDashboardLayoutBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 16px; height: 16px;"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" /></svg><span>Edytuj ukad KPI</span>`;
            } else {
                state.ui.dashboardEditMode = true;
                // ZMIANA: Dopisek "KPI" w HTML przycisku
                editDashboardLayoutBtn.innerHTML = `<span>Zapisz ukad KPI</span>`;
            }
            render();
        });


         editProjectsLayoutBtn.addEventListener('click', async () => {
            if (state.ui.allProjectsEditMode) {
                if (sortableProjects) {
                    const newOrder = sortableProjects.toArray();
                    state.currentUser.layouts.allProjects = newOrder;
                    try {
                        const userRef = doc(usersRef, state.currentUser.uid);
                        await updateDoc(userRef, { "layouts.allProjects": newOrder });
                        showNotification("Ukad projekt贸w zosta zapisany.", "Sukces");
                    } catch (error) {
                        console.error("Bd zapisu ukadu projekt贸w:", error);
                        showNotification("Nie udao si zapisa ukadu.", "Bd");
                    }
                }
                state.ui.allProjectsEditMode = false;
                editProjectsLayoutBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 16px; height: 16px;"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" /></svg><span>Edytuj ukad</span>`;
            } else {
                state.ui.allProjectsEditMode = true;
                editProjectsLayoutBtn.innerHTML = `<span>Zapisz ukad</span>`;
            }
            render();
        });
    
       

       
        inviteMemberModal.form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const emailToInvite = inviteMemberModal.emailInput.value.trim();
            if (!emailToInvite) return;

            inviteMemberModal.submitBtn.disabled = true;
            inviteMemberModal.submitBtn.textContent = 'Wysyanie...';
            inviteMemberModal.error.textContent = '';

            try {
                const sendGroupInvite = httpsCallable(functions, 'sendGroupInvite');
                const result = await sendGroupInvite({ 
                    email: emailToInvite,
                    groupId: state.ui.activeGroupId 
                });
                closeModal(inviteMemberModal.overlay);
                showNotification(`Zaproszenie zostao wysane na adres ${emailToInvite}.`, "Sukces");
            } catch (error) {
                console.error("Bd podczas wysyania zaproszenia:", error);
                inviteMemberModal.error.textContent = error.message || "Wystpi nieznany bd.";
            } finally {
                inviteMemberModal.submitBtn.disabled = false;
                inviteMemberModal.submitBtn.textContent = 'Wylij zaproszenie';
            }
        });

        changeSubgroupModal.form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const newSubgroup = changeSubgroupModal.select.value;
            
            // --- Krok 1: Inicjalizacja przycisku i walidacja ---
            const submitBtn = e.target.querySelector('button[type="submit"]');
            
            if (!newSubgroup) {
                showNotification("Musisz wybra dzia z listy.", "Bd");
                return;
            }
            
            submitBtn.disabled = true;
            submitBtn.textContent = 'Zapisywanie...';
            // --- Koniec Kroku 1 ---


            try {
                const userRef = doc(usersRef, state.currentUser.uid);
                
                // Aktualizujemy map 'groupInfo' u偶ywajc notacji kropkowej.
                await updateDoc(userRef, {
                    [`groupInfo.${state.ui.activeGroupId}.subgroup`]: newSubgroup
                });
                
                // Zaktualizuj stan lokalny NATYCHMIAST, aby UI si zgadza
                state.currentUser.groupInfo[state.ui.activeGroupId].subgroup = newSubgroup;
                state.ui.activeGroupInfo.subgroup = newSubgroup;

                closeModal(changeSubgroupModal.overlay);
                showNotification("Dzia zosta pomylnie zaktualizowany.", "Sukces");
                
                // Wymu pene odwie偶enie renderowania (bezpieczniej)
                render(); 

            } catch (error) {
                console.error("Bd aktualizacji podgrupy:", error);
                // Usu blokad i poka偶 bd
                showNotification("Wystpi bd podczas zapisywania zmiany.", "Bd");

            } finally {
                // --- Krok 2: Odblokowanie przycisku w bloku finally ---
                submitBtn.disabled = false;
                submitBtn.textContent = 'Zapisz zmian';
                // --- Koniec Kroku 2 ---
            }
        });

        moveTaskModal.confirmBtn.addEventListener('click', async () => {
            const taskId = moveTaskModal.overlay.dataset.taskId;
            const sourceProjectId = moveTaskModal.overlay.dataset.sourceProjectId;
            const selectedRadio = moveTaskModal.projectList.querySelector('input[name="destination-project"]:checked');

            if (!selectedRadio) {
                showNotification("Prosz wybra projekt docelowy.", "Bd");
                return;
            }
            const destinationProjectId = selectedRadio.value;

            if (!taskId || !sourceProjectId || !destinationProjectId) {
                showNotification("Wystpi bd: Brak potrzebnych informacji do przeniesienia zadania.", "Bd");
                return;
            }

            moveTaskModal.confirmBtn.disabled = true;
            moveTaskModal.confirmBtn.textContent = 'Przenoszenie...';

            try {
                const sourceProjectRef = findProject(sourceProjectId)
                    ? doc(projectsRef, sourceProjectId)
                    : doc(completedProjectsRef, sourceProjectId);
                const sourceProjectSnap = await getDoc(sourceProjectRef);

                if (!sourceProjectSnap.exists()) {
                    throw new Error("Nie znaleziono projektu 藕r贸dowego.");
                }

                const sourceProjectData = sourceProjectSnap.data();
                const taskToMove = (sourceProjectData.tasks || []).find(t => t.id === taskId);

                if (!taskToMove) {
                    throw new Error("Nie znaleziono zadania do przeniesienia w projekcie 藕r贸dowym.");
                }

                const batch = writeBatch(db);

                // 1. Usu zadanie z projektu 藕r贸dowego
                const updatedSourceTasks = (sourceProjectData.tasks || []).filter(t => t.id !== taskId);
                const sourceBudgetSummary = calculateProjectBudgetSummary(updatedSourceTasks); // Przelicz bud偶et 藕r贸da
                batch.update(sourceProjectRef, { 
                    tasks: updatedSourceTasks,
                    budgetSummary: sourceBudgetSummary // Zapisz nowy bud偶et 藕r贸da
                });

                // 2. Dodaj zadanie do projektu docelowego
                const destinationProjectRef = doc(projectsRef, destinationProjectId);
                const destinationProjectSnap = await getDoc(destinationProjectRef); 

                if (!destinationProjectSnap.exists()) {
                     throw new Error("Nie znaleziono projektu docelowego.");
                }
                const destinationProjectData = destinationProjectSnap.data();
                const updatedDestinationTasks = [...(destinationProjectData.tasks || []), taskToMove];
                const destBudgetSummary = calculateProjectBudgetSummary(updatedDestinationTasks); // Przelicz bud偶et celu
                batch.update(destinationProjectRef, { 
                    tasks: updatedDestinationTasks,
                    budgetSummary: destBudgetSummary // Zapisz nowy bud偶et celu
                });

                await batch.commit();

                closeModal(moveTaskModal.overlay);
                closeModal(taskModal.overlay); 

                showNotification("Zadanie zostao pomylnie przeniesione.", "Sukces");
                state.currentProjectId = destinationProjectId;
                state.ui.currentView = 'projects';
                saveUiState();
                render(); 

            } catch (error) {
                console.error("Bd podczas przenoszenia zadania:", error);
                showNotification(`Wystpi bd podczas przenoszenia zadania: ${error.message}`, "Bd");
            } finally {
                moveTaskModal.confirmBtn.disabled = false;
                moveTaskModal.confirmBtn.textContent = 'Przenie';
            }
        });

        const subtasksToggleBtn = document.getElementById('subtasks-toggle-btn');
        const subtasksCollapsibleArea = document.getElementById('subtasks-collapsible-area');
        if (subtasksToggleBtn && subtasksCollapsibleArea) {
            subtasksToggleBtn.addEventListener('click', () => {
                subtasksToggleBtn.classList.toggle('collapsed');
                subtasksCollapsibleArea.classList.toggle('collapsed');
                
                const toggleText = subtasksToggleBtn.querySelector('.toggle-text');
                if (toggleText) {
                    if (subtasksToggleBtn.classList.contains('collapsed')) {
                        toggleText.textContent = 'Rozwi';
                    } else {
                        toggleText.textContent = 'Zwi';
                    }
                }
            });
        }

       // === ZAKTUALIZOWANY LISTENER: Lewa kolumna w Podzadaniu ===
        subtaskModal.assigneesList.addEventListener('click', (e) => {
            const header = e.target.closest('.department-header');
            const pill = e.target.closest('.member-pill:not(.disabled)');

            if (header) {
                const usersContainer = header.nextElementSibling;
                if (usersContainer && usersContainer.classList.contains('department-users')) {
                    header.classList.toggle('active');
                    usersContainer.classList.toggle('collapsed');
                }
            } else if (pill) {
                pill.classList.toggle('selected');
                // Odwie偶 praw kolumn
                renderSelectedMembersColumn(subtaskModal.assigneesList, subtaskModal.selectedList, null, [], []);
            }
        });

        // === NOWY LISTENER: Prawa kolumna w Podzadaniu (Usuwanie) ===
        if (subtaskModal.selectedList) {
            subtaskModal.selectedList.addEventListener('click', (e) => {
                if (e.target.closest('.selected-member-remove')) {
                    const userId = e.target.closest('.selected-member-row')?.dataset.userId;
                    if (userId) {
                        const pill = subtaskModal.assigneesList.querySelector(`.member-pill[data-user-id="${userId}"]`);
                        if (pill) {
                            pill.classList.remove('selected');
                            renderSelectedMembersColumn(subtaskModal.assigneesList, subtaskModal.selectedList, null, [], []);
                        }
                    }
                }
            });
        }

        addSubtaskBtnMain.addEventListener('click', () => {
             const mainTaskId = taskModal.overlay.dataset.taskId;
             if (mainTaskId) { 
                openSubtaskModal(mainTaskId);
             } else {
                 console.error("Brak ID zadania g贸wnego w modalu taskModal");
             }
        });

        subtasksListMain.addEventListener('click', (e) => {
             const checkbox = e.target.closest('.subtask-checkbox');
             const deleteBtn = e.target.closest('.subtask-action-btn.delete');
             // USUNITO: const editBtn = ... (przycisk ju偶 nie istnieje)
             const titleSpan = e.target.closest('.subtask-item-title');

             const subtaskItem = e.target.closest('li[data-subtask-id]'); 
             if (!subtaskItem) return;

             const subtaskId = subtaskItem.dataset.subtaskId;
             const mainTaskId = taskModal.overlay.dataset.taskId; 

             if (!mainTaskId) {
                 console.error("Brak ID zadania g贸wnego przy obsudze listy subzada");
                 return;
             }

             if (checkbox && subtaskId) {
                 handleSubtaskToggle(checkbox, mainTaskId); 
             } else if (deleteBtn && subtaskId) {
                 handleSubtaskDelete(subtaskId, mainTaskId); 
             } else if (titleSpan && subtaskId) { // ZMIANA: Reagujemy tylko na tytu
                 openSubtaskModal(mainTaskId, subtaskId);
             }
        });

        subtaskModal.form.addEventListener('submit', async (e) => {
             e.preventDefault();
             console.log("Pr贸ba zapisu podzadania..."); // DIAGNOSTYKA

             const mainTaskId = subtaskModal.overlay.dataset.mainTaskId;
             const subtaskId = subtaskModal.subtaskIdInput.value; 
             const title = subtaskModal.titleInput.value.trim();

             if (!title) {
                 showNotification("Tytu jest wymagany.", "Bd");
                 return;
             }

             const { task: mainTask, project } = findTask(mainTaskId);
             if (!mainTask || !project) {
                 showNotification("Bd: Nie znaleziono zadania g贸wnego.", "Bd");
                 return;
             }

             subtaskModal.saveBtn.disabled = true;
             subtaskModal.saveBtn.textContent = 'Zapisywanie...';

             
                 try {
                 // --- 1. Zbieranie danych ---
                 subtaskModal.checklistError.style.display = 'none'; // Reset bdu listy kontrolnej
                 const description = subtaskModal.descriptionInput.value;
                 
                 // Skadanie daty rozpoczcia (YYYY-MM-DD + T + HH:MM)
                 let startDate = null;
                 if (subtaskModal.startDateDate.value) {
                     startDate = `${subtaskModal.startDateDate.value}T${subtaskModal.startDateHour.value}:${subtaskModal.startDateMinute.value}`;
                 }

                 // Skadanie terminu wykonania (YYYY-MM-DD + T + HH:MM)
                 let dueDate = null;
                 if (subtaskModal.dueDateDate.value) {
                     dueDate = `${subtaskModal.dueDateDate.value}T${subtaskModal.dueDateHour.value}:${subtaskModal.dueDateMinute.value}`;
                 }
                 
                 // Wysiek
                 const effort = subtaskModal.effortInput.value ? parseFloat(subtaskModal.effortInput.value) : null;
                 const actualEffort = subtaskModal.actualEffortInput.value ? parseFloat(subtaskModal.actualEffortInput.value) : null;
                 
                 // === NOWE: Pobranie statusu i Custom Column ===
                 const rawStatusValue = subtaskModal.statusSelect.value;
                 let newStatus = 'todo';
                 let newCustomColumnId = null;

                 if (rawStatusValue === 'done') {
                     newStatus = 'done';
                 } else if (rawStatusValue === 'todo') {
                     newStatus = 'todo';
                 } else if (rawStatusValue === 'inprogress') {
                     newStatus = 'inprogress';
                     newCustomColumnId = null; // Czyste "W trakcie"
                 } else if (rawStatusValue.startsWith('CUSTOM_COL:')) {
                     // To jest nasza niestandardowa kolumna!
                     newStatus = 'inprogress'; // Technicznie nadal "W trakcie"
                     newCustomColumnId = rawStatusValue.replace('CUSTOM_COL:', ''); // Wycigamy ID
                 }
                 
                const isNowCompletedByStatus = (newStatus === 'done');
                 
                 // === NOWE: Pobranie priorytetu i ostrze偶e ===
                 const priority = subtaskModal.prioritySelect ? subtaskModal.prioritySelect.value : 'medium';
                 const warningOverride = subtaskModal.warningOverride ? subtaskModal.warningOverride.checked : false;
                 let warningDays = null;
                 if (warningOverride && subtaskModal.warningDaysInput) {
                     warningDays = parseInt(subtaskModal.warningDaysInput.value, 10) || 3;
                 }
                 // === KONIEC ===

                 // Osoby (z "eleganckiej" listy piguek)
                 const selectedAssignees = Array.from(subtaskModal.assigneesList.querySelectorAll('.member-pill.selected'))
                                               .map(pill => pill.dataset.userId);
                 
                 if (selectedAssignees.length === 0) {
                     throw new Error("Podzadanie musi by przypisane do co najmniej jednej osoby.");
                 }

                 // === NOWA LOGIKA: ZBIERANIE LISTY KONTROLNEJ ===
                 let checklistData = [];
                 if (subtaskModal.checklistToggle.checked) {
                     const rows = Array.from(subtaskModal.checklistItemsList.querySelectorAll('.checklist-item-row'));
                     
                     for (const row of rows) {
                         const name = row.querySelector('.checklist-input-name').value.trim();
                         const isCompleted = row.querySelector('.checklist-checkbox').checked;
                         const dateVal = row.querySelector('.checklist-input-date').value;
                         const pill = row.querySelector('.checklist-assignee-pill');
                         const assigneeId = pill ? pill.dataset.userId : null;
                         
                         if (name) {
                             // Walidacja daty (musi by w zakresie podzadania)
                             if (dateVal) {
                                 const itemTime = new Date(dateVal).getTime();
                                 // Uproszczona walidacja (tylko dni)
                                 const subStart = startDate ? new Date(startDate.split('T')[0]).getTime() : 0;
                                 const subDue = dueDate ? new Date(dueDate.split('T')[0]).getTime() : Infinity;
                                 
                                 if (itemTime < subStart || itemTime > subDue) {
                                     throw new Error(`Data zadania z listy "${name}" wykracza poza ramy czasowe podzadania.`);
                                 }
                             }
                             
                             checklistData.push({
                                 id: `chk_${Date.now()}_${Math.random().toString(36).substr(2,5)}`,
                                 name,
                                 isCompleted,
                                 date: dateVal,
                                 assigneeId
                             });
                             
                             // Propagacja u偶ytkownika do listy g贸wnej (selectedAssignees)
                             // Jeli u偶ytkownik jest na licie kontrolnej, musi by w podzadaniu
                             if (assigneeId && !selectedAssignees.includes(assigneeId)) {
                                 selectedAssignees.push(assigneeId);
                             }
                         }
                     }
                     
                     // Opcjonalnie: mo偶na rzuci bd, jeli lista wczona ale pusta
                     // if (checklistData.length === 0) ...
                 }
                 // === NOWA LOGIKA: POWIADOMIENIA O PRZYPISANIU DO LISTY KONTROLNEJ ===
                 // Musimy to zrobi teraz, p贸ki mamy dostp do 'checklistData' i kontekstu
                 
                 const checklistNotificationsQueue = [];

                 if (checklistData.length > 0) {
                     // Pobierz star list kontroln (jeli edycja)
                     let oldChecklist = [];
                     if (subtaskId) {
                         const oldSubObj = (mainTask.subtasks || []).find(s => s.id === subtaskId);
                         if (oldSubObj) oldChecklist = oldSubObj.checklist || [];
                     }

                     checklistData.forEach(newItem => {
                         const assigneeId = newItem.assigneeId;
                         
                         // Warunki wysania powiadomienia:
                         // 1. Element ma przypisan osob.
                         // 2. Ta osoba to NIE ja (current user).
                         if (assigneeId && assigneeId !== state.currentUser.uid) {
                             
                             // Sprawd藕, czy to NOWE przypisanie
                             // Szukamy w starej licie elementu o tym samym ID (jeli ID zostao zachowane) lub zakadamy nowe
                             // Uwaga: addChecklistItemUI generuje nowe ID dla nowych wierszy, ale stare wiersze maj stare ID.
                             
                             const oldItem = oldChecklist.find(old => old.id === newItem.id);
                             
                             // Wylij, jeli:
                             // A. To nowy element (brak oldItem)
                             // B. Element istnia, ale nie mia assignee
                             // C. Element istnia, mia assignee, ale INNEGO ni偶 teraz
                             
                             if (!oldItem || !oldItem.assigneeId || oldItem.assigneeId !== assigneeId) {
                                 
                                 checklistNotificationsQueue.push({
                                     recipientId: assigneeId,
                                     itemName: newItem.name
                                 });
                             }
                         }
                     });
                 }
                 // === KONIEC NOWEJ LOGIKI ===

                 // Bud偶et
                 let budgetItems = [];
                 if (subtaskModal.budgetToggle.checked) {
                     subtaskModal.budgetItemsList.querySelectorAll('li.budget-item').forEach(li => {
                         const nameSelect = li.querySelector('.task-budget-item-name');
                         const amountInput = li.querySelector('.task-budget-item-amount');
                         
                         if (nameSelect && amountInput) {
                             const name = nameSelect.value;
                             const amount = parseFloat(amountInput.value);
                             if (name && amount > 0) {
                                 budgetItems.push({ name, amount });
                             }
                         }
                     });
                 }

                 // --- ZMODYFIKOWANA LOGIKA KOMENTARZY ---
                 // Zamiast pobiera z inputa, pobieramy z tymczasowej listy (dla nowego) 
                 // lub ignorujemy (dla edycji, bo ju偶 zapisane przyciskiem Dodaj).
                 
                 let commentsToSave = [];
                 // Sprawd藕 czy w inpucie zosta jaki tekst (u偶ytkownik nie klikn "Dodaj")
                 const leftoverText = subtaskModal.commentInput.value.trim();
                 let leftoverComment = null;
                 if (leftoverText) {
                     leftoverComment = {
                         id: `comm_${Date.now()}_last`,
                         userId: state.currentUser.uid,
                         text: leftoverText,
                         timestamp: Date.now()
                     };
                 }
                 if (subtaskId) {
                     // EDYCJA: Komentarze s ju偶 w bazie (obsu偶one przez przycisk Dodaj). 
                     // Pobieramy aktualne komentarze z obiektu (aby ich nie straci przy nadpisywaniu obiektu)
                     const currentSubtaskObj = mainTask.subtasks.find(s => s.id === subtaskId);
                     commentsToSave = currentSubtaskObj ? (currentSubtaskObj.comments || []) : [];
                 } else {
                     // NOWE: Bierzemy komentarze z listy tymczasowej
                     commentsToSave = [...subtaskStagedComments];
                     
                     // Opcjonalnie: Jeli w inpucie zosta tekst, a u偶ytkownik nie klikn "Dodaj", dodaj go teraz automatycznie
                     const leftoverText = subtaskModal.commentInput.value.trim();
                     if (leftoverText) {
                         commentsToSave.push({
                             id: `comm_${Date.now()}_last`,
                             userId: state.currentUser.uid,
                             text: leftoverText,
                             timestamp: Date.now()
                         });
                     }
                 }
                 // --- KONIEC ZMIANY ---

                 // Przesyanie plik贸w (Staged Files)
                 let newAttachments = [];
                 if (subtaskStagedFiles.length > 0) {
                     subtaskModal.saveBtn.textContent = `Przesyanie plik贸w (${subtaskStagedFiles.length})...`;
                     
                     const uploadPromises = subtaskStagedFiles.map(async file => {
                         // cie偶ka: attachments/PROJECT_ID/MAIN_TASK_ID/subtasks/TIMESTAMP_NAME
                         const path = `attachments/${project.id}/${mainTaskId}/subtasks/${Date.now()}_${file.name}`;
                         const storageRef = ref(storage, path);
                         const snap = await uploadBytes(storageRef, file);
                         const url = await getDownloadURL(snap.ref);
                         return {
                             id: `att_${Date.now()}_${Math.random().toString(36).substr(2,5)}`,
                             name: file.name,
                             url: url,
                             path: path,
                             uploadedBy: state.currentUser.uid,
                             timestamp: Date.now()
                         };
                     });
                     
                     newAttachments = await Promise.all(uploadPromises);
                 }

                 // --- 2. Konstrukcja/Aktualizacja Obiektu Podzadania ---
                 let updatedSubtasks = [...(mainTask.subtasks || [])];
                 let currentUpdatedSubtask = null; // Do u偶ycia po zapisie
                 
                 if (subtaskId) {
                     // === EDYCJA ISTNIEJCEGO ===
                     updatedSubtasks = updatedSubtasks.map(s => {
                         if (s.id === subtaskId) {
                            // ZMIANA: U偶ywamy commentsToSave zamiast scalania newCommentObj
                             const updatedComments = commentsToSave; 
                             const updatedAtts = [...(s.attachments || []), ...newAttachments];
                             
                             // Logika completedBy: filtrujemy ID, kt贸re nie s ju偶 przypisane
                             let currentCompletedBy = (s.completedBy || []).filter(id => selectedAssignees.includes(id));
                             
                             // === NOWE: Synchronizacja statusu z completedBy ===
                             // Jeli ustawiono rcznie na 'done', oznaczamy wszystkich jako ukoczonych
                             if (newStatus === 'done') {
                                 currentCompletedBy = [...selectedAssignees];
                             } 
                             // Jeli zmieniono z 'done' na 'todo/inprogress', a byo w peni ukoczone, 
                             // opcjonalnie mo偶na wyczyci completedBy, ale bezpieczniej zostawi indywidualne odhaczenia.
                             // Jednak dla sp贸jnoci z logik "przeniesienia", jeli przenosz do 'Todo', 
                             // to zazwyczaj oznacza reset. Dla bezpieczestwa - zostawmy stan indywidualny,
                             // chyba 偶e wprost wymuszamy 'todo'.
                             
                             // Obliczamy isCompleted na podstawie SELECTA, a nie tylko checkbox贸w
                             const isNowCompleted = (newStatus === 'done');

                             currentUpdatedSubtask = {
                                 ...s,
                                 title,
                                 description,
                                 startDate,
                                 dueDate,
                                 priority,         // <-- DODANO
                                 warningOverride,  // <-- DODANO
                                 warningDays,      // <-- DODANO
                                 effort,
                                 actualEffort,
                                 budgetItems,
                                 assignees: selectedAssignees,
                                 completedBy: currentCompletedBy,
                                 
                                 // ZAPISUJEMY NOWE POLA
                                 status: newStatus,
                                 // === NAPRAWA: Jeli status to todo/done, czycimy kolumn ===
                                 customColumnId: (newStatus === 'todo' || newStatus === 'done') ? null : newCustomColumnId,
                                 // === KONIEC NAPRAWY ===
                                 isCompleted: isNowCompleted,
                                 
                                 comments: commentsToSave,
                                 attachments: updatedAtts,
                                 checklist: checklistData,
                                 type: selectedAssignees.length > 1 ? 'multi' : 'single'
                             };
                             return currentUpdatedSubtask;
                         }
                         return s;
                     });
                 } else {
                     // === TWORZENIE NOWEGO ===
                     const newSubtask = {
                         id: `sub_${Date.now()}_${Math.random().toString(36).substr(2, 5)}`,
                         title,
                         description,
                         startDate,   
                         dueDate,     
                         priority,        // <-- DODANO
                         warningOverride, // <-- DODANO
                         warningDays,     // <-- DODANO
                         effort,
                         actualEffort,
                         budgetItems,
                         assignees: selectedAssignees,
                         type: selectedAssignees.length > 1 ? 'multi' : 'single', // <--- DODANO TYP
                         // === NOWE ===
                         status: newStatus,
                         // === NAPRAWA ===
                         customColumnId: (newStatus === 'todo' || newStatus === 'done') ? null : newCustomColumnId,
                         // === KONIEC ===
                         isCompleted: (newStatus === 'done'),
                         comments: commentsToSave,
                         attachments: newAttachments,
                         checklist: checklistData, // <--- DODANO NOWE POLE
                         createdBy: state.currentUser.uid,
                         createdAt: Date.now()
                     };
                     updatedSubtasks.push(newSubtask);
                     currentUpdatedSubtask = newSubtask;
                 }

                 // --- 3. Zapis do Firestore ---
                 
                 // === NOWA LOGIKA POWIADOMIE PODZADA ===
                 // Obliczamy, kto zosta nowo przypisany do tego podzadania
                 const oldSubtaskAssignees = subtaskId 
                     ? (mainTask.subtasks.find(s => s.id === subtaskId)?.assignees || []) 
                     : [];
                 const newlyAssignedToSubtask = selectedAssignees.filter(id => !oldSubtaskAssignees.includes(id));

                 if (newlyAssignedToSubtask.length > 0) {
                     const msg = `<strong>${state.currentUser.name}</strong> przypisa/a Ci do podzadania "<strong>${title}</strong>" w zadaniu "${mainTask.title}".`;
                     // Wywoujemy nasz now funkcj (asynchronicznie, nie blokujemy zapisu)
                     sendInternalNotification(
                         newlyAssignedToSubtask, 
                         'task_assigned', 
                         msg, 
                         { type: 'task', projectId: project.id, taskId: mainTask.id },
                         'subtask_assign' // <--- NOWY KLUCZ
                     );
                 }
                 // === KONIEC LOGIKI POWIADOMIE ===

                 // === NOWA LOGIKA: Automatyczne dodawanie os贸b do zadania g贸wnego i projektu ===
                 
                 // Kopia list do modyfikacji
                 let updatedMainAssignees = [...(mainTask.assignees || [])];
                 let updatedProjectMembers = [...(project.members || [])];
                 let mainTaskChanged = false;
                 let projectMembersChanged = false;

                 selectedAssignees.forEach(userId => {
                     // A. Sprawd藕 i dodaj do zadania g贸wnego
                     if (!updatedMainAssignees.includes(userId)) {
                         updatedMainAssignees.push(userId);
                         mainTaskChanged = true;
                     }
                     // B. Sprawd藕 i dodaj do czonk贸w projektu
                     if (!updatedProjectMembers.includes(userId)) {
                         updatedProjectMembers.push(userId);
                         projectMembersChanged = true;
                     }
                 });

                 // Jeli dodano osoby do zadania g贸wnego, sprawd藕 czy zmieni si typ na 'multi'
                 let updatedMainType = mainTask.type;
                 if (mainTaskChanged) {
                     updatedMainType = updatedMainAssignees.length > 1 ? 'multi' : 'single';
                 }
                 // === KONIEC NOWEJ LOGIKI ===

                 // Tworzymy zaktualizowany obiekt zadania g贸wnego, uwzgldniajc nowe podzadania ORAZ nowych wykonawc贸w
                 const updatedTask = { 
                     ...mainTask, 
                     subtasks: updatedSubtasks,
                     assignees: updatedMainAssignees, // Zaktualizowana lista wykonawc贸w
                     type: updatedMainType            // Zaktualizowany typ zadania
                 };
                 
                 const projectDocRef = findProject(project.id) ? doc(projectsRef, project.id) : doc(completedProjectsRef, project.id);
                 const allTasks = project.tasks.map(t => t.id === mainTaskId ? updatedTask : t);
                 
                 // --- NOWA LOGIKA: Przeliczenie bud偶etu projektu ---
                 // Poniewa偶 zmienilimy podzadanie (kt贸re mo偶e mie bud偶et), musimy zaktualizowa globalne podsumowanie
                 const newBudgetSummary = calculateProjectBudgetSummary(allTasks);
                 // --- KONIEC ---

                 // Przygotuj payload do aktualizacji
                 const updatePayload = { 
                     tasks: allTasks,
                     budgetSummary: newBudgetSummary // <--- NAPRAWA: Zapisz nowe podsumowanie
                 };
                 
                 // Jeli dodano nowych czonk贸w do projektu, dodaj ich do payloadu
                 if (projectMembersChanged) {
                     updatePayload.members = updatedProjectMembers;
                 }

                 // Wykonaj aktualizacj w Firestore (zadania + opcjonalnie czonkowie + bud偶et)
                 await updateDoc(projectDocRef, updatePayload);

                 // Jeli zaktualizowano czonk贸w projektu, odwie偶amy te偶 stan lokalny, aby UI od razu to widziao
                 // (onSnapshot i tak to zrobi, ale dla sp贸jnoci wewntrz tej funkcji)
                 if (projectMembersChanged) {
                     project.members = updatedProjectMembers;
                 }

                 // --- 4. Finalizacja ---
                 closeModal(subtaskModal.overlay);
                 
                 // Odwie偶 list podzada w modalu zadania g贸wnego
                 renderSubtaskListInMainModal(updatedTask);
                 
                 // Sprawd藕, czy zmiana podzadania wpywa na ukoczenie zadania g贸wnego
                 await checkAndCompleteMainTask(updatedTask, project);
                 
                 // === NAPRAWA: U偶ywamy nowej nazwy funkcji ===
                 await checkSubtasksAndCompleteParticipants(updatedTask, project);
                // === NOWE: WYSYANIE POWIADOMIE Z KOLEJKI LISTY KONTROLNEJ ===
                 if (checklistNotificationsQueue.length > 0) {
                     console.log(`Wysyanie ${checklistNotificationsQueue.length} powiadomie z listy kontrolnej...`);
                     
                     // Grupujemy powiadomienia, aby nie spamowa fetchami (cho sendInternalNotification jest per user/group)
                     // Tutaj iterujemy po kolejce i wysyamy pojedynczo, bo ka偶dy item ma inn nazw
                     
                     checklistNotificationsQueue.forEach(notif => {
                         // ZMIANA TRECI WIADOMOCI:
                         const msg = `<strong>${state.currentUser.name}</strong> przypisa/a Ci do zadania "<strong>${notif.itemName}</strong>" z listy kontrolnej podzadania "<strong>${title}</strong>".`;
                         
                         sendInternalNotification(
                            [notif.recipientId], // Tablica z jednym ID
                            'checklist_assign', // Typ
                            msg,
                            { type: 'task', projectId: project.id, taskId: mainTask.id }, // Link (otwiera zadanie g贸wne)
                            'checklist_assign' // Klucz preferencji
                         );
                     });
                 }
                 // === KONIEC ===
                 showNotification("Podzadanie zapisane pomylnie.", "Sukces");

             } catch (error) {
                 console.error("Bd zapisu podzadania:", error);
                 showNotification("Wystpi bd: " + error.message, "Bd");
             } finally {
                 subtaskModal.saveBtn.disabled = false;
                 subtaskModal.saveBtn.textContent = 'Zapisz podzadanie';
                 subtaskStagedFiles = []; // Wyczy pliki tymczasowe
             }
        });

        async function handleSubtaskToggle(checkbox, mainTaskId) {
             const subtaskId = checkbox.dataset.subtaskId;
             const { task: mainTask, project } = findTask(mainTaskId);
             if (!mainTask || !project) {
                 console.error("Nie znaleziono zadania g贸wnego lub projektu dla subzadania");
                 return; 
             }

             let updatedTask = { ...mainTask };
             const oldStatus = updatedTask.status; 
             const currentUserId = state.currentUser.uid;

             let subtaskChanged = false;
             
             // Zmienne pomocnicze do przechwycenia stanu z wntrza ptli map
             let optimisticIsMyPartDone = false;
             let optimisticIsFullyCompleted = false;

             updatedTask.subtasks = updatedTask.subtasks.map(s => {
                 if (s.id === subtaskId) {
                     // === BLOKADA: Lista kontrolna ===
                     if (checkbox.checked && s.checklist && s.checklist.length > 0) {
                         const allChecklistDone = s.checklist.every(i => i.isCompleted);
                         if (!allChecklistDone) {
                             showNotification("Nie mo偶na ukoczy podzadania. Ukocz najpierw wszystkie pozycje z listy kontrolnej.", "Bd");
                             checkbox.checked = false; 
                             return s; 
                         }
                     }

                     subtaskChanged = true;

                     // Dodajemy sprawdzanie SuperUsera do Override
                     const isOverride = project.ownerId === currentUserId || 
                                        (project.admins || []).includes(currentUserId) || 
                                        (project.superUsers || []).includes(currentUserId);

                     let newCompletedBy = [...(s.completedBy || [])];
                     let isNowCompleted = s.isCompleted;

                     if (checkbox.checked) {
                         // --- ZAZNACZANIE ---
                         showConfetti(); 

                         if (isOverride) {
                             // ADMIN
                             if (s.assignees.length > 0) {
                                 const allAssigneesSet = new Set([...newCompletedBy, ...s.assignees]);
                                 newCompletedBy = Array.from(allAssigneesSet);
                             } else {
                                 if (!newCompletedBy.includes(currentUserId)) newCompletedBy.push(currentUserId);
                             }
                             isNowCompleted = true; 
                         } else {
                             // USER
                             if (!newCompletedBy.includes(currentUserId)) {
                                 newCompletedBy.push(currentUserId);
                             }
                             const hasAssignees = s.assignees && s.assignees.length > 0;
                             if (hasAssignees) {
                                 isNowCompleted = s.assignees.every(id => newCompletedBy.includes(id));
                             } else {
                                 isNowCompleted = true;
                             }
                         }
                     } else {
                         // --- ODZNACZANIE ---
                         if (isOverride) {
                             newCompletedBy = []; 
                             isNowCompleted = false;
                         } else {
                             newCompletedBy = newCompletedBy.filter(id => id !== currentUserId);
                             isNowCompleted = false; 
                         }
                     }
                     
                     // === NAPRAWA: Synchronizacja statusu tekstowego (Lepsza logika) ===
                     let newSubStatus = 'todo';
                     if (isNowCompleted) {
                         newSubStatus = 'done';
                     } else if (newCompletedBy.length > 0) {
                         newSubStatus = 'inprogress'; // Czciowo wykonane
                     }
                     
                     const newCustomCol = isNowCompleted ? null : s.customColumnId;

                     // === PRZECHWYCENIE STANU DO ZMIENNYCH ZEWNTRZNYCH ===
                     // Sprawdzamy, czy bie偶cy u偶ytkownik znajduje si w nowej licie completedBy
                     optimisticIsMyPartDone = newCompletedBy.includes(currentUserId);
                     optimisticIsFullyCompleted = isNowCompleted;
                     // ======================================================

                     return { 
                         ...s, 
                         completedBy: newCompletedBy, 
                         isCompleted: isNowCompleted,
                         status: newSubStatus, 
                         customColumnId: newCustomCol 
                     };
                 }
                 return s;
             });

             if (!subtaskChanged) return;

             const projectDocRef = findProject(project.id) ? doc(projectsRef, project.id) : doc(completedProjectsRef, project.id);
             const updatedTasks = project.tasks.map(t => (t.id === mainTaskId ? updatedTask : t));

             try {
                const newBudgetSummary = calculateProjectBudgetSummary(updatedTasks);
                
                // === ZMIANA: OPTYMISTYCZNA AKTUALIZACJA UI (Poprawiona) ===
                // 1. Odwie偶 list w modalu (jeli jest otwarty) - to obsuguje list tekstow
                renderSubtaskListInMainModal(updatedTask);

                // 2. Odwie偶 BEZPOREDNIO kliknity element (np. kafelek na Kanbanie lub wiersz w modalu)
                // U偶ywamy zmiennych przechwyconych z ptli, zamiast szuka w tablicy (eliminacja bd贸w odwie偶ania)
                if (checkbox) {
                    // A. Wymu stan checkboxa (Moja cz)
                    checkbox.checked = optimisticIsMyPartDone;

                    // B. Ustaw styl rodzica (Cao ukoczona)
                    const parentCard = checkbox.closest('.subtask-visual-card') || checkbox.closest('.kanban-subtask-item');
                    if (parentCard) {
                        if (optimisticIsFullyCompleted) {
                            parentCard.classList.add('completed');
                        } else {
                            parentCard.classList.remove('completed');
                        }
                    }
                }
                // === KONIEC ZMIANY ===

                // Dopiero teraz wysyamy dane do Firebase
                await updateDoc(projectDocRef, {
                    tasks: updatedTasks,
                    budgetSummary: newBudgetSummary
                });
                 
                 // Sprawdzenia automatyczne po zapisie
                 await checkAndCompleteMainTask(updatedTask, project);
                 await checkSubtasksAndCompleteParticipants(updatedTask, project); 

                 // === NOWE: WYSANIE POWIADOMIE DLA PODZADANIA ===
                 const changedSubtask = updatedTask.subtasks.find(s => s.id === subtaskId);
                 // Sprawd藕, czy podzadanie jest teraz ukoczone (i czy wczeniej nie byo - cho tu trudniej o stan 'prev',
                 // zakadamy, 偶e checkbox toggle zmieni stan na przeciwny. Jeli teraz jest completed, to znaczy 偶e wanie je ukoczylimy).
                 // Dodatkowo sprawdzamy optimisticIsFullyCompleted (zdefiniowane wy偶ej w tej funkcji)
                 if (changedSubtask && optimisticIsFullyCompleted) {
                     sendSubtaskCompletionNotifications(changedSubtask, updatedTask, project);
                 }
                 // === KONIEC ===

         } catch (error) {
             console.error("Bd zapisu stanu subzadania:", error);
             showNotification("Wystpi bd podczas aktualizacji podzadania.", "Bd");
             
             // === ZMIANA: PRZYWRACANIE STANU ===
             // Poniewa偶 lista zostaa przerysowana, stary element 'checkbox' ju偶 nie istnieje w DOM.
             // Musimy przerysowa list u偶ywajc starego obiektu 'mainTask' (stan sprzed kliknicia).
             renderSubtaskListInMainModal(mainTask); 
         }
        }

        async function handleSubtaskDelete(subtaskId, mainTaskId) {
             const { task: mainTask, project } = findTask(mainTaskId);
             if (!mainTask || !project) return;

             const subtaskToDelete = (mainTask.subtasks || []).find(s => s.id === subtaskId);
             if (!subtaskToDelete) return;

             const canDelete = mainTask.createdBy === state.currentUser.uid ||
                               project.ownerId === state.currentUser.uid ||
                               (project.admins || []).includes(state.currentUser.uid) || 
                               (project.superUsers || []).includes(state.currentUser.uid) || // <-- NOWY WARUNEK
                               (subtaskToDelete.assignees || []).includes(state.currentUser.uid);

             if (!canDelete) {
                 showNotification("Nie masz uprawnie do usunicia tego podzadania.", "Bd");
                 return;
             }

             showConfirmation("Potwierd藕 usunicie", `Czy na pewno chcesz usun podzadanie: "${subtaskToDelete.title}"?`, async (confirmed) => {
                 if (confirmed) {
                     // 1. Przygotuj obiekt do archiwizacji w koszu
                     const archivedSubtask = {
                         ...subtaskToDelete,
                         deletedAt: Date.now(),
                         deletedBy: state.currentUser.uid,
                         originalParentId: mainTaskId, // Wa偶ne: zachowujemy ID rodzica, aby wiedzie skd pochodzi
                         originalParentTitle: mainTask.title, // Opcjonalnie: tytu rodzica dla czytelnoci w koszu
                         isSubtask: true // Znacznik, 偶e to podzadanie
                     };

                     // 2. Usu podzadanie z listy w zadaniu g贸wnym
                     const updatedTask = {
                         ...mainTask,
                         subtasks: (mainTask.subtasks || []).filter(s => s.id !== subtaskId)
                     };

                     const projectDocRef = findProject(project.id) ? doc(projectsRef, project.id) : doc(completedProjectsRef, project.id);
                     const updatedTasks = project.tasks.map(t => (t.id === mainTaskId ? updatedTask : t));

                     try {
                         // --- NAPRAWA: Przeliczenie bud偶etu po usuniciu podzadania ---
                         const newBudgetSummary = calculateProjectBudgetSummary(updatedTasks);
                         
                         // 3. Zapisz zmiany: zaktualizuj zadania, bud偶et ORAZ dodaj do kosza
                         await updateDoc(projectDocRef, { 
                             tasks: updatedTasks,
                             budgetSummary: newBudgetSummary,
                             deletedTasks: arrayUnion(archivedSubtask) // Dodajemy do tablicy kosza
                         });
                         // --- KONIEC NAPRAWY ---

                         renderSubtaskListInMainModal(updatedTask); // Odwie偶 list
                         await checkAndCompleteMainTask(updatedTask, project); 
                         
                         showNotification("Podzadanie zostao przeniesione do kosza.", "Sukces");

                     } catch (error) {
                         console.error("Bd usuwania subzadania:", error);
                         showNotification("Bd podczas usuwania podzadania.", "Bd");
                     }
                 }
             }, true);
        }
       /**
         * NOWA FUNKCJA
         * Obsuguje wczanie/wyczanie subskrypcji powiadomie o ukoczeniu zadania.
         * @param {string} taskId - ID zadania
         * @param {string} projectId - ID projektu nadrzdnego
         * @param {HTMLElement} bellElement - Kliknity element dzwonka (dla animacji)
         */
        async function handleTaskSubscription(taskId, projectId, bellElement) {
            const { task, project } = findTask(taskId);
            if (!task || !project) {
                console.error("Nie znaleziono zadania lub projektu do subskrypcji.");
                return;
            }
            
            const currentUserId = state.currentUser.uid;
            const subscribers = task.subscribers || [];
            let updatedSubscribers;
            let isSubscribing = false; // Czy u偶ytkownik wcza dzwonek?

            if (subscribers.includes(currentUserId)) {
                // U偶ytkownik ju偶 subskrybuje -> Anuluj subskrypcj
                updatedSubscribers = subscribers.filter(id => id !== currentUserId);
            } else {
                // U偶ytkownik nie subskrybuje -> Dodaj subskrypcj
                updatedSubscribers = [...subscribers, currentUserId];
                isSubscribing = true;
            }

            // === USUNITO: Natychmiastowa wizualna informacja zwrotna ===
            // (onSnapshot zajmie si zmian koloru)

            try {
                // Zaktualizuj zadanie w bazie danych
                const updatedTask = { ...task, subscribers: updatedSubscribers };
                const updatedTasks = project.tasks.map(t => (t.id === taskId ? updatedTask : t));

                // Okrel, w kt贸rej kolekcji jest projekt
                const projectDocRef = findProject(project.id) 
                    ? doc(projectsRef, project.id) 
                    : doc(completedProjectsRef, project.id);
                
                await updateDoc(projectDocRef, { tasks: updatedTasks });

                // === NOWA LOGIKA DODANA PO AWAIT ===
                if (isSubscribing) {
                    // Czekamy kr贸tki moment (np. 100ms), aby da czas onSnapshot
                    // na przerysowanie interfejsu (render()).
                    setTimeout(() => {
                        // Znajd藕 w DOM dzwonek, kt贸ry zosta wanie przerysowany
                        const newBellElement = document.querySelector(`.task-subscription-bell[data-task-id="${taskId}"]`);
                        
                        if (newBellElement) {
                            // Dodaj klas animacji do NOWEGO elementu
                            newBellElement.classList.add('animate-ring');
                            
                            // Ustaw usunicie klasy animacji po jej zakoczeniu
                            setTimeout(() => {
                                if (newBellElement) {
                                     newBellElement.classList.remove('animate-ring');
                                }
                            }, 700); // Czas trwania animacji + bufor
                        }
                    }, 100); // Bufor na re-render
                }
                // === KONIEC NOWEJ LOGIKI ===
                
            } catch (error) {
                console.error("Bd podczas aktualizacji subskrypcji zadania:", error);
                showNotification("Bd zapisu subskrypcji.", "Bd");
                // Bd: Musimy odwie偶y widok, aby cofn zmian, jeli onSnapshot nie zadziaa
                render(); 
            }
            
            // Ju偶 nie potrzebujemy lokalnej manipulacji klasami,
            // onSnapshot zajmie si zmian koloru, a logika powy偶ej animacj.
        }
       /**
         * NOWA FUNKCJA: Obsuguje subskrypcj PODZADANIA.
         */
        async function handleSubtaskSubscription(mainTaskId, subtaskId, bellElement) {
            const { task: mainTask, project } = findTask(mainTaskId);
            if (!mainTask || !project) return;

            const currentUserId = state.currentUser.uid;
            let isSubscribing = false;

            // Tworzymy kopi zadania g贸wnego i aktualizujemy konkretne podzadanie
            const updatedSubtasks = mainTask.subtasks.map(sub => {
                if (sub.id === subtaskId) {
                    const subscribers = sub.subscribers || [];
                    let newSubscribers;

                    if (subscribers.includes(currentUserId)) {
                        // Wypisz si
                        newSubscribers = subscribers.filter(id => id !== currentUserId);
                    } else {
                        // Zapisz si
                        newSubscribers = [...subscribers, currentUserId];
                        isSubscribing = true;
                    }
                    
                    return { ...sub, subscribers: newSubscribers };
                }
                return sub;
            });

            const updatedMainTask = { ...mainTask, subtasks: updatedSubtasks };

            try {
                // Zapisz do Firestore
                const updatedTasks = project.tasks.map(t => (t.id === mainTaskId ? updatedMainTask : t));
                const projectDocRef = findProject(project.id) ? doc(projectsRef, project.id) : doc(completedProjectsRef, project.id);
                
                await updateDoc(projectDocRef, { tasks: updatedTasks });

                // Animacja (jeli wczono)
                if (isSubscribing) {
                    // Czekamy kr贸tki moment (100ms), aby da czas onSnapshot na przerysowanie interfejsu
                    setTimeout(() => {
                        // Znajd藕 w DOM NOWY dzwonek, kt贸ry zosta wanie przerysowany
                        const newBellElement = document.querySelector(`.subtask-subscription-bell[data-subtask-id="${subtaskId}"]`);
                        
                        if (newBellElement) {
                            newBellElement.classList.add('animate-ring');
                            setTimeout(() => newBellElement.classList.remove('animate-ring'), 700);
                        }
                    }, 100);
                }

            } catch (error) {
                console.error("Bd subskrypcji podzadania:", error);
                showNotification("Bd zapisu subskrypcji.", "Bd");
            }
        }
       /**
         * NOWA FUNKCJA
         * Wysya powiadomienia do wszystkich subskrybent贸w danego zadania.
         * @param {object} task - Obiekt ukoczonego zadania.
         * @param {object} project - Obiekt projektu nadrzdnego.
         */
        async function sendCompletionNotifications(task, project) {
            if (!task.subscribers || task.subscribers.length === 0) {
                return; // Brak subskrybent贸w, zakocz
            }

            const completerUser = findUser(state.currentUser.uid); // Kto ukoczy zadanie
            const completerName = completerUser ? (completerUser.name || completerUser.email) : 'Kto';

            // Filtruj list subskrybent贸w:
            // 1. Usu osob, kt贸ra wanie ukoczya zadanie (偶eby nie dostaa powiadomienia od samej siebie)
            const subscribersToNotify = task.subscribers.filter(id => id !== state.currentUser.uid);

            if (subscribersToNotify.length === 0) {
                return; // Nikt do powiadomienia
            }

            console.log(`Wysyanie ${subscribersToNotify.length} powiadomie o ukoczeniu zadania: ${task.title}`);

            try {
                const batch = writeBatch(db);
                const notificationsRef = collection(db, `artifacts/${appId}/public/data/notifications`);
                
                subscribersToNotify.forEach(userId => {
                    const notification = {
                        userId: userId, // ID odbiorcy
                        creatorId: state.currentUser.uid, // ID osoby, kt贸ra ukoczya zadanie
                        type: 'task_completed', // NOWY TYP
                        message: `Zadanie "<strong>${task.title}</strong>", kt贸re obserwujesz, zostao ukoczone przez <strong>${completerName}</strong>.`,
                        isRead: false,
                        timestamp: Date.now(),
                        groupId: project.groupId, // ID grupy z projektu
                        link: { type: 'task', projectId: project.id, taskId: task.id }
                    };
                    const newNotifRef = doc(notificationsRef);
                    batch.set(newNotifRef, notification);
                });
                
                await batch.commit();

            } catch (error) {
                console.error("Bd podczas wysyania powiadomie o ukoczeniu zadania:", error);
                // Nie pokazujemy bdu u偶ytkownikowi, tylko logujemy w konsoli
            }
        }
       /**
         * NOWA FUNKCJA: Wysya powiadomienia o ukoczeniu PODZADANIA.
         */
        async function sendSubtaskCompletionNotifications(subtask, mainTask, project) {
            if (!subtask.subscribers || subtask.subscribers.length === 0) return;

            const completerUser = findUser(state.currentUser.uid);
            const completerName = completerUser ? (completerUser.name || completerUser.email) : 'Kto';

            // Filtruj subskrybent贸w (nie wysyaj do siebie)
            const recipients = subtask.subscribers.filter(id => id !== state.currentUser.uid);

            if (recipients.length === 0) return;

            const msg = `Podzadanie "<strong>${subtask.title}</strong>" (w zadaniu "${mainTask.title}") zostao ukoczone przez <strong>${completerName}</strong>.`;

            // U偶ywamy uniwersalnej funkcji wysyania
            // Reuse typu 'task_completed' lub dodaj nowy w getNotificationIcon jeli chcesz inn ikon
            await sendInternalNotification(
                recipients,
                'task_completed', // Typ
                msg,
                { type: 'task', projectId: project.id, taskId: mainTask.id }, // Link otwiera g贸wne zadanie
                'subtask_assign' // U偶ywamy preferencji dot. podzada (lub stw贸rz now 'subtask_subscription')
            );
        }
       /**
         * NOWA FUNKCJA (ZAKTUALIZOWANA): Sprawdza postp WSZYSTKICH uczestnik贸w.
         * Jeli u偶ytkownik ukoczy wszystkie swoje podzadania, jego cz zadania g贸wnego jest zaliczana.
         * Dziaa zar贸wno dla currentUser, jak i dla innych (gdy admin edytuje).
         */
        async function checkSubtasksAndCompleteParticipants(mainTask, project) {
            if (!mainTask || !project || mainTask.type !== 'multi' || mainTask.status === 'done') {
                return;
            }

            let updatedTask = { ...mainTask };
            let hasChanges = false;
            const oldStatus = updatedTask.status;
            const usersWhoCompleted = [];

            // Iterujemy po wszystkich przypisanych do zadania g贸wnego
            for (const userId of updatedTask.assignees) {
                // Jeli ten u偶ytkownik ju偶 ma zaliczone zadanie g贸wne, pomijamy
                if ((updatedTask.completedBy || []).includes(userId)) continue;

                // Znajd藕 podzadania przypisane do tego konkretnego u偶ytkownika
                const userSubtasks = (updatedTask.subtasks || []).filter(s => (s.assignees || []).includes(userId));

                // Jeli u偶ytkownik nie ma 偶adnych podzada, pomijamy (nie zaliczamy automatem pustych)
                if (userSubtasks.length === 0) continue;

                // Sprawd藕, czy WSZYSTKIE jego podzadania s przez niego ukoczone
                const allDone = userSubtasks.every(s => (s.completedBy || []).includes(userId));

                if (allDone) {
                    // Zaliczamy cz tego u偶ytkownika!
                    updatedTask.completedBy = [...(updatedTask.completedBy || []), userId];
                    hasChanges = true;
                    usersWhoCompleted.push(userId);
                }
            }

            if (!hasChanges) return; // Brak zmian, wychodzimy

            // Przelicz status zadania g贸wnego
            const isMainTaskNowCompleted = updatedTask.assignees.every(id => updatedTask.completedBy.includes(id));

            if (isMainTaskNowCompleted) {
                updatedTask.status = 'done';
            } else if (updatedTask.completedBy.length > 0) {
                updatedTask.status = 'inprogress';
            }

            // Logowanie zmian statusu
            if (updatedTask.status !== oldStatus) {
                if (updatedTask.status === 'done') showConfetti();
                updatedTask = addActivity(updatedTask, 'status', STATUSES[oldStatus], STATUSES[updatedTask.status]);
            }
            
            // Dodajemy log aktywnoci (technicznie robi to "system" w imieniu u偶ytkownika/admina)
            // U偶ywamy typu 'completion', ale uwaga: w historii pojawi si, 偶e zrobi to Current User (Admin)
            updatedTask = addActivity(updatedTask, 'completion'); 

            // Zapisz zmiany
            await handleTaskCompletion(updatedTask, project, 'subtask_auto');
            
            console.log(`[Auto-Complete] System automatycznie ukoczy cz zadania dla: ${usersWhoCompleted.join(', ')}`);

            // Odwie偶 modal, jeli jest otwarty i dotyczy tego zadania
            if (taskModal.overlay.dataset.taskId === mainTask.id && taskModal.overlay.classList.contains('visible')) {
                openTaskModal(mainTask.id);
            }
        }
        async function checkAndCompleteMainTask(mainTask, project) {
             if (!mainTask || !project) {
                 console.warn(`checkAndCompleteMainTask: Otrzymano nieprawidowe dane zadania lub projektu.`);
                 return;
             }
             
             // Jeli zadanie ju偶 jest 'done', nie ma co robi
             if (mainTask.status === 'done') return;

             // Sprawd藕 czy wszystkie podzadania s completed
             const allSubtasksDone = mainTask.subtasks && mainTask.subtasks.length > 0 && mainTask.subtasks.every(s => s.isCompleted);

             // Automatyczne koczenie dziaa tylko dla zada typu 'single' (jednoosobowych)
             if (allSubtasksDone && mainTask.type === 'single') {
                  const oldStatus = mainTask.status;
                  let updatedTask = { ...mainTask };

                  updatedTask.status = 'done';

                  // Logujemy zmian statusu
                  updatedTask = addActivity(updatedTask, 'status', STATUSES[oldStatus], STATUSES.done);

                  try {
                        // Wykonujemy fizyczne zakoczenie zadania w bazie
                        await handleTaskCompletion(updatedTask, project, 'subtask_auto');
                        showConfetti();

                        // === NAPRAWA: U偶ywamy mainTask.id zamiast nieistniejcego mainTaskId ===
                        // Odwie偶amy modal tylko jeli jest otwarty i dotyczy tego zadania
                        if (taskModal.overlay.classList.contains('visible') && taskModal.overlay.dataset.taskId === mainTask.id) {
                            setTimeout(() => openTaskModal(mainTask.id), 100);
                        }

                  } catch (error) {
                       console.error("Bd podczas automatycznego koczenia zadania g贸wnego (single):", error);
                  }
             }
        }

        async function loadAndRenderTemplates() {
            if (!state.currentUser) return;
            templatesModal.list.innerHTML = '<li>adowanie...</li>';

            try {
                const q = query(templatesRef, where("ownerId", "==", state.currentUser.uid), orderBy("name"));
                const snapshot = await getDocs(q);
                state.projectTemplates = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderTemplatesList();

                if (state.selectedTemplateId && state.projectTemplates.some(t => t.id === state.selectedTemplateId)) {
                    renderTemplateDetails(state.selectedTemplateId);
                } else {
                    state.selectedTemplateId = null;
                    templatesModal.detailsTitle.textContent = 'Wybierz szablon';
                    templatesModal.detailsContent.innerHTML = '<p style="color: var(--text-secondary); text-align: center; margin-top: 40px;">Wybierz szablon z listy po lewej, aby zobaczy szczeg贸y lub utworzy nowy.</p>';
                    templatesModal.editBtn.style.display = 'none';
                    templatesModal.deleteBtn.style.display = 'none';
                    templatesModal.createProjectBtn.disabled = true;
                }
            } catch (error) {
                console.error("Bd adowania szablon贸w:", error);
                templatesModal.list.innerHTML = '<li>Bd adowania szablon贸w.</li>';
                showNotification("Nie udao si wczyta listy szablon贸w.", "Bd");
            }
        }

       function renderTemplatesList() {
            if (state.projectTemplates.length === 0) {
                templatesModal.list.innerHTML = '<li><em style="color: var(--text-secondary);">Brak zapisanych szablon贸w.</em></li>';
                return;
            }
            templatesModal.list.innerHTML = state.projectTemplates.map(template => `
                <li class="nav-item">
                    <a href="#" data-template-id="${template.id}" class="${template.id === state.selectedTemplateId ? 'active' : ''}">
                         <span>${template.name}</span> 
                    </a>
                </li>
            `).join(''); 
        }

        function renderTemplateDetails(templateId) {
            const template = state.projectTemplates.find(t => t.id === templateId);

            if (!template) {
                 state.selectedTemplateId = null;
                 renderTemplatesList();
                 templatesModal.detailsTitle.textContent = 'Wybierz szablon';
                 templatesModal.detailsContent.innerHTML = '<p style="color: var(--text-secondary); text-align: center; margin-top: 40px;">Wybrany szablon nie istnieje.</p>';
                 templatesModal.editBtn.style.display = 'none';
                 templatesModal.deleteBtn.style.display = 'none';
                 templatesModal.createProjectBtn.disabled = true;
                 return; 
            }

            state.selectedTemplateId = templateId;
            renderTemplatesList();

            templatesModal.detailsTitle.textContent = template.name;
            let detailsHTML = '';
            if (template.description) {
                detailsHTML += `<h4>Opis</h4><p style="white-space: pre-wrap; margin-bottom: 20px;">${template.description}</p>`;
            } else {
                 detailsHTML += `<p style="color: var(--text-secondary); margin-bottom: 20px;"><em>Brak opisu.</em></p>`;
            }
            detailsHTML += `<h4>Zadania (${(template.tasks || []).length})</h4>`;
            if (template.tasks && template.tasks.length > 0) {
                detailsHTML += `<ul style="list-style: disc; padding-left: 20px; max-height: 300px; overflow-y: auto;">`;
                template.tasks.forEach(taskTitle => {
                    detailsHTML += `<li>${taskTitle}</li>`;
                });
                detailsHTML += `</ul>`;
            } else {
                detailsHTML += `<p style="color: var(--text-secondary);"><em>Brak zada w szablonie.</em></p>`;
            }

            templatesModal.detailsContent.innerHTML = detailsHTML;
            templatesModal.editBtn.style.display = 'block';
            templatesModal.deleteBtn.style.display = 'block';
            templatesModal.createProjectBtn.disabled = false;
        }
   
       const resourcesMenu = document.getElementById('resources-menu');
        const openTemplatesBtnMenu = document.getElementById('open-templates-btn-menu');
        const openArchiveBtnMenu = document.getElementById('open-archive-btn-menu');

        // === NOWA, POPRAWIONA LOGIKA KLIKNICIA DLA "ZASOBY" ===
       

        resourcesBtn.addEventListener('click', (e) => {
            e.stopPropagation();

            const isDesktop = window.innerWidth > 768;
            const isCollapsed = appContainer.classList.contains('sidebar-collapsed');

            // Zawsze przeczaj klas .open
            resourcesBtn.classList.toggle('open');
            resourcesMenu.classList.toggle('open');

            // === DODANA LOGIKA: Zamykanie innych menu (jak w przycisku "Grupy") ===
            const groupMenu = document.getElementById('group-switcher-menu');
            if (groupMenu && groupMenu.classList.contains('open')) {
                groupMenu.classList.remove('open');
                document.getElementById('group-switcher-toggle').classList.remove('open');
            }
            const favMenu = document.getElementById('favorites-flyout-menu');
            if (favMenu && favMenu.classList.contains('open')) {
                favMenu.classList.remove('open');
            }
            // === KONIEC DODANEJ LOGIKI ===

            if (isDesktop && isCollapsed) {
                // --- SCENARIUSZ 1: Desktop, Sidebar ZWINITY (NAPRAWIONA LOGIKA POZYCJONOWANIA) ---
                const rect = resourcesBtn.getBoundingClientRect();
                resourcesMenu.style.position = 'absolute';
                
                // Logika otwierania w g贸r (skopiowana z przycisku 'Grupy')
                const menuHeight = 120; // Szacowana wysoko menu (2 przyciski * ~60px)
                if (rect.top + menuHeight > window.innerHeight) {
                     // Otw贸rz w g贸r
                     resourcesMenu.style.top = 'auto';
                     resourcesMenu.style.bottom = '5px'; // Lekki odstp od dou
                } else {
                     // Otw贸rz w d贸 (standardowo)
                     resourcesMenu.style.top = `${rect.top}px`;
                     resourcesMenu.style.bottom = 'auto';
                }
                
                resourcesMenu.style.left = '72px';
                resourcesMenu.style.width = '220px'; // Staa szeroko z CSS
                resourcesMenu.style.zIndex = 3000;
                
            } else if (!isDesktop) {
                // --- SCENARIUSZ 3: Mobile (DODANY BRAKUJCY BLOK) ---
                // Na mobilnym, menu jest czci sidebara, ale jest ukryte przez 'max-height: 0'
                // Musimy wyczyci style inline, aby 'max-height: 120px' z CSS zadziaao
                resourcesMenu.style.cssText = ''; 
                
            } else {
                // --- SCENARIUSZ 2: Desktop, Sidebar ROZWINITY ---
                // Wyczy style inline
                resourcesMenu.style.cssText = ''; 
            }
        });
        // Zamykanie menu "Zasoby" po klikniciu poza nim (TYLKO w trybie flyout)
        document.addEventListener('click', (e) => {
            if (resourcesBtn && resourcesMenu && 
                resourcesMenu.classList.contains('flyout-open') && 
                !resourcesBtn.contains(e.target) && 
                !resourcesMenu.contains(e.target)) 
            {
                resourcesMenu.classList.remove('flyout-open');
                resourcesBtn.classList.remove('open');
            }
        });
        // === KONIEC NOWEJ LOGIKI KLIKNICIA ===

        openTemplatesBtnMenu.addEventListener('click', async () => {
            openModal(templatesModal.overlay);
            await loadAndRenderTemplates();
            resourcesBtn.classList.remove('open');
            resourcesMenu.classList.remove('open');
        });

        openArchiveBtnMenu.addEventListener('click', () => {
            state.currentProjectId = null;
            state.ui.previousView = state.ui.currentView; 
            state.ui.currentView = 'archive'; 
            state.ui.isCalendarView = false;
            saveUiState();
            render(); 
            
            resourcesBtn.classList.remove('open');
            resourcesMenu.classList.remove('open');

            if (window.innerWidth <= 768) {
                sidebar.classList.remove('open');
                sidebarOverlay.classList.remove('visible');
            }
        });
       templatesModal.list.addEventListener('click', (e) => {
             e.preventDefault(); 
             const link = e.target.closest('a[data-template-id]');
             if (link) {
                 const templateId = link.dataset.templateId;
                 renderTemplateDetails(templateId);
             }
        });

        templatesModal.addNewBtn.addEventListener('click', () => {
             templateEditModal.form.reset();
             templateEditModal.title.textContent = 'Nowy Szablon Projektu';
             templateEditModal.idInput.value = ''; 
             templateEditModal.tasksList.innerHTML = '<li class="template-task-item-empty" style="font-style: italic; color: var(--text-secondary); font-size: 13px;">Brak zada.</li>'; 
             openModal(templateEditModal.overlay);
        });

        templateEditModal.addTaskBtn.addEventListener('click', () => {
            const taskTitle = prompt("Wpisz tytu nowego zadania:");
            if (taskTitle && taskTitle.trim()) {
                 const taskId = `temp_task_${Date.now()}`; 
                 const li = document.createElement('li');
                 li.dataset.taskId = taskId;
                 li.innerHTML = `
                     <input type="text" value="${taskTitle.trim()}" class="template-task-input" style="width: calc(100% - 30px); border: none; background: transparent; padding: 4px; font-size: 14px;">
                     <button type="button" class="delete-template-task-btn" style="background: none; border: none; color: var(--danger-primary); cursor: pointer; float: right;">&times;</button>
                 `;
                 
                 const emptyMsg = templateEditModal.tasksList.querySelector('.template-task-item-empty');
                 if (emptyMsg) {
                     emptyMsg.remove();
                 }
                 
                 templateEditModal.tasksList.appendChild(li);
            }
        });

        templateEditModal.tasksList.addEventListener('click', (e) => {
            if (e.target.classList.contains('delete-template-task-btn')) {
                e.target.closest('li').remove();
                 if (templateEditModal.tasksList.children.length === 0) {
                     templateEditModal.tasksList.innerHTML = '<li class="template-task-item-empty" style="font-style: italic; color: var(--text-secondary); font-size: 13px;">Brak zada.</li>';
                 }
            }
        });
    

   templateEditModal.form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const templateId = templateEditModal.idInput.value; 
            const name = templateEditModal.nameInput.value.trim();
            const description = templateEditModal.descriptionTextarea.value.trim();

            if (!name) {
                showNotification("Nazwa szablonu jest wymagana.", "Bd");
                return;
            }

            const tasks = Array.from(templateEditModal.tasksList.querySelectorAll('li:not(.template-task-item-empty)'))
                .map(li => li.querySelector('.template-task-input').value.trim())
                .filter(Boolean); 

            const templateData = {
                name: name,
                description: description,
                tasks: tasks,
                ownerId: state.currentUser.uid 
            };

            templateEditModal.saveBtn.disabled = true;
            templateEditModal.saveBtn.textContent = 'Zapisywanie...';

            try {
                if (templateId) {
                    const templateRef = doc(templatesRef, templateId);
                    await updateDoc(templateRef, templateData);
                    showNotification("Szablon zosta zaktualizowany.", "Sukces");
                    state.selectedTemplateId = templateId; 
                } else {
                    const docRef = await addDoc(templatesRef, templateData);
                    showNotification("Nowy szablon zosta zapisany.", "Sukces");
                    state.selectedTemplateId = docRef.id; 
                }
                closeModal(templateEditModal.overlay);
                await loadAndRenderTemplates();
            } catch (error) {
                console.error("Bd zapisu szablonu:", error);
                showNotification("Wystpi bd podczas zapisywania szablonu.", "Bd");
            } finally {
                templateEditModal.saveBtn.disabled = false;
                templateEditModal.saveBtn.textContent = 'Zapisz Szablon';
            }
        });


    templatesModal.editBtn.addEventListener('click', () => {
            if (!state.selectedTemplateId) return;
            const template = state.projectTemplates.find(t => t.id === state.selectedTemplateId);
            if (!template) return;

            templateEditModal.form.reset();
            templateEditModal.title.textContent = 'Edytuj Szablon Projektu';
            templateEditModal.idInput.value = template.id;
            templateEditModal.nameInput.value = template.name;
            templateEditModal.descriptionTextarea.value = template.description || '';

            if (template.tasks && template.tasks.length > 0) {
                 templateEditModal.tasksList.innerHTML = template.tasks.map(taskTitle => {
                     const taskId = `temp_task_${Date.now()}_${Math.random()}`; 
                     return `<li data-task-id="${taskId}">
                                <input type="text" value="${taskTitle}" class="template-task-input" style="width: calc(100% - 30px); border: none; background: transparent; padding: 4px; font-size: 14px;">
                                <button type="button" class="delete-template-task-btn" style="background: none; border: none; color: var(--danger-primary); cursor: pointer; float: right;">&times;</button>
                            </li>`;
                 }).join('');
            } else {
                 templateEditModal.tasksList.innerHTML = '<li class="template-task-item-empty" style="font-style: italic; color: var(--text-secondary); font-size: 13px;">Brak zada.</li>';
            }

            openModal(templateEditModal.overlay);
        });

        templatesModal.deleteBtn.addEventListener('click', () => {
            if (!state.selectedTemplateId) return;
            const template = state.projectTemplates.find(t => t.id === state.selectedTemplateId);
            if (!template) return;

            showConfirmation(
                "Potwierd藕 usunicie szablonu",
                `Czy na pewno chcesz usun szablon "${template.name}"? Tej operacji nie mo偶na cofn.`,
                async (confirmed) => {
                    if (confirmed) {
                        try {
                            const templateRef = doc(templatesRef, template.id);
                            await deleteDoc(templateRef);
                            showNotification("Szablon zosta usunity.", "Sukces");
                            state.selectedTemplateId = null; 
                            await loadAndRenderTemplates(); 
                        } catch (error) {
                            console.error("Bd usuwania szablonu:", error);
                            showNotification("Wystpi bd podczas usuwania szablonu.", "Bd");
                        }
                    }
                },
                true 
            );
        });
        
        templatesModal.createProjectBtn.addEventListener('click', () => {
            if (!state.selectedTemplateId) return;
            const template = state.projectTemplates.find(t => t.id === state.selectedTemplateId);
            if (!template) return;

            closeModal(templatesModal.overlay);

            newProjectModal.form.reset();
            newProjectModal.descriptionTextarea.value = template.description || '';
            buildTeamMembersAccordion(newProjectModal.membersContainer, [state.currentUser.uid]);

            newProjectModal.form.dataset.templateTasks = JSON.stringify(template.tasks || []);
            newProjectModal.nameInput.value = template.name;

            openModal(newProjectModal.overlay);
        });
       // === POCZTEK ZMIANY: Nowa funkcja przeczajca panel AI ===
        function toggleAiChatPanel() {
            // === NOWA LINIA: Pobranie referencji do g贸wnego kontenera ===
            const appContainer = document.querySelector('.app-container');
            const isOpen = aiHelpModal.sidebar.classList.contains('open');

            if (isOpen) {
                // Zamykanie panelu
                aiHelpModal.sidebar.classList.remove('open');
                // === NOWA LINIA: Usunicie klasy z kontenera nadrzdnego ===
                if (appContainer) appContainer.classList.remove('ai-panel-is-open');
                
                // === NOWA INTEGRACJA: ZATRZYMAJ ROZMOW ===
                if (isConversationModeActive) {
                    aiHelpModal.micBtn.click(); // Symuluj kliknicie, aby wyczy tryb
                } else {
                    // Jeli tryb nie by aktywny, i tak przerwij mow/nasuch
                    if (speechSynthesisInstance) speechSynthesisInstance.cancel();
                    stopListening();
                }
                // === KONIEC NOWEJ INTEGRACJI ===
                
            } else {
                // Otwieranie panelu
                aiChatHistory = [];
                aiHelpModal.container.innerHTML = '';
                
                const firstBotMessage = "Cze! Jestem Twoim asystentem. Jak mog Ci pom贸c w obsudze aplikacji TeamFlow lub w analizie Twoich danych?";
                addAiChatMessage(firstBotMessage, 'bot');
                
                aiChatHistory.push({ role: 'bot', text: firstBotMessage });
                
                aiHelpModal.sidebar.classList.add('open');
                // === NOWA LINIA: Dodanie klasy do kontenera nadrzdnego ===
                if (appContainer) appContainer.classList.add('ai-panel-is-open');
                aiHelpModal.input.focus();
            }
        }
        // === KONIEC ZMIANY ===

   // === POCZTEK ZMIANY: U偶ycie nowej funkcji ===
        aiHelpModal.openBtn.addEventListener('click', toggleAiChatPanel);
        // === KONIEC ZMIANY ===

        // === POCZTEK ZMIANY: U偶ycie nowej funkcji ===
        aiHelpModal.closeBtn.addEventListener('click', toggleAiChatPanel);
        // === KONIEC ZMIANY ===
        
        aiHelpModal.form.addEventListener('submit', async (e) => {
        e.preventDefault();
        // === POPRAWIONA INTEGRACJA: PRZERWIJ MOW/NASUCH ===
        
        // Jeli AI wanie m贸wi, a u偶ytkownik wysya now wiadomo (rcznie lub gosem),
        // po prostu przerwij mow AI. Flaga 'userInterruptedSpeech'
        // zostanie ustawiona tylko wtedy, gdy u偶ytkownik rcznie WYCZY tryb.
        if (speechSynthesisInstance.speaking) {
            speechSynthesisInstance.cancel();
        }
        
        // Niezale偶nie od wszystkiego, flaga 'userInterruptedSpeech' powinna by 'false'
        // podczas normalnego cyklu zapytanie-odpowied藕.
        // Zostanie ustawiona na 'true' tylko przez kliknicie przycisku mikrofonu.
        userInterruptedSpeech = false;

        // stopListening(); // Nadal niepotrzebne, 'onresult' ju偶 to zrobio
        updateAiChatStatus('processing'); // Rcznie ustaw status przetwarzania
        // === KONIEC POPRAWIONEJ INTEGRACJI ===
        const question = aiHelpModal.input.value.trim();
        if (!question) return;

        aiHelpModal.input.value = '';
        aiHelpModal.input.disabled = true;
        aiHelpModal.sendBtn.disabled = true;

        addAiChatMessage(question, 'user');

        // KROK 1.3: Dodanie pytania u偶ytkownika do historii
        aiChatHistory.push({ role: 'user', text: question });

        // === POCZTEK ZMIANY: Ustalanie kontekstu projektu i roli ===
        let contextProjectId = null;
        let userProjectRole = null; // 'owner', 'admin', 'member', lub null

        // Sprawdzamy, czy jestemy aktualnie w widoku konkretnego projektu
        if (state.currentProjectId && state.ui.currentView === 'projects') {
            const project = findProject(state.currentProjectId);
            if (project) {
                contextProjectId = project.id;
                
                // Sprawdzamy rol (Waciciel ma najwy偶szy priorytet, potem Admin)
                if (project.ownerId === state.currentUser.uid) {
                    userProjectRole = 'owner';
                } else if ((project.admins || []).includes(state.currentUser.uid)) {
                    userProjectRole = 'admin';
                } else if (project.members.includes(state.currentUser.uid)) {
                    userProjectRole = 'member';
                }
                // Jeli u偶ytkownik nie jest czonkiem (teoretycznie niemo偶liwe), rola pozostanie null
            }
        }
        // === KONIEC ZMIANY ===

        const loadingMessageId = `msg_${Date.now()}`;
        addAiChatMessage("Myl...", 'loading', loadingMessageId);

        try {
            const askGemini = httpsCallable(functions, 'askGemini');

            // KROK 1.4: Wysanie historii (ostatnie 4 wiadomoci) do funkcji
            const result = await askGemini({ 
                question: question, // Nadal wysyamy samo pytanie
                history: aiChatHistory.slice(-5, -1), // Wylij 4 wiadomoci PRZED ostatnim pytaniem
                groupId: state.ui.activeGroupId,

                // === POCZTEK ZMIANY: Przekazanie nowego kontekstu do Cloud Function ===
                projectId: contextProjectId,
                userRole: userProjectRole
                // === KONIEC ZMIANY ===
            });

            const response = result.data.response;

        // KROK 1.5: Dodanie odpowiedzi bota do historii
        aiChatHistory.push({ role: 'bot', text: response });
        
        // Opcjonalnie: Utrzymuj histori w rozsdnym rozmiarze (np. 10 ostatnich wiadomoci)
        if (aiChatHistory.length > 10) {
            aiChatHistory = aiChatHistory.slice(-10);
        }

        const loadingBubble = document.getElementById(loadingMessageId);
        if (loadingBubble) loadingBubble.remove();

        addAiChatMessage(response, 'bot');
        
        // === NOWA INTEGRACJA: ODTWRZ ODPOWIED殴 GOSOWO ===
        speakResponse(response);
        // === KONIEC NOWEJ INTEGRACJI ===

    } catch (error) {
        console.error("Bd wywoania Cloud Function 'askGemini':", error);
        const loadingBubble = document.getElementById(loadingMessageId);
        if (loadingBubble) loadingBubble.remove();
        addAiChatMessage(`Przepraszam, wystpi bd serwera: ${error.message}. Spr贸buj ponownie.`, 'bot');
    } finally {
        aiHelpModal.input.disabled = false;
        aiHelpModal.sendBtn.disabled = false;
        aiHelpModal.input.focus();
    }
});

function addAiChatMessage(text, type, id = null) {
    const messageDiv = document.createElement('div');
    messageDiv.className = `ai-chat-message ${type}`;
    if (id) messageDiv.id = id;

    // === POCZTEK ZMIANY: Logika tworzenia awatar贸w (z poprawn nazw .png) ===
    let avatarHTML = '';
    if (type === 'bot' || type === 'loading') { // Poka偶 ikon AI tak偶e przy adowaniu
        // Dla bota: u偶yj ikony TeamFlowAI.png
        avatarHTML = `<img src="TeamFlowAI.png" alt="AI Assistant" class="avatar avatar-comment">`;
    } else { // type === 'user'
        // Dla u偶ytkownika: u偶yj funkcji renderAvatarHTML (obsuguje zdjcie lub inicjay)
        avatarHTML = renderAvatarHTML(state.currentUser, 'avatar-comment');
    }
    messageDiv.insertAdjacentHTML('beforeend', avatarHTML);
    // === KONIEC ZMIANY ===

    // Tworzenie dymka (bubble)
    const bubbleDiv = document.createElement('div');
    bubbleDiv.className = 'ai-chat-bubble';

    let bubbleContent = '';
    if (type === 'loading') {
        bubbleContent = `<div class="ai-spinner"></div> <span>${text}</span>`;
    } else {
        // U偶ywamy .replace() do bezpiecznego wstawienia tekstu
        bubbleContent = text.replace(/\n/g, '<br>');
    }
    bubbleDiv.innerHTML = bubbleContent;
    messageDiv.appendChild(bubbleDiv);

    aiHelpModal.container.appendChild(messageDiv);
    
    // Auto-scroll
    aiHelpModal.container.scrollTop = aiHelpModal.container.scrollHeight;
}
       // === NOWE FUNKCJE: ROZMOWA GOSOWA AI (Web API) ===

        /**
         * Aktualizuje wska藕nik statusu w panelu AI.
         * @param {string} status 'idle', 'listening', 'processing', 'speaking'
         * @param {string} [text=null] Opcjonalny tekst do wywietlenia
         */
        function updateAiChatStatus(status, text = null) {
            if (!aiHelpModal.statusBar) return;

            aiHelpModal.statusBar.classList.remove('listening', 'processing', 'speaking');
            
            switch (status) {
                case 'listening':
                    aiHelpModal.statusBar.classList.add('listening');
                    aiHelpModal.statusBar.textContent = text || "Sucham... (m贸w teraz)";
                    break;
                case 'processing':
                    aiHelpModal.statusBar.classList.add('processing');
                    aiHelpModal.statusBar.textContent = text || "Przetwarzam... (czekaj)";
                    break;
                case 'speaking':
                    aiHelpModal.statusBar.classList.add('speaking');
                    aiHelpModal.statusBar.textContent = text || "M贸wi...";
                    break;
                case 'error':
                    aiHelpModal.statusBar.classList.add('processing'); // U偶yj stylu processing dla bd贸w
                    aiHelpModal.statusBar.textContent = text || "Bd";
                    break;
                default: // idle
                    aiHelpModal.statusBar.textContent = "Tryb gosowy wyczony";
            }
        }

        /**
         * Inicjalizuje SpeechRecognition i SpeechSynthesis API.
         * Wywoywane tylko, jeli nie wykryto Median.
         */
        function initVoiceConversation() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            
            if (!SpeechRecognition || !speechSynthesisInstance) {
                console.warn("Web Speech API (Recognition lub Synthesis) nie jest wspierane w tej przegldarce.");
                aiHelpModal.micBtn.style.display = 'none'; // Ukryj przycisk, jeli API nie dziaa
                aiHelpModal.statusBar.style.display = 'none'; // Ukryj status
                return;
            }

            // Inicjalizacja Rozpoznawania Mowy
            speechRecognitionInstance = new SpeechRecognition();
            speechRecognitionInstance.lang = 'pl-PL'; // Ustaw jzyk polski
            speechRecognitionInstance.interimResults = false; // Nie potrzebujemy wynik贸w porednich
            speechRecognitionInstance.continuous = false; // Kluczowe: Tryb cigy jest niestabilny. Bdziemy restartowa rcznie.
            speechRecognitionInstance.maxAlternatives = 1;

            // Inicjalizacja Syntezy Mowy (gos)
            speechUtteranceInstance = new SpeechSynthesisUtterance();
            speechUtteranceInstance.lang = 'pl-PL';
            speechUtteranceInstance.rate = 1.0;
            speechUtteranceInstance.pitch = 1.0;

            // === NOWA LOGIKA: Dynamiczne ustawianie gosu (USTAWIENIA MODAL) ===
            
            // Referencje do element贸w w nowym modalu ustawie
            const aiSettingsModal = document.getElementById('ai-settings-modal');
            const aiVoiceSelect = document.getElementById('ai-voice-select');
            const aiVoiceTestBtn = document.getElementById('ai-voice-test-btn');
            // Referencja do przycisku "rubki" w nag贸wku panelu AI
            const aiSettingsBtn = document.getElementById('ai-settings-btn');

            const populateVoiceList = () => {
                const voices = speechSynthesisInstance.getVoices();
                aiVoiceSelect.innerHTML = ''; // Wyczy list
                
                const polishVoices = voices.filter(voice => voice.lang === 'pl-PL');
                
                if (polishVoices.length === 0) {
                    console.warn("Nie znaleziono 偶adnych polskich gos贸w (pl-PL).");
                    aiSettingsBtn.style.display = 'none'; // Ukryj "rubk"
                    return;
                }

                // Wypenij list <select> w modalu ustawie
                polishVoices.forEach(voice => {
                    const option = document.createElement('option');
                    option.value = voice.name;
                    option.textContent = voice.name.replace('Microsoft ', '').replace(' Online (Natural) - Polish (Poland)', '');
                    aiVoiceSelect.appendChild(option);
                });

                // Zaaduj zapisany gos (lub Paulin, lub fallback)
                const savedVoiceName = localStorage.getItem('teamflow-ai-voice');
                let selectedVoice = null;
                if (savedVoiceName) {
                    selectedVoice = polishVoices.find(v => v.name === savedVoiceName);
                }
                if (!selectedVoice) {
                    selectedVoice = polishVoices.find(v => v.name.includes('Paulina'));
                }
                if (!selectedVoice) {
                    selectedVoice = polishVoices[0];
                }

                // Ustaw wybrany gos w <select> i w syntezatorze
                if (selectedVoice) {
                    aiVoiceSelect.value = selectedVoice.name;
                    speechUtteranceInstance.voice = selectedVoice;
                    console.log(`Ustawiono domylny gos: ${selectedVoice.name}`);
                }
                
                // Poka偶 przycisk "rubki"
                aiSettingsBtn.style.display = 'inline-flex';
            };

            speechSynthesisInstance.onvoiceschanged = populateVoiceList;
            if (speechSynthesisInstance.getVoices().length > 0) {
                populateVoiceList();
            }
            
            // Listener otwierajcy modal ustawie AI
            aiSettingsBtn.addEventListener('click', () => {
                openModal(aiSettingsModal);
            });

            // Listener do zmiany gosu przez u偶ytkownika (tylko zapisuje, nie odtwarza)
            aiVoiceSelect.addEventListener('change', (e) => {
                const selectedVoiceName = e.target.value;
                const voices = speechSynthesisInstance.getVoices();
                const newVoice = voices.find(v => v.name === selectedVoiceName);
                
                if (newVoice) {
                    // Ustaw gos dla przyszych odpowiedzi
                    speechUtteranceInstance.voice = newVoice;
                    // Zapisz wyb贸r
                    localStorage.setItem('teamflow-ai-voice', newVoice.name);
                    console.log(`Zmieniono i zapisano gos na: ${newVoice.name}`);
                }
            });
            
            // NOWY Listener dla przycisku "Play" (Testuj gos)
            aiVoiceTestBtn.addEventListener('click', () => {
                // Znajd藕 aktualnie wybrany gos (mo偶e by inny ni偶 w instancji, jeli u偶ytkownik zmieni, a nie zapisa)
                const selectedVoiceName = aiVoiceSelect.value;
                const newVoice = speechSynthesisInstance.getVoices().find(v => v.name === selectedVoiceName);

                if (newVoice) {
                    // Upewnij si, 偶e instancja u偶ywa DOKADNIE tego gosu do testu
                    speechUtteranceInstance.voice = newVoice;
                    // Zapisz ten wyb贸r w localStorage od razu po tecie
                    localStorage.setItem('teamflow-ai-voice', newVoice.name);
                    
                    // Przerwij mow, jeli AI akurat m贸wia co innego
                    speechSynthesisInstance.cancel(); 
                    
                    // Odtw贸rz pr贸bk
                    speechUtteranceInstance.text = 'Testuj wybrany gos.';
                    speechSynthesisInstance.speak(speechUtteranceInstance);
                } else {
                    console.error("Nie mo偶na znale藕 wybranego gosu do testu.");
                }
            });
            // === KONIEC NOWEJ LOGIKI ===

            // --- LISTENERY GOSOWE ---

            // --- LISTENERY GOSOWE ---

            // Kliknicie przycisku Mikrofonu
            aiHelpModal.micBtn.addEventListener('click', () => {
                isConversationModeActive = !isConversationModeActive; // Przecz tryb
                aiHelpModal.micBtn.classList.toggle('active', isConversationModeActive);

                if (isConversationModeActive) {
                    console.log("Tryb rozmowy: WCZONY");
                    userInterruptedSpeech = false;
                    startListening();
                } else {
                    console.log("Tryb rozmowy: WYCZONY");
                    stopListening();
                    speechSynthesisInstance.cancel(); // Przerwij mow AI
                    updateAiChatStatus('idle');
                }
            });

            // Rozpoczcie nasuchu
            speechRecognitionInstance.onstart = () => {
                console.log("SpeechRecognition: Start");
                updateAiChatStatus('listening');
            };

            // Zakoczenie nasuchu (wa偶ne!)
            speechRecognitionInstance.onend = () => {
                console.log("SpeechRecognition: End");
                // Jeli tryb rozmowy jest nadal aktywny (tzn. u偶ytkownik go nie wyczy rcznie),
                // ale nasuch si zakoczy (np. z powodu bdu, ciszy, koca zdania),
                // uruchom go ponownie.
                if (isConversationModeActive) {
                    // Nie restartuj, jeli AI wanie zaczyna m贸wi
                    if (!speechSynthesisInstance.speaking) {
                        console.log("SpeechRecognition: Restartowanie nasuchu (tryb cigy)...");
                        startListening();
                    }
                } else {
                    updateAiChatStatus('idle'); // Nasuch zakoczony, bo tryb wyczony
                }
            };

            // Wykryto mow
            speechRecognitionInstance.onresult = (event) => {
                const transcript = event.results[event.results.length - 1][0].transcript.trim();
                console.log("SpeechRecognition: Wykryto tekst:", transcript);
                
                if (transcript) {
                    // Mamy tekst, zatrzymaj nasuch na czas przetwarzania
                    stopListening();
                    updateAiChatStatus('processing');
                    
                    // Wylij tekst do AI (symulujc wysanie formularza)
                    aiHelpModal.input.value = transcript;
                    aiHelpModal.form.dispatchEvent(new Event('submit'));
                }
            };

            // Bdy rozpoznawania
            speechRecognitionInstance.onerror = (event) => {
                console.warn("SpeechRecognition: Bd:", event.error);
                if (event.error === 'no-speech' || event.error === 'audio-capture') {
                    // 'no-speech' to normalne, po prostu cisza.
                    // 'audio-capture' mo偶e oznacza brak uprawnie.
                    updateAiChatStatus('error', 'Nie sysz. Sprawd藕 mikrofon.');
                } else if (event.error === 'not-allowed') {
                    updateAiChatStatus('error', 'Brak uprawnie do mikrofonu.');
                    stopListening(); // Wycz tryb
                }
                // 'onend' automatycznie zrestartuje nasuch (jeli tryb jest aktywny)
            };

            // Zakoczenie mowy AI (syntezy)
            speechUtteranceInstance.onend = () => {
                console.log("SpeechSynthesis: Zakoczono m贸wi.");
                updateAiChatStatus('idle');
                // Jeli u偶ytkownik nie przerwa rozmowy (np. klikajc mikrofon w trakcie mowy AI)
                // i tryb cigy jest aktywny, uruchom nasuch ponownie.
                if (isConversationModeActive && !userInterruptedSpeech) {
                    startListening();
                }
                userInterruptedSpeech = false;
            };
        }

        /**
         * Bezpiecznie uruchamia nasuch (SpeechRecognition).
         */
        function startListening() {
            if (!speechRecognitionInstance || !isConversationModeActive) return;
            
            // Jeli AI wanie m贸wi, nie wczaj nasuchu (poczekaj na onend syntezy)
            if (speechSynthesisInstance.speaking) {
                console.log("SpeechRecognition: Wstrzymano start (AI m贸wi)");
                return;
            }

            try {
                // Rozpocznij nasuch
                speechRecognitionInstance.start();
            } catch (e) {
                // Obsuga bdu, jeli .start() zostanie wywoane, gdy ju偶 dziaa
                console.warn("SpeechRecognition: Bd przy pr贸bie start():", e.message);
            }
        }

        /**
         * Bezpiecznie zatrzymuje nasuch.
         */
        function stopListening() {
            if (!speechRecognitionInstance) return;
            
            try {
                // Zatrzymaj nasuch
                speechRecognitionInstance.stop();
            } catch (e) {
                // Obsuga bdu (jeli nie dziaa)
                console.warn("SpeechRecognition: Bd przy pr贸bie stop():", e.message);
            }
        }

        /**
         * Odtwarza odpowied藕 tekstow AI za pomoc SpeechSynthesis.
         * @param {string} textToSpeak Tekst odpowiedzi od AI.
         */
        function speakResponse(textToSpeak) {
            if (!speechSynthesisInstance || !speechUtteranceInstance) return;

            // Jeli u偶ytkownik wyczy rozmow, nie odtwarzaj odpowiedzi
            if (!isConversationModeActive) return;

            // Zatrzymaj nasuch na czas m贸wienia
            stopListening();
            updateAiChatStatus('speaking');

            // Usu ewentualne formatowanie Markdown (np. **, ##), kt贸re 藕le brzmi
            const cleanText = textToSpeak
                .replace(/###|##|#/g, '')
                .replace(/\*\*(.*?)\*\*/g, '$1')
                .replace(/\*(.*?)\*/g, '$1');

            speechUtteranceInstance.text = cleanText;
            speechSynthesisInstance.speak(speechUtteranceInstance);
        }

        // === KONIEC NOWYCH FUNKCJI ===
       // === POCZTEK ZMIANY: Logika Modala Powitalnego ===

/**
 * Otwiera modal powitalny.
 */
function openWelcomeModal() {
    openModal(welcomeModal.overlay);
}

// Listener dla przycisku "OK" w modalu powitalnym
welcomeModal.okBtn.addEventListener('click', async () => {
    // Sprawd藕, czy checkbox "Nie pokazuj wicej" jest zaznaczony
    if (welcomeModal.dontShowCheckbox.checked) {
        // Jeli tak, zaktualizuj preferencje u偶ytkownika w Firestore
        try {
            const userRef = doc(usersRef, state.currentUser.uid);
            await updateDoc(userRef, {
                showWelcomeModal: false // Ustaw flag na false
            });
            // Zaktualizuj r贸wnie偶 stan lokalny
            state.currentUser.showWelcomeModal = false;
        } catch (error) {
            console.error("Bd podczas zapisywania preferencji 'showWelcomeModal':", error);
            // Nie blokujemy u偶ytkownika, po prostu zamykamy modal
        }
    }
    
    // Zamknij modal
    closeModal(welcomeModal.overlay);
});

// === KONIEC ZMIANY ===

        const createFirstGroupModal = {
            overlay: document.getElementById('create-first-group-modal'),
            form: document.getElementById('create-first-group-form'),
            input: document.getElementById('first-group-name'),
            logoutBtn: document.getElementById('logout-from-first-group-modal')
        };
        
        const createNewGroupModal = {
            overlay: document.getElementById('create-new-group-modal'),
            form: document.getElementById('create-new-group-form'),
            input: document.getElementById('new-group-name')
        };
        
        

        createFirstGroupModal.form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const groupName = createFirstGroupModal.input.value.trim();
            if (!groupName) return;

            const user = auth.currentUser;
            if (!user) {
                showNotification("Bd: U偶ytkownik nie jest zalogowany.", "Bd");
                return;
            }
            
            const submitBtn = e.target.querySelector('button[type="submit"]');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Tworzenie...';
            
            try {
                const batch = writeBatch(db);
                
                const newGroupRef = doc(groupsRef); 
                const newGroupId = newGroupRef.id;
                batch.set(newGroupRef, {
                    name: groupName,
                    ownerId: user.uid,
                    memberIds: [user.uid], 
                    subgroups: []
                });

                const userRef = doc(usersRef, user.uid);
                batch.set(userRef, {
                    groupIds: [newGroupId],
                    groupInfo: {
                        [newGroupId]: {
                            name: groupName,
                            role: "owner",
                            subgroup: null
                        }
                    },
                    lastActiveGroupId: newGroupId
                }, { merge: true }); 
                
                const inboxProject = {
                    name: "Skrzynka zada",
                    ownerId: user.uid,
                    members: [user.uid],
                    tasks: [],
                    isInbox: true,
                    createdAt: Date.now(),
                    groupId: newGroupId 
                };
                const newProjectRef = doc(projectsRef); 
                batch.set(newProjectRef, inboxProject);

                await batch.commit();
                
                console.log(`Stworzono pierwsz grup: ${groupName} (${newGroupId}) dla u偶ytkownika ${user.uid}`);
                
                closeModal(createFirstGroupModal.overlay);
                window.location.reload(); 

            } catch (error) {
                console.error("Bd podczas tworzenia pierwszej grupy:", error);
                showNotification("Wystpi bd: " + error.message, "Bd");
                submitBtn.disabled = false;
                submitBtn.textContent = 'Stw贸rz grup i kontynuuj';
            }
        });
        
        createFirstGroupModal.logoutBtn.addEventListener('click', (e) => {
            e.preventDefault();
            signOut(auth);
        });

        createNewGroupModal.form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const groupName = createNewGroupModal.input.value.trim();
            if (!groupName) return;

            // Nie potrzebujemy ju偶 `state.currentUser`, funkcja chmurowa pobierze go z kontekstu
            
            const submitBtn = e.target.querySelector('button[type="submit"]');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Tworzenie...';

            try {
                // === NOWA LOGIKA: Wywoanie Cloud Function ===
                // 1. Uzyskaj referencj do funkcji chmurowej
                const createNewGroup = httpsCallable(functions, 'createNewGroup');
                
                // 2. Wywoaj funkcj z nazw grupy
                const result = await createNewGroup({ groupName: groupName });
                
                // 3. Odbierz dane (jeli funkcja zwr贸cia sukces)
                const { newGroupId, newGroupName } = result.data;
                // === KONIEC NOWEJ LOGIKI ===
                
                console.log(`Stworzono now grup: ${newGroupName} (${newGroupId})`);

                // 4. Zaktualizuj stan lokalny na podstawie odpowiedzi z serwera
                state.currentUser.groupIds.push(newGroupId);
                state.currentUser.groupInfo[newGroupId] = { name: newGroupName, role: "owner", subgroup: null };
                state.currentUser.lastActiveGroupId = newGroupId; // Zapisz te偶 lastActiveGroupId

                closeModal(createNewGroupModal.overlay);
                handleGroupSwitch(newGroupId); // Przecz na nowo utworzon grup

            } catch (error) {
                // Bdy (np. "already-exists") bd teraz przychodzi z funkcji chmurowej
                console.error("Bd podczas tworzenia nowej grupy:", error);
                showNotification(error.message, "Bd");
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Stw贸rz grup';
                createNewGroupModal.form.reset(); 
            }
        });
        
        
        
       groupSwitcher.menu.addEventListener('click', (e) => {
            const groupItem = e.target.closest('.group-menu-item');
            const createBtn = e.target.closest('#create-group-btn');
            const manageBtn = e.target.closest('#manage-groups-btn');
            const joinBtn = e.target.closest('#join-group-btn');
            const leaveBtn = e.target.closest('#leave-group-btn');
            const inviteBtn = e.target.closest('#invite-member-menu-btn'); // <-- DODANA TA LINIA

            if (groupItem) {
                const newGroupId = groupItem.dataset.groupId;
                handleGroupSwitch(newGroupId); 
            }
            // === POCZTEK NOWEGO BLOKU ===
            else if (leaveBtn) {
                const groupToLeave = state.ui.activeGroupInfo;
                if (!groupToLeave) return;

                showConfirmation(
                    `Opu grup "${groupToLeave.name}"`,
                    "Czy na pewno chcesz opuci t grup? Utracisz dostp do wszystkich jej projekt贸w i zada. Ta akcja jest nieodwracalna.",
                    async (confirmed) => {
                        if (confirmed) {
                            loadingOverlay.style.display = 'flex'; // Poka偶 ekran adowania
                            try {
                                const leaveGroup = httpsCallable(functions, 'leaveGroup');
                                await leaveGroup({ groupId: state.ui.activeGroupId });
                                
                                // Sukces - przeaduj aplikacj, aby onAuthStateChanged
                                // znalazo now aktywn grup (lub pokazao modal tworzenia)
                                window.location.reload();

                            } catch (error) {
                                console.error("Bd podczas opuszczania grupy:", error);
                                showNotification(error.message, "Bd");
                                loadingOverlay.style.display = 'none'; // Ukryj adowanie w razie bdu
                            }
                        }
                    },
                    true // true = przycisk potwierdzenia jest czerwony
                );
            }
            // === KONIEC NOWEGO BLOKU ===
            // === NOWY BLOK DLA ZAPROSZENIA ===
            else if (inviteBtn) {
                inviteMemberModal.form.reset(); 
                inviteMemberModal.error.textContent = ''; 
                openModal(inviteMemberModal.overlay); 
                inviteMemberModal.emailInput.focus();
            }
            // === KONIEC NOWEGO BLOKU ===
            // === DODANY BLOK DLA TWORZENIA GRUPY (NAPRAWA BDU) ===
            else if (createBtn) {
                createNewGroupModal.form.reset();
                openModal(createNewGroupModal.overlay);
                createNewGroupModal.input.focus();
            }
            // === KONIEC DODANEGO BLOKU ===
            else if (joinBtn) {
                joinGroupModal.form.reset();
                joinGroupModal.error.textContent = '';
                openModal(joinGroupModal.overlay);
                joinGroupModal.input.focus();
            }
            // === KONIEC NOWEJ LINII ===
            else if (manageBtn) {
                 openManageGroupModal();
            }
            
            groupSwitcher.toggle.classList.remove('open');
            groupSwitcher.menu.classList.remove('open');
        });
        
        const joinGroupModal = {
            overlay: document.getElementById('join-group-modal'),
            form: document.getElementById('join-group-form'),
            input: document.getElementById('join-group-name-input'),
            error: document.getElementById('join-group-error'),
            submitBtn: document.querySelector('#join-group-form button[type="submit"]')
        };

        const waitingRoom = {
            overlay: document.getElementById('waiting-room-overlay'),
            logoutBtn: document.getElementById('logout-from-waiting-room')
        };
        
        joinGroupModal.form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const groupName = joinGroupModal.input.value.trim();
            if (!groupName) return;
            
            // Nie potrzebujemy ju偶 `state.currentUser`, funkcja sama pobierze ID

            joinGroupModal.submitBtn.disabled = true;
            joinGroupModal.submitBtn.textContent = 'Wysyanie...';
            joinGroupModal.error.textContent = '';

            // Nie potrzebujemy ju偶 `requestsRef` ani `groupsRef` po stronie klienta

            try {
                // === NOWA LOGIKA: Wywoanie Cloud Function ===
                // 1. Uzyskaj referencj do funkcji chmurowej
                const requestToJoinGroup = httpsCallable(functions, 'requestToJoinGroup');

                // 2. Wywoaj funkcj z nazw grupy
                const result = await requestToJoinGroup({ groupName: groupName });
                
                // 3. Odbierz komunikat o sukcesie
                closeModal(joinGroupModal.overlay);
                showNotification(result.data.message, "Sukces");
                // === KONIEC NOWEJ LOGIKI ===

            } catch (error) {
                // Bdy (np. "not-found", "already-exists") przyjd z funkcji chmurowej
                joinGroupModal.error.textContent = error.message;
            } finally {
                joinGroupModal.submitBtn.disabled = false;
                joinGroupModal.submitBtn.textContent = 'Wylij prob';
            }
        });

        waitingRoom.logoutBtn.addEventListener('click', (e) => {
            e.preventDefault();
            unsubscribeAllListeners(); 
            signOut(auth);
        });

        manageGroupModal.overlay.addEventListener('click', (e) => {
            const tabBtn = e.target.closest('.modal-tab-btn');
            if (!tabBtn) return;
            
            const tabContainer = tabBtn.closest('.modal-tabs');
            const contentContainer = tabBtn.closest('.modal').querySelector('.form-modal-content');
            
            tabContainer.querySelectorAll('.modal-tab-btn').forEach(btn => btn.classList.remove('active'));
            contentContainer.querySelectorAll('.modal-tab-content').forEach(content => content.classList.remove('active'));
            
            tabBtn.classList.add('active');
            const tabId = tabBtn.dataset.tab;
            contentContainer.querySelector(`#${tabId}`).classList.add('active');
        }); 
       // === POCZTEK: NOWE FUNKCJE I LISTENERY DLA ZALE呕NOCI ===

        /**
         * Otwiera modal wyboru zadania blokujcego.
         */
        function openTaskDependencyModal(dependentTaskId) {
            const { task, project } = findTask(dependentTaskId);
            if (!task || !project) return;

            const modal = document.getElementById('task-dependency-modal');
            const title = modal.querySelector('#task-dependency-title');
            const intro = modal.querySelector('#task-dependency-intro');
            const listContainer = modal.querySelector('#dependency-task-list');
            const confirmBtn = modal.querySelector('#confirm-dependency-btn');

            title.textContent = `Powi偶 zadanie`;
            intro.innerHTML = `Wybierz zadanie, kt贸re musi zosta ukoczone, zanim bdzie mo偶na ukoczy zadanie: "<strong>${task.title}</strong>".`;
            
            // Filtruj list:
            // 1. Musi by w tym samym projekcie
            // 2. Nie mo偶e by samym sob (dependentTaskId)
            // 3. Nie mo偶e by ju偶 ukoczone ('done')
            // 4. Nie mo偶e by zadaniem, kt贸re JU呕 jest blokowane przez 'task' (aby unikn cyklicznych zale偶noci)
            const availableTasks = (project.tasks || []).filter(t => 
                t.id !== dependentTaskId && 
                t.status !== 'done' &&
                t.blockingTaskId !== dependentTaskId 
            );

            if (availableTasks.length === 0) {
                listContainer.innerHTML = '<p style="color: var(--text-secondary); padding: 10px;">Brak dostpnych zada do powizania w tym projekcie.</p>';
                confirmBtn.disabled = true;
            } else {
                listContainer.innerHTML = availableTasks.map(t => {
                    return `
                        <div class="project-selection-item">
                            <label>
                                <input type="radio" name="blocking-task" value="${t.id}">
                                ${t.title}
                            </label>
                        </div>
                    `;
                }).join('');
                confirmBtn.disabled = true; // Pozostaje wyczony, dop贸ki u偶ytkownik czego nie wybierze
            }
            
            modal.dataset.dependentTaskId = dependentTaskId; // Zapisz ID zadania, kt贸re edytujemy
            openModal(modal);
        }

        /**
         * Obsuguje usunicie powizania.
         */
        function handleTaskUnlink(dependentTaskId) {
            const { task, project } = findTask(dependentTaskId);
            if (!task || !project) return;

            // === DODANA WERYFIKACJA UPRAWNIE ===
            if (!task.dependency || state.currentUser.uid !== task.dependency.setByUserId) {
                showNotification("Nie masz uprawnie do usunicia tego powizania. Mo偶e to zrobi tylko osoba, kt贸ra je utworzya.", "Bd");
                return;
            }
            // === KONIEC WERYFIKACJI ===

            showConfirmation(
                "Usu powizanie",
                "Czy na pewno chcesz usun zale偶no tego zadania? Bdzie mo偶na je ukoczy w dowolnym momencie.",
                async (confirmed) => {
                    if (confirmed) {
                        try {
                            // === ZMIANA: Ustawiamy 'dependency' na null ===
                            const updatedTask = { ...task, dependency: null };
                            // === KONIEC ZMIANY ===
                            const updatedTasks = project.tasks.map(t => t.id === dependentTaskId ? updatedTask : t);
                            
                            const projectDocRef = findProject(project.id) ? doc(projectsRef, project.id) : doc(completedProjectsRef, project.id);
                            await updateDoc(projectDocRef, { tasks: updatedTasks });
                            
                            // Nie trzeba render(), onSnapshot to zrobi
                            showNotification("Powizanie zostao usunite.", "Sukces");

                        } catch (error) {
                            console.error("Bd podczas usuwania powizania:", error);
                            showNotification("Wystpi bd.", "Bd");
                        }
                    }
                },
                true // Czerwony przycisk
            );
        }

        // Listener dla modala zale偶noci (wyb贸r + przycisk)
        document.getElementById('task-dependency-modal').addEventListener('click', async (e) => {
            const confirmBtn = e.target.closest('#confirm-dependency-btn');
            const radio = e.target.closest('input[name="blocking-task"]');
            
            const modal = document.getElementById('task-dependency-modal');
            const modalConfirmBtn = modal.querySelector('#confirm-dependency-btn');

            if (radio) {
                // U偶ytkownik wybra radio, wcz przycisk zapisu
                modalConfirmBtn.disabled = false;
            }
            
            if (confirmBtn && !confirmBtn.disabled) {
                // U偶ytkownik klikn "Utw贸rz powizanie"
                const dependentTaskId = modal.dataset.dependentTaskId;
                const selectedRadio = modal.querySelector('input[name="blocking-task"]:checked');
                
                if (!dependentTaskId || !selectedRadio) {
                    showNotification("Prosz wybra zadanie z listy.", "Bd");
                    return;
                }
                
                const blockingTaskId = selectedRadio.value;
                
                const { task, project } = findTask(dependentTaskId);
                if (!task || !project) {
                    showNotification("Bd: Nie znaleziono zadania 藕r贸dowego.", "Bd");
                    return;
                }
                
                confirmBtn.disabled = true;
                confirmBtn.textContent = 'Zapisywanie...';

                try {
                    // === ZMIANA: Tworzymy nowy obiekt dependency ===
                    const newDependency = {
                        blockingTaskId: blockingTaskId,
                        setByUserId: state.currentUser.uid // Zapisujemy, kto utworzy link
                    };
                    const updatedTask = { ...task, dependency: newDependency }; // Zapisujemy obiekt, a nie string
                    // === KONIEC ZMIANY ===

                    const updatedTasks = project.tasks.map(t => t.id === dependentTaskId ? updatedTask : t);
                    
                    const projectDocRef = findProject(project.id) ? doc(projectsRef, project.id) : doc(completedProjectsRef, project.id);
                    await updateDoc(projectDocRef, { tasks: updatedTasks });

                    closeModal(modal);
                    showNotification("Powizanie zostao utworzone.", "Sukces");
                    // onSnapshot sam odwie偶y widok (render())
                    
                } catch (error) {
                    console.error("Bd podczas tworzenia powizania:", error);
                    showNotification("Wystpi bd.", "Bd");
                } finally {
                    confirmBtn.disabled = false;
                    confirmBtn.textContent = 'Utw贸rz powizanie';
                }
            }
        });
        // === POCZTEK NOWEGO KODU: Listenery Modala Zarzdzania Kolumnami ===

        // Listener 1: Dodawanie nowej kolumny do listy w modalu
        manageColumnsModal.addForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const newName = manageColumnsModal.addInput.value.trim();
            if (!newName) return;

            const newColumnData = {
                id: `col_${Date.now()}`, // Unikalne tymczasowe ID
                title: newName
            };
            
            const newColumnHTML = renderCustomColumnItemHTML(newColumnData);
            manageColumnsModal.list.insertAdjacentHTML('beforeend', newColumnHTML);
            
            manageColumnsModal.addInput.value = ''; // Wyczy input
        });

        // Listener 2: Delegowane usuwanie kolumny z listy w modalu
        manageColumnsModal.list.addEventListener('click', (e) => {
            // Przekazujemy zdarzenie do naszej funkcji pomocniczej
            handleDeleteCustomColumn(e);
        });

        // Listener 3: Zapisywanie zmian (kolejnoci, nazw, usuni)
        manageColumnsModal.saveBtn.addEventListener('click', async () => {
            const projectId = state.currentProjectId;
            if (!projectId) return;

            manageColumnsModal.saveBtn.disabled = true;
            manageColumnsModal.saveBtn.textContent = 'Zapisywanie...';

            try {
                // 1. Odczytaj wszystkie LI z kolumnami (opr贸cz statycznej)
                const columnItems = manageColumnsModal.list.querySelectorAll('li[data-id^="col_"]');
                
                // 2. Przemapuj je na tablic obiekt贸w, zapisujc now kolejno (index)
                const newColumnsArray = Array.from(columnItems).map((li, index) => {
                    const id = li.dataset.id;
                    const title = li.querySelector('.custom-column-name-input').value.trim();
                    return {
                        id: id,
                        title: title,
                        order: index + 1 // Zaczynamy kolejno od 1
                    };
                });

                // 3. Zapisz t now tablic w dokumencie projektu
                const projectRef = doc(projectsRef, projectId);
                await updateDoc(projectRef, {
                    customColumns: newColumnsArray
                });
                
                showNotification("Kolejno kolumn zostaa zaktualizowana.", "Sukces");
                closeModal(manageColumnsModal.overlay);
                // `render()` zostanie wywoane automatycznie przez onSnapshot,
                // a nowa `renderKanbanBoard` odczyta now struktur.

            } catch (error) {
                console.error("Bd zapisu niestandardowych kolumn:", error);
                showNotification("Wystpi bd podczas zapisu kolumn.", "Bd");
            } finally {
                manageColumnsModal.saveBtn.disabled = false;
                manageColumnsModal.saveBtn.textContent = 'Zapisz zmiany';
            }
        });
        // === KONIEC NOWEGO KODU ===
        // === KONIEC: NOWE FUNKCJE I LISTENERY DLA ZALE呕NOCI ===
       // === POCZTEK NOWEGO KODU: Listener Zwijania Sidebara ===
        document.getElementById('sidebar-toggle-btn').addEventListener('click', toggleSidebar);
        // === KONIEC NOWEGO KODU ===
        // === NOWA LOGIKA: Efekt cienia przy przewijaniu Kanbanu ===

        const kanbanBoardScrollHandler = (e) => {
            const el = e.target;
            // Sprawd藕, czy przewijany element to kanban-board (zabezpieczenie)
            if (!el.classList.contains('kanban-board')) return;

            const maxScrollLeft = el.scrollWidth - el.clientWidth;
            const scrollLeft = el.scrollLeft;
            const tolerance = 5; // Tolerancja 5 pikseli

            // 1. KONTROLA CIENIA PRAWEGO (fade-end)
            // Jeli przewinito do koca w prawo
            if (scrollLeft >= maxScrollLeft - tolerance) {
                el.classList.add('fade-end');
            } else {
                el.classList.remove('fade-end');
            }
            
            // 2. KONTROLA CIENIA LEWEGO (fade-start)
            // Jeli przewinito w prawo (jest z dala od 0)
            if (scrollLeft > tolerance) {
                el.classList.add('fade-start'); // Poka偶 lewy cie
            } else {
                el.classList.remove('fade-start'); // Ukryj lewy cie
            }
        };
        // Podpinanie listenera (zapewnij, 偶e jest wywoany po renderowaniu kanbanBoardEl)
        kanbanBoardEl.addEventListener('scroll', kanbanBoardScrollHandler);

        // Ustawienie pocztkowe przy pierwszym renderowaniu
        const initialFadeCheck = () => {
            const board = document.getElementById('kanban-board');
            // Czekamy na nastpny cykl zdarze, aby mie pewno, 偶e wszystkie elementy s ju偶 w DOM
            setTimeout(() => {
                if (board) {
                    kanbanBoardScrollHandler({ target: board });
                }
            }, 50); 
        };
        
        // Zmodyfikuj istniejce wywoania render (lub po prostu polegaj na tym, 偶e render uruchamia si po zaadowaniu danych).
        
        // Poniewa偶 nie mog modyfikowa funkcji render() globalnie, opieram si na listenrze 'scroll'.
        // Aby zadziaao to po zaadowaniu, dodaj wywoanie po inicjalizacji:
        
        window.addEventListener('load', initialFadeCheck);

        // Upewnij si, 偶e ten sam handler jest wywoywany po ka偶dej zmianie widoku (zapewniajc, 偶e kanbanBoardEl nie jest null)
        const observer = new MutationObserver(function() {
            const board = document.getElementById('kanban-board');
            if (board) kanbanBoardScrollHandler({ target: board });
        });
        
        // Obserwuj zmiany w g贸wnym kontenerze treci (dla widocznoci)
        observer.observe(document.querySelector('.main-content'), { childList: true, subtree: true });
       // === NOWY LISTENER: Zamykanie modali klawiszem ESC ===
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                // Znajd藕 ostatni otwarty modal (ten na wierzchu)
                // Selektor zwraca kolekcj, bierzemy ostatni element, bo w CSS z-indexy mog si nakada
                const openModals = document.querySelectorAll('.modal-overlay.visible');
                
                if (openModals.length > 0) {
                    const topModal = openModals[openModals.length - 1];
                    
                    // Logika bezpieczestwa: odblokuj inputy (np. po anulowaniu czatu AI)
                    Array.from(topModal.querySelectorAll('select, textarea, input')).forEach(el => el.disabled = false);
                    
                    closeModal(topModal);
                }
            }
        });
        // === KONIEC NOWEGO LISTENERA ===
       // === NOWA LOGIKA: Obsuga przycisku "Otw贸rz w nowym oknie" ===
        if (openNewWindowBtn) {
            openNewWindowBtn.addEventListener('click', () => {
                if (state.currentProjectId) {
                    // Budujemy URL z parametrem projectId
                    const newUrl = `${window.location.origin}${window.location.pathname}?projectId=${state.currentProjectId}`;
                    // Otwieramy w nowej karcie/oknie
                    window.open(newUrl, '_blank');
                }
            });
        }
        // === KONIEC NOWEJ LOGIKI ===
       // Inicjalizacja wyszukiwarki w modalach projekt贸w
    setupUserSearch(newProjectModal.memberSearchInput, newProjectModal.memberSearchResults, newProjectModal.membersContainer);
    setupUserSearch(editProjectModal.memberSearchInput, editProjectModal.memberSearchResults, editProjectModal.membersContainer);
       // === LOGIKA FORULARZA KONTAKTOWEGO (SUPPORT) ===
    
    const supportForm = document.getElementById('support-contact-form');
    const toggleHistoryBtn = document.getElementById('toggle-support-history-btn');
    const historySection = document.getElementById('support-history-section');
    const historyList = document.getElementById('support-history-list');
    const contactSubject = document.getElementById('contact-subject');
    const contactMessage = document.getElementById('contact-message');

    // 1. Wysanie zgoszenia
    if (supportForm) {
        supportForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const submitBtn = supportForm.querySelector('button[type="submit"]');
            
            const subject = contactSubject.value.trim();
            const message = contactMessage.value.trim();

            if (!subject || !message) return;

            submitBtn.disabled = true;
            submitBtn.textContent = 'Wysyanie...';

            try {
                // Zapisz do kolekcji 'support_tickets'
                // UWAGA: Backend (Cloud Function) powinien nasuchiwa na t kolekcj i wysya e-mail
                const ticketData = {
                    userId: state.currentUser.uid,
                    userEmail: state.currentUser.email,
                    userName: state.currentUser.name,
                    subject: subject,
                    message: message,
                    status: 'new', // Status zgoszenia
                    type: 'contact_form',
                    timestamp: Date.now(),
                    targetEmail: 'mateuszczerwinski0@gmail.com' // Informacja dla backendu
                };

                const ticketsRef = collection(db, `artifacts/${appId}/public/data/support_tickets`);
                await addDoc(ticketsRef, ticketData);

                showNotification("Wiadomo zostaa wysana! Dzikujemy za kontakt.", "Sukces");
                
                // Wyczy formularz
                contactSubject.value = '';
                contactMessage.value = '';
                
                // Jeli historia jest otwarta, odwie偶 j
                if (historySection.style.display === 'block') {
                    loadSupportHistory();
                }

            } catch (error) {
                console.error("Bd wysyania zgoszenia:", error);
                showNotification("Nie udao si wysa wiadomoci.", "Bd");
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Wylij wiadomo';
            }
        });
    }

    // 2. Przeczanie widoku historii
    if (toggleHistoryBtn) {
        toggleHistoryBtn.addEventListener('click', (e) => {
            e.preventDefault();
            if (historySection.style.display === 'none') {
                historySection.style.display = 'block';
                toggleHistoryBtn.textContent = 'Ukryj histori';
                loadSupportHistory();
            } else {
                historySection.style.display = 'none';
                toggleHistoryBtn.textContent = ' Historia zgosze';
            }
        });
    }

    // 3. Funkcja adujca histori
    async function loadSupportHistory() {
        if (!state.currentUser) return;
        historyList.innerHTML = '<li style="text-align: center; color: var(--text-secondary);">adowanie...</li>';

        try {
            const ticketsRef = collection(db, `artifacts/${appId}/public/data/support_tickets`);
            const q = query(
                ticketsRef, 
                where("userId", "==", state.currentUser.uid),
                orderBy("timestamp", "desc"),
                limit(20)
            );

            const snapshot = await getDocs(q);
            
            if (snapshot.empty) {
                historyList.innerHTML = '<li style="text-align: center; color: var(--text-secondary);">Brak wczeniejszych zgosze.</li>';
                return;
            }

            historyList.innerHTML = '';
            snapshot.forEach(doc => {
                const ticket = doc.data();
                const dateStr = new Date(ticket.timestamp).toLocaleString('pl-PL', { 
                    day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' 
                });
                
                // Status (prosta logika wizualna)
                let statusLabel = 'Wysano';
                if (ticket.status === 'resolved') statusLabel = 'Rozwizane';
                if (ticket.status === 'in_progress') statusLabel = 'W trakcie';

                const li = document.createElement('li');
                li.className = 'support-ticket-item';
                li.innerHTML = `
                    <div class="support-ticket-header">
                        <div style="display:flex; align-items:center;">
                            <span class="support-ticket-subject">${ticket.subject}</span>
                            <span class="support-ticket-status">${statusLabel}</span>
                        </div>
                        <span class="support-ticket-date">${dateStr}</span>
                    </div>
                    <div class="support-ticket-message">${ticket.message}</div>
                `;
                historyList.appendChild(li);
            });

        } catch (error) {
            console.error("Bd adowania historii:", error);
            // Fallback dla braku indeksu (czsty bd przy zo偶onych zapytaniach)
            if (error.code === 'failed-precondition') {
                 historyList.innerHTML = '<li style="color: var(--danger-primary);">Bd: Wymagany indeks bazy danych. Skontaktuj si z administratorem.</li>';
            } else {
                 historyList.innerHTML = '<li style="color: var(--danger-primary);">Nie udao si zaadowa historii.</li>';
            }
        }
    }
       // === NOWE LISTENERY: OBSUGA MENU PROJEKTU (Clean UI) ===

        // 1. Toggle Menu
        if (projectMenuToggle) {
            projectMenuToggle.addEventListener('click', (e) => {
                e.stopPropagation(); // Zapobiegaj propagacji do document
                projectMenuDropdown.classList.toggle('visible');
                projectMenuToggle.classList.toggle('active');
            });
        }

        // 2. Zamykanie po klikniciu poza
        document.addEventListener('click', (e) => {
            if (projectMenuDropdown && projectMenuDropdown.classList.contains('visible')) {
                if (!projectMenuDropdown.contains(e.target) && !projectMenuToggle.contains(e.target)) {
                    projectMenuDropdown.classList.remove('visible');
                    projectMenuToggle.classList.remove('active');
                }
            }
        });

        // 3. Obsuga akcji wewntrz menu (Delegacja)
        if (projectMenuDropdown) {
            projectMenuDropdown.addEventListener('click', (e) => {
                // Znajd藕 kliknity przycisk (opcj menu)
                const item = e.target.closest('.project-menu-item');
                if (!item) return;

                const action = item.dataset.action;
                const projectId = state.currentProjectId;

                // Zamknij menu
                projectMenuDropdown.classList.remove('visible');
                projectMenuToggle.classList.remove('active');

                // Wykonaj akcj
                if (action === 'details') {
                    openProjectDetailsModal();
                } else if (action === 'edit') {
                    openEditProjectModal(projectId);
                } else if (action === 'complete') {
                    handleCompleteProject(projectId);
                } else if (action === 'delete') {
                    handleDeleteProject(projectId);
                }
            });
        }

        // 4. Funkcja pomocnicza: Zakocz Projekt (Wyodrbniona)
        async function handleCompleteProject(projectId) {
            const project = findProject(projectId);
            if (!project || (project.tasks || []).some(t => t.status !== 'done')) {
                showNotification("Wszystkie zadania musz by ukoczone, aby zamkn projekt.", "Bd");
                return;
            }
            try {
                await setDoc(doc(completedProjectsRef, project.id), project);
                await deleteDoc(doc(projectsRef, project.id));
                
                state.currentProjectId = state.projects.length > 0 ? state.projects[0].id : null;
                // Jeli nie ma projekt贸w, id藕 do Dashboardu
                if (!state.currentProjectId) state.ui.currentView = 'my-dashboard';
                
                saveUiState();
                render(); // Odwie偶 widok
                showNotification("Projekt zosta zakoczony i przeniesiony do archiwum.", "Sukces");
            } catch (error) {
                console.error("Bd zamykania projektu:", error);
                showNotification("Bd podczas zamykania projektu.", "Bd");
            }
        }
        // === KONIEC NOWYCH LISTENERW ===
       // === NOWE LISTENERY DLA PODSUMOWANIA W RAPORCIE ===
        
        const reportAddSummaryBtn = document.getElementById('report-add-summary-btn');
        const reportSummaryLabelInput = document.getElementById('report-summary-label-input');
        const reportSummaryValueInput = document.getElementById('report-summary-value-input');
        const reportSummaryList = document.getElementById('report-summary-items-list');

        if (reportAddSummaryBtn) {
            reportAddSummaryBtn.addEventListener('click', async () => {
                const projectId = document.getElementById('project-report-modal').dataset.projectId;
                const label = reportSummaryLabelInput.value.trim();
                const value = reportSummaryValueInput.value.trim();

                if (!projectId) return;
                if (!label || !value) {
                    showNotification("Wypenij oba pola: Nazw i Tre.", "Bd");
                    return;
                }

                // Znajd藕 projekt w stanie (aktywny lub zakoczony)
                const project = state.completedProjects.find(p => p.id === projectId) || state.projects.find(p => p.id === projectId);
                if (!project) return;

                // Zablokuj przycisk
                reportAddSummaryBtn.disabled = true;
                reportAddSummaryBtn.textContent = '...';

                try {
                    // Aktualizuj tablic lokalnie
                    const newItem = { label, value };
                    const currentItems = project.summaryItems || [];
                    const newItems = [...currentItems, newItem];

                    // Znajd藕 referencj do dokumentu (sprawd藕 obie kolekcje)
                    const projectDocRef = state.projects.some(p => p.id === projectId) 
                        ? doc(projectsRef, projectId) 
                        : doc(completedProjectsRef, projectId);

                    // Zapisz w bazie
                    await updateDoc(projectDocRef, { summaryItems: newItems });
                    
                    // Zaktualizuj stan lokalny (dla pynnoci, chocia偶 onSnapshot i tak by to zrobi)
                    project.summaryItems = newItems;

                    // Odwie偶 widok listy w modalu (bez zamykania)
                    openProjectReportModal(projectId);

                    // Wyczy inputy
                    reportSummaryLabelInput.value = '';
                    reportSummaryValueInput.value = '';
                    reportSummaryLabelInput.focus();

                } catch (error) {
                    console.error("Bd dodawania podsumowania:", error);
                    showNotification("Nie udao si zapisa.", "Bd");
                } finally {
                    reportAddSummaryBtn.disabled = false;
                    reportAddSummaryBtn.textContent = 'Dodaj';
                }
            });
        }

        // Delegacja usuwania element贸w z listy podsumowania
        if (reportSummaryList) {
            reportSummaryList.addEventListener('click', async (e) => {
                if (e.target.classList.contains('js-delete-summary-item')) {
                    const indexToRemove = parseInt(e.target.dataset.index, 10);
                    const projectId = document.getElementById('project-report-modal').dataset.projectId;
                    
                    const project = state.completedProjects.find(p => p.id === projectId) || state.projects.find(p => p.id === projectId);
                    if (!project) return;

                    if (confirm("Czy na pewno usun t pozycj?")) {
                        try {
                            const currentItems = project.summaryItems || [];
                            const newItems = currentItems.filter((_, idx) => idx !== indexToRemove);

                            const projectDocRef = state.projects.some(p => p.id === projectId) 
                                ? doc(projectsRef, projectId) 
                                : doc(completedProjectsRef, projectId);

                            await updateDoc(projectDocRef, { summaryItems: newItems });
                            
                            project.summaryItems = newItems;
                            openProjectReportModal(projectId); // Odwie偶

                        } catch (error) {
                            console.error("Bd usuwania pozycji:", error);
                            showNotification("Nie udao si usun.", "Bd");
                        }
                    }
                }
            });
        }
        // === KONIEC NOWYCH LISTENERW ===
    }); // Ten nawias zamyka g贸wny listener DOMContentLoaded
    
</script>
    <div class="modal-overlay" id="settings-modal">
    <div class="modal" style="max-width: 900px; height: 80vh; max-height: 800px; padding: 0;">
        
        <div class="modal-header">
            <h2>Ustawienia Konta</h2>
            <button type="button" class="modal-close-btn">&times;</button>
        </div>

        <div class="settings-container">
            <aside class="settings-sidebar">
                <nav class="settings-nav" id="settings-main-nav"> <button class="settings-nav-item active" data-tab="profile">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0ZM4.501 20.118a7.5 7.5 0 0 1 14.998 0A17.933 17.933 0 0 1 12 21.75c-2.676 0-5.216-.584-7.499-1.632Z" />
                        </svg>
                        <span>M贸j Profil</span>
                    </button>
                    
                    <button class="settings-nav-item" data-tab="application">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 6h9.75M10.5 6a1.5 1.5 0 1 1-3 0m3 0a1.5 1.5 0 1 0-3 0M3.75 6H7.5m3 12h9.75m-9.75 0a1.5 1.5 0 0 1-3 0m3 0a1.5 1.5 0 0 0-3 0m-3.75 0H7.5m9-6h3.75m-3.75 0a1.5 1.5 0 0 1-3 0m3 0a1.5 1.5 0 0 0-3 0m-9.75 0h9.75" />
                        </svg>
                        <span>Aplikacja</span>
                    </button>
                    <button class="settings-nav-item" data-tab="notifications">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M14.857 17.082a23.848 23.848 0 0 0 5.454-1.31A8.967 8.967 0 0 1 18 9.75v-.7V9A6 6 0 0 0 6 9v.75a8.967 8.967 0 0 1-2.312 6.022c1.733.64 3.56 1.085 5.455 1.31m5.714 0a24.255 24.255 0 0 1-5.714 0m5.714 0a3 3 0 1 1-5.714 0" />
                        </svg>
                        <span>Powiadomienia</span>
                    </button>
                    <button class="settings-nav-item" id="open-tutorial-btn">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M4.26 10.147a60.436 60.436 0 0 0-.491 6.347A48.627 48.627 0 0 1 12 20.904a48.627 48.627 0 0 1 8.232-4.41 60.46 60.46 0 0 0-.491-6.347m-15.482 0a50.57 50.57 0 0 0-2.658-.813A59.905 59.905 0 0 1 12 3.493a59.902 59.902 0 0 1 10.499 5.24 50.552 50.552 0 0 0-2.658.814m-15.482 0A50.697 50.697 0 0 1 12 13.489a50.702 50.702 0 0 1 7.74-3.342M6.75 15a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5Zm0 0v-3.675A55.378 55.378 0 0 1 12 8.443m-7.007 11.55A5.981 5.981 0 0 0 6.75 15.75v-1.5" />
                        </svg>
                        <span>Akademia TeamFlow</span>
                    </button>
                <button class="settings-nav-item" data-tab="contact">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M21.75 6.75v10.5a2.25 2.25 0 0 1-2.25 2.25h-15a2.25 2.25 0 0 1-2.25-2.25V6.75m19.5 0A2.25 2.25 0 0 0 19.5 4.5h-15a2.25 2.25 0 0 0-2.25 2.25m19.5 0v.243a2.25 2.25 0 0 1-1.07 1.916l-7.5 4.615a2.25 2.25 0 0 1-2.36 0L3.32 8.91a2.25 2.25 0 0 1-1.07-1.916V6.75" />
                        </svg>
                        <span>Napisz do nas</span>
                    </button>
                </nav>
            </aside>

            <main class="settings-content">
                <div id="settings-tab-contact" class="settings-tab-content">
                    <div class="settings-section">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                            <h3 style="margin-bottom: 0;">Formularz Kontaktowy</h3>
                            <button id="toggle-support-history-btn" class="btn btn-secondary" style="font-size: 12px; padding: 6px 10px;">
                                 Historia zgosze
                            </button>
                        </div>
                        <p class="settings-hint" style="margin-bottom: 24px;">Masz pytanie, problem lub sugesti? Napisz do nas. Odpowiemy najszybciej jak to mo偶liwe.</p>

                        <form id="support-contact-form">
                            <div class="form-group" style="display: flex; gap: 16px;">
                                <div style="flex: 1;">
                                    <label>Twoje Imi</label>
                                    <input type="text" id="contact-name" disabled style="background-color: var(--bg-tertiary); opacity: 0.7;">
                                </div>
                                <div style="flex: 1;">
                                    <label>Tw贸j Email</label>
                                    <input type="email" id="contact-email" disabled style="background-color: var(--bg-tertiary); opacity: 0.7;">
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="contact-subject">Temat zgoszenia</label>
                                <input type="text" id="contact-subject" required placeholder="np. Bd przy dodawaniu zadania">
                            </div>

                            <div class="form-group">
                                <label for="contact-message">Tre wiadomoci</label>
                                <textarea id="contact-message" rows="6" required placeholder="Opisz szczeg贸owo sw贸j problem lub propozycj..."></textarea>
                            </div>

                            <div style="text-align: right; margin-top: 16px;">
                                <button type="submit" class="btn btn-primary">Wylij wiadomo</button>
                            </div>
                        </form>
                    </div>

                    <div id="support-history-section" style="display: none; margin-top: 32px; border-top: 1px solid var(--border-color); padding-top: 24px;">
                        <h3 style="margin-bottom: 16px;">Twoja Historia Zgosze</h3>
                        <ul id="support-history-list" style="list-style: none; padding: 0;">
                            <li style="text-align: center; color: var(--text-secondary); font-style: italic;">adowanie historii...</li>
                        </ul>
                    </div>
                </div>

            <main class="settings-content">
                <div id="settings-tab-application" class="settings-tab-content">
                    <div class="settings-section">
                        <h3 style="margin-bottom: 8px;">Wygld</h3>
                        <p class="settings-hint" style="margin-bottom: 24px;">Dostosuj interfejs aplikacji do swoich preferencji.</p>
                        
                        <div class="form-group">
                            <label style="margin-bottom: 12px; display: block;">Motyw aplikacji</label>
                            <div style="display: flex; gap: 16px;">
                                <label class="project-selection-item" style="flex: 1; text-align: center;">
                                    <input type="radio" name="app-theme" value="light">
                                    Tryb Jasny 锔
                                </label>
                                <label class="project-selection-item" style="flex: 1; text-align: center;">
                                    <input type="radio" name="app-theme" value="dark">
                                    Tryb Ciemny 
                                </label>
                            </div>
                        </div>
                    </div>

                    <hr style="border: 0; border-top: 1px solid var(--border-color); margin: 24px 0;">

                    <div class="settings-section">
                        <h3 style="margin-bottom: 8px;">Zachowanie (Workflow)</h3>
                        <p class="settings-hint" style="margin-bottom: 24px;">Skonfiguruj, jak aplikacja reaguje na Twoje dziaania.</p>

                        <div class="form-group">
                            <label for="settings-start-view">Domylny widok startowy</label>
                            <select id="settings-start-view">
                                <option value="auto">Automatycznie (Dashboard / M贸j Dzie)</option>
                                <option value="my-dashboard">M贸j Dashboard</option>
                                <option value="my-day">M贸j Dzie</option>
                                <option value="all-projects">Wszystkie Projekty</option>
                            </select>
                        </div>

                        <div class="form-group" style="margin-top: 16px;">
                            <label>Efekty wizualne</label>
                            <div class="form-group-checkbox" style="margin-top: 8px;">
                                <input type="checkbox" id="settings-show-confetti">
                                <label for="settings-show-confetti">Pokazuj konfetti po ukoczeniu zadania </label>
                            </div>
                        </div>

                        
                            <div class="form-group" style="margin-top: 16px;">
                            <label>Bezpieczestwo</label>
                            <div class="form-group-checkbox" style="margin-top: 8px;">
                                <input type="checkbox" id="settings-confirm-delete">
                                <label for="settings-confirm-delete">Pytaj o potwierdzenie przed usuniciem zadania</label>
                            </div>
                        </div>

                        <div class="form-group" style="margin-top: 16px;">
                            <label>Interfejs</label>
                            
                            <div class="form-group-checkbox" style="margin-top: 8px;">
                                <input type="checkbox" id="settings-compact-mode">
                                <label for="settings-compact-mode">Tryb kompaktowy (zmniejszone odstpy)</label>
                            </div>

                            <div class="form-group-checkbox" style="margin-top: 8px;">
                                <input type="checkbox" id="settings-start-collapsed">
                                <label for="settings-start-collapsed">Zawsze uruchamiaj ze zwinitym paskiem bocznym</label>
                            </div>

                            <div class="form-group-checkbox" style="margin-top: 8px;">
                                <input type="checkbox" id="settings-expand-subtasks" checked>
                                <label for="settings-expand-subtasks">Zawsze uruchamiaj z rozwinitymi podzadaniami</label>
                            </div>
                        </div>
                        </div>
                </div>
                <div id="settings-tab-notifications" class="settings-tab-content">
    
    <div class="settings-section">
        <h3 style="margin-bottom: 8px; color: var(--text-secondary);">Powiadomienia Push</h3>
        <div style="padding: 16px; background-color: var(--bg-tertiary); border-radius: var(--border-radius); text-align: center;">
            <span style="font-weight: 600; color: var(--text-secondary);"> Funkcja w budowie</span>
            <p style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">Powiadomienia na pulpit i telefon pojawi si wkr贸tce.</p>
        </div>
    </div>

    <hr style="border: 0; border-top: 1px solid var(--border-color); margin: 24px 0;">

    <div class="settings-section">
        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 16px;">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 24px; height: 24px; color: var(--accent-primary);">
                <path stroke-linecap="round" stroke-linejoin="round" d="M14.857 17.082a23.848 23.848 0 0 0 5.454-1.31A8.967 8.967 0 0 1 18 9.75v-.7V9A6 6 0 0 0 6 9v.75a8.967 8.967 0 0 1-2.312 6.022c1.733.64 3.56 1.085 5.455 1.31m5.714 0a24.255 24.255 0 0 1-5.714 0m5.714 0a3 3 0 1 1-5.714 0" />
            </svg>
            <h3 style="margin-bottom: 0;">Powiadomienia TeamFlow</h3>
        </div>
        <p class="settings-hint" style="margin-bottom: 24px;">Wybierz, jakie zdarzenia maj wywietla czerwon kropk i pojawia si na licie powiadomie w aplikacji.</p>

        <div style="display: flex; flex-direction: column; gap: 20px;">

            <div>
                <div class="form-group-checkbox">
                    <input type="checkbox" id="notif-project-invite" checked>
                    <label for="notif-project-invite">Dodanie do projektu</label>
                </div>
                <p class="settings-hint">Przykad: "Anna zaprosia Ci do nowego projektu Kampania 2025."</p>
            </div>

            <div>
                <div class="form-group-checkbox">
                    <input type="checkbox" id="notif-task-assign" checked>
                    <label for="notif-task-assign">Przypisanie do zadania</label>
                </div>
                <p class="settings-hint">Przykad: "Marek przypisa Ci do zadania Przygotowanie grafik."</p>
            </div>

            <div>
                <div class="form-group-checkbox">
                    <input type="checkbox" id="notif-subtask-assign" checked>
                    <label for="notif-subtask-assign">Przypisanie do podzadania</label>
                </div>
                <p class="settings-hint">Przykad: "Marek przypisa Ci do podzadania Wyb贸r kolor贸w w zadaniu Grafiki."</p>
            </div>

            <div>
                <div class="form-group-checkbox">
                    <input type="checkbox" id="notif-task-mention" checked>
                    <label for="notif-task-mention">Wzmianka w zadaniu (@)</label>
                </div>
                <p class="settings-hint">Przykad: "Tomasz wspomnia o Tobie w komentarzu w zadaniu Raport."</p>
            </div>

            <div>
                <div class="form-group-checkbox">
                    <input type="checkbox" id="notif-subtask-mention" checked>
                    <label for="notif-subtask-mention">Wzmianka w podzadaniu (@)</label>
                </div>
                <p class="settings-hint">Przykad: "Tomasz wspomnia o Tobie w komentarzu do podzadania Dane Excel."</p>
            </div>

            <div>
                <div class="form-group-checkbox">
                    <input type="checkbox" id="notif-budget-alert" checked>
                    <label for="notif-budget-alert">Kontrola bud偶etu (Dla waciciela)</label>
                </div>
                <p class="settings-hint">Przykad: "Uwaga: Zadanie X spowodowao przekroczenie bud偶etu projektu."</p>
            </div>

            <div>
                <div class="form-group-checkbox">
                    <input type="checkbox" id="notif-polls" checked>
                    <label for="notif-polls">Sonda偶e (Zaproszenia i Wyniki)</label>
                </div>
                <p class="settings-hint">Przykad: "Sonda偶 Wyb贸r logo zosta zakoczony. Sprawd藕 wyniki."</p>
            </div>

            <div>
                <div class="form-group-checkbox">
                    <input type="checkbox" id="notif-correction" checked>
                    <label for="notif-correction">Cofnicie do poprawki</label>
                </div>
                <p class="settings-hint">Przykad: "Kasia cofna status zadania X do 'Do realizacji'. Sprawd藕, co wymaga poprawy."</p>
            </div>

            <div>
                <div class="form-group-checkbox">
                    <input type="checkbox" id="notif-dependency" checked>
                    <label for="notif-dependency">Wizane zadanie (Odblokowanie)</label>
                </div>
                <p class="settings-hint">Przykad: "Zadanie blokujce Y zostao ukoczone. Mo偶esz rozpocz prac."</p>
            </div>

            <div>
                <div class="form-group-checkbox">
                    <input type="checkbox" id="notif-checklist-assign" checked>
                    <label for="notif-checklist-assign">Lista kontrolna (Przypisanie)</label>
                </div>
                <p class="settings-hint">Przykad: "Anna przypisaa Ci do zadania 'Sprawdzi bdy' z listy kontrolnej podzadania Testy."</p>
            </div>
            <div style="border-top: 1px dashed var(--border-color); padding-top: 16px; margin-top: 8px;">
                <label for="setting-warning-days" style="font-weight: 500; display: block; margin-bottom: 8px;">Ostrze偶enie o terminie zadania</label>
                <div style="display: flex; align-items: center; gap: 12px;">
                    <input type="number" id="setting-warning-days" min="1" max="30" value="3" style="width: 80px; padding: 8px; border-radius: var(--border-radius); border: 1px solid var(--border-color); background-color: var(--bg-primary); color: var(--text-primary);">
                    <span style="font-size: 14px; color: var(--text-secondary);">dni przed terminem</span>
                </div>
                <p class="settings-hint" style="margin-top: 8px;">Ikona ostrze偶enia pojawi si przy zadaniach, kt贸rych termin zbli偶a si w wybranym przedziale czasu.</p>
            </div>
            </div>
    </div>
</div>
                <div id="settings-tab-profile" class="settings-tab-content active">
                    
                    <div class="settings-section centered">
                        <div class="settings-avatar-wrapper" id="settings-avatar-wrapper" title="Kliknij, aby zmieni zdjcie">
                            <div id="settings-avatar-preview" class="avatar-xl"></div>
                            <div class="avatar-overlay">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M6.827 6.175A2.31 2.31 0 0 1 5.186 7.23c-.38.054-.757.112-1.134.175C2.999 7.58 2.25 8.507 2.25 9.574V18a2.25 2.25 0 0 0 2.25 2.25h15A2.25 2.25 0 0 0 21.75 18V9.574c0-1.067-.75-1.994-1.802-2.169a47.865 47.865 0 0 0-1.134-.175 2.31 2.31 0 0 1-1.64-1.055l-.822-1.316a2.192 2.192 0 0 0-1.736-1.039 48.774 48.774 0 0 0-5.232 0 2.192 2.192 0 0 0-1.736 1.039l-.821 1.316Z" />
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M16.5 12.75a4.5 4.5 0 1 1-9 0 4.5 4.5 0 0 1 9 0ZM18.75 10.5h.008v.008h-.008V10.5Z" />
                                </svg>
                            </div>
                        </div>
                        <p class="settings-hint">Kliknij zdjcie, aby je zaktualizowa</p>
                    </div>

                    <form id="settings-profile-form">
                        <div class="form-group">
                            <label for="settings-name">Imi i Nazwisko</label>
                            <input type="text" id="settings-name" placeholder="Twoje imi">
                        </div>

                        <div class="form-group">
                            <label for="settings-email">Adres E-mail</label>
                            <input type="email" id="settings-email" disabled style="opacity: 0.6; cursor: not-allowed;" title="Nie mo偶na zmieni adresu e-mail">
                        </div>

                        <div class="form-group">
                            <label for="settings-subgroup">Tw贸j Dzia / Podgrupa</label>
                            <select id="settings-subgroup">
                                <option value="">-- Brak (Domylny) --</option>
                            </select>
                            <p class="settings-hint">Wybierz dzia, do kt贸rego nale偶ysz w tej grupie.</p>
                        </div>

                        <hr style="border: 0; border-top: 1px solid var(--border-color); margin: 24px 0;">

                        <h4 style="margin-bottom: 16px; font-size: 14px; font-weight: 600; color: var(--text-secondary);">Zmiana Hasa</h4>
                        
                        <div class="form-group">
                            <label for="settings-current-password">Obecne haso</label>
                            <input type="password" id="settings-current-password" placeholder="Wymagane do zmiany hasa">
                        </div>

                        <div class="form-group">
                            <label for="settings-new-password">Nowe haso</label>
                            <input type="password" id="settings-new-password" placeholder="Minimum 6 znak贸w">
                        </div>
                        <div class="form-group" id="settings-confirm-password-group" style="display:none;">
                            <label for="settings-confirm-password">Potwierd藕 nowe haso</label>
                            <input type="password" id="settings-confirm-password" placeholder="Powt贸rz nowe haso">
                        </div>
                    </form>
                </div>
            </main>
        </div>

        <div class="modal-footer" style="border-top: 1px solid var(--border-color);">
            <button type="button" class="btn btn-secondary modal-close-btn">Anuluj</button>
            <button type="button" id="settings-save-btn" class="btn btn-primary">Zapisz zmiany</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="change-username-modal">
    <div class="modal" style="max-width: 400px;">
        <form id="change-username-form">
            <div class="modal-header">
                <h2>Zmie nazw u偶ytkownika</h2>
                <button type="button" class="modal-close-btn">&times;</button>
            </div>
            <div class="form-modal-content">
                <div class="form-group">
                    <label for="new-username-input">Nowa nazwa</label>
                    <input type="text" id="new-username-input" required>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary modal-close-btn">Anuluj</button>
                <button type="submit" class="btn btn-primary">Zapisz</button>
            </div>
        </form>
    </div>
</div>

<div class="modal-overlay" id="change-password-modal">
    <div class="modal" style="max-width: 400px;">
        <form id="change-password-form">
            <div class="modal-header">
                <h2>Zmie haso</h2>
                <button type="button" class="modal-close-btn">&times;</button>
            </div>
            <div class="form-modal-content">
                <div class="form-group">
                    <label for="current-password">Bie偶ce haso</label>
                    <input type="password" id="current-password" required>
                </div>
                <div class="form-group">
                    <label for="new-password">Nowe haso (min. 6 znak贸w)</label>
                    <input type="password" id="new-password" required>
                </div>
                <div class="form-group">
                    <label for="confirm-password">Potwierd藕 nowe haso</label>
                    <input type="password" id="confirm-password" required>
                </div>
                <p id="change-password-error" class="error-message"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary modal-close-btn">Anuluj</button>
                <button type="submit" class="btn btn-primary">Zmie haso</button>
            </div>
        </form>
    </div>
</div>
<div class="modal-overlay" id="dashboard-details-modal">
    <div class="modal" style="max-width: 900px;">
        <div class="modal-header">
            <h2 id="dashboard-details-title">Szczeg贸y</h2>
            <button type="button" class="modal-close-btn">&times;</button>
        </div>
        <div class="form-modal-content">
            <div id="dashboard-details-content" class="dashboard-detail-list">
                </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary modal-close-btn">Zamknij</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="crop-photo-modal">
    <div class="modal" style="max-width: 450px;">
        <div class="modal-header">
            <h2>Wykadruj zdjcie</h2>
            <button type="button" class="modal-close-btn">&times;</button>
        </div>
        <div class="form-modal-content">
            <div id="croppie-container"></div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary modal-close-btn">Anuluj</button>
            <button type="button" id="save-cropped-photo-btn" class="btn btn-primary">Zapisz</button>
        </div>
    </div>
</div>
<input type="file" id="photo-upload-input" style="display: none;" accept="image/png, image/jpeg">
        <div class="modal-overlay" id="task-cover-croppie-modal">
    <div class="modal">
        <div class="modal-header">
            <h2>Dopasuj okadk zadania</h2>
            <button type="button" class="modal-close-btn">&times;</button>
        </div>
        <div class="form-modal-content">
            <p style="text-align: center; color: var(--text-secondary); margin-bottom: 12px;">Przesu i powiksz, aby dopasowa obrazek.</p>
            <div id="task-cover-croppie-container"></div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary modal-close-btn">Anuluj</button>
            <button type="button" id="save-cropped-cover-btn" class="btn btn-primary">Ustaw jako okadk</button>
        </div>
    </div>
</div>
<div class="modal-overlay" id="manage-group-modal">
    <div class="modal" style="max-width: 900px; height: 80vh; max-height: 800px; padding: 0;">
        
        <div class="modal-header">
            <h2>Centrum Zarzdzania Grup</h2>
            <button type="button" class="modal-close-btn">&times;</button>
        </div>

        <div class="settings-container">
            
            <aside class="settings-sidebar">
                <nav class="settings-nav" id="manage-group-nav">
                    
                    <button class="settings-nav-item active" data-tab="subgroups">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 7.125C2.25 6.504 2.754 6 3.375 6h6c.621 0 1.125.504 1.125 1.125v3.75c0 .621-.504 1.125-1.125 1.125h-6a1.125 1.125 0 0 1-1.125-1.125v-3.75ZM14.25 8.625c0-.621.504-1.125 1.125-1.125h5.25c.621 0 1.125.504 1.125 1.125v8.25c0 .621-.504 1.125-1.125 1.125h-5.25a1.125 1.125 0 0 1-1.125-1.125v-8.25ZM3.75 16.125c0-.621.504-1.125 1.125-1.125h5.25c.621 0 1.125.504 1.125 1.125v2.25c0 .621-.504 1.125-1.125 1.125h-5.25a1.125 1.125 0 0 1-1.125-1.125v-2.25Z" />
                        </svg>
                        <span>Dziay / Podgrupy</span>
                    </button>

                    <button class="settings-nav-item" data-tab="members">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15 19.128a9.38 9.38 0 0 0 2.625.372 9.337 9.337 0 0 0 4.121-.952 4.125 4.125 0 0 0-7.533-2.493M15 19.128v-.003c0-1.113-.285-2.16-.786-3.07M15 19.128v.106A12.318 12.318 0 0 1 8.624 21c-2.331 0-4.512-.645-6.374-1.766l-.001-.109a6.375 6.375 0 0 1 11.964-3.07M12 6.375a3.375 3.375 0 1 1-6.75 0 3.375 3.375 0 0 1 6.75 0Zm8.25 2.25a2.625 2.625 0 1 1-5.25 0 2.625 2.625 0 0 1 5.25 0Z" />
                        </svg>
                        <span>Czonkowie Zespou</span>
                    </button>

                    <button class="settings-nav-item" data-tab="pending">
                        <div style="position: relative;">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M19 7.5v3m0 0v3m0-3h3m-3 0h-3m-2.25-4.125a3.375 3.375 0 1 1-6.75 0 3.375 3.375 0 0 1 6.75 0ZM3.75 15h2.25c.621 0 1.125-.504 1.125-1.125v-1.5c0-.621-.504-1.125-1.125-1.125h-2.25A1.125 1.125 0 0 0 2.625 12.375v1.5c0 .621.504 1.125 1.125 1.125Zm14.25 5.25a3.375 3.375 0 0 0-2.725-5.172 8.968 8.968 0 0 0-2.618.677 4.501 4.501 0 0 1-4.173.832 4.501 4.501 0 0 0-4.18 2.062c-.38.58-.572 1.26-.572 1.95V19.5A2.25 2.25 0 0 0 6 21.75h12.75a2.25 2.25 0 0 0 2.25-2.25v-.75Z" />
                            </svg>
                            <span id="pending-requests-badge" class="notification-badge" style="display: none; top: -5px; right: -5px;">0</span>
                        </div>
                        <span>Oczekujcy</span>
                    </button>

                </nav>
            </aside>

            <main class="settings-content">
                
                <div id="manage-tab-subgroups" class="manage-tab-content active">
                    <div class="settings-section">
                        <h3 style="margin-bottom: 8px;">Struktura Organizacji</h3>
                        <p class="settings-hint" style="margin-bottom: 24px;">Zdefiniuj dziay (podgrupy), do kt贸rych mog przypisywa si czonkowie.</p>

                        <form id="add-subgroup-form" style="margin-bottom: 24px; display: flex; gap: 12px;">
                            <input type="text" id="new-subgroup-name-input" required placeholder="Nazwa nowego dziau (np. Marketing)" style="flex-grow: 1; padding: 10px; border-radius: var(--border-radius); border: 1px solid var(--border-color); background-color: var(--bg-primary); color: var(--text-primary);">
                            <button type="submit" class="btn btn-primary">Dodaj dzia</button>
                        </form>

                        <ul id="subgroups-list" class="attachments-list" style="max-height: 400px; overflow-y: auto;">
                            </ul>
                    </div>
                </div>

                <div id="manage-tab-members" class="manage-tab-content">
                    <div class="settings-section">
                        <h3 style="margin-bottom: 8px;">Czonkowie Zespou</h3>
                        <p class="settings-hint" style="margin-bottom: 24px;">Zarzdzaj osobami, kt贸re maj dostp do tej grupy.</p>

                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                            <span style="font-weight: 600; color: var(--text-secondary);">Lista aktywnych czonk贸w</span>
                            </div>

                        <ul id="group-members-list" class="attachments-list" style="max-height: 500px; overflow-y: auto;">
                            </ul>
                    </div>
                </div>

                <div id="manage-tab-pending" class="manage-tab-content">
                    <div class="settings-section">
                        <h3 style="margin-bottom: 8px;">Proby o doczenie</h3>
                        <p class="settings-hint" style="margin-bottom: 24px;">Osoby, kt贸re chc doczy do Twojej grupy.</p>

                        <ul id="pending-requests-list" class="attachments-list" style="max-height: 500px; overflow-y: auto;">
                            </ul>
                    </div>
                </div>

            </main>
        </div>

        <div class="modal-footer" style="border-top: 1px solid var(--border-color);">
            <button type="button" class="btn btn-secondary modal-close-btn" style="margin-left: auto;">Zamknij</button>
        </div>
    </div>
</div>
    <div class="modal-overlay" id="select-subgroup-modal">
    <div class="modal" style="max-width: 400px;">
        <form id="select-subgroup-form">
            <div class="modal-header">
                <h2>Wybierz sw贸j dzia</h2>
            </div>
            <div class="form-modal-content">
                <p style="font-size: 14px; color: var(--text-secondary); margin-bottom: 16px;">
                    Zanim zaczniesz, wybierz z listy podgrup (dzia), do kt贸rej nale偶ysz w swojej organizacji.
                </p>
                <div class="form-group">
                    <label for="subgroup-selection-select">Dostpne dziay</label>
                    <select id="subgroup-selection-select" required>
                        <option value="">-- Prosz wybra --</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="submit" class="btn btn-primary">Zapisz i kontynuuj</button>
            </div>
        </form>
    </div>
</div>
    <div class="modal-overlay" id="change-subgroup-modal">
    <div class="modal" style="max-width: 400px;">
        <form id="change-subgroup-form">
            <div class="modal-header">
                <h2>Zmie podgrup (dzia)</h2>
                <button type="button" class="modal-close-btn">&times;</button>
            </div>
            <div class="form-modal-content">
                <p style="font-size: 14px; color: var(--text-secondary); margin-bottom: 16px;">Wybierz z listy nowy dzia, do kt贸rego chcesz by przypisany/a.</p>
                <div class="form-group">
                    <label for="change-subgroup-select-list">Dostpne dziay</label>
                    <select id="change-subgroup-select-list" required>
                        </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary modal-close-btn">Anuluj</button>
                <button type="submit" class="btn btn-primary">Zapisz zmian</button>
            </div>
        </form>
    </div>
</div>
    <div class="modal-overlay" id="notifications-modal">
    <div class="modal">
        <div class="modal-header">
            <h2>Powiadomienia</h2>
            <button type="button" class="modal-close-btn">&times;</button>
        </div>
        <div class="form-modal-content" id="notifications-list-container">
            <ul class="notifications-list" id="notifications-list">
                </ul>
        </div>
        <div class="modal-footer">
            <button type="button" id="mark-all-notifications-read-btn" class="btn btn-secondary">Oznacz wszystkie jako przeczytane</button>
        </div>
    </div>
</div>
   
<div class="modal-overlay" id="subtask-modal">
    <div class="modal">
        <form id="subtask-form" style="display: flex; flex-direction: column; height: 100%;">
            <div class="modal-header">
                <h2 id="subtask-modal-title">Dodaj podzadanie</h2>
                <button type="button" class="modal-close-btn">&times;</button>
            </div>
            
            <div class="task-modal-main" style="padding: 20px 24px 0 24px; flex-shrink: 0;">
                <input type="hidden" id="subtask-modal-id">
                <div class="form-group">
                    <label for="subtask-modal-title-input">Tytu podzadania</label>
                    <input type="text" id="subtask-modal-title-input" required placeholder="Co trzeba zrobi?">
                </div>
            </div>

            <div class="task-modal-interactive-area" style="display: flex; flex-direction: column; flex-grow: 1; overflow: hidden;">
                <div class="task-modal-tabs" id="subtask-tabs">
                    <div class="task-modal-tabs-wrapper">
                        <button type="button" class="task-modal-tab active" data-tab="description" title="Opis">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width:18px;height:18px;"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25H12" /></svg>
                            <span>Opis</span>
                        </button>
                        <button type="button" class="task-modal-tab" data-tab="dates" title="Terminy">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width:18px;height:18px;"><path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75m-18 0h18" /></svg>
                            <span>Terminy</span>
                        </button>
                        <button type="button" class="task-modal-tab" id="subtask-tab-effort" data-tab="effort" title="Wysiek" style="display: none;">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64" width="18" height="18" role="img" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><circle cx="32" cy="32" r="22"/><path d="M32 20 L32 34 L42 38"/></svg>
                            <span>Wysiek</span>
                        </button>
                        <button type="button" class="task-modal-tab" id="subtask-tab-budget" data-tab="budget" title="Bud偶et" style="display: none;">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64" width="18" height="18" role="img">
                                <style>.bg-main{fill:var(--bg-tertiary);stroke:currentColor;}.bg-accent{fill:var(--icon-accent-light);stroke:currentColor;}.stroke{fill:none;stroke:currentColor;stroke-width:2;}.text-fill{fill:currentColor;}.dark-mode .bg-main{fill:#374151;}</style>
                                <rect x="10" y="20" width="44" height="28" rx="3" ry="3" class="bg-main" stroke-width="2"/>
                                <rect x="14" y="24" width="44" height="28" rx="3" ry="3" class="bg-accent" stroke-width="2"/>
                                <circle cx="36" cy="38" r="12" class="stroke" stroke-width="2"/>
                                <text x="36" y="38" text-anchor="middle" dominant-baseline="central" font-family="sans-serif" font-size="22" font-weight="700" class="text-fill">$</text>
                            </svg>
                            <span>Bud偶et</span>
                        </button>
                       <button type="button" class="task-modal-tab" data-tab="assignees" title="Osoby">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width:18px;height:18px;"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z" /></svg>
                            <span>Osoby</span>
                        </button>
                        <button type="button" class="task-modal-tab" data-tab="status" title="Status">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width:18px;height:18px;"><path stroke-linecap="round" stroke-linejoin="round" d="M9.568 3H5.25A2.25 2.25 0 003 5.25v4.318c0 .597.237 1.17.659 1.591l9.581 9.581c.699.699 1.78.872 2.607.33a18.095 18.095 0 005.223-5.223c.542-.827.369-1.908-.33-2.607L11.16 3.66A2.25 2.25 0 009.568 3z" /><path stroke-linecap="round" stroke-linejoin="round" d="M6 6h.008v.008H6V6z" /></svg>
                            <span>Status</span>
                        </button>
                        <button type="button" class="task-modal-tab" data-tab="priority" title="Priorytet">
                           <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width:18px;height:18px;"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" /></svg>
                           <span>Priorytet</span>
                        </button>
                        <button type="button" class="task-modal-tab" data-tab="attachments" title="Zaczniki">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width:18px;height:18px;"><path stroke-linecap="round" stroke-linejoin="round" d="M18.375 12.739l-7.693 7.693a4.5 4.5 0 01-6.364-6.364l10.94-10.94A3 3 0 1119.5 7.372L8.552 18.32m.009-.01l-.01.01m5.699-9.4l-7.693 7.693a2.25 2.25 0 003.182 3.182l7.693-7.693a.75.75 0 011.06 1.06l-7.693 7.693a4.5 4.5 0 01-6.364-6.364l10.94-10.94A3 3 0 1119.5 7.372L8.552 18.32" /></svg>
                            <span>Zaczniki</span>
                        </button>
                        <button type="button" class="task-modal-tab" data-tab="comments" title="Komentarze">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width:18px;height:18px;"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12.76c0 1.6 1.123 2.994 2.707 3.227 1.087.16 2.185.283 3.293.369V21l4.076-4.076a1.526 1.526 0 011.037-.443 48.282 48.282 0 005.68-.494c1.584-.233 2.707-1.626 2.707-3.228V6.741c0-1.602-1.123-2.995-2.707-3.228A48.394 48.394 0 0012 3c-2.392 0-4.744.175-7.043.513C3.373 3.746 2.25 5.14 2.25 6.741v6.018z" /></svg>
                            <span>Komentarze</span>
                        </button>
                    <button type="button" class="task-modal-tab" data-tab="checklist" title="Lista kontrolna">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width:18px;height:18px;"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75M21 12c0 1.268-.63 2.39-1.593 3.068a3.745 3.745 0 0 1-1.043 3.296 3.745 3.745 0 0 1-3.296 1.043A3.745 3.745 0 0 1 12 21c-1.268 0-2.39-.63-3.068-1.593a3.746 3.746 0 0 1-3.296-1.043 3.745 3.745 0 0 1-1.043-3.296A3.745 3.745 0 0 1 3 12c0-1.268.63-2.39 1.593-3.068a3.745 3.745 0 0 1 1.043-3.296 3.746 3.746 0 0 1 3.296-1.043A3.746 3.746 0 0 1 12 3c1.268 0 2.39.63 3.068 1.593a3.746 3.746 0 0 1 3.296 1.043 3.746 3.746 0 0 1 1.043 3.296A3.745 3.745 0 0 1 21 12Z" /></svg>
                            <span>Lista</span>
                        </button>
                    </div>
                </div>
                
                <div class="task-modal-tabs-content" style="flex-grow: 1; overflow-y: auto; padding: 24px;">
                    
                    <div id="subtask-tab-content-description" class="task-modal-tab-content active">
                        <div class="form-group">
                            <textarea id="subtask-description" rows="6" placeholder="Dodaj szczeg贸owy opis podzadania..."></textarea>
                        </div>
                    </div>

                    <div id="subtask-tab-content-dates" class="task-modal-tab-content">
                        <div class="form-group" style="margin-bottom: 16px;">
                            <label>Data rozpoczcia</label>
                            <div style="display: flex; gap: 8px;">
                                <input type="date" id="subtask-startDate-date" style="flex: 2;">
                                <select id="subtask-startDate-hour" style="flex: 1;">
                                    <script>for(let i=0;i<24;i++){document.write(`<option value="${String(i).padStart(2,'0')}">${String(i).padStart(2,'0')}</option>`)}</script>
                                </select>
                                <select id="subtask-startDate-minute" style="flex: 1;">
                                    <option value="00">00</option><option value="15">15</option><option value="30">30</option><option value="45">45</option>
                                </select>
                            </div>
                            <small id="subtask-start-error" style="color: var(--danger-primary); display: none;"></small>
                        </div>
                        <div class="form-group">
                            <label>Termin wykonania</label>
                            <div style="display: flex; gap: 8px;">
                                <input type="date" id="subtask-dueDate-date" style="flex: 2;">
                                <select id="subtask-dueDate-hour" style="flex: 1;">
                                    <script>for(let i=0;i<24;i++){document.write(`<option value="${String(i).padStart(2,'0')}">${String(i).padStart(2,'0')}</option>`)}</script>
                                </select>
                                <select id="subtask-dueDate-minute" style="flex: 1;">
                                    <option value="00">00</option><option value="15">15</option><option value="30">30</option><option value="45">45</option>
                                </select>
                            </div>
                            <small id="subtask-due-error" style="color: var(--danger-primary); display: none;"></small>
                        </div>
                    </div>

                    <div id="subtask-tab-content-effort" class="task-modal-tab-content">
                        <div class="form-group">
                            <label id="subtask-effort-label">Szacowany wysiek</label>
                            <input type="number" id="subtask-effort-input" min="0" step="1">
                            <p id="subtask-effort-unit" style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;"></p>
                        </div>
                        <div class="form-group" style="margin-top: 16px; border-top: 1px dashed var(--border-color); padding-top: 12px;">
                            <label>Rzeczywisty wysiek</label>
                            <input type="number" id="subtask-actual-effort-input" min="0" step="1">
                        </div>
                    </div>

                    <div id="subtask-tab-content-budget" class="task-modal-tab-content">
                        <p style="font-size: 13px; color: var(--text-secondary); margin-bottom: 12px;">
                            Mo偶esz przypisa koszty specyficzne dla tego podzadania.
                        </p>
                        <div class="form-group-checkbox">
                            <input type="checkbox" id="subtask-budget-toggle">
                            <label for="subtask-budget-toggle">Przypisz koszty</label>
                        </div>
                        <div id="subtask-budget-details" style="display: none; margin-top: 12px; background-color: var(--bg-primary); padding: 12px; border-radius: var(--border-radius);">
                            <ul id="subtask-budget-items" style="list-style: none; padding: 0;"></ul>
                            <button type="button" id="subtask-add-budget-item-btn" class="btn btn-secondary" style="margin-top: 8px; font-size: 12px;">+ Dodaj pozycj</button>
                        </div>
                    </div>

                    <div id="subtask-tab-content-assignees" class="task-modal-tab-content">
                        <div class="form-group">
                            <label>Wyszukaj i przypisz</label>
                            <div class="member-search-container" style="margin-bottom: 8px;">
                                <input type="text" id="subtask-member-search" class="member-search-input" placeholder="Wpisz nazw lub e-mail...">
                                <ul id="subtask-member-search-results" class="member-search-results"></ul>
                            </div>
                        </div>
                        
                        <div class="members-dual-view">
                            <div class="members-column">
                                <div class="members-column-header">Dostpni Pracownicy</div>
                                <div id="subtask-modal-assignees-list" class="members-scroll-area members-selection-pills" style="background: transparent; padding: 8px; border: none;"></div>
                            </div>

                            <div class="members-column">
                                <div class="members-column-header">Wybrani Wykonawcy</div>
                                <div id="subtask-selected-list" class="members-scroll-area">
                                    <p style="color: var(--text-secondary); font-size: 13px; text-align: center; margin-top: 20px;">Brak wybranych os贸b.</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="subtask-tab-content-status" class="task-modal-tab-content">
                        <div class="form-group">
                            <label for="subtask-status-select">Status podzadania</label>
                            <select id="subtask-status-select" style="margin-bottom: 12px; font-weight: 500;">
                                <option value="todo">Do realizacji</option>
                                <option value="inprogress">W trakcie realizacji</option>
                                <option value="done">Wykonane</option>
                            </select>
                            
                            <div id="subtask-multi-status-container" style="display: none; margin-top: 8px; padding: 12px; background-color: var(--bg-tertiary); border-radius: var(--border-radius); border: 1px solid var(--border-color);">
                            </div>
                            </div>
                    </div>

                    <div id="subtask-tab-content-priority" class="task-modal-tab-content">
                        <div class="form-group">
                            <label for="subtask-priority-select">Priorytet podzadania</label>
                            <select id="subtask-priority-select">
                                <option value="low">Niski</option>
                                <option value="medium" selected>redni</option>
                                <option value="high">Wysoki</option>
                            </select>
                        </div>
                        
                         <div style="margin-top: 20px; padding-top: 16px; border-top: 1px dashed var(--border-color);">
                            <div class="form-group-checkbox">
                                <input type="checkbox" id="subtask-warning-override">
                                <label for="subtask-warning-override">Indywidualne ostrze偶enie o terminie</label>
                            </div>
                            <div id="subtask-warning-wrapper" style="display: none; margin-top: 8px; padding-left: 28px;">
                                <label style="font-size: 12px; color: var(--text-secondary); display:block; margin-bottom:4px;">Ile dni przed terminem?</label>
                                <input type="number" id="subtask-warning-days" min="1" max="60" value="3" placeholder="np. 1" style="width: 80px;">
                            </div>
                        </div>
                    </div>

                    <div id="subtask-tab-content-attachments" class="task-modal-tab-content">
                        <div class="new-task-attachments-container">
                            <input type="file" id="subtask-attachment-input" style="display: none;" multiple>
                            <button type="button" id="add-subtask-attachment-btn" class="btn btn-secondary">Dodaj zacznik</button>
                            <ul id="subtask-attachments-list" class="attachments-list" style="margin-top: 12px;"></ul>
                        </div>
                    </div>

                    <div id="subtask-tab-content-comments" class="task-modal-tab-content">
                        <div class="task-modal-section comments">
                            <div class="comment-input-area">
                                <textarea id="subtask-new-comment" placeholder="Napisz komentarz..." rows="1"></textarea>
                                <button type="button" class="btn btn-primary" id="subtask-add-comment-btn">Dodaj</button> 
                                </div>
                            <ul id="subtask-comments-list" class="comments-list"></ul>
                        </div>
                    </div>

                    <div id="subtask-tab-content-checklist" class="task-modal-tab-content">
                        <div class="form-group-checkbox">
                            <input type="checkbox" id="subtask-checklist-toggle">
                            <label for="subtask-checklist-toggle">Wcz list kontroln</label>
                        </div>
                        <div id="subtask-checklist-wrapper" style="display: none; margin-top: 12px;">
                            <p style="font-size: 12px; color: var(--text-secondary); margin-bottom: 10px;">
                                Wszystkie elementy listy musz zosta ukoczenie, aby mo偶na byo zakoczy to podzadanie.
                            </p>
                            <ul id="subtask-checklist-items" style="list-style: none; padding: 0; margin-bottom: 12px;">
                                </ul>
                            <button type="button" id="add-checklist-item-btn" class="btn btn-secondary" style="font-size: 12px;">+ Dodaj element listy</button>
                            <p id="subtask-checklist-error" class="error-message" style="margin-top: 8px; display: none;"></p>
                        </div>
                    </div>

                </div>
            </div>

            <div class="modal-footer" style="flex-shrink: 0;">
                <button type="button" id="finish-subtask-btn" class="btn btn-success" style="display: none; margin-right: auto;"> Zakocz</button>
                <button type="button" class="btn btn-secondary modal-close-btn">Anuluj</button>
                <button type="submit" id="subtask-save-btn" class="btn btn-primary">Zapisz podzadanie</button>
            </div>
        </form>
    </div>
</div>
   </div> <div class="modal-overlay" id="project-templates-modal">
        <div class="modal"> <div style="width: 300px; border-right: 1px solid var(--border-color); display: flex; flex-direction: column;">
                <div class="modal-header" style="flex-shrink: 0;">
                    <h2>Szablony</h2>
                </div>
                <div class="form-modal-content" style="flex-grow: 1;">
                    <ul id="templates-list" class="nav-list" style="padding-left: 0;">
                        <li><em style="color: var(--text-secondary);">adowanie szablon贸w...</em></li>
                    </ul>
                </div>
                <div class="modal-footer" style="flex-shrink: 0;">
                    <button type="button" id="add-new-template-btn" class="btn btn-primary" style="width: 100%;">+ Nowy Szablon</button>
                </div>
            </div>
            <div id="template-details-view" style="flex-grow: 1; display: flex; flex-direction: column;">
                <div class="modal-header" style="flex-shrink: 0;">
                    <h2 id="template-details-title">Wybierz szablon</h2>
                    <button type="button" class="modal-close-btn">&times;</button>
                </div>
                <div class="form-modal-content" style="flex-grow: 1;">
                    <div id="template-details-content">
                        <p style="color: var(--text-secondary); text-align: center; margin-top: 40px;">Wybierz szablon z listy po lewej, aby zobaczy szczeg贸y lub utworzy nowy.</p>
                    </div>
                </div>
                <div class="modal-footer" style="flex-shrink: 0;">
                    <button type="button" id="edit-template-btn" class="btn btn-secondary" style="margin-right: auto; display: none;">Edytuj szablon</button>
                    <button type="button" id="delete-template-btn" class="btn btn-danger" style="margin-right: auto; display: none;">Usu szablon</button>
                    <button type="button" id="create-project-from-template-btn" class="btn btn-primary" disabled>Stw贸rz projekt z szablonu</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="template-edit-modal">
        <div class="modal">
            <form id="template-edit-form">
                <div class="modal-header">
                    <h2 id="template-edit-title">Nowy Szablon Projektu</h2>
                    <button type="button" class="modal-close-btn">&times;</button>
                </div>
                <div class="form-modal-content">
                    <input type="hidden" id="template-edit-id">
                    <div class="form-group">
                        <label for="template-edit-name">Nazwa Szablonu</label>
                        <input type="text" id="template-edit-name" required>
                    </div>
                    <div class="form-group">
                        <label for="template-edit-description">Opis Szablonu</label>
                        <textarea id="template-edit-description" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Zadania w Szablonie</label>
                        <ul id="template-edit-tasks-list" style="list-style: none; padding-left: 0; max-height: 200px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: var(--border-radius); padding: 8px; margin-top: 4px; background-color: var(--bg-primary);">
                           <li class="template-task-item-empty" style="font-style: italic; color: var(--text-secondary); font-size: 13px;">Brak zada.</li>
                        </ul>
                        <button type="button" id="add-template-task-btn" class="btn btn-secondary" style="margin-top: 8px; display: flex; align-items: center; gap: 4px;">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" style="width: 16px; height: 16px;"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg>
                            Dodaj zadanie
                        </button>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary modal-close-btn">Anuluj</button>
                    <button type="submit" class="btn btn-primary">Zapisz Szablon</button>
                </div>
            </form>
        </div>
    </div>
   <div class="modal-overlay" id="project-filter-modal">
    <div class="modal" style="max-width: 500px; max-height: 90vh; height: auto;">
        <div class="modal-header">
            <h2>Filtrowanie zada</h2>
            <button type="button" class="modal-close-btn">&times;</button>
        </div>
        <div class="form-modal-content" style="padding-bottom: 8px;">

            <div class="form-group" style="border-bottom: 1px solid var(--border-color); padding-bottom: 8px;">
                <label>Osoba Przypisana</label>
                <div id="filter-assignee-list-container" style="background-color: var(--bg-primary); border: 1px solid var(--border-color); border-radius: var(--border-radius); max-height: 200px; overflow-y: auto; padding: 8px;">
                    </div>
            </div>

            <div class="form-group" style="border-bottom: 1px solid var(--border-color); padding-bottom: 8px;">
                <label for="filter-priority">Priorytet</label>
                <select id="filter-priority">
                    <option value="">Wszystkie priorytety</option>
                    <option value="high">Wysoki</option>
                    <option value="medium">redni</option>
                    <option value="low">Niski</option>
                </select>
            </div>

            <div class="form-group" style="border-bottom: 1px solid var(--border-color); padding-bottom: 8px;">
                <label for="filter-dueDate">Termin Wykonania</label>
                <select id="filter-dueDate">
                    <option value="">Wszystkie terminy</option>
                    <option value="overdue">Op贸藕nione</option>
                    <option value="upcoming">Nadchodzce (do 7 dni)</option>
                    <option value="no-date">Bez terminu</option>
                </select>
            </div>

            <div class="form-group">
                <label for="filter-budgetStatus">Status Bud偶etowy</label>
                <select id="filter-budgetStatus">
                    <option value="">Wszystkie statusy</option>
                    <option value="has-budget">Maj przypisane koszty</option>
                    <option value="no-budget">Nie maj przypisanych koszt贸w</option>
                </select>
            </div>
            <div class="form-group" style="border-top: 1px solid var(--border-color); padding-top: 16px; margin-top: 16px;">
                <label>Widoczno element贸w</label>
                
                <label for="filter-showPolls" class="toggle-switch"> 
                    <input type="checkbox" id="filter-showPolls" checked> 
                    <span class="toggle-switch-slider"></span>
                    <span class="toggle-switch-text">Poka偶 Sonda偶e</span>
                </label>
            </div>

            <p id="filter-status-message" class="error-message" style="color: var(--text-secondary); min-height: 20px; font-size: 13px; margin-bottom: 0;">Filtrowanie aktywne: Brak</p>
        </div>
        <div class="modal-footer">
            <button type="button" id="filter-apply-btn" class="btn btn-primary">Zastosuj filtry</button>
            <button type="button" id="filter-clear-btn" class="btn btn-secondary">Wyczy filtry</button>
        </div>
    </div>
</div>

    <div class="modal-overlay" id="project-details-modal">
        <div class="modal" style="max-width: 950px; height: 85vh;"> 
            <div class="modal-header">
                <h2 id="project-details-title">Szczeg贸y Projektu</h2>
                <button type="button" class="modal-close-btn">&times;</button>
            </div>
            <div class="form-modal-content">
                <div class="project-details-info">
                    <h3 style="margin-bottom: 16px; border-bottom: 1px solid var(--border-color); padding-bottom: 8px;">Informacje Og贸lne</h3>
                    <p><strong>Nazwa:</strong> <span id="details-project-name">-</span></p>
                    <p><strong>Waciciel:</strong> <span id="details-project-owner">-</span></p>
                    <p style="margin-bottom: 8px;"><strong>Czonkowie:</strong>
                        <div id="details-project-members" class="project-members" style="margin-top: 4px; justify-content: flex-start;">-</div>
                    </p>
                    <p><strong>Opis:</strong></p>
                    <p id="details-project-description" style="white-space: pre-wrap; background-color: var(--bg-primary); padding: 8px; border-radius: var(--border-radius); min-height: 50px;">-</p>
                    <p style="margin-top: 8px;"><strong>Data rozpoczcia:</strong> <span id="details-project-start">-</span></p>
                    <p><strong>Data zakoczenia:</strong> <span id="details-project-end">-</span></p>
                    <p><strong>Priorytet:</strong> <span id="details-project-priority">-</span></p>
                </div>

                <div class="project-details-charts">
                    <div class="budget-chart-section" style="margin-bottom: 16px;">
                        <div class="collapsible-header collapsed" data-target="#details-budget-chart-container">
                            <h3>Bud偶et Projektu</h3>
                            <div class="collapsible-controls"> <span class="toggle-text">Rozwi</span> <svg class="chevron" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="m19.5 8.25-7.5 7.5-7.5-7.5" /> </svg>
                            </div>
                        </div>
                        <div id="details-budget-chart-container" class="collapsible-content collapsed">
                            <p style="color: var(--text-secondary);">adowanie danych bud偶etowych...</p>
                        </div>
                    </div>

                    <div class="budget-tasks-table-section" style="margin-top: 0; grid-column: 1 / -1; margin-bottom: 16px;">
                        <div class="collapsible-header collapsed" data-target="#details-budget-tasks-table-container">
                             <h3>Szczeg贸owe Obci偶enia Bud偶etu</h3>
                             <div class="collapsible-controls"> <span class="toggle-text">Rozwi</span> <svg class="chevron" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="m19.5 8.25-7.5 7.5-7.5-7.5" /> </svg>
                            </div>
                        </div>
                        <div id="details-budget-tasks-table-container" class="collapsible-content collapsed">
                             <p style="color: var(--text-secondary); padding: 12px;">adowanie danych o kosztach zada...</p>
                        </div>
                    </div>
                    
                    <div class="workload-chart-section">
                        <div class="collapsible-header collapsed" data-target="#details-workload-chart-container">
                            <h3>Obci偶enie Zespou</h3>
                             <div class="collapsible-controls"> <span class="toggle-text">Rozwi</span> <svg class="chevron" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="m19.5 8.25-7.5 7.5-7.5-7.5" /> </svg>
                            </div>
                        </div>
                        <div id="details-workload-chart-container" class="collapsible-content collapsed" style="position: relative;">
                             <p id="workload-chart-placeholder" style="color: var(--text-secondary);">adowanie danych o obci偶eniu...</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary modal-close-btn">Zamknij</button>
            </div>
        </div>
    </div>
    <div class="modal-overlay" id="new-poll-modal">
        <div class="modal" style="max-width: 600px; height: auto; max-height: 80vh;">
            <form id="new-poll-form">
                <div class="modal-header">
                    <h2>Nowy Sonda偶</h2>
                    <button type="button" class="modal-close-btn">&times;</button>
                </div>
                <div class="form-modal-content">
                    
                    <div class="form-group">
                        <label for="new-poll-title">Tytu sonda偶u</label>
                        <input type="text" id="new-poll-title" required placeholder="np. Wyb贸r miejsca na kolacj integracyjn">
                    </div>
                    <div class="form-group">
                        <label for="new-poll-description">Cel i opis (opcjonalnie)</label>
                        <textarea id="new-poll-description" rows="3" placeholder="Wpisz tutaj cel sonda偶u lub dodatkowe informacje..."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Opcje gosowania</label>
                        <ul id="new-poll-options-list" style="list-style: none; padding: 0; margin-top: 4px;">
                            <li class="poll-option-item" style="display: flex; gap: 8px; align-items: center; margin-bottom: 6px;">
                                <input type="text" class="new-poll-option-input" placeholder="Wpisz opcj 1" value="" style="flex: 1;">
                                <button type="button" class="delete-poll-option-btn btn btn-secondary" style="padding: 2px 6px; font-size: 14px; line-height: 1;">&times;</button>
                            </li>
                            <li class="poll-option-item" style="display: flex; gap: 8px; align-items: center; margin-bottom: 6px;">
                                <input type="text" class="new-poll-option-input" placeholder="Wpisz opcj 2" value="" style="flex: 1;">
                                <button type="button" class="delete-poll-option-btn btn btn-secondary" style="padding: 2px 6px; font-size: 14px; line-height: 1;">&times;</button>
                            </li>
                        </ul>
                        <button type="button" id="add-poll-option-btn" class="btn btn-secondary" style="margin-top: 8px; font-size: 13px; padding: 4px 8px;">+ Dodaj opcj</button>
                    </div>

                    <div class="form-group">
                        <label for="new-poll-deadline">Termin gosowania (opcjonalnie)</label>
                        <input type="datetime-local" id="new-poll-deadline">
                    </div>

                    <div class="form-group">
                        <label>Uczestnicy (kto ma gosowa)</label>
                        <div id="new-poll-assignees" class="members-selection-pills">
                            </div>
                    </div>

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary modal-close-btn">Anuluj</button>
                    <button type="submit" class="btn btn-primary">Utw贸rz sonda偶</button>
                </div>
            </form>
        </div>
    </div>
    <div class="modal-overlay" id="poll-details-modal">
        <div class="modal" style="max-width: 600px; height: auto; max-height: 80vh;">
            <div class="modal-header">
                <h2 id="poll-details-title">Szczeg贸y sonda偶u</h2>
                <button type="button" class="modal-close-btn">&times;</button>
            </div>
            <div class="form-modal-content" id="poll-details-content">
                <p style="color: var(--text-secondary);">adowanie danych sonda偶u...</p>
            </div>
            <div class="modal-footer" id="poll-details-footer">
                <button type="button" id="poll-details-delete-btn" class="btn btn-danger" style="display: none; margin-right: auto;">Usu sonda偶</button>
                <button type="button" id="poll-details-close-btn" class="btn btn-secondary" style="display: none; margin-left: 8px;">Zakocz sonda偶</button>
                
                <button type="button" id="poll-details-change-vote-btn" class="btn btn-primary" style="display: none; margin-right: 8px;">Zmie gos</button>
                <button type="button" class="btn btn-secondary modal-close-btn">Zamknij</button>
            </div>
        </div>
    </div>
    <div id="resources-menu-content" style="display: none;">
        <div class="mobile-actions-menu" style="display: block; box-shadow: none; border: none; padding: 0;">
            <ul>
                <li><a href="#" data-action="templates">Szablony Projekt贸w</a></li>
                <li><a href="#" data-action="archive">Archiwum Projekt贸w</a></li>
            </ul>
        </div>
    </div>
    
    <div class="modal-overlay" id="invite-member-modal">
        <div class="modal" style="max-width: 400px;">
            <form id="invite-member-form">
                <div class="modal-header">
                    <h2>Zapro do grupy</h2>
                    <button type="button" class="modal-close-btn">&times;</button>
                </div>
                <div class="form-modal-content">
                    <p style="font-size: 14px; color: var(--text-secondary); margin-bottom: 16px;">
                        Wpisz adres e-mail osoby, kt贸r chcesz zaprosi. Otrzyma ona e-mail z linkiem rejestracyjnym do Twojej grupy.
                    </p>
                    <div class="form-group">
                        <label for="invite-member-email">Adres e-mail</label>
                        <input type="email" id="invite-member-email" required>
                    </div>
                    <p id="invite-member-error" class="error-message"></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary modal-close-btn">Anuluj</button>
                    <button type="submit" class="btn btn-primary">Wylij zaproszenie</button>
                </div>
            </form>
        </div>
    </div>
    <div class="modal-overlay" id="cover-templates-modal">
    <div class="modal">
        <div class="modal-header">
            <h2>Wybierz szablon bannera</h2>
            <button type="button" class="modal-close-btn">&times;</button>
        </div>
        <p style="font-size: 14px; color: var(--text-secondary); margin: 10px 24px 16px 24px; text-align: center;">
            Pamitaj, 偶e po dodaniu zacznika do zadania w formacie .png/.jpeg mo偶esz u偶y wasnego obrazka jako bannera.
        </p>
        <div class="form-modal-content">
            <div id="cover-templates-grid">
                <p style="color: var(--text-secondary);">adowanie szablon贸w...</p>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary modal-close-btn">Anuluj</button>
            </div>
    </div>
</div>
    <div class="modal-overlay" id="create-first-group-modal" data-backdrop-static="true">
        <div class="modal" style="max-width: 450px; height: auto;">
            <form id="create-first-group-form">
                <div class="modal-header">
                    <h2>Witaj w TeamFlow!</h2>
                    </div>
                <div class="form-modal-content">
                    <p style="font-size: 14px; color: var(--text-secondary); margin-bottom: 16px;">
                        Wyglda na to, 偶e logujesz si po raz pierwszy. Aby zacz, stw贸rz swoj pierwsz przestrze robocz (grup).
                    </p>
                    <div class="form-group">
                        <label for="first-group-name">Nazwa Twojej Grupy</label>
                        <input type="text" id="first-group-name" placeholder="np. Moja Firma, Projekty Prywatne" required>
                    </div>
                </div>
                <div class="modal-footer" style="justify-content: space-between;">
                    <a href="#" id="logout-from-first-group-modal" style="font-size: 14px; color: var(--text-secondary);">Wyloguj si</a>
                    <button type="submit" class="btn btn-primary">Stw贸rz grup i kontynuuj</button>
                </div>
            </form>
        </div>
    </div>
    <div class="modal-overlay" id="create-new-group-modal">
        <div class="modal" style="max-width: 450px; height: auto;">
            <form id="create-new-group-form">
                <div class="modal-header">
                    <h2>Stw贸rz now grup (Przestrze robocz)</h2>
                    <button type="button" class="modal-close-btn">&times;</button>
                </div>
                <div class="form-modal-content">
                    <p style="font-size: 14px; color: var(--text-secondary); margin-bottom: 16px;">
                        Utw贸rz now, oddzieln przestrze do zarzdzania innym zespoem lub projektami.
                    </p>
                    <div class="form-group">
                        <label for="new-group-name">Nazwa Nowej Grupy</label>
                        <input type="text" id="new-group-name" placeholder="np. Klient ABC, Projekty Hobbystyczne" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary modal-close-btn">Anuluj</button>
                    <button type="submit" class="btn btn-primary">Stw贸rz grup</button>
                </div>
            </form>
        </div>
    </div>
    <div class="modal-overlay" id="join-group-modal">
        <div class="modal" style="max-width: 450px; height: auto;">
            <form id="join-group-form">
                <div class="modal-header">
                    <h2>Docz do istniejcej grupy</h2>
                    <button type="button" class="modal-close-btn">&times;</button>
                </div>
                <div class="form-modal-content">
                    <p style="font-size: 14px; color: var(--text-secondary); margin-bottom: 16px;">
                        Wpisz dokadn nazw grupy, do kt贸rej chcesz wysa prob o doczenie.
                    </p>
                    <div class="form-group">
                        <label for="join-group-name-input">Nazwa grupy</label>
                        <input type="text" id="join-group-name-input" placeholder="np. Firma Klienta ABC" required>
                    </div>
                    <p id="join-group-error" class="error-message"></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary modal-close-btn">Anuluj</button>
                    <button type="submit" class="btn btn-primary">Wylij prob</button>
                </div>
            </form>
        </div>
    </div>
    
    <div class="modal-overlay" id="waiting-room-overlay" data-backdrop-static="true" style="z-index: 10002;">
        <div class="auth-container">
            <h2>Proba wysana!</h2>
            <p style="font-size: 14px; color: var(--text-secondary); margin-top: 16px; line-height: 1.6;">
                Twoja proba o doczenie do grupy <strong id="waiting-room-group-name">...</strong> zostaa wysana do waciciela.
            </p>
            <p style="font-size: 14px; color: var(--text-primary); margin-top: 16px;">
                Gdy Twoja proba zostanie zaakceptowana, aplikacja odwie偶y si automatycznie. Mo偶esz te偶 wylogowa si i spr贸bowa p贸藕niej.
            </p>
            <p id="waiting-room-status" style="font-size: 14px; font-weight: 600; color: var(--accent-primary); margin-top: 16px;">
                Status: Oczekujca
            </p>
            <button id="logout-from-waiting-room" class="btn btn-secondary" style="margin-top: 24px;">Wyloguj si</button>
        </div>
    </div>
    <div class="modal-overlay" id="task-dependency-modal">
        <div class="modal" style="max-width: 500px; height: 70vh;">
            <div class="modal-header">
                <h2 id="task-dependency-title">Powi偶 zadanie</h2>
                <button type="button" class="modal-close-btn">&times;</button>
            </div>
            <div class="form-modal-content">
                <p id="task-dependency-intro" style="font-size: 14px; color: var(--text-secondary); margin-bottom: 16px;">Wybierz zadanie, kt贸re musi zosta ukoczone przed tym.</p>
                <div id="dependency-task-list" class="form-group" style="max-height: 400px; overflow-y: auto;">
                    </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary modal-close-btn">Anuluj</button>
                <button type="button" id="confirm-dependency-btn" class="btn btn-primary" disabled>Utw贸rz powizanie</button>
            </div>
        </div>
    </div>
    <svg width="0" height="0" style="position:absolute; display: none;">
        <symbol id="icon-bell" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
            <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
        </symbol>
    <symbol id="icon-link" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
            </symbol>
            </svg>
            
        <div class="chat-panel" id="project-chat-panel">
            <div class="chat-panel-header">
                <h3>Chat Projektu</h3>
                <button type="button" class="modal-close-btn" id="close-chat-panel-btn">&times;</button>
            </div>
            <div class="chat-panel-content">
                <div class="chat-messages" id="chat-messages-list">
                    </div>
            </div>
            <div class="chat-panel-footer">
                <textarea id="chat-message-input" placeholder="Napisz wiadomo..." rows="1"></textarea>
                <button class="btn btn-primary" id="send-chat-message-btn" title="Wylij">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 20px; height: 20px;">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 12 3.269 3.125A59.769 59.769 0 0 1 21.485 12 59.768 59.768 0 0 1 3.27 20.875L6 12Zm0 0h7.5" />
                    </svg>
                </button>
            </div>
        </div>
        <div class="modal-overlay" id="bulk-assign-modal">
            <div class="modal" style="max-width: 500px; height: auto; max-height: 70vh;">
                <form id="bulk-assign-form">
                    <div class="modal-header">
                        <h2>Zmie przypisanych</h2>
                        <button type="button" class="modal-close-btn">&times;</button>
                    </div>
                    <div class="form-modal-content">
                        <p style="font-size: 14px; color: var(--text-secondary); margin-bottom: 16px;">
                            Wybierz jedn lub wicej os贸b, kt贸re maj zosta przypisane do zaznaczonych zada. Poprzednie przypisania zostan nadpisane.
                        </p>
                        <div class="form-group">
                            <label>Wybierz czonk贸w projektu</label>
                            <div id="bulk-assign-members-list" class="members-selection-pills">
                                <p>adowanie czonk贸w...</p>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary modal-close-btn">Anuluj</button>
                        <button type="button" id="bulk-assign-save-btn" class="btn btn-primary">Zapisz zmiany</button>
                    </div>
                </form>
            </div>
        </div>
    <div class="modal-overlay" id="welcome-modal" data-backdrop-static="true">
        <div class="modal" style="max-width: 500px; height: auto;">
            <div class="modal-header">
                <h2>Witaj w TeamFlow!</h2>
                <button type="button" class="modal-close-btn" style="display: none;">&times;</button>
            </div>
            <div class="form-modal-content">

                <div class="welcome-intro-flex">
                    <img src="TeamFlowAI.png" alt="TeamFlow AI Icon" style="width: 180px; height: 180px; border-radius: 12px; box-shadow: var(--shadow-md); flex-shrink: 0;">
                    
                    <p style="font-size: 15px; line-height: 1.6; margin-bottom: 0;"> 
                        Cieszymy si, 偶e tu jeste. TeamFlow to Twoje centrum dowodzenia do zarzdzania projektami i organizowania dnia pracy.
                    </p>
                </div>
                <p style="font-size: 15px; line-height: 1.6; margin-top: 20px;">
                    Odkryj moc naszego <strong>Asystenta AI</strong>, dostpnego w menu w lewym dolnym rogu (ikona 
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 18px; height: 18px; vertical-align: text-bottom; color: var(--accent-primary);">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904 9 18.75l-.813-2.846a4.5 4.5 0 0 0-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 0 0 3.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 0 0 3.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 0 0-3.09 3.09Z" />
                    </svg>
                    ). Asystent nie tylko wyjani Ci funkcje aplikacji, ale przede wszystkim pomo偶e w aktywnej analizie Twoich danych.
                </p>
                <p style="font-size: 13px; line-height: 1.6; color: var(--text-secondary); margin-top: 16px; padding-left: 12px; border-left: 3px solid var(--border-color);">
                    Zapytaj go na przykad: <br>
                    <em>"Kt贸re projekty maj op贸藕nienia?"</em><br>
                    <em>"Kto w zespole ma najwicej aktywnych zada?"</em><br>
                    <em>"Jaki jest status bud偶etu w projekcie X?"</em>
                </p>
            </div>
            <div class="modal-footer" style="justify-content: space-between; align-items: center;">
                <div class="form-group-checkbox welcome-modal-footer-prefs" style="margin: 0;">
                    <input type="checkbox" id="welcome-modal-dont-show-again">
                    <label for="welcome-modal-dont-show-again" style="font-weight: 500; font-size: 13px;">Nie pokazuj wicej</label>
                </div>
                <button type="button" id="welcome-modal-ok-btn" class="btn btn-primary">Rozumiem</button>
            </div>
        </div>
    </div>
    <div class="modal-overlay" id="ai-settings-modal">
        <div class="modal" style="max-width: 450px; height: auto;">
            <div class="modal-header">
                <h2>Ustawienia Asystenta AI</h2>
                <button type="button" class="modal-close-btn">&times;</button>
            </div>
            <div class="form-modal-content">
                <div class="form-group ai-voice-setting-row">
                    <label for="ai-voice-select">Wybierz gos lektora</label>
                    <select id="ai-voice-select">
                        <option value="">adowanie gos贸w...</option>
                    </select>
                    <button type="button" id="ai-voice-test-btn" class="btn btn-secondary" title="Testuj gos" style="padding: 10px;">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24" role="img" aria-labelledby="playTitle">
                         <title id="playTitle">Play</title>
                          <path d="M8 5v14l11-7z" fill="var(--text-secondary)" />
                        </svg>
                    </button>
                </div>
                </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary modal-close-btn">Zamknij</button>
            </div>
        </div>
    </div>
    
    <div class="modal-overlay" id="custom-columns-modal">
        <div class="modal" style="max-width: 500px; height: auto; max-height: 70vh;">
            <div class="modal-header">
                <h2>Zarzdzaj kolumnami</h2>
                <button type="button" class="modal-close-btn">&times;</button>
            </div>
            <div class="form-modal-content">
                <p style="font-size: 14px; color: var(--text-secondary); margin-bottom: 16px;">
                    Dodaj wasne etapy dla zada "W trakcie realizacji". Mo偶esz zmienia ich kolejno, przecigajc je.
                </p>
                <div class="form-group">
                    <label>Kolejno kolumn (Przecignij i upu)</label>
                    <ul id="custom-columns-list" class="attachments-list" style="margin-top: 4px; padding: 8px; background-color: var(--bg-primary); min-height: 50px;">
                        <li class="attachment-item" data-id="inprogress" style="background-color: var(--bg-tertiary); opacity: 0.8; cursor: not-allowed;">
                            <div class="attachment-info" style="gap: 12px;">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" style="width: 16px; height: 16px; color: var(--text-secondary);"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" /></svg>
                                <span>W trakcie realizacji (Domylna)</span>
                            </div>
                        </li>
                        </ul>
                </div>
                
                <form id="add-custom-column-form" style="margin-top: 24px; border-top: 1px solid var(--border-color); padding-top: 16px;">
                    <div class="form-group">
                        <label for="new-column-name-input">Dodaj now kolumn</label>
                        <div style="display: flex; gap: 8px;">
                            <input type="text" id="new-column-name-input" required placeholder="np. Wstrzymane, Do akceptacji">
                            <button type="submit" class="btn btn-primary">Dodaj</button>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary modal-close-btn">Anuluj</button>
                <button type="button" id="save-custom-columns-btn" class="btn btn-primary">Zapisz zmiany</button>
            </div>
        </div>
    </div>
    <div class="modal-overlay" id="background-color-modal">
        <div class="modal" style="max-width: 500px;">
            <div class="modal-header">
                <h2>Wybierz kolor kafelka</h2>
                <button type="button" class="modal-close-btn">&times;</button>
            </div>
            <div class="form-modal-content">
                <div id="background-colors-grid">
                    </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary modal-close-btn">Anuluj</button>
            </div>
        </div>
    </div>
    <div class="modal-overlay" id="tutorial-modal" style="padding: 0;"> <div class="modal" style="width: 100%; height: 100%; max-width: none; max-height: none; padding: 0; border-radius: 0; display: flex; flex-direction: column;">
        
        <div class="modal-header">
            <h2>Akademia TeamFlow</h2>
            <button type="button" class="modal-close-btn">&times;</button>
        </div>

        <div class="settings-container">
            <aside class="settings-sidebar" style="width: 300px; overflow-y: auto;">
                <div class="settings-nav" id="tutorial-tree-nav">
                    </div>
            </aside>

            <main class="settings-content" id="tutorial-content-area" style="padding: 40px;">
                <div class="tutorial-welcome-screen" style="text-align: center; margin-top: 80px;">
                    <div style="font-size: 64px; margin-bottom: 20px;"></div>
                    <h3 style="font-size: 24px; margin-bottom: 12px;">Witaj w Centrum Wiedzy!</h3>
                    <p style="color: var(--text-secondary); max-width: 450px; margin: 0 auto; line-height: 1.6;">
                        Wybierz temat z menu po lewej stronie, aby obejrze kr贸tkie instrukcje wideo.
                        <br><br>
                        Dowiedz si, jak w peni wykorzysta funkcje zarzdzania czasem, bud偶etem i zespoem.
                        
                        <br><br>
                        
                        <span style="display: inline-flex; align-items: center; gap: 8px; color: var(--text-primary); font-size: 15px;">
                            <img src="TeamFlowAI.png" alt="TeamFlow AI" style="width: 28px; height: 28px; object-fit: cover; border-radius: 6px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <strong>Pamitaj o naszym asystencie AI:</strong>
                        </span>
                        <br>
                        <span style="display: block; margin-top: 6px;">
                            Tw贸j inteligentny partner potrafi tworzy i edytowa projekty oraz zadania, zarzdza kolumnami, analizowa bud偶et oraz odpowiada na pytania o postpy prac  obsugujesz go tekstowo lub gosowo.
                        </span>
                    </p>
                </div>
            </main>
        </div>

        <div class="modal-footer" style="border-top: 1px solid var(--border-color);">
            <button type="button" class="btn btn-secondary modal-close-btn" style="margin-left: auto;">Zamknij</button>
        </div>
    </div>
</div>
    <div class="modal-overlay" id="transfer-ownership-modal">
    <div class="modal" style="max-width: 450px;">
        <form id="transfer-ownership-form">
            <div class="modal-header">
                <h2>Przeka偶 wasno grupy</h2>
                <button type="button" class="modal-close-btn">&times;</button>
            </div>
            <div class="form-modal-content">
                <p style="font-size: 14px; color: var(--text-secondary); margin-bottom: 16px;">
                    Jeste wacicielem tej grupy. Aby j opuci, musisz najpierw przekaza swoje obowizki (wasno grupy oraz wszystkich Twoich projekt贸w) innemu czonkowi.
                </p>
                <div class="form-group">
                    <label for="new-owner-select">Wybierz nowego waciciela grupy</label>
                    <select id="new-owner-select" required>
                        <option value="">-- Wybierz czonka... --</option>
                    </select>
                </div>
                <p id="transfer-ownership-error" class="error-message"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary modal-close-btn">Anuluj</button>
                <button type="submit" class="btn btn-danger">Przeka偶 wasno i opu grup</button>
            </div>
        </form>
    </div>
</div>
    <div class="modal-overlay" id="trash-modal">
    <div class="modal" style="max-width: 600px; height: 70vh;">
        <div class="modal-header">
            <h2>Kosz projektu</h2>
            <button type="button" class="modal-close-btn">&times;</button>
        </div>
        <div class="form-modal-content">
            <p style="font-size: 14px; color: var(--text-secondary); margin-bottom: 16px;">
                Zadania znajdujce si w koszu nie s widoczne na tablicy ani w statystykach. Mo偶esz je przywr贸ci lub usun bezpowrotnie.
            </p>
            <ul id="trash-list" class="attachments-list" style="overflow-y: auto; flex-grow: 1;">
                </ul>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary modal-close-btn">Zamknij</button>
        </div>
    </div>
</div>

<style>
    /* Nowe style dla element贸w kosza */
    .trash-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px;
        background-color: var(--bg-primary);
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius);
        margin-bottom: 8px;
    }
    .trash-item-info {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }
    .trash-item-title {
        font-weight: 600;
        font-size: 14px;
        text-decoration: line-through; /* Przekrelenie sugeruje usunicie */
        color: var(--text-secondary);
    }
    .trash-item-meta {
        font-size: 11px;
        color: var(--text-secondary);
    }
    .trash-item-actions {
        display: flex;
        gap: 8px;
    }
    .btn-restore {
        background-color: var(--success-primary);
        color: white;
        border: none;
        padding: 6px 12px;
        border-radius: 4px;
        font-size: 12px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 4px;
    }
    .btn-restore:hover {
        opacity: 0.9;
    }
    .btn-delete-forever {
        background-color: transparent;
        border: 1px solid var(--danger-primary);
        color: var(--danger-primary);
        padding: 6px 12px;
        border-radius: 4px;
        font-size: 12px;
        cursor: pointer;
    }
    .btn-delete-forever:hover {
        background-color: var(--danger-primary);
        color: white;
    }
    /* === STYLE DLA RAPORTU PROJEKTU (POST-MORTEM) === */
    .report-section {
        background-color: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius);
        padding: 20px;
        margin-bottom: 24px;
        box-shadow: var(--shadow-sm);
    }
    .report-section-title {
        font-size: 16px;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 16px;
        padding-bottom: 8px;
        border-bottom: 2px solid var(--bg-tertiary);
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .report-kpi-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 16px;
    }
    .report-kpi-card {
        background-color: var(--bg-primary);
        border-radius: var(--border-radius);
        padding: 12px;
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        border-left: 4px solid var(--accent-primary);
    }
    .report-kpi-card.wide {
        grid-column: span 2;
    }
    .kpi-label {
        font-size: 11px;
        text-transform: uppercase;
        color: var(--text-secondary);
        font-weight: 600;
        margin-bottom: 4px;
    }
    .kpi-value {
        font-size: 24px;
        font-weight: 700;
        color: var(--text-primary);
        line-height: 1.2;
    }
    .kpi-sub {
        font-size: 11px;
        color: var(--text-secondary);
        margin-top: 2px;
    }
    
    /* Tabela Zespou */
    .report-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 13px;
    }
    .report-table th {
        text-align: left;
        padding: 8px;
        border-bottom: 2px solid var(--border-color);
        color: var(--text-secondary);
        font-weight: 600;
    }
    .report-table td {
        padding: 10px 8px;
        border-bottom: 1px solid var(--border-color);
        vertical-align: middle;
    }
    .report-badge {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 10px;
        font-weight: 700;
        text-transform: uppercase;
    }
    .badge-gold { background-color: #fef3c7; color: #d97706; border: 1px solid #f59e0b; }
    .badge-green { background-color: #dcfce7; color: #16a34a; border: 1px solid #22c55e; }
    
    /* Pasek Bud偶etu w Raporcie */
    .report-budget-bar-bg {
        height: 24px;
        background-color: var(--bg-tertiary);
        border-radius: 12px;
        overflow: hidden;
        position: relative;
        margin-top: 8px;
    }
    .report-budget-bar-fill {
        height: 100%;
        background: linear-gradient(90deg, var(--success-primary), var(--accent-primary));
        display: flex;
        align-items: center;
        justify-content: flex-end;
        padding-right: 8px;
        color: white;
        font-size: 11px;
        font-weight: 600;
    }
    .report-budget-bar-fill.over {
        background: var(--danger-primary);
    }
    </style>
   <div class="modal-overlay" id="project-report-modal">
    <div class="modal" style="max-width: 900px; height: 90vh;">
        <div class="modal-header" style="background-color: var(--bg-secondary); border-bottom: 1px solid var(--border-color);">
            <div>
                <h2 id="report-project-name" style="margin-bottom: 4px;">Raport Zamknicia</h2>
                <p style="font-size: 12px; color: var(--text-secondary);">Analiza powykonawcza (Post-Mortem)</p>
            </div>
            <button type="button" class="modal-close-btn">&times;</button>
        </div>
        <div class="form-modal-content" style="padding: 24px; background-color: var(--bg-primary);">
            
           <div class="report-section">
                <h3 class="report-section-title"> Opis Projektu</h3>
                <p id="report-project-description" style="white-space: pre-wrap; color: var(--text-primary); line-height: 1.6; font-size: 14px;">-</p>
            </div>
            <div class="report-section">
                <h3 class="report-section-title"> Podsumowanie i Wnioski</h3>
                
                <ul id="report-summary-items-list" style="list-style: none; padding: 0; margin-bottom: 16px;"></ul>

                <div style="display: flex; gap: 8px; align-items: flex-start;">
                    <div style="flex: 1;">
                        <input type="text" id="report-summary-label-input" placeholder="Nazwa (np. Podzikowania)" 
                               style="width: 100%; padding: 8px; border-radius: var(--border-radius); border: 1px solid var(--border-color); background-color: var(--bg-secondary); color: var(--text-primary); font-size: 13px;">
                    </div>
                    <div style="flex: 2;">
                         <textarea id="report-summary-value-input" rows="1" placeholder="Tre (np. Jan Kowalski, Anna Nowak...)" 
                                   style="width: 100%; padding: 8px; border-radius: var(--border-radius); border: 1px solid var(--border-color); background-color: var(--bg-secondary); color: var(--text-primary); font-size: 13px; resize: vertical;"></textarea>
                    </div>
                    <button id="report-add-summary-btn" class="btn btn-secondary" style="padding: 8px 12px;">Dodaj</button>
                </div>
            </div>
            <div class="report-section">
                <h3 class="report-section-title">憋 Efektywno Czasowa</h3>
                <div class="report-kpi-grid">
                    <div class="report-kpi-card">
                        <span class="kpi-label">Terminowo</span>
                        <strong class="kpi-value" id="report-time-score">-</strong>
                        <span class="kpi-sub" id="report-time-sub">zada na czas</span>
                    </div>
                    <div class="report-kpi-card">
                        <span class="kpi-label">rednie op贸藕nienie</span>
                        <strong class="kpi-value" id="report-avg-delay" style="color: var(--danger-primary);">-</strong>
                        <span class="kpi-sub">dla zada sp贸藕nionych</span>
                    </div>
                    <div class="report-kpi-card wide">
                        <span class="kpi-label">Najwikszy polizg</span>
                        <div id="report-worst-task" style="font-size: 13px; margin-top: 6px; font-weight: 500;">-</div>
                    </div>
                </div>
            </div>

            <div class="report-section">
                <h3 class="report-section-title"> Bilans Bud偶etowy</h3>
                <div id="report-budget-container">
                    </div>
                <div class="report-kpi-grid" style="margin-top: 16px;">
                        <div class="report-kpi-card">
                        <span class="kpi-label">redni koszt zadania</span>
                        <strong class="kpi-value" id="report-avg-cost">-</strong>
                    </div>
                        <div class="report-kpi-card wide">
                        <span class="kpi-label">Top 3 Kosztogenne Zadania</span>
                        <ul id="report-costly-tasks" style="list-style: none; padding: 0; margin-top: 8px; font-size: 12px;"></ul>
                    </div>
                </div>
            </div>

            <div class="report-section">
                <h3 class="report-section-title"> Wydajno Zespou</h3>
                <div class="report-table-container">
                    <table class="report-table">
                        <thead>
                            <tr>
                                <th>Pracownik</th>
                                <th style="text-align: center;">Zadania (Ukoczone)</th>
                                <th style="text-align: center;">Terminowo</th>
                                <th style="text-align: center;">Lider w...</th>
                            </tr>
                        </thead>
                        <tbody id="report-team-tbody">
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="report-section">
                <h3 class="report-section-title"> Jako i Proces</h3>
                <div class="report-kpi-grid">
                    <div class="report-kpi-card">
                        <span class="kpi-label">Porzucone (Tech Debt)</span>
                        <strong class="kpi-value" id="report-abandoned-count">-</strong>
                        <span class="kpi-sub">niewykonane w dniu zamknicia</span>
                    </div>
                    <div class="report-kpi-card">
                        <span class="kpi-label">Komunikacja</span>
                        <strong class="kpi-value" id="report-comments-count">-</strong>
                        <span class="kpi-sub">wymienionych komentarzy</span>
                    </div>
                </div>
            </div>

        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary modal-close-btn">Zamknij raport</button>
        </div>
    </div>
</div>

</body>
</html>











































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































